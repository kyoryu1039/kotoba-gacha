<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | å‹é”å¯¾æˆ¦P2Pãƒ»å˜ä¸€HTMLç‰ˆ</title>
<style>
:root{
  --bg:#0b1228; --text:#eaf2ff;
  --panel:#0f1633; --panel2:#0e1530; --border:#20335f; --shadow:0 18px 44px rgba(0,0,0,.18);
  --ally:#27b1ff; --enemy:#ff6b7a; --hp:#63ff8c; --hpBack:#0f2a1c;
  --gauge:#ffe066; --gaugeBack:#31260a;
}
*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",Inter,system-ui,Roboto,"Helvetica Neue",Arial,sans-serif}
.container{max-width:1024px;margin:0 auto;padding:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
.card h2{margin:0;padding:10px 14px;border-bottom:1px solid var(--border);font-size:17px}
.card .body{padding:12px}
.note{color:#c9d7ff;font-size:11px}
.row{display:flex;gap:10px;align-items:center}
.primary,.ghost{appearance:none;cursor:pointer;border-radius:12px;border:1px solid #2b3a70;background:#101c3b;color:#eaf2ff;padding:8px 12px;font-weight:700}
.primary{background:#18326a}
input[type="text"],textarea{width:100%;background:#0b1430;border:1px solid #25366b;color:#eaf2ff;padding:8px;border-radius:10px}
textarea{min-height:120px;resize:vertical}
.grid2{display:grid;gap:12px}
@media(min-width:740px){.grid2{grid-template-columns:1fr 1fr}}
.status{display:flex;gap:8px;align-items:center;font-size:13px}
.badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2d3a70;background:#0b1635d8;white-space:nowrap}
.badge.ok{color:#7dffab;border-color:#1f6042;background:#0b2a1bd8}
.hr{height:1px;background:#20335f;margin:10px 0}
.toastArea{min-height:54px}
.toast{margin:6px auto 0;max-width:min(96vw,720px);padding:10px 14px;border-radius:14px;background:rgba(12,22,50,.96);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;transform:translateY(8px);transition:.22s ease}
.toast.show{opacity:1;transform:translateY(0)}
.timer{display:flex;justify-content:center;gap:8px;align-items:center;font-weight:900}
.timer .num{font-size:26px}

/* ãƒãƒˆãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.arena{display:grid;gap:12px}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
.unit{position:relative;border-radius:18px;overflow:hidden;background:
 linear-gradient(180deg,#0e1735,#0d1430) padding-box,
 linear-gradient(135deg,#fff4a8,#ffd86b 30%,#d7a63a 60%,#ffefb0) border-box;
border:3px solid transparent;background-clip:padding-box,border-box;box-shadow:0 12px 40px rgba(0,0,0,.25);padding:18px}
.owner{position:absolute;top:8px;left:10px;font-size:11px;padding:3px 9px;border-radius:999px;border:1px solid #2d3a70;background:#0b1635d8}
.owner.ally{color:var(--ally)}.owner.enemy{color:var(--enemy)}
.name{font-weight:900;font-size:18px;text-align:center;margin:4px 0 10px}
.art{display:flex;justify-content:center;align-items:center;height:100px;margin:6px 0 10px}
.chara{font-size:60px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.28))}
.hpHead{display:flex;justify-content:space-between;align-items:center;font-size:11px}
.hpBox{width:100%;height:13px;background:var(--hpBack);border-radius:8px;overflow:hidden;margin-top:4px}
.hpFill{height:100%;background:var(--hp);transition:width 0.6s cubic-bezier(.22,1,.36,1)}
.gaugeRow{display:flex;gap:4px;margin-top:6px;justify-content:center}
.pip{width:16px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
.pip.on{background:var(--gauge);opacity:1}
.skillArea{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.statusTiny{font-size:9.8px;color:#a7c3ff;background:rgba(10,18,45,.55);border:1px solid #2b3a70;border-radius:10px;padding:4px 6px}
.padCard{position:relative;background:linear-gradient(180deg,#121c3e 0%,#0a1128 100%);border:1px solid #31457b;border-radius:20px;box-shadow:0 22px 48px rgba(0,0,0,.45), 0 8px 18px rgba(4,10,30,.6), inset 0 1px 0 rgba(255,255,255,.06);padding:8px}
.padInner{display:grid;grid-template-columns:1fr;gap:8px;align-items:center}
.rpsArea{position:relative;height:110px}
.rps{position:absolute;display:grid;place-items:center;width:60px;height:60px;border-radius:999px;border:none;color:#061225;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.rps .emo{font-size:24px}.rps .lbl{font-size:10px;margin-top:2px;font-weight:800}
.rps.g{left:50%;top:6%;transform:translateX(-50%);background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
.rps.p{left:70%;bottom:6%;transform:translateX(-50%);background:linear-gradient(180deg,#defae5,#8bffb5)}
.rps.c{left:30%;bottom:6%;transform:translateX(-50%);background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
.sideBtns{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.switchBtn{width:100%;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900;cursor:pointer;padding:8px 0}
.spToggle{width:100%;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s;cursor:pointer;padding:8px 0}
.spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
.dim{opacity:.6;filter:saturate(.85)}
#result{position:fixed;inset:0;background:rgba(6,10,26,.82);display:none;place-items:center;z-index:60}
.box{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 26px;text-align:center;box-shadow:var(--shadow)}
/* tiny helpers */
.hidden{display:none}
.center{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
<div class="container">
  <!-- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨­å®š -->
  <section class="card">
    <h2>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆP2Pãƒ»å˜ä¸€HTMLï¼‰</h2>
    <div class="body">
      <div class="grid2">
        <div>
          <div class="row">
            <input id="myName" type="text" placeholder="ã‚ãªãŸã®åå‰ï¼ˆä»»æ„ï¼‰">
            <button id="btnHost" class="primary">ğŸ›– ãƒ›ã‚¹ãƒˆã™ã‚‹</button>
            <button id="btnJoin" class="ghost">ğŸ”— å‚åŠ ã™ã‚‹</button>
          </div>
          <div class="status" style="margin-top:8px">
            <span class="badge" id="netState">æœªæ¥ç¶š</span>
            <span class="badge" id="seatBadge">-</span>
            <span class="badge" id="oppBadge">ç›¸æ‰‹æœªæ¥ç¶š</span>
          </div>
          <div class="hr"></div>
          <div>
            <div class="note">ãƒ›ã‚¹ãƒˆâ†’ã€Œã‚ªãƒ•ã‚¡ãƒ¼ã€ã‚’ç›¸æ‰‹ã«é€ã‚‹ï¼å‚åŠ â†’ã€Œã‚ªãƒ•ã‚¡ãƒ¼ã‚’è²¼ä»˜â†’ã‚¢ãƒ³ã‚µãƒ¼ã‚’è¿”ã™ã€</div>
            <textarea id="sigA" placeholder="ã“ã“ã«ã‚ªãƒ•ã‚¡ãƒ¼ï¼ˆOfferï¼‰/ã‚¢ãƒ³ã‚µãƒ¼ï¼ˆAnswerï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
            <div class="row" style="margin-top:8px">
              <button id="copySig" class="ghost">ã‚³ãƒ”ãƒ¼</button>
              <button id="clearSig" class="ghost">ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="row" style="margin-top:8px">
              <textarea id="sigPaste" placeholder="ç›¸æ‰‹ã‹ã‚‰å—ã‘å–ã£ãŸæ–‡å­—åˆ—ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnUsePaste" class="primary">è²¼ã‚Šä»˜ã‘ã‚’é©ç”¨</button>
              <span class="note">ï¼ˆãƒ›ã‚¹ãƒˆã¯ç›¸æ‰‹ã®ã‚¢ãƒ³ã‚µãƒ¼ï¼å‚åŠ ã¯ãƒ›ã‚¹ãƒˆã®ã‚ªãƒ•ã‚¡ãƒ¼ï¼‰</span>
            </div>
          </div>
        </div>
        <div>
          <div class="row">
            <button id="btnReady" class="primary" disabled>âœ… æº–å‚™å®Œäº†</button>
            <span class="note">ä¸¡è€…ãŒæº–å‚™ã™ã‚‹ã¨è©¦åˆé–‹å§‹</span>
          </div>
          <div class="toastArea"><div class="toast" id="toast"></div></div>
          <div class="hr"></div>
          <div class="note">
            âš ï¸ WebRTCã¯é€šå¸¸ <b>https ã¾ãŸã¯ localhost</b> ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚<br>
            STUN: <code>stun.l.google.com:19302</code> ã‚’ä½¿ç”¨ã€‚P2Pãªã®ã§ä¸€éƒ¨ã®å›ç·šã§ã¯æ¥ç¶šã—ã«ãã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section class="card" id="battleCard">
    <h2>å¯¾æˆ¦</h2>
    <div class="body">
      <div class="arena">
        <div class="vsrow">
          <div class="unit" id="unitA">
            <div class="owner ally">ã‚ãªãŸï¼ˆAï¼‰</div>
            <div class="name" id="nameA">Player A</div>
            <div class="art"><div class="chara">ğŸ›¡ï¸</div></div>
            <div class="hpHead"><span>HP</span><span id="hpValA">1000/1000</span></div>
            <div class="hpBox"><div class="hpFill" id="hpFillA" style="width:100%"></div></div>
            <div class="gaugeRow" id="gaugeA"></div>
            <div class="skillArea"><span class="statusTiny" id="statA">-</span></div>
          </div>
          <div class="unit" id="unitB">
            <div class="owner enemy">ç›¸æ‰‹ï¼ˆBï¼‰</div>
            <div class="name" id="nameB">Player B</div>
            <div class="art"><div class="chara">âš”ï¸</div></div>
            <div class="hpHead"><span>HP</span><span id="hpValB">1000/1000</span></div>
            <div class="hpBox"><div class="hpFill" id="hpFillB" style="width:100%"></div></div>
            <div class="gaugeRow" id="gaugeB"></div>
            <div class="skillArea"><span class="statusTiny" id="statB">-</span></div>
          </div>
        </div>

        <section class="padCard" id="pad">
          <div class="padInner">
            <div class="rpsArea">
              <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
              <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
              <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
            </div>
            <div class="sideBtns">
              <button class="spToggle" id="btnSP" disabled>âœ¨ å¿…æ®º OFF</button>
              <button class="switchBtn" id="btnSwitch" disabled>ğŸ” äº¤ä»£ï¼ˆæœªå®Ÿè£…ï¼‰</button>
            </div>
          </div>
        </section>

        <div class="timer">é¸æŠã¾ã§ <span class="num" id="countNum">-</span> ç§’</div>
      </div>
    </div>
  </section>
</div>

<!-- çµæœ -->
<div id="result" class="center">
  <div class="box">
    <h1 id="resTitle" style="margin:0 0 8px;font-size:38px">YOU WIN!</h1>
    <p id="resSub" style="margin:4px 0 0;color:#cfe2ff">ã€ŒOKã€ã§ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚</p>
    <div class="row center" style="margin-top:10px">
      <button id="btnBack" class="primary">OK</button>
    </div>
  </div>
</div>

<script>
/* ========== å‹é”å¯¾æˆ¦P2Pï¼šå˜ä¸€HTMLå®Œæˆå½¢ ========== */
/* ä½¿ã„æ–¹ï¼š
   1) ãƒ›ã‚¹ãƒˆï¼šğŸ›–ã€Œãƒ›ã‚¹ãƒˆã™ã‚‹ã€â†’å‡ºãŸæ–‡å­—åˆ—ã‚’ç›¸æ‰‹ã¸é€ã‚‹â†’ç›¸æ‰‹ã®ã‚¢ãƒ³ã‚µãƒ¼ã‚’è²¼ã£ã¦ã€Œè²¼ã‚Šä»˜ã‘ã‚’é©ç”¨ã€
   2) å‚åŠ ï¼šğŸ”—ã€Œå‚åŠ ã™ã‚‹ã€â†’ãƒ›ã‚¹ãƒˆã®æ–‡å­—åˆ—ã‚’è²¼ã£ã¦ã€Œè²¼ã‚Šä»˜ã‘ã‚’é©ç”¨ã€â†’å‡ºãŸæ–‡å­—åˆ—ã‚’ãƒ›ã‚¹ãƒˆã¸è¿”ã™
   3) ä¸¡è€…ã€Œæº–å‚™å®Œäº†ã€â†’è©¦åˆé–‹å§‹
*/
const $=id=>document.getElementById(id);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

/* --------- UI: Toast / Timer / Buttons ---------- */
const toastEl=$('toast');
function showToast(msg, ms=1800){
  toastEl.textContent=msg; toastEl.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t=setTimeout(()=>toastEl.classList.remove('show'),ms);
}
function startCountdownTo(deadlineTs){
  const el=$('countNum');
  clearInterval(startCountdownTo._t);
  const tick=()=>{
    const remain=Math.max(0, Math.ceil((deadlineTs - Date.now())/1000));
    el.textContent=remain;
    if(remain<=0){ clearInterval(startCountdownTo._t); }
  };
  tick();
  startCountdownTo._t=setInterval(tick,250);
}
function setPadEnabled(on){
  ['btnG','btnC','btnP'].forEach(id=>{ const b=$(id); b.disabled=!on;});
  const sp=$('btnSP'); if(on) sp.removeAttribute('disabled'); else sp.setAttribute('disabled','');
  $('pad').classList.toggle('dim', !on);
}

/* --------- ãƒãƒˆãƒ«è¡¨ç¤º ---------- */
const ui = {
  setNames(a,b){ $('nameA').textContent=a||'Player A'; $('nameB').textContent=b||'Player B'; },
  setHP(a,b){
    const max=1000;
    $('hpValA').textContent=`${a}/${max}`; $('hpFillA').style.width=`${a/max*100}%`;
    $('hpValB').textContent=`${b}/${max}`; $('hpFillB').style.width=`${b/max*100}%`;
  },
  setGauge(ga,gb){
    const draw=(wrap,val)=>{
      wrap.innerHTML='';
      for(let i=0;i<6;i++){ const p=document.createElement('div'); p.className='pip'+(i<val?' on':''); wrap.appendChild(p); }
    };
    draw($('gaugeA'), ga); draw($('gaugeB'), gb);
  },
  setSeat(seat){
    $('seatBadge').textContent=seat?`å¸­ï¼š${seat}`:'-';
    $('ownerA'); // visual already shows A/B
  },
  setNetState(txt, ok=false){
    const b=$('netState'); b.textContent=txt; b.classList.toggle('ok', !!ok);
  },
  setOpp(txt){ $('oppBadge').textContent=txt; },
  result(winner, mySeat){
    $('result').style.display='grid';
    const title=$('resTitle');
    if(winner==='draw'){ title.textContent='DRAW'; }
    else if(winner===mySeat){ title.textContent='YOU WIN!'; }
    else { title.textContent='YOU LOSE...'; }
  },
  resetResult(){ $('result').style.display='none'; }
};

/* --------- P2Pãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ï¼ˆæ‰‹å‹•ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼‰ ---------- */
class NetP2P {
  constructor(){ this.pc=null; this.dc=null; this.handlers={}; this.seat=null; this._authority=false; this._oppName='-'; }
  on(t,fn){ (this.handlers[t]=this.handlers[t]||[]).push(fn); }
  emit(t,p){ (this.handlers[t]||[]).forEach(f=>f(p)); }
  send(o){ if(this.dc?.readyState==="open") this.dc.send(JSON.stringify(o)); }

  async host(name){
    this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    this.dc=this.pc.createDataChannel("game"); this._wire();
    const offer=await this.pc.createOffer(); await this.pc.setLocalDescription(offer);
    const sdp=await this._waitGather();
    $('sigA').value = btoa(JSON.stringify(sdp));
    ui.setNetState('ãƒ›ã‚¹ãƒˆ: ã‚ªãƒ•ã‚¡ãƒ¼ç”Ÿæˆ', true);
    ui.setOpp('ç›¸æ‰‹æœªæ¥ç¶š');
    this.seat="A"; this.myName = name||"Player A";
    this.emit("JOIN_OK",{seat:"A",gameId:"p2p"});
  }
  async join(name){
    this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    this.pc.ondatachannel=e=>{ this.dc=e.channel; this._wire(); };
    ui.setNetState('å‚åŠ : ã‚ªãƒ•ã‚¡ãƒ¼å¾…ã¡');
    this.seat="B"; this.myName = name||"Player B";
    this.emit("JOIN_OK",{seat:"B",gameId:"p2p"});
  }
  async applyPasted(text){
    const obj = JSON.parse(atob(text.trim()));
    if(this.pc.signalingState==="stable"){
      // likely we are host expecting ANSWER
      await this.pc.setRemoteDescription(obj);
      ui.setNetState('æ¥ç¶šæ¸ˆã¿', true); ui.setOpp('ç›¸æ‰‹æ¥ç¶š');
      this._hello();
      return;
    }else{
      // we are joiner applying OFFER -> create ANSWER
      await this.pc.setRemoteDescription(obj);
      const answer=await this.pc.createAnswer(); await this.pc.setLocalDescription(answer);
      const sdp=await this._waitGather();
      $('sigA').value = btoa(JSON.stringify(sdp));
      ui.setNetState('ã‚¢ãƒ³ã‚µãƒ¼ç”Ÿæˆ', true);
      return;
    }
  }
  _wire(){
    this.dc.onmessage=ev=>{ const m=JSON.parse(ev.data); this.emit(m.type,m); };
    this.dc.onopen=()=>{ ui.setNetState('æ¥ç¶šæ¸ˆã¿', true); ui.setOpp('ç›¸æ‰‹æ¥ç¶š'); this._hello(); };
  }
  _waitGather(){ return new Promise(res=>{
    if(this.pc.iceGatheringState==="complete") return res(this.pc.localDescription);
    this.pc.onicegatheringstatechange=()=>{
      if(this.pc.iceGatheringState==="complete") res(this.pc.localDescription);
    };
  });}
  _hello(){
    this.send({type:"HELLO", name:this.myName});
    this.emit("HELLO",{name:this.myName}); // reflect self
  }

  // ã‚²ãƒ¼ãƒ ç”¨API
  ready(){ this._authority ? (this._readyA=true, this._maybeStart()) : this.send({type:"READY",ready:true}); }
  pick(h){ this._authority ? (this._pending.A={...(this._pending.A||{}),hand:h}, this._maybeResolve()) : this.send({type:"PICK",hand:h}); }
  spToggle(on){ this._authority ? (this._pending.A={...(this._pending.A||{}),sp:on}) : this.send({type:"SP_TOGGLE",on}); }
  doSwitch(to){ this._authority ? (this._pending.A={...(this._pending.A||{}),sw:to}) : this.send({type:"SWITCH",to}); }

  // æ¨©å¨ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ãƒ­ã‚¸ãƒƒã‚¯
  becomeAuthority(){
    this._authority=true;
    this.state={turn:1, hp:{A:1000,B:1000}, gauge:{A:0,B:0}, active:{A:0,B:0}, canSP:{A:false,B:false}};
    this._pending={A:null,B:null}; this._readyA=false; this._readyB=false;
    // å—ä¿¡ãƒãƒ³ãƒ‰ãƒ©
    this.on("READY",()=>{ this._readyB=true; this._maybeStart(); });
    this.on("PICK",m=>{ this._pending.B={...(this._pending.B||{}),hand:m.hand}; this._maybeResolve(); });
    this.on("SP_TOGGLE",m=>{ this._pending.B={...(this._pending.B||{}),sp:!!m.on}; });
    this.on("SWITCH",m=>{ this._pending.B={...(this._pending.B||{}),sw:m.to}; });
    this.on("HELLO", m=>{ this._oppName = m.name || 'Player B'; this.emit("OPPONENT_NAME",{A:this.myName, B:this._oppName}); });
  }
  onOpponentName(cb){
    this.on("HELLO", m=>cb({me:this.myName, opp:m.name||'Player'}));
  }
  _maybeStart(){
    if(this._readyA && this._readyB){
      const deadline=Date.now()+15000;
      this._pending={A:null,B:null};
      const msg={type:"TURN_START",turn:this.state.turn,deadlineTs:deadline,
        canSP_A:this.state.gauge.A>=6, canSP_B:this.state.gauge.B>=6,
        activeA:this.state.active.A, activeB:this.state.active.B};
      this.send(msg); window.dispatchEvent(new CustomEvent('LOCAL_MSG',{detail:msg}));
      clearTimeout(this._timer); this._timer=setTimeout(()=>this._resolve(),15050);
    }
  }
  _maybeResolve(){
    if(this._pending.A?.hand && this._pending.B?.hand){ clearTimeout(this._timer); this._resolve(); }
  }
  _resolve(){
    const A=this._pending.A || {hand:["g","c","p"][Math.random()*3|0]};
    const B=this._pending.B || {hand:["g","c","p"][Math.random()*3|0]};
    const win=(a,b)=>a===b?"draw":(a==="g"&&b==="c")||(a==="c"&&b==="p")||(a==="p"&&b==="g")?"A":"B";
    const who=win(A.hand,B.hand);

    // --- ç°¡æ˜“ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹SP ---
    // é€šå¸¸120ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚SPæŒ‡å®šã‹ã¤ã‚²ãƒ¼ã‚¸>=6ã§ 260ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‹ã‚²ãƒ¼ã‚¸-6ï¼ˆãã®ã‚¿ãƒ¼ãƒ³1å›ï¼‰
    const dmgBase = 120;
    const dmgSP   = 260;
    const effects=[];
    const state=this.state;

    const useSPA = !!A.sp && state.gauge.A>=6;
    const useSPB = !!B.sp && state.gauge.B>=6;

    let dmg = 0;
    if(who==="A"){ dmg = useSPA ? dmgSP : dmgBase; state.hp.B = Math.max(0, state.hp.B - dmg); }
    if(who==="B"){ dmg = useSPB ? dmgSP : dmgBase; state.hp.A = Math.max(0, state.hp.A - dmg); }
    if(who!=="draw") effects.push({type:"dmg", who, dmg});

    if(useSPA){ state.gauge.A -= 6; effects.push({type:"sp", who:"A"}); }
    if(useSPB){ state.gauge.B -= 6; effects.push({type:"sp", who:"B"}); }

    // ã‚²ãƒ¼ã‚¸åŠ ç®—ï¼šã‚ã„ã“ã§ã‚‚+1ï¼ˆä¸¡è€…ï¼‰
    state.gauge.A = Math.min(6, state.gauge.A + 1);
    state.gauge.B = Math.min(6, state.gauge.B + 1);

    // æ¬¡ã‚¿ãƒ¼ãƒ³ã®SPå¯å¦
    state.canSP = {A: state.gauge.A>=6, B: state.gauge.B>=6};

    const res={type:"TURN_RESOLVE",turn:state.turn,hands:{A:A.hand,B:B.hand},effects,newState:structuredClone(state)};
    this.send(res); window.dispatchEvent(new CustomEvent('LOCAL_MSG',{detail:res}));

    // å‹æ•—
    if(state.hp.A<=0 || state.hp.B<=0){
      const winner= state.hp.A<=0 && state.hp.B<=0 ? "draw" : (state.hp.A>0?"A":"B");
      const fin={type:"RESULT",winner};
      this.send(fin); window.dispatchEvent(new CustomEvent('LOCAL_MSG',{detail:fin}));
      return;
    }
    state.turn++;
    this._maybeStart();
  }
}

/* --------- ã‚²ãƒ¼ãƒ çµ±åˆ ---------- */
const net = new NetP2P();
let isHost = false;

// å—ä¿¡ã‚’ã€ŒãƒãƒƒãƒˆçµŒç”±ã€ã¨ã€Œãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆãƒ›ã‚¹ãƒˆè‡ªèº«ç”¨ï¼‰ã€ã§å…±é€šå‡¦ç†ã«æµã™
function handleMsg(m){
  switch(m.type){
    case "JOIN_OK":{
      ui.setSeat(m.seat); $('btnReady').disabled=false;
      showToast(`å¸­ãŒç¢ºå®šï¼š${m.seat}`);
      break;
    }
    case "TURN_START":{
      setPadEnabled(true);
      $('btnSP').classList.toggle('on', false);
      $('btnSP').textContent = 'âœ¨ å¿…æ®º OFF';
      $('btnSP').disabled = !( (net.seat==="A") ? m.canSP_A : m.canSP_B );
      startCountdownTo(m.deadlineTs);
      showToast(`ã‚¿ãƒ¼ãƒ³${m.turn} é–‹å§‹`);
      break;
    }
    case "TURN_RESOLVE":{
      setPadEnabled(false);
      const s=m.newState;
      ui.setHP(s.hp.A, s.hp.B);
      ui.setGauge(s.gauge.A, s.gauge.B);
      const hands = {g:'âœŠ', c:'âœŒï¸', p:'ğŸ–'};
      $('statA').textContent=`å‡ºã—ãŸæ‰‹ï¼š${hands[m.hands.A]}`;
      $('statB').textContent=`å‡ºã—ãŸæ‰‹ï¼š${hands[m.hands.B]}`;
      const spMsg = m.effects?.find(e=>e.type==='sp') ? 'ï¼ˆå¿…æ®ºï¼ï¼‰' : '';
      if(m.effects?.length){
        const e=m.effects.find(e=>e.type==='dmg');
        if(e) showToast(`${e.who} ãŒ ${e.dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ ${spMsg}`);
      }else{
        showToast('ã‚ã„ã“ï¼ ã‚²ãƒ¼ã‚¸+1');
      }
      break;
    }
    case "RESULT":{
      ui.result(m.winner, net.seat);
      break;
    }
    case "HELLO":{
      // self hello already sent; handled in authority via OPPONENT_NAME
      break;
    }
    case "OPPONENT_NAME":{
      const a = m.A || 'Player A', b = m.B || 'Player B';
      if(net.seat==="A") ui.setNames(a,b); else ui.setNames(b,a);
      break;
    }
    default:
      // ignore
      break;
  }
}
net.on("JOIN_OK", handleMsg);
net.on("TURN_START", handleMsg);
net.on("TURN_RESOLVE", handleMsg);
net.on("RESULT", handleMsg);
net.on("HELLO", (m)=>{ if(!isHost){ ui.setNames(net.myName, m.name||'Player'); } });
window.addEventListener('LOCAL_MSG', e=>handleMsg(e.detail));

// UI åˆæœŸ
ui.setHP(1000,1000); ui.setGauge(0,0);
$('btnSP').disabled=true; $('btnSwitch').disabled=true;
ui.setNames('Player A','Player B');

/* --------- ãƒœã‚¿ãƒ³é…ç·š ---------- */
$('btnHost').onclick = async ()=>{
  try{
    isHost = true;
    await net.host($('myName').value.trim());
    net.becomeAuthority();
    $('seatBadge').textContent='å¸­ï¼šA';
    ui.setNetState('ãƒ›ã‚¹ãƒˆå¾…æ©Ÿä¸­', true);
    showToast('ã‚ªãƒ•ã‚¡ãƒ¼ã‚’ç›¸æ‰‹ã¸é€ã£ã¦ãã ã•ã„');
  }catch(e){ console.error(e); showToast('ãƒ›ã‚¹ãƒˆå¤±æ•—'); }
};
$('btnJoin').onclick = async ()=>{
  try{
    isHost = false;
    await net.join($('myName').value.trim());
    $('seatBadge').textContent='å¸­ï¼šB';
    ui.setNetState('å‚åŠ å¾…æ©Ÿä¸­');
    showToast('ãƒ›ã‚¹ãƒˆã®ã‚ªãƒ•ã‚¡ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦é©ç”¨ã—ã¦ãã ã•ã„');
  }catch(e){ console.error(e); showToast('å‚åŠ å¤±æ•—'); }
};
$('btnUsePaste').onclick = async ()=>{
  const txt=$('sigPaste').value.trim();
  if(!txt){ showToast('è²¼ã‚Šä»˜ã‘ãŒç©ºã§ã™'); return; }
  try{
    await net.applyPasted(txt);
    if(!isHost && $('sigA').value){
      showToast('ç”Ÿæˆã—ãŸã‚¢ãƒ³ã‚µãƒ¼ã‚’ãƒ›ã‚¹ãƒˆã¸é€ã£ã¦ãã ã•ã„');
    }else{
      showToast('æ¥ç¶šå‡¦ç†ã‚’ç¶™ç¶šä¸­â€¦');
    }
  }catch(e){ console.error(e); showToast('é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
};
$('copySig').onclick=()=>{
  const ta=$('sigA'); ta.select(); document.execCommand('copy');
  showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
};
$('clearSig').onclick=()=>{ $('sigA').value=''; $('sigPaste').value=''; };

$('btnReady').onclick=()=>{
  net.ready();
  if(isHost){ net._readyA = true; net._maybeStart(); }
  showToast('æº–å‚™OK');
};

$('btnG').onclick=()=>{ net.pick("g"); setPadEnabled(false); showToast('âœŠ ã‚’é¸æŠ'); };
$('btnC').onclick=()=>{ net.pick("c"); setPadEnabled(false); showToast('âœŒï¸ ã‚’é¸æŠ'); };
$('btnP').onclick=()=>{ net.pick("p"); setPadEnabled(false); showToast('ğŸ– ã‚’é¸æŠ'); };
$('btnSP').onclick=()=>{
  const on=!$('btnSP').classList.contains('on');
  $('btnSP').classList.toggle('on', on);
  $('btnSP').textContent = on ? 'âœ¨ å¿…æ®º ON' : 'âœ¨ å¿…æ®º OFF';
  net.spToggle(on);
};

$('btnBack').onclick=()=>{
  ui.resetResult();
  // HP/ã‚²ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ï¼ˆå†æˆ¦ã¯ã€Œæº–å‚™å®Œäº†ã€ã§ãƒ›ã‚¹ãƒˆãŒå†é–‹ï¼‰
  ui.setHP(1000,1000); ui.setGauge(0,0);
  showToast('ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚Šã¾ã—ãŸã€‚ã€Œæº–å‚™å®Œäº†ã€ã§å†æˆ¦ã§ãã¾ã™');
};

/* è¦‹ãŸç›®ã®ç´°ã‹ãªè£œåŠ© */
(function initSeatBadges(){
  $('seatBadge').textContent='-';
  ui.setNetState('æœªæ¥ç¶š');
  ui.setOpp('ç›¸æ‰‹æœªæ¥ç¶š');
})();
</script>
</body>
</html>
