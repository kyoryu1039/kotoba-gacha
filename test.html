<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v8.5 Flashy</title>
<meta name="theme-color" content="#0b0f1c">

<style>
/* === å…ƒã®é…è‰²ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ (v7.80 Respect) === */
:root{
  --bg:#0b1228; --text:#eaf2ff;
  --panel:#0f1633; --panel2:#0e1530; --border:#20335f; --shadow:0 18px 44px rgba(0,0,0,.18);
  --ally:#27b1ff; --enemy:#ff6b7a;
  --hp:#63ff8c; --hpBack:#0f2a1c;
  --gauge:#ffe066; --gaugeBack:#31260a;
  --t-ã‚¸ã‚ª:#7aa0ff; --t-ã‚¢ãƒ‹ãƒãƒ«:#34d790; --t-ãƒ•ãƒ¼ãƒ‰:#ffb158; --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#b68cff; --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#2dd6ff; --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff7a9a; --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#78e063;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;overflow:hidden; touch-action:manipulation;}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±é€š */
.container{max-width:600px;margin:0 auto;padding:10px;height:100%;display:flex;flex-direction:column}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card h2{margin:0;padding:10px 14px;border-bottom:1px solid var(--border);font-size:15px;background:rgba(0,0,0,0.2)}
.body{padding:12px}

/* ãƒœã‚¿ãƒ³é¡ */
.primary,.ghost{appearance:none;cursor:pointer;border-radius:12px;border:1px solid #2b3a70;background:#101c3b;color:#eaf2ff;padding:10px 12px;font-weight:700;transition:transform 0.1s}
.primary{background:linear-gradient(135deg,#18326a,#264385);border-color:#385291}
.primary:active, .ghost:active{transform:scale(0.96)}

/* === ç·¨æˆç”»é¢ (å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒ) === */
#setup{display:grid;gap:12px;align-content:start;overflow-y:auto}
.slot{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.slot select{flex:1;background:#0b1430;border:1px solid #25366b;color:#eaf2ff;padding:8px;border-radius:10px}
.pill{display:inline-grid;place-items:center;width:24px;height:24px;border-radius:6px;background:#0b1430;border:1px solid #2b3a70;font-size:12px}

/* === ãƒãƒˆãƒ«ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ === */
#battle{display:none;grid-template-rows:auto 1fr auto;gap:10px;height:100%}

/* ã‚¿ã‚¤ãƒãƒ¼ (å¾©æ´»ï¼) */
.timer-bar{
  display:flex; justify-content:center; align-items:center; gap:10px;
  background:var(--panel2); padding:8px; border-radius:12px; border:1px solid var(--border);
  font-weight:900; font-size:18px; color:#fff;
}
.timer-val{color:#ff6b7a;font-variant-numeric:tabular-nums}
.timer-val.safe{color:#63ff8c}

/* ã‚¢ãƒªãƒ¼ãƒŠ (ã‚«ãƒ¼ãƒ‰è¡¨ç¤º) */
.arena{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:start}

/* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ (v7.80æº–æ‹  + å¾®èª¿æ•´) */
.unit{
  --typeColor:#7aa0ff;
  position:relative; width:100%; border-radius:14px; padding:8px;
  background:linear-gradient(180deg,#0e1735,#0d1430);
  border:2px solid color-mix(in srgb,var(--typeColor) 40%, transparent);
  box-shadow:0 8px 20px rgba(0,0,0,.3);
  transition:transform 0.2s, filter 0.2s;
}
.unit.hit{animation:shake 0.4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate3d(-2px,0,0)}20%,80%{transform:translate3d(4px,0,0)}30%,50%,70%{transform:translate3d(-6px,0,0)}40%,60%{transform:translate3d(6px,0,0)}}
.unit.dead{filter:grayscale(1) brightness(0.5); opacity:0.7}

.nm{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
.hpBox{width:100%;height:10px;background:var(--hpBack);border-radius:4px;overflow:hidden;margin:4px 0}
.hpFill{height:100%;background:var(--hp);transition:width 0.4s}
.spRow{display:flex;gap:3px;height:6px;margin-top:4px}
.pip{flex:1;background:#31260a;border-radius:2px}
.pip.on{background:var(--gauge);box-shadow:0 0 4px var(--gauge)}

/* === æ–°æ©Ÿèƒ½: ãƒãƒˆãƒ«ãƒ­ã‚° (ãƒˆãƒ¼ã‚¹ãƒˆã®ä»£ã‚ã‚Š) === */
.log-window{
  height:100px; overflow-y:scroll; 
  background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px;
  padding:6px; font-size:12px; font-family:monospace; line-height:1.4;
  display:flex; flex-direction:column; gap:2px;
}
.log-line{padding:2px 4px; border-radius:4px}
.log-line.turn{background:rgba(255,255,255,0.05); color:#a0b8ff; margin-top:4px; font-weight:bold}
.log-line.dmg{color:#ff9ea9}
.log-line.heal{color:#9effa9}
.log-line.sys{color:#ffd04f}

/* === æ“ä½œãƒ‘ãƒãƒ« === */
.padCard{
  background:linear-gradient(180deg,#121c3e,#0a1128);
  border-top:1px solid #31457b; padding:10px; border-radius:16px 16px 0 0;
  display:grid; gap:10px;
}
.rpsArea{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.rps{
  height:60px; border-radius:12px; border:none; cursor:pointer;
  background:linear-gradient(145deg,#1e2a50,#101730);
  border:2px solid #304275; color:#fff; font-size:24px;
  position:relative; overflow:hidden;
}
.rps:active{transform:scale(0.95)}
.rps:disabled{opacity:0.5; filter:grayscale(1)}

.subBtns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.spToggle{background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;border-radius:10px;font-weight:900}
.spToggle.on{background:#f2c94c;color:#000}

/* === ãƒ‰æ´¾æ‰‹æ¼”å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ (NEW!) === */
#fxLayer{
  position:fixed; inset:0; pointer-events:none; z-index:100;
  display:grid; place-items:center; overflow:hidden;
}
.fx-hand{
  font-size:120px; position:absolute; top:40%; 
  transition:transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  filter:drop-shadow(0 10px 20px rgba(0,0,0,0.5));
  opacity:0;
}
.fx-hand.left{left:-150px; transform:translateY(-50%) rotate(90deg)}
.fx-hand.right{right:-150px; transform:translateY(-50%) rotate(-90deg) scaleX(-1)}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
.fx-active .fx-hand.left{transform:translate(calc(50vw - 40px), -50%) rotate(15deg); opacity:1}
.fx-active .fx-hand.right{transform:translate(calc(-50vw + 40px), -50%) rotate(-15deg) scaleX(-1); opacity:1}

.fx-text{
  font-size:80px; font-weight:900; color:#fff;
  text-shadow:0 0 20px rgba(255,255,255,0.8), 0 0 40px var(--ally);
  opacity:0; transform:scale(0.5);
  position:absolute; top:30%;
}
.fx-text.show{animation:popText 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards}
@keyframes popText{0%{opacity:0;transform:scale(0);filter:blur(10px)} 50%{opacity:1;transform:scale(1.2)} 100%{opacity:1;transform:scale(1);filter:blur(0)}}

.flash-screen{
  position:absolute; inset:0; background:#fff; opacity:0; pointer-events:none;
}
.flash-now{animation:flash 0.4s ease-out}
@keyframes flash{0%{opacity:0.8} 100%{opacity:0}}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;place-items:center;z-index:90}
.modal.show{display:grid}
.modal-content{background:var(--panel);width:90%;max-width:400px;border-radius:16px;padding:20px;border:1px solid var(--border)}

</style>
</head>
<body>

<div id="fxLayer">
  <div class="flash-screen" id="flash"></div>
  <div class="fx-hand left" id="fxHandL">âœŠ</div>
  <div class="fx-hand right" id="fxHandR">âœŠ</div>
  <div class="fx-text" id="fxText">WIN!</div>
</div>

<div id="setup" class="container">
  <section class="card">
    <h2>ãƒãƒ¼ãƒ ç·¨æˆ</h2>
    <div class="body">
      <div style="color:var(--ally);font-weight:900;margin-bottom:6px">YOU</div>
      <div id="setupA"></div>
      <div style="color:var(--enemy);font-weight:900;margin:12px 0 6px">CPU</div>
      <div id="setupB"></div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="btnRand" class="ghost" style="flex:1">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button id="btnStart" class="primary" style="flex:2">å¯¾æˆ¦é–‹å§‹ï¼</button>
      </div>
    </div>
  </section>
  <div style="font-size:12px;color:#667;text-align:center;margin-top:20px">KOTOBA-BATTLE v8.5 Flashy</div>
</div>

<div id="battle" class="container">
  
  <div class="timer-bar">
    <span>TIME LIMIT</span>
    <span id="timerVal" class="timer-val safe">15</span>
  </div>

  <div class="arena">
    <div class="unit" id="unitA" style="--typeColor:var(--ally)">
      <div class="nm" id="nameA">Name</div>
      <div class="hpBox"><div class="hpFill" id="hpBarA" style="width:100%"></div></div>
      <div style="font-size:11px;display:flex;justify-content:space-between">
        <span id="hpNumA">100/100</span>
        <span class="badge" id="typeA">TYPE</span>
      </div>
      <div class="spRow" id="spA"></div>
    </div>
    <div class="unit" id="unitB" style="--typeColor:var(--enemy)">
      <div class="nm" id="nameB">Enemy</div>
      <div class="hpBox"><div class="hpFill" id="hpBarB" style="width:100%"></div></div>
      <div style="font-size:11px;display:flex;justify-content:space-between">
        <span id="hpNumB">100/100</span>
        <span class="badge" id="typeB">TYPE</span>
      </div>
      <div class="spRow" id="spB"></div>
    </div>
  </div>

  <div class="log-window" id="battleLog">
    <div class="log-line">ãƒãƒˆãƒ«é–‹å§‹ï¼</div>
  </div>

  <div class="padCard">
    <div class="rpsArea">
      <button class="rps" id="btnG">âœŠ</button>
      <button class="rps" id="btnC">âœŒï¸</button>
      <button class="rps" id="btnP">ğŸ–</button>
    </div>
    <div class="subBtns">
      <button class="spToggle" id="btnSP">âœ¨ å¿…æ®º OFF</button>
      <button class="ghost" id="btnSwap">ğŸ” äº¤ä»£</button>
    </div>
  </div>
</div>

<div id="modalSwap" class="modal">
  <div class="modal-content">
    <h2>äº¤ä»£ãƒ¡ãƒ³ãƒãƒ¼</h2>
    <div id="swapList" style="display:grid;gap:8px;margin:10px 0"></div>
    <button class="ghost" onclick="toggleModal('modalSwap',false)" style="width:100%">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="modalResult" class="modal">
  <div class="modal-content" style="text-align:center">
    <h1 id="resTitle" style="font-size:40px;margin:0 0 10px">YOU WIN!</h1>
    <button class="primary" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
  </div>
</div>

<script>
'use strict';
const $=(id)=>document.getElementById(id);
const delay=(ms)=>new Promise(r=>setTimeout(r,ms));

// === ãƒ‡ãƒ¼ã‚¿ (v7.80æº–æ‹ ) ===
const WORDS=[
 ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"],
 ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰"],
 ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«"],
 ["ä¹å“ä»","A","ã‚¸ã‚ª"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰"],
 ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«"],
 ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰"],
 ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª"],
 ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼"],
 ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],
 ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª"],
 ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],
 ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«"],
 ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰"],
 ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«"],
 ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"],
 ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]
];

const TYPE_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const getAff=(at,df)=>{
  const i=TYPE_RING.indexOf(at), j=TYPE_RING.indexOf(df), n=TYPE_RING.length;
  if([(i+1)%n,(i+2)%n].includes(j)) return 1.5;
  if([(i-1+n)%n,(i-2+n)%n].includes(j)) return 0.67;
  return 1.0;
};

// === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ ===
function makeUnit([name,rank,type]){
  // åå‰ã‹ã‚‰ç–‘ä¼¼ãƒ©ãƒ³ãƒ€ãƒ ã«å¼·ã•ã‚’æ±ºå®š
  let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h);
  const rBonus={S:1.3,A:1.15,B:1.0,C:0.9,D:0.8,X:1.0}[rank];
  const hp=Math.floor((500+(name.length*15))*rBonus);
  const atk=Math.floor((80+(Math.abs(h)%40))*rBonus);
  return {name,rank,type,maxhp:hp,hp:hp,atk:atk,def:80,sp:0};
}

// === ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ===
const state={
  A:{team:[],idx:0,spOn:false},
  B:{team:[],idx:0},
  timer:null, remain:15, busy:false
};
const getA=()=>state.A.team[state.A.idx];
const getB=()=>state.B.team[state.B.idx];

// === ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  ===
function log(msg, type=''){
  const box=$('battleLog');
  const d=document.createElement('div');
  d.className=`log-line ${type}`;
  d.textContent=msg;
  box.appendChild(d);
  box.scrollTop=box.scrollHeight;
}

// === UIæ›´æ–° ===
function render(){
  const draw=(side, u)=>{
    $(`name${side}`).textContent=u.name;
    $(`type${side}`).textContent=u.type;
    $(`unit${side}`).style.setProperty('--typeColor', `var(--t-${u.type})`);
    
    // HP
    const pct=(u.hp/u.maxhp)*100;
    $(`hpBar${side}`).style.width=`${pct}%`;
    $(`hpBar${side}`).style.background=pct<30?'#ff6b7a':'var(--hp)';
    $(`hpNum${side}`).textContent=`${u.hp}/${u.maxhp}`;

    // SP
    let pips=''; for(let i=0;i<6;i++) pips+=`<div class="pip ${i<u.sp?'on':''}"></div>`;
    $(`sp${side}`).innerHTML=pips;
    
    if(u.hp<=0) $(`unit${side}`).classList.add('dead');
    else $(`unit${side}`).classList.remove('dead');
  };
  draw('A', getA());
  draw('B', getB());

  const spReady = getA().sp>=6;
  $('btnSP').disabled = !spReady;
  $('btnSP').className = `spToggle ${state.A.spOn?'on':''}`;
  $('btnSP').textContent = state.A.spOn ? 'âœ¨ å¿…æ®º ON' : 'âœ¨ å¿…æ®º OFF';
}

// === ã‚¿ã‚¤ãƒãƒ¼ ===
function startTimer(){
  clearInterval(state.timer);
  state.remain=15;
  updateTimerUI();
  state.timer=setInterval(()=>{
    state.remain--;
    updateTimerUI();
    if(state.remain<=0){
      clearInterval(state.timer);
      pick(['G','C','P'][Math.floor(Math.random()*3)]); // æ™‚é–“åˆ‡ã‚Œã§ãƒ©ãƒ³ãƒ€ãƒ 
    }
  },1000);
}
function updateTimerUI(){
  const el=$('timerVal');
  el.textContent=state.remain;
  el.className=`timer-val ${state.remain<=5?'':'safe'}`;
}

// === æ´¾æ‰‹ãªã˜ã‚ƒã‚“ã‘ã‚“æ¼”å‡º (ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼) ===
async function playJankenEffect(userH, cpuH, res){
  const layer=$('fxLayer');
  const hL=$('fxHandL');
  const hR=$('fxHandR');
  const txt=$('fxText');
  const flash=$('flash');
  
  const map={G:'âœŠ',C:'âœŒï¸',P:'ğŸ–'};
  hL.textContent = map[userH];
  hR.textContent = map[cpuH];

  // 1. æ‰‹ãŒç”»é¢å¤–ã‹ã‚‰é£›ã‚“ã§ãã‚‹
  layer.classList.add('fx-active');
  await delay(300); // ã¶ã¤ã‹ã‚‹ã¾ã§ã®æ™‚é–“

  // 2. è¡çªï¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼
  flash.classList.add('flash-now');
  
  // 3. çµæœæ–‡å­—ã®è¡¨ç¤º
  let msg="DRAW";
  let color="#fff";
  if(res===1) { msg="WIN!"; color="var(--ally)"; }
  if(res===-1){ msg="LOSE"; color="var(--enemy)"; }
  
  txt.textContent=msg;
  txt.style.textShadow=`0 0 40px ${color}`;
  txt.classList.add('show');

  await delay(1000); // çµæœã‚’è¦‹ã›ã‚‹æ™‚é–“

  // 4. ç‰‡ä»˜ã‘
  layer.classList.remove('fx-active');
  flash.classList.remove('flash-now');
  txt.classList.remove('show');
}

// === ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ===
function judge(a,b){
  if(a===b)return 0;
  if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;
  return -1;
}

async function pick(hand){
  if(state.busy)return;
  state.busy=true;
  clearInterval(state.timer); // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—
  
  const cpuHand=['G','C','P'][Math.floor(Math.random()*3)];
  const res=judge(hand,cpuHand);

  // æ¼”å‡ºå®Ÿè¡Œ
  await playJankenEffect(hand, cpuHand, res);
  
  if(res===0){
    log(`ã‚ã„ã“ï¼ (${hand} vs ${cpuHand})`);
    state.busy=false;
    startTimer(); // ã‚¿ã‚¤ãƒãƒ¼å†é–‹
    return;
  }

  // æ”»æ’ƒå‡¦ç†
  const isPlayerAtk = res===1;
  const at = isPlayerAtk ? getA() : getB();
  const df = isPlayerAtk ? getB() : getA();
  const side = isPlayerAtk ? 'A' : 'B';

  const useSP = isPlayerAtk ? (state.A.spOn && at.sp>=6) : (at.sp>=6); // CPUã¯æºœã¾ã£ãŸã‚‰å³æ’ƒã¡
  
  if(useSP){
    log(`âš¡ï¸ ${at.name}ã®å¿…æ®ºæŠ€ï¼ï¼`, 'sys');
    at.sp=0; if(isPlayerAtk) state.A.spOn=false;
  }else{
    log(`âš”ï¸ ${at.name}ã®æ”»æ’ƒï¼`);
    at.sp=Math.min(6, at.sp+1);
  }

  // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
  await delay(200);
  const aff=getAff(at.type, df.type);
  let dmg=Math.floor(at.atk * (useSP?2.2:1.0) * aff * (0.9+Math.random()*0.2));
  df.hp=Math.max(0, df.hp-dmg);

  // ç”»é¢æºã‚Œ
  $(`unit${isPlayerAtk?'B':'A'}`).classList.add('hit');
  setTimeout(()=>$(`unit${isPlayerAtk?'B':'A'}`).classList.remove('hit'), 400);

  log(`${df.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${aff>1?'(æŠœç¾¤)':''}`, 'dmg');
  render();

  await delay(800);

  // æ±ºç€åˆ¤å®š
  if(df.hp<=0){
    log(`ğŸ’€ ${df.name}ã¯å€’ã‚ŒãŸï¼`, 'sys');
    await handleKO(isPlayerAtk?'B':'A');
  }

  state.busy=false;
  if(state.A.team.some(u=>u.hp>0) && state.B.team.some(u=>u.hp>0)){
    startTimer(); // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
  }
}

async function handleKO(deadSide){
  const team = deadSide==='A'?state.A.team:state.B.team;
  const alive = team.map((u,i)=>u.hp>0?i:-1).filter(i=>i!==-1);

  if(alive.length===0){
    // ã‚²ãƒ¼ãƒ çµ‚äº†
    $('resTitle').textContent = deadSide==='B' ? "YOU WIN!" : "YOU LOSE...";
    $('resTitle').style.color = deadSide==='B' ? "#ffe066" : "#aab";
    toggleModal('modalResult', true);
    return;
  }

  if(deadSide==='A'){
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äº¤ä»£ï¼ˆå¼·åˆ¶ï¼‰
    await delay(500);
    toggleModal('modalSwap', true);
  }else{
    // CPUäº¤ä»£ï¼ˆè‡ªå‹•ï¼šæœ‰åˆ©å±æ€§ã‚’é¸ã¶ï¼‰
    await delay(1000);
    const myType = getA().type;
    let bestIdx = alive[0];
    let bestScore = 0;
    alive.forEach(i=>{
      const score = getAff(team[i].type, myType);
      if(score > bestScore) { bestScore=score; bestIdx=i; }
    });
    state.B.idx = bestIdx;
    log(`CPUã¯ ${getB().name} ã‚’ç¹°ã‚Šå‡ºã—ãŸï¼`, 'sys');
    render();
  }
}

// === ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===
function init(){
  const mkSel=(root,prefix)=>{
    root.innerHTML='';
    for(let i=0;i<3;i++){
      const d=document.createElement('div'); d.className='slot';
      d.innerHTML=`<span class="pill">#${i+1}</span><select id="${prefix}${i}"></select>`;
      root.appendChild(d);
      const s=d.querySelector('select');
      WORDS.forEach((w,idx)=>{
        const o=document.createElement('option');
        o.value=idx; o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;
        s.appendChild(o);
      });
      s.value=Math.floor(Math.random()*WORDS.length);
    }
  };
  mkSel($('setupA'), 'p');
  mkSel($('setupB'), 'c');
  
  $('btnRand').onclick=init;
  $('btnStart').onclick=startBattle;
  
  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  $('btnG').onclick=()=>pick('G');
  $('btnC').onclick=()=>pick('C');
  $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{if(getA().sp>=6){state.A.spOn=!state.A.spOn; render();}};
  $('btnSwap').onclick=()=>{if(!state.busy) toggleModal('modalSwap',true);};
}

function startBattle(){
  const getTeam=(pre)=>[0,1,2].map(i=>makeUnit(WORDS[$(`${pre}${i}`).value]));
  state.A.team=getTeam('p'); state.A.idx=0; state.A.spOn=false;
  state.B.team=getTeam('c'); state.B.idx=0;
  
  $('setup').style.display='none';
  $('battle').style.display='grid';
  render();
  log('ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼åˆ¶é™æ™‚é–“ã¯15ç§’ï¼');
  startTimer();
}

// === ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»äº¤ä»£ ===
function toggleModal(id, show){
  $(id).classList.toggle('show', show);
  if(id==='modalSwap' && show){
    const list=$('swapList'); list.innerHTML='';
    state.A.team.forEach((u,i)=>{
      if(i===state.A.idx || u.hp<=0) return;
      const b=document.createElement('button');
      b.className='unit'; // ã‚¹ã‚¿ã‚¤ãƒ«æµç”¨
      b.style.textAlign='left';
      b.style.cursor='pointer';
      b.innerHTML=`<div class="nm">${u.name}</div><div style="font-size:12px">HP:${u.hp} TYPE:${u.type}</div>`;
      b.onclick=()=>{ doSwap(i); toggleModal('modalSwap',false); };
      list.appendChild(b);
    });
    if(list.children.length===0 && state.A.team[state.A.idx].hp>0){
      log('äº¤ä»£ã§ãã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“');
      toggleModal('modalSwap',false);
    }
  }
}

async function doSwap(newIdx){
  const deadSwap = getA().hp<=0;
  state.A.idx = newIdx;
  state.A.spOn = false;
  log(`ğŸ”„ ${getA().name} ã«äº¤ä»£ã—ãŸï¼`, 'sys');
  render();

  // æˆ¦é—˜ä¸èƒ½ã«ã‚ˆã‚‹äº¤ä»£ã§ãªã‘ã‚Œã°ã€ç›¸æ‰‹ã®æ”»æ’ƒã‚’å—ã‘ã‚‹
  if(!deadSwap){
    state.busy=true;
    clearInterval(state.timer);
    await delay(500);
    log(`âš ï¸ äº¤ä»£ã®éš™ã‚’çªã‹ã‚ŒãŸï¼`, 'dmg');
    
    const at = getB();
    const df = getA();
    const aff = getAff(at.type, df.type);
    let dmg = Math.floor(at.atk * aff * 0.8); // äº¤ä»£ãƒšãƒŠãƒ«ãƒ†ã‚£ã¯å°‘ã—è»½æ¸›
    df.hp = Math.max(0, df.hp - dmg);
    
    $('unitA').classList.add('hit');
    setTimeout(()=>$('unitA').classList.remove('hit'), 400);
    log(`${df.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, 'dmg');
    render();
    
    if(df.hp<=0) await handleKO('A');
    else {
      state.busy=false;
      startTimer();
    }
  } else {
    // æˆ¦é—˜ä¸èƒ½å¾Œã®äº¤ä»£ãªã‚‰å³å†é–‹
    state.busy=false;
    startTimer();
  }
}

init();

</script>
</body>
</html>
