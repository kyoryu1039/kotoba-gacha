<!doctype html><html lang="ja"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOTOBA-BATTLE｜対戦 v7.4.5</title>
<style>
:root{
  --bg:#0b1227;--panel:#0f1633;--border:#1d2440;--muted:#96a7d6;--text:#eaf2ff;
  --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
  --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP",sans-serif}
header{position:sticky;top:0;z-index:5;background:rgba(11,18,39,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
.container{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:8px 0 0;font-size:28px}.sub{margin:4px 0 12px;color:var(--muted)}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
.card .body{padding:16px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
.ghost{background:transparent;border:1px dashed #2b3a70}
.pill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#0a1430;border:1px solid #2b3a70;color:#cfe2ff;font-weight:800}
.hidden{display:none!important}

/* 編成 */
#setup{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
.team{display:grid;gap:8px}
.slot{display:flex;gap:8px;align-items:center}
.slot select{flex:1;background:#0b1430;border:1px solid #25366b;color:#eaf2ff;padding:10px;border-radius:10px}

/* 選択中ステータス：スマホは縦3×横2 */
#statsGrid{display:grid;gap:10px}
@media(min-width:720px){ #statsGrid{grid-template-columns:1fr 1fr} }
.statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}
.setupMini{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
.setupMini .head{display:flex;justify-content:space-between;font-weight:800}
.setupMini .nums{margin-top:6px;font-size:12px;color:#cfe2ff;display:grid;grid-template-columns:repeat(2,1fr);gap:4px}
.note{color:#8aa0d6}

/* バトル全画面 */
body.battleMode{height:100vh;overflow:hidden}
body.battleMode header,.inSetup{display:none}
#battle{display:none}
body.battleMode #battle{display:block}

.arena{position:relative;min-height:100vh;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;background:#0d1326}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
.unit{border:1px solid #22325c;border-radius:12px;padding:10px;transition:transform .15s}
.ally{box-shadow:0 0 0 2px var(--ally) inset}.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
.nameRow{display:flex;justify-content:space-between;gap:8px;align-items:center}
.name{font-weight:900}.tag{font-size:12px;color:#c7d7ff}
.skillLine{margin-top:6px;padding:8px;border:1px solid #2c3a69;border-radius:10px;background:#0c1633}
.skillTitle{font-weight:900}.skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}
.bar{height:12px;background:#12321f;border-radius:8px;overflow:hidden;margin-top:6px}
.bar>span{display:block;height:100%;background:var(--hp);width:0%}
.hpAnim{transition:width .6s ease}
.gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
.gLabel{font-size:12px;color:#ffeaa7}
.gauge{display:flex;gap:4px}.pip{width:14px;height:12px;background:#342b0b;border:1px solid #5a480c;border-radius:3px;opacity:.7}
.pip.on{background:#ffe066;opacity:1}.readyPulse{animation:pulse 1.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}

/* パッド */
.pad{border:1px solid #22335f;border-radius:14px;background:linear-gradient(180deg,#0d1530,#0b1428);padding:8px}
.padInner{position:relative;width:min(520px,92vw);height:220px;margin:0 auto}
.rps{position:absolute;display:grid;place-items:center;width:92px;height:92px;border-radius:999px;border:none;color:#061225}
.rps .emo{font-size:34px}.rps .lbl{font-size:12px;margin-top:2px;font-weight:800}
.rps.g{left:8%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
.rps.c{right:8%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
.rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)}
.switchBtn{position:absolute;right:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
.spToggle{position:absolute;left:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
.spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
.spToggle:disabled{opacity:.5;filter:grayscale(.4)}

/* ベンチ */
.benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-height:18vh;overflow:auto;padding:6px;border:1px dashed #2b3a70;border-radius:12px;background:#0a1733;touch-action:pan-y}
.benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px;cursor:pointer}
.benchChip.good{outline:2px solid #69ffb6}

/* 六枚ステータス */
#sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.miniCard{border:1px solid #1a2b54;border-radius:10px;padding:8px;cursor:pointer}
.miniCard.ally{outline:2px solid var(--ally)} .miniCard.enemy{outline:2px solid var(--enemy)}
.miniHead{display:flex;justify-content:space-between;font-weight:800}
.miniBar{height:8px;background:#12321f;border-radius:6px;overflow:hidden;margin-top:4px}
.miniBar>span{display:block;height:100%;background:var(--hp);width:0%}

/* トースト */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(12px);padding:10px 14px;border-radius:12px;background:rgba(12,22,50,.95);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50;max-width:min(92vw,720px);line-height:1.6}
body.battleMode .toast{bottom:28vh}.toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}

/* FX */
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}} .shake{animation:shake .5s ease}
.fx-burst{box-shadow:0 0 0 3px rgba(255,224,102,.7),0 0 22px 6px rgba(255,224,102,.25);transition:.2s}

/* タイプ色 */
.t-ジオ{background:linear-gradient(180deg,#0f1730,#101f46)}
.t-アニマル{background:linear-gradient(180deg,#0f1c30,#132c4f)}
.t-フード{background:linear-gradient(180deg,#0f1a26,#1f2c46)}
.t-コンセプト{background:linear-gradient(180deg,#12182e,#1b2544)}
.t-サイエンス{background:linear-gradient(180deg,#0e1d2f,#0e2c48)}
.t-ヒストリー{background:linear-gradient(180deg,#12172a,#1b2142)}
.t-ヒューマン{background:linear-gradient(180deg,#121a28,#1e2941)}
/* 初期化エラー */
#bootErr{position:fixed;inset:10px 10px auto 10px;background:#2b0e12;color:#ffdede;border:1px solid #ff8080;border-radius:10px;padding:10px;display:none;z-index:100}
</style>
</head>
<body>
<header class="inSetup"><div class="container">
  <h1>対戦 v7.4.5</h1>
  <div class="sub">UI/トースト/必殺制御/ベンチ/相性/基礎値ポップ</div>
</div></header>

<div id="bootErr"></div>

<main class="container inSetup" id="setup">
  <section class="card">
    <h2>チーム編成（あなた / CPU）</h2>
    <div class="body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">あなた</strong></div>
          <div class="team" id="teamA"></div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
          <div class="team" id="teamB"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="randBoth" class="ghost">ランダムでチームを編成</button>
        <span class="note" id="dupNote"></span>
        <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">対戦開始</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>選択中のステータス</h2>
    <div class="body">
      <div id="statsGrid">
        <div class="statsCol" id="statsA"></div>
        <div class="statsCol" id="statsB"></div>
      </div>
    </div>
  </section>
</main>

<section id="battle">
  <section class="card"><h2 style="display:none">バトル</h2>
    <div class="body">
      <div class="arena">
        <div class="vsrow">
          <div id="leftWrap"></div>
          <div id="rightWrap"></div>
        </div>

        <div class="pad">
          <div class="padInner">
            <button class="rps g" id="handG"><div class="emo">✊</div><div class="lbl">グー</div></button>
            <button class="rps c" id="handC"><div class="emo">✌️</div><div class="lbl">チョキ</div></button>
            <button class="rps p" id="handP"><div class="emo">🖐</div><div class="lbl">パー</div></button>
            <button class="switchBtn" id="btnSwitch">🔁 交代</button>
            <button class="spToggle" id="btnSP" disabled>✨ 必殺 OFF</button>
          </div>
          <div class="benchBar" id="benchBar"></div>
        </div>

        <div class="timer"><span class="label">選択まで</span> <span class="num" id="countNum">15</span> <span class="label">秒</span></div>
        <div id="sixStats"></div>
        <div class="toast" id="toast">...</div>
      </div>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div id="summary" class="small muted">バトル準備中</div>
        <button id="backSetup">編成に戻る</button>
      </div>
    </div>
  </section>
</section>

<script>
(function(){
"use strict";
const $=id=>document.getElementById(id);
const boot=$('bootErr'),panic=msg=>{boot.style.display='block';boot.textContent=msg};
window.addEventListener('error',e=>panic('JSエラー: '+(e?.message||e)));
window.addEventListener('unhandledrejection',e=>panic('Promiseエラー: '+(e?.reason?.message||e?.reason||e)));

function startOnce(){ if(document.body.dataset.kbInit==='done')return; document.body.dataset.kbInit='done'; init(); }
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',startOnce,{once:true}); } else { startOnce(); }

/* ================== 本体 ================== */

function init(){
  // --- データ（抜粋） ---
  const WORDS=[
    ["そぼろごはん","A","フード",540,88,72,10.5,"そぼろ乱舞","3回攻撃（0.75→0.5→0.25）。途中で倒しても次へ続く。"],
    ["にんじんしりしり","A","フード",540,86,74,10.5,"なんくるないさー","攻撃1.5倍＋次に受ける致死ダメージを1回だけHP1で耐える。"],
    ["ニシローランドゴリラ","A","アニマル",520,92,70,9.5,"マウンテンビート","初回1.5倍。以後2Tは1.3倍。"],
    ["毛むくじゃら","A","アニマル",520,90,71,9.5,"ムクジャララ","攻撃1.4倍＋回避率を3T 80%に。"],
    ["九品仏","A","ジオ",520,84,78,10.0,"仏の顔も三度まで","攻撃1.6倍＋被ダメ半減を3T。"],
    ["けんちん汁","A","フード",540,82,76,10.5,"長寿の秘訣","攻撃1.2倍＋HP150回復。"],

    ["カムチャッカ半島","B","ジオ",520,80,74,10.0,"言論統制","4T 交代不可。"],
    ["タランチュラ","B","アニマル",520,84,70,10.5,"言葉狩り","1T 行動不能。"],
    ["ハシビロコウ","B","アニマル",520,83,71,10.0,"言論統制","4T 交代不可。"],
    ["バルサミコ酢","B","フード",520,86,69,10.5,"言論統制","4T 交代不可。"],
    ["ピロリ菌","B","サイエンス",520,82,73,10.5,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],
    ["トリニダード・トバゴ","B","ジオ",520,81,73,10.0,"言葉狩り","1T 行動不能。"],
    ["カラメル色素","B","サイエンス",520,82,72,10.5,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],

    ["バビロン捕囚","C","ヒストリー",500,76,73,11.0,"言論統制","4T 交代不可。"],
    ["鳥取砂丘","C","ジオ",500,78,72,11.0,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],
    ["プラシーボ効果","C","サイエンス",500,79,71,11.0,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],
    ["渡来人","C","ヒューマン",500,77,73,11.0,"文字化け","3T後に戦闘不能。交代で解除。"],
    ["さるびあ丸","C","ジオ",500,77,72,11.0,"言葉狩り","1T 行動不能。"],
    ["ペペロンチーノ","C","フード",500,79,71,11.0,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],
    ["ポリプロピレン","C","サイエンス",500,80,70,11.0,"言論統制","4T 交代不可。"],
    ["サラエボ事件","C","ヒストリー",500,76,74,11.0,"言葉狩り","1T 行動不能。"],

    ["クマンバチ","D","アニマル",480,60,72,10.5,"言論統制","4T 交代不可。"],
    ["県庁所在地","D","ジオ",480,58,75,11.0,"文字化け","3T後に戦闘不能。交代で解除。"],
    ["照り焼きチキン","D","フード",480,59,74,11.0,"言論統制","4T 交代不可。"],
    ["ねるねるねるね","D","フード",480,58,73,11.0,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],
    ["スルメイカ","D","アニマル",480,60,72,10.5,"ゲシュタルト崩壊","4Tの間、攻撃時33%で自傷100。"],

    ["本質","X","コンセプト",500,75,72,10.0,"鏡文字","相手の誰かの必殺をコピーして威力2倍。"]
  ];
  const TYPES_RING=['ヒストリー','ジオ','コンセプト','サイエンス','アニマル','ヒューマン','フード'];
  const typeMult=(atk,def)=>{
    const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);
    if(i<0||j<0) return 1;
    const strong=[(i+1)%n,(i+2)%n], weak=[(i-1+n)%n,(i-2+n)%n];
    if(strong.includes(j)) return 1.5;
    if(weak.includes(j)) return 0.67;
    return 1;
  };
  const TYPE_CLASS=t=>`t-${t}`;

  /* ========== 編成UI ========== */
  const teamA=$('teamA'),teamB=$('teamB');
  const makeSlots=(root,side)=>{
    root.innerHTML='';
    for(let i=0;i<3;i++){
      const div=document.createElement('div');div.className='slot';
      const sel=document.createElement('select');sel.id=`${side}-sel-${i}`;
      WORDS.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;sel.append(o);});
      const pill=document.createElement('span');pill.className='pill';pill.textContent=`#${i+1}`;
      div.append(pill,sel);root.append(div);
    }
  };
  makeSlots(teamA,'A');makeSlots(teamB,'B');

  // 重複禁止：両軍で1回まで
  function applyNoDup(){
    const used=new Set();
    for(let s of ['A','B'])for(let i=0;i<3;i++){ const v=$(`${s}-sel-${i}`).value; if(v!=='') used.add(v); }
    for(let s of ['A','B'])for(let i=0;i<3;i++){
      const sel=$(`${s}-sel-${i}`);
      [...sel.options].forEach(op=>op.disabled = used.has(op.value) && op.value!==sel.value);
    }
    $('dupNote').textContent='同じ言葉は両チーム合計で1回まで（候補は自動でグレーアウト）。';
  }
  teamA.addEventListener('change',()=>{renderMini('A');applyNoDup();});
  teamB.addEventListener('change',()=>{renderMini('B');applyNoDup();});

  const statsA=$('statsA'),statsB=$('statsB');
  function renderMini(side){
    const root=side==='A'?statsA:statsB;
    root.innerHTML='';
    for(let i=0;i<3;i++){
      const idx=Number($(`${side}-sel-${i}`).value)||0;
      const [n,rank,typ,hp,atk,def,eva]=WORDS[idx];
      const wrap=document.createElement('div');wrap.className=`setupMini ${TYPE_CLASS(typ)}`;
      wrap.innerHTML=`<div class="head"><div>${n}</div><div class="tag">[${typ}]</div></div>
      <div class="nums"><div>HP ${hp}</div><div>回避 ${eva.toFixed(1)}%</div><div>ATK ${atk}</div><div>DEF ${def}</div></div>`;
      root.append(wrap);
    }
  }
  renderMini('A');renderMini('B');applyNoDup();

  $('randBoth').onclick=()=>{
    const picks=()=>{
      const used=new Set(),res=[];
      while(res.length<3){const i=Math.floor(Math.random()*WORDS.length);if(!used.has(i)){used.add(i);res.push(i);}}
      return res;
    };
    const a=picks(),b=picks();
    a.forEach((v,i)=>$('A-sel-'+i).value=v);
    b.forEach((v,i)=>$('B-sel-'+i).value=v);
    renderMini('A');renderMini('B');applyNoDup(); toast('ランダムでチームを編成しました');
  };

  /* ========== バトル ========== */
  const state={A:{team:[],idx:0,sp:0},B:{team:[],idx:0,sp:0},timer:null,remain:15,spOn:false,busy:false};

  $('toBattle').onclick=()=>{
    state.A.team=selectPack('A'); state.B.team=selectPack('B');
    state.A.idx=0;state.B.idx=0;state.A.sp=0;state.B.sp=0;state.spOn=false;
    enterBattle();
  };
  $('backSetup').onclick=()=>{document.body.classList.remove('battleMode');document.querySelectorAll('.inSetup').forEach(e=>e.style.display='block');$('battle').style.display='none';toast('編成に戻りました');};

  function selectPack(side){
    const arr=[];
    for(let i=0;i<3;i++){ const w=WORDS[Number($(`${side}-sel-${i}`).value)||0]; arr.push(pack(w,side)); }
    return arr;
  }
  function pack([n,rank,typ,hp,atk,def,eva,sk,skd],side){return {name:n,rank,type:typ,maxhp:hp,hp,atk,def,eva,skill:sk,skillDesc:skd,side};}
  const left =()=>state.A.team[state.A.idx], right=()=>state.B.team[state.B.idx];

  function enterBattle(){
    document.querySelectorAll('.inSetup').forEach(e=>e.style.display='none');
    document.body.classList.add('battleMode'); $('battle').style.display='block';
    renderSides(); buildBench(); buildSixStats();
    (async ()=>{
      await showToast(`いけ、${left().name}！バトルスタート！`);
      startRound();
    })();
  }

  /* カード描画 */
  function gaugeHtml(side){
    const sp=side==='A'?state.A.sp:state.B.sp;
    const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
    const pulse=sp>=6?'readyPulse':'';
    return `<div class="gaugeWrap"><div class="gLabel">必殺ゲージ</div><div class="gauge ${pulse}" id="g${side}">${pips}</div></div>`;
  }
  function affinityHtml(att,def){
    const m=typeMult(att.type,def.type); const txt=m===1.5?'相性 x1.5（抜群）':m===0.67?'相性 x0.67（いまいち）':'相性 x1.0（等倍）';
    return `<div class="tag">${txt}</div>`;
  }
  function cardHtml(u,role,opp){ return `
    <div class="unit ${role} ${TYPE_CLASS(u.type)}" id="card-${role}">
      <div class="nameRow"><div class="name">${u.name}</div><div class="tag">[${u.type}]</div></div>
      <div class="bar"><span id="hpbar-${role}" class="hpAnim" style="width:${100*u.hp/u.maxhp}%"></span></div>
      ${gaugeHtml(role==='ally'?'A':'B')}
      <div class="skillLine"><div class="skillTitle">必殺：${u.skill}</div>
        <div class="skillDesc" id="skdesc-${role}">${u.skillDesc}</div>
        ${opp?affinityHtml(u,opp):''}
      </div>
      <div class="meta" style="margin-top:6px;font-size:12px;color:#cfe2ff">HP ${u.hp}/${u.maxhp}・ATK ${u.atk}・DEF ${u.def}・回避 ${u.eva}%</div>
    </div>`; }
  function renderSides(){
    $('leftWrap').innerHTML=cardHtml(left(),'ally',right());
    $('rightWrap').innerHTML=cardHtml(right(),'enemy',left());
    updateSPButton();
    attachCardPop('ally',left()); attachCardPop('enemy',right());
  }
  function attachCardPop(role,unit){
    const el=$('card-'+role);
    el.onclick=()=>showToast(`${unit.name} 基礎値｜HP:${unit.maxhp} / ATK:${unit.atk} / DEF:${unit.def} / 回避:${unit.eva}%`);
  }
  function updateSPButton(){
    const ready=state.A.sp>=6;
    $('gA')?.classList.toggle('readyPulse',ready);
    $('btnSP').disabled=!ready;
    $('btnSP').classList.toggle('on',state.spOn);
    $('btnSP').textContent = (state.spOn?'✨ 必殺 ON':'✨ 必殺 OFF');
  }

  /* ベンチ */
  function buildBench(){
    const bar=$('benchBar'); bar.innerHTML='';
    const idxs=state.A.team.map((_,i)=>i).filter(i=>i!==state.A.idx);
    if(!idxs.length){ bar.innerHTML='<span class="note">控えなし</span>'; return; }
    idxs.forEach(i=>{
      const u=state.A.team[i], good=typeMult(u,right().type)>1;
      const chip=document.createElement('div'); chip.className='benchChip'+(good?' good':'');
      chip.innerHTML=`<span>🪪 ${u.name}</span><span class="tag">[${u.type}]</span>${good?'<span class="tag">おすすめ</span>':''}`;
      chip.onclick=()=>{ state.A.idx=i; showToast(`いけ、${left().name}！`); renderSides(); buildBench(); };
      bar.append(chip);
    });
  }

  /* 六枚まとめ */
  function buildSixStats(){
    const root=$('sixStats'); root.innerHTML='';
    const mk=(u,role)=>{ const div=document.createElement('div');div.className=`miniCard ${role}`; div.innerHTML=
      `<div class="miniHead"><div>${u.name}</div><div class="tag">[${u.type}]</div></div>
       <div class="miniBar"><span style="width:${100*u.hp/u.maxhp}%"></span></div>
       <div style="margin-top:4px;font-size:12px;color:#cfe2ff">HP ${u.hp}/${u.maxhp}</div>`;
      div.onclick=()=>showToast(`${u.name} 基礎値｜HP:${u.maxhp} / ATK:${u.atk} / DEF:${u.def} / 回避:${u.eva}%`);
      root.append(div);
    };
    mk(left(),'ally'); mk(right(),'enemy');
    state.A.team.map((u,i)=>i!==state.A.idx&&mk(u,'ally'));
    state.B.team.map((u,i)=>i!==state.B.idx&&mk(u,'enemy'));
  }

  /* トースト（可変滞留） */
  async function showToast(msg){ const t=$('toast'); const base=900, per=22;
    t.textContent=msg; t.classList.add('show'); clearTimeout(t._h);
    const stay=Math.min(4200, base + Math.max(0,msg.length-12)*per);
    await new Promise(r=> t._h=setTimeout(()=>{t.classList.remove('show'); r();}, stay));
  }

  /* RPS 操作 */
  $('handG').onclick=()=>pick('G');
  $('handC').onclick=()=>pick('C');
  $('handP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{ if(state.A.sp>=6){ state.spOn=!state.spOn; updateSPButton(); } };
  $('btnSwitch').onclick=()=>{ buildBench(); showToast('控えから出すカードをタップ'); };

  function startRound(){ state.remain=15; $('countNum').textContent=state.remain;
    clearInterval(state.timer); state.timer=setInterval(()=>{
      state.remain--; $('countNum').textContent=state.remain;
      if(state.remain<=0){ const r=['G','C','P'][Math.floor(Math.random()*3)]; pick(r); }
    },1000);
  }
  function judge(a,b){ if(a===b) return 0; if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G')) return 1; return -1; }

  async function pick(h){
    if(state.busy) return; state.busy=true;
    clearInterval(state.timer);
    const cpuH=['G','C','P'][Math.floor(Math.random()*3)];
    const you={G:'グー',C:'チョキ',P:'パー'}[h], cpu={G:'グー',C:'チョキ',P:'パー'}[cpuH];
    const res=judge(h,cpuH);
    await showToast(`あなたは ${you}。相手は ${cpu}。${res>0?'あなたの勝ち':res<0?'あなたの負け':'あいこ'}。`);
    // ゲージ加算（あいこでも+1）
    state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
    if(res>0){ await doAttack(left(),right(),state.spOn && state.A.sp>=6,'ally'); if(state.spOn && state.A.sp>=6){ state.A.sp=0; state.spOn=false; } }
    else if(res<0){ await doAttack(right(),left(),false,'enemy'); }
    updateSPButton(); renderSides(); buildSixStats(); buildBench();
    state.busy=false; startRound();
  }

  async function doAttack(att,def,useSP,role){
    // 必殺FX（直前）
    if(useSP){ const el=$('card-'+(role==='ally'?'ally':'enemy')); el.classList.add('fx-burst'); setTimeout(()=>el.classList.remove('fx-burst'),220); }
    // ダメージ計算（簡易）
    let base=100*(1+att.atk/100)/(1+def.def/120)*typeMult(att.type,def.type);
    let dmg=Math.round(base*(useSP?1.6:1.0)); // 参考倍率
    if(!useSP && Math.random()<def.eva/100) dmg=0;
    await showToast(`${att.name}の${useSP?'必殺！':'攻撃！'} ${dmg}ダメージ！`);
    // HP減少はアナウンス後
    const before=def.hp; def.hp=Math.max(0,def.hp-dmg);
    const bar=$('hpbar-'+(role==='ally'?'enemy':'ally')); if(bar){ bar.style.width=`${100*def.hp/def.maxhp}%`; }
    // 被弾側カード揺れ
    const box=$('card-'+(role==='ally'?'enemy':'ally')); box?.classList.add('shake'); setTimeout(()=>box?.classList.remove('shake'),500);
    if(def.hp<=0){ await showToast(`${def.name}は倒れた！`); }
  }

  // 最初のヒント
  showToast('READY: 初期化完了。編成→対戦開始で遷移します。');
} // init
})();
</script>
</body></html>
