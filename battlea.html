<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1">
<title>KOTOBA-BATTLE | å¯¾æˆ¦ v7.20 (art override)</title>
<style>
:root{
  --bg:#fff7e9; --text:#eaf2ff;
  --panel:#0f1633; --panel2:#0e1530; --border:#20335f; --shadow:0 18px 44px rgba(0,0,0,.18);

  --ally:#27b1ff; --enemy:#ff6b7a;
  --hp:#63ff8c; --hpBack:#0f2a1c; --gauge:#ffe066; --gaugeBack:#31260a;

  /* ã‚¿ã‚¤ãƒ—è‰²ï¼ˆæ¿ƒè‰²ãƒ»è¦–èªæ€§é‡è¦–ï¼‰ */
  --t-ã‚¸ã‚ª:#7aa0ff;       --tbg-ã‚¸ã‚ª:linear-gradient(180deg,#0f1837 0%, rgba(122,160,255,.7) 100%);
  --t-ã‚¢ãƒ‹ãƒãƒ«:#34d790;   --tbg-ã‚¢ãƒ‹ãƒãƒ«:linear-gradient(180deg,#0a2725 0%, rgba(52,215,144,.7) 100%);
  --t-ãƒ•ãƒ¼ãƒ‰:#ffbf4d;     --tbg-ãƒ•ãƒ¼ãƒ‰:linear-gradient(180deg,#261a07 0%, rgba(255,191,77,.7) 100%);
  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#b68cff; --tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:linear-gradient(180deg,#221742 0%, rgba(182,140,255,.7) 100%);
  --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#2dd6ff; --tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:linear-gradient(180deg,#0c2638 0%, rgba(45,214,255,.7) 100%);
  --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff7a9a;--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:linear-gradient(180deg,#2b1522 0%, rgba(255,122,154,.7) 100%);
  --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#5ff3d3; --tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:linear-gradient(180deg,#123235 0%, rgba(95,243,211,.7) 100%);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP",sans-serif;overflow-x:hidden}
.container{max-width:1024px;margin:0 auto;padding:10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
.card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
.card .body{padding:12px}
.note{color:#c9d7ff;font-size:12px}

/* ç·¨æˆ */
#setup{display:grid;gap:12px}
#teamGrid{display:grid;gap:10px}
@media(min-width:720px){#teamGrid{grid-template-columns:1fr 1fr}}
.slot{display:flex;gap:8px;align-items:center}
.pill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#0b1430;border:1px solid #2b3a70;color:#cfe2ff;font-weight:800}
.slot select{flex:1;background:#0b1430;border:1px solid #25366b;color:#eaf2ff;padding:10px;border-radius:12px}
.statsHead{font-weight:900;margin:2px 0 6px}
#statsGrid{display:grid;gap:12px}
@media(min-width:720px){#statsGrid{grid-template-columns:1fr 1fr}}
.statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}
.setupMini{border:2px solid #203060;border-radius:12px;padding:10px;position:relative}
.setupMini[data-type="ã‚¸ã‚ª"]{background:var(--tbg-ã‚¸ã‚ª);box-shadow:0 0 0 3px var(--t-ã‚¸ã‚ª) inset}
.setupMini[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{background:var(--tbg-ã‚¢ãƒ‹ãƒãƒ«);box-shadow:0 0 0 3px var(--t-ã‚¢ãƒ‹ãƒãƒ«) inset}
.setupMini[data-type="ãƒ•ãƒ¼ãƒ‰"]{background:var(--tbg-ãƒ•ãƒ¼ãƒ‰);box-shadow:0 0 0 3px var(--t-ãƒ•ãƒ¼ãƒ‰) inset}
.setupMini[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{background:var(--tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ);box-shadow:0 0 0 3px var(--t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ) inset}
.setupMini[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{background:var(--tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹);box-shadow:0 0 0 3px var(--t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹) inset}
.setupMini[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{background:var(--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼);box-shadow:0 0 0 3px var(--t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼) inset}
.setupMini[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{background:var(--tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³);box-shadow:0 0 0 3px var(--t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³) inset}
.setupMini .head{display:flex;justify-content:space-between;font-weight:800}

/* ç›¸å¯¾ãƒãƒ¼ï¼ˆHP800/æ”»120/é˜²120/å›é¿20ã‚’åŸºæº–ã«%ï¼‰ */
.barLine{display:flex;align-items:center;gap:10px;margin-top:6px}
.barBox{flex:1;min-width:140px;height:16px;background:#0e1b31;border:1px solid #2a3a6b;border-radius:8px;overflow:hidden}
.barFill{height:100%;background:var(--hp)}
.val{font-size:12px;color:#cfe2ff;width:96px;text-align:right}

/* è¡¨ç¤ºåˆ‡æ›¿ */
.inSetup{display:block}.inBattle{display:none}
.battleMode .inSetup{display:none}.battleMode .inBattle{display:block}

/* ãƒãƒˆãƒ« */
.arena{min-height:calc(100vh - 120px);display:grid;grid-template-rows:auto auto auto auto;gap:10px}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ */
.unit{border:1px solid #243567;border-radius:14px;padding:10px;position:relative;min-height:260px}
.unit[data-type="ã‚¸ã‚ª"]{background:var(--tbg-ã‚¸ã‚ª);--accent:var(--t-ã‚¸ã‚ª)}
.unit[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{background:var(--tbg-ã‚¢ãƒ‹ãƒãƒ«);--accent:var(--t-ã‚¢ãƒ‹ãƒãƒ«)}
.unit[data-type="ãƒ•ãƒ¼ãƒ‰"]{background:var(--tbg-ãƒ•ãƒ¼ãƒ‰);--accent:var(--t-ãƒ•ãƒ¼ãƒ‰)}
.unit[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{background:var(--tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ);--accent:var(--t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)}
.unit[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{background:var(--tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹);--accent:var(--t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹)}
.unit[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{background:var(--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼);--accent:var(--t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼)}
.unit[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{background:var(--tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³);--accent:var(--t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³)}
.owner{position:absolute;top:6px;left:6px;font-size:12px;padding:3px 9px;border-radius:999px;border:1px solid #2d3a70;background:#0b1635d8}
.owner.ally{color:var(--ally)} .owner.enemy{color:var(--enemy)}
.nameRow{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
.badge{font-size:12px;background:#0d1630;border:1px solid #2b3a70;padding:2px 8px;border-radius:999px}
.meta{font-size:12px;color:#cfe2ff;margin-top:6px}

/* ã‚¤ãƒ©ã‚¹ãƒˆæ  */
.artFrame{
  margin-top:8px;height:130px;border-radius:12px;
  border:2px solid var(--accent); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.04), 0 8px 20px rgba(0,0,0,.25);
}
.artFrame img{max-height:100%;max-width:100%;object-fit:contain;image-rendering:-webkit-optimize-contrast;filter:drop-shadow(0 10px 22px rgba(0,0,0,.38))}
.artFrame.noart::before{content:'NO IMAGE';color:#cfe2ff80;font-weight:900}

/* HPã‚²ãƒ¼ã‚¸ï¼ˆä¸Šæ®µï¼‰ */
.hpRow{display:flex;align-items:center;gap:10px;margin-top:8px}
.hpBox{flex:1;height:22px;background:var(--hpBack);border-radius:11px;overflow:hidden}
.hpFill{height:100%;background:var(--hp);transition:width .6s ease}
.hpNum{font-size:13px;width:160px;text-align:right}

/* å¿…æ®ºã‚²ãƒ¼ã‚¸ */
.gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
.gLabel{font-size:12px;color:#ffeaa7}
.gauge{display:flex;gap:4px}
.pip{width:16px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
.pip.on{background:var(--gauge);opacity:1}
.readyPulse{animation:pulse 1.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.55)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
.btnReady{animation:pulse 1.2s infinite}

/* æŠ€ã¨ç›¸æ€§ */
.skillWrap{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
.skillBox{border:1px solid #2c3a69;border-radius:12px;background:#0c1633;padding:10px}
.skillTitle{font-weight:900;display:flex;align-items:center;gap:6px}
.skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}
.affinityBox{border:1px solid #2c3a69;border-radius:12px;background:#0b1530;padding:8px;font-size:12px}

/* ç›¸å¯¾ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.statBars{margin-top:8px}
.statBars .barBox{height:16px}
.statBars .barLine .val{width:110px}

/* ãƒ‘ãƒƒãƒ‰ */
.pad{border:1px solid #233562;border-radius:14px;background:linear-gradient(180deg,#0d1530,#0b1428);padding:10px}
.padInner{position:relative;width:min(520px,96vw);height:200px;margin:0 auto}
.rps{position:absolute;display:grid;place-items:center;width:90px;height:90px;border-radius:999px;border:none;color:#061225;cursor:pointer}
.rps .emo{font-size:34px}.rps .lbl{font-size:12px;margin-top:2px;font-weight:800}
.rps.g{left:8%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
.rps.c{right:8%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
.rps.p{left:50%;transform:translateX(-50%);bottom:24%;background:linear-gradient(180deg,#defae5,#8bffb5)}
.switchBtn{position:absolute;right:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900;cursor:pointer}
.spToggle{position:absolute;left:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s;cursor:pointer}
.spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
.spToggle:disabled{opacity:.45;filter:grayscale(.5)}

/* ãƒœãƒƒã‚¯ã‚¹ */
#benchWrap{margin-top:0}
.benchTitle{font-weight:900;margin:6px 4px 4px}
#boxGrid{display:grid;gap:10px}
@media(min-width:720px){#boxGrid{grid-template-columns:1fr 1fr}}
.boxCol{background:var(--panel2);border:1px solid #233562;border-radius:12px;padding:8px}
#sixA,#sixB{display:grid;grid-template-columns:1fr;gap:10px}
.mini{border:1px solid #1a2b54;border-radius:12px;padding:8px;cursor:pointer;position:relative}
.mini[data-type="ã‚¸ã‚ª"]{background:var(--tbg-ã‚¸ã‚ª)} .mini[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{background:var(--tbg-ã‚¢ãƒ‹ãƒãƒ«)}
.mini[data-type="ãƒ•ãƒ¼ãƒ‰"]{background:var(--tbg-ãƒ•ãƒ¼ãƒ‰)} .mini[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{background:var(--tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)}
.mini[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{background:var(--tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹)} .mini[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{background:var(--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼)}
.mini[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{background:var(--tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³)}
.mini .head{display:flex;justify-content:space-between}
.mini .miniBar{height:11px;background:#11321f;border-radius:6px;overflow:hidden;margin-top:6px}
.mini .miniBar>span{display:block;height:100%;background:var(--hp)}

/* ã‚¿ã‚¤ãƒãƒ¼ï¼†ãƒˆãƒ¼ã‚¹ãƒˆ */
.timer{display:flex;justify-content:center;gap:8px;align-items:center;font-weight:900}
.timer .num{font-size:28px}
.toastArea{min-height:56px}
.toast{margin:6px auto 0;max-width:min(96vw,720px);padding:12px 16px;border-radius:14px;background:rgba(12,22,50,.96);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;transform:translateY(8px);transition:.22s ease}
.toast.show{opacity:1;transform:translateY(0)}

/* FX */
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
.shake{animation:shake .5s ease}
.fx-burst{box-shadow:0 0 0 3px rgba(255,224,102,.7),0 0 22px 6px rgba(255,224,102,.25);transition:.2s}

/* å‹æ•— */
#result{position:fixed;inset:0;background:rgba(6,10,26,.82);display:none;place-items:center;z-index:40}
#result .box{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:26px 28px;text-align:center;box-shadow:var(--shadow)}
#result h1{margin:0 0 8px;font-size:40px}
#result p{margin:4px 0 0;color:#cfe2ff}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
#switchModal,#infoModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:30}
.selCard{cursor:pointer} .selCard.selected{outline:3px solid #ffe066}

/* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
@media(max-width:600px){
  html{font-size:13.5px}
  .container{padding:8px}
  .vsrow{gap:6px}
  .unit{padding:8px;min-height:240px}
  .nameRow{margin-top:8px}
  .hpNum{width:120px}
  .skillBox{padding:8px}
  .padInner{width:96vw;height:176px}
  .rps{width:76px;height:76px}.rps .emo{font-size:28px}
  .switchBtn,.spToggle{width:112px;height:48px}
  .artFrame{height:120px}
}
</style>
</head>
<body>

<!-- ç·¨æˆ -->
<div class="container inSetup" id="setup">
  <section class="card">
    <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
    <div class="body">
      <div id="teamGrid">
        <div>
          <div class="statsHead" style="color:#27b1ff">ã‚ãªãŸ</div>
          <div id="teamA"></div>
        </div>
        <div>
          <div class="statsHead" style="color:#ff6b7a">CPU</div>
          <div id="teamB"></div>
        </div>
      </div>
      <div class="row" style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button id="btnRand" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
        <button id="btnStart" class="primary" style="margin-left:auto">å¯¾æˆ¦é–‹å§‹</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div class="body">
      <div id="statsGrid">
        <div>
          <div class="statsHead" style="color:#27b1ff">ã‚ãªãŸ</div>
          <div class="statsCol" id="statsA"></div>
        </div>
        <div>
          <div class="statsHead" style="color:#ff6b7a">CPU</div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ãƒãƒˆãƒ« -->
<div id="battle" class="container inBattle">
  <section class="card">
    <div class="body">
      <div class="arena">
        <div class="vsrow">
          <div id="leftWrap"></div>
          <div id="rightWrap"></div>
        </div>

        <div class="pad">
          <div class="padInner">
            <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
            <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
            <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
            <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
            <button class="spToggle" id="btnSP" disabled>âœ¨ å¿…æ®º OFF</button>
          </div>
        </div>

        <div class="toastArea"><div class="toast" id="toast"></div></div>
        <div class="timer">é¸æŠã¾ã§ <span class="num" id="countNum">15</span> ç§’</div>

        <div id="benchWrap">
          <div class="benchTitle">ãƒœãƒƒã‚¯ã‚¹</div>
          <div id="boxGrid">
            <div class="boxCol">
              <div class="statsHead" style="color:#27b1ff">ã‚ãªãŸã®ãƒœãƒƒã‚¯ã‚¹</div>
              <div id="sixA"></div>
            </div>
            <div class="boxCol">
              <div class="statsHead" style="color:#ff6b7a">CPUã®ãƒœãƒƒã‚¯ã‚¹</div>
              <div id="sixB"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="switchModal">
  <div class="card" style="min-width:min(92vw,560px)">
    <h2>äº¤ä»£å…ˆã‚’é¸æŠ</h2>
    <div class="body">
      <div id="switchGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
      <div class="row" style="display:flex;justify-content:space-between;margin-top:10px">
        <div id="swTimer" class="note">è‡ªå‹•äº¤ä»£ã¾ã§ 15 ç§’</div>
        <div>
          <button id="swCancel" class="ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="swDo" class="primary" disabled>äº¤ä»£ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="infoModal"><div class="card" style="min-width:min(92vw,520px)"><h2 id="infoTitle">æƒ…å ±</h2><div class="body" id="infoBody">...</div></div></div>

<!-- å‹æ•— -->
<div id="result"><div class="box"><h1 id="resTitle">YOU WIN!</h1><p id="resSub">3ç§’å¾Œã«ç·¨æˆã¸æˆ»ã‚‹â€¦</p></div></div>

<script>
(()=>{'use strict';
const $=id=>document.getElementById(id);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

/* ====== ç”»åƒè¨­å®šï¼ˆimage/ ã« 1024x1024 PNGï¼‰ ====== */
const IMG_BASE = './image/';
const IMG_OVERRIDES = {
  'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ':'parabola_antenna.png',
  'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼':'nescafe_ambassador.png',
  'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š':'ninjin_shirishiri.png',
  'ãã¼ã‚ã”ã¯ã‚“':'soboro_gohan.png',
  'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©':'western_lowland_gorilla.png',
  'æ¯›ã‚€ãã˜ã‚ƒã‚‰':'kemukujara.png',
  'ä¹å“ä»':'kuhonbutsu.png',
  'ã‘ã‚“ã¡ã‚“æ±':'kenchin_jiru.png',
  'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶':'kamchatka_peninsula.png',
  'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©':'tarantula.png',
  'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦':'shoebill.png',
  'ãƒãƒ«ã‚µãƒŸã‚³é…¢':'balsamic_vinegar.png',
  'ãƒ”ãƒ­ãƒªèŒ':'helicobacter_pylori.png',
  'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´':'trinidad_and_tobago.png',
  'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ':'caramel_color.png',
  'ãƒãƒ“ãƒ­ãƒ³æ•å›š':'babylonian_captivity.png',
  'é³¥å–ç ‚ä¸˜':'tottori_sand_dunes.png',
  'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ':'placebo_effect.png',
  'æ¸¡æ¥äºº':'torai_jin.png',
  'ã•ã‚‹ã³ã‚ä¸¸':'sarubia_maru.png',
  'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ':'peperoncino.png',
  'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³':'polypropylene.png',
  'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶':'sarajevo_incident.png',
  'ã‚¯ãƒãƒ³ãƒãƒ':'kumabachi.png',
  'çœŒåºæ‰€åœ¨åœ°':'prefectural_capital.png',
  'ç…§ã‚Šç„¼ããƒã‚­ãƒ³':'teriyaki_chicken.png',
  'ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­':'nerunerunerune.png',
  'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«':'surume_ika.png',
  'æœ¬è³ª':'essence.png',
  'è¦‹ãˆã‚‹åŒ–':'mieruka.png',
  'è‡ªåˆ†ã”ã¨åŒ–':'jibungotoka.png',
  'è§£åƒåº¦':'resolution.png'
};
function imgPath(name){ const fn = IMG_OVERRIDES[name] || (encodeURIComponent(name)+'.png'); return IMG_BASE + fn; }

/* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆ1.5s + 0.06sÃ—æ–‡å­—ï¼‰ */
const toastQueue=[]; let toastBusy=false;
function toast(msg){toastQueue.push(String(msg)); if(!toastBusy) runToast();}
function toastDuration(msg){const base=1500, per=60; return Math.min(9000, base + String(msg).length*per) + 120;}
async function runToast(){toastBusy=true;while(toastQueue.length){const t=$('toast'), m=toastQueue.shift(), stay=toastDuration(m);t.textContent=m;t.classList.add('show');await delay(stay);t.classList.remove('show');await delay(120);}toastBusy=false;}

/* ç›¸å¯¾ãƒãƒ¼åŸºæº– */
const MAX={HP:800,ATK:120,DEF:120,EVA:20};

/* ç›¸æ€§ãƒªãƒ³ã‚°ï¼ˆæœ€æ–°ï¼‰ */
const TYPES_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const st=[(i+1)%n,(i+2)%n], wk=[(i-1+n)%n,(i-2+n)%n];if(st.includes(j))return 1.5;if(wk.includes(j))return 0.67;return 1;};

/* ãƒ©ãƒ³ã‚¯ãƒ»HPåŸºæº– */
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

/* æ–‡å­—ç¨®ã‚«ã‚¦ãƒ³ãƒˆ */
const reKanaH=/[ã-ã‚Ÿ]/g,reKanaK=/[ã‚ -ãƒ¿ãƒ¼]/g,reKanji=/[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g,reSmallK=/[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°-ã‡¿]/g,reSokuon=/ãƒƒ/g,reVoiced=/[ã‚¬-ãƒãƒ´]/g,PLosiveEnd=/[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
const visualLen=s=>(s||"").replace(/[ãƒ»\s]/g,"").length; const toKatakana=s=>(s||"").replace(/[ã-ã‚“]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
function countClass(s){const H=(s.match(reKanaH)||[]).length,K=(s.match(reKanaK)||[]).length,J=(s.match(reKanji)||[]).length,t=H+K+J;return{H,K,J,total:t};}
function calcAttackDefense(name,yomi){let atkP=17.5,defP=17.5;const cls=countClass(name);if(cls.J+cls.K===0){atkP+=12.5;defP+=12.5;}else{const r=cls.K/(cls.J+cls.K);atkP+=25*r;defP+=25*(1-r);}const Lph=yomi.length||1;const d=(yomi.match(reVoiced)||[]).length/Lph,s=(yomi.match(reSokuon)||[]).length/Lph,m=(yomi.match(reSmallK)||[]).length/Lph,e=PLosiveEnd.test(yomi)?1:0;const raw=0.6*d+0.25*(s+m)+0.15*e,L=0.05,U=0.45,ph=Math.max(-1,Math.min(1,((raw-L)/(U-L))*2-1));const atk_ph=20*(0.5+0.5*ph);atkP+=atk_ph;defP+=20-atk_ph;const T=visualLen(name),len=Math.max(-1,Math.min(1,(6-T)/6));const atk_len=20*(0.5+0.5*len);atkP+=atk_len;defP+=20-atk_len;return{atkP,defP,T};}
function calcEvasion(name,T,rank){const cls=countClass(name);const Hratio=cls.total?(cls.H/cls.total):0;const adj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;let eva=10+8*Hratio-0.5*(T-5)+adj;eva=Math.round(eva*10)/10;return Math.max(5,Math.min(35,eva));}
function makeWordObject([name,rank,type,yomiH]){const y=toKatakana(yomiH||name);const {atkP,defP,T}=calcAttackDefense(name,y);const ATK=Math.round(PRANK[rank]*(atkP/100)),DEF=Math.round(PRANK[rank]*(defP/100)),HP=HP_BASE[rank]+20*(T-5),EVA=calcEvasion(name,T,rank);return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,/* çŠ¶æ…‹ */shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};}

/* å¿…æ®ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ”»æ’ƒã‚¿ãƒ¼ãƒ³è¡¨è¨˜ï¼ã ãƒ»ã§ã‚ã‚‹èª¿ï¼‰ */
const SKILLS={
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","ã“ã®ä¸€æ’ƒã¯2.5å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
 "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","é€šå¸¸æ”»æ’ƒã®ã‚ã¨ã€å‘³æ–¹å…¨å“¡ã®HPã‚’60å›å¾©ã™ã‚‹ï¼ˆè‡ªåˆ†ã‚‚60ï¼‰ã€‚"],
 "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","ã“ã®ä¸€æ’ƒã¯1.6å€ã§ã‚ã‚‹ã€‚æ¬¡ã«å—ã‘ã‚‹è‡´å‘½å‚·ã‚’1å›ã ã‘HP1ã§è€ãˆã‚‹ã€‚"],
 "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3é€£æ’ƒã§æ”»æ’ƒã™ã‚‹ï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚ç›¸æ‰‹ã‚’å€’ã—ãŸã‚‰æ¬¡ã®ç›¸æ‰‹ã«ã‚‚ç¶šãã€‚"],
 "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","ã“ã®ä¸€æ’ƒã¯1.5å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«è‡ªåˆ†ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ2å›æ¥ã‚‹ã¾ã§æ”»æ’ƒãŒ1.3å€ã§ã‚ã‚‹ã€‚"],
 "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","ã“ã®ä¸€æ’ƒã¯1.4å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«è‡ªåˆ†ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ2å›æ¥ã‚‹ã¾ã§å›é¿ç‡ã¯60%ã§ã‚ã‚‹ã€‚"],
 "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","ã“ã®ä¸€æ’ƒã¯1.6å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«è‡ªåˆ†ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ2å›æ¥ã‚‹ã¾ã§å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’åŠåˆ†ã«ã™ã‚‹ã€‚"],
 "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","ã“ã®ä¸€æ’ƒã¯1.2å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«HPã‚’150å›å¾©ã™ã‚‹ã€‚"],
 "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","å¯¾è±¡ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã¯è¡Œå‹•ã§ããªã„ã€‚"],
 "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","å¯¾è±¡ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã¯è¡Œå‹•ã§ããªã„ã€‚"],
 "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›çµŒéã—ãŸæ™‚ç‚¹ã§æˆ¦é—˜ä¸èƒ½ã«ãªã‚‹ï¼ˆäº¤ä»£ã§è§£é™¤ã•ã‚Œã‚‹ï¼‰ã€‚"],
 "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","å¯¾è±¡ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã¯è¡Œå‹•ã§ããªã„ã€‚"],
 "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","å¯¾è±¡ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã¯è¡Œå‹•ã§ããªã„ã€‚"],
 "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›çµŒéã—ãŸæ™‚ç‚¹ã§æˆ¦é—˜ä¸èƒ½ã«ãªã‚‹ï¼ˆäº¤ä»£ã§è§£é™¤ã•ã‚Œã‚‹ï¼‰ã€‚"],
 "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","å¯¾è±¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ãŒ3å›æ¥ã‚‹ã¾ã§ã€æ”»æ’ƒã®ãŸã³ã«33%ã§è‡ªå‚·100ã‚’å—ã‘ã‚‹ã€‚"],
 "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ã ã‚Œã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ã ã‚Œã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ã ã‚Œã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ã ã‚Œã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};

/* å…¨ãƒ¯ãƒ¼ãƒ‰ */
const WORDS_BASE=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const makeW=i=>makeWordObject(WORDS_BASE[i]);

/* çŠ¶æ…‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ */
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false,spAnnB:false};
const left =()=>state.A.team[state.A.i], right=()=>state.B.team[state.B.i];
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

/* ç›¸å¯¾ãƒãƒ¼è¡Œ */
function barRow(label,val,max){const pct=label==='å›é¿'?clamp((val/MAX.EVA)*100,0,100):clamp((val/max)*100,0,100);return `<div class="barLine"><div style="width:76px;font-size:12px;color:#cfe2ff">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="val">${label==='å›é¿'?val+'%':val}</div></div>`;}
function miniCard(idx){const w=makeW(idx);return `<div class="setupMini" data-type="${w.type}"><div class="head"><div>${w.name}</div><div class="badge">${w.type}</div></div>${barRow('HP',w.maxhp,MAX.HP)}${barRow('æ”»æ’ƒ',w.atk,MAX.ATK)}${barRow('é˜²å¾¡',w.def,MAX.DEF)}${barRow('å›é¿',w.eva,MAX.EVA)}</div>`;}
function renderMini(side){const root=side==='A'?$('statsA'):$('statsB');root.innerHTML='';for(let i=0;i<3;i++){const idx=Number($(`${side}-${i}`).value)||0;root.innerHTML+=miniCard(idx);}}

/* ç·¨æˆUI */
function makeTeam(root,side){
  root.innerHTML='';
  for(let i=0;i<3;i++){
    const div=document.createElement('div');div.className='slot';
    const pill=document.createElement('span');pill.className='pill';pill.textContent='#'+(i+1);
    const sel=document.createElement('select');sel.id=`${side}-${i}`;
    WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;sel.append(o);});
    sel.addEventListener('change',()=>{enforceUnique(side);renderMini(side);});
    div.append(pill,sel);root.append(div);
  }
  const picks=uniqueRandom(3,WORDS_BASE.length);picks.forEach((v,i)=>$(`${side}-${i}`).value=v);
  enforceUnique(side);renderMini(side);
}
function uniqueRandom(n,lim){const used=new Set(),arr=[];while(arr.length<n){const i=Math.floor(Math.random()*lim);if(!used.has(i)){used.add(i);arr.push(i)}}return arr;}
function enforceUnique(side){const selected=[0,1,2].map(i=>Number($(`${side}-${i}`).value));for(let i=0;i<3;i++){const sel=$(`${side}-${i}`);[...sel.options].forEach(opt=>{const v=Number(opt.value);opt.disabled=selected.includes(v)&&v!==Number(sel.value);});}}
const collect=side=>[0,1,2].map(i=>{const idx=Number($(`${side}-${i}`).value)||0;return {...makeW(idx),side};});

/* ãƒãƒˆãƒ«UI */
function gaugeHtml(sp,tag){const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');const pulse=sp>=6?'readyPulse':'';return `<div class="gaugeWrap"><div class="gLabel">å¿…æ®ºã‚²ãƒ¼ã‚¸</div><div class="gauge ${pulse}" id="g${tag}">${pips}</div></div>`;}
function statBarsHtml(u){return `<div class="statBars">${barRow('HP',u.maxhp,MAX.HP)}${barRow('æ”»æ’ƒ',u.atk,MAX.ATK)}${barRow('é˜²å¾¡',u.def,MAX.DEF)}${barRow('å›é¿',u.eva,MAX.EVA)}</div>`;}
function cardHtml(u,role,opp){
  const aff=typeMult(u.type,opp.type), affText=aff===1.5?'ç›¸æ€§ x1.5ï¼ˆæŠœç¾¤ï¼‰':aff===0.67?'ç›¸æ€§ x0.67ï¼ˆã„ã¾ã„ã¡ï¼‰':'ç›¸æ€§ x1.0ï¼ˆç­‰å€ï¼‰';
  const sp=role==='ally'?state.A.sp:state.B.sp, tag=role==='ally'?'A':'B';
  const owner=role==='ally'?'ã‚ãªãŸ':'CPU';
  const art=`<div class="artFrame"><img loading="lazy" src="${imgPath(u.name)}" alt="${u.name}" onerror="this.closest('.artFrame').classList.add('noart'); this.remove();"></div>`;
  return `<div class="unit" data-type="${u.type}">
    <div class="owner ${role==='ally'?'ally':'enemy'}">${owner}</div>
    <div class="nameRow"><div style="font-weight:900">${u.name}</div><div class="badge">${u.type}</div></div>
    ${art}
    <div class="hpRow"><div class="hpBox"><div class="hpFill" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div><div class="hpNum" id="hpnum-${role}">HP ${u.hp}/${u.maxhp}</div></div>
    ${gaugeHtml(sp,tag)}
    <div class="skillWrap">
      <div class="skillBox"><div class="skillTitle">âœ¨ å¿…æ®ºï¼š${(SKILLS[u.name]||['â€”'])[0]}</div><div class="skillDesc">${(SKILLS[u.name]||['â€”','â€”'])[1]}</div></div>
      <div class="affinityBox">${affText}</div>
    </div>
    ${statBarsHtml(u)}
  </div>`;
}
function renderSides(){
  $('leftWrap').innerHTML=`<div id="card-ally">${cardHtml(left(),'ally',right())}</div>`;
  $('rightWrap').innerHTML=`<div id="card-enemy">${cardHtml(right(),'enemy',left())}</div>`;
  updateSPBtn();
}

/* ãƒœãƒƒã‚¯ã‚¹ */
function buildBoxes(){
  const mk=u=>`<div class="mini" data-type="${u.type}" data-name="${u.name}">
    <div class="head"><div>${u.name}</div><div class="badge">${u.type}</div></div>
    <div class="miniBar"><span style="width:${100*u.hp/u.maxhp}%"></span></div>
    <div class="meta">HP ${u.hp}/${u.maxhp}</div></div>`;
  $('sixA').innerHTML=state.A.team.map(mk).join('');
  $('sixB').innerHTML=state.B.team.map(mk).join('');
  document.querySelectorAll('#sixA .mini, #sixB .mini').forEach(div=>{
    div.onclick=()=>{const n=div.dataset.name;const u=[...state.A.team,...state.B.team].find(x=>x.name===n);if(!u)return;
      $('infoTitle').textContent=u.name;
      $('infoBody').innerHTML=`<div style="margin:6px 0"><span class="badge">${u.type}</span></div>${statBarsHtml(u)}<div class="skillBox" style="margin-top:8px"><div class="skillTitle">âœ¨ å¿…æ®ºï¼š${(SKILLS[u.name]||['â€”'])[0]}</div><div class="skillDesc">${(SKILLS[u.name]||['â€”','â€”'])[1]}</div></div>`;
      $('infoModal').style.display='grid'; $('infoModal').onclick=()=>($('infoModal').style.display='none');
    };
  });
}

/* å¿…æ®ºãƒœã‚¿ãƒ³ï¼†æº€ã‚¿ãƒ³é€šçŸ¥ï¼ˆæ”»æ’ƒå¾Œã«åˆ¤å®šï¼‰ */
function updateSPBtn(){
  const readyA=state.A.sp>=6, readyB=state.B.sp>=6, btn=$('btnSP');
  if(btn){btn.disabled=!readyA;btn.classList.toggle('on',state.spOn);btn.textContent=state.spOn?'âœ¨ å¿…æ®º ON':'âœ¨ å¿…æ®º OFF';btn.classList.toggle('btnReady',readyA&&!state.spOn);}
  $('gA')?.classList.toggle('readyPulse',readyA); $('gB')?.classList.toggle('readyPulse',readyB);
  if(readyA && !state.spAnnA){toast('ã‚ãªãŸã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã ã€‚'); state.spAnnA=true;}
  if(readyB && !state.spAnnB){toast('ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã ã€‚'); state.spAnnB=true;}
}

/* ã‚¿ã‚¤ãƒãƒ¼ */
function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  state.timer=setInterval(()=>{ if(toastBusy) return; state.remain--; $('countNum').textContent=state.remain; if(state.remain<=0){const r=['G','C','P'][Math.floor(Math.random()*3)]; pick(r);} },1000);
}

/* ã˜ã‚ƒã‚“ã‘ã‚“ */
function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}

/* ä¸ãƒ€ãƒ¡åŸºç¤ */
function baseDamage(att,def){
  let mult=typeMult(att.type,def.type);
  if(att.atk13>0) mult*=1.3;
  let dmg=100*(1+att.atk/100)/(1+def.def/120)*mult;
  if(def.shield>0) dmg*=0.5;
  return dmg;
}

/* è‡ªåˆ†ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ï¼ˆæ®‹ã‚Šæ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ã‚«ã‚¦ãƒ³ãƒˆâ†’æ–‡å­—åŒ–ã‘åˆ¤å®šâ†’ã‚¹ã‚¿ãƒ³ï¼‰ */
async function startOfAction(side){
  const me = side==='ally'?left():right();
  if(me.shield>0)me.shield--;
  if(me.eva60>0)me.eva60--;
  if(me.atk13>0)me.atk13--;
  if(me.lock>0)me.lock--;
  if(me.selfHurt>0)me.selfHurt--;
  if(me.doom>0){me.doom--; if(me.doom<=0){me.hp=0; renderSides(); buildBoxes(); toast(`${me.name}ã¯æ–‡å­—åŒ–ã‘ã®åŠ¹æœã§å€’ã‚ŒãŸï¼`); await delay(toastDuration('x')); await handleKO(side); return false;}}
  if(me.stun){me.stun=false; toast(`${me.name}ã¯è¨€è‘‰ç‹©ã‚Šã§è¡Œå‹•ã§ããªã„ã€‚`); await delay(toastDuration('x')); return false;}
  return true;
}

/* å¿…æ®ºåŠ¹æœï¼ˆå‰ï¼šå€ç‡ã€å¾Œï¼šãƒãƒ•/ãƒ‡ãƒãƒ•/å›å¾©ç­‰ï¼‰ */
function spEffectPre(att,def,role){
  let mult=1, multiSeq=null, name=(SKILLS[att.name]||['â€”'])[0], desc=(SKILLS[att.name]||['â€”','â€”'])[1];
  switch(att.name){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': mult=2.5; break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': mult=1; break;
    case 'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š': mult=1.6; att.endure=true; break;
    case 'ãã¼ã‚ã”ã¯ã‚“': multiSeq=[0.75,0.5,0.25]; break;
    case 'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©': mult=1.5; att.atk13=2; break;
    case 'æ¯›ã‚€ãã˜ã‚ƒã‚‰': mult=1.4; att.eva60=2; break;        // 2æ”»æ’ƒã‚¿ãƒ¼ãƒ³
    case 'ä¹å“ä»':       mult=1.6; att.shield=2; break;        // 2æ”»æ’ƒã‚¿ãƒ¼ãƒ³
    case 'ã‘ã‚“ã¡ã‚“æ±':   mult=1.2; break;
    case 'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶':
    case 'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦':
    case 'ãƒãƒ«ã‚µãƒŸã‚³é…¢':
    case 'ãƒãƒ“ãƒ­ãƒ³æ•å›š':
    case 'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³':
    case 'ã‚¯ãƒãƒ³ãƒãƒ':
    case 'ç…§ã‚Šç„¼ããƒã‚­ãƒ³':
      def.lock=3; break;                                        // 3æ”»æ’ƒã‚¿ãƒ¼ãƒ³
    case 'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©':
    case 'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´':
    case 'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶':
    case 'ã•ã‚‹ã³ã‚ä¸¸':
      def.stun=true; break;                                     // æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸å¯
    case 'ãƒ”ãƒ­ãƒªèŒ':
    case 'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ':
    case 'é³¥å–ç ‚ä¸˜':
    case 'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ':
    case 'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ':
    case 'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«':
    case 'ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­':
      att.selfHurt=3; break;                                    // 3æ”»æ’ƒã‚¿ãƒ¼ãƒ³
    case 'æ¸¡æ¥äºº':
    case 'çœŒåºæ‰€åœ¨åœ°':
      def.doom=3; break;                                        // 3æ”»æ’ƒã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½
    case 'æœ¬è³ª': case 'è¦‹ãˆã‚‹åŒ–': case 'è‡ªåˆ†ã”ã¨åŒ–': case 'è§£åƒåº¦': {
      mult=2.0; break; /* å¨åŠ›2å€å›ºå®šï¼ˆèª°ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‹è¡¨ç¤ºã™ã‚‹æ‹¡å¼µã¯å¿…è¦ãªã‚‰å¾Œã§è¶³ã›ã‚‹ï¼‰ */
    }
  }
  return {mult,multiSeq,name,desc};
}
function spEffectPost(att,def,role,usedName){
  switch(usedName){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': if(role==='ally'){state.B.sp=0;state.spAnnB=false;} else {state.A.sp=0;state.spAnnA=false;} break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': {
      const team = role==='ally'?state.A.team:state.B.team;
      team.forEach(u=>u.hp=Math.min(u.maxhp,u.hp+60));
      break;
    }
    case 'ã‘ã‚“ã¡ã‚“æ±': att.hp=Math.min(att.maxhp,att.hp+150); break;
  }
}

/* HP/ã‚²ãƒ¼ã‚¸æ›´æ–° */
function updateHpBars(role,unit){$('hp-'+role).style.width=`${100*unit.hp/unit.maxhp}%`; $('hpnum-'+role).textContent=`HP ${unit.hp}/${unit.maxhp}`;}
function addGaugeAfterAttack(){const a0=state.A.sp,b0=state.B.sp;state.A.sp=Math.min(6,a0+1);state.B.sp=Math.min(6,b0+1);if(state.A.sp>=6 && a0<6)state.spAnnA=false;if(state.B.sp>=6 && b0<6)state.spAnnB=false;}

/* æ”»æ’ƒæœ¬ä½“ */
async function doAttack(att,def,useSP,role){
  if(att.hp<=0) return;

  let mult=1, multi=null, spName='', spDesc='';
  if(useSP){
    const pre=spEffectPre(att,def,role);
    mult=pre.mult; multi=pre.multiSeq; spName=pre.name; spDesc=pre.desc;
    toast(`${att.name}ã®å¿…æ®ºã€ã€Œ${spName}ã€ï¼`); await delay(toastDuration('x'));
    const el=role==='ally'?$('card-ally'):$('card-enemy'); el?.classList.add('fx-burst'); setTimeout(()=>el?.classList.remove('fx-burst'),300);
  }

  // å‘½ä¸­ï¼ˆé€šå¸¸ã®ã¿ï¼ç›¸æ‰‹ã®å›é¿60%ã¯ä¸Šæ›¸ãï¼‰
  const eva = def.eva60>0 ? 60 : def.eva;
  const miss = (!useSP && Math.random() < (eva/100));
  if(miss){
    const vr=role==='ally'?'enemy':'ally';
    $('card-'+vr)?.classList.add('shake'); setTimeout(()=>$('card-'+vr)?.classList.remove('shake'),500);
    const msg=`${att.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`; toast(msg); await delay(toastDuration('x')); return;
  }

  // ä¸ãƒ€ãƒ¡
  let total=0;
  const applyHit=(m)=>{ let d=baseDamage(att,def)*m; d=Math.max(1,Math.round(d)); total+=d; };
  if(useSP && Array.isArray(multi)) multi.forEach(s=>applyHit(s)); else applyHit(mult);

  // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒˆãƒ¼ã‚¹ãƒˆâ†’HPåæ˜ ï¼ˆæºã‚Œï¼‰
  const vr=role==='ally'?'enemy':'ally';
  $('card-'+vr)?.classList.add('shake'); setTimeout(()=>$('card-'+vr)?.classList.remove('shake'),500);
  toast(`${att.name}ã®${useSP?'å¿…æ®ºï¼':'æ”»æ’ƒï¼'} ${total}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); await delay(toastDuration('x'));
  def.hp=Math.max(0,def.hp-total); updateHpBars(vr,def);

  // è‡ªå‚·ï¼ˆã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆä¸­ï¼‰
  if(att.selfHurt>0 && Math.random()<0.33){
    const self=100; toast(`${att.name}ã¯ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šã§100ã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`); await delay(toastDuration('x'));
    att.hp=Math.max(0,att.hp-self); updateHpBars(role==='ally'?'ally':'enemy',att);
    if(att.hp<=0){toast(`${att.name}ã¯å€’ã‚ŒãŸï¼`); await delay(toastDuration('x')); await handleKO(role==='ally'?'ally':'enemy');}
  }

  // å¿…æ®ºã®äº‹å¾ŒåŠ¹æœ
  if(useSP){ spEffectPost(att,def,role,att.name); if(spDesc) { toast(spDesc); await delay(toastDuration('x')); } }
  // æ ¹æ€§å‡¦ç†
  if(def.hp<=0 && def.endure){ def.endure=false; def.hp=1; updateHpBars(vr,def); toast(`${def.name}ã¯æ ¹æ€§ã§è€ãˆãŸï¼`); await delay(toastDuration('x')); }

  if(def.hp<=0){ const ko=`${def.name}ã¯å€’ã‚ŒãŸï¼`; toast(ko); await delay(toastDuration('x')); await handleKO(vr); }
}

/* KOâ†’äº¤ä»£ or å‹æ•—ï¼ˆæ’ƒç ´å¾Œã¯è¿½æ’ƒãªã—ï¼‰ */
async function handleKO(side){
  if(side==='ally'){
    const can=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
    if(can.length){
      const i=await openSwitchAuto(15,can,false);
      state.A.i=i; state.A.sp=0; state.spOn=false; updateSPBtn();
      toast(`ã„ã‘ã€${left().name}ï¼`); renderSides(); buildBoxes(); startRound();
    } else { return showResult(false); }
  }else{
    const can=[0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0);
    if(can.length){
      let best=can[0],m0=typeMult(state.B.team[best].type,left().type);
      for(const k of can){const m=typeMult(state.B.team[k].type,left().type); if(m>m0){best=k;m0=m;}}
      state.B.i=best; state.B.sp=0; updateSPBtn();
      toast(`ç›¸æ‰‹ã¯ ${right().name} ã‚’ãã‚Šã ã—ãŸï¼`); renderSides(); buildBoxes(); startRound();
    } else { return showResult(true); }
  }
}

/* äº¤ä»£UI */
const modal=$('switchModal'),grid=$('switchGrid'),doBtn=$('swDo'),cancelBtn=$('swCancel'),swTimer=$('swTimer');let selectIdx=null,swInterval=null;
function openSwitch(){ if(left().lock>0){toast('äº¤ä»£ã§ããªã„ï¼ˆè¨€è«–çµ±åˆ¶ä¸­ï¼‰ã€‚'); return Promise.resolve(null);} return openSwitchAuto(15,null,true); }
function openSwitchAuto(sec=15,canList=null,allowCancel=false){
  return new Promise(resolve=>{
    grid.innerHTML='';selectIdx=null;doBtn.disabled=true;modal.style.display='grid';
    const idxs=(canList??[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0));
    idxs.forEach(i=>{
      const u=state.A.team[i], mul=typeMult(u.type,right().type);
      const div=document.createElement('div');div.className='setupMini selCard';div.setAttribute('data-type',u.type);
      div.innerHTML=`<div class="head"><div>${u.name}</div><div class="badge">${u.type}</div></div>${barRow('HP',u.hp,u.maxhp)}<div class="meta">ç›¸æ€§ï¼š${mul===1.5?'x1.5ï¼ˆæŠœç¾¤ï¼‰':mul===0.67?'x0.67ï¼ˆã„ã¾ã„ã¡ï¼‰':'x1.0ï¼ˆç­‰å€ï¼‰'}</div>`;
      div.addEventListener('click',()=>{document.querySelectorAll('.selCard').forEach(x=>x.classList.remove('selected'));div.classList.add('selected');selectIdx=i;doBtn.disabled=false;});
      grid.append(div);
    });
    let remain=sec; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`; clearInterval(swInterval);
    swInterval=setInterval(()=>{ if(toastBusy) return; remain--; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`; if(remain<=0){clearInterval(swInterval); auto();}},1000);
    const close=i=>{modal.style.display='none';clearInterval(swInterval);resolve(i);};
    const auto=()=>{const r=idxs[Math.floor(Math.random()*idxs.length)];close(r);};
    doBtn.onclick=()=>{if(selectIdx==null)return;close(selectIdx);};
    cancelBtn.onclick=()=>{ if(allowCancel){ close(null); } else { auto(); } };
  });
}

/* å‹æ•— */
function showResult(win){$('resTitle').textContent=win?'YOU WIN!':'YOU LOSE...';$('result').style.display='grid';setTimeout(()=>{$('result').style.display='none';document.body.classList.remove('battleMode');$('battle').style.display='none';$('setup').style.display='block';},3000);}

/* ãƒ©ã‚¦ãƒ³ãƒ‰é€²è¡Œ */
async function pick(h){
  if(state.busy) return; state.busy=true; clearInterval(state.timer);
  const cpuH=['G','C','P'][Math.floor(Math.random()*3)], map={G:'ã‚°ãƒ¼',C:'ãƒãƒ§ã‚­',P:'ãƒ‘ãƒ¼'};
  const res=judge(h,cpuH);
  const head=`ã‚ãªãŸã¯ ${map[h]}ã€‚ç›¸æ‰‹ã¯ ${map[cpuH]}ã€‚${res>0?'ã‚ãªãŸã®å‹ã¡':res<0?'ã‚ãªãŸã®è² ã‘':'ã‚ã„ã“'}ã€‚`;
  toast(head); await delay(toastDuration('x'));

  if(res>0){
    if(await startOfAction('ally')){await doAttack(left(),right(), state.spOn && state.A.sp>=6,'ally'); if(state.spOn && state.A.sp>=6){state.A.sp=0; state.spOn=false; state.spAnnA=false;}}
  }else if(res<0){
    if(await startOfAction('enemy')){await doAttack(right(),left(), state.B.sp>=6,'enemy'); if(state.B.sp>=6){state.B.sp=0; state.spAnnB=false;}}
  }
  // æ”»æ’ƒå¾Œã«åŒæ–¹ã‚²ãƒ¼ã‚¸+1
  addGaugeAfterAttack(); renderSides(); buildBoxes(); updateSPBtn();
  state.busy=false; startRound();
}

/* åˆæœŸåŒ– */
function ensureBattleMode(){document.body.classList.add('battleMode');$('setup').style.display='none';$('battle').style.display='block';}
function buildSetup(){makeTeam($('teamA'),'A');makeTeam($('teamB'),'B');}
function bindClicks(){
  $('btnRand').onclick=()=>{const a=uniqueRandom(3,WORDS_BASE.length),b=uniqueRandom(3,WORDS_BASE.length);a.forEach((v,i)=>$(`A-${i}`).value=v);b.forEach((v,i)=>$(`B-${i}`).value=v);enforceUnique('A');enforceUnique('B');renderMini('A');renderMini('B');toast('ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆã—ãŸã€‚');};
  $('btnStart').onclick=()=>{state.A.team=collect('A');state.B.team=collect('B');state.A.i=0;state.B.i=0;state.A.sp=0;state.B.sp=0;state.spOn=false;state.spAnnA=false;state.spAnnB=false;ensureBattleMode();renderSides();buildBoxes();(async()=>{const m=`ã„ã‘ã€${left().name}ï¼ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼`;toast(m);await delay(toastDuration('x'));startRound();})();};
  $('btnG').onclick=()=>pick('G'); $('btnC').onclick=()=>pick('C'); $('btnP').onclick=()=>pick('P');
  $('btnSwitch').onclick=async()=>{const i=await openSwitch(); if(i!=null){state.A.i=i; state.A.sp=0; state.spOn=false; updateSPBtn(); toast(`ã„ã‘ã€${left().name}ï¼`); renderSides(); buildBoxes(); /*æ‰‹å‹•äº¤ä»£ã¯ç›¸æ‰‹ãŒå³è¡Œå‹•*/ await (async()=>{await delay(200); await doAttack(right(), left(), state.B.sp>=6, 'enemy'); if(state.B.sp>=6){state.B.sp=0;state.spAnnB=false;} renderSides(); buildBoxes(); updateSPBtn(); startRound();})();}};
  $('btnSP').onclick=()=>{if(state.A.sp>=6){state.spOn=!state.spOn;updateSPBtn();}};
}
document.addEventListener('DOMContentLoaded',()=>{buildSetup();bindClicks();toast('READY: v7.20');});
})();
</script>
</body>
</html>
