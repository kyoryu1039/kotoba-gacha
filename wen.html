<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v8.20 Logic Restored</title>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f1c">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#080b14; --text:#eef4ff;
  --panel:#10182b; --panel2:#0c1221; --border:#2a3d6b; --shadow:0 8px 32px rgba(0,0,0,.4);
  --ally:#4da6ff; --enemy:#ff5c6c;
  --hp:#4effa5; --hpBack:#0a2618;
  --gauge:#ffd900; --gaugeBack:#3d2e00;
  --t-„Ç∏„Ç™:#4d8aff; --t-„Ç¢„Éã„Éû„É´:#00db84; --t-„Éï„Éº„Éâ:#ffaa2b; --t-„Ç≥„É≥„Çª„Éó„Éà:#b366ff; --t-„Çµ„Ç§„Ç®„É≥„Çπ:#00e5ff; --t-„Éí„Çπ„Éà„É™„Éº:#ff5c87; --t-„Éí„É•„Éº„Éû„É≥:#88f060;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;overflow-x:hidden}

.container{max-width:1024px;margin:0 auto;padding:10px;padding-bottom:40px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:14px}
.card h2{margin:0;padding:10px 16px;border-bottom:1px solid var(--border);font-size:15px;font-weight:800;letter-spacing:.05em;background:rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center}
.card .body{padding:12px}

.primary,.ghost{appearance:none;cursor:pointer;border-radius:8px;border:1px solid #364a80;background:#142042;color:#eaf2ff;padding:10px 14px;font-weight:800;font-size:13px;transition:.15s;display:inline-flex;justify-content:center;align-items:center}
.primary{background:linear-gradient(180deg,#2b52a3,#18326a);border-color:#4a74c9;box-shadow:0 3px 0 #0f1f42}
.primary:active{transform:translateY(2px);box-shadow:0 1px 0 #0f1f42}
.ghost:hover{background:#1c2b55}
button:disabled{opacity:0.4;cursor:not-allowed;filter:grayscale(1);transform:none!important;box-shadow:none!important}
.btnTiny{padding:4px 8px;border-radius:6px;font-size:10px;height:24px;border:1px solid #364a80;background:transparent;color:#abc;cursor:pointer}

#setup{display:grid;gap:14px}
#teamGrid{display:grid;gap:10px}
@media(min-width:720px){#teamGrid{grid-template-columns:1fr 1fr}}
.slot{display:flex;gap:8px;align-items:center;background:#090e1c;padding:6px;border-radius:10px;border:1px solid #1f2b4d}
.pill{display:inline-grid;place-items:center;width:22px;height:22px;border-radius:6px;background:#1a2642;color:#8ba6d6;font-weight:900;font-size:11px}
.slot select{flex:1;background:transparent;border:none;color:#eaf2ff;padding:4px;font-weight:700;font-size:13px;outline:none}
#statsGrid{display:grid;gap:10px}
@media(min-width:720px){#statsGrid{grid-template-columns:1fr 1fr}}
.statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:8px}

.setupMini{
  border:1px solid #2a3d6b; border-radius:8px; padding:8px; position:relative;
  background:#11182b; box-shadow:0 2px 8px rgba(0,0,0,.3);
  display:flex; flex-direction:column; gap:4px;
}
.setupMini .head{display:flex;justify-content:space-between;font-weight:800;font-size:12px}
.barLine{display:flex;align-items:center;gap:6px;height:10px}
.barBox{flex:1;height:5px;background:#060912;border-radius:3px;overflow:hidden}
.barFill{height:100%;background:var(--hp);border-radius:3px}
.val{font-size:10px;color:#9cb3de;width:28px;text-align:right;font-family:"Menlo",monospace}

.arena{display:grid;gap:12px;transition:transform .1s}
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-2px,1px)}20%,80%{transform:translate(1px,-2px)}30%,50%,70%{transform:translate(-4px,2px)}40%,60%{transform:translate(4px,-2px)}}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:stretch}
.vsrow>div{min-width:0;background:transparent!important;box-shadow:none!important;border:none!important}

.unit{
  position:relative; width:100%; height:100%; min-height:210px;
  border-radius:12px; padding:8px;
  background:#151b2e; border:1px solid #2a3d6b;
  display:flex; flex-direction:column;
  box-shadow:0 8px 20px rgba(0,0,0,.5);
  overflow:hidden;
}
.unit[data-rank="S"]{ background:linear-gradient(145deg,#1a1a2e,#2e2138); border:1px solid #ffd700; box-shadow:0 0 10px rgba(255,215,0,.15), 0 8px 20px rgba(0,0,0,.5); }
.unit[data-rank="S"]::before{
  content:""; position:absolute; inset:0; z-index:0;
  background:linear-gradient(115deg, transparent 30%, rgba(255,255,255,.1) 45%, rgba(255,255,255,.2) 50%, transparent 55%);
  background-size:250% 250%; animation:shine 4s infinite linear; pointer-events:none;
}
.unit[data-rank="A"]{ background:linear-gradient(145deg,#141e38,#242f4f); border:1px solid #e0c060; }
@keyframes shine{0%{background-position:200% 200%}100%{background-position:-50% -50%}}

.unitInner{position:relative; z-index:2; flex:1; display:flex; flex-direction:column}
.cardHeader{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;min-height:18px}
.ownerBadge{font-size:9px;font-weight:900;padding:2px 5px;border-radius:4px;background:#000;border:1px solid #444;color:#ccc;line-height:1}
.ownerBadge.ally{color:var(--ally);border-color:var(--ally)}
.ownerBadge.enemy{color:var(--enemy);border-color:var(--enemy)}
.typeIcon{font-size:9px;font-weight:800;padding:2px 6px;border-radius:8px;background:var(--typeColor);color:#080b14;line-height:1}

.artArea{
  position:relative; width:100%; aspect-ratio:1.8/1; margin-bottom:6px;
  background:radial-gradient(circle, rgba(0,0,0,.2), rgba(0,0,0,.6));
  border-radius:8px; border:1px solid rgba(255,255,255,.1);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.mainImg{max-height:100%;max-width:100%;width:auto;height:auto;object-fit:contain;filter:drop-shadow(0 4px 6px rgba(0,0,0,.6));transition:transform .2s}
.unit.hit .mainImg{animation:hit .4s ease}
@keyframes hit{10%,90%{transform:translate(-3px,0)}20%,80%{transform:translate(3px,0)}30%,50%,70%{transform:translate(-3px,0)}40%,60%{transform:translate(3px,0)}}

.cardName{text-align:center; font-weight:900; font-size:14px; margin:0 0 6px; text-shadow:0 2px 0 #000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.statRow{display:grid; grid-template-columns:20px 1fr; gap:4px; align-items:center; margin-bottom:4px; font-size:10px; font-weight:700; color:#8ba0c0}
.hpBarBg{height:6px; background:#06080e; border-radius:3px; border:1px solid #233562; overflow:hidden}
.hpBar{height:100%; background:var(--hp); width:100%; transition:width .4s ease-out; box-shadow:0 0 6px var(--hp)}
.num{text-align:right; font-family:monospace; font-size:10px}

.statusRow{display:flex;gap:2px;min-height:14px;margin-bottom:4px;justify-content:flex-end;flex-wrap:wrap}
.stBadge{font-size:8px;padding:1px 3px;border-radius:3px;background:#330000;color:#ff5c6c;border:1px solid #ff5c6c;white-space:nowrap}
.spRow{display:flex; gap:2px; justify-content:center; margin:6px 0}
.pip{width:12px; height:5px; background:#221a00; border:1px solid #4d3900; border-radius:2px}
.pip.on{background:var(--gauge); border-color:#ffeaa7; box-shadow:0 0 5px var(--gauge)}

.skillInfo{background:rgba(0,0,0,.3); padding:5px; border-radius:5px; border:1px solid rgba(255,255,255,.05); margin-top:auto}
.skillN{font-size:9px; font-weight:800; color:#e0e6f0; margin-bottom:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.skillD{font-size:8px; line-height:1.2; color:#9aa5b8; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.footer{display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:9px; color:#677a99}
.btnStat{background:transparent; border:1px solid #364a80; color:#8ba6d6; border-radius:4px; padding:1px 5px; font-size:8px; cursor:pointer}

.padCard{position:relative; background:rgba(18,28,58,.95); border:1px solid #31457b; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.5); padding:10px}
.padInner{display:grid;grid-template-columns:1fr;gap:10px}
.rpsArea{display:flex;justify-content:center;gap:16px;padding:8px 0}
.rps{
  position:relative; width:58px; height:58px; border-radius:50%; border:none; cursor:pointer;
  display:grid; place-items:center; box-shadow:0 5px 0 rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.3);
  transition:transform .1s, box-shadow .1s;
}
.rps:active{transform:translateY(3px); box-shadow:0 2px 0 rgba(0,0,0,.4)}
.rps.g{background:linear-gradient(#ff9ea6,#ff5c6c); color:#52000b}
.rps.c{background:linear-gradient(#9ebdff,#4d8aff); color:#001a4d}
.rps.p{background:linear-gradient(#9effc5,#00db84); color:#003d24}
.emo{font-size:26px}
.lbl{position:absolute; bottom:-16px; font-size:9px; font-weight:800; color:#8ba6d6}

.sideBtns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.switchBtn{border-radius:8px;background:linear-gradient(90deg,#8e44ad,#9b59b6);border:none;color:#fff;font-weight:800;padding:10px 0;font-size:12px}
.spToggle{border-radius:8px; background:#121829; border:2px solid #554400; color:#776600; font-weight:800; padding:8px 0; font-size:12px; transition:.2s}
.spToggle.on{background:linear-gradient(90deg,#ffb700,#ffaa00); color:#3d2e00!important; border-color:#ffd700!important; box-shadow:0 0 12px rgba(255,200,0,.4)}
.spToggle.btnReady:not(.on){border-color:#ffaa00; color:#ffaa00; animation:glow 1.5s infinite}
@keyframes glow{50%{box-shadow:0 0 8px rgba(255,170,0,.3)}}

.logContainer{
  height:120px; margin:10px 0; overflow-y:auto;
  background:rgba(0,0,0,.4); border:1px solid #1f2b4d; border-radius:10px;
  padding:8px; font-family:sans-serif; font-size:12px; display:flex; flex-direction:column; gap:5px;
}
.logLine{color:#b0c4de; border-left:3px solid #2b3a70; padding-left:6px; line-height:1.3}
.logLine.highlight{color:#ffe066; border-left-color:#ffe066; background:rgba(255,224,102,0.08)}
.logLine.dmg{color:#ff9e9e; border-left-color:#ff5c6c}
.logLine.heal{color:#9effc5; border-left-color:#4effa5}
.logLine.sp{color:#fff; border-left-color:#a29bfe}

#boxGrid{display:grid;gap:8px;grid-template-columns:1fr 1fr; margin-top:12px}
.boxCol{background:#0e1424;border:1px solid #1f2b4d;border-radius:10px;padding:6px}
.mini{border:1px solid #2a3d6b; border-radius:6px; padding:5px; cursor:pointer; background:#141d33; margin-bottom:5px}
.mini:hover{background:#1c2642}
.mini .head{display:flex;justify-content:space-between;font-size:10px;font-weight:700;margin-bottom:3px}
.miniBarBg{height:3px;background:#000;border-radius:2px;overflow:hidden}
.miniBar{height:100%;background:var(--hp)}

@media(max-width:600px){
  .container{padding:8px}
  .unit{min-height:200px; padding:6px}
  .cardName{font-size:13px}
  .skillD{display:none}
  .rps{width:50px;height:50px}
  .emo{font-size:22px}
}

#jankenOverlay,#cutIn,#switchModal,#infoModal,#rulesModal,#result{position:fixed;inset:0;z-index:99;pointer-events:none;display:none;align-items:center;justify-content:center}
#switchModal,#infoModal,#rulesModal,#result{background:rgba(0,0,0,.8);pointer-events:auto;backdrop-filter:blur(4px)}
#jankenOverlay.active{display:flex;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
#switchModal.show,#infoModal.show,#rulesModal.show,#result.show{display:flex}

.jkWrap{display:flex;flex-direction:column;align-items:center;gap:20px}
.jkHands{display:flex;gap:30px;align-items:center}
.jkHand{font-size:60px;transition:transform .2s;opacity:0;transform:scale(0)}
.jkHand.show{opacity:1;transform:scale(1)}
.jkHand.win{filter:drop-shadow(0 0 20px #ffe066);transform:scale(1.3) rotate(-15deg);z-index:10}
.jkHand.lose{filter:grayscale(1) brightness(0.5);opacity:0.5;transform:scale(0.8) rotate(15deg)}
.jkResult{font-size:48px;font-weight:900;color:#fff;text-shadow:0 4px 10px #000;opacity:0;transform:translateY(20px);transition:all .2s}
.jkResult.show{opacity:1;transform:translateY(0)}

#cutIn{background:linear-gradient(90deg,transparent,rgba(20,30,80,.95) 20%,rgba(20,30,80,.95) 80%,transparent);height:100px;border-top:2px solid #ffe066;border-bottom:2px solid #ffe066;flex-direction:column;transform:scaleY(0);transition:.15s}
#cutIn.show{display:flex;transform:scaleY(1)}
.cutInText{font-size:28px;font-weight:900;color:#fff;text-shadow:0 4px 10px #000;font-style:italic}
.cutInSub{font-size:12px;color:#ffe066;font-weight:700}

.modalCard{width:min(500px,90vw);max-height:80vh;overflow-y:auto;background:#101626;border:1px solid #364a80;border-radius:14px;padding:16px;box-shadow:0 20px 50px #000}
.modalHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid #2a3d6b;padding-bottom:8px}
.modalTitle{margin:0;font-size:16px;font-weight:800;color:#fff}
#switchGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.selCard{cursor:pointer;transition:.2s}.selCard:hover{background:#1c2645}
.selCard.selected{outline:2px solid #ffe066;background:#1e2a50}

.timer{text-align:center;font-weight:900;font-size:12px;color:#8ba6d6;margin-top:6px}
.timer .num{font-size:20px;color:#fff}
.floatingText{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);font-weight:900;font-size:28px;color:#fff;-webkit-text-stroke:1px #000;text-shadow:0 2px 5px rgba(0,0,0,.8);pointer-events:none;z-index:10;animation:floatUp .8s forwards}
.floatingText.dmg{color:#ff5c6c}.floatingText.heal{color:#4effa5}
@keyframes floatUp{0%{opacity:0;transform:translate(-50%,0) scale(0.5)} 20%{opacity:1;transform:translate(-50%,-40px) scale(1.2)} 100%{opacity:0;transform:translate(-50%,-80px) scale(1)}}
</style>
</head>
<body>

<div class="container" id="setup">
  <section class="card">
    <h2>„ÉÅ„Éº„É†Á∑®Êàê <button class="btnTiny" id="btnRules">„É´„Éº„É´</button></h2>
    <div class="body">
      <div id="teamGrid">
        <div><div class="statsHead" style="color:#4da6ff">„ÅÇ„Å™„Åü</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#ff5c6c">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px">
        <button id="btnRand" class="ghost">„É©„É≥„ÉÄ„É†</button>
        <button id="btnStart" class="primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2>„Çπ„ÉÜ„Éº„Çø„ÇπË©≥Á¥∞</h2>
    <div class="body">
      <div id="statsGrid">
        <div><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div class="container" id="battle" style="display:none">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>
    <section class="padCard" id="pad">
      <div class="padInner">
        <div class="rpsArea">
          <button class="rps g" id="btnG"><div class="emo">‚úä</div><div class="lbl">„Ç∞„Éº</div></button>
          <button class="rps c" id="btnC"><div class="emo">‚úåÔ∏è</div><div class="lbl">„ÉÅ„Éß„Ç≠</div></button>
          <button class="rps p" id="btnP"><div class="emo">üñê</div><div class="lbl">„Éë„Éº</div></button>
        </div>
        <div class="sideBtns">
          <button class="spToggle" id="btnSP" disabled>SP ÂøÖÊÆ∫ÊäÄ</button>
          <button class="switchBtn" id="btnSwitch">üîÅ ‰∫§‰ª£</button>
        </div>
      </div>
    </section>
    <div class="logContainer" id="battleLog"></div>
    <div class="timer">TIME <span class="num" id="countNum">15</span></div>
    <div id="boxGrid">
      <div class="boxCol"><div class="statsHead">Ally</div><div id="sixA"></div></div>
      <div class="boxCol"><div class="statsHead">Enemy</div><div id="sixB"></div></div>
    </div>
  </div>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">‚úä</div><div style="color:#fff;font-weight:900;font-size:20px">VS</div><div class="jkHand" id="jkHandB">‚úåÔ∏è</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">‰∫§‰ª£</h3><button class="btnTiny" id="swCancel">Èñâ„Åò„Çã</button></div><div id="switchGrid"></div><button id="swDo" class="primary" style="width:100%;margin-top:16px" disabled>Ê±∫ÂÆö</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">Ë©≥Á¥∞</h3><button class="btnTiny" onclick="$('infoModal').classList.remove('show')">Èñâ„Åò„Çã</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">„É´„Éº„É´</h3><button class="btnTiny" onclick="$('rulesModal').classList.remove('show')">Èñâ„Åò„Çã</button></div><ul style="padding-left:18px;line-height:1.6;color:#cbd7f0;font-size:13px"><li>3‰Ωì„ÅÆ„ÄåË®ÄËëâ„Äç„Åß„ÉÅ„Éº„É†„ÇíÁµÑ„Çì„ÅßÊà¶„ÅÑ„Åæ„Åô„ÄÇ</li><li>„Åò„ÇÉ„Çì„Åë„Çì„Å´Âãù„Å§„Å®ÊîªÊíÉ„ÄÅË≤†„Åë„Çã„Å®Èò≤Âæ°„Åß„Åô„ÄÇ</li><li>„Çø„Ç§„ÉóÁõ∏ÊÄßÔºàÊúâÂà©1.5ÂÄç„ÄÅ‰∏çÂà©0.67ÂÄçÔºâ„ÅåÈáçË¶Å„Åß„Åô„ÄÇ</li><li>ÂøÖÊÆ∫„Ç≤„Éº„Ç∏„Åå6Ê∫ú„Åæ„Çã„Å®„ÄÅÂº∑Âäõ„Å™ÂøÖÊÆ∫ÊäÄ„Åå‰Ωø„Åà„Åæ„Åô„ÄÇ</li><li>Áõ∏Êâã„ÉÅ„Éº„É†„ÇíÂÖ®Âì°ÂÄí„Åõ„Å∞ÂãùÂà©„Åß„Åô„ÄÇ</li></ul></div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:40px"><h1 id="resTitle" style="color:#fff;margin:0 0 20px;font-size:36px">WIN</h1><p style="color:#8ba6d6;font-size:12px">Returning to setup...</p></div></div>

<script>
(()=>{
'use strict';
const $=id=>document.getElementById(id);
const qs=(s,el=document)=>el.querySelector(s);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

const IMG={"„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"parabola_antenna.png","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"nescafe_ambassador.png","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"ninjin_shirishiri.png","„Åù„Åº„Çç„Åî„ÅØ„Çì":"soboro_gohan.png","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"western_lowland_gorilla.png","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"kemukujara.png","‰πùÂìÅ‰ªè":"kuhonbutsu.png","„Åë„Çì„Å°„ÇìÊ±Å":"kenchin_jiru.png","„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"kamchatka_peninsula.png","„Çø„É©„É≥„ÉÅ„É•„É©":"tarantula.png","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"shoebill.png","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"balsamic_vinegar.png","„Éî„É≠„É™Ëèå":"helicobacter_pylori.png","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"trinidad_and_tobago.png","„Ç´„É©„É°„É´Ëâ≤Á¥†":"caramel_color.png","„Éê„Éì„É≠„É≥ÊçïÂõö":"babylonian_captivity.png","È≥•ÂèñÁ†Ç‰∏ò":"tottori_sand_dunes.png","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"placebo_effect.png","Ê∏°Êù•‰∫∫":"torai_jin.png","„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"peperoncino.png","„Éù„É™„Éó„É≠„Éî„É¨„É≥":"polypropylene.png","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"sarajevo_incident.png","„ÇØ„Éû„É≥„Éê„ÉÅ":"kumabachi.png","ÁúåÂ∫ÅÊâÄÂú®Âú∞":"prefectural_capital.png","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"teriyaki_chicken.png","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"nerunerunerune.png","„Çπ„É´„É°„Ç§„Ç´":"surume_ika.png","Êú¨Ë≥™":"essence.png","Ë¶ã„Åà„ÇãÂåñ":"mieruka.png","Ëá™ÂàÜ„Åî„Å®Âåñ":"jibungotoka.png","Ëß£ÂÉèÂ∫¶":"resolution.png","„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png"};
function preloadImgs(names){
  const unique=[...new Set(names.map(n=>IMG[n]).filter(Boolean))];
  unique.forEach(f=>{ const im=new Image(); im.src=`images/${f}`; });
}

function log(msg, type='normal'){
  const c=$('battleLog'); const d=document.createElement('div');
  let icon='';
  if(type==='atk') icon='‚öîÔ∏è '; else if(type==='dmg') icon='üí• '; else if(type==='heal') icon='üíñ '; else if(type==='sp') icon='‚ú® ';
  d.className='logLine '+type; d.textContent=icon+msg; c.appendChild(d); c.scrollTop=c.scrollHeight;
}

function showFloatingText(targetId, text, type){
  const wrap=$(targetId); if(!wrap)return;
  const el=document.createElement('div'); el.className='floatingText '+type; el.textContent=text;
  wrap.appendChild(el); setTimeout(()=>el.remove(),900);
}

async function showCutIn(skill, user){
  $('cutInName').textContent=skill; $('cutInUser').textContent=user;
  const el=$('cutIn'); el.classList.add('show');
  await delay(1200); el.classList.remove('show'); await delay(200);
}

function shakeScreen(){
  const a=$('arena'); a.classList.remove('shake'); void a.offsetWidth; a.classList.add('shake');
}

let inputLocked=false;
function lockInputs(on){
  inputLocked=on; const p=$('pad'); if(p)p.style.opacity=on?.6:1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id=>$(id).disabled=on);
  updateSPBtn(); 
}

function updateSPBtn(){
  const btn=$('btnSP'); if(!btn)return;
  const ready=state.A.sp>=6;
  const canPress=!inputLocked && ready && !state.busy;
  btn.disabled=!canPress;
  if(state.spOn){
    btn.textContent='‚ú® ÂøÖÊÆ∫ ON'; btn.classList.add('on'); btn.classList.remove('btnReady');
  } else {
    btn.textContent='SP ÂøÖÊÆ∫ÊäÄ'; btn.classList.remove('on');
    if(ready && !inputLocked) btn.classList.add('btnReady'); else btn.classList.remove('btnReady');
  }
  qs('#gA')?.classList.toggle('readyPulse',ready);
  if(ready && !state.spAnnA){ log('ÂøÖÊÆ∫„Ç≤„Éº„Ç∏MAXÔºÅ', 'highlight'); state.spAnnA=true; }
}

async function playJankenAnim(myH, cpuH, res){
  const map={G:'‚úä',C:'‚úåÔ∏è',P:'üñê'};
  const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  ov.classList.add('active');
  hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  await delay(50); hA.classList.add('show'); hB.classList.add('show');
  await delay(300);
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else { rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show');
  await delay(700); ov.classList.remove('active');
}

const TYPES_RING=['„Éí„Çπ„Éà„É™„Éº','„Ç∏„Ç™','„Ç≥„É≥„Çª„Éó„Éà','„Çµ„Ç§„Ç®„É≥„Çπ','„Ç¢„Éã„Éû„É´','„Éí„É•„Éº„Éû„É≥','„Éï„Éº„Éâ'];
const typeColor=t=>getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`)||'#7aa0ff';
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const st=[(i+1)%n,(i+2)%n],wk=[(i-1+n)%n,(i-2+n)%n];if(st.includes(j))return 1.5;if(wk.includes(j))return 0.67;return 1;};
const MAX={HP:800,ATK:120,DEF:120,EVA:20};
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

/* Âæ©Êóß: „Ç™„É™„Ç∏„Éä„É´„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ */
const visualLen = (s)=> (s||"").replace(/[„Éª\s]/g,"").length;
const toKatakana = (s)=> (s||"").replace(/[„ÅÅ-„Çì]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
const reKanaH = /[„ÅÅ-„Çü]/g, reKanaK = /[„Ç†-„Éø„Éº]/g, reKanji = /[‰∏Ä-Èæ•„ÄÖ„ÄÜ„Éµ„É∂]/g;
function countClass(name){const H=(name.match(reKanaH)||[]).length,K=(name.match(reKanaK)||[]).length,J=(name.match(reKanji)||[]).length;return{H,K,J,total:H+K+J};}
const reSmallK = /[„Ç°„Ç£„Ç•„Çß„Ç©„É£„É•„Éß„ÉÆ„á∞-„áø]/g, reSokuon=/„ÉÉ/g, reVoiced=/[„Ç¨-„Éù„É¥]/g, rePlosiveEnd=/[„ÉÑ„ÉÉ„ÇØ„Ç≠„ÉÅ„ÉÜ„Éà„Éó„Éî„Éö„Éù„Ç´„Çø]$/;
function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5;
  const cls=countClass(name);
  if(cls.J+cls.K===0){atkP+=12.5;defP+=12.5;}
  else{const r=cls.K/(cls.J+cls.K);atkP+=25*r;defP+=25*(1-r);}
  const Lph=yomiKatakana.length||1;
  const d=(yomiKatakana.match(reVoiced)||[]).length/Lph;
  const s=(yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m=(yomiKatakana.match(reSmallK)||[]).length/Lph;
  const e=rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw=0.6*d+0.25*(s+m)+0.15*e, L=0.05, U=0.45;
  const s_ph=Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph=20*(0.5+0.5*s_ph);
  atkP+=atk_ph; defP+=20-atk_ph;
  const T=visualLen(name);
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len=20*(0.5+0.5*s_len);
  atkP+=atk_len; defP+=20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){const cls=countClass(name);const hiraRatio=cls.total?(cls.H/cls.total):0;const rankAdj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;let eva=10+8*hiraRatio-0.5*(T-5)+rankAdj;eva=Math.round(eva*10)/10;return Math.max(5,Math.min(35,eva));}
function makeWordObject([name,rank,type,yomiH]){const y=toKatakana(yomiH||name);const {atkP,defP,T}=calcAttackDefense(name,y);const ATK=Math.round(PRANK[rank]*(atkP/100));const DEF=Math.round(PRANK[rank]*(defP/100));const HP=Math.round(HP_BASE[rank]+20*(T-5));const EVA=calcEvasion(name,T,rank);return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};}

/* Âæ©Êóß: ÂÆåÂÖ®„Å™„Çπ„Ç≠„É´ÂÆöÁæ©„Å®ÂäπÊûú */
const SKILLS={
 "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":["Â¶®ÂÆ≥ÈõªÊ≥¢","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ2.2ÂÄç„Åß„ÅÇ„Çã„ÄÇ„Åï„Çâ„Å´Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Ç≤„Éº„Ç∏„Çí0„Å´„Åô„Çã„ÄÇ"],
 "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":["‰∏ÄÊùØ„ÅÑ„Åã„Åå","ÈÄöÂ∏∏ÊîªÊíÉ„ÅÆ„ÅÇ„Å®„ÄÅÂë≥ÊñπÂÖ®Âì°„ÅÆHP„Çí60ÂõûÂæ©„Åô„ÇãÔºàËá™ÂàÜ„ÇÇ60Ôºâ„ÄÇ"],
 "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":["„Å™„Çì„Åè„Çã„Å™„ÅÑ„Åï„Éº","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ1.6ÂÄç„Åß„ÅÇ„Çã„ÄÇÊ¨°„Å´Âèó„Åë„ÇãËá¥ÂëΩÂÇ∑„Çí1Âõû„Å†„ÅëHP1„ÅßËÄê„Åà„Çã„ÄÇ"],
 "„Åù„Åº„Çç„Åî„ÅØ„Çì":["„Åù„Åº„Çç‰π±Ëàû","3ÂõûÈÄ£Á∂ö„ÅßÊîªÊíÉ„Åô„ÇãÔºà0.75‚Üí0.5‚Üí0.25ÂÄçÔºâ„ÄÇÁõ∏Êâã„ÇíÂÄí„Åó„Åü„ÇâÊ¨°„ÅÆÁõ∏Êâã„Å´„ÇÇÁ∂ö„Åè„ÄÇ"],
 "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":["„Éû„Ç¶„É≥„ÉÜ„É≥„Éì„Éº„Éà","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ1.5ÂÄç„Åß„ÅÇ„Çã„ÄÇ„Åï„Çâ„Å´Ê¨°„ÅÆ2Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅØ1.3ÂÄç„Å´„Å™„Çã„ÄÇ"],
 "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":["„É†„ÇØ„Ç∏„É£„É©„É©","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ1.4ÂÄç„Åß„ÅÇ„Çã„ÄÇ„Åï„Çâ„Å´Ê¨°„ÅÆ2Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅÆ„ÅÇ„ÅÑ„Å†ÂõûÈÅøÁéá„Åå60%„Å´„Å™„Çã„ÄÇ"],
 "‰πùÂìÅ‰ªè":["‰ªè„ÅÆÈ°î„ÇÇ‰∏âÂ∫¶„Åæ„Åß","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ1.6ÂÄç„Åß„ÅÇ„Çã„ÄÇ„Åï„Çâ„Å´Ê¨°„ÅÆ2Âõû„ÅÆÁõ∏Êâã„Åã„Çâ„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÂçäÂàÜ„Å´„Åô„Çã„ÄÇ"],
 "„Åë„Çì„Å°„ÇìÊ±Å":["Èï∑ÂØø„ÅÆÁßòË®£","„Åì„ÅÆ‰∏ÄÊíÉ„ÅØ1.2ÂÄç„Åß„ÅÇ„Çã„ÄÇ„Åï„Çâ„Å´Ëá™ÂàÜ„ÅÆHP„Çí150ÂõûÂæ©„Åô„Çã„ÄÇ"],
 "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Çø„É©„É≥„ÉÅ„É•„É©":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆÊîªÊíÉ„Çø„Éº„É≥„Å´Ë°åÂãï„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Éî„É≠„É™Ëèå":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆÊîªÊíÉ„Çø„Éº„É≥„Å´Ë°åÂãï„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Ç´„É©„É°„É´Ëâ≤Á¥†":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "„Éê„Éì„É≠„É≥ÊçïÂõö":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "È≥•ÂèñÁ†Ç‰∏ò":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "Ê∏°Êù•‰∫∫":["ÊñáÂ≠óÂåñ„Åë","3„Çø„Éº„É≥Âæå„Å´Ëá™ÂàÜ„ÅåÊà¶Èóò‰∏çËÉΩ„Å´„Å™„ÇãÔºà‰∫§‰ª£„ÅßËß£Èô§Ôºâ„ÄÇ"],
 "„Åï„Çã„Å≥„ÅÇ‰∏∏":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆÊîªÊíÉ„Çø„Éº„É≥„Å´Ë°åÂãï„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "„Éù„É™„Éó„É≠„Éî„É¨„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆÊîªÊíÉ„Çø„Éº„É≥„Å´Ë°åÂãï„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„ÇØ„Éû„É≥„Éê„ÉÅ":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "ÁúåÂ∫ÅÊâÄÂú®Âú∞":["ÊñáÂ≠óÂåñ„Åë","3„Çø„Éº„É≥Âæå„Å´Ëá™ÂàÜ„ÅåÊà¶Èóò‰∏çËÉΩ„Å´„Å™„ÇãÔºà‰∫§‰ª£„ÅßËß£Èô§Ôºâ„ÄÇ"],
 "ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØÊ¨°„ÅÆ3Âõû„ÅÆËá™ÂàÜ„ÅÆÊîªÊíÉ„ÅåÁµÇ„Çè„Çã„Åæ„Åß‰∫§‰ª£„Åß„Åç„Å™„ÅÑ„ÄÇ"],
 "„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "„Çπ„É´„É°„Ç§„Ç´":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","ÂØæË±°„ÅØÊ¨°„ÅÆ3Âõû„ÅÆÊîªÊíÉ„Çø„Éº„É≥„ÅÆ„Åü„Å≥„ÄÅ33%„ÅßËá™ÂàÜ„Å´100„ÉÄ„É°„Éº„Ç∏„ÄÇ"],
 "Êú¨Ë≥™":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÉÅ„Éº„É†„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„Éº„Åó„Å¶‰Ωø„ÅÜÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ë¶ã„Åà„ÇãÂåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÉÅ„Éº„É†„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„Éº„Åó„Å¶‰Ωø„ÅÜÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ëá™ÂàÜ„Åî„Å®Âåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÉÅ„Éº„É†„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„Éº„Åó„Å¶‰Ωø„ÅÜÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ëß£ÂÉèÂ∫¶":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÉÅ„Éº„É†„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„Éº„Åó„Å¶‰Ωø„ÅÜÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"]
};
const WORDS_BASE=[["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","S","„Çµ„Ç§„Ç®„É≥„Çπ","„Å±„Çâ„Åº„Çâ„ÅÇ„Çì„Å¶„Å™"],["„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº","S","„Éí„É•„Éº„Éû„É≥","„Å≠„Åô„Åã„Åµ„Åá„ÅÇ„Çì„Å∞„Åï„Å†„Éº"],["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","A","„Éï„Éº„Éâ","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä"],["„Åù„Åº„Çç„Åî„ÅØ„Çì","A","„Éï„Éº„Éâ","„Åù„Åº„Çç„Åî„ÅØ„Çì"],["„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","A","„Ç¢„Éã„Éû„É´","„Å´„Åó„Çç„Éº„Çâ„Çì„Å©„Åî„Çä„Çâ"],["ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","A","„Ç¢„Éã„Éû„É´","„Åë„ÇÄ„Åè„Åò„ÇÉ„Çâ"],["‰πùÂìÅ‰ªè","A","„Ç∏„Ç™","„Åè„Åª„Çì„Å∂„Å§"],["„Åë„Çì„Å°„ÇìÊ±Å","A","„Éï„Éº„Éâ","„Åë„Çì„Å°„Çì„Åò„Çã"],["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","B","„Ç∏„Ç™","„Åã„ÇÄ„Å°„ÇÉ„Å£„Åã„ÅØ„Çì„Å®„ÅÜ"],["„Çø„É©„É≥„ÉÅ„É•„É©","B","„Ç¢„Éã„Éû„É´","„Åü„Çâ„Çì„Å°„ÇÖ„Çâ"],["„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","B","„Ç¢„Éã„Éû„É´","„ÅØ„Åó„Å≥„Çç„Åì„ÅÜ"],["„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","B","„Éï„Éº„Éâ","„Å∞„Çã„Åï„Åø„Åì„Åô"],["„Éî„É≠„É™Ëèå","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Å¥„Çç„Çä„Åç„Çì"],["„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","B","„Ç∏„Ç™","„Å®„Çä„Å´„Å†„Éº„Å©„Å®„Å∞„Åî"],["„Ç´„É©„É°„É´Ëâ≤Á¥†","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Åã„Çâ„ÇÅ„Çã„Åó„Åç„Åù"],["„Éê„Éì„É≠„É≥ÊçïÂõö","C","„Éí„Çπ„Éà„É™„Éº","„Å∞„Å≥„Çç„Çì„Åª„Åó„ÇÖ„ÅÜ"],["È≥•ÂèñÁ†Ç‰∏ò","C","„Ç∏„Ç™","„Å®„Å£„Å®„Çä„Åï„Åç„ÇÖ„ÅÜ"],["„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","C","„Çµ„Ç§„Ç®„É≥„Çπ","„Å∑„Çâ„Åó„Éº„Åº„Åì„ÅÜ„Åã"],["Ê∏°Êù•‰∫∫","C","„Éí„É•„Éº„Éû„É≥","„Å®„Çâ„ÅÑ„Åò„Çì"],["„Åï„Çã„Å≥„ÅÇ‰∏∏","C","„Ç∏„Ç™","„Åï„Çã„Å≥„ÅÇ„Åæ„Çã"],["„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","C","„Éï„Éº„Éâ","„Å∫„Å∫„Çç„Çì„Å°„Éº„ÅÆ"],["„Éù„É™„Éó„É≠„Éî„É¨„É≥","C","„Çµ„Ç§„Ç®„É≥„Çπ","„ÅΩ„Çä„Å∑„Çç„Å¥„Çå„Çì"],["„Çµ„É©„Ç®„Éú‰∫ã‰ª∂","C","„Éí„Çπ„Éà„É™„Éº","„Åï„Çâ„Åà„Åº„Åò„Åë„Çì"],["„ÇØ„Éû„É≥„Éê„ÉÅ","D","„Ç¢„Éã„Éû„É´","„Åè„Åæ„Çì„Å∞„Å°"],["ÁúåÂ∫ÅÊâÄÂú®Âú∞","D","„Ç∏„Ç™","„Åë„Çì„Å°„Çá„ÅÜ„Åó„Çá„Åñ„ÅÑ„Å°"],["ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","D","„Éï„Éº„Éâ","„Å¶„Çä„ÇÑ„Åç„Å°„Åç„Çì"],["„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","D","„Éï„Éº„Éâ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠"],["„Çπ„É´„É°„Ç§„Ç´","D","„Ç¢„Éã„Éû„É´","„Åô„Çã„ÇÅ„ÅÑ„Åã"],["Êú¨Ë≥™","X","„Ç≥„É≥„Çª„Éó„Éà","„Åª„Çì„Åó„Å§"],["Ë¶ã„Åà„ÇãÂåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åø„Åà„Çã„Åã"],["Ëá™ÂàÜ„Åî„Å®Âåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åò„Å∂„Çì„Åî„Å®„Åã"],["Ëß£ÂÉèÂ∫¶","X","„Ç≥„É≥„Çª„Éó„Éà","„Åã„ÅÑ„Åû„ÅÜ„Å©"]];
const makeW=i=>makeWordObject(WORDS_BASE[i]);
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false};

function barRow(label,val,max){const pct=Math.min(100,(val/max)*100);return `<div class="barLine"><div class="val" style="width:20px;text-align:left">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="val">${val}</div></div>`;}
function miniCard(idx){const w=makeW(idx);return `<div class="setupMini" data-type="${w.type}"><div class="head"><div>${w.name}</div><div style="color:${typeColor(w.type)}">${w.type}</div></div>${barRow('HP',w.maxhp,800)}${barRow('ATK',w.atk,120)}</div>`;}
function renderMini(side){const root=side==='A'?$('statsA'):$('statsB');root.innerHTML='';for(let i=0;i<3;i++){const idx=Number($(`${side}-${i}`).value)||0;root.innerHTML+=miniCard(idx);}}
function makeTeam(root,side){root.innerHTML='';for(let i=0;i<3;i++){const div=document.createElement('div');div.className='slot';const pill=document.createElement('span');pill.className='pill';pill.textContent='#'+(i+1);const sel=document.createElement('select');sel.id=`${side}-${i}`;WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;sel.append(o);});sel.addEventListener('change',()=>{renderMini(side);});div.append(pill,sel);root.append(div);}const picks=Array.from({length:3},()=>Math.floor(Math.random()*WORDS_BASE.length));picks.forEach((v,i)=>$(`${side}-${i}`).value=v);renderMini(side);}
const collect=side=>[0,1,2].map(i=>{const idx=Number($(`${side}-${i}`).value)||0;return {...makeW(idx),side};});

function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  state.busy=false; lockInputs(false); 
  state.timer=setInterval(()=>{if(state.busy)return; state.remain--; $('countNum').textContent=state.remain; if(state.remain<=0){pick(['G','C','P'][Math.floor(Math.random()*3)]);}},1000);
}
function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}
function baseDamage(att,def){let mult=typeMult(att.type,def.type); if(att.atk13>0) mult*=1.3; let dmg=100*(1+att.atk/100)/(1+def.def/120)*mult; if(def.shield>0)dmg*=0.5; return dmg;}

function renderCard(u,role,opp){
  const sp=role==='ally'?state.A.sp:state.B.sp, tag=role==='ally'?'A':'B';
  const owner=role==='ally'?'YOU':'CPU';
  const img=IMG[u.name]?`<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none'">`:'<span style="font-size:40px">üì¶</span>';
  const skill=(SKILLS[u.name]||['‚Äî','‚Äî']);
  const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  let badges='';
  if(u.lock>0) badges+=`<div class="stBadge">üîí‰∫§‰ª£‰∏çÂèØ</div>`;
  if(u.doom>0) badges+=`<div class="stBadge">üëæÊñáÂ≠óÂåñ„Åë</div>`;
  if(u.selfHurt>0) badges+=`<div class="stBadge">üåÄÂ¥©Â£ä</div>`;
  
  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}">
    <div class="unitInner">
      <div class="cardHeader"><span class="ownerBadge ${role}">${owner}</span><span class="typeIcon">${u.type}</span></div>
      <div class="cardName">${u.name}</div>
      <div class="artArea" id="art-${role}">${img}</div>
      <div class="statusRow">${badges}</div>
      <div class="statRow"><span>HP</span><div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div></div>
      <div style="text-align:right;font-size:10px;margin-bottom:6px"><span id="hpnum-${role}" class="num">${u.hp}</span> / ${u.maxhp}</div>
      <div class="spRow">${pips}</div>
      <div class="skillInfo"><div class="skillN">ÂøÖÊÆ∫: ${skill[0]}</div><div class="skillD">${skill[1]}</div></div>
      <div class="footer"><span>ATK ${u.atk} / DEF ${u.def}</span><button class="btnStat" onclick="window._sh('${u.name}')">STATUS</button></div>
    </div>
  </div>`;
}

function buildBoxes(){
  const mk=u=>`<div class="mini" data-type="${u.type}" onclick="window._sh('${u.name}')"><div class="head"><div>${u.name}</div><div style="color:${typeColor(u.type)}">${u.type}</div></div><div class="miniBarBg"><div class="miniBar" style="width:${Math.max(0,100*u.hp/u.maxhp)}%"></div></div></div>`;
  $('sixA').innerHTML=state.A.team.map(mk).join(''); $('sixB').innerHTML=state.B.team.map(mk).join('');
}

function renderSides(){
  $('leftWrap').innerHTML=renderCard(state.A.team[state.A.i],'ally',state.B.team[state.B.i]);
  $('rightWrap').innerHTML=renderCard(state.B.team[state.B.i],'enemy',state.A.team[state.A.i]);
  buildBoxes(); updateSPBtn();
}
window._sh=(n)=>{const u=[...state.A.team,...state.B.team].find(x=>x.name===n); if(u){$('infoTitle').innerHTML=`${u.name}`; $('infoBody').innerHTML=renderCard(u,'info','info'); $('infoModal').classList.add('show');}};

/* Âæ©Êóß: ÂøÖÊÆ∫ÊäÄÂàÜÂ≤ê„É≠„Ç∏„ÉÉ„ÇØ */
function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
  let mult=1, multiSeq=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', skillUser=att.name, notes=[];
  const useName=forcedName??att.name;
  const [title,desc]=(SKILLS[useName]||['‚Äî','‚Äî']);
  skillTitle=title;
  switch(useName){
    case '„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä': mult=2.2; break;
    case '„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº': mult=1; notes.push('Âë≥ÊñπÂÖ®Âì°ÂõûÂæ©'); break;
    case '„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä': mult=1.6; att.endure=true; break;
    case '„Åù„Åº„Çç„Åî„ÅØ„Çì': multiSeq=[0.75,0.5,0.25]; break;
    case '„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©': mult=1.5; att.atk13=2; break;
    case 'ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ': mult=1.4; att.eva60=2; break;
    case '‰πùÂìÅ‰ªè': mult=1.6; att.shield=2; break;
    case '„Åë„Çì„Å°„ÇìÊ±Å': mult=1.2; notes.push('Ëá™Â∑±ÂõûÂæ©'); break;
    case '„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂': case '„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶': case '„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢': case '„Éê„Éì„É≠„É≥ÊçïÂõö': case '„Éù„É™„Éó„É≠„Éî„É¨„É≥': case '„ÇØ„Éû„É≥„Éê„ÉÅ': case 'ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥': def.lock=3; break;
    case '„Çø„É©„É≥„ÉÅ„É•„É©': case '„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥': case '„Çµ„É©„Ç®„Éú‰∫ã‰ª∂': case '„Åï„Çã„Å≥„ÅÇ‰∏∏': def.stun=true; break;
    case '„Éî„É≠„É™Ëèå': case '„Ç´„É©„É°„É´Ëâ≤Á¥†': case 'È≥•ÂèñÁ†Ç‰∏ò': case '„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú': case '„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé': case '„Çπ„É´„É°„Ç§„Ç´': case '„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠': def.selfHurt=3; break;
    case 'Ê∏°Êù•‰∫∫': case 'ÁúåÂ∫ÅÊâÄÂú®Âú∞': def.doom=3; break;
    case 'Êú¨Ë≥™': case 'Ë¶ã„Åà„ÇãÂåñ': case 'Ëá™ÂàÜ„Åî„Å®Âåñ': case 'Ëß£ÂÉèÂ∫¶':
      if(!mirrorMode){ mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; } break;
  }
  return {mult,multiSeq,skillTitle,skillUser,notes};
}
async function spEffectPost(att,def,role,usedName){
  switch(usedName){
    case '„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä': if(role==='ally'){state.B.sp=0;}else{state.A.sp=0;} break;
    case '„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº': (role==='ally'?state.A.team:state.B.team).forEach(u=>u.hp=Math.min(u.maxhp,u.hp+60)); renderSides(); break;
    case '„Åë„Çì„Å°„ÇìÊ±Å': att.hp=Math.min(att.maxhp,att.hp+150); renderSides(); break;
  }
}

/* Âæ©Êóß: „Çø„Éº„É≥ÈñãÂßãÊôÇÂá¶ÁêÜ */
async function startOfAction(side){
  const me=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  if(me.shield>0)me.shield--; if(me.eva60>0)me.eva60--; if(me.atk13>0)me.atk13--; if(me.lock>0)me.lock--;
  if(me.doom>0){
    me.doom--;
    if(me.doom<=0){
      me.hp=0; renderSides();
      log(`${me.name}„ÅØÊñáÂ≠óÂåñ„Åë„ÅßÂÄí„Çå„ÅüÔºÅ`,'highlight');
      const ended=await handleKO(side); return false===ended;
    }
  }
  if(me.stun){
    me.stun=false; renderSides();
    log(`${me.name}„ÅØÂãï„Åë„Å™„ÅÑÔºÅ`,'highlight'); await delay(1000);
    return false;
  }
  return true;
}

async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true; clearInterval(state.timer); lockInputs(true);
  try{
    const cpu=['G','C','P'][Math.floor(Math.random()*3)];
    const res=judge(h,cpu);
    await playJankenAnim(h,cpu,res);
    
    let ko=false;
    if(res>0){
      if(await startOfAction('ally')) ko=await doTurn('ally');
    } else if(res<0){
      if(await startOfAction('enemy')) ko=await doTurn('enemy');
    }
    if(!ko){
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      if(state.A.sp<6)state.spAnnA=false;
      renderSides(); log('Ê¨°„ÅÆ„Çø„Éº„É≥','normal'); await delay(600); startRound();
    }
  }catch(e){console.error(e); startRound();}
}

async function doTurn(side){
  const att=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  let def=side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse=(side==='ally'&&state.spOn&&state.A.sp>=6)||(side==='enemy'&&state.B.sp>=6);
  
  let mult=1, multi=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', usedName=att.name;
  
  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; } else { state.B.sp=0; }
    
    // Èè°ÊñáÂ≠óÂà§ÂÆö
    if(['Êú¨Ë≥™','Ë¶ã„Åà„ÇãÂåñ','Ëá™ÂàÜ„Åî„Å®Âåñ','Ëß£ÂÉèÂ∫¶'].includes(att.name)){
      const foe=(side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X'&&u.hp>0);
      if(foe.length){
        const pick=foe[Math.floor(Math.random()*foe.length)];
        const pre=spEffectPre(att,def,side,pick.name,true);
        mult=pre.mult*2.0; multi=pre.multiSeq?pre.multiSeq.map(x=>x*2.0):null;
        skillTitle=pre.skillTitle; usedName=pick.name;
        await showCutIn(skillTitle, att.name);
        log(`Èè°ÊñáÂ≠óÔºö${pick.name}„Çí„Ç≥„Éî„ÉºÔºÅ`,'sp');
      }else{
        mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; await showCutIn(skillTitle, att.name);
      }
    } else {
      const pre=spEffectPre(att,def,side);
      mult=pre.mult; multi=pre.multiSeq; skillTitle=pre.skillTitle;
      await showCutIn(skillTitle, att.name);
      if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
    }
  } else {
    log(`${att.name}„ÅÆÊîªÊíÉ`,'atk'); await delay(400);
  }

  // ÂõûÈÅøÂà§ÂÆö
  const eva=def.eva60>0?60:def.eva;
  if(!spUse && Math.random()<(eva/100)){
    log('ÊîªÊíÉ„ÇíÂõûÈÅø„Åó„ÅüÔºÅ','highlight'); return false;
  }

  // ÊîªÊíÉÂá¶ÁêÜ„É´„Éº„Éó
  let targetRole=side==='ally'?'enemy':'ally';
  const dmgList=(Array.isArray(multi)?multi:[mult]);
  
  for(let i=0; i<dmgList.length; i++){
    let m=dmgList[i];
    let damage=baseDamage(att,def)*m;
    if(att.atk13>0) damage*=1.3; if(def.shield>0) damage*=0.5;
    damage = Math.max(1, Math.floor(damage * (Math.random()*0.4+0.8)));
    
    def.hp=Math.max(0,def.hp-damage);
    qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit');
    shakeScreen();
    showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap', `-${damage}`, 'dmg');
    renderSides();
    log(`${def.name}„Å´ ${damage} „ÉÄ„É°„Éº„Ç∏`,'dmg');
    await delay(600);
    qs('.unit.hit')?.classList.remove('hit');

    if(def.hp<=0 && def.endure){
      def.endure=false; def.hp=1; renderSides(); log('Ê†πÊÄß„ÅßËÄê„Åà„ÅüÔºÅ','highlight');
    }
    else if(def.hp<=0){
      log(`${def.name}„ÅØÂÄí„Çå„ÅüÔºÅ`,'highlight');
      const ended=await handleKO(targetRole==='enemy'?'enemy':'ally');
      if(ended) return true;
      // ÈÄ£ÊíÉ„ÅÆÈÄî‰∏≠„ÅßÂÄí„Åó„ÅüÂ†¥Âêà„ÄÅ„Çø„Éº„Ç≤„ÉÉ„ÉàÊõ¥Êñ∞
      if(i<dmgList.length-1){
        def=(side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i]);
      }
    }
  }

  // Ëá™ÂÇ∑
  if(att.selfHurt>0){
    att.selfHurt--;
    if(Math.random()<0.33){
      log('„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£äÔºÅ','dmg');
      att.hp=Math.max(0,att.hp-100); renderSides();
      if(att.hp<=0){
        log(`${att.name}„ÅØËá™ÊªÖ„Åó„Åü`,'highlight');
        return await handleKO(side);
      }
    }
  }

  if(spUse) await spEffectPost(att,def,side,usedName);
  return false;
}

async function handleKO(side){
  const team = side==='ally' ? state.A.team : state.B.team;
  const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);
  if(survivors.length===0){
    $('resTitle').textContent = side==='enemy' ? 'YOU WIN!' : 'YOU LOSE...';
    $('result').classList.add('show'); await delay(3000); $('result').classList.remove('show');
    $('battle').style.display='none'; $('setup').style.display='grid';
    return true; 
  }
  if(side==='enemy'){
    state.B.i = survivors[0].i; state.B.sp=0;
    log(`Áõ∏Êâã„ÅØ ${team[state.B.i].name} „ÇíÁπ∞„ÇäÂá∫„Åó„Åü`, 'highlight');
  } else {
    state.A.i = survivors[0].i; state.A.sp=0; state.spOn=false;
    log(`${team[state.A.i].name} „Å´‰∫§‰ª£„Åó„Åü`, 'highlight');
  }
  renderSides(); await delay(1000); startRound();
  return true; 
}

const swModal=$('switchModal'), swGrid=$('switchGrid'), swDo=$('swDo'); let swIdx=null;
function openSwitch(){
  swGrid.innerHTML=''; swIdx=null; swDo.disabled=true;
  const idxs=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!idxs.length){ log('‰∫§‰ª£„Åß„Åç„ÇãÊéß„Åà„Åå„ÅÑ„Åæ„Åõ„Çì'); return; }
  idxs.forEach(i=>{
    const u=state.A.team[i];
    const div=document.createElement('div'); div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`<div class="head"><div>${u.name}</div></div>${barRow('HP',u.hp,u.maxhp)}`;
    div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx=i; swDo.disabled=false; };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}
$('btnSwitch').onclick=()=>{ if(!inputLocked) openSwitch(); };
$('swCancel').onclick=()=>swModal.classList.remove('show');
swDo.onclick=async()=>{
  if(swIdx===null)return;
  swModal.classList.remove('show');
  state.A.i=swIdx; state.A.sp=0; state.spOn=false;
  renderSides(); log(`${state.A.team[swIdx].name} „Å´‰∫§‰ª£ÔºÅ`, 'highlight');
  await delay(500); await doTurn('enemy');
  state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
  startRound();
};

document.addEventListener('DOMContentLoaded',()=>{
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
  $('btnStart').onclick=async()=>{
    state.A.team=collect('A'); state.B.team=collect('B'); state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0; state.spOn=false; state.spAnnA=false;
    $('battleLog').innerHTML=''; $('setup').style.display='none'; $('battle').style.display='block';
    await preloadImgs([...state.A.team, ...state.B.team].map(u=>u.name));
    renderSides(); log('„Éê„Éà„É´ÈñãÂßãÔºÅ', 'highlight'); await delay(800); startRound();
  };
  $('btnG').onclick=()=>pick('G'); $('btnC').onclick=()=>pick('C'); $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{ if(!inputLocked && state.A.sp>=6){ state.spOn = !state.spOn; updateSPBtn(); }};
  $('btnRules').onclick=()=>$('rulesModal').classList.add('show');
  $('btnRand').onclick=()=>{makeTeam($('teamA'),'A');makeTeam($('teamB'),'B');};
});
})();
</script>
</body>
</html>
