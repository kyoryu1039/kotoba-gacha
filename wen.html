<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v17.00 Poke-Style Revamp</title>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f1c">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #05070a;
  --glass: rgba(15, 23, 42, 0.9);
  --glass-border: rgba(255, 255, 255, 0.15);
  --text: #eef4ff;
  
  --ally: #3b82f6;
  --enemy: #f43f5e;
  
  --hp: #10b981; --gauge: #fbbf24;
  
  /* ã‚¿ã‚¤ãƒ—å®šç¾©è‰² */
  --t-ã‚¸ã‚ª:#4d8aff; --t-ã‚¢ãƒ‹ãƒãƒ«:#00db84; --t-ãƒ•ãƒ¼ãƒ‰:#ffaa2b; 
  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#b366ff; --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#00e5ff; --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff5c87; --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#88f060;

  /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£å®šç¾©è‰² */
  --r-S: #ffd700; --r-A: #e2e8f0; --r-B: #3b82f6;
  --r-C: #10b981; --r-D: #b45309; --r-X: #a855f7;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0;overflow:hidden}
body{
  background-color: var(--bg); color: var(--text);
  font-family: 'Noto Sans JP', sans-serif; overflow-y: auto;
  /* èƒŒæ™¯ã‚’å°‘ã—è½ã¡ç€ã‹ã›ã‚‹ */
  background-image: radial-gradient(circle at 50% 50%, #1a202c 0%, #020617 100%);
}

/* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (æ§ãˆã‚ã«) */
.bg-anim {
  position: fixed; inset: 0; z-index: -1; opacity: 0.4;
  background-image: 
    linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
  background-size: 60px 60px; perspective: 1000px; transform-style: preserve-3d;
  animation: scrollGrid 30s linear infinite;
}
@keyframes scrollGrid { 0% { background-position: 0 0; } 100% { background-position: 0 60px; } }

/* å…±é€šã‚³ãƒ³ãƒ†ãƒŠ */
.container{max-width:800px;margin:0 auto;padding:12px;padding-bottom:120px}

/* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (UIå´) */
.card {
  background: var(--glass); border: 1px solid var(--glass-border);
  border-radius: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  overflow: hidden; margin-bottom: 16px;
}
.card h2 {
  margin:0; padding:10px 16px; font-size:14px; font-weight:900;
  background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--glass-border);
  display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.05em;
}
.card .body { padding: 12px; }

/* ãƒœã‚¿ãƒ³ */
.btn3d {
  appearance: none; border: none; outline: none; cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif; font-weight: 900; font-size: 14px; color: #fff;
  padding: 12px 16px; border-radius: 8px;
  position: relative; top: 0; transition: all 0.1s;
  display: inline-flex; justify-content: center; align-items: center;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.btn3d:active:not([disabled]) { top: 2px; box-shadow: none !important; }
.btn3d:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; top: 2px; }

.btn-primary {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  box-shadow: 0 4px 0 #1d4ed8, 0 8px 16px rgba(59, 130, 246, 0.4);
  border-top: 1px solid rgba(255,255,255,0.2);
}
.btn-ghost {
  background: linear-gradient(to bottom, #475569, #334155);
  box-shadow: 0 4px 0 #1e293b; border: 1px solid rgba(255,255,255,0.1);
}
.btnTiny {
  padding: 4px 10px; font-size: 10px; border-radius: 6px;
  background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
  color: #94a3b8; cursor: pointer; transition: .2s;
}

/* ç·¨æˆç”»é¢ */
#setup { display: grid; gap: 16px; }
#teamGrid { display: grid; gap: 10px; }
@media(min-width:720px){ #teamGrid { grid-template-columns: 1fr 1fr; } }
.slot { display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); }
.pill { display: grid; place-items: center; width: 24px; height: 24px; border-radius: 6px; background: #1e293b; color: #94a3b8; font-weight: 900; font-size: 12px; font-family: 'Orbitron'; }
.slot select { flex: 1; background: transparent; border: none; color: #fff; font-weight: 700; font-size: 14px; outline: none; }
.slot select option { background: #0f172a; color: #fff; }

#statsGrid { display: grid; gap: 10px; }
@media(min-width:720px){ #statsGrid { grid-template-columns: 1fr 1fr; } }
.statsCol { display: grid; gap: 8px; }
.setupMini { border: 1px solid var(--glass-border); border-radius: 8px; padding: 8px; background: rgba(30, 41, 59, 0.6); }

/* ãƒãƒˆãƒ«ç”»é¢ */
.arena { display: grid; gap: 12px; transition: transform .1s; }
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-2px,1px)}20%,80%{transform:translate(1px,-2px)}30%,50%,70%{transform:translate(-4px,2px)}40%,60%{transform:translate(4px,-2px)}}
.vsrow { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: stretch; }
.vsrow > div { min-width: 0; }

/* =========================================
   ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹ä¿® (v17.00 ãƒã‚±ã‚«é¢¨)
   ========================================= */
.unit {
  position: relative; width: 100%; height: 100%; min-height: 320px; /* é«˜ã•ã‚’ç¢ºä¿ */
  border-radius: 14px;
  /* ã‚«ãƒ¼ãƒ‰ã®ãƒ™ãƒ¼ã‚¹èƒŒæ™¯ï¼ˆã‚¿ã‚¤ãƒ—è‰²ã‚’åæ˜ ï¼‰ */
  background: linear-gradient(160deg, #1e293b, var(--typeColor), #0f172a);
  /* é‡‘å±çš„ãªæ ç·š */
  border: 3px solid #334155;
  box-shadow: 0 10px 30px rgba(0,0,0,0.7), inset 0 0 20px rgba(0,0,0,0.5);
  display: flex; flex-direction: column; overflow: hidden;
  transition: filter 0.5s, opacity 0.5s, transform 0.5s;
}
/* ã‚«ãƒ¼ãƒ‰ã®å†…å´ã«ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä¹—ã›ã‚‹ */
.unit::after {
  content: ""; position: absolute; inset: 3px; border-radius: 11px; z-index: 0;
  background:
    repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 8px),
    radial-gradient(circle at top left, rgba(255,255,255,0.15), transparent 70%);
  pointer-events: none;
}

/* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥ è±ªè¯ãªæ ã¨è¼ã */
.unit[data-rank="S"] { border-color: var(--r-S); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 15px 40px rgba(0,0,0,0.8); }
.unit[data-rank="S"]::before {
  content: ""; position: absolute; inset: 0; z-index: 10; pointer-events: none;
  background: linear-gradient(115deg, transparent 30%, rgba(255,215,0,0.4) 45%, rgba(255,255,255,0.7) 50%, transparent 55%);
  background-size: 250% 250%; animation: shine 3.5s infinite linear; mix-blend-mode: overlay;
}
.unit[data-rank="A"] { border-color: var(--r-A); box-shadow: 0 0 15px rgba(226, 232, 240, 0.4), 0 15px 40px rgba(0,0,0,0.8); }
.unit[data-rank="B"] { border-color: var(--r-B); }
.unit[data-rank="X"] { border-color: var(--r-X); box-shadow: 0 0 15px rgba(168, 85, 247, 0.4), 0 15px 40px rgba(0,0,0,0.8); }

@keyframes shine{0%{background-position:200% 200%}100%{background-position:-50% -50%}}
.unit.fall { animation: fallDown 0.8s forwards; filter: grayscale(1) brightness(0.4); }
@keyframes fallDown { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(80px) rotate(20deg); opacity: 0; } }

/* å†…éƒ¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å†æ§‹ç¯‰ */
.unitInner { position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column; padding: 4px; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šåå‰ã¨HPã‚’ä¸Šéƒ¨ã«é…ç½® */
.cardHeader {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; background: rgba(0,0,0,0.5); border-radius: 8px 8px 0 0;
  border-bottom: 2px solid rgba(255,255,255,0.1);
}
.cardName {
  font-weight: 900; font-size: 16px; color: #fff;
  text-shadow: 0 2px 4px #000; white-space: nowrap;
  flex: 1; text-align: left; display: block; /* flexè§£é™¤ */
}
.hpDisplay { display: flex; align-items: center; gap: 4px; font-family: 'Orbitron'; font-weight: 700; color: var(--hp); font-size: 14px; }
.hpLabel { font-size: 10px; color: #94a3b8; }

/* ã‚¤ãƒ©ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼šå¤§ããé…ç½® */
.artArea {
  position: relative; width: 100%; aspect-ratio: 4/3; /* ã‚ˆã‚Šæ­£æ–¹å½¢ã«è¿‘ã¥ã‘ã‚‹ */
  margin: 0; border-radius: 0 0 8px 8px; overflow: hidden;
  background: radial-gradient(circle at center, rgba(255,255,255,0.1), rgba(0,0,0,0.6));
  border: 2px solid rgba(255,255,255,0.2); border-top: none;
  display: flex; align-items: center; justify-content: center;
  box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
}
.mainImg {
  max-height: 95%; max-width: 95%; width: auto; height: auto; object-fit: contain;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7));
  animation: breathe 4s ease-in-out infinite alternate;
}
@keyframes breathe { from { transform: scale(1); } to { transform: scale(1.04); } }
.unit.hit .mainImg { animation: hit .4s ease; }
@keyframes hit{10%,90%{transform:translate(-6px,0)}20%,80%{transform:translate(10px,0)}30%,50%,70%{transform:translate(-10px,0)}40%,60%{transform:translate(10px,0)}}

/* ä¸­æ®µï¼šã‚¿ã‚¤ãƒ—ã€ç›¸æ€§ã€ãƒãƒƒã‚¸ã€HPãƒãƒ¼ */
.midSection { padding: 8px 6px; background: rgba(15, 23, 42, 0.6); margin-top: -4px; position: relative; z-index: 3; border-radius: 0 0 10px 10px; }
.typeRow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.typeIcon { font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 6px; background: var(--typeColor); color: #0b0f1c; box-shadow: 0 2px 4px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); }
.affTag { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.05em; }
.affTag.adv { background: #065f46; color: #34d399; border: 1px solid #10b981; }
.affTag.dis { background: #7f1d1d; color: #fda4af; border: 1px solid #f43f5e; }
.affTag.even { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }

.statusRow { display: flex; gap: 4px; min-height: 14px; margin-bottom: 4px; justify-content: flex-end; flex-wrap: wrap; }
.stBadge { font-size: 9px; padding: 1px 4px; border-radius: 4px; background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; }

.hpBarBg { width: 100%; height: 12px; background: #0f172a; border-radius: 6px; border: 2px solid #334155; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
.hpBar { height: 100%; background: linear-gradient(to bottom, var(--hp), #059669); width: 100%; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 10px var(--hp); position: relative; }
.hpBar::after { content:""; position:absolute; top:0; left:0; width:100%; height:50%; background:rgba(255,255,255,0.2); }

/* ä¸‹æ®µï¼šã‚¹ã‚­ãƒ«ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.bottomSection { flex: 1; display: flex; flex-direction: column; gap: 6px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 6px; }

.spRow { display: flex; gap: 4px; justify-content: center; }
.pip { width: 16px; height: 8px; background: #451a03; border: 1px solid #78350f; border-radius: 2px; transition: .3s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
.pip.on { background: linear-gradient(to bottom, var(--gauge), #d97706); border-color: #fcd34d; box-shadow: 0 0 8px var(--gauge); }

.skillInfo { background: rgba(0,0,0,0.4); padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); flex: 1; }
.skillN { font-size: 11px; font-weight: 900; color: #fcd34d; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
.skillD { font-size: 10px; line-height: 1.4; color: #cbd5e1; }

.footer { display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #94a3b8; font-family: 'Orbitron'; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; }
.btnStat { appearance: none; border: none; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #60a5fa; border-radius: 4px; padding: 2px 6px; font-size: 9px; font-weight: 800; cursor: pointer; transition: .2s; }
.btnStat:hover { background: rgba(59, 130, 246, 0.4); color: #fff; }

/* æ“ä½œãƒ‘ãƒƒãƒ‰ */
.padCard {
  position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50;
  background: rgba(15, 23, 42, 0.95); border-top: 2px solid #334155;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.6); padding: 16px 20px 28px;
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
}
@media(min-width: 800px) { .padCard { position: relative; border-radius: 24px; border: 2px solid #334155; margin-top: 20px; background: var(--glass); padding: 20px; } }

.padInner { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 600px; margin: 0 auto; }
.rpsArea { display: flex; justify-content: center; gap: 28px; padding: 4px 0; }

.rps {
  width: 72px; height: 72px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.15); cursor: pointer;
  display: grid; place-items: center; position: relative; top: 0; transition: all 0.1s;
  box-shadow: 0 8px 0 rgba(0,0,0,0.5), 0 12px 24px rgba(0,0,0,0.4);
}
.rps:active:not([disabled]) { top: 8px; box-shadow: none; }
.rps.g { background: linear-gradient(145deg, #ef4444, #991b1b); color: #fff; }
.rps.c { background: linear-gradient(145deg, #3b82f6, #1e40af); color: #fff; }
.rps.p { background: linear-gradient(145deg, #22c55e, #166534); color: #fff; }
.rps:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; top: 8px; box-shadow: none; }
.emo { font-size: 36px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }
.lbl { position: absolute; bottom: -22px; font-size: 11px; font-weight: 900; color: #94a3b8; font-family: 'Orbitron'; text-shadow: 0 1px 2px #000; }

.sideBtns { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.spToggle {
  width: 100%; padding: 16px 0; border-radius: 12px; font-weight: 900; font-size: 15px;
  border: 2px solid #1e293b; cursor: pointer; position: relative; top: 0; transition: .1s;
  background: linear-gradient(to bottom, #334155, #1e293b); color: #94a3b8;
  box-shadow: 0 6px 0 #0f172a; display: flex; justify-content: center; align-items: center; gap: 8px;
}
.spToggle.on { background: linear-gradient(to bottom, #f1c40f, #b45309); color: #fff !important; border-color: #fcd34d !important; box-shadow: 0 6px 0 #92400e, 0 0 25px rgba(251, 191, 36, 0.6); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
.spToggle.btnReady:not(.on) { background: #34495e; color: #fcd34d; border: 2px solid #fcd34d; box-shadow: 0 6px 0 #0e141a, 0 0 15px rgba(251, 191, 36, 0.3); animation: pulseBtn 0.8s infinite alternate; }

.spToggle:active:not([disabled]) { top: 6px; box-shadow: none !important; }
.spToggle:disabled { opacity: 0.5; top: 6px; box-shadow: none; cursor: not-allowed; animation: none; background: #1e293b; color: #475569; border-color: transparent; }

.switchBtn {
  width: 100%; padding: 16px 0; border-radius: 12px; font-weight: 900; font-size: 15px;
  border: 2px solid #581c87; cursor: pointer; position: relative; top: 0; transition: .1s;
  background: linear-gradient(to bottom, #a855f7, #6b21a8); color: #fff;
  box-shadow: 0 6px 0 #4c1d95;
}
.switchBtn:active:not([disabled]) { top: 6px; box-shadow: none; }
.switchBtn:disabled { opacity: 0.5; top: 6px; box-shadow: none; cursor: not-allowed; filter: grayscale(0.8); border-color: transparent; }

/* ãƒ­ã‚°ã€ã‚¿ã‚¤ãƒãƒ¼ã€ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆ */
.logContainer {
  height: 120px; margin: 10px 0; overflow-y: auto;
  background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); border-radius: 12px;
  padding: 12px; font-family: 'Noto Sans JP', sans-serif; font-size: 12px; display: flex; flex-direction: column; gap: 6px;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}
.logLine { color: #94a3b8; border-left: 3px solid #334155; padding-left: 8px; line-height: 1.4; }
.logLine.highlight { color: #fcd34d; border-left-color: #fbbf24; background: rgba(251, 191, 36, 0.05); }
.logLine.dmg { color: #fca5a5; border-left-color: #f43f5e; }
.logLine.heal { color: #6ee7b7; border-left-color: #10b981; }
.logLine.sp { color: #e9d5ff; border-left-color: #a855f7; }
.logLine.miss { color: #cbd5e1; border-left-color: #64748b; }

.timer { text-align: center; font-family: 'Orbitron'; font-weight: 700; font-size: 14px; color: #94a3b8; margin: 12px 0; }
.timer .num { font-size: 28px; color: #fff; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

.floatingText {
  position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%);
  font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 36px;
  color: #fff; -webkit-text-stroke: 2px rgba(0,0,0,0.8); text-shadow: 0 4px 12px rgba(0,0,0,0.8);
  pointer-events: none; z-index: 20; animation: floatUp 1.2s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex; align-items: center; justify-content: center; padding: 6px 16px;
  background: rgba(0,0,0,0.7); border-radius: 12px; border: 2px solid rgba(255,255,255,0.3);
  backdrop-filter: blur(4px); white-space: nowrap;
}
.floatingText.dmg { color: #f43f5e; border-color: #f43f5e; background: rgba(244, 63, 94, 0.2); }
.floatingText.heal { color: #10b981; border-color: #10b981; background: rgba(16, 185, 129, 0.2); }
.floatingText.miss { color: #94a3b8; border-color: #94a3b8; font-size: 28px; background: rgba(148, 163, 184, 0.2); }
.floatingText.buff { color: #fbbf24; border-color: #fbbf24; font-size: 24px; background: rgba(251, 191, 36, 0.2); }
.floatingText.debuff { color: #a855f7; border-color: #a855f7; font-size: 24px; background: rgba(168, 85, 247, 0.2); }
.floatingText.adv { color: #10b981; font-size: 32px; border-color: #10b981; background: rgba(16, 185, 129, 0.2); }
.floatingText.dis { color: #f43f5e; font-size: 32px; border-color: #f43f5e; background: rgba(244, 63, 94, 0.2); }

/* ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ */
#jankenOverlay, #cutIn, #switchModal, #infoModal, #rulesModal, #result {
  position: fixed; inset: 0; z-index: 100; pointer-events: none;
  display: none; align-items: center; justify-content: center;
}
#switchModal, #infoModal, #rulesModal, #result { background: rgba(0,0,0,0.8); pointer-events: auto; backdrop-filter: blur(12px); }
#jankenOverlay.active { display: flex; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
#switchModal.show, #infoModal.show, #rulesModal.show, #result.show { display: flex; }

.jkWrap { display: flex; flex-direction: column; align-items: center; gap: 32px; }
.jkHands { display: flex; gap: 40px; align-items: center; }
.jkHand { font-size: 96px; transition: transform .3s cubic-bezier(0.34, 1.56, 0.64, 1); opacity: 0; transform: scale(0); filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
.jkHand.show { opacity: 1; transform: scale(1); }
.jkHand.win { filter: drop-shadow(0 0 40px #fcd34d); transform: scale(1.4) rotate(-15deg); z-index: 10; }
.jkHand.lose { filter: grayscale(1) brightness(0.3); opacity: 0.6; transform: scale(0.7) rotate(15deg); }
.jkResult { font-family: 'Orbitron'; font-size: 72px; font-weight: 900; color: #fff; text-shadow: 0 8px 24px #000; opacity: 0; transform: translateY(40px); transition: all .4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.jkResult.show { opacity: 1; transform: translateY(0); }

#cutIn {
  background: linear-gradient(90deg, transparent, rgba(29, 78, 216, 0.95) 15%, rgba(29, 78, 216, 0.95) 85%, transparent);
  height: 140px; border-top: 3px solid #60a5fa; border-bottom: 3px solid #60a5fa;
  flex-direction: column; transform: scaleY(0); transition: .25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 0 50px rgba(37, 99, 235, 0.5);
}
#cutIn.show { display: flex; transform: scaleY(1); }
.cutInText { font-size: 40px; font-weight: 900; color: #fff; text-shadow: 0 4px 16px #000, 0 0 20px rgba(96, 165, 250, 0.8); font-style: italic; letter-spacing: 0.05em; }
.cutInSub { font-size: 16px; color: #bfdbfe; font-weight: 700; margin-top: 8px; text-shadow: 0 2px 4px #000; }

.modalCard {
  width: min(500px, 92vw); max-height: 85vh; overflow-y: auto;
  background: #1e293b; border: 2px solid #334155; border-radius: 20px; padding: 24px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.8); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modalHead { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #334155; padding-bottom: 12px; }
.modalTitle { margin: 0; font-size: 20px; font-weight: 900; color: #fff; font-family: 'Noto Sans JP'; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

#switchGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.selCard { cursor: pointer; transition: .2s; border: 2px solid transparent; background: rgba(30, 41, 59, 0.8); }
.selCard:hover { background: #334155; transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
.selCard.selected { border-color: #fcd34d; background: rgba(251, 191, 36, 0.15); box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
</style>
</head>
<body>

<div class="bg-anim"></div>

<div class="container" id="setup">
  <section class="card">
    <h2>TEAM SETUP <button class="btnTiny" id="btnRules">ãƒ«ãƒ¼ãƒ«</button></h2>
    <div class="body">
      <div id="teamGrid">
        <div><div class="statsHead" style="color:#4da6ff;font-weight:900;margin-bottom:8px">YOU</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#ff5c6c;font-weight:900;margin-bottom:8px">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:12px; margin-top:24px">
        <button id="btnRand" class="btn3d btn-ghost" style="flex:0 0 auto">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button id="btnStart" class="btn3d btn-primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2>STATUS DETAIL</h2>
    <div class="body">
      <div id="statsGrid">
        <div><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div class="container" id="battle" style="display:none">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>
    <div class="logContainer" id="battleLog"></div>
    <div class="timer">TIME <span class="num" id="countNum">15</span></div>
    <div style="height:180px"></div>
  </div>
  
  <section class="padCard" id="pad">
    <div class="padInner">
      <div class="rpsArea">
        <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">GU</div></button>
        <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">CHOKI</div></button>
        <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">PA</div></button>
      </div>
      <div class="sideBtns">
        <button class="spToggle" id="btnSP" disabled><span>âœ¨</span> å¿…æ®ºæŠ€</button>
        <button class="switchBtn" id="btnSwitch"><span>ğŸ”</span> CHANGE</button>
      </div>
    </div>
  </section>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">âœŠ</div><div style="color:#fff;font-weight:900;font-size:40px;font-family:'Orbitron';text-shadow:0 0 20px rgba(255,255,255,0.5)">VS</div><div class="jkHand" id="jkHandB">âœŒï¸</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">ãƒ¡ãƒ³ãƒãƒ¼äº¤ä»£</h3><button class="btnTiny" id="swCancel">é–‰ã˜ã‚‹</button></div><div id="switchGrid"></div><button id="swDo" class="btn3d btn-primary" style="width:100%;margin-top:24px" disabled>ã“ã®ã‚­ãƒ£ãƒ©ã«äº¤ä»£</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3><button class="btnTiny" id="infoClose">é–‰ã˜ã‚‹</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">ãƒ«ãƒ¼ãƒ«èª¬æ˜</h3><button class="btnTiny" id="rulesClose">é–‰ã˜ã‚‹</button></div><ul style="padding-left:20px;line-height:2;color:#cbd7f0;font-size:14px;list-style-type:square"><li>3ä½“ã®ã€Œè¨€è‘‰ã€ã§ãƒãƒ¼ãƒ ã‚’çµ„ã‚“ã§æˆ¦ã†ã‚¿ãƒ¼ãƒ³åˆ¶ãƒãƒˆãƒ«ã€‚</li><li>ã˜ã‚ƒã‚“ã‘ã‚“ã«<strong>å‹ã¤ã¨æ”»æ’ƒ</strong>ã€<strong>è² ã‘ã‚‹ã¨é˜²å¾¡</strong>ã€‚</li><li><strong>ã‚¿ã‚¤ãƒ—ç›¸æ€§</strong>ãŒé‡è¦ï¼ˆæœ‰åˆ©1.5å€ / ä¸åˆ©0.67å€ï¼‰ã€‚</li><li>æ”»æ’ƒãƒ»è¢«å¼¾ã§ã‚²ãƒ¼ã‚¸ãŒæºœã¾ã‚Šã€MAX(6)ã§<strong>å¿…æ®ºæŠ€</strong>ç™ºå‹•ï¼</li><li>ç›¸æ‰‹ãƒãƒ¼ãƒ ã‚’å…¨å“¡å€’ã›ã°å‹åˆ©ï¼</li></ul></div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:48px;background:rgba(15,23,42,0.95)"><h1 id="resTitle" style="color:#fff;margin:0 0 24px;font-size:56px;font-family:'Orbitron';text-shadow:0 0 30px rgba(255,255,255,0.6)">WIN</h1><p style="color:#94a3b8;font-size:14px;font-family:'Orbitron';letter-spacing:0.1em">RETURNING TO SETUP...</p></div></div>

<script>
(()=>{
'use strict';
const $=id=>document.getElementById(id);
const qs=(s,el=document)=>el.querySelector(s);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

const IMG={"ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"parabola_antenna.png","ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"nescafe_ambassador.png","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"ninjin_shirishiri.png","ãã¼ã‚ã”ã¯ã‚“":"soboro_gohan.png","ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"western_lowland_gorilla.png","æ¯›ã‚€ãã˜ã‚ƒã‚‰":"kemukujara.png","ä¹å“ä»":"kuhonbutsu.png","ã‘ã‚“ã¡ã‚“æ±":"kenchin_jiru.png","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"kamchatka_peninsula.png","ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"tarantula.png","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"shoebill.png","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"balsamic_vinegar.png","ãƒ”ãƒ­ãƒªèŒ":"helicobacter_pylori.png","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"trinidad_and_tobago.png","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"caramel_color.png","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"babylonian_captivity.png","é³¥å–ç ‚ä¸˜":"tottori_sand_dunes.png","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"placebo_effect.png","æ¸¡æ¥äºº":"torai_jin.png","ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"peperoncino.png","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"polypropylene.png","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"sarajevo_incident.png","ã‚¯ãƒãƒ³ãƒãƒ":"kumabachi.png","çœŒåºæ‰€åœ¨åœ°":"prefectural_capital.png","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"teriyaki_chicken.png","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"nerunerunerune.png","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"surume_ika.png","æœ¬è³ª":"essence.png","è¦‹ãˆã‚‹åŒ–":"mieruka.png","è‡ªåˆ†ã”ã¨åŒ–":"jibungotoka.png","è§£åƒåº¦":"resolution.png","ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png"};
function preloadImgs(names){
  const unique=[...new Set(names.map(n=>IMG[n]).filter(Boolean))];
  unique.forEach(f=>{ const im=new Image(); im.src=`images/${f}`; });
}

function log(msg, type='normal'){
  const c=$('battleLog'); const d=document.createElement('div');
  let icon='';
  if(type==='atk') icon='âš”ï¸ '; else if(type==='dmg') icon='ğŸ’¥ '; else if(type==='heal') icon='ğŸ’– '; else if(type==='sp') icon='âœ¨ '; else if(type==='miss') icon='ğŸ’¨ ';
  d.className='logLine '+type; d.textContent=icon+msg; c.appendChild(d); c.scrollTop=c.scrollHeight;
}

function updateHPUI(role, val, max){
  const bar = $(`hp-${role}`); const num = $(`hpnum-${role}`);
  if(bar) bar.style.width = `${100 * val / max}%`;
  if(num) num.textContent = val;
}

function fitName(el) {
  if(!el) return;
  const len = el.textContent.length;
  if(len > 10) el.style.fontSize = '11px';
  else if(len > 7) el.style.fontSize = '13px';
  else el.style.fontSize = '16px';
}

function showFloatingText(targetId, text, type){
  const wrap=$(targetId); if(!wrap)return;
  const el=document.createElement('div'); el.className='floatingText '+type; el.textContent=text;
  wrap.appendChild(el); setTimeout(()=>el.remove(),1500);
}

async function showCutIn(skill, user){
  $('cutInName').textContent=skill; $('cutInUser').textContent=user;
  const el=$('cutIn'); el.classList.add('show');
  await delay(1200); el.classList.remove('show'); await delay(200);
}

function shakeScreen(){
  const a=$('arena'); a.classList.remove('shake'); void a.offsetWidth; a.classList.add('shake');
}

let inputLocked=false;
function lockInputs(on){
  inputLocked = on;
  const p = $('pad');
  if (p) p.style.opacity = on ? 0.6 : 1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id=>{ const el = $(id); if(el) el.disabled = on; });
  updateSPBtn();
}

function updateSPBtn(){
  const btn=$('btnSP'); if(!btn)return;
  const ready=state.A.sp>=6;
  const canPress=!inputLocked && ready && !state.busy;
  btn.disabled=!canPress;
  if(state.spOn){
    btn.innerHTML='<span>âœ¨</span> å¿…æ®º ON'; btn.classList.add('on'); btn.classList.remove('btnReady');
  } else {
    if(ready && !inputLocked) {
      btn.innerHTML='<span>âœ¨</span> PUSH!'; btn.classList.add('btnReady'); btn.classList.remove('on');
    } else {
      btn.innerHTML='<span>âœ¨</span> å¿…æ®ºæŠ€'; btn.classList.remove('on','btnReady');
    }
  }
  if(ready && !state.spAnnA){ log('å¿…æ®ºã‚²ãƒ¼ã‚¸MAXï¼', 'highlight'); state.spAnnA=true; }
}

async function playJankenAnim(myH, cpuH, res){
  const map={G:'âœŠ',C:'âœŒï¸',P:'ğŸ–'};
  const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  ov.classList.add('active');
  hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  await delay(50); hA.classList.add('show'); hB.classList.add('show');
  await delay(400);
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else { rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show');
  await delay(800); ov.classList.remove('active');
}

const TYPES_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeColor=t=>getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`)||'#7aa0ff';
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const st=[(i+1)%n,(i+2)%n],wk=[(i-1+n)%n,(i-2+n)%n];if(st.includes(j))return 1.5;if(wk.includes(j))return 0.67;return 1;};
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

const toKatakana=(s)=>(s||"").replace(/[ã-ã‚“]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
const visualLen = (s)=> (s||"").replace(/[ãƒ»\s]/g,"").length;
const reKanaH = /[ã-ã‚Ÿ]/g, reKanaK = /[ã‚ -ãƒ¿ãƒ¼]/g, reKanji = /[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g;
function countClass(name){const H=(name.match(reKanaH)||[]).length,K=(name.match(reKanaK)||[]).length,J=(name.match(reKanji)||[]).length;return{H,K,J,total:H+K+J};}
const reSmallK = /[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°-ã‡¿]/g, reSokuon=/ãƒƒ/g, reVoiced=/[ã‚¬-ãƒãƒ´]/g, rePlosiveEnd=/[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5;
  const cls=countClass(name);
  if(cls.J+cls.K===0){atkP+=12.5;defP+=12.5;}
  else{const r=cls.K/(cls.J+cls.K);atkP+=25*r;defP+=25*(1-r);}
  const Lph=yomiKatakana.length||1;
  const d=(yomiKatakana.match(reVoiced)||[]).length/Lph;
  const s=(yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m=(yomiKatakana.match(reSmallK)||[]).length/Lph;
  const e=rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw=0.6*d+0.25*(s+m)+0.15*e, L=0.05, U=0.45;
  const s_ph=Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph=20*(0.5+0.5*s_ph);
  atkP+=atk_ph; defP+=20-atk_ph;
  const T=visualLen(name);
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len=20*(0.5+0.5*s_len);
  atkP+=atk_len; defP+=20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){const cls=countClass(name);const hiraRatio=cls.total?(cls.H/cls.total):0;const rankAdj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;let eva=10+8*hiraRatio-0.5*(T-5)+rankAdj;eva=Math.round(eva*10)/10;return Math.max(5,Math.min(35,eva));}
function makeWordObject([name,rank,type,yomiH]){const y=toKatakana(yomiH||name);const {atkP,defP,T}=calcAttackDefense(name,y);const ATK=Math.round(PRANK[rank]*(atkP/100));const DEF=Math.round(PRANK[rank]*(defP/100));const HP=Math.round(HP_BASE[rank]+20*(T-5));const EVA=calcEvasion(name,T,rank);return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};}

const SKILLS={
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","å¨åŠ›2.2å€ã€‚ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
 "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","æ”»æ’ƒå¾Œã€å‘³æ–¹å…¨å“¡HP60å›å¾©ã€‚"],
 "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","å¨åŠ›1.6å€ã€‚æ¬¡ã«å—ã‘ã‚‹è‡´å‘½å‚·ã‚’HP1ã§è€ãˆã‚‹ã€‚"],
 "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›é€£ç¶šæ”»æ’ƒï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚"],
 "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","å¨åŠ›1.5å€ã€‚æ¬¡ã®2å›ã€è‡ªåˆ†ã®æ”»æ’ƒ1.3å€ã€‚"],
 "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","å¨åŠ›1.4å€ã€‚æ¬¡ã®2å›ã€å›é¿ç‡60%å›ºå®šã€‚"],
 "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","å¨åŠ›1.6å€ã€‚æ¬¡ã®2å›ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸åŠæ¸›ã€‚"],
 "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","å¨åŠ›1.2å€ã€‚è‡ªåˆ†HP150å›å¾©ã€‚"],
 "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
 "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
 "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};
const WORDS_BASE=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const makeW=i=>makeWordObject(WORDS_BASE[i]);
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false,history:new Set()};

const left =()=>state.A.team[state.A.i];
const right =()=>state.B.team[state.B.i];

function barRow(label,val,max){const pct=Math.min(100,(val/max)*100);return `<div class="barRow"><div class="barLabel">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="barVal">${val}</div></div>`;}

function miniCard(idx){const w=makeW(idx);return `<div class="setupMini" data-type="${w.type}"><div class="head" style="display:flex;justify-content:space-between;font-weight:bold;font-size:12px;margin-bottom:4px"><div>${w.name}</div><div style="color:${typeColor(w.type)}">${w.type}</div></div><div class="statGrid">${barRow('HP',w.maxhp,800)}${barRow('ATK',w.atk,120)}${barRow('DEF',w.def,120)}${barRow('EVA',w.eva,30)}</div></div>`;}
function renderMini(side){const root=side==='A'?$('statsA'):$('statsB');root.innerHTML='';for(let i=0;i<3;i++){const idx=Number($(`${side}-${i}`).value)||0;root.innerHTML+=miniCard(idx);}}

function uniqueRandom(n, sourceLen){
  const arr = []; const pool = Array.from({length: sourceLen}, (_, i) => i);
  for(let i=0; i<n; i++){
    const idx = Math.floor(Math.random() * pool.length);
    arr.push(pool[idx]); pool.splice(idx, 1);
  }
  return arr;
}
function makeTeam(root,side){root.innerHTML='';for(let i=0;i<3;i++){const div=document.createElement('div');div.className='slot';const pill=document.createElement('span');pill.className='pill';pill.textContent='#'+(i+1);const sel=document.createElement('select');sel.id=`${side}-${i}`;WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;sel.append(o);});sel.addEventListener('change',()=>{renderMini(side);});div.append(pill,sel);root.append(div);}const picks=uniqueRandom(3,WORDS_BASE.length);picks.forEach((v,i)=>$(`${side}-${i}`).value=v);renderMini(side);}
const collect=side=>[0,1,2].map(i=>{const idx=Number($(`${side}-${i}`).value)||0;return {...makeW(idx),side};});

function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  state.busy=false; lockInputs(false); 
  checkAffinity();
  
  setTimeout(()=>{
    if(state.busy) return;
    const cpu = right(); const player = left();
    const m = typeMult(cpu.type, player.type);
    if(m <= 0.7 && cpu.lock === 0 && cpu.hp > 0){
      const reserves = [0,1,2].filter(i => i !== state.B.i && state.B.team[i].hp > 0);
      const best = reserves.find(i => typeMult(state.B.team[i].type, player.type) >= 1.5);
      if(best !== undefined && Math.random() < 0.7){ cpuSwitchAction(best); return; }
    }
  }, 1200);

  state.timer=setInterval(()=>{if(state.busy)return; state.remain--; $('countNum').textContent=state.remain; if(state.remain<=0){pick(['G','C','P'][Math.floor(Math.random()*3)]);}},1000);
}

async function cpuSwitchAction(nextIdx){
  state.busy = true; clearInterval(state.timer); lockInputs(true);
  try {
    log('CPUãŒäº¤ä»£ã‚’é¸æŠï¼', 'highlight'); await delay(1000);
    state.B.i = nextIdx; state.B.sp = 0; renderSides();
    log(`ç›¸æ‰‹ã¯ ${right().name} ã«äº¤ä»£ã—ãŸï¼`, 'highlight'); await delay(1000);
    log('ç›¸æ‰‹ã®éš™ã ï¼æ”»æ’ƒã®ãƒãƒ£ãƒ³ã‚¹ï¼', 'highlight');
    const ended = await doTurn('ally');
    if(!ended){
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      startRound();
    }
  } catch(e){ console.error(e); startRound(); } finally { state.busy = false; lockInputs(false); }
}

function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}

function baseDamage(att, def){
  let mult = typeMult(att.type, def.type);
  let val = 100 * (1 + att.atk/100) / (1 + def.def/120) * mult;
  return val * (Math.random() * 0.4 + 0.8);
}

function checkAffinity(){
  const a = left(), b = right();
  const pairKey = `${a.name}:${b.name}`;
  const setBadge = (el, m) => {
    if(!el) return; el.className = 'affTag';
    if(m>=1.5) { el.textContent='â— æœ‰åˆ©'; el.classList.add('adv'); }
    else if(m<=0.7) { el.textContent='â–³ ä¸åˆ©'; el.classList.add('dis'); }
    else { el.textContent='ãƒ¼ ç­‰å€'; el.classList.add('even'); }
  };
  const m1 = typeMult(a.type, b.type);
  setBadge(qs('#affA'), m1);
  setBadge(qs('#affB'), typeMult(b.type, a.type));

  if(!state.history.has(pairKey)){
    state.history.add(pairKey);
    if(m1 >= 1.5) { showFloatingText('leftWrap', 'ç›¸æ€§æœ‰åˆ©!', 'adv'); log(`ã€æœ‰åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼·ã„ï¼`,'heal'); }
    else if(m1 <= 0.7) { showFloatingText('leftWrap', 'ç›¸æ€§ä¸åˆ©...', 'dis'); log(`ã€ä¸åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼±ã„...`,'dmg'); }
  }
}

/* ã‚«ãƒ¼ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ã®å¤§å¹…æ”¹ä¿® (v17.00 ãƒã‚±ã‚«é¢¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) */
function renderCard(u,role,opp){
  const sp=role==='ally'?state.A.sp:state.B.sp, tag=role==='ally'?'A':'B';
  const owner=role==='ally'?'YOU':'CPU';
  const img=IMG[u.name]?`<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none'">`:'<span style="font-size:60px">ğŸ“¦</span>';
  const skill=(SKILLS[u.name]||['â€”','â€”']);
  const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  let badges='';
  if(u.lock>0) badges+=`<div class="stBadge">ğŸ”’äº¤ä»£ä¸å¯</div>`;
  if(u.doom>0) badges+=`<div class="stBadge">ğŸ‘¾æ–‡å­—åŒ–ã‘</div>`;
  if(u.selfHurt>0) badges+=`<div class="stBadge">ğŸŒ€å´©å£Š</div>`;
  
  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}">
    <div class="unitInner">
      <div class="cardHeader">
        <div class="cardName" id="nm-${role}">${u.name}</div>
        <div class="hpDisplay"><span id="hpnum-${role}">${u.hp}</span><span class="hpLabel">HP</span></div>
      </div>
      
      <div class="artArea" id="art-${role}">${img}</div>
      
      <div class="midSection">
        <div class="typeRow">
          <span class="typeIcon">${u.type}</span>
          <span id="aff${tag}" class="affTag"></span>
          <div class="statusRow">${badges}</div>
        </div>
        <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
      </div>

      <div class="bottomSection">
        <div class="skillInfo">
          <div class="skillN"><span style="color:#fff">æŠ€:</span> ${skill[0]}</div>
          <div class="skillD">${skill[1]}</div>
        </div>
        <div class="spRow">${pips}</div>
        <div class="footer"><span>ATK: ${u.atk} / DEF: ${u.def} / EVA: ${u.eva}%</span></div>
      </div>
    </div>
  </div>`;
}

function renderSides(){
  $('leftWrap').innerHTML=renderCard(state.A.team[state.A.i],'ally',state.B.team[state.B.i]);
  $('rightWrap').innerHTML=renderCard(state.B.team[state.B.i],'enemy',state.A.team[state.A.i]);
  fitName(qs('#nm-ally')); fitName(qs('#nm-enemy'));
  updateSPBtn(); checkAffinity();
}

window._sh=(n)=>{
  const u=[...state.A.team,...state.B.team].find(x=>x.name===n); if(!u)return;
  const skill = SKILLS[u.name]||['?','?'];
  const html = `
    <div style="text-align:center;margin-bottom:12px">
      <h2 style="margin:0;color:${typeColor(u.type)};font-size:20px">${u.name}</h2>
      <div style="font-size:12px;color:#ccc;margin-top:4px">[${u.rank}ãƒ©ãƒ³ã‚¯ / ${u.type}ã‚¿ã‚¤ãƒ—]</div>
    </div>
    <div class="setupMini" style="margin-bottom:12px;background:rgba(0,0,0,0.3)">
      <div class="statGrid" style="gap:12px">
        ${barRow('HP', u.hp, u.maxhp)} ${barRow('ATK', u.atk, 120)}
        ${barRow('DEF', u.def, 120)} ${barRow('EVA', u.eva, 30)}
      </div>
    </div>
    <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;border:1px solid #444">
      <div style="font-weight:bold;color:#ffd900;margin-bottom:6px;font-size:14px">å¿…æ®ºæŠ€: ${skill[0]}</div>
      <div style="font-size:12px;line-height:1.5;color:#ccc">${skill[1]}</div>
    </div>
  `;
  $('infoBody').innerHTML=html; $('infoModal').classList.add('show');
};

function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
  let mult=1, multiSeq=null, skillTitle='é€šå¸¸æ”»æ’ƒ', skillUser=att.name, notes=[];
  const useName=forcedName??att.name;
  const [title,desc]=(SKILLS[useName]||['â€”','â€”']);
  skillTitle=title;
  switch(useName){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': mult=2.2; break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': mult=1; notes.push('å‘³æ–¹å…¨å“¡å›å¾©'); break;
    case 'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š': mult=1.6; att.endure=true; showFloatingText(role==='ally'?'leftWrap':'rightWrap','æ ¹æ€§','buff'); break;
    case 'ãã¼ã‚ã”ã¯ã‚“': multiSeq=[0.75,0.5,0.25]; break;
    case 'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©': mult=1.5; att.atk13=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ATK UP','buff'); break;
    case 'æ¯›ã‚€ãã˜ã‚ƒã‚‰': mult=1.4; att.eva60=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','å›é¿UP','buff'); break;
    case 'ä¹å“ä»': mult=1.6; att.shield=2; showFloatingText(role==='ally'?'leftWrap':'rightWrap','è»½æ¸›','buff'); break;
    case 'ã‘ã‚“ã¡ã‚“æ±': mult=1.2; notes.push('è‡ªå·±å›å¾©'); break;
    case 'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶': case 'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦': case 'ãƒãƒ«ã‚µãƒŸã‚³é…¢': case 'ãƒãƒ“ãƒ­ãƒ³æ•å›š': case 'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³': case 'ã‚¯ãƒãƒ³ãƒãƒ': case 'ç…§ã‚Šç„¼ããƒã‚­ãƒ³': def.lock=4; showFloatingText(role==='ally'?'rightWrap':'leftWrap','LOCKED','debuff'); break;
    case 'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©': case 'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´': case 'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶': case 'ã•ã‚‹ã³ã‚ä¸¸': def.stun=true; showFloatingText(role==='ally'?'rightWrap':'leftWrap','ã‚¹ã‚¿ãƒ³','debuff'); break;
    case 'ãƒ”ãƒ­ãƒªèŒ': case 'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ': case 'é³¥å–ç ‚ä¸˜': case 'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ': case 'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ': case 'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«': case 'ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­': def.selfHurt=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','å´©å£Š','debuff'); break;
    case 'æ¸¡æ¥äºº': case 'çœŒåºæ‰€åœ¨åœ°': def.doom=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','æ–‡å­—åŒ–ã‘','debuff'); break;
    case 'æœ¬è³ª': case 'è¦‹ãˆã‚‹åŒ–': case 'è‡ªåˆ†ã”ã¨åŒ–': case 'è§£åƒåº¦':
      if(!mirrorMode){ mult=2.0; skillTitle='é¡æ–‡å­—'; } break;
  }
  return {mult,multiSeq,skillTitle,skillUser,notes};
}
async function spEffectPost(att,def,role,usedName){
  switch(usedName){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': if(role==='ally'){state.B.sp=0;}else{state.A.sp=0;} break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': {
      const team = (role==='ally'?state.A.team:state.B.team);
      team.forEach(u=>{ if(u.hp<u.maxhp){ u.hp=Math.min(u.maxhp,u.hp+60); } });
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+60','heal');
      renderSides(); 
      break;
    }
    case 'ã‘ã‚“ã¡ã‚“æ±': {
      att.hp=Math.min(att.maxhp,att.hp+150); 
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+150','heal');
      renderSides(); 
      break;
    }
  }
}

async function startOfAction(side){
  const me=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  if(me.eva60>0)me.eva60--; if(me.atk13>0)me.atk13--; if(me.lock>0)me.lock--;
  if(me.doom>0){
    me.doom--;
    if(me.doom<=0){
      me.hp=0; renderSides();
      qs(side==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${me.name}ã¯æ–‡å­—åŒ–ã‘ã§å€’ã‚ŒãŸï¼`,'highlight');
      const ended=await handleKO(side); return false===ended;
    }
  }
  if(me.stun){
    me.stun=false; renderSides();
    log(`${me.name}ã¯å‹•ã‘ãªã„ï¼`,'highlight'); await delay(1000);
    return false;
  }
  return true;
}

async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true; clearInterval(state.timer); lockInputs(true);
  try{
    const cpu=['G','C','P'][Math.floor(Math.random()*3)];
    const res=judge(h,cpu);
    await playJankenAnim(h,cpu,res);
    
    let ko=false;
    if(res>0){
      if(await startOfAction('ally')) ko=await doTurn('ally');
    } else if(res<0){
      if(await startOfAction('enemy')) ko=await doTurn('enemy');
    }
    if(!ko){
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      if(state.A.sp<6)state.spAnnA=false;
      renderSides(); log('æ¬¡ã®ã‚¿ãƒ¼ãƒ³','normal'); await delay(600); startRound();
    }
  }catch(e){console.error(e); startRound();}
}

async function doTurn(side){
  const att=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  let def=side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse=(side==='ally'&&state.spOn&&state.A.sp>=6)||(side==='enemy'&&state.B.sp>=6);
  
  let mult=1, multi=null, skillTitle='é€šå¸¸æ”»æ’ƒ', usedName=att.name;
  
  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; } else { state.B.sp=0; }
    
    if(['æœ¬è³ª','è¦‹ãˆã‚‹åŒ–','è‡ªåˆ†ã”ã¨åŒ–','è§£åƒåº¦'].includes(att.name)){
      const foe=(side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X'&&u.hp>0);
      if(foe.length){
        const pick=foe[Math.floor(Math.random()*foe.length)];
        const pre=spEffectPre(att,def,side,pick.name,true);
        mult=pre.mult*2.0; multi=pre.multiSeq?pre.multiSeq.map(x=>x*2.0):null;
        skillTitle=pre.skillTitle; usedName=pick.name;
        await showCutIn(skillTitle, att.name);
        log(`é¡æ–‡å­—ï¼š${pick.name}ã‚’ã‚³ãƒ”ãƒ¼ï¼`,'sp');
      }else{
        mult=2.0; skillTitle='é¡æ–‡å­—'; await showCutIn(skillTitle, att.name);
      }
    } else {
      const pre=spEffectPre(att,def,side);
      mult=pre.mult; multi=pre.multiSeq; skillTitle=pre.skillTitle;
      await showCutIn(skillTitle, att.name);
      if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
    }
  } else {
    log(`${att.name}ã®æ”»æ’ƒ`,'atk'); await delay(400);
  }

  const eva=def.eva60>0?60:def.eva;
  if(!spUse && Math.random()<(eva/100)){
    showFloatingText(side==='ally'?'rightWrap':'leftWrap', "MISS", "miss");
    log('æ”»æ’ƒã‚’å›é¿ã—ãŸï¼','miss'); 
    await delay(800);
    return false;
  }

  let targetRole=side==='ally'?'enemy':'ally';
  const dmgList=(Array.isArray(multi)?multi:[mult]);
  
  for(let i=0; i<dmgList.length; i++){
    let m=dmgList[i];
    let base = baseDamage(att,def) * m;
    if(att.atk13>0) base *= 1.3;
    if(def.shield>0){ base*=0.5; def.shield--; showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','GUARD','buff'); }
    
    let damage = Math.max(1, Math.floor(base));
    
    def.hp=Math.max(0,def.hp-damage);
    updateHPUI(targetRole, def.hp, def.maxhp);

    qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit');
    shakeScreen();
    showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap', `-${damage}`, 'dmg');
    
    log(`${def.name}ã« ${damage} ãƒ€ãƒ¡ãƒ¼ã‚¸`,'dmg');
    await delay(1200); 
    qs('.unit.hit')?.classList.remove('hit');

    if(def.hp<=0 && def.endure){
      def.endure=false; def.hp=1; 
      updateHPUI(targetRole, 1, def.maxhp);
      showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap', 'æ ¹æ€§', 'buff');
      log('æ ¹æ€§ã§è€ãˆãŸï¼','highlight');
    }
    else if(def.hp<=0){
      qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${def.name}ã¯å€’ã‚ŒãŸï¼`,'highlight');
      const ended=await handleKO(targetRole==='enemy'?'enemy':'ally');
      if(ended) return true;
      if(i<dmgList.length-1){
        def=(side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i]);
      }
    }
  }

  if(att.selfHurt>0){
    att.selfHurt--;
    if(Math.random()<0.33){
      log('ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼','dmg');
      att.hp=Math.max(0,att.hp-100); 
      const myRole=side==='ally'?'ally':'enemy';
      updateHPUI(myRole, att.hp, att.maxhp);
      showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','-100','dmg');
      if(att.hp<=0){
        qs(myRole==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
        await delay(1000);
        log(`${att.name}ã¯è‡ªæ»…ã—ãŸ`,'highlight');
        return await handleKO(side);
      }
    }
  }
  if(spUse) await spEffectPost(att,def,side,usedName);
  return false;
}

async function handleKO(side){
  const team = side==='ally' ? state.A.team : state.B.team;
  const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);
  if(survivors.length===0){
    $('resTitle').textContent = side==='enemy' ? 'YOU WIN!' : 'YOU LOSE...';
    $('result').classList.add('show'); await delay(3000); $('result').classList.remove('show');
    $('battle').style.display='none'; $('setup').style.display='grid';
    return true; 
  }
  if(side==='enemy'){
    state.B.i = survivors[0].i; state.B.sp=0;
    log(`ç›¸æ‰‹ã¯ ${team[state.B.i].name} ã‚’ç¹°ã‚Šå‡ºã—ãŸ`, 'highlight');
  } else {
    state.A.i = survivors[0].i; state.A.sp=0; state.spOn=false;
    log(`${team[state.A.i].name} ã«äº¤ä»£ã—ãŸ`, 'highlight');
  }
  renderSides(); await delay(1000); startRound();
  return true; 
}

const swModal=$('switchModal'), swGrid=$('switchGrid'), swDo=$('swDo'); let swIdx=null;
function openSwitch(){
  if(left().lock>0){ log('è¨€è«–çµ±åˆ¶ã«ã‚ˆã‚Šäº¤ä»£ä¸å¯ï¼', 'highlight'); showFloatingText('leftWrap','LOCKED','debuff'); return; }
  swGrid.innerHTML=''; swIdx=null; swDo.disabled=true;
  const idxs=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!idxs.length){ log('äº¤ä»£ã§ãã‚‹æ§ãˆãŒã„ã¾ã›ã‚“'); return; }
  const enemy = right();
  
  idxs.forEach(i=>{
    const u=state.A.team[i];
    const skill = SKILLS[u.name]||['?','?'];
    const m = typeMult(u.type, enemy.type);
    let affText = 'ãƒ¼ ç­‰å€'; let affClass = 'color:#8ba0c0';
    if(m>=1.5){ affText='â— æœ‰åˆ©'; affClass='color:#4effa5'; }
    if(m<=0.7){ affText='â–³ ä¸åˆ©'; affClass='color:#ff5c6c'; }

    const div=document.createElement('div'); div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`
      <div class="head" style="display:flex;justify-content:space-between;font-weight:bold;font-size:12px;margin-bottom:4px"><div>${u.name}</div></div>
      <div style="font-size:11px;font-weight:bold;${affClass};margin-bottom:6px">å¯¾ ${enemy.name}: ${affText}</div>
      <div class="statGrid" style="gap:10px">
        ${barRow('HP',u.hp,u.maxhp)} ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)} ${barRow('EVA',u.eva,30)}
      </div>
      <div style="font-size:10px;color:#ccc;margin-top:6px;border-top:1px solid rgba(255,255,255,0.1);padding-top:4px">å¿…æ®º: ${skill[0]}</div>
    `;
    div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx=i; swDo.disabled=false; };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}

$('btnSwitch').onclick=()=>{ if(!inputLocked) openSwitch(); };
$('swCancel').onclick=()=>swModal.classList.remove('show');
swDo.onclick=async()=>{
  if(swIdx===null)return;
  swModal.classList.remove('show');
  state.A.i=swIdx; state.A.sp=0; state.spOn=false;
  renderSides(); log(`${state.A.team[swIdx].name} ã«äº¤ä»£ï¼`, 'highlight');
  
  await delay(500); 
  const ended = await doTurn('enemy');
  if(!ended) {
    state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
    startRound();
  }
};

const modals = ['switchModal','infoModal','rulesModal'];
modals.forEach(id=>{ $(id).addEventListener('click', (e)=>{ if(e.target === $(id)) $(id).classList.remove('show'); }); });

document.addEventListener('DOMContentLoaded',()=>{
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
  $('btnStart').onclick=async()=>{
    state.A.team=collect('A'); state.B.team=collect('B'); state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0; state.spOn=false; state.spAnnA=false;
    state.history=new Set();
    $('battleLog').innerHTML=''; $('setup').style.display='none'; $('battle').style.display='block';
    await preloadImgs([...state.A.team, ...state.B.team].map(u=>u.name));
    renderSides(); 
    log('ãƒãƒˆãƒ«é–‹å§‹ï¼', 'highlight'); 
    checkAffinity();
    await delay(800); startRound();
  };
  $('btnG').onclick=()=>pick('G'); $('btnC').onclick=()=>pick('C'); $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{ if(!inputLocked && state.A.sp>=6){ state.spOn = !state.spOn; updateSPBtn(); }};
  
  $('btnRules').onclick=()=>$('rulesModal').classList.add('show');
  $('rulesClose').onclick=()=>$('rulesModal').classList.remove('show');
  $('infoClose').onclick=()=>$('infoModal').classList.remove('show');
  $('btnRand').onclick=()=>{makeTeam($('teamA'),'A');makeTeam($('teamB'),'B');};
});
})();
</script>
</body>
</html>
