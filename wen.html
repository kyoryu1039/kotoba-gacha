<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v8.00 Ultimate</title>
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f1c">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --bg:#080b14; --text:#eef4ff;
  --panel:#10182b; --panel2:#0c1221; --border:#2a3d6b; --shadow:0 8px 32px rgba(0,0,0,.4);
  --ally:#4da6ff; --enemy:#ff5c6c;
  --hp:#4effa5; --hpBack:#0a2618;
  --gauge:#ffd900; --gaugeBack:#3d2e00;
  /* ã‚¿ã‚¤ãƒ—ã‚«ãƒ©ãƒ¼ */
  --t-ã‚¸ã‚ª:#4d8aff; --t-ã‚¢ãƒ‹ãƒãƒ«:#00db84; --t-ãƒ•ãƒ¼ãƒ‰:#ffaa2b; --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#b366ff; --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#00e5ff; --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff5c87; --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#88f060;
}

/* reset */
*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0;overflow:hidden} /* ã‚·ã‚§ã‚¤ã‚¯æ¼”å‡ºã®ãŸã‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶é™ */
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;overflow-y:auto}

/* å…±é€š */
.container{max-width:1024px;margin:0 auto;padding:12px;position:relative}
.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
.card h2{margin:0;padding:12px 18px;border-bottom:1px solid var(--border);font-size:16px;position:relative;font-weight:800;letter-spacing:.05em;background:rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center}
.card .body{padding:14px}
.primary,.ghost{appearance:none;cursor:pointer;border-radius:10px;border:1px solid #364a80;background:#142042;color:#eaf2ff;padding:10px 16px;font-weight:800;font-size:13px;transition:.15s;display:inline-flex;justify-content:center;align-items:center}
.primary{background:linear-gradient(180deg,#2b52a3,#18326a);border-color:#4a74c9;box-shadow:0 4px 0 #0f1f42}
.primary:active{transform:translateY(2px);box-shadow:0 2px 0 #0f1f42}
.ghost:hover{background:#1c2b55}
button:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;box-shadow:none!important;filter:grayscale(1)}
.btnTiny{padding:4px 10px;border-radius:6px;font-size:11px;height:24px;border:1px solid #364a80;background:transparent;color:#abc}

/* === ç·¨æˆ === */
#setup{display:grid;gap:16px}
#teamGrid{display:grid;gap:12px}
@media(min-width:720px){#teamGrid{grid-template-columns:1fr 1fr}}
.slot{display:flex;gap:10px;align-items:center;background:#090e1c;padding:6px;border-radius:12px;border:1px solid #1f2b4d}
.pill{display:inline-grid;place-items:center;width:24px;height:24px;border-radius:6px;background:#1a2642;color:#8ba6d6;font-weight:900;font-size:11px}
.slot select{flex:1;background:transparent;border:none;color:#eaf2ff;padding:4px;font-weight:700;font-size:14px;outline:none}
.statsHead{font-weight:800;font-size:12px;letter-spacing:.05em;margin:0 0 8px;opacity:.8;text-transform:uppercase}
#statsGrid{display:grid;gap:12px}
@media(min-width:720px){#statsGrid{grid-template-columns:1fr 1fr}}
.statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}
.setupMini{
  border:1px solid #2a3d6b; border-radius:10px; padding:10px; position:relative;
  background:#11182b; box-shadow:0 4px 10px rgba(0,0,0,.3);
  display:flex; flex-direction:column; gap:6px;
}
.setupMini .head{display:flex;justify-content:space-between;font-weight:800;font-size:13px}
.barLine{display:flex;align-items:center;gap:8px;height:12px}
.barBox{flex:1;height:6px;background:#060912;border-radius:3px;overflow:hidden}
.barFill{height:100%;background:var(--hp);border-radius:3px}
.val{font-size:10px;color:#9cb3de;width:30px;text-align:right;font-family:"Menlo",monospace}

/* === ãƒãƒˆãƒ« === */
.inBattle{font-size:.95em}
.arena{display:grid;gap:16px;transition:transform .1s}
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-2px,1px)}20%,80%{transform:translate(1px,-2px)}30%,50%,70%{transform:translate(-4px,2px)}40%,60%{transform:translate(4px,-2px)}}

.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:stretch}
.vsrow>div{min-width:0;background:transparent!important;box-shadow:none!important;border:none!important;position:relative}

/* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
.unit{
  position:relative; width:100%; height:100%; min-height:230px;
  border-radius:14px; padding:10px;
  background:#151b2e; border:1px solid #2a3d6b;
  display:flex; flex-direction:column;
  box-shadow:0 12px 30px rgba(0,0,0,.5);
  overflow:hidden;
}
.unit[data-rank="S"]{ background:linear-gradient(145deg,#1a1a2e,#2e2138); border:1px solid #ffd700; box-shadow:0 0 15px rgba(255,215,0,.2), 0 12px 30px rgba(0,0,0,.5); }
.unit[data-rank="S"]::before{
  content:""; position:absolute; inset:0; z-index:0;
  background:linear-gradient(115deg, transparent 30%, rgba(255,255,255,.1) 45%, rgba(255,255,255,.2) 50%, transparent 55%);
  background-size:250% 250%; animation:shine 4s infinite linear; pointer-events:none;
}
.unit[data-rank="A"]{ background:linear-gradient(145deg,#141e38,#242f4f); border:1px solid #e0c060; }
.unit[data-rank="B"]{ border:1px solid #a0b0d0; }
.unit[data-rank="C"]{ border:1px solid #cd7f32; }
@keyframes shine{0%{background-position:200% 200%}100%{background-position:-50% -50%}}

.unitInner{position:relative; z-index:2; flex:1; display:flex; flex-direction:column}
.cardHeader{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.ownerBadge{font-size:9px;font-weight:900;padding:2px 6px;border-radius:4px;background:#000;border:1px solid #444;color:#ccc}
.ownerBadge.ally{color:var(--ally);border-color:var(--ally)}
.ownerBadge.enemy{color:var(--enemy);border-color:var(--enemy)}
.typeIcon{font-size:10px;font-weight:800;padding:2px 8px;border-radius:10px;background:var(--typeColor);color:#080b14;box-shadow:0 2px 5px rgba(0,0,0,.3)}

.artArea{
  position:relative; width:100%; aspect-ratio:1.8/1; margin-bottom:8px;
  background:radial-gradient(circle, rgba(0,0,0,.2), rgba(0,0,0,.6));
  border-radius:8px; border:1px solid rgba(255,255,255,.1);
  display:flex; align-items:center; justify-content:center;
}
.mainImg{height:90%; width:auto; filter:drop-shadow(0 5px 8px rgba(0,0,0,.6)); transition:transform .2s}
.unit.hit .mainImg{animation:hit .4s ease}
@keyframes hit{10%,90%{transform:translate(-4px,0)}20%,80%{transform:translate(8px,0)}30%,50%,70%{transform:translate(-8px,0)}40%,60%{transform:translate(8px,0)}}

.cardName{text-align:center; font-weight:900; font-size:16px; margin:0 0 8px; text-shadow:0 2px 0 #000; letter-spacing:.02em; white-space:nowrap; overflow:hidden}
.statRow{display:grid; grid-template-columns:24px 1fr; gap:6px; align-items:center; margin-bottom:4px; font-size:10px; font-weight:700; color:#8ba0c0}
.hpBarBg{height:8px; background:#06080e; border-radius:4px; border:1px solid #233562; overflow:hidden}
.hpBar{height:100%; background:var(--hp); width:100%; transition:width .4s ease-out; box-shadow:0 0 8px var(--hp)}
.num{text-align:right; font-family:monospace}

/* çŠ¶æ…‹ç•°å¸¸ãƒãƒƒã‚¸ */
.statusRow{display:flex;gap:4px;min-height:16px;margin-bottom:4px;justify-content:flex-end}
.stBadge{font-size:9px;padding:2px 4px;border-radius:4px;background:#330000;color:#ff5c6c;border:1px solid #ff5c6c;display:flex;align-items:center;gap:2px}

.spRow{display:flex; gap:3px; justify-content:center; margin:6px 0}
.pip{width:14px; height:6px; background:#221a00; border:1px solid #4d3900; border-radius:2px}
.pip.on{background:var(--gauge); border-color:#ffeaa7; box-shadow:0 0 6px var(--gauge)}

.skillInfo{background:rgba(0,0,0,.3); padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,.05); margin-top:auto}
.skillN{font-size:10px; font-weight:800; color:#e0e6f0; margin-bottom:2px}
.skillD{font-size:9px; line-height:1.3; color:#9aa5b8}
.footer{display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:9px; color:#677a99}
.btnStat{background:transparent; border:1px solid #364a80; color:#8ba6d6; border-radius:4px; padding:2px 6px; font-size:9px; cursor:pointer}

/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¼”å‡º */
.floatingText{
  position:absolute; left:50%; top:40%; transform:translate(-50%,-50%);
  font-family:"Arial Black",sans-serif; font-weight:900; font-size:32px;
  color:#fff; -webkit-text-stroke:1px #000; text-shadow:0 4px 10px rgba(0,0,0,.8);
  pointer-events:none; z-index:10; animation:floatUp .8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
}
.floatingText.dmg{color:#ff5c6c}
.floatingText.heal{color:#4effa5}
@keyframes floatUp{0%{opacity:0;transform:translate(-50%,0) scale(0.5)} 20%{opacity:1;transform:translate(-50%,-60px) scale(1.2)} 100%{opacity:0;transform:translate(-50%,-100px) scale(1)}}

/* ã‚«ãƒƒãƒˆã‚¤ãƒ³ */
#cutIn{
  position:fixed; top:35%; left:0; width:100%; height:120px; z-index:85;
  background:linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(20,30,80,.95) 15%, rgba(20,30,80,.95) 85%, rgba(0,0,0,0) 100%);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  transform:scaleY(0); transform-origin:center; transition:transform .15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events:none; border-top:2px solid #ffe066; border-bottom:2px solid #ffe066;
}
#cutIn.show{transform:scaleY(1)}
.cutInText{font-size:32px; font-weight:900; color:#fff; text-shadow:0 4px 15px #000; font-style:italic; letter-spacing:.1em}
.cutInSub{font-size:14px; color:#ffe066; font-weight:700; margin-top:4px}

/* æ“ä½œãƒ‘ãƒãƒ« */
.padCard{
  position:relative; background:rgba(18,28,58,.9);
  border:1px solid #31457b; border-radius:20px;
  box-shadow:0 12px 32px rgba(0,0,0,.5);
  padding:12px; backdrop-filter:blur(8px);
}
.padInner{display:grid;grid-template-columns:1fr;gap:12px}
.rpsArea{display:flex;justify-content:center;gap:20px;padding:10px 0}
.rps{
  position:relative; width:68px; height:68px; border-radius:50%; border:none; cursor:pointer;
  display:grid; place-items:center; box-shadow:0 6px 0 rgba(0,0,0,.4), 0 12px 20px rgba(0,0,0,.3);
  transition:transform .1s, box-shadow .1s;
}
.rps:active{transform:translateY(4px); box-shadow:0 2px 0 rgba(0,0,0,.4)}
.rps.g{background:linear-gradient(#ff9ea6,#ff5c6c); color:#52000b}
.rps.c{background:linear-gradient(#9ebdff,#4d8aff); color:#001a4d}
.rps.p{background:linear-gradient(#9effc5,#00db84); color:#003d24}
.emo{font-size:30px}
.lbl{position:absolute; bottom:-20px; font-size:10px; font-weight:800; color:#8ba6d6}

.sideBtns{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.switchBtn{border-radius:8px;background:linear-gradient(90deg,#8e44ad,#9b59b6);border:none;color:#fff;font-weight:800;padding:12px 0;text-shadow:0 1px 1px rgba(0,0,0,.3)}
.spToggle{
  border-radius:8px; background:#121829; border:2px solid #554400; color:#776600;
  font-weight:800; padding:10px 0; transition:.2s;
}
.spToggle.on{background:linear-gradient(90deg,#ffb700,#ffaa00); color:#3d2e00!important; border-color:#ffd700!important; box-shadow:0 0 15px rgba(255,200,0,.4); text-shadow:0 1px 0 rgba(255,255,255,.4)}
.spToggle.btnReady:not(.on){border-color:#ffaa00; color:#ffaa00; animation:glow 1.5s infinite}
@keyframes glow{50%{box-shadow:0 0 10px rgba(255,170,0,.3)}}

/* ãƒ­ã‚°ãƒ»æ§ãˆ */
#boxGrid{display:grid;gap:8px;grid-template-columns:1fr 1fr}
.boxCol{background:#0e1424;border:1px solid #1f2b4d;border-radius:12px;padding:8px}
.mini{
  border:1px solid #2a3d6b; border-radius:6px; padding:6px; cursor:pointer; position:relative;
  background:#141d33; margin-bottom:6px; transition:.2s;
}
.mini:hover{background:#1c2642; transform:translateX(2px)}
.mini .head{display:flex;justify-content:space-between;font-size:11px;font-weight:700;margin-bottom:4px}
.miniBarBg{height:4px;background:#000;border-radius:2px;overflow:hidden}
.miniBar{height:100%;background:var(--hp)}

/* ãƒ­ã‚°å¼·åŒ– */
.logContainer{
  height:140px; margin:8px 0; overflow-y:auto;
  background:rgba(0,0,0,.4); border:1px solid #1f2b4d; border-radius:10px;
  padding:8px; font-family:"Hiragino Kaku Gothic ProN", sans-serif; font-size:13px; /* ã‚µã‚¤ã‚ºUP */
  display:flex; flex-direction:column; gap:6px;
}
.logLine{color:#b0c4de; border-left:3px solid #2b3a70; padding-left:8px; padding-bottom:2px; line-height:1.4}
.logLine.highlight{color:#ffe066; border-left-color:#ffe066; background:rgba(255,224,102,0.08)}
.logLine.dmg{color:#ff9e9e; border-left-color:#ff5c6c}
.logLine.heal{color:#9effc5; border-left-color:#4effa5}
.logLine.sp{color:#fff; border-left-color:#a29bfe; background:linear-gradient(90deg, rgba(162,155,254,0.1), transparent)}

/* ã˜ã‚ƒã‚“ã‘ã‚“æ¼”å‡º */
#jankenOverlay{
  position:fixed; inset:0; z-index:90; pointer-events:none;
  display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);
}
#jankenOverlay.active{display:flex}
.jkWrap{display:flex; flex-direction:column; align-items:center; gap:30px}
.jkHands{display:flex; gap:50px; align-items:center}
.jkHand{font-size:80px; transition:transform .2s cubic-bezier(.17,.67,.28,1.4); opacity:0; transform:scale(0)}
.jkHand.show{opacity:1; transform:scale(1)}
.jkHand.win{filter:drop-shadow(0 0 30px #ffe066); transform:scale(1.4) rotate(-15deg); z-index:10}
.jkHand.lose{filter:grayscale(1) brightness(0.5); opacity:0.5; transform:scale(0.8) rotate(15deg)}
.jkResult{font-size:60px; font-weight:900; color:#fff; text-shadow:0 4px 20px rgba(0,0,0,1); opacity:0; transform:translateY(20px)}
.jkResult.show{opacity:1; transform:translateY(0)}

/* å‹æ•—ãƒ»ãƒ«ãƒ¼ãƒ« */
#result,#rulesModal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;place-items:center;z-index:99;backdrop-filter:blur(5px)}
#result.show,#rulesModal.show{display:grid}
.box{background:#151b2e;border:1px solid #364a80;border-radius:20px;padding:30px;text-align:center;box-shadow:0 20px 50px #000}
.rulesDialog{width:min(600px,90vw);max-height:80vh;overflow-y:auto;background:#101626;border:1px solid #2a3d6b;border-radius:16px;padding:20px;position:relative;color:#eaf2ff}
.rulesClose{position:absolute;top:10px;right:10px;background:#1f2b4d;border:none;color:#fff;width:30px;height:30px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>

<div class="container" id="setup">
  <section class="card">
    <h2>ãƒãƒ¼ãƒ ç·¨æˆ <button class="btnTiny" id="btnRules">ãƒ«ãƒ¼ãƒ«</button></h2>
    <div class="body">
      <div id="teamGrid">
        <div><div class="statsHead" style="color:#4da6ff">ã‚ãªãŸ</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#ff5c6c">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px">
        <button id="btnRand" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button id="btnStart" class="primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°</h2>
    <div class="body">
      <div id="statsGrid">
        <div><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div class="container" id="battle" style="display:none">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>

    <section class="padCard" id="pad">
      <div class="padInner">
        <div class="rpsArea">
          <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
          <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
          <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
        </div>
        <div class="sideBtns">
          <button class="spToggle" id="btnSP" disabled>SP å¿…æ®ºæŠ€</button>
          <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
        </div>
      </div>
    </section>

    <div class="logContainer" id="battleLog"></div>
    <div class="timer" style="margin-top:-4px">TIME <span class="num" id="countNum">15</span></div>

    <div id="boxGrid">
      <div class="boxCol"><div class="statsHead">Ally</div><div id="sixA"></div></div>
      <div class="boxCol"><div class="statsHead">Enemy</div><div id="sixB"></div></div>
    </div>
  </div>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">âœŠ</div><div style="color:#fff;font-weight:900;font-size:24px">VS</div><div class="jkHand" id="jkHandB">âœŒï¸</div></div></div></div>

<div id="cutIn">
  <div class="cutInText" id="cutInName">SKILL NAME</div>
  <div class="cutInSub" id="cutInUser">User</div>
</div>

<div id="switchModal">
  <div class="card">
    <h2>äº¤ä»£ãƒ¡ãƒ³ãƒãƒ¼<button class="btnTiny" id="swCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></h2>
    <div class="body">
      <div id="switchGrid"></div>
      <button id="swDo" class="primary" style="width:100%;margin-top:10px" disabled>äº¤ä»£æ±ºå®š</button>
    </div>
  </div>
</div>

<div id="infoModal">
  <div class="card" style="width:min(400px,90vw)">
    <h2 id="infoTitle">è©³ç´° <button class="btnTiny" onclick="$('infoModal').style.display='none'">é–‰ã˜ã‚‹</button></h2>
    <div class="body" id="infoBody"></div>
  </div>
</div>

<div id="rulesModal">
  <div class="rulesDialog">
    <button class="rulesClose">Ã—</button>
    <h3 style="margin-top:0">ãƒ«ãƒ¼ãƒ«èª¬æ˜</h3>
    <ul style="padding-left:20px;line-height:1.6">
      <li>3ä½“ã®ã€Œè¨€è‘‰ã€ã§ãƒãƒ¼ãƒ ã‚’çµ„ã‚“ã§æˆ¦ã„ã¾ã™ã€‚</li>
      <li>ã˜ã‚ƒã‚“ã‘ã‚“ã«å‹ã¤ã¨æ”»æ’ƒã€è² ã‘ã‚‹ã¨é˜²å¾¡ã§ã™ã€‚</li>
      <li>ã‚¿ã‚¤ãƒ—ç›¸æ€§ï¼ˆæœ‰åˆ©1.5å€ã€ä¸åˆ©0.67å€ï¼‰ãŒé‡è¦ã§ã™ã€‚</li>
      <li>å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒ6æºœã¾ã‚‹ã¨ã€å¼·åŠ›ãªå¿…æ®ºæŠ€ãŒä½¿ãˆã¾ã™ã€‚</li>
      <li>ç›¸æ‰‹ãƒãƒ¼ãƒ ã‚’å…¨å“¡å€’ã›ã°å‹åˆ©ã§ã™ã€‚</li>
    </ul>
  </div>
</div>

<div id="result">
  <div class="box">
    <h1 id="resTitle" style="color:#fff;margin:0 0 10px">WIN</h1>
    <p>Returning to setup...</p>
  </div>
</div>

<script>
(()=>{
'use strict';
const $=id=>document.getElementById(id);
const qs=(s,el=document)=>el.querySelector(s);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

// ç”»åƒãƒãƒƒãƒ—
const IMG={"ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"parabola_antenna.png","ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"nescafe_ambassador.png","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"ninjin_shirishiri.png","ãã¼ã‚ã”ã¯ã‚“":"soboro_gohan.png","ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"western_lowland_gorilla.png","æ¯›ã‚€ãã˜ã‚ƒã‚‰":"kemukujara.png","ä¹å“ä»":"kuhonbutsu.png","ã‘ã‚“ã¡ã‚“æ±":"kenchin_jiru.png","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"kamchatka_peninsula.png","ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"tarantula.png","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"shoebill.png","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"balsamic_vinegar.png","ãƒ”ãƒ­ãƒªèŒ":"helicobacter_pylori.png","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"trinidad_and_tobago.png","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"caramel_color.png","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"babylonian_captivity.png","é³¥å–ç ‚ä¸˜":"tottori_sand_dunes.png","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"placebo_effect.png","æ¸¡æ¥äºº":"torai_jin.png","ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"peperoncino.png","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"polypropylene.png","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"sarajevo_incident.png","ã‚¯ãƒãƒ³ãƒãƒ":"kumabachi.png","çœŒåºæ‰€åœ¨åœ°":"prefectural_capital.png","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"teriyaki_chicken.png","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"nerunerunerune.png","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"surume_ika.png","æœ¬è³ª":"essence.png","è¦‹ãˆã‚‹åŒ–":"mieruka.png","è‡ªåˆ†ã”ã¨åŒ–":"jibungotoka.png","è§£åƒåº¦":"resolution.png","ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png"};
function preloadImgs(names){
  const unique=[...new Set(names.map(n=>IMG[n]).filter(Boolean))];
  unique.forEach(f=>{ const im=new Image(); im.src=`images/${f}`; });
}

// ãƒ­ã‚°ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ–ï¼‰
function log(msg, type='normal'){
  const c=$('battleLog');
  const d=document.createElement('div');
  let icon='';
  if(type==='atk') icon='âš”ï¸ ';
  else if(type==='dmg') icon='ğŸ’¥ ';
  else if(type==='heal') icon='ğŸ’– ';
  else if(type==='sp') icon='âœ¨ ';
  
  d.className='logLine '+type;
  d.textContent=icon + msg;
  c.appendChild(d); c.scrollTop=c.scrollHeight;
}

// æ¼”å‡ºï¼šãƒ€ãƒ¡ãƒ¼ã‚¸ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
function showFloatingText(targetId, text, type){
  const wrap = $(targetId); if(!wrap) return;
  const el = document.createElement('div');
  el.className = 'floatingText ' + type;
  el.textContent = text;
  wrap.appendChild(el);
  setTimeout(()=>el.remove(), 900);
}

// æ¼”å‡ºï¼šã‚«ãƒƒãƒˆã‚¤ãƒ³
async function showCutIn(skill, user){
  $('cutInName').textContent = skill;
  $('cutInUser').textContent = user;
  const el = $('cutIn');
  el.classList.add('show');
  await delay(1200);
  el.classList.remove('show');
  await delay(200);
}

// æ¼”å‡ºï¼šç”»é¢ã‚·ã‚§ã‚¤ã‚¯
function shakeScreen(){
  const a=$('arena');
  a.classList.remove('shake');
  void a.offsetWidth;
  a.classList.add('shake');
}

// å…¥åŠ›ãƒ­ãƒƒã‚¯ç®¡ç†
let inputLocked=false;
function lockInputs(on){
  inputLocked=on;
  const p=$('pad'); if(p) p.style.opacity=on?.6:1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id=>$(id).disabled=on);
  updateSPBtn(); 
}

// å¿…æ®ºãƒœã‚¿ãƒ³æ›´æ–°
function updateSPBtn(){
  const btn=$('btnSP'); if(!btn)return;
  const ready = state.A.sp >= 6;
  const canPress = !inputLocked && ready && !state.busy;
  
  btn.disabled = !canPress;
  
  if(state.spOn){
    btn.textContent='âœ¨ å¿…æ®º ON';
    btn.classList.add('on');
    btn.classList.remove('btnReady');
  } else {
    btn.textContent='SP å¿…æ®ºæŠ€';
    btn.classList.remove('on');
    if(ready && !inputLocked) btn.classList.add('btnReady');
    else btn.classList.remove('btnReady');
  }

  qs('#gA')?.classList.toggle('readyPulse', ready);
  
  if(ready && !state.spAnnA){
    log('å¿…æ®ºã‚²ãƒ¼ã‚¸MAXï¼ä½¿ç”¨å¯èƒ½', 'highlight');
    state.spAnnA=true;
  }
}

// ã˜ã‚ƒã‚“ã‘ã‚“æ¼”å‡º
async function playJankenAnim(myH, cpuH, res){
  const map={G:'âœŠ',C:'âœŒï¸',P:'ğŸ–'};
  const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  
  ov.classList.add('active');
  hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  
  await delay(50);
  hA.classList.add('show'); hB.classList.add('show');
  await delay(300);
  
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else { rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show');
  
  await delay(700);
  ov.classList.remove('active');
}

// ã‚²ãƒ¼ãƒ å®šæ•°ãƒ»ãƒ­ã‚¸ãƒƒã‚¯
const TYPES_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeColor = t => getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`)||'#7aa0ff';
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const st=[(i+1)%n,(i+2)%n],wk=[(i-1+n)%n,(i-2+n)%n];if(st.includes(j))return 1.5;if(wk.includes(j))return 0.67;return 1;};
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

const toKatakana = (s)=> (s||"").replace(/[ã-ã‚“]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
function calcStatus(name,yomi){
  const T=name.length;
  const H=(yomi.match(/[ã‚¡-ãƒ³]/g)||[]).length;
  const d=(yomi.match(/[ã‚¬-ãƒ]/g)||[]).length;
  let atkP=25 + (d*3) + (T*2);
  let defP=25 + (T*3);
  return {atkP, defP, T};
}
function makeWordObject([name,rank,type,yomiH]){
  const y=toKatakana(yomiH); const {atkP,defP,T}=calcStatus(name,y);
  const ATK=Math.round(PRANK[rank]*(atkP/100));
  const DEF=Math.round(PRANK[rank]*(defP/100));
  const HP=Math.round(HP_BASE[rank]+20*(T-5));
  const EVA=Math.min(30, 5 + T + (rank==='S'?5:0));
  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

// ãƒ‡ãƒ¼ã‚¿
const SKILLS={
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","å¨åŠ›2.2å€ã€‚ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
 "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","æ”»æ’ƒå¾Œã€å‘³æ–¹å…¨å“¡HP60å›å¾©ã€‚"],
 "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","å¨åŠ›1.6å€ã€‚æ¬¡ã«å—ã‘ã‚‹è‡´å‘½å‚·ã‚’HP1ã§è€ãˆã‚‹ã€‚"],
 "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›é€£ç¶šæ”»æ’ƒï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚"],
 "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","å¨åŠ›1.5å€ã€‚æ¬¡ã®2å›ã€è‡ªåˆ†ã®æ”»æ’ƒ1.3å€ã€‚"],
 "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","å¨åŠ›1.4å€ã€‚æ¬¡ã®2å›ã€å›é¿ç‡60%å›ºå®šã€‚"],
 "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","å¨åŠ›1.6å€ã€‚æ¬¡ã®2å›ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸åŠæ¸›ã€‚"],
 "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","å¨åŠ›1.2å€ã€‚è‡ªåˆ†HP150å›å¾©ã€‚"],
 "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
 "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
 "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
 "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
 "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};
const WORDS_BASE=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const makeW=i=>makeWordObject(WORDS_BASE[i]);
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false};

// UIæ›´æ–°
function barRow(label,val,max){const pct=Math.min(100,(val/max)*100);return `<div class="barLine"><div class="val" style="width:20px;text-align:left">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="val">${val}</div></div>`;}
function miniCard(idx){const w=makeW(idx);return `<div class="setupMini" data-type="${w.type}"><div class="head"><div>${w.name}</div><div style="color:${typeColor(w.type)}">${w.type}</div></div>${barRow('HP',w.maxhp,800)}${barRow('ATK',w.atk,120)}</div>`;}
function renderMini(side){const root=side==='A'?$('statsA'):$('statsB');root.innerHTML='';for(let i=0;i<3;i++){const idx=Number($(`${side}-${i}`).value)||0;root.innerHTML+=miniCard(idx);}}
function makeTeam(root,side){root.innerHTML='';for(let i=0;i<3;i++){const div=document.createElement('div');div.className='slot';const pill=document.createElement('span');pill.className='pill';pill.textContent='#'+(i+1);const sel=document.createElement('select');sel.id=`${side}-${i}`;WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;sel.append(o);});sel.addEventListener('change',()=>{renderMini(side);});div.append(pill,sel);root.append(div);}const picks=Array.from({length:3},()=>Math.floor(Math.random()*WORDS_BASE.length));picks.forEach((v,i)=>$(`${side}-${i}`).value=v);renderMini(side);}
const collect=side=>[0,1,2].map(i=>{const idx=Number($(`${side}-${i}`).value)||0;return {...makeW(idx),side};});

function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  state.busy=false; lockInputs(false); 
  state.timer=setInterval(()=>{if(state.busy)return; state.remain--; $('countNum').textContent=state.remain; if(state.remain<=0){pick(['G','C','P'][Math.floor(Math.random()*3)]);}},1000);
}
function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}

// ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆçŠ¶æ…‹ç•°å¸¸ãƒãƒƒã‚¸è¿½åŠ ï¼‰
function renderCard(u,role,opp){
  const sp=role==='ally'?state.A.sp:state.B.sp, tag=role==='ally'?'A':'B';
  const owner=role==='ally'?'YOU':'CPU';
  const img=IMG[u.name]?`<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none'">`:'<span style="font-size:40px">ğŸ“¦</span>';
  const skill=(SKILLS[u.name]||['â€”','â€”']);
  const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  
  // ãƒãƒƒã‚¸ç”Ÿæˆ
  let badges='';
  if(u.lock>0) badges+=`<div class="stBadge">ğŸ”’äº¤ä»£ä¸å¯</div>`;
  if(u.doom>0) badges+=`<div class="stBadge">ğŸ‘¾æ–‡å­—åŒ–ã‘</div>`;
  if(u.selfHurt>0) badges+=`<div class="stBadge">ğŸŒ€å´©å£Š</div>`;
  
  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}">
    <div class="unitInner">
      <div class="cardHeader">
        <span class="ownerBadge ${role}">${owner}</span>
        <span class="typeIcon">${u.type}</span>
      </div>
      <div class="cardName">${u.name}</div>
      <div class="artArea" id="art-${role}">${img}</div>
      
      <div class="statusRow">${badges}</div>
      <div class="statRow">
        <span>HP</span>
        <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
      </div>
      <div style="text-align:right;font-size:10px;margin-bottom:6px"><span id="hpnum-${role}" class="num">${u.hp}</span> / ${u.maxhp}</div>
      
      <div class="spRow">${pips}</div>
      
      <div class="skillInfo">
        <div class="skillN">å¿…æ®º: ${skill[0]}</div>
        <div class="skillD">${skill[1]}</div>
      </div>
      
      <div class="footer">
        <span>ATK ${u.atk} / DEF ${u.def}</span>
        <button class="btnStat" onclick="window._sh('${u.name}')">STATUS</button>
      </div>
    </div>
  </div>`;
}
function renderSides(){
  $('leftWrap').innerHTML=renderCard(state.A.team[state.A.i],'ally',state.B.team[state.B.i]);
  $('rightWrap').innerHTML=renderCard(state.B.team[state.B.i],'enemy',state.A.team[state.A.i]);
  updateSPBtn();
}
window._sh=(n)=>{const u=[...state.A.team,...state.B.team].find(x=>x.name===n); if(u){$('infoTitle').innerHTML=`${u.name}`; $('infoBody').innerHTML=renderCard(u,'info','info'); $('infoModal').style.display='grid';}};

async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true; clearInterval(state.timer);
  lockInputs(true);
  
  try{
    const cpu=['G','C','P'][Math.floor(Math.random()*3)];
    const res=judge(h,cpu);
    await playJankenAnim(h,cpu,res);
    
    // ãƒãƒˆãƒ«å‡¦ç†
    let ko=false;
    if(res>0) ko = await doTurn('ally');
    else if(res<0) ko = await doTurn('enemy');
    
    if(!ko){
      state.A.sp=Math.min(6,state.A.sp+1);
      state.B.sp=Math.min(6,state.B.sp+1);
      if(state.A.sp<6) state.spAnnA=false;
      renderSides();
      log(`æ¬¡ã®ã‚¿ãƒ¼ãƒ³`, 'normal');
      await delay(600);
      startRound();
    }
  }catch(e){
    console.error(e); startRound();
  }
}

async function doTurn(side){
  const att=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  const def=side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse = (side==='ally' && state.spOn && state.A.sp>=6) || (side==='enemy' && state.B.sp>=6);
  
  // å¿…æ®ºã‚«ãƒƒãƒˆã‚¤ãƒ³
  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; }
    else { state.B.sp=0; }
    
    const sName = (SKILLS[att.name]||['?'])[0];
    await showCutIn(sName, att.name);
    log(`ã€å¿…æ®ºã€‘${att.name}ã®ã€${sName}ã€ç™ºå‹•ï¼`, 'sp');
  } else {
    log(`${att.name}ã®æ”»æ’ƒï¼`, 'atk');
  }
  
  await delay(400);
  
  // ç°¡æ˜“ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
  let mult=typeMult(att.type,def.type);
  if(spUse) mult *= 1.5; 
  let dmg = Math.floor( 40 * (att.atk/def.def) * mult * (Math.random()*0.4+0.8) );
  if(spUse) dmg = Math.floor(dmg*1.5);
  
  // çŠ¶æ…‹ç•°å¸¸ãªã©ã®ç°¡æ˜“å‡¦ç†(ä»Šå›ã¯æ¼”å‡ºãƒ¡ã‚¤ãƒ³)
  def.hp = Math.max(0, def.hp-dmg);
  
  // ãƒ’ãƒƒãƒˆæ¼”å‡º
  qs(side==='ally'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit');
  shakeScreen();
  showFloatingText(side==='ally'?'rightWrap':'leftWrap', `-${dmg}`, 'dmg');
  renderSides();
  
  log(`${def.name}ã« ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸`, 'dmg');
  await delay(800);
  qs('.unit.hit')?.classList.remove('hit');

  if(def.hp<=0){
    log(`${def.name}ã¯å€’ã‚ŒãŸï¼`, 'highlight');
    return await handleKO(side==='ally'?'enemy':'ally');
  }
  return false;
}

async function handleKO(side){
  const team = side==='ally' ? state.A.team : state.B.team;
  const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);
  
  if(survivors.length===0){
    $('resTitle').textContent = side==='enemy' ? 'YOU WIN!' : 'YOU LOSE...';
    $('result').classList.add('show');
    await delay(3000);
    $('result').classList.remove('show');
    $('battle').style.display='none'; $('setup').style.display='grid';
    return true; 
  }
  
  if(side==='enemy'){
    state.B.i = survivors[0].i;
    state.B.sp=0;
    log(`ç›¸æ‰‹ã¯ ${team[state.B.i].name} ã‚’ç¹°ã‚Šå‡ºã—ãŸ`, 'highlight');
  } else {
    state.A.i = survivors[0].i;
    state.A.sp=0; state.spOn=false;
    log(`${team[state.A.i].name} ã«äº¤ä»£ã—ãŸ`, 'highlight');
  }
  renderSides();
  await delay(1000);
  startRound();
  return true; 
}

// èµ·å‹•å‡¦ç†
document.addEventListener('DOMContentLoaded',()=>{
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
  $('btnStart').onclick=async()=>{
    state.A.team=collect('A'); state.B.team=collect('B');
    state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0;
    state.spOn=false; state.spAnnA=false;
    $('battleLog').innerHTML='';
    $('setup').style.display='none'; $('battle').style.display='block';
    
    await preloadImgs([...state.A.team, ...state.B.team].map(u=>u.name));
    renderSides();
    log('ãƒãƒˆãƒ«é–‹å§‹ï¼', 'highlight');
    await delay(800);
    startRound();
  };
  $('btnG').onclick=()=>pick('G');
  $('btnC').onclick=()=>pick('C');
  $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{
    if(!inputLocked && state.A.sp>=6){
      state.spOn = !state.spOn;
      updateSPBtn();
    }
  };
  
  // ãƒ«ãƒ¼ãƒ«
  $('btnRules').onclick=()=>$('rulesModal').classList.add('show');
  qs('.rulesClose').onclick=()=>$('rulesModal').classList.remove('show');
  $('btnRand').onclick=()=>{makeTeam($('teamA'),'A');makeTeam($('teamB'),'B');};
});

})();
</script>
</body>
</html>
