<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | å¯¾æˆ¦ v7.10</title>
<style>
:root{
  /* ãƒ™ãƒ¼ã‚¹è‰² */
  --bg:#0b1227;--panel:#0f1633;--border:#1d2440;--muted:#96a7d6;--text:#eaf2ff;
  --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
  --hp:#6bff8b;--hpBack:#0f2a19;--gauge:#ffe066;--gaugeBack:#2a230c;
  --shadow:0 16px 40px rgba(0,0,0,.28);

  /* ã‚¿ã‚¤ãƒ—ã”ã¨ã®ãƒãƒƒãƒ—é…è‰²ï¼ˆã‚«ãƒ¼ãƒ‰ç¸å–ã‚Šï¼‹è–„ã„èƒŒæ™¯ã‚°ãƒ©ãƒ‡ï¼‰ */
  --t-ã‚¸ã‚ª:#7aa0ff;        --tbg-ã‚¸ã‚ª:linear-gradient(180deg,#0f1730,#101f46);
  --t-ã‚¢ãƒ‹ãƒãƒ«:#6bffa6;    --tbg-ã‚¢ãƒ‹ãƒãƒ«:linear-gradient(180deg,#0f1c30,#132c4f);
  --t-ãƒ•ãƒ¼ãƒ‰:#ffd36b;      --tbg-ãƒ•ãƒ¼ãƒ‰:linear-gradient(180deg,#0f1a26,#1f2c46);
  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#c69bff;  --tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:linear-gradient(180deg,#12182e,#1b2544);
  --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#66e2ff;  --tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:linear-gradient(180deg,#0e1d2f,#0e2c48);
  --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff9bb2; --tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:linear-gradient(180deg,#12172a,#1b2142);
  --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#9bffea;  --tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:linear-gradient(180deg,#121a28,#1e2941);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP",sans-serif;overflow-x:hidden}

/* å…±é€šã‚«ãƒ¼ãƒ‰ */
.container{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
.card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
.card .body{padding:14px}

/* ç·¨æˆ */
#setup{display:grid;gap:12px}
#teamGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.slot{display:flex;gap:8px;align-items:center}
.pill{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:#0a1430;border:1px solid #2b3a70;color:#cfe2ff;font-weight:800}
.slot select{flex:1;background:#0b1430;border:1px solid #25366b;color:#eaf2ff;padding:10px;border-radius:12px;min-width:0}

.statsHead{font-weight:900;margin:2px 0 6px 2px}
#statsGrid{display:grid;gap:12px}
@media(min-width:720px){ #statsGrid{grid-template-columns:1fr 1fr} }
.statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}
.setupMini{border:1px solid #1a2b54;border-radius:12px;padding:10px}
.setupMini .head{display:flex;justify-content:space-between;font-weight:800}
.barLine{display:flex;align-items:center;gap:8px;margin-top:6px}
.barBox{flex:1;height:14px;background:#0e1b31;border:1px solid #2a3a6b;border-radius:7px;overflow:hidden}
.barFill{height:100%;background:var(--hp);width:0%}
.val{font-size:12px;color:#cfe2ff;width:86px;text-align:right}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.ghost{background:transparent;border:1px dashed #2b3a70;color:#cfe2ff;padding:10px 12px;border-radius:10px}
.primary{background:linear-gradient(90deg,var(--ally),var(--ally2));color:#05203a;border:none;padding:10px 14px;border-radius:12px;font-weight:900}

/* ãƒãƒˆãƒ«åˆ‡æ›¿ */
.inSetup{display:block}
.inBattle{display:none}
.battleMode .inSetup{display:none}
.battleMode .inBattle{display:block}

/* ãƒãƒˆãƒ« */
.arena{min-height:100vh;display:grid;grid-template-rows:auto 1fr auto auto;gap:12px}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆã‚¿ã‚¤ãƒ—ã”ã¨ã«ãƒãƒƒãƒ—ãªç¸å–ã‚Šï¼†èƒŒæ™¯ï¼‰ */
.unit{border:1px solid #22325c;border-radius:14px;padding:12px;position:relative;min-height:196px;box-shadow:0 0 0 3px rgba(255,255,255,.03) inset}
.unit[data-type]{background:var(--tbg-default)}
.unit[data-type="ã‚¸ã‚ª"]{background:var(--tbg-ã‚¸ã‚ª); box-shadow:0 0 0 2px var(--t-ã‚¸ã‚ª) inset, 0 0 18px rgba(122,160,255,.25)}
.unit[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{background:var(--tbg-ã‚¢ãƒ‹ãƒãƒ«); box-shadow:0 0 0 2px var(--t-ã‚¢ãƒ‹ãƒãƒ«) inset,0 0 18px rgba(107,255,166,.22)}
.unit[data-type="ãƒ•ãƒ¼ãƒ‰"]{background:var(--tbg-ãƒ•ãƒ¼ãƒ‰); box-shadow:0 0 0 2px var(--t-ãƒ•ãƒ¼ãƒ‰) inset,0 0 18px rgba(255,211,107,.22)}
.unit[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{background:var(--tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ); box-shadow:0 0 0 2px var(--t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ) inset,0 0 18px rgba(198,155,255,.22)}
.unit[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{background:var(--tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹); box-shadow:0 0 0 2px var(--t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹) inset,0 0 18px rgba(102,226,255,.25)}
.unit[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{background:var(--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼); box-shadow:0 0 0 2px var(--t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼) inset,0 0 18px rgba(255,155,178,.22)}
.unit[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{background:var(--tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³); box-shadow:0 0 0 2px var(--t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³) inset,0 0 18px rgba(155,255,234,.22)}
.unit.ally{outline:2px solid var(--ally)}
.unit.enemy{outline:2px solid var(--enemy)}

.nameRow{display:flex;justify-content:space-between;align-items:center}
.badge{font-size:12px;background:#0d1630;border:1px solid #2b3a70;padding:2px 6px;border-radius:999px}
.meta{font-size:12px;color:#cfe2ff;margin-top:6px}

/* HPãƒãƒ¼ï¼ˆå¹…é•·ã‚ãƒ»å¤ªã‚ï¼‰ */
.hpRow{display:flex;align-items:center;gap:10px;margin-top:8px}
.hpBox{flex:1;height:22px;background:var(--hpBack);border-radius:11px;overflow:hidden;position:relative}
.hpFill{height:100%;background:var(--hp);width:0%;transition:width .55s ease}
.hpNum{font-size:13px;width:180px;text-align:right}

/* ã‚²ãƒ¼ã‚¸ */
.gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
.gLabel{font-size:12px;color:#ffeaa7}
.gauge{display:flex;gap:4px}
.pip{width:16px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
.pip.on{background:var(--gauge);opacity:1}
.readyPulse{animation:pulse 1.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.55)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
.btnReady{animation:pulse 1.2s infinite}

/* æŠ€ã¨ç›¸æ€§ */
.skillWrap{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
.skillBox{border:1px solid #2c3a69;border-radius:12px;background:#0c1633;padding:10px}
.skillTitle{font-weight:900;display:flex;align-items:center;gap:6px}
.skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}
.affinityBox{border:1px solid #2c3a69;border-radius:12px;background:#0b1530;padding:8px;font-size:12px}

/* ç›¸å¯¾ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.statBars{margin-top:8px}
.statBars .barLine .val{width:86px}

/* ãƒ‘ãƒƒãƒ‰ */
.pad{border:1px solid #22335f;border-radius:14px;background:linear-gradient(180deg,#0d1530,#0b1428);padding:10px}
.padInner{position:relative;width:min(520px,92vw);height:210px;margin:0 auto}
.rps{position:absolute;display:grid;place-items:center;width:92px;height:92px;border-radius:999px;border:none;color:#061225}
.rps .emo{font-size:34px}.rps .lbl{font-size:12px;margin-top:2px;font-weight:800}
.rps.g{left:8%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
.rps.c{right:8%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
.rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)}
.switchBtn{position:absolute;right:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
.spToggle{position:absolute;left:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
.spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
.spToggle:disabled{opacity:.5;filter:grayscale(.4)}

/* å…­æšã¾ã¨ã‚ */
#sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mini{border:1px solid #1a2b54;border-radius:12px;padding:8px}
.mini .head{display:flex;justify-content:space-between}
.mini .miniBar{height:10px;background:#11321f;border-radius:6px;overflow:hidden;margin-top:6px}
.mini .miniBar>span{display:block;height:100%;background:var(--hp);width:0%}

/* ã‚¿ã‚¤ãƒãƒ¼ & ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆä¸‹æ®µã«å›ºå®šã€‚å…ƒã€Œæ§ãˆãƒãƒƒãƒ—ã€ã®é ˜åŸŸã‚’ä½¿ç”¨ï¼‰ */
.timer{display:flex;justify-content:center;gap:8px;align-items:center;font-weight:900}
.timer .num{font-size:28px}
.toast{position:fixed;left:50%;bottom:16vh;transform:translateX(-50%) translateY(12px);padding:12px 16px;border-radius:14px;background:rgba(12,22,50,.96);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50;max-width:min(92vw,720px);line-height:1.7}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}

/* æ”»æ’ƒFX */
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
.shake{animation:shake .5s ease}
.fx-burst{box-shadow:0 0 0 3px rgba(255,224,102,.7),0 0 22px 6px rgba(255,224,102,.25);transition:.2s}

/* ãƒ¢ãƒã‚¤ãƒ« */
@media(max-width:600px){
  .container{padding:8px}
  .arena{grid-template-rows:auto auto auto auto}
  .padInner{width:96vw;height:180px}
  .rps{width:78px;height:78px}.rps .emo{font-size:30px}
  .switchBtn,.spToggle{width:118px;height:52px}
  #teamGrid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="container inSetup" id="setup">
  <section class="card">
    <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
    <div class="body">
      <div id="teamGrid">
        <div>
          <div style="font-weight:900;color:#69d3ff;margin-bottom:6px">ã‚ãªãŸ</div>
          <div id="teamA"></div>
        </div>
        <div>
          <div style="font-weight:900;color:#ff9aa5;margin-bottom:6px">CPU</div>
          <div id="teamB"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnRand" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
        <button id="btnStart" class="primary" style="margin-left:auto">å¯¾æˆ¦é–‹å§‹</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div class="body">
      <div id="statsGrid">
        <div>
          <div class="statsHead" style="color:#69d3ff">ã‚ãªãŸ</div>
          <div class="statsCol" id="statsA"></div>
        </div>
        <div>
          <div class="statsHead" style="color:#ff9aa5">CPU</div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ãƒãƒˆãƒ«ç”»é¢ -->
<div id="battle" class="container inBattle">
  <section class="card">
    <div class="body">
      <div class="arena">
        <div class="vsrow">
          <div id="leftWrap"></div>
          <div id="rightWrap"></div>
        </div>

        <div class="pad">
          <div class="padInner">
            <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
            <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
            <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
            <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
            <button class="spToggle" id="btnSP" disabled>âœ¨ å¿…æ®º OFF</button>
          </div>
        </div>

        <div class="timer">é¸æŠã¾ã§ <span class="num" id="countNum">15</span> ç§’</div>
        <div id="sixStats"></div>
        <div class="toast" id="toast">READY</div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div id="summary" class="note">ãƒãƒˆãƒ«æº–å‚™ä¸­</div>
        <button id="btnBack" class="ghost">ç·¨æˆã«æˆ»ã‚‹</button>
      </div>
    </div>
  </section>
</div>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="switchModal" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:30">
  <div class="card" style="min-width:min(92vw,520px)">
    <h2>äº¤ä»£å…ˆã‚’é¸æŠ</h2>
    <div class="body">
      <div class="modalGrid" id="switchGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div id="swTimer" class="note">è‡ªå‹•äº¤ä»£ã¾ã§ 15 ç§’</div>
        <div>
          <button id="swCancel" class="ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="swDo" class="primary" disabled>äº¤ä»£ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
"use strict";

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $=id=>document.getElementById(id);
const delay=ms=>new Promise(r=>setTimeout(r,ms));
const MAX={HP:800,ATK:120,DEF:120,EVA:20};
const TYPES_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const strong=[(i+1)%n,(i+2)%n],weak=[(i-1+n)%n,(i-2+n)%n];if(strong.includes(j))return 1.5;if(weak.includes(j))return 0.67;return 1;};
const toast=(msg)=>{ const t=$('toast'); const base=1500, per=60; t.textContent=msg; t.classList.add('show'); clearTimeout(t._h); const stay = Math.min(8000, base + Math.max(0,msg.length)*per); t._h=setTimeout(()=>t.classList.remove('show'),stay); };

/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const PRANK = {S:170, A:165, B:160, C:150, D:145, X:150};
const HP_BASE = {S:560, A:540, B:520, C:500, D:480, X:500};

const SKILLS={
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","æ”»æ’ƒ2.5å€ï¼‹ç›¸æ‰‹ã®ã‚²ãƒ¼ã‚¸0ã€‚"],
 "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","é€šå¸¸æ”»æ’ƒï¼‹å‘³æ–¹å…¨å“¡HP60å›å¾©ï¼ˆè‡ªåˆ†ã‚‚60ï¼‰ã€‚"],
 "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","æ”»æ’ƒ1.6å€ï¼‹è‡´æ­»ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’1å›ã ã‘HP1ã§è€ãˆã‚‹ã€‚"],
 "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›æ”»æ’ƒï¼ˆ0.75â†’0.5â†’0.25ï¼‰ã€‚é€”ä¸­KOã§ã‚‚æ¬¡ã«ç¶šãã€‚"],
 "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","åˆå›1.5å€ã€‚ä»¥å¾Œ2Tã¯1.3å€ã€‚"],
 "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","æ”»æ’ƒ1.4å€ï¼‹å›é¿60%Ã—3Tã€‚"],
 "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","æ”»æ’ƒ1.6å€ï¼‹è¢«ãƒ€ãƒ¡åŠæ¸›Ã—3Tã€‚"],
 "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","æ”»æ’ƒ1.2å€ï¼‹HP150å›å¾©ã€‚"],
 /* Bã€œD å‰²å½“ï¼ˆå¹³æº–åŒ–æ¸ˆï¼‰ */
 "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","1T è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","1T è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"], /* ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«å¤‰æ›´æ¸ˆã¿ */
 "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","3Tå¾Œã«æˆ¦é—˜ä¸èƒ½ï¼ˆäº¤ä»£ã§è§£é™¤ï¼‰ã€‚"],
 "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","1T è¡Œå‹•ä¸èƒ½ã€‚"],
 "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","1T è¡Œå‹•ä¸èƒ½ã€‚"],
 "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","3Tå¾Œã«æˆ¦é—˜ä¸èƒ½ï¼ˆäº¤ä»£ã§è§£é™¤ï¼‰ã€‚"],
 "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","4T äº¤ä»£ä¸å¯ã€‚"],
 "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","4Tã€æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚"],
 "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ã®èª°ã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®èª°ã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®èª°ã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ã®èª°ã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};

/* ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ [åå‰, ãƒ©ãƒ³ã‚¯, ã‚¿ã‚¤ãƒ—, ã‚ˆã¿(ã²ã‚‰ãŒãª)] */
const WORDS_BASE = [
  ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],
  ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
  ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],
  ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
  ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],
  ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
  ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],
  ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
  ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],
  ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
  ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],
  ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
  ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],
  ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
  ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],
  ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
  ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],
  ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
  ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],
  ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
  ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],
  ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
  ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],
  ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
  ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],
  ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
  ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],
  ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
  ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],
  ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
  ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],
  ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]
];

/* ===== ã‚¹ãƒ†ç®—å‡º ===== */
const reKanaH=/[ã-ã‚Ÿ]/g, reKanaK=/[ã‚ -ãƒ¿ãƒ¼]/g, reKanji=/[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g;
const reSmallK=/[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°ã‡±ã‡²ã‡³ã‡´ã‡µã‡¶ã‡·ã‡¸ã‡¹ã‡·ã‚šã‡ºã‡»ã‡¼ã‡½ã‡¾ã‡¿]/g;
const reSokuon=/ãƒƒ/g;
const reVoiced=/[ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ´ãƒ‘ãƒ”ãƒ—ãƒšãƒ]/g;
const PLosiveEnd = /[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
const visualLen = s => (s||"").replace(/[ãƒ»\s]/g,"").length;
const toKatakana = s => (s||"").replace(/[ã-ã‚“]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));

function countClass(s){const H=(s.match(reKanaH)||[]).length; const K=(s.match(reKanaK)||[]).length; const J=(s.match(reKanji)||[]).length; const total=H+K+J; return {H,K,J,total};}
function calcAttackDefense(name,yomiKata){
  let atkP=17.5, defP=17.5;
  const cls=countClass(name);
  if(cls.J+cls.K===0){ atkP+=12.5; defP+=12.5; }
  else{ const r_kata=cls.K/(cls.J+cls.K); atkP+=25*r_kata; defP+=25*(1-r_kata); }
  const Tph=yomiKata.length||1;
  const d=(yomiKata.match(reVoiced)||[]).length/Tph;
  const s=(yomiKata.match(reSokuon)||[]).length/Tph;
  const m=(yomiKata.match(reSmallK)||[]).length/Tph;
  const e=PLosiveEnd.test(yomiKata)?1:0;
  const s_raw=0.6*d+0.25*(s+m)+0.15*e;
  const L=0.05,U=0.45;
  const s_ph=Math.max(-1,Math.min(1, ((s_raw-L)/(U-L))*2-1 ));
  const atk_ph=20*(0.5+0.5*s_ph); const def_ph=20-atk_ph; atkP+=atk_ph; defP+=def_ph;
  const T=visualLen(name);
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len=20*(0.5+0.5*s_len); const def_len=20-atk_len;
  atkP+=atk_len; defP+=def_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
  const cls=countClass(name); const Hratio=cls.total?(cls.H/cls.total):0;
  const rankAdj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;
  let eva=10+8*Hratio-0.5*(T-5)+rankAdj; eva=Math.round(eva*10)/10; return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiHira]){
  const yomi=toKatakana(yomiHira||name);
  const {atkP,defP,T}=calcAttackDefense(name,yomi);
  const ATK=Math.round(PRANK[rank]*(atkP/100));
  const DEF=Math.round(PRANK[rank]*(defP/100));
  const HP=HP_BASE[rank]+20*(T-5);
  const EVA=calcEvasion(name,T,rank);
  const [skill,skillDesc]=SKILLS[name]||["â€”","â€”"];
  return {name,rank,type,yomi,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,skill,skillDesc};
}
function getWord(i){ return makeWordObject(WORDS_BASE[i]); }

/* ===== çŠ¶æ…‹ ===== */
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false,spAnnB:false};

/* ===== UI: ç·¨æˆ ===== */
function barRow(label,val,max,id){ const pct=Math.max(0,Math.min(100, Math.round((val/max)*100))); return `<div class="barLine"><div style="width:76px;font-size:12px;color:#cfe2ff">${label}</div><div class="barBox"><div class="barFill" ${id?`id="${id}"`:''} style="width:${pct}%"></div></div><div class="val">${label==='å›é¿'?val+'%':val}</div></div>`; }
function miniCard(idx){ const w=getWord(idx); return `<div class="setupMini" data-type="${w.type}" style="background:var(--tbg-${w.type})"><div class="head"><div>${w.name}</div><div class="badge">${w.type}</div></div>${barRow('HP',w.maxhp,MAX.HP)}${barRow('æ”»æ’ƒ',w.atk,MAX.ATK)}${barRow('é˜²å¾¡',w.def,MAX.DEF)}${barRow('å›é¿',w.eva,MAX.EVA)}</div>`; }
function renderMini(side){ const root= side==='A' ? $('statsA') : $('statsB'); root.innerHTML=''; for(let i=0;i<3;i++){ const idx=Number($(`${side}-${i}`).value)||0; root.innerHTML += miniCard(idx); } }
function makeTeam(root,side){
  root.innerHTML='';
  for(let i=0;i<3;i++){
    const div=document.createElement('div'); div.className='slot';
    const pill=document.createElement('span'); pill.className='pill'; pill.textContent='#'+(i+1);
    const sel=document.createElement('select'); sel.id=`${side}-${i}`;
    WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`; sel.append(o);});
    sel.addEventListener('change',()=>{ enforceUnique(side); renderMini(side); });
    div.append(pill,sel); root.append(div);
  }
  // åˆæœŸãƒ©ãƒ³ãƒ€ãƒ ï¼ˆé‡è¤‡ãªã—ï¼‰
  const picks=uniqueRandom(3,WORDS_BASE.length);
  picks.forEach((v,i)=>$(`${side}-${i}`).value=v);
  enforceUnique(side); renderMini(side);
}
function uniqueRandom(n,limit){ const used=new Set(),arr=[]; while(arr.length<n){const i=Math.floor(Math.random()*limit); if(!used.has(i)){used.add(i);arr.push(i);} } return arr; }
function enforceUnique(side){
  const selected=[0,1,2].map(i=>Number($(`${side}-${i}`).value));
  for(let i=0;i<3;i++){
    const sel=$(`${side}-${i}`); [...sel.options].forEach(opt=>{
      const v=Number(opt.value); const dup=selected.includes(v) && v!==Number(sel.value);
      opt.disabled=dup;
    });
  }
}
function collect(side){ const arr=[]; for(let i=0;i<3;i++){ const idx=Number($(`${side}-${i}`).value)||0; arr.push( pack(getWord(idx), side) ); } return arr; }
function pack(w,side){ return {...w, side}; }

/* ===== UI: ãƒãƒˆãƒ« ===== */
function gaugeHtml(sp,sideTag){ const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join(''); const pulse=sp>=6?'readyPulse':''; return `<div class="gaugeWrap"><div class="gLabel">å¿…æ®ºã‚²ãƒ¼ã‚¸</div><div class="gauge ${pulse}" id="g${sideTag}">${pips}</div></div>`; }
function statBarsHtml(u,role){ const id = role==='ally'?'statHP-ally':'statHP-enemy'; return `<div class="statBars" id="stat-${role}">${barRow('HP',u.hp,MAX.HP,id)}${barRow('æ”»æ’ƒ',u.atk,MAX.ATK)}${barRow('é˜²å¾¡',u.def,MAX.DEF)}${barRow('å›é¿',u.eva,MAX.EVA)}</div>`; }
function cardHtml(u,role,opp){
  const aff = typeMult(u.type,opp.type);
  const affText = aff===1.5?'ç›¸æ€§ x1.5ï¼ˆæŠœç¾¤ï¼‰': aff===0.67?'ç›¸æ€§ x0.67ï¼ˆã„ã¾ã„ã¡ï¼‰':'ç›¸æ€§ x1.0ï¼ˆç­‰å€ï¼‰';
  const sp = role==='ally'?state.A.sp:state.B.sp; const sideTag = role==='ally'?'A':'B';
  return `<div class="unit ${role}" data-type="${u.type}">
    <div class="nameRow"><div style="font-weight:900">${u.name}</div><div class="badge">${u.type}</div></div>
    <div class="hpRow"><div class="hpBox"><div class="hpFill" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div><div class="hpNum" id="hpnum-${role}">HP ${u.hp}/${u.maxhp}</div></div>
    ${gaugeHtml(sp,sideTag)}
    <div class="skillWrap">
      <div class="skillBox"><div class="skillTitle">âœ¨ å¿…æ®ºï¼š${u.skill}</div><div class="skillDesc">${u.skillDesc}</div></div>
      <div class="affinityBox">${affText}</div>
    </div>
    ${statBarsHtml(u,role)}
  </div>`;
}
function attachPop(role,u){ const el=$('card-'+role); if(el){ el.onclick=()=>toast(`${u.name} åŸºç¤å€¤ï½œHP:${u.maxhp} / æ”»æ’ƒ:${u.atk} / é˜²å¾¡:${u.def} / å›é¿:${u.eva}%`);} }

function renderSides(){
  $('leftWrap').innerHTML = `<div id="card-ally">${cardHtml(left(),'ally',right())}</div>`;
  $('rightWrap').innerHTML = `<div id="card-enemy">${cardHtml(right(),'enemy',left())}</div>`;
  attachPop('ally',left()); attachPop('enemy',right());
  updateSPBtn();
}
function updateSPBtn(){
  const readyA = state.A.sp>=6, readyB=state.B.sp>=6;
  const btn=$('btnSP');
  if(btn){
    btn.disabled=!readyA;
    btn.classList.toggle('on',state.spOn);
    btn.textContent = state.spOn ? 'âœ¨ å¿…æ®º ON' : 'âœ¨ å¿…æ®º OFF';
    btn.classList.toggle('btnReady',readyA&&!state.spOn);
  }
  $('gA')?.classList.toggle('readyPulse',readyA);
  if(readyA && !state.spAnnA){ toast('ã‚ãªãŸã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼'); state.spAnnA=true; }
  if(readyB && !state.spAnnB){ toast('ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼'); state.spAnnB=true; }
}

/* å…­æšã¾ã¨ã‚ */
function buildSix(){
  const root=$('sixStats'); root.innerHTML='';
  const mk=(u)=>`<div class="mini" data-type="${u.type}" style="background:var(--tbg-${u.type})">
    <div class="head"><div>${u.name}</div><div class="badge">${u.type}</div></div>
    <div class="miniBar"><span style="width:${100*u.hp/u.maxhp}%"></span></div>
    <div class="meta">HP ${u.hp}/${u.maxhp}</div>
  </div>`;
  root.innerHTML += mk(left()) + mk(right());
  state.A.team.forEach((u,i)=> i!==state.A.i && (root.innerHTML += mk(u)));
  state.B.team.forEach((u,i)=> i!==state.B.i && (root.innerHTML += mk(u)));
}

/* ã‚¿ãƒ¼ãƒ³ã‚¿ã‚¤ãƒãƒ¼ */
function startRound(){
  state.remain=15; $('countNum').textContent=state.remain;
  clearInterval(state.timer);
  state.timer=setInterval(()=>{
    state.remain--; $('countNum').textContent=state.remain;
    if(state.remain<=0){
      const r=['G','C','P'][Math.floor(Math.random()*3)];
      pick(r);
    }
  },1000);
}

/* ã˜ã‚ƒã‚“ã‘ã‚“ */
function judge(a,b){ if(a===b) return 0; if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G')) return 1; return -1; }

async function pick(h){
  if(state.busy) return; state.busy=true; clearInterval(state.timer);
  const cpuH=['G','C','P'][Math.floor(Math.random()*3)];
  const map={G:'ã‚°ãƒ¼',C:'ãƒãƒ§ã‚­',P:'ãƒ‘ãƒ¼'};
  const res=judge(h,cpuH);
  toast(`ã‚ãªãŸã¯ ${map[h]}ã€‚ç›¸æ‰‹ã¯ ${map[cpuH]}ã€‚${res>0?'ã‚ãªãŸã®å‹ã¡':res<0?'ã‚ãªãŸã®è² ã‘':'ã‚ã„ã“'}ã€‚`);

  const prevA=state.A.sp, prevB=state.B.sp;
  state.A.sp=Math.min(6,state.A.sp+1);
  state.B.sp=Math.min(6,state.B.sp+1);
  if(state.A.sp>=6 && prevA<6){ state.spAnnA=false; }
  if(state.B.sp>=6 && prevB<6){ state.spAnnB=false; }
  updateSPBtn();

  if(res>0){
    await doAttack(left(),right(), state.spOn && state.A.sp>=6, 'ally');
    if(state.spOn && state.A.sp>=6){state.A.sp=0; state.spOn=false; state.spAnnA=false;}
  } else if(res<0){
    await doAttack(right(),left(), state.B.sp>=6, 'enemy');
    if(state.B.sp>=6){state.B.sp=0; state.spAnnB=false;}
  }
  updateSPBtn(); renderSides(); buildSix();
  state.busy=false; startRound();
}

/* æ”»æ’ƒãƒ»å¿…æ®º */
function rand() { return Math.random(); }
function baseDamage(att,def){ return 100*(1+att.atk/100)/(1+def.def/120)*typeMult(att.type,def.type); }

async function doAttack(att,def,useSP,role){
  if(att.hp<=0) return;

  // å¿…æ®ºæ¼”å‡ºï¼†èª¬æ˜ï¼ˆæŠ€åâ†’åŠ¹æœï¼‰
  if(useSP){
    const el = role==='ally' ? $('card-ally') : $('card-enemy');
    el?.classList.add('fx-burst'); setTimeout(()=>el?.classList.remove('fx-burst'),280);
    toast(`${att.name}ã®å¿…æ®ºã€ã€Œ${att.skill}ã€ï¼`);
    await delay(900);
    // Xã¯ã‚³ãƒ”ãƒ¼å…ƒã‚’å‘ŠçŸ¥
    if(att.rank==='X'){
      const enemies = state.B.team.filter(x=>x.hp>0 && x.rank!=='X');
      if(enemies.length){
        const picked = enemies[Math.floor(Math.random()*enemies.length)];
        const [sName,sDesc] = SKILLS[picked.name]||["â€”","â€”"];
        toast(`${picked.name}ã®å¿…æ®ºã€${sName}ã€ã‚’ã‚³ãƒ”ãƒ¼ï¼`);
        await delay(900);
        toast(sDesc);
        await delay(900);
      }
    } else {
      toast(att.skillDesc);
      await delay(900);
    }
  }

  // å‘½ä¸­ï¼ˆå¿…æ®ºã¯å¿…ä¸­ï¼‰
  let miss = (!useSP && rand() < (def.eva/100));
  let dmg = 0;
  if(!miss){
    let base = baseDamage(att,def);
    if(useSP) base *= 2.0; /* å¿…æ®ºãƒ‡ãƒ•ã‚©å€ç‡ï¼ˆå€‹åˆ¥åŠ¹æœã¯èª¬æ˜ã ã‘ã§ã€ã“ã“ã¯å…¨ä½“è£œæ­£ï¼‰ */
    // ãã¼ã‚3é€£ã¯å€‹åˆ¥å‡¦ç†
    if(useSP && att.name==="ãã¼ã‚ã”ã¯ã‚“"){
      const seq=[0.75,0.5,0.25]; let total=0;
      for(const s of seq){ total += Math.max(1, Math.round(base*s)); }
      dmg = total;
    }else{
      dmg = Math.max(1, Math.round(base)); // 0ãƒ€ãƒ¡é˜²æ­¢ã®ä¸‹é™
    }
  }

  // è¢«å¼¾FX â†’ ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ â†’ æ¸›å°‘
  const vr = role==='ally'?'enemy':'ally';
  $('card-'+vr)?.classList.add('shake'); setTimeout(()=>$('card-'+vr)?.classList.remove('shake'),500);
  await delay(420);
  toast(`${att.name}ã®${useSP?'å¿…æ®ºï¼':'æ”»æ’ƒï¼'} ${miss?0:dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);

  if(!miss){
    def.hp=Math.max(0,def.hp-dmg);
    updateHpBars(vr,def);
    if(def.hp<=0){
      await delay(400);
      toast(`${def.name}ã¯å€’ã‚ŒãŸï¼`);
      await delay(600);
      await handleKO(vr);
    }
  }
}

function updateHpBars(role,unit){
  const bar=$('hp-'+role), num=$('hpnum-'+role), statHP=$('statHP-'+role);
  const pct = 100*unit.hp/unit.maxhp;
  if(bar){ bar.style.width=`${pct}%`; }
  if(num){ num.textContent=`HP ${unit.hp}/${unit.maxhp}`; }
  if(statHP){ statHP.style.width=`${Math.max(0,Math.min(100,Math.round(unit.hp/MAX.HP*100)))}%`; }
}

/* KOå‡¦ç†ï¼ˆäººé–“ã¯é¸ã°ãªã‘ã‚Œã°è‡ªå‹•äº¤ä»£ï¼‰ */
async function handleKO(side){
  if(side==='ally'){
    const can=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
    if(can.length){
      const i = await openSwitchAuto(15, can);
      state.A.i = i;
      toast(`ã„ã‘ã€${left().name}ï¼`);
      renderSides(); buildSix();
    } else {
      toast('ã‚ãªãŸã®ãƒãƒ¼ãƒ ã¯å…¨æ»…â€¦');
    }
  }else{
    const can=[0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0);
    if(can.length){
      // ç›¸æ€§å„ªå…ˆã§äº¤ä»£
      let best=can[0], bestMul=typeMult(state.B.team[can[0]].type,left().type);
      for(const k of can){ const m=typeMult(state.B.team[k].type,left().type); if(m>bestMul){best=k;bestMul=m;} }
      state.B.i=best; toast(`ç›¸æ‰‹ã¯ ${right().name} ã‚’ãã‚Šã ã—ãŸï¼`);
      renderSides(); buildSix();
    } else {
      toast('ç›¸æ‰‹ã®ãƒãƒ¼ãƒ ã¯å…¨æ»…ï¼ã‚ãªãŸã®å‹ã¡ï¼');
    }
  }
}

/* äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å¼·åˆ¶äº¤ä»£ï¼‰ */
const modal=$('switchModal'), grid=$('switchGrid'), doBtn=$('swDo'), cancelBtn=$('swCancel'), swTimer=$('swTimer');
let selectIdx=null, swInterval=null;
function openSwitch(){ return openSwitchAuto(15); }
function openSwitchAuto(sec=15, canList=null){
  return new Promise(resolve=>{
    grid.innerHTML=''; selectIdx=null; doBtn.disabled=true; modal.style.display='grid';
    const idxs = (canList??[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0));
    idxs.forEach(i=>{
      const u=state.A.team[i]; const good=typeMult(u.type,right().type)>1;
      const div=document.createElement('div'); div.className='setupMini selCard'; if(good) div.innerHTML+='<div class="badge">ãŠã™ã™ã‚</div>';
      div.innerHTML += `<div class="head"><div>${u.name}</div><div class="badge">${u.type}</div></div>
        <div class="barLine"><div style="width:76px;font-size:12px">HP</div>
          <div class="barBox"><div class="barFill" style="width:${100*u.hp/u.maxhp}%"></div></div>
          <div class="val">HP ${u.hp}/${u.maxhp}</div></div>`;
      div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(x=>x.classList.remove('selected')); div.classList.add('selected'); selectIdx=i; doBtn.disabled=false; };
      grid.append(div);
    });

    let remain=sec; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`;
    clearInterval(swInterval);
    swInterval=setInterval(()=>{ remain--; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`; if(remain<=0){ clearInterval(swInterval); auto(); }},1000);

    const close=(i)=>{ modal.style.display='none'; clearInterval(swInterval); resolve(i); };
    const auto=()=>{ const r = idxs[Math.floor(Math.random()*idxs.length)]; close(r); };
    doBtn.onclick=()=>{ if(selectIdx==null) return; close(selectIdx); };
    cancelBtn.onclick=auto;
  });
}

/* ===== åˆæœŸåŒ– ===== */
function left(){return state.A.team[state.A.i]}
function right(){return state.B.team[state.B.i]}

function ensureBattleMode(){ document.body.classList.add('battleMode'); $('setup').style.display='none'; $('battle').style.display='block'; }

function bindClicks(){
  $('btnRand').onclick=()=>{
    const a=uniqueRandom(3,WORDS_BASE.length), b=uniqueRandom(3,WORDS_BASE.length);
    a.forEach((v,i)=>$(`A-${i}`).value=v); b.forEach((v,i)=>$(`B-${i}`).value=v);
    enforceUnique('A'); enforceUnique('B'); renderMini('A'); renderMini('B');
    toast('ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆã—ã¾ã—ãŸ');
  };
  $('btnStart').onclick=()=>{
    state.A.team=collect('A'); state.B.team=collect('B');
    state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0; state.spOn=false; state.spAnnA=false; state.spAnnB=false;
    ensureBattleMode(); renderSides(); buildSix();
    (async()=>{ toast('ã„ã‘ã€'+left().name+'ï¼ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼'); await delay(900); startRound(); })();
  };
  $('btnBack').onclick=()=>{document.body.classList.remove('battleMode'); $('battle').style.display='none'; $('setup').style.display='block'; toast('ç·¨æˆã«æˆ»ã‚Šã¾ã—ãŸ');};
  $('btnG').onclick=()=>pick('G'); $('btnC').onclick=()=>pick('C'); $('btnP').onclick=()=>pick('P');
  $('btnSwitch').onclick=openSwitch;
  $('btnSP').onclick=()=>{ if(state.A.sp>=6){ state.spOn=!state.spOn; updateSPBtn(); }};
}

function buildUI(){
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
}

document.addEventListener('DOMContentLoaded',()=>{ buildUI(); bindClicks(); toast('READY: v7.10'); });

})();
</script>
</body>
</html>
