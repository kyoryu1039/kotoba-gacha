<!doctype html> 
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v30.10 AutoResize</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#020617">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Teko:wght@500;700&family=M+PLUS+1p:wght@700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #020617; --text: #f1f5f9;
  --glass: rgba(15, 23, 42, 0.85);
  --border-color: rgba(255, 255, 255, 0.15);
  
  --ally: #3b82f6; --enemy: #ef4444;
  --hp: #10b981; --gauge: #eab308;
  
  /* ã‚¿ã‚¤ãƒ—è‰² */
  --t-ã‚¸ã‚ª:#4f46e5; 
  --t-ã‚¢ãƒ‹ãƒãƒ«:#4ade80; 
  --t-ãƒ•ãƒ¼ãƒ‰:#ffaa2b; 
  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#c084fc; 
  --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#22d3ee; 
  --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#f472b6; 
  --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#a3e635;

  --glow-A: #ffd700;
  --glow-B: #c0c0c0;
  --glow-C: #64748b;
  --glow-D: #ffffff;
  --glow-X: #d946ef;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0;}
body{
  background-color: var(--bg); color: var(--text);
  font-family: 'Noto Sans JP', sans-serif;
  background-image: radial-gradient(circle at 50% 30%, #1e293b 0%, #020617 80%);
  overflow-y:auto; /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
}

/* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.bg-anim {
  position: fixed; inset: 0; z-index: -1;
  background: 
    linear-gradient(transparent 95%, rgba(59, 130, 246, 0.1) 96%, transparent 100%),
    linear-gradient(90deg, transparent 95%, rgba(59, 130, 246, 0.1) 96%, transparent 100%);
  background-size: 40px 40px;
  animation: gridMove 20s linear infinite;
  perspective: 1000px; transform-style: preserve-3d;
}
@keyframes gridMove { from { transform: translateY(0); } to { transform: translateY(40px); } }

.container{
  max-width:800px;
  margin:0 auto;
  padding:8px;
}

/* ãƒãƒˆãƒ«ç”»é¢ç”¨ï¼š1ç”»é¢ã«åã‚ã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
#battle{
  display:none;           /* JSã§flexã«åˆ‡ã‚Šæ›¿ãˆ */
  flex-direction:column;
  height:100vh;           /* ç”»é¢ã„ã£ã±ã„ */
  max-height: 100vh;      /* ã¯ã¿å‡ºã—é˜²æ­¢ */
  box-sizing:border-box;
  overflow: hidden;       /* ãƒãƒˆãƒ«ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
}

/* ã‚«ãƒ¼ãƒ‰ãƒ»ç·¨æˆå…±é€šã‚«ãƒ¼ãƒ‰ */
.card {
  background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color);
  border-radius: 12px; margin-bottom: 12px; backdrop-filter: blur(12px);
}
.card h2 {
  margin:0; padding:10px 14px; font-size:14px; font-weight:800; color: #e2e8f0;
  background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-color);
  display: flex; justify-content: space-between; align-items: center;
}
.card h2 span{
  flex:1;
  text-align:center;
}
.card .body { padding: 12px; }

/* ãƒœã‚¿ãƒ³ */
.btn3d {
  appearance: none; border: none; cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif; font-weight: 800; font-size: 14px; color: #fff;
  padding: 10px 16px; border-radius: 8px; transition: .1s;
  display: inline-flex; justify-content: center; align-items: center; gap: 6px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.btn3d:active:not([disabled]) { transform: translateY(2px); filter: brightness(0.9); }
.btn3d:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

.btn-primary { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); box-shadow: 0 4px 0 #1e3a8a; }
.btn-ghost { background: linear-gradient(to bottom, #475569, #1e293b); box-shadow: 0 4px 0 #0f172a; border: 1px solid rgba(255,255,255,0.1); }
.btnTiny { padding: 4px 8px; font-size: 10px; border-radius: 4px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); color: #cbd5e1; cursor: pointer; }

/* ç·¨æˆç”»é¢ */
#setup { display: grid; gap: 12px; }
#teamGrid { display: grid; gap: 8px; }
@media(min-width:600px){ #teamGrid { grid-template-columns: 1fr 1fr; } }
.slot { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
.pill { 
  width: 20px; height: 20px; border-radius: 4px; 
  background: #334155; color: #fff; font-weight: 800; font-size: 11px; 
  display: grid; place-items: center;
  border: 1px solid rgba(15,23,42,0.9);
}
.slot select { flex: 1; background: transparent; border: none; color: #fff; font-weight: 800; font-size: 13px; outline: none; }
.slot select option { background: #0f172a; color: #fff; }

#statsGrid { display: grid; gap: 10px; }
@media(min-width:720px){ #statsGrid { grid-template-columns: 1fr 1fr; } }
.statsCol { display: grid; gap: 8px; }
.setupMini { border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; background: rgba(30, 41, 59, 0.6); display: flex; flex-direction: column; gap: 4px;}

.barRow{margin:2px 0;display:grid;grid-template-columns:40px 1fr 36px;align-items:center;gap:4px;font-size:10px}
.barLabel{color:#9ca3af}
.barBox{height:6px;background:#020617;border-radius:3px;overflow:hidden}
.barFill{height:100%;background:var(--hp);}

/* äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã®æ ã‚’å¼·èª¿ */
.selCard {
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
}
.selCard.selected {
  border: 2px solid #facc15;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.7),
              0 0 16px rgba(250, 204, 21, .8);
  transform: translateY(-2px);
}

/* ãƒãƒˆãƒ«ç”»é¢å…¨ä½“ */
.arena {
  flex:1;
  display:flex;
  flex-direction:column;
  gap:8px; /* éš™é–“ã‚’å°‘ã—è©°ã‚ã‚‹ */
  transition: transform .1s;
  overflow:hidden;
  padding: 8px 8px 0 8px; /* ä¸Šå·¦å³ã«padding */
}
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-2px,1px)}20%,80%{transform:translate(1px,-2px)}30%,50%,70%{transform:translate(-4px,2px)}40%,60%{transform:translate(4px,-2px)}}
.vsrow { 
  flex:1;
  min-height:0; /* å­è¦ç´ ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ç¸®å°ã‚’è¨±å¯ */
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: stretch;
}
.vsrow > div { 
  min-width: 0; 
  height: 100%; /* è¦ªã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
}

/* === ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ === */
.unit {
  position: relative; 
  width: 100%; 
  height: 100%; 
  min-height: 0; /* â˜…é‡è¦ï¼šç¸®å°ã‚’è¨±å¯ */
  border-radius: 14px;
  padding: 3px; 
  background: #334155;
  box-shadow: 0 10px 30px rgba(0,0,0,0.7);
  display: flex; flex-direction: column; overflow: hidden;
  transition: filter 0.3s;
}

/* ãƒ©ãƒ³ã‚¯åˆ¥ æ ç·š */
.unit[data-rank="S"] { 
  background: linear-gradient(60deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); 
  background-size: 300% 300%; 
  animation: rainbowBorder 3s linear infinite; 
}
.unit[data-rank="A"] {
  position: relative;
  border: 1px solid #ffd700;
  overflow: hidden;
}
.unit[data-rank="A"]::after {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: linear-gradient(
     115deg,
     transparent 40%,
     rgba(255,255,255,0.35) 50%,
     transparent 60%
  );
  animation: shineA 3.5s ease-in-out infinite;
}
@keyframes shineA {
  0%    { transform: translate(0,0); }
  100% { transform: translate(150%,150%); }
}
.unit[data-rank="B"] {
  position: relative;
  border: 1px solid #e5e7eb;
  overflow: hidden;
}
.unit[data-rank="B"]::after {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: linear-gradient(
    115deg,
    transparent 40%,
    rgba(255,255,255,0.25) 50%,
    transparent 60%
  );
  animation: shineB 4.2s ease-in-out infinite;
}
@keyframes shineB {
  0%    { transform: translate(0,0); }
  100% { transform: translate(150%,150%); }
}
.unit[data-rank="C"] {
  background: #64748b;
  border: 1px solid #475569;
}
.unit[data-rank="D"] {
  background: #ffffff;
  border: 1px solid #d1d5db;
}
.unit[data-rank="X"] {
  background: #d946ef;
  border: 1px solid #9333ea;
}
@keyframes rainbowBorder { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

/* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ */
.unitInner {
  position: relative; z-index: 1; 
  flex: 1; 
  display: flex; flex-direction: column;
  background: linear-gradient(160deg, #1e293b, var(--typeColor), #0f172a);
  border-radius: 11px; padding: 4px; overflow: hidden;
  height: 100%;
}
.unit[data-rank="S"]::after {
  content: ""; position: absolute; inset: 0; z-index: 10; pointer-events: none;
  background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.4) 50%, transparent 55%);
  background-size: 250% 250%; animation: shine 3.5s infinite linear; mix-blend-mode: overlay;
}
@keyframes shine{0%{background-position:200% 200%}100%{background-position:-50% -50%}}

.unit.fall { animation: fallDown 0.8s forwards; filter: grayscale(1) brightness(0.4); }
@keyframes fallDown { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(80px) rotate(20deg); opacity: 0; } }

.cardHeader {
  flex: 0 0 auto; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å›ºå®š */
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; background: rgba(0,0,0,0.5); border-radius: 8px 8px 0 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.ownerBadge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; background: #020617; border: 1px solid #334155; color: #94a3b8; letter-spacing: 0.05em; }
.typeIcon { font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 6px; background: var(--typeColor); color: #0b0f1c; box-shadow: 0 2px 4px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); }

.cardName {
  flex: 0 0 auto; /* åå‰ã‚‚å›ºå®š */
  font-weight: 900; font-size: 15px; color: #fff;
  text-shadow: 0 2px 4px #000; white-space: nowrap;
  text-align: center; display: block; height: 24px; line-height: 24px;
  font-family:'M PLUS 1p','Noto Sans JP',sans-serif;
}

.artArea {
  position: relative; width: 100%; 
  /* aspect-ratio: 4/3; å‰Šé™¤: ç¸¦æ¨ªæ¯”å›ºå®šã‚’è§£é™¤ */
  flex: 1;            /* ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦ä½¿ã† */
  min-height: 0;      /* ç¸®å°å¯èƒ½ã«ã™ã‚‹ */
  
  margin: 0; border-radius: 0 0 8px 8px; overflow: hidden;
  background: radial-gradient(circle at center, rgba(255,255,255,0.1), rgba(0,0,0,0.6));
  border: 1px solid rgba(255,255,255,0.1); border-top: none;
  display: flex; align-items: center; justify-content: center;
  box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
}
.mainImg {
  max-height: 100%; max-width: 100%; 
  width: auto; height: auto;
  object-fit: contain;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7));
  animation: breathe 4s ease-in-out infinite alternate;
}
@keyframes breathe { from { transform: scale(1); } to { transform: scale(1.04); } }
.unit.hit .mainImg { animation: hit .4s ease; }
@keyframes hit{10%,90%{transform:translate(-6px,0)}20%,80%{transform:translate(10px,0)}30%,50%,70%{transform:translate(-10px,0)}40%,60%{transform:translate(10px,0)}}

.statsArea { 
  flex: 0 0 auto; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹éƒ¨åˆ†ã¯ç¸®ã¾ãªã„ */
  padding: 8px 6px 6px; 
  background: rgba(15, 23, 42, 0.85); 
  margin-top: 0; /* ãƒãƒ¼ã‚¸ãƒ³ãƒªã‚»ãƒƒãƒˆ */
  position: relative; z-index: 3; 
  border-radius: 0 0 10px 10px; 
}

/* HP è¡¨ç¤º */
.hpRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2px;
  font-family:'Teko',sans-serif;
}
.hpLabel{
  font-size:12px;
  color:#e5e7eb;
  letter-spacing:0.06em;
}
.hpNum{
  display:flex;
  align-items:baseline;
  gap:2px;
  font-weight:700;
  color:#f9fafb;
}
.hpCurr{font-size:18px;}
.hpSlash{font-size:11px;opacity:0.9;}
.hpMax{font-size:11px;color:#e5e7eb;opacity:0.9;}

.statusRow { display: flex; gap: 4px; min-height: 14px; margin-top: 4px; justify-content: flex-end; flex-wrap: wrap; }
.stBadge { font-size: 9px; padding: 1px 4px; border-radius: 4px; background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; }

.hpBarBg { width: 100%; height: 10px; background: #0f172a; border-radius: 5px; border: 1px solid #334155; overflow: hidden; }
.hpBar { height: 100%; width: 100%; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s; }
.hpBar.high { background: #10b981; box-shadow: 0 0 8px #10b981; }
.hpBar.mid { background: #eab308; box-shadow: 0 0 8px #eab308; }
.hpBar.low { background: #ef4444; box-shadow: 0 0 8px #ef4444; animation: pulseHP 0.5s infinite alternate; }
@keyframes pulseHP { from { opacity: 1; } to { opacity: 0.6; } }

.bottomSection { 
  flex: 0 0 auto; /* ä¸‹éƒ¨ã‚‚å›ºå®š */
  display: flex; flex-direction: column; gap: 6px; padding: 6px; 
  background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 6px; 
}
.spRow { display: flex; gap: 4px; justify-content: center; }
.pip { width: 16px; height: 8px; background: #451a03; border: 1px solid #78350f; border-radius: 2px; transition: .3s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
.pip.on { background: linear-gradient(to bottom, var(--gauge), #d97706); border-color: #fcd34d; box-shadow: 0 0 8px var(--gauge); }

.skillInfo { background: rgba(0,0,0,0.4); padding: 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); flex: 1; min-height: 40px; display:flex; flex-direction:column; justify-content:center; }
.skillN { font-size: 11px; font-weight: 900; color: #fcd34d; margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
.skillD { font-size: 10px; line-height: 1.3; color: #cbd5e1; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.footer { display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #94a3b8; font-family: 'Teko'; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; }
.btnStat { appearance: none; border: none; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #60a5fa; border-radius: 4px; padding: 2px 6px; font-size: 9px; font-weight: 800; cursor: pointer; transition: .2s; }
.btnStat:hover { background: rgba(59, 130, 246, 0.4); color: #fff; }

/* æ“ä½œãƒ‘ãƒƒãƒ‰ï¼ˆé€šå¸¸é…ç½®ï¼‰ */
.padCard {
  flex:0 0 auto;
  background: rgba(15, 23, 42, 0.95); border-top: 1px solid #334155;
  box-shadow: 0 -4px 24px rgba(0,0,0,0.8); padding: 10px 16px 20px;
  backdrop-filter: blur(12px);
  border-radius: 12px 12px 0 0;
  margin-top:6px;
}

@media(min-width: 800px) {
  .padCard {
    padding: 16px 24px 22px;
  }
}

.padHead {
  display: flex; justify-content: center; align-items: center;
  margin-bottom: 6px; font-size: 12px; color: #94a3b8; font-family: 'Teko'; letter-spacing: 1px;
}
.timerVal { font-size: 24px; color: #fff; font-weight: 600; margin-left: 4px; }

/* === æ§ãˆï¼šãƒ‘ãƒãƒ«ã®ä¸Šã«ä¹—ã‚‹å¸¯ï¼ˆé€šå¸¸é…ç½®ï¼‰ === */
.benchRow {
  flex:0 0 auto;
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:4px 14px;
  max-width:480px;
  width:100%;
  height:32px;
  margin:4px auto 0;

  background:rgba(15,23,42,0.98);
  border-radius:10px 10px 0 0;
  border:1px solid #334155;
  box-shadow:0 -2px 12px rgba(0,0,0,0.7);

  overflow-x:auto;
  scrollbar-width:none;
}
.benchRow::-webkit-scrollbar{display:none}

.benchLabel{
  font-weight:900;
  font-family:'Teko','M PLUS 1p',sans-serif;
  font-size:11px;
  flex:0 0 auto;
}

.resIcon { 
  width: 24px; height: 24px; border-radius: 6px; background: #1e293b; 
  border: 2px solid; color: #fff; font-size: 10px; display: grid; place-items: center; 
  cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-weight: 800;
  flex:0 0 auto;
}
.resIcon.dead { opacity: 0.3; filter: grayscale(1); cursor: default; border-color: #333 !important; }
.resIcon.active { border-color: #fff !important; box-shadow: 0 0 6px #fff; transform: scale(1.1); z-index: 2; }

.padInner { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center; max-width: 600px; margin: 0 auto; }
.rpsArea { display: flex; gap: 16px; justify-content: center; }
.rps {
  width: 64px; height: 64px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.15); cursor: pointer;
  display: grid; place-items: center; position: relative; top: 0; transition: all .1s;
  box-shadow: 0 8px 0 rgba(0,0,0,0.5), 0 12px 24px rgba(0,0,0,0.4);
}
.rps:active:not([disabled]) { top: 8px; box-shadow: none; }
.rps.g { background: linear-gradient(145deg, #ef4444, #b91c1c); color: #fff; }
.rps.c { background: linear-gradient(145deg, #3b82f6, #1d4ed8); color: #fff; }
.rps.p { background: linear-gradient(145deg, #22c55e, #15803d); color: #fff; }
.rps:disabled { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; top: 8px; box-shadow: none; }
.emo { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }

.sideBtns { display: flex; flex-direction: column; gap: 8px; width: 120px; }
.cmdBtn {
  width: 100%; padding: 10px 0; border-radius: 8px; font-weight: 800; font-size: 13px;
  border: none; cursor: pointer; color: #fff; position: relative; top: 0; transition: .1s;
  box-shadow: 0 4px 0 rgba(0,0,0,0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.cmdBtn:active:not([disabled]) { top: 4px; box-shadow: none; }
.cmdBtn:disabled { opacity: 0.5; top: 4px; box-shadow: none; cursor: not-allowed; filter: grayscale(1); }

/* SPãƒ»äº¤ä»£ãƒœã‚¿ãƒ³ */
.btn-sp { background: linear-gradient(to bottom, #334155, #1e293b); color: #94a3b8; }
.btn-switch { background: linear-gradient(to bottom, #334155, #1e293b); }

@media(max-width:480px){
  .padCard{padding:8px 10px 14px;}
  .padInner{grid-template-columns:1fr; gap:12px;}
  .sideBtns{flex-direction:row; justify-content:center; width:auto;}
  .sideBtns .cmdBtn{font-size:12px; padding:8px 10px;}
  .rps{width:56px; height:56px;}
}

/* SP READY(PUSH!) */
.btn-sp.ready { 
  background: #f59e0b; color: #fff;
  animation: flashReady 0.2s infinite alternate; 
  border: 2px solid #fff;
}
@keyframes flashReady { from { background: #f59e0b; box-shadow: 0 0 5px #f59e0b; } to { background: #b91c1c; box-shadow: 0 0 20px #ef4444; } }
.btn-sp.on { background: linear-gradient(to bottom, #ef4444, #b91c1c); color: #fff; box-shadow: 0 0 15px #ef4444; animation: pulse 1s infinite; }
@keyframes pulse { 0% { opacity:1; } 50% { opacity:0.8; } 100% { opacity:1; } }

.logWrapper { border: 1px solid #334155; background: rgba(2, 6, 23, 0.8); border-radius: 8px; overflow: hidden; margin-bottom: 4px; flex:0 0 auto; }
.logHeader { background: #1e293b; color: #94a3b8; font-size: 10px; padding: 2px 8px; font-weight: 700; font-family: 'Noto Sans JP','Teko',sans-serif; border-bottom: 1px solid #334155; }
.logContainer { height: 80px; overflow-y: auto; padding: 8px; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
.logLine { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.logLine.highlight { color: #fbbf24; }
.logLine.dmg { color: #fca5a5; }
.logLine.heal { color: #6ee7b7; }

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.floatingText {
  position: absolute; 
  left: 50%; top: 22%; transform: translate(-50%, -50%);
  font-family: 'M PLUS 1p','Noto Sans JP',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  font-weight: 900;
  font-size: 14px;
  color: #e5e7eb;
  letter-spacing: 0.05em;
  pointer-events: none; 
  z-index: 20;
  animation: popUp 1.4s cubic-bezier(0.215, 0.61, 0.355, 1) forwards;
  white-space: pre-wrap;
  text-align:center;
  max-width: 80vw;
  padding:6px 14px;
  border-radius:999px;
  background: rgba(15,23,42,0.95);
  box-shadow: 0 8px 24px rgba(0,0,0,0.7);
  border: 1px solid rgba(148,163,184,0.9);
}

.floatingText.dmg { 
  color:#fecaca; 
  border-color:#fca5a5;
  background:linear-gradient(135deg,rgba(30,64,75,0.96),rgba(127,29,29,0.96));
}
.floatingText.heal { 
  color:#bbf7d0; 
  border-color:#4ade80;
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(21,128,61,0.96));
}
.floatingText.miss { 
  color:#e5e7eb; 
  border-color:#9ca3af;
  background:rgba(15,23,42,0.96);
}
.floatingText.buff { 
  color:#fef9c3; 
  border-color:#facc15;
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(161,98,7,0.96));
}
.floatingText.debuff { 
  color:#e9d5ff; 
  border-color:#a855f7;
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(88,28,135,0.96));
}
.floatingText.info { 
  color:#e5e7eb; 
  border-color:#38bdf8;
  background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(30,64,175,0.96));
}

/* ç›¸æ€§ãƒˆãƒ¼ã‚¹ãƒˆã¯å°‘ã—ä¸Šã« */
.floatingText.advTop,
.floatingText.disTop {
  top: 16%;
  font-size: 13px;
  padding:4px 10px;
}
.floatingText.advTop { 
  color:#bbf7d0; 
  border-color:#4ade80;
}
.floatingText.disTop { 
  color:#fecaca; 
  border-color:#f97373;
}

@keyframes popUp { 
  0% { opacity: 0; transform: translate(-50%, -8px) scale(0.9); } 
  15% { opacity: 1; transform: translate(-50%, -4px) scale(1); } 
  80% { opacity: 1; transform: translate(-50%, -6px) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -14px) scale(0.98); } 
}

#jankenOverlay,#cutIn,#switchModal,#infoModal,#rulesModal,#result{position:fixed;inset:0;z-index:100;pointer-events:none;display:none;align-items:center;justify-content:center}
#switchModal,#infoModal,#rulesModal,#result{background:rgba(0,0,0,0.8);pointer-events:auto;backdrop-filter:blur(8px)}
#jankenOverlay.active{display:flex;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)}
#cutIn.show,#switchModal.show,#infoModal.show,#rulesModal.show,#result.show{display:flex}
.jkWrap{display:flex;flex-direction:column;align-items:center;gap:24px}
.jkHands{display:flex;gap:40px;align-items:center}
.jkHand{font-size:80px;transition:transform .2s cubic-bezier(0.34,1.56,0.64,1);opacity:0;transform:scale(0)}
.jkHand.show{opacity:1;transform:scale(1)}
.jkHand.win{filter:drop-shadow(0 0 30px #fcd34d);transform:scale(1.3) rotate(-15deg);z-index:10}
.jkHand.lose{filter:grayscale(1) brightness(0.4);opacity:0.5;transform:scale(0.8) rotate(15deg)}
.jkResult{font-family:'Teko';font-size:80px;font-weight:700;color:#fff;text-shadow:0 8px 24px #000;opacity:0;transform:translateY(30px);transition:all .3s}
.jkResult.show{opacity:1;transform:translateY(0)}
#cutIn{background:linear-gradient(90deg,transparent,rgba(30,58,138,0.95) 20%,rgba(30,58,138,0.95) 80%,transparent);height:120px;border-top:2px solid #60a5fa;border-bottom:2px solid #60a5fa;flex-direction:column;transform:scaleY(0);transition:.2s}
#cutIn.show{display:flex;transform:scaleY(1)}
.cutInText{font-size:36px;font-weight:900;color:#fff;text-shadow:0 4px 12px #000;font-style:italic;letter-spacing:0.1em}
.cutInSub{font-size:14px;color:#93c5fd;font-weight:700;margin-top:6px}
.modalCard{width:min(500px,92vw);max-height:85vh;overflow-y:auto;background:#0f172a;border:1px solid #334155;border-radius:16px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:popIn 0.3s}
@keyframes popIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
.modalHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid #334155;padding-bottom:10px}
.modalTitle{margin:0;font-size:18px;font-weight:900;color:#fff;font-family:'Noto Sans JP'}

@media(max-width:480px){
  .modalCard{
    max-height:80vh;
    padding:14px;
    border-radius:12px;
  }
  .setupMini{
    padding:6px;
  }
}

/* ç¸¦ãŒçŸ­ã„ç”»é¢å‘ã‘ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-height: 700px) {
  .logContainer { height: 50px; } /* ãƒ­ã‚°ã‚’å°ã•ã */
  .padCard { padding-top: 6px; padding-bottom: 10px; }
  .rps { width: 50px; height: 50px; }
  .emo { font-size: 20px; }
  .benchRow { height: 28px; }
  .resIcon { width: 20px; height: 20px; }
  .btn3d { padding: 6px 12px; font-size: 12px; }
}
</style>
</head>
<body>

<div class="bg-anim"></div>

<div class="container" id="setup">
  <section class="card">
    <h2>
      <button class="btnTiny" id="btnBack">â† æˆ»ã‚‹</button>
      <span>TEAM SETUP</span>
      <button class="btnTiny" id="btnRules">ãƒ«ãƒ¼ãƒ«</button>
    </h2>
    <div class="body">
      <div id="teamGrid">
        <div><div class="statsHead" style="color:#4da6ff;font-weight:900;margin-bottom:8px">YOU</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#ff5c6c;font-weight:900;margin-bottom:8px">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:12px; margin-top:24px">
        <button id="btnRand" class="btn3d btn-ghost" style="flex:0 0 auto">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button id="btnStart" class="btn3d btn-primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2><span>STATUS DETAIL</span></h2>
    <div class="body">
      <div id="statsGrid">
        <div><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div class="container" id="battle" style="display:none">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>
    
    <div class="logWrapper">
      <div class="logHeader">BATTLE LOG</div>
      <div class="logContainer" id="battleLog"></div>
    </div>
  </div>

  <div class="benchRow" id="benchRow"></div>
  
  <section class="padCard" id="pad">
    <div class="padHead">
      <div style="flex:1"></div>
      <div>TIME <span class="timerVal" id="countNum">15</span></div>
      <div style="flex:1"></div>
    </div>

    <div class="padInner">
      <div class="rpsArea">
        <button class="rps g" id="btnG"><div class="emo">âœŠ</div></button>
        <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div></button>
        <button class="rps p" id="btnP"><div class="emo">ğŸ–</div></button>
      </div>
      <div class="sideBtns">
        <button class="cmdBtn btn-sp" id="btnSP" disabled>å¿…æ®ºæŠ€</button>
        <button class="cmdBtn btn-switch" id="btnSwitch">äº¤ä»£</button>
      </div>
    </div>
  </section>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">âœŠ</div><div style="color:#fff;font-weight:900;font-size:40px;font-family:'Teko'">VS</div><div class="jkHand" id="jkHandB">âœŒï¸</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">ãƒ¡ãƒ³ãƒãƒ¼äº¤ä»£</h3><button class="btnTiny" id="swCancel">é–‰ã˜ã‚‹</button></div><div id="switchGrid"></div><button id="swDo" class="btn3d btn-primary" style="width:100%;margin-top:24px" disabled>ã“ã®ã‚­ãƒ£ãƒ©ã«äº¤ä»£</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3><button class="btnTiny" id="infoClose">é–‰ã˜ã‚‹</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">ãƒ«ãƒ¼ãƒ«èª¬æ˜</h3><button class="btnTiny" id="rulesClose">é–‰ã˜ã‚‹</button></div><ul style="padding-left:20px;line-height:2;color:#cbd7f0;font-size:14px;list-style-type:square"><li>3ä½“ã®ã€Œè¨€è‘‰ã€ã§ãƒãƒ¼ãƒ ã‚’çµ„ã‚“ã§æˆ¦ã†ã‚¿ãƒ¼ãƒ³åˆ¶ãƒãƒˆãƒ«ã€‚</li><li>ã˜ã‚ƒã‚“ã‘ã‚“ã«<strong>å‹ã¤ã¨æ”»æ’ƒ</strong>ã€<strong>è² ã‘ã‚‹ã¨é˜²å¾¡</strong>ã€‚</li><li><strong>ã‚¿ã‚¤ãƒ—ç›¸æ€§</strong>ãŒé‡è¦ï¼ˆæœ‰åˆ©1.5å€ / ä¸åˆ©0.67å€ï¼‰ã€‚</li><li>æ”»æ’ƒãƒ»è¢«å¼¾ã§ã‚²ãƒ¼ã‚¸ãŒæºœã¾ã‚Šã€MAX(6)ã§<strong>å¿…æ®ºæŠ€</strong>ç™ºå‹•ï¼</li><li>ç›¸æ‰‹ãƒãƒ¼ãƒ ã‚’å…¨å“¡å€’ã›ã°å‹åˆ©ï¼</li></ul></div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:48px;background:rgba(15,23,42,0.95)"><h1 id="resTitle" style="color:#fff;margin:0 0 24px;font-size:56px;font-family:'Teko';text-shadow:0 0 30px rgba(255,255,255,0.6)">WIN</h1><p style="color:#94a3b8;font-size:14px;font-family:'Teko';letter-spacing:0.1em">RETURNING TO SETUP...</p></div></div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop></audio>
<audio id="seHit" src="audio/hit.mp3"></audio>
<audio id="seSkill" src="audio/skill.mp3"></audio>
<audio id="seKO" src="audio/ko.mp3"></audio>

<script>
(()=> {
'use strict';
const $ = id => document.getElementById(id);
const qs = (s, el = document) => el.querySelector(s);
const delay = ms => new Promise(r => setTimeout(r, ms));

/* ==== BGM & åŠ¹æœéŸ³ ==== */
function playBGM(){
  const a = $('bgm'); if(!a) return;
  if(a.paused){
    a.volume = 0.25;
    a.play().catch(()=>{});
  }
}
function stopBGM(){
  const a = $('bgm');
  if(a){
    a.pause();
    a.currentTime = 0;
  }
}
function playSE(type){
  let el = null;
  if(type === 'hit') el = $('seHit');
  else if(type === 'skill') el = $('seSkill');
  else if(type === 'ko') el = $('seKO');
  if(el){
    try{
      el.currentTime = 0;
      el.play();
    }catch(e){}
  }
}

/* ç”»åƒãƒãƒƒãƒ— & ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ */
const IMG = {
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"parabola_antenna.png",
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"nescafe_ambassador.png",
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"ninjin_shirishiri.png",
  "ãã¼ã‚ã”ã¯ã‚“":"soboro_gohan.png",
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"western_lowland_gorilla.png",
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":"kemukujara.png",
  "ä¹å“ä»":"kuhonbutsu.png",
  "ã‘ã‚“ã¡ã‚“æ±":"kenchin_jiru.png",
  "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"kamchatka_peninsula.png",
  "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"tarantula.png",
  "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"shoebill.png",
  "ãƒãƒ«ã‚µãƒŸã‚³é…¢":"balsamic_vinegar.png",
  "ãƒ”ãƒ­ãƒªèŒ":"helicobacter_pylori.png",
  "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"trinidad_and_tobago.png",
  "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"caramel_color.png",
  "ãƒãƒ“ãƒ­ãƒ³æ•å›š":"babylonian_captivity.png",
  "é³¥å–ç ‚ä¸˜":"tottori_sand_dunes.png",
  "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"placebo_effect.png",
  "æ¸¡æ¥äºº":"torai_jin.png",
  "ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png",
  "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"peperoncino.png",
  "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"polypropylene.png",
  "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"sarajevo_incident.png",
  "ã‚¯ãƒãƒ³ãƒãƒ":"kumabachi.png",
  "çœŒåºæ‰€åœ¨åœ°":"prefectural_capital.png",
  "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"teriyaki_chicken.png",
  "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"nerunerunerune.png",
  "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"surume_ika.png",
  "æœ¬è³ª":"essence.png",
  "è¦‹ãˆã‚‹åŒ–":"mieruka.png",
  "è‡ªåˆ†ã”ã¨åŒ–":"jibungotoka.png",
  "è§£åƒåº¦":"resolution.png"
};
function preloadImgs(names){
  const unique = [...new Set(names.map(n => IMG[n]).filter(Boolean))];
  unique.forEach(f => {
    const im = new Image();
    im.src = `images/${f}`;
  });
}

/* ãƒ­ã‚° */
function log(msg, type = 'normal'){
  const c = $('battleLog');
  if(!c) return;
  const d = document.createElement('div');
  let icon = '';
  if(type === 'atk') icon = 'âš”ï¸';
  else if(type === 'dmg') icon = 'ğŸ’¥';
  else if(type === 'heal') icon = 'ğŸ’–';
  else if(type === 'sp') icon = 'âœ¨';
  else if(type === 'miss') icon = 'ğŸ’¨';
  d.className = 'logLine ' + type;
  d.textContent = (icon ? icon + ' ' : '') + msg;
  c.appendChild(d);
  c.scrollTop = c.scrollHeight;
}

/* HP UI */
function updateHPUI(role, val, max){
  const bar = $(`hp-${role}`);
  const num = $(`hpnum-${role}`);
  if(bar){
    const pct = (val / max) * 100;
    bar.style.width = `${pct}%`;
    bar.className = 'hpBar';
    if(pct > 50) bar.classList.add('high');
    else if(pct > 20) bar.classList.add('mid');
    else bar.classList.add('low');
  }
  if(num) num.textContent = val;
}

/* åå‰ãƒ•ã‚£ãƒƒãƒˆ */
function fitName(el){
  if(!el) return;
  const len = el.textContent.length;
  if(len > 10) el.style.fontSize = '11px';
  else if(len > 7) el.style.fontSize = '13px';
  else el.style.fontSize = '16px';
}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
function showFloatingText(targetId, text, type, opts = {}){
  const wrap = $(targetId);
  if(!wrap) return;
  const el = document.createElement('div');
  el.className = 'floatingText ' + type;
  el.textContent = text;
  if(opts.fontSize) el.style.fontSize = opts.fontSize + 'px';

  wrap.appendChild(el);

  requestAnimationFrame(() => {
    const maxWidth = window.innerWidth * 0.8;
    let size = parseFloat(window.getComputedStyle(el).fontSize);
    let rect = el.getBoundingClientRect();
    while(rect.width > maxWidth && size > 12){
      size -= 2;
      el.style.fontSize = size + 'px';
      rect = el.getBoundingClientRect();
    }
  });

  setTimeout(() => el.remove(), opts.duration || 2000);
}

async function showCutIn(skill, user){
  $('cutInName').textContent = skill;
  $('cutInUser').textContent = user;
  const el = $('cutIn');
  el.classList.add('show');
  await delay(1200);
  el.classList.remove('show');
  await delay(200);
}

function shakeScreen(){
  const a = $('arena');
  a.classList.remove('shake');
  void a.offsetWidth;
  a.classList.add('shake');
}

let inputLocked = false;
function lockInputs(on){
  inputLocked = on;
  const p = $('pad');
  if(p) p.style.opacity = on ? 0.6 : 1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id => {
    const el = $(id);
    if(el) el.disabled = on;
  });
  updateSPBtn();
}

/* ã‚²ãƒ¼ãƒ çŠ¶æ…‹ */
const TYPES_RING = ['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeColor = t => getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`) || '#7aa0ff';
const typeMult = (atk, def) => {
  const n = TYPES_RING.length;
  const i = TYPES_RING.indexOf(atk);
  const j = TYPES_RING.indexOf(def);
  if(i < 0 || j < 0) return 1;
  const st = [(i+1)%n,(i+2)%n];
  const wk = [(i-1+n)%n,(i-2+n)%n];
  if(st.includes(j)) return 1.5;
  if(wk.includes(j)) return 0.67;
  return 1;
};
const PRANK = {S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE = {S:560,A:540,B:520,C:500,D:480,X:500};

const toKatakana = s => (s || '').replace(/[ã-ã‚“]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
const visualLen = s => (s || '').replace(/[ãƒ»\s]/g,'').length;
const reKanaH = /[ã-ã‚Ÿ]/g, reKanaK = /[ã‚ -ãƒ¿ãƒ¼]/g, reKanji = /[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g;
function countClass(name){
  const H = (name.match(reKanaH) || []).length;
  const K = (name.match(reKanaK) || []).length;
  const J = (name.match(reKanji) || []).length;
  return {H,K,J,total:H+K+J};
}
const reSmallK = /[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°-ã‡¿]/g, reSokuon=/ãƒƒ/g, reVoiced=/[ã‚¬-ãƒãƒ´]/g, rePlosiveEnd=/[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5;
  const cls = countClass(name);
  if(cls.J+cls.K===0){
    atkP += 12.5; defP += 12.5;
  }else{
    const r = cls.K/(cls.J+cls.K);
    atkP += 25*r; defP += 25*(1-r);
  }
  const Lph = yomiKatakana.length || 1;
  const d = (yomiKatakana.match(reVoiced)||[]).length/Lph;
  const s = (yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m = (yomiKatakana.match(reSmallK)||[]).length/Lph;
  const e = rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw = 0.6*d + 0.25*(s+m) + 0.15*e;
  const L = 0.05, U = 0.45;
  const s_ph = Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph = 20*(0.5+0.5*s_ph);
  atkP += atk_ph; defP += 20-atk_ph;
  const T = visualLen(name);
  const s_len = Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len = 20*(0.5+0.5*s_len);
  atkP += atk_len; defP += 20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
  const cls = countClass(name);
  const hiraRatio = cls.total ? (cls.H/cls.total) : 0;
  const rankAdj = ({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank] ?? 0;
  let eva = 10 + 8*hiraRatio - 0.5*(T-5) + rankAdj;
  eva = Math.round(eva*10)/10;
  return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiH]){
  const y = toKatakana(yomiH || name);
  const {atkP,defP,T} = calcAttackDefense(name,y);
  const ATK = Math.round(PRANK[rank]*(atkP/100));
  const DEF = Math.round(PRANK[rank]*(defP/100));
  const HP  = Math.round(HP_BASE[rank]+20*(T-5));
  const EVA = calcEvasion(name,T,rank);
  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,
          shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

/* ã‚¹ã‚­ãƒ«å®šç¾© */
const SKILLS = {
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","å¨åŠ›2.2å€ã€‚ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","æ”»æ’ƒå¾Œã€å‘³æ–¹å…¨å“¡HP60å›å¾©ã€‚"],
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","å¨åŠ›1.6å€ã€‚æ¬¡ã«å—ã‘ã‚‹è‡´å‘½å‚·ã‚’1å›ã ã‘HP1ã§è€ãˆã‚‹ã€‚"],
  "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›é€£ç¶šæ”»æ’ƒï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚"],
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","å¨åŠ›1.5å€ã€‚æ¬¡ã®2å›ã€è‡ªåˆ†ã®æ”»æ’ƒ1.3å€ã€‚"],
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","å¨åŠ›1.4å€ã€‚æ¬¡ã®2å›ã€å›é¿ç‡60%å›ºå®šã€‚"],
  "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","å¨åŠ›1.6å€ã€‚æ¬¡ã®2å›ã€è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸åŠæ¸›ã€‚"],
  "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","å¨åŠ›1.2å€ã€‚è‡ªåˆ†HP150å›å¾©ã€‚"],
  "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
  "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
  "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
  "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
  "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
  "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ã¯3ã‚¿ãƒ¼ãƒ³å¾Œã«æˆ¦é—˜ä¸èƒ½ã€‚"],
  "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯4ã‚¿ãƒ¼ãƒ³äº¤ä»£ä¸å¯ã€‚"],
  "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã«è‡ªå‚·åŠ¹æœï¼ˆ3Tï¼‰ã€‚"],
  "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
  "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
  "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
  "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};

/* ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ */
const WORDS_BASE = [
  ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],
  ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
  ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],
  ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
  ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],
  ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
  ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],
  ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
  ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],
  ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
  ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],
  ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
  ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],
  ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
  ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],
  ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
  ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],
  ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
  ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],
  ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
  ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],
  ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
  ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],
  ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
  ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],
  ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
  ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],
  ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
  ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],
  ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
  ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],
  ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]
];
const makeW = i => makeWordObject(WORDS_BASE[i]);

const state = {
  A:{team:[],i:0,sp:0},
  B:{team:[],i:0,sp:0},
  remain:15,
  timer:null,
  spOn:false,
  busy:false,
  spAnnA:false,
  history:new Set(),
  suppressAffToastOnce:false
};
let forceSwitch = false;

const left  = () => state.A.team[state.A.i];
const right = () => state.B.team[state.B.i];

function barRow(label,val,max){
  const pct = Math.min(100,(val/max)*100);
  return `<div class="barRow">
    <div class="barLabel">${label}</div>
    <div class="barBox"><div class="barFill" style="width:${pct}%"></div></div>
    <div class="barVal">${val}</div>
  </div>`;
}

/* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰ */
function miniCard(idx){
  const w = makeW(idx);
  return `<div class="setupMini" style="--typeC:${typeColor(w.type)}" data-type="${w.type}">
    <div class="head" style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
      <div>${w.name}</div><div style="color:var(--typeC)">${w.type}ï¼${w.rank}ãƒ©ãƒ³ã‚¯</div>
    </div>
    <div class="statGrid">
      ${barRow('HP',w.maxhp,800)}
      ${barRow('ATK',w.atk,120)}
      ${barRow('DEF',w.def,120)}
      ${barRow('EVA',w.eva,30)}
    </div>
  </div>`;
}
function renderMini(side){
  const root = side === 'A' ? $('statsA') : $('statsB');
  root.innerHTML = '';
  for(let i=0;i<3;i++){
    const idx = Number($(`${side}-${i}`).value) || 0;
    root.innerHTML += miniCard(idx);

    const w = WORDS_BASE[idx];
    const t = w[2];
    const pill = $(`${side}-pill-${i}`);
    if(pill){
      const c = typeColor(t) || '#334155';
      pill.style.background = c;
      pill.style.color = '#020617';
      pill.style.borderColor = 'rgba(15,23,42,0.9)';
      pill.style.boxShadow = '0 0 6px rgba(0,0,0,0.5)';
    }
  }
}

/* ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ */
function uniqueRandom(n, sourceLen){
  const arr = [];
  const pool = Array.from({length:sourceLen},(_,i)=>i);
  for(let i=0;i<n;i++){
    const idx = Math.floor(Math.random()*pool.length);
    arr.push(pool[idx]);
    pool.splice(idx,1);
  }
  return arr;
}
function makeTeam(root,side){
  root.innerHTML = '';
  for(let i=0;i<3;i++){
    const div = document.createElement('div');
    div.className = 'slot';
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.textContent = '#' + (i+1);
    pill.id = `${side}-pill-${i}`;
    const sel = document.createElement('select');
    sel.id = `${side}-${i}`;
    WORDS_BASE.forEach((w,idx)=>{
      const o = document.createElement('option');
      o.value = idx;
      o.textContent = `${w[0]} [${w[2]}ï¼${w[1]}ãƒ©ãƒ³ã‚¯]`;
      sel.append(o);
    });
    sel.addEventListener('change', () => renderMini(side));
    div.append(pill,sel);
    root.append(div);
  }
  const picks = uniqueRandom(3,WORDS_BASE.length);
  picks.forEach((v,i) => $(`${side}-${i}`).value = v);
  renderMini(side);
}
function randomizeTeam(side){
  const picks = uniqueRandom(3,WORDS_BASE.length);
  for(let i=0;i<3;i++){
    $(`${side}-${i}`).value = picks[i];
  }
  renderMini(side);
}
const collect = side => [0,1,2].map(i=>{
  const idx = Number($(`${side}-${i}`).value) || 0;
  return {...makeW(idx), side};
});

/* SPãƒœã‚¿ãƒ³ï¼ˆPUSH!å¯¾å¿œï¼‰ */
function updateSPBtn(){
  const btn = $('btnSP'); if(!btn) return;
  const ready = state.A.sp >= 6;
  const canPress = !inputLocked && ready && !state.busy;

  btn.disabled = !canPress;

  if(state.spOn){
    btn.innerHTML = '<span>âœ¨</span> å¿…æ®ºON';
    btn.className = 'cmdBtn btn-sp on';
  }else if(ready && !inputLocked){
    // ç‚¹æ»…ä¸­ã®è¡¨ç¤ºã‚’ PUSH! ã«å¤‰æ›´
    btn.innerHTML = '<span>PUSH!</span>';
    btn.className = 'cmdBtn btn-sp ready';
  }else{
    btn.innerHTML = '<span>å¿…æ®ºæŠ€</span>';
    btn.className = 'cmdBtn btn-sp';
  }

  if(ready && !state.spAnnA){
    log('å¿…æ®ºã‚²ãƒ¼ã‚¸MAXï¼','highlight');
    state.spAnnA = true;
  }
}

/* ã˜ã‚ƒã‚“ã‘ã‚“æ¼”å‡º */
async function playJankenAnim(myH,cpuH,res){
  const map={G:'âœŠ',C:'âœŒï¸',P:'ğŸ–'};
  const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  ov.classList.add('active');
  hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  await delay(50); hA.classList.add('show'); hB.classList.add('show');
  await delay(400);
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else{ rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show');
  await delay(800); ov.classList.remove('active');
}

/* ç›¸æ€§ï¼†æ§ãˆè¡¨ç¤º */
function checkAffinity(){
  const a = left(), b = right();
  const pairKey = `${a.name}:${b.name}`;
  const m1 = typeMult(a.type,b.type);
  const m2 = typeMult(b.type,a.type);

  const setBadge = (el,m)=>{
    if(!el) return;
    el.className = 'affTag';
    if(m>=1.5){ el.textContent='â–² æœ‰åˆ©'; el.className='affTag adv show'; }
    else if(m<=0.7){ el.textContent='â–¼ ä¸åˆ©'; el.className='affTag dis show'; }
    else { el.className='affTag even'; }
  };
  setBadge(qs('#affA'),m1);
  setBadge(qs('#affB'),m2);

  if(state.suppressAffToastOnce){
    state.suppressAffToastOnce = false;
    return;
  }
  if(!state.history.has(pairKey)){
    state.history.add(pairKey);
    if(m1>=1.5){
      showFloatingText('leftWrap','ç›¸æ€§æœ‰åˆ©!','advTop');
      log(`ã€æœ‰åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼·ã„ï¼`,'heal');
    }else if(m1<=0.7){
      showFloatingText('leftWrap','ç›¸æ€§ä¸åˆ©...','disTop');
      log(`ã€ä¸åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼±ã„...`,'dmg');
    }
  }
}

/* æ§ãˆã‚¢ã‚¤ã‚³ãƒ³ */
function buildBoxes(){
  const row = $('benchRow');
  if(!row) return;

  const mk = (u,i,isActive) => `
    <div class="resIcon ${u.hp<=0?'dead':''} ${isActive?'active':''}"
         onclick="window._sh('${u.name}')"
         style="border-color:${typeColor(u.type)}">
      ${u.name.charAt(0)}
    </div>`;

  const leftIcons  = state.A.team.map((u,i)=>mk(u,i,i===state.A.i)).join('');
  const rightIcons = state.B.team.map((u,i)=>mk(u,i,i===state.B.i)).join('');

  row.innerHTML = `
    <span class="benchLabel you">YOU</span>
    ${leftIcons}
    <span class="benchLabel vs">VS</span>
    ${rightIcons}
    <span class="benchLabel cpu">CPU</span>
  `;
}

/* ã‚«ãƒ¼ãƒ‰æç”» */
function renderCard(u,role){
  const sp = role==='ally'?state.A.sp:state.B.sp;
  const owner = role==='ally'?'YOU':'CPU';
  const img = IMG[u.name]
    ? `<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none';">`
    : `<span style="font-size:40px">ğŸ“¦</span>`;
  const skill = (SKILLS[u.name] || ['â€”','â€”']);
  const pips = [...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  let badges = '';
  if(u.lock>0)     badges += `<div class="stBadge">ğŸ”’äº¤ä»£ä¸å¯</div>`;
  if(u.doom>0)     badges += `<div class="stBadge">ğŸ‘¾æ–‡å­—åŒ–ã‘</div>`;
  if(u.selfHurt>0) badges += `<div class="stBadge">ğŸŒ€å´©å£Š</div>`;

  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}">
    <div class="unitInner">
      <div class="cardHeader">
        <span class="ownerBadge ${role}">${owner}</span>
        <span class="typeIcon">${u.type}</span>
      </div>
      <div class="cardName" id="nm-${role}">${u.name}</div>
      <div class="artArea" id="art-${role}">${img}</div>
      <div class="statsArea">
        <div class="hpRow">
          <span class="hpLabel">HP</span>
          <div class="hpNum">
            <span class="hpCurr" id="hpnum-${role}">${u.hp}</span>
            <span class="hpSlash">/</span>
            <span class="hpMax">${u.maxhp}</span>
          </div>
        </div>
        <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
        <div class="statusRow">${badges}</div>
      </div>
      <div class="bottomSection">
        <div class="skillInfo">
          <div class="skillN">æŠ€: ${skill[0]}</div>
          <div class="skillD">${skill[1]}</div>
        </div>
        <div class="spRow">${pips}</div>
        <div class="footer">
          <span class="typeBadge" style="color:#94a3b8;font-size:10px">ATK:${u.atk} DEF:${u.def} EVA:${u.eva}%</span>
          <button class="btnStat" onclick="window._sh('${u.name}')">è©³ç´°</button>
        </div>
      </div>
    </div>
  </div>`;
}

function renderSides(){
  $('leftWrap').innerHTML  = renderCard(left(),'ally');
  $('rightWrap').innerHTML = renderCard(right(),'enemy');
  fitName(qs('#nm-ally'));
  fitName(qs('#nm-enemy'));
  buildBoxes();
  updateSPBtn();
  updateHPUI('ally',left().hp,left().maxhp);
  updateHPUI('enemy',right().hp,right().maxhp);
  checkAffinity();
}

/* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
window._sh = (n)=>{
  const u = [...state.A.team,...state.B.team].find(x=>x.name===n);
  if(!u) return;
  const skill = SKILLS[u.name] || ['?','?'];
  const html = `
    <div style="text-align:center;margin-bottom:12px">
      <h2 style="margin:0;color:${typeColor(u.type)};font-size:20px">${u.name}</h2>
      <div style="font-size:12px;color:#ccc;margin-top:4px">[${u.rank}ãƒ©ãƒ³ã‚¯ / ${u.type}ã‚¿ã‚¤ãƒ—]</div>
    </div>
    <div class="setupMini" style="margin-bottom:12px;background:rgba(0,0,0,0.3)">
      <div class="statGrid" style="gap:12px">
        ${barRow('HP',u.hp,u.maxhp)}
        ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)}
        ${barRow('EVA',u.eva,30)}
      </div>
    </div>
    <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;border:1px solid #444">
      <div style="font-weight:bold;color:#ffd900;margin-bottom:6px;font-size:14px">å¿…æ®ºæŠ€: ${skill[0]}</div>
      <div style="font-size:12px;line-height:1.5;color:#ccc">${skill[1]}</div>
    </div>`;
  $('infoBody').innerHTML = html;
  $('infoModal').classList.add('show');
};

/* å¿…æ®ºå‰å‡¦ç† */
function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
  let mult=1, multiSeq=null, skillTitle='é€šå¸¸æ”»æ’ƒ', skillUser=att.name, notes=[];
  const useName=forcedName ?? att.name;
  const [title] = (SKILLS[useName]||['â€”','â€”']);
  skillTitle=title;
  switch(useName){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': mult=2.2; break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': mult=1; notes.push('å‘³æ–¹å…¨å“¡å›å¾©'); break;
    case 'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š': mult=1.6; att.endure=true; showFloatingText(role==='ally'?'leftWrap':'rightWrap','æ ¹æ€§','buff'); break;
    case 'ãã¼ã‚ã”ã¯ã‚“': multiSeq=[0.75,0.5,0.25]; break;
    case 'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©': mult=1.5; att.atk13=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ATK UP','buff'); break;
    case 'æ¯›ã‚€ãã˜ã‚ƒã‚‰': mult=1.4; att.eva60=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','å›é¿UP','buff'); break;
    case 'ä¹å“ä»': mult=1.6; att.shield=2; showFloatingText(role==='ally'?'leftWrap':'rightWrap','è»½æ¸›','buff'); break;
    case 'ã‘ã‚“ã¡ã‚“æ±': mult=1.2; notes.push('è‡ªå·±å›å¾©'); break;
    case 'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶':
    case 'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦':
    case 'ãƒãƒ«ã‚µãƒŸã‚³é…¢':
    case 'ãƒãƒ“ãƒ­ãƒ³æ•å›š':
    case 'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³':
    case 'ã‚¯ãƒãƒ³ãƒãƒ':
    case 'ç…§ã‚Šç„¼ããƒã‚­ãƒ³':
      def.lock=4; showFloatingText(role==='ally'?'rightWrap':'leftWrap','LOCKED','debuff'); break;
    case 'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©':
    case 'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´':
    case 'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶':
    case 'ã•ã‚‹ã³ã‚ä¸¸':
      def.stun=true; showFloatingText(role==='ally'?'rightWrap':'leftWrap','ã‚¹ã‚¿ãƒ³','debuff'); break;
    case 'ãƒ”ãƒ­ãƒªèŒ':
    case 'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ':
    case 'é³¥å–ç ‚ä¸˜':
    case 'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ':
    case 'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ':
    case 'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«':
    case 'ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­':
      def.selfHurt=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','å´©å£Š','debuff'); break;
    case 'æ¸¡æ¥äºº':
    case 'çœŒåºæ‰€åœ¨åœ°':
      def.doom=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','æ–‡å­—åŒ–ã‘','debuff'); break;
    case 'æœ¬è³ª':
    case 'è¦‹ãˆã‚‹åŒ–':
    case 'è‡ªåˆ†ã”ã¨åŒ–':
    case 'è§£åƒåº¦':
      if(!mirrorMode){ mult=2.0; skillTitle='é¡æ–‡å­—'; }
      break;
  }
  return {mult,multiSeq,skillTitle,skillUser,notes};
}

/* å¿…æ®ºå¾Œå‡¦ç† */
async function spEffectPost(att,def,role,usedName){
  switch(usedName){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ':
      if(role==='ally') state.B.sp=0; else state.A.sp=0;
      break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': {
      const team = role==='ally'?state.A.team:state.B.team;
      team.forEach(u => {
        if(u.hp<u.maxhp) u.hp = Math.min(u.maxhp,u.hp+60);
      });
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+60','heal');
      renderSides();
      break;
    }
    case 'ã‘ã‚“ã¡ã‚“æ±':
      att.hp = Math.min(att.maxhp, att.hp+150);
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+150','heal');
      renderSides();
      break;
  }
}

/* ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã®çŠ¶æ…‹å‡¦ç† */
async function startOfAction(side){
  const me = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  if(me.eva60>0) me.eva60--;
  if(me.atk13>0) me.atk13--;
  if(me.lock>0) me.lock--;
  if(me.doom>0){
    me.doom--;
    if(me.doom<=0){
      me.hp=0;
      renderSides();
      showFloatingText(side==='ally'?'leftWrap':'rightWrap','æ–‡å­—åŒ–ã‘ã§å€’ã‚ŒãŸâ€¦','debuff',{duration:2200});
      qs(side==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${me.name}ã¯æ–‡å­—åŒ–ã‘ã§å€’ã‚ŒãŸï¼`,'highlight');
      const ended = await handleKO(side);
      return !ended;
    }
  }
  if(me.stun){
    me.stun=false;
    renderSides();
    log(`${me.name}ã¯å‹•ã‘ãªã„ï¼`,'highlight');
    await delay(1000);
    return false;
  }
  return true;
}

function judge(a,b){
  if(a===b) return 0;
  if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G')) return 1;
  return -1;
}
function baseDamage(att,def){
  let mult = typeMult(att.type,def.type);
  let val = 100 * (1 + att.atk/100) / (1 + def.def/120) * mult;
  return val * (Math.random()*0.4+0.8);
}

/* æ”»æ’ƒå‡¦ç†æœ¬ä½“ */
async function doTurn(side){
  const att = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  let   def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse = (side==='ally' && state.spOn && state.A.sp>=6) ||
                (side==='enemy' && state.B.sp>=6);

  let mult=1, multi=null, skillTitle='é€šå¸¸æ”»æ’ƒ', usedName=att.name;

  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; }
    else{ state.B.sp=0; }
    playSE('skill');

    if(['æœ¬è³ª','è¦‹ãˆã‚‹åŒ–','è‡ªåˆ†ã”ã¨åŒ–','è§£åƒåº¦'].includes(att.name)){
      const foe = (side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X' && u.hp>0);
      if(foe.length){
        const pick = foe[Math.floor(Math.random()*foe.length)];
        const pre = spEffectPre(att,def,side,pick.name,true);
        mult = pre.mult*2.0;
        multi = pre.multiSeq ? pre.multiSeq.map(x=>x*2.0) : null;
        skillTitle = pre.skillTitle;
        usedName   = pick.name;
        await showCutIn(skillTitle,att.name);
        log(`é¡æ–‡å­—ï¼š${pick.name}ã‚’ã‚³ãƒ”ãƒ¼ï¼`,'sp');
      }else{
        mult = 2.0;
        skillTitle='é¡æ–‡å­—';
        await showCutIn(skillTitle,att.name);
      }
    }else{
      const pre = spEffectPre(att,def,side);
      mult  = pre.mult;
      multi = pre.multiSeq;
      skillTitle = pre.skillTitle;
      await showCutIn(skillTitle,att.name);
      if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
    }
  }else{
    log(`${att.name}ã®æ”»æ’ƒ`,'atk');
    await delay(400);
  }

  const eva = def.eva60>0?60:def.eva;
  if(!spUse && Math.random() < (eva/100)){
    showFloatingText(side==='ally'?'rightWrap':'leftWrap','MISS','miss');
    log('æ”»æ’ƒã‚’å›é¿ã—ãŸï¼','miss');
    await delay(800);
    return false;
  }

  let targetRole = side==='ally'?'enemy':'ally';
  const dmgList = (Array.isArray(multi)?multi:[mult]);

  for(let i=0;i<dmgList.length;i++){
    let m = dmgList[i];
    let base = baseDamage(att,def)*m;
    if(att.atk13>0) base *= 1.3;
    if(def.shield>0){
      base *= 0.5;
      def.shield--;
      showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','GUARD','buff');
    }

    let damage = Math.max(1,Math.floor(base));
    def.hp = Math.max(0,def.hp-damage);
    updateHPUI(targetRole,def.hp,def.maxhp);

    playSE('hit');
    qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit');
    shakeScreen();
    showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap',`-${damage}`,'dmg');
    log(`${def.name}ã« ${damage} ãƒ€ãƒ¡ãƒ¼ã‚¸`,'dmg');
    await delay(1200);
    const hitUnit = qs('.unit.hit');
    if(hitUnit) hitUnit.classList.remove('hit');

    if(def.hp<=0 && def.endure){
      def.endure=false;
      def.hp=1;
      updateHPUI(targetRole,1,def.maxhp);
      showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','æ ¹æ€§','buff');
      log('æ ¹æ€§ã§è€ãˆãŸï¼','highlight');
    }else if(def.hp<=0){
      qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${def.name}ã¯å€’ã‚ŒãŸï¼`,'highlight');
      const ended = await handleKO(targetRole==='enemy'?'enemy':'ally');
      if(ended) return true;
      if(i<dmgList.length-1){
        def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
        targetRole = side==='ally'?'enemy':'ally';
      }
    }
  }

  if(att.selfHurt>0){
    att.selfHurt--;
    if(Math.random()<0.33){
      log('ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼','dmg');
      att.hp = Math.max(0,att.hp-100);
      const myRole = side==='ally'?'ally':'enemy';
      updateHPUI(myRole,att.hp,att.maxhp);
      showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','-100','dmg');
      if(att.hp<=0){
        showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','å´©å£Šã§è‡ªæ»…','debuff',{duration:2200});
        qs(myRole==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
        await delay(1000);
        log(`${att.name}ã¯è‡ªæ»…ã—ãŸ`,'highlight');
        return await handleKO(side);
      }
    }
  }
  if(spUse) await spEffectPost(att,def,side,usedName);
  return false;
}

/* ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ */
function startRound(){
  state.remain=15;
  $('countNum').textContent=state.remain;
  clearInterval(state.timer);
  state.busy=false;
  lockInputs(false);
  checkAffinity();

  setTimeout(()=>{
    if(state.busy) return;
    const cpu = right();
    const player = left();
    const m = typeMult(cpu.type,player.type);
    if(m<=0.7 && cpu.lock===0 && cpu.hp>0){
      const reserves = [0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0);
      const best = reserves.find(i => typeMult(state.B.team[i].type,player.type)>=1.5);
      if(best!==undefined && Math.random()<0.7){
        cpuSwitchAction(best);
        return;
      }
    }
  },1200);

  state.timer=setInterval(()=>{
    if(state.busy) return;
    state.remain--;
    $('countNum').textContent=state.remain;
    if(state.remain<=0){
      pick(['G','C','P'][Math.floor(Math.random()*3)]);
    }
  },1000);
}

/* CPUäº¤ä»£ */
async function cpuSwitchAction(nextIdx){
  state.busy=true;
  clearInterval(state.timer);
  lockInputs(true);
  try{
    log('CPUãŒäº¤ä»£ã‚’é¸æŠï¼','highlight');
    await delay(1000);
    state.B.i = nextIdx;
    state.B.sp = 0;
    state.suppressAffToastOnce = true;
    renderSides();
    showFloatingText('rightWrap',`äº¤ä»£ï¼\nã‚†ã‘ã€${right().name}`,'info',{duration:2200});
    log(`ç›¸æ‰‹ã¯ ${right().name} ã«äº¤ä»£ã—ãŸï¼`,'highlight');
    await delay(1000);
    log('ç›¸æ‰‹ã®éš™ã ï¼æ”»æ’ƒã®ãƒãƒ£ãƒ³ã‚¹ï¼','highlight');
    const ended = await doTurn('ally');
    if(!ended){
      state.A.sp=Math.min(6,state.A.sp+1);
      state.B.sp=Math.min(6,state.B.sp+1);
      startRound();
    }
  }catch(e){
    console.error(e);
    startRound();
  }finally{
    state.busy=false;
    lockInputs(false);
  }
}

/* ã˜ã‚ƒã‚“ã‘ã‚“å…¥åŠ› */
async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true;
  clearInterval(state.timer);
  lockInputs(true);
  try{
    const cpu = ['G','C','P'][Math.floor(Math.random()*3)];
    const res = judge(h,cpu);
    await playJankenAnim(h,cpu,res);

    let ko=false;
    if(res>0){
      if(await startOfAction('ally')) ko = await doTurn('ally');
    }else if(res<0){
      if(await startOfAction('enemy')) ko = await doTurn('enemy');
    }
    if(!ko){
      state.A.sp=Math.min(6,state.A.sp+1);
      state.B.sp=Math.min(6,state.B.sp+1);
      if(state.A.sp<6) state.spAnnA=false;
      renderSides();
      log('æ¬¡ã®ã‚¿ãƒ¼ãƒ³','normal');
      await delay(600);
      startRound();
    }
  }catch(e){
    console.error(e);
    startRound();
  }
}

/* KOå‡¦ç† */
async function handleKO(side){
  playSE('ko');
  const team = side==='ally'?state.A.team:state.B.team;
  const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);

  if(survivors.length===0){
    stopBGM();
    $('resTitle').textContent = side==='enemy'?'YOU WIN!':'YOU LOSE...';
    $('result').classList.add('show');
    await delay(3000);
    $('result').classList.remove('show');
    $('battle').style.display='none';
    $('setup').style.display='grid';
    return true;
  }

  if(side==='enemy'){
    state.B.i = survivors[0].i;
    state.B.sp = 0;
    state.suppressAffToastOnce = true;
    renderSides();
    showFloatingText('rightWrap',`äº¤ä»£ï¼\nã‚†ã‘ã€${team[state.B.i].name}`,'info',{duration:2200});
    log(`ç›¸æ‰‹ã¯ ${team[state.B.i].name} ã‚’ç¹°ã‚Šå‡ºã—ãŸ`,'highlight');
    await delay(1000);
    startRound();
    return true;
  }

  forceSwitch = true;
  openForceSwitch(survivors.map(o=>o.i));
  return true;
}

/* äº¤ä»£UI */
let swModal, swGrid, swDo, swIdx = null;

function openSwitch(){
  if(left().lock>0){
    log('è¨€è«–çµ±åˆ¶ã«ã‚ˆã‚Šäº¤ä»£ä¸å¯ï¼','highlight');
    showFloatingText('leftWrap','LOCKED','debuff');
    return;
  }
  forceSwitch = false;
  if(!swModal || !swGrid || !swDo) return;

  swGrid.innerHTML = '';
  swIdx = null;
  swDo.disabled = true;

  const idxs = [0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!idxs.length){
    log('äº¤ä»£ã§ãã‚‹æ§ãˆãŒã„ã¾ã›ã‚“');
    return;
  }
  const enemy = right();
  idxs.forEach(i=>{
    const u = state.A.team[i];
    const skill = SKILLS[u.name]||['?','?'];
    const m = typeMult(u.type,enemy.type);
    let affText='ãƒ¼ ç­‰å€', affClass='color:#8ba0c0';
    if(m>=1.5){ affText='â— æœ‰åˆ©'; affClass='color:#4effa5'; }
    if(m<=0.7){ affText='â–³ ä¸åˆ©'; affClass='color:#ff5c6c'; }

    const div = document.createElement('div');
    div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`
      <div class="head"><div>${u.name}</div></div>
      <div style="font-size:11px;font-weight:bold;${affClass};margin-bottom:4px">å¯¾ ${enemy.name}: ${affText}</div>
      <div class="statGrid">
        ${barRow('HP',u.hp,u.maxhp)}
        ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)}
        ${barRow('EVA',u.eva,30)}
      </div>
      <div style="font-size:10px;color:#ccc;margin-top:4px">å¿…æ®º: ${skill[0]}</div>`;
    div.onclick=()=>{
      document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected'));
      div.classList.add('selected');
      swIdx = i;
      swDo.disabled = false;
    };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}
function openForceSwitch(indices){
  if(!swModal || !swGrid || !swDo) return;
  swGrid.innerHTML='';
  swIdx=null;
  swDo.disabled=true;
  const enemy = right();

  indices.forEach(i=>{
    const u = state.A.team[i];
    if(u.hp<=0) return;
    const skill = SKILLS[u.name]||['?','?'];
    const m = typeMult(u.type,enemy.type);
    let affText='ãƒ¼ ç­‰å€', affClass='color:#8ba0c0';
    if(m>=1.5){ affText='â— æœ‰åˆ©'; affClass='color:#4effa5'; }
    if(m<=0.7){ affText='â–³ ä¸åˆ©'; affClass='color:#ff5c6c'; }

    const div=document.createElement('div');
    div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`
      <div class="head"><div>${u.name}</div></div>
      <div style="font-size:11px;font-weight:bold;${affClass};margin-bottom:4px">å¯¾ ${enemy.name}: ${affText}</div>
      <div class="statGrid">
        ${barRow('HP',u.hp,u.maxhp)}
        ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)}
        ${barRow('EVA',u.eva,30)}
      </div>
      <div style="font-size:10px;color:#ccc;margin-top:4px">å¿…æ®º: ${skill[0]}</div>`;
    div.onclick=()=>{
      document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected'));
      div.classList.add('selected');
      swIdx=i;
      swDo.disabled=false;
    };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}

/* DOM æ§‹ç¯‰å¾Œ */
document.addEventListener('DOMContentLoaded', () => {
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  makeTeam($('teamA'),'A');
  makeTeam($('teamB'),'B');

  $('btnStart').onclick = async () => {
    state.A.team = collect('A');
    state.B.team = collect('B');
    state.A.i = 0; state.B.i = 0;
    state.A.sp = 0; state.B.sp = 0;
    state.spOn = false; state.spAnnA = false;
    state.history = new Set();
    state.suppressAffToastOnce = false;

    $('battleLog').innerHTML = '';
    $('setup').style.display = 'none';
    const battle = $('battle');
    battle.style.display = 'flex';   // flexã§1ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    playBGM();
    preloadImgs([...state.A.team,...state.B.team].map(u=>u.name));
    renderSides();
    log('ãƒãƒˆãƒ«é–‹å§‹ï¼','highlight');
    showFloatingText('leftWrap','ãƒãƒˆãƒ«é–‹å§‹ï¼','info',{duration:1800});
    checkAffinity();
    await delay(800);
    startRound();
  };

  $('btnG').onclick = () => pick('G');
  $('btnC').onclick = () => pick('C');
  $('btnP').onclick = () => pick('P');
  $('btnSP').onclick = () => {
    if(!inputLocked && state.A.sp>=6){
      state.spOn = !state.spOn;
      updateSPBtn();
    }
  };
  $('btnRand').onclick = () => {
    randomizeTeam('A');
    randomizeTeam('B');
  };
  $('btnRules').onclick   = () => $('rulesModal').classList.add('show');
  $('rulesClose').onclick = () => $('rulesModal').classList.remove('show');
  $('infoClose').onclick  = () => $('infoModal').classList.remove('show');

  const btnBack = $('btnBack');
  if(btnBack){
    btnBack.onclick = () => {
      window.location.href = 'https://kyoryu1039.github.io/kotoba-gacha/';
    };
  }

  // äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
  swModal = $('switchModal');
  swGrid  = $('switchGrid');
  swDo    = $('swDo');
  swIdx   = null;

  const btnSwitch = $('btnSwitch');
  const swCancel  = $('swCancel');

  if(btnSwitch) btnSwitch.onclick = () => { if(!inputLocked) openSwitch(); };
  if(swCancel && swModal) swCancel.onclick = () => swModal.classList.remove('show');
  if(swDo){
    swDo.onclick = async () => {
      if(swIdx === null) return;
      swModal.classList.remove('show');

      const newUnit = state.A.team[swIdx];
      state.A.i = swIdx;
      state.A.sp = 0;
      state.spOn = false;
      state.suppressAffToastOnce = true;
      renderSides();
      showFloatingText('leftWrap',`äº¤ä»£ï¼\nã‚†ã‘ã€${newUnit.name}`,'info',{duration:2200});
      log(`${newUnit.name} ã«äº¤ä»£ï¼`,'highlight');

      if(forceSwitch){
        forceSwitch = false;
        await delay(600);
        startRound();
      }else{
        await delay(500);
        const ended = await doTurn('enemy');
        if(!ended){
          state.A.sp=Math.min(6,state.A.sp+1);
          state.B.sp=Math.min(6,state.B.sp+1);
          startRound();
        }
      }
    };
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  ['switchModal','infoModal','rulesModal'].forEach(id => {
    const el = $(id);
    if(!el) return;
    el.addEventListener('click', e => {
      if(e.target === el) el.classList.remove('show');
    });
  });
});
})(); 
</script>
</body>
</html>
