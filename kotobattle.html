<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | v30.01 Final Debug</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#020617">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Teko:wght@500;700&family=M+PLUS+1p:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #020617; --text: #f1f5f9;
  --glass: rgba(15, 23, 42, 0.85);
  --border-color: rgba(255, 255, 255, 0.15);
  
  --ally: #3b82f6; --enemy: #ef4444;
  --hp: #10b981; --gauge: #eab308;
  
  --t-„Ç∏„Ç™:#38bdf8; --t-„Ç¢„Éã„Éû„É´:#4ade80; --t-„Éï„Éº„Éâ:#ffaa2b; 
  --t-„Ç≥„É≥„Çª„Éó„Éà:#c084fc; --t-„Çµ„Ç§„Ç®„É≥„Çπ:#22d3ee; --t-„Éí„Çπ„Éà„É™„Éº:#f472b6; --t-„Éí„É•„Éº„Éû„É≥:#a3e635;

  --glow-A: #ffd700;
  --glow-B: #c0c0c0;
  --glow-C: #64748b;
  --glow-D: #ffffff;
  --glow-X: #d946ef;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0;overflow:hidden}
body{
  background-color: var(--bg); color: var(--text);
  font-family: 'Noto Sans JP', sans-serif; overflow-y: auto;
  background-image: radial-gradient(circle at 50% 30%, #1e293b 0%, #020617 80%);
}

/* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
.bg-anim {
  position: fixed; inset: 0; z-index: -1;
  background: 
    linear-gradient(transparent 95%, rgba(59, 130, 246, 0.1) 96%, transparent 100%),
    linear-gradient(90deg, transparent 95%, rgba(59, 130, 246, 0.1) 96%, transparent 100%);
  background-size: 40px 40px;
  animation: gridMove 20s linear infinite;
  perspective: 1000px; transform-style: preserve-3d;
}
@keyframes gridMove { from { transform: translateY(0); } to { transform: translateY(40px); } }

.container{max-width:800px;margin:0 auto;padding:8px;padding-bottom:160px}

.card {
  background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color);
  border-radius: 12px; margin-bottom: 12px; backdrop-filter: blur(12px);
}
.card h2 {
  margin:0; padding:10px 14px; font-size:14px; font-weight:800; color: #e2e8f0;
  background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-color);
  display: flex; justify-content: space-between; align-items: center;
}
.card .body { padding: 12px; }

/* „Éú„Çø„É≥ */
.btn3d {
  appearance: none; border: none; cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif; font-weight: 800; font-size: 14px; color: #fff;
  padding: 10px 16px; border-radius: 8px; transition: .1s;
  display: inline-flex; justify-content: center; align-items: center; gap: 6px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.btn3d:active:not([disabled]) { transform: translateY(2px); filter: brightness(0.9); }
.btn3d:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

.btn-primary { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); box-shadow: 0 4px 0 #1e3a8a; }
.btn-ghost { background: linear-gradient(to bottom, #475569, #1e293b); box-shadow: 0 4px 0 #0f172a; border: 1px solid rgba(255,255,255,0.1); }
.btnTiny { padding: 4px 8px; font-size: 10px; border-radius: 4px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); color: #cbd5e1; cursor: pointer; }

/* Á∑®ÊàêÁîªÈù¢ */
#setup { display: grid; gap: 12px; }
#teamGrid { display: grid; gap: 8px; }
@media(min-width:600px){ #teamGrid { grid-template-columns: 1fr 1fr; } }
.slot { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
.pill { width: 20px; height: 20px; border-radius: 4px; background: #334155; color: #fff; font-weight: 800; font-size: 11px; display: grid; place-items: center; }
.slot select { flex: 1; background: transparent; border: none; color: #fff; font-weight: 800; font-size: 13px; outline: none; }
.slot select option { background: #0f172a; color: #fff; }

#statsGrid { display: grid; gap: 10px; }
@media(min-width:720px){ #statsGrid { grid-template-columns: 1fr 1fr; } }
.statsCol { display: grid; gap: 8px; }
.setupMini { border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; background: rgba(30, 41, 59, 0.6); display: flex; flex-direction: column; gap: 4px;}

.barRow{margin:2px 0;display:grid;grid-template-columns:40px 1fr 36px;align-items:center;gap:4px;font-size:10px}
.barLabel{color:#9ca3af}
.barBox{height:6px;background:#020617;border-radius:3px;overflow:hidden}
.barFill{height:100%;background:var(--hp);}

/* ‰∫§‰ª£„É¢„Éº„ÉÄ„É´„ÅßÈÅ∏Êäû‰∏≠„ÅÆ„Ç´„Éº„Éâ„ÅÆÊû†„ÇíÂº∑Ë™ø */
.selCard {
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
}
.selCard.selected {
  border: 2px solid #facc15;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.7),
              0 0 16px rgba(250, 204, 21, .8);
  transform: translateY(-2px);
}

/* „Éê„Éà„É´ÁîªÈù¢ */
.arena { display: grid; gap: 12px; transition: transform .1s; }
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-2px,1px)}20%,80%{transform:translate(1px,-2px)}30%,50%,70%{transform:translate(-4px,2px)}40%,60%{transform:translate(4px,-2px)}}
.vsrow { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: stretch; }
.vsrow > div { min-width: 0; }

/* === „É¶„Éã„ÉÉ„Éà„Ç´„Éº„Éâ === */
.unit {
  position: relative; width: 100%; height: 100%; min-height: 280px;
  border-radius: 14px;
  padding: 3px; 
  background: #334155;
  box-shadow: 0 10px 30px rgba(0,0,0,0.7);
  display: flex; flex-direction: column; overflow: hidden;
  transition: filter 0.3s;
}

/* „É©„É≥„ÇØÂà• Êû†Á∑öË®≠ÂÆö */
.unit[data-rank="S"] { 
  background: linear-gradient(60deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); 
  background-size: 300% 300%; 
  animation: rainbowBorder 3s linear infinite; 
}

/* A„É©„É≥„ÇØ */
.unit[data-rank="A"] {
  position: relative;
  border: 1px solid #ffd700;
  overflow: hidden;
}
.unit[data-rank="A"]::after {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: linear-gradient(
     115deg,
     transparent 40%,
     rgba(255,255,255,0.35) 50%,
     transparent 60%
  );
  animation: shineA 3.5s ease-in-out infinite;
}
@keyframes shineA {
  0%   { transform: translate(0,0); }
  100% { transform: translate(150%,150%); }
}

/* B„É©„É≥„ÇØ */
.unit[data-rank="B"] {
  position: relative;
  border: 1px solid #e5e7eb;
  overflow: hidden;
}
.unit[data-rank="B"]::after {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: linear-gradient(
    115deg,
    transparent 40%,
    rgba(255,255,255,0.25) 50%,
    transparent 60%
  );
  animation: shineB 4.2s ease-in-out infinite;
}
@keyframes shineB {
  0%   { transform: translate(0,0); }
  100% { transform: translate(150%,150%); }
}

/* C„É©„É≥„ÇØ */
.unit[data-rank="C"] {
  background: #64748b;
  border: 1px solid #475569;
}

/* D„É©„É≥„ÇØ */
.unit[data-rank="D"] {
  background: #ffffff;
  border: 1px solid #d1d5db;
}

/* X„É©„É≥„ÇØ */
.unit[data-rank="X"] {
  background: #d946ef;
  border: 1px solid #9333ea;
}

@keyframes rainbowBorder { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

/* „Ç´„Éº„ÉâÊú¨‰Ωì */
.unitInner {
  position: relative; z-index: 1; flex: 1; display: flex; flex-direction: column;
  background: linear-gradient(160deg, #1e293b, var(--typeColor), #0f172a);
  border-radius: 11px; padding: 4px; overflow: hidden;
}

/* S„É©„É≥„ÇØË°®Èù¢„Ç≠„É©„Ç≠„É© */
.unit[data-rank="S"]::after {
  content: ""; position: absolute; inset: 0; z-index: 10; pointer-events: none;
  background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.4) 50%, transparent 55%);
  background-size: 250% 250%; animation: shine 3.5s infinite linear; mix-blend-mode: overlay;
}
@keyframes shine{0%{background-position:200% 200%}100%{background-position:-50% -50%}}

.unit.fall { animation: fallDown 0.8s forwards; filter: grayscale(1) brightness(0.4); }
@keyframes fallDown { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(80px) rotate(20deg); opacity: 0; } }

.cardHeader {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 8px; background: rgba(0,0,0,0.5); border-radius: 8px 8px 0 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.ownerBadge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; background: #020617; border: 1px solid #334155; color: #94a3b8; letter-spacing: 0.05em; }
.typeIcon { font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 6px; background: var(--typeColor); color: #0b0f1c; box-shadow: 0 2px 4px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); }

.cardName {
  font-weight: 900; font-size: 15px; color: #fff;
  text-shadow: 0 2px 4px #000; white-space: nowrap;
  flex: 1; text-align: center; display: block; height: 24px; line-height: 24px;
}

.artArea {
  position: relative; width: 100%; aspect-ratio: 4/3;
  margin: 0; border-radius: 0 0 8px 8px; overflow: hidden;
  background: radial-gradient(circle at center, rgba(255,255,255,0.1), rgba(0,0,0,0.6));
  border: 1px solid rgba(255,255,255,0.1); border-top: none;
  display: flex; align-items: center; justify-content: center;
  box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
}
.mainImg {
  max-height: 95%; max-width: 95%; object-fit: contain;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.7));
  animation: breathe 4s ease-in-out infinite alternate;
}
@keyframes breathe { from { transform: scale(1); } to { transform: scale(1.04); } }
.unit.hit .mainImg { animation: hit .4s ease; }
@keyframes hit{10%,90%{transform:translate(-6px,0)}20%,80%{transform:translate(10px,0)}30%,50%,70%{transform:translate(-10px,0)}40%,60%{transform:translate(10px,0)}}

.statsArea { padding: 8px 6px 6px; background: rgba(15, 23, 42, 0.6); margin-top: -4px; position: relative; z-index: 3; border-radius: 0 0 10px 10px; }
.statusRow { display: flex; gap: 4px; min-height: 14px; margin-top: 4px; justify-content: flex-end; flex-wrap: wrap; }
.stBadge { font-size: 9px; padding: 1px 4px; border-radius: 4px; background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; }

.hpBarBg { width: 100%; height: 10px; background: #0f172a; border-radius: 5px; border: 1px solid #334155; overflow: hidden; }
.hpBar { height: 100%; width: 100%; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s; }
.hpBar.high { background: #10b981; box-shadow: 0 0 8px #10b981; }
.hpBar.mid { background: #eab308; box-shadow: 0 0 8px #eab308; }
.hpBar.low { background: #ef4444; box-shadow: 0 0 8px #ef4444; animation: pulseHP 0.5s infinite alternate; }
@keyframes pulseHP { from { opacity: 1; } to { opacity: 0.6; } }

.bottomSection { flex: 1; display: flex; flex-direction: column; gap: 6px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 6px; }
.spRow { display: flex; gap: 4px; justify-content: center; }
.pip { width: 16px; height: 8px; background: #451a03; border: 1px solid #78350f; border-radius: 2px; transition: .3s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
.pip.on { background: linear-gradient(to bottom, var(--gauge), #d97706); border-color: #fcd34d; box-shadow: 0 0 8px var(--gauge); }

.skillInfo { background: rgba(0,0,0,0.4); padding: 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); flex: 1; min-height: 50px; display:flex; flex-direction:column; justify-content:center; }
.skillN { font-size: 11px; font-weight: 900; color: #fcd34d; margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
.skillD { font-size: 10px; line-height: 1.3; color: #cbd5e1; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.footer { display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #94a3b8; font-family: 'Teko'; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; }
.btnStat { appearance: none; border: none; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #60a5fa; border-radius: 4px; padding: 2px 6px; font-size: 9px; font-weight: 800; cursor: pointer; transition: .2s; }
.btnStat:hover { background: rgba(59, 130, 246, 0.4); color: #fff; }

/* Êìç‰Ωú„Éë„ÉÉ„Éâ */
.padCard {
  position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50;
  background: rgba(15, 23, 42, 0.95); border-top: 1px solid #334155;
  box-shadow: 0 -4px 24px rgba(0,0,0,0.8); padding: 10px 16px 20px;
  backdrop-filter: blur(12px);
}
@media(min-width: 800px) {
  .padCard {
    position: relative; border-radius: 20px; margin-top: 16px; background: var(--glass); padding: 20px;
  }
}

.padHead {
  display: flex; justify-content: center; align-items: center;
  margin-bottom: 6px; font-size: 12px; color: #94a3b8; font-family: 'Teko'; letter-spacing: 1px;
}
.timerVal { font-size: 24px; color: #fff; font-weight: 600; margin-left: 4px; }

/* Êéß„ÅàË°®Á§∫ÔºöÊ®™‰∏ÄÂàó„Éª„Éë„Éç„É´Áõ¥‰∏äÂõ∫ÂÆöÔºà„Çπ„Éû„ÉõÂØæÂøúÔºâ */
.benchRow {
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:8px;
  padding:4px 0;
  overflow-x:auto;
  scrollbar-width:thin;
}
.benchRow::-webkit-scrollbar{height:4px}
.benchRow::-webkit-scrollbar-thumb{background:#475569;border-radius:999px}
.benchLabel{
  font-weight:900;
  font-family:'Teko';
  font-size:11px;
  flex:0 0 auto;
}
.resIcon { 
  width: 26px; height: 26px; border-radius: 4px; background: #1e293b; 
  border: 2px solid; color: #fff; font-size: 10px; display: grid; place-items: center; 
  cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-weight: 800;
  flex:0 0 auto;
}
.resIcon.dead { opacity: 0.3; filter: grayscale(1); cursor: default; border-color: #333 !important; }
.resIcon.active { border-color: #fff !important; box-shadow: 0 0 6px #fff; transform: scale(1.1); z-index: 2; }

.padInner { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center; max-width: 600px; margin: 0 auto; }
.rpsArea { display: flex; gap: 16px; justify-content: center; }
.rps {
  width: 64px; height: 64px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.15); cursor: pointer;
  display: grid; place-items: center; position: relative; top: 0; transition: all .1s;
  box-shadow: 0 8px 0 rgba(0,0,0,0.5), 0 12px 24px rgba(0,0,0,0.4);
}
.rps:active:not([disabled]) { top: 8px; box-shadow: none; }
.rps.g { background: linear-gradient(145deg, #ef4444, #b91c1c); color: #fff; }
.rps.c { background: linear-gradient(145deg, #3b82f6, #1d4ed8); color: #fff; }
.rps.p { background: linear-gradient(145deg, #22c55e, #15803d); color: #fff; }
.rps:disabled { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; top: 8px; box-shadow: none; }
.emo { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }

.sideBtns { display: flex; flex-direction: column; gap: 8px; width: 120px; }
.cmdBtn {
  width: 100%; padding: 10px 0; border-radius: 8px; font-weight: 800; font-size: 13px;
  border: none; cursor: pointer; color: #fff; position: relative; top: 0; transition: .1s;
  box-shadow: 0 4px 0 rgba(0,0,0,0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.cmdBtn:active:not([disabled]) { top: 4px; box-shadow: none; }
.cmdBtn:disabled { opacity: 0.5; top: 4px; box-shadow: none; cursor: not-allowed; filter: grayscale(1); }
.btn-sp { background: linear-gradient(to bottom, #334155, #1e293b); color: #94a3b8; }
.btn-switch { background: linear-gradient(to bottom, #8b5cf6, #6d28d9); }

@media(max-width:480px){
  .padCard{padding:8px 10px 14px;}
  .padInner{grid-template-columns:1fr; gap:12px;}
  .sideBtns{flex-direction:row; justify-content:center; width:auto;}
  .sideBtns .cmdBtn{font-size:12px; padding:8px 10px;}
  .rps{width:56px; height:56px;}
}

.btn-sp.ready { 
  background: #f59e0b; color: #fff;
  animation: flashReady 0.2s infinite alternate; 
  border: 2px solid #fff;
}
@keyframes flashReady { from { background: #f59e0b; box-shadow: 0 0 5px #f59e0b; } to { background: #b91c1c; box-shadow: 0 0 20px #ef4444; } }
.btn-sp.on { background: linear-gradient(to bottom, #ef4444, #b91c1c); color: #fff; box-shadow: 0 0 15px #ef4444; animation: pulse 1s infinite; }
@keyframes pulse { 0% { opacity:1; } 50% { opacity:0.8; } 100% { opacity:1; } }

.logWrapper { border: 1px solid #334155; background: rgba(2, 6, 23, 0.8); border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
.logHeader { background: #1e293b; color: #94a3b8; font-size: 10px; padding: 2px 8px; font-weight: 700; font-family: 'Orbitron', 'Noto Sans JP', sans-serif; border-bottom: 1px solid #334155; }
.logContainer { height: 80px; overflow-y: auto; padding: 8px; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
.logLine { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.logLine.highlight { color: #fbbf24; }
.logLine.dmg { color: #fca5a5; }
.logLine.heal { color: #6ee7b7; }

/* „Éà„Éº„Çπ„ÉàÔºö„Éï„Ç©„É≥„ÉàÔºÜ‰ΩçÁΩÆË™øÊï¥ */
.floatingText {
  position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%);
  font-family: 'M PLUS 1p','Noto Sans JP',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  font-weight: 700;
  font-size: 26px;
  color: #fff; letter-spacing: 0.04em;
  text-shadow:
    -2px -2px 0 rgba(0,0,0,0.9),
     2px -2px 0 rgba(0,0,0,0.9),
    -2px  2px 0 rgba(0,0,0,0.9),
     2px  2px 0 rgba(0,0,0,0.9),
     0 0 16px var(--glow-color, rgba(255,255,255,0.4));
  pointer-events: none; z-index: 20;
  animation: popUp 2.0s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  white-space: pre-wrap;
  text-align:center;
  max-width: 80vw;
  padding:4px 10px;
  border-radius:6px;
  background:rgba(15,23,42,0.6);
}

/* Á®ÆÈ°ûÂà• */
.floatingText.dmg { color: #f97373; --glow-color: #f97373; }
.floatingText.heal { color: #4ade80; --glow-color: #4ade80; }
.floatingText.miss { color: #e5e7eb; --glow-color: #9ca3af; font-size: 22px; }
.floatingText.buff { color: #facc15; --glow-color: #facc15; font-size: 22px; }
.floatingText.debuff { color: #c4b5fd; --glow-color: #a855f7; font-size: 22px; }
.floatingText.info { color:#e5e7eb; --glow-color:#38bdf8; }

/* Áõ∏ÊÄß„Éà„Éº„Çπ„Éà„ÅØ‰∏äÈÉ®„Å´Â∞è„Åï„Åè */
.floatingText.advTop,
.floatingText.disTop {
  top: 16%;
  font-size: 18px;
}

/* Áõ∏ÊÄßÊúâÂà©„Éª‰∏çÂà©Ëâ≤ */
.floatingText.advTop { color:#4ade80; --glow-color:#34d399; }
.floatingText.disTop { color:#f97373; --glow-color:#f97373; }

@keyframes popUp { 
  0% { opacity: 0; transform: translate(-50%, 20px) scale(0.7); } 
  10% { opacity: 1; transform: translate(-50%, -10px) scale(1.05); } 
  80% { opacity: 1; transform: translate(-50%, -10px) scale(1.02); }
  100% { opacity: 0; transform: translate(-50%, -40px) scale(1); } 
}

#jankenOverlay,#cutIn,#switchModal,#infoModal,#rulesModal,#result{position:fixed;inset:0;z-index:100;pointer-events:none;display:none;align-items:center;justify-content:center}
#switchModal,#infoModal,#rulesModal,#result{background:rgba(0,0,0,0.8);pointer-events:auto;backdrop-filter:blur(8px)}
#jankenOverlay.active{display:flex;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)}
#switchModal.show,#infoModal.show,#rulesModal.show,#result.show{display:flex}
.jkWrap{display:flex;flex-direction:column;align-items:center;gap:24px}
.jkHands{display:flex;gap:40px;align-items:center}
.jkHand{font-size:80px;transition:transform .2s cubic-bezier(0.34,1.56,0.64,1);opacity:0;transform:scale(0)}
.jkHand.show{opacity:1;transform:scale(1)}
.jkHand.win{filter:drop-shadow(0 0 30px #fcd34d);transform:scale(1.3) rotate(-15deg);z-index:10}
.jkHand.lose{filter:grayscale(1) brightness(0.4);opacity:0.5;transform:scale(0.8) rotate(15deg)}
.jkResult{font-family:'Teko';font-size:80px;font-weight:700;color:#fff;text-shadow:0 8px 24px #000;opacity:0;transform:translateY(30px);transition:all .3s}
.jkResult.show{opacity:1;transform:translateY(0)}
#cutIn{background:linear-gradient(90deg,transparent,rgba(30,58,138,0.95) 20%,rgba(30,58,138,0.95) 80%,transparent);height:120px;border-top:2px solid #60a5fa;border-bottom:2px solid #60a5fa;flex-direction:column;transform:scaleY(0);transition:.2s}
#cutIn.show{display:flex;transform:scaleY(1)}
.cutInText{font-size:36px;font-weight:900;color:#fff;text-shadow:0 4px 12px #000;font-style:italic;letter-spacing:0.1em}
.cutInSub{font-size:14px;color:#93c5fd;font-weight:700;margin-top:6px}
.modalCard{width:min(500px,92vw);max-height:85vh;overflow-y:auto;background:#0f172a;border:1px solid #334155;border-radius:16px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:popIn 0.3s}
@keyframes popIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
.modalHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid #334155;padding-bottom:10px}
.modalTitle{margin:0;font-size:18px;font-weight:900;color:#fff;font-family:'Noto Sans JP'}

@media(max-width:480px){
  .modalCard{
    max-height:80vh;
    padding:14px;
    border-radius:12px;
  }
  .setupMini{
    padding:6px;
  }
}
</style>
</head>
<body>

<div class="bg-anim"></div>

<div class="container" id="setup">
  <section class="card">
    <h2>TEAM SETUP <button class="btnTiny" id="btnRules">„É´„Éº„É´</button></h2>
    <div class="body">
      <div id="teamGrid">
        <div><div class="statsHead" style="color:#4da6ff;font-weight:900;margin-bottom:8px">YOU</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#ff5c6c;font-weight:900;margin-bottom:8px">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:12px; margin-top:24px">
        <button id="btnRand" class="btn3d btn-ghost" style="flex:0 0 auto">„É©„É≥„ÉÄ„É†</button>
        <button id="btnStart" class="btn3d btn-primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2>STATUS DETAIL</h2>
    <div class="body">
      <div id="statsGrid">
        <div><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div class="container" id="battle" style="display:none">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>
    
    <div class="logWrapper">
      <div class="logHeader">BATTLE LOG</div>
      <div class="logContainer" id="battleLog"></div>
    </div>
    
    <div style="height:180px"></div>
  </div>
  
  <section class="padCard" id="pad">
    <div class="padHead">
      <div style="flex:1"></div>
      <div>TIME <span class="timerVal" id="countNum">15</span></div>
      <div style="flex:1"></div>
    </div>

    <!-- Êéß„ÅàÔºöÊ®™‰∏ÄÂàó„Éª„Éë„Éç„É´Áõ¥‰∏äÂõ∫ÂÆö -->
    <div class="benchRow" id="benchRow"></div>

    <div class="padInner">
      <div class="rpsArea">
        <button class="rps g" id="btnG"><div class="emo">‚úä</div></button>
        <button class="rps c" id="btnC"><div class="emo">‚úåÔ∏è</div></button>
        <button class="rps p" id="btnP"><div class="emo">üñê</div></button>
      </div>
      <div class="sideBtns">
        <button class="cmdBtn btn-sp" id="btnSP" disabled>SP ÂøÖÊÆ∫</button>
        <button class="cmdBtn btn-switch" id="btnSwitch">‰∫§‰ª£</button>
      </div>
    </div>
  </section>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">‚úä</div><div style="color:#fff;font-weight:900;font-size:40px;font-family:'Teko'">VS</div><div class="jkHand" id="jkHandB">‚úåÔ∏è</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">„É°„É≥„Éê„Éº‰∫§‰ª£</h3><button class="btnTiny" id="swCancel">Èñâ„Åò„Çã</button></div><div id="switchGrid"></div><button id="swDo" class="btn3d btn-primary" style="width:100%;margin-top:24px" disabled>„Åì„ÅÆ„Ç≠„É£„É©„Å´‰∫§‰ª£</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„Çπ</h3><button class="btnTiny" id="infoClose">Èñâ„Åò„Çã</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle">„É´„Éº„É´Ë™¨Êòé</h3><button class="btnTiny" id="rulesClose">Èñâ„Åò„Çã</button></div><ul style="padding-left:20px;line-height:2;color:#cbd7f0;font-size:14px;list-style-type:square"><li>3‰Ωì„ÅÆ„ÄåË®ÄËëâ„Äç„Åß„ÉÅ„Éº„É†„ÇíÁµÑ„Çì„ÅßÊà¶„ÅÜ„Çø„Éº„É≥Âà∂„Éê„Éà„É´„ÄÇ</li><li>„Åò„ÇÉ„Çì„Åë„Çì„Å´<strong>Âãù„Å§„Å®ÊîªÊíÉ</strong>„ÄÅ<strong>Ë≤†„Åë„Çã„Å®Èò≤Âæ°</strong>„ÄÇ</li><li><strong>„Çø„Ç§„ÉóÁõ∏ÊÄß</strong>„ÅåÈáçË¶ÅÔºàÊúâÂà©1.5ÂÄç / ‰∏çÂà©0.67ÂÄçÔºâ„ÄÇ</li><li>ÊîªÊíÉ„ÉªË¢´Âºæ„Åß„Ç≤„Éº„Ç∏„ÅåÊ∫ú„Åæ„Çä„ÄÅMAX(6)„Åß<strong>ÂøÖÊÆ∫ÊäÄ</strong>Áô∫ÂãïÔºÅ</li><li>Áõ∏Êâã„ÉÅ„Éº„É†„ÇíÂÖ®Âì°ÂÄí„Åõ„Å∞ÂãùÂà©ÔºÅ</li></ul></div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:48px;background:rgba(15,23,42,0.95)"><h1 id="resTitle" style="color:#fff;margin:0 0 24px;font-size:56px;font-family:'Teko';text-shadow:0 0 30px rgba(255,255,255,0.6)">WIN</h1><p style="color:#94a3b8;font-size:14px;font-family:'Teko';letter-spacing:0.1em">RETURNING TO SETUP...</p></div></div>

<!-- BGM & ÂäπÊûúÈü≥ -->
<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop></audio>
<audio id="seHit" src="audio/hit.mp3"></audio>
<audio id="seSkill" src="audio/skill.mp3"></audio>
<audio id="seKO" src="audio/ko.mp3"></audio>

<script>
(()=>{
'use strict';
const $=id=>document.getElementById(id);
const qs=(s,el=document)=>el.querySelector(s);
const delay=ms=>new Promise(r=>setTimeout(r,ms));

/* ==== BGM & ÂäπÊûúÈü≥ ==== */
function playBGM(){
  const a = $('bgm'); if(!a) return;
  if(a.paused){
    a.volume = 0.25; // ‚òÖ Èü≥Èáè„Çí„Åï„Çâ„Å´‰∏ã„Åí„Åü
    a.play().catch(()=>{});
  }
}
function stopBGM(){
  const a = $('bgm'); if(a){
    a.pause();
    a.currentTime = 0;
  }
}
function playSE(type){
  let el = null;
  if(type === 'hit') el = $('seHit');
  else if(type === 'skill') el = $('seSkill');
  else if(type === 'ko') el = $('seKO');
  if(el){
    try{
      el.currentTime = 0;
      el.play();
    }catch(e){}
  }
}

const IMG={"„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"parabola_antenna.png","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"nescafe_ambassador.png","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"ninjin_shirishiri.png","„Åù„Åº„Çç„Åî„ÅØ„Çì":"soboro_gohan.png","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"western_lowland_gorilla.png","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"kemukujara.png","‰πùÂìÅ‰ªè":"kuhonbutsu.png","„Åë„Çì„Å°„ÇìÊ±Å":"kenchin_jiru.png","„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"kamchatka_peninsula.png","„Çø„É©„É≥„ÉÅ„É•„É©":"tarantula.png","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"shoebill.png","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"balsamic_vinegar.png","„Éî„É≠„É™Ëèå":"helicobacter_pylori.png","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"trinidad_and_tobago.png","„Ç´„É©„É°„É´Ëâ≤Á¥†":"caramel_color.png","„Éê„Éì„É≠„É≥ÊçïÂõö":"babylonian_captivity.png","È≥•ÂèñÁ†Ç‰∏ò":"tottori_sand_dunes.png","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"placebo_effect.png","Ê∏°Êù•‰∫∫":"torai_jin.png","„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"peperoncino.png","„Éù„É™„Éó„É≠„Éî„É¨„É≥":"polypropylene.png","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"sarajevo_incident.png","„ÇØ„Éû„É≥„Éê„ÉÅ":"kumabachi.png","ÁúåÂ∫ÅÊâÄÂú®Âú∞":"prefectural_capital.png","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"teriyaki_chicken.png","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"nerunerunerune.png","„Çπ„É´„É°„Ç§„Ç´":"surume_ika.png","Êú¨Ë≥™":"essence.png","Ë¶ã„Åà„ÇãÂåñ":"mieruka.png","Ëá™ÂàÜ„Åî„Å®Âåñ":"jibungotoka.png","Ëß£ÂÉèÂ∫¶":"resolution.png","„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png"};
function preloadImgs(names){
  const unique=[...new Set(names.map(n=>IMG[n]).filter(Boolean))];
  unique.forEach(f=>{ const im=new Image(); im.src=`images/${f}`; });
}

function log(msg, type='normal'){
  const c=$('battleLog');
  if(!c) return;
  const d=document.createElement('div');
  let icon='';
  if(type==='atk') icon='‚öîÔ∏è'; else if(type==='dmg') icon='üí•'; else if(type==='heal') icon='üíñ'; else if(type==='sp') icon='‚ú®'; else if(type==='miss') icon='üí®';
  d.className='logLine '+type; d.textContent=(icon?icon+' ':'')+msg; c.appendChild(d); c.scrollTop=c.scrollHeight;
}

/* HP UI */
function updateHPUI(role, val, max){
  const bar = $(`hp-${role}`);
  const num = $(`hpnum-${role}`);
  if(bar) {
    const pct = (val/max)*100;
    bar.style.width = `${pct}%`;
    bar.className = 'hpBar';
    if(pct > 50) bar.classList.add('high');
    else if(pct > 20) bar.classList.add('mid');
    else bar.classList.add('low');
  }
  if(num) num.textContent = val;
}

/* ÂêçÂâç„Éï„Ç£„ÉÉ„Éà */
function fitName(el) {
  if(!el) return;
  const len = el.textContent.length;
  if(len > 10) el.style.fontSize = '11px';
  else if(len > 7) el.style.fontSize = '13px';
  else el.style.fontSize = '16px';
}

/* „Éà„Éº„Çπ„ÉàÔºàËá™ÂãïÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥‰ªò„ÅçÔºâ */
function showFloatingText(targetId, text, type, opts={}) {
  const wrap=$(targetId); if(!wrap)return;
  const el=document.createElement('div');
  el.className='floatingText '+type;
  el.textContent=text;
  if(opts.fontSize) el.style.fontSize = opts.fontSize+'px';
  wrap.appendChild(el);

  // ÁîªÈù¢ÂπÖ„Å´Âêà„Çè„Åõ„Å¶„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è
  requestAnimationFrame(()=>{
    const maxWidth = window.innerWidth * 0.8;
    let size = parseFloat(window.getComputedStyle(el).fontSize);
    let rect = el.getBoundingClientRect();
    while(rect.width > maxWidth && size > 14){
      size -= 2;
      el.style.fontSize = size + 'px';
      rect = el.getBoundingClientRect();
    }
  });

  setTimeout(()=>el.remove(), opts.duration || 2000);
}

async function showCutIn(skill, user){
  $('cutInName').textContent=skill; $('cutInUser').textContent=user;
  const el=$('cutIn'); el.classList.add('show');
  await delay(1200); el.classList.remove('show'); await delay(200);
}

function shakeScreen(){
  const a=$('arena'); a.classList.remove('shake'); void a.offsetWidth; a.classList.add('shake');
}

let inputLocked=false;
function lockInputs(on){
  inputLocked = on;
  const p = $('pad');
  if (p) p.style.opacity = on ? 0.6 : 1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id=>{ const el = $(id); if(el) el.disabled = on; });
  updateSPBtn();
}

function updateSPBtn(){
  const btn=$('btnSP'); if(!btn)return;
  const ready=state.A.sp>=6;
  const canPress=!inputLocked && ready && !state.busy;
  btn.disabled=!canPress;
  if(state.spOn){
    btn.innerHTML='<span>‚ú®</span> ÂøÖÊÆ∫ ON'; btn.className='cmdBtn btn-sp on';
  } else {
    if(ready && !inputLocked) {
      btn.innerHTML='<span>‚ú®</span> PUSH!'; btn.className='cmdBtn btn-sp ready';
    } else {
      btn.innerHTML='<span>SP</span> ÂøÖÊÆ∫ÊäÄ'; btn.className='cmdBtn btn-sp';
    }
  }
  if(ready && !state.spAnnA){ log('ÂøÖÊÆ∫„Ç≤„Éº„Ç∏MAXÔºÅ', 'highlight'); state.spAnnA=true; }
}

async function playJankenAnim(myH, cpuH, res){
  const map={G:'‚úä',C:'‚úåÔ∏è',P:'üñê'};
  const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  ov.classList.add('active');
  hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  await delay(50); hA.classList.add('show'); hB.classList.add('show');
  await delay(400);
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else { rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show');
  await delay(800); ov.classList.remove('active');
}

/* „Çø„Ç§„Éó„Éª„Çπ„ÉÜË®àÁÆó */
const TYPES_RING=['„Éí„Çπ„Éà„É™„Éº','„Ç∏„Ç™','„Ç≥„É≥„Çª„Éó„Éà','„Çµ„Ç§„Ç®„É≥„Çπ','„Ç¢„Éã„Éû„É´','„Éí„É•„Éº„Éû„É≥','„Éï„Éº„Éâ'];
const typeColor=t=>getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`)||'#7aa0ff';
const typeMult=(atk,def)=>{
  const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);
  if(i<0||j<0)return 1;
  const st=[(i+1)%n,(i+2)%n],wk=[(i-1+n)%n,(i-2+n)%n];
  if(st.includes(j))return 1.5;
  if(wk.includes(j))return 0.67;
  return 1;
};
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

const toKatakana=(s)=>(s||"").replace(/[„ÅÅ-„Çì]/g,ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
const visualLen = (s)=> (s||"").replace(/[„Éª\s]/g,"").length;
const reKanaH = /[„ÅÅ-„Çü]/g, reKanaK = /[„Ç†-„Éø„Éº]/g, reKanji = /[‰∏Ä-Èæ•„ÄÖ„ÄÜ„Éµ„É∂]/g;
function countClass(name){
  const H=(name.match(reKanaH)||[]).length;
  const K=(name.match(reKanaK)||[]).length;
  const J=(name.match(reKanji)||[]).length;
  return{H,K,J,total:H+K+J};
}
const reSmallK = /[„Ç°„Ç£„Ç•„Çß„Ç©„É£„É•„Éß„ÉÆ„á∞-„áø]/g, reSokuon=/„ÉÉ/g, reVoiced=/[„Ç¨-„Éù„É¥]/g, rePlosiveEnd=/[„ÉÑ„ÉÉ„ÇØ„Ç≠„ÉÅ„ÉÜ„Éà„Éó„Éî„Éö„Éù„Ç´„Çø]$/;
function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5;
  const cls=countClass(name);
  if(cls.J+cls.K===0){atkP+=12.5;defP+=12.5;}
  else{
    const r=cls.K/(cls.J+cls.K);
    atkP+=25*r;defP+=25*(1-r);
  }
  const Lph=yomiKatakana.length||1;
  const d=(yomiKatakana.match(reVoiced)||[]).length/Lph;
  const s=(yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m=(yomiKatakana.match(reSmallK)||[]).length/Lph;
  const e=rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw=0.6*d+0.25*(s+m)+0.15*e, L=0.05, U=0.45;
  const s_ph=Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph=20*(0.5+0.5*s_ph);
  atkP+=atk_ph; defP+=20-atk_ph;
  const T=visualLen(name);
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len=20*(0.5+0.5*s_len);
  atkP+=atk_len; defP+=20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
  const cls=countClass(name);
  const hiraRatio=cls.total?(cls.H/cls.total):0;
  const rankAdj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;
  let eva=10+8*hiraRatio-0.5*(T-5)+rankAdj;
  eva=Math.round(eva*10)/10;
  return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiH]){
  const y=toKatakana(yomiH||name);
  const {atkP,defP,T}=calcAttackDefense(name,y);
  const ATK=Math.round(PRANK[rank]*(atkP/100));
  const DEF=Math.round(PRANK[rank]*(defP/100));
  const HP=Math.round(HP_BASE[rank]+20*(T-5));
  const EVA=calcEvasion(name,T,rank);
  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

/* „Çπ„Ç≠„É´ÂÆöÁæ© */
const SKILLS={
 "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":["Â¶®ÂÆ≥ÈõªÊ≥¢","Â®ÅÂäõ2.2ÂÄç„ÄÇÁõ∏Êâã„ÅÆÂøÖÊÆ∫„Ç≤„Éº„Ç∏„Çí0„Å´„Åô„Çã„ÄÇ"],
 "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":["‰∏ÄÊùØ„ÅÑ„Åã„Åå","ÊîªÊíÉÂæå„ÄÅÂë≥ÊñπÂÖ®Âì°HP60ÂõûÂæ©„ÄÇ"],
 "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":["„Å™„Çì„Åè„Çã„Å™„ÅÑ„Åï„Éº","Â®ÅÂäõ1.6ÂÄç„ÄÇÊ¨°„Å´Âèó„Åë„ÇãËá¥ÂëΩÂÇ∑„Çí1Âõû„Å†„ÅëHP1„ÅßËÄê„Åà„Çã„ÄÇ"],
 "„Åù„Åº„Çç„Åî„ÅØ„Çì":["„Åù„Åº„Çç‰π±Ëàû","3ÂõûÈÄ£Á∂öÊîªÊíÉÔºà0.75‚Üí0.5‚Üí0.25ÂÄçÔºâ„ÄÇ"],
 "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":["„Éû„Ç¶„É≥„ÉÜ„É≥„Éì„Éº„Éà","Â®ÅÂäõ1.5ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅËá™ÂàÜ„ÅÆÊîªÊíÉ1.3ÂÄç„ÄÇ"],
 "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":["„É†„ÇØ„Ç∏„É£„É©„É©","Â®ÅÂäõ1.4ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅÂõûÈÅøÁéá60%Âõ∫ÂÆö„ÄÇ"],
 "‰πùÂìÅ‰ªè":["‰ªè„ÅÆÈ°î„ÇÇ‰∏âÂ∫¶„Åæ„Åß","Â®ÅÂäõ1.6ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅË¢´„ÉÄ„É°„Éº„Ç∏ÂçäÊ∏õ„ÄÇ"],
 "„Åë„Çì„Å°„ÇìÊ±Å":["Èï∑ÂØø„ÅÆÁßòË®£","Â®ÅÂäõ1.2ÂÄç„ÄÇËá™ÂàÜHP150ÂõûÂæ©„ÄÇ"],
 "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "„Çø„É©„É≥„ÉÅ„É•„É©":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
 "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "„Éî„É≠„É™Ëèå":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
 "„Ç´„É©„É°„É´Ëâ≤Á¥†":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "„Éê„Éì„É≠„É≥ÊçïÂõö":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "È≥•ÂèñÁ†Ç‰∏ò":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "Ê∏°Êù•‰∫∫":["ÊñáÂ≠óÂåñ„Åë","Áõ∏Êâã„ÅØ3„Çø„Éº„É≥Âæå„Å´Êà¶Èóò‰∏çËÉΩ„ÄÇ"],
 "„Åï„Çã„Å≥„ÅÇ‰∏∏":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
 "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "„Éù„É™„Éó„É≠„Éî„É¨„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
 "„ÇØ„Éû„É≥„Éê„ÉÅ":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "ÁúåÂ∫ÅÊâÄÂú®Âú∞":["ÊñáÂ≠óÂåñ„Åë","Áõ∏Êâã„ÅØ3„Çø„Éº„É≥Âæå„Å´Êà¶Èóò‰∏çËÉΩ„ÄÇ"],
 "ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
 "„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "„Çπ„É´„É°„Ç§„Ç´":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
 "Êú¨Ë≥™":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ë¶ã„Åà„ÇãÂåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ëá™ÂàÜ„Åî„Å®Âåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
 "Ëß£ÂÉèÂ∫¶":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"]
};
const WORDS_BASE=[
 ["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","S","„Çµ„Ç§„Ç®„É≥„Çπ","„Å±„Çâ„Åº„Çâ„ÅÇ„Çì„Å¶„Å™"],
 ["„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº","S","„Éí„É•„Éº„Éû„É≥","„Å≠„Åô„Åã„Åµ„Åá„ÅÇ„Çì„Å∞„Åï„Å†„Éº"],
 ["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","A","„Éï„Éº„Éâ","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä"],
 ["„Åù„Åº„Çç„Åî„ÅØ„Çì","A","„Éï„Éº„Éâ","„Åù„Åº„Çç„Åî„ÅØ„Çì"],
 ["„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","A","„Ç¢„Éã„Éû„É´","„Å´„Åó„Çç„Éº„Çâ„Çì„Å©„Åî„Çä„Çâ"],
 ["ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","A","„Ç¢„Éã„Éû„É´","„Åë„ÇÄ„Åè„Åò„ÇÉ„Çâ"],
 ["‰πùÂìÅ‰ªè","A","„Ç∏„Ç™","„Åè„Åª„Çì„Å∂„Å§"],
 ["„Åë„Çì„Å°„ÇìÊ±Å","A","„Éï„Éº„Éâ","„Åë„Çì„Å°„Çì„Åò„Çã"],
 ["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","B","„Ç∏„Ç™","„Åã„ÇÄ„Å°„ÇÉ„Å£„Åã„ÅØ„Çì„Å®„ÅÜ"],
 ["„Çø„É©„É≥„ÉÅ„É•„É©","B","„Ç¢„Éã„Éû„É´","„Åü„Çâ„Çì„Å°„ÇÖ„Çâ"],
 ["„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","B","„Ç¢„Éã„Éû„É´","„ÅØ„Åó„Å≥„Çç„Åì„ÅÜ"],
 ["„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","B","„Éï„Éº„Éâ","„Å∞„Çã„Åï„Åø„Åì„Åô"],
 ["„Éî„É≠„É™Ëèå","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Å¥„Çç„Çä„Åç„Çì"],
 ["„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","B","„Ç∏„Ç™","„Å®„Çä„Å´„Å†„Éº„Å©„Å®„Å∞„Åî"],
 ["„Ç´„É©„É°„É´Ëâ≤Á¥†","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Åã„Çâ„ÇÅ„Çã„Åó„Åç„Åù"],
 ["„Éê„Éì„É≠„É≥ÊçïÂõö","C","„Éí„Çπ„Éà„É™„Éº","„Å∞„Å≥„Çç„Çì„Åª„Åó„ÇÖ„ÅÜ"],
 ["È≥•ÂèñÁ†Ç‰∏ò","C","„Ç∏„Ç™","„Å®„Å£„Å®„Çä„Åï„Åç„ÇÖ„ÅÜ"],
 ["„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","C","„Çµ„Ç§„Ç®„É≥„Çπ","„Å∑„Çâ„Åó„Éº„Åº„Åì„ÅÜ„Åã"],
 ["Ê∏°Êù•‰∫∫","C","„Éí„É•„Éº„Éû„É≥","„Å®„Çâ„ÅÑ„Åò„Çì"],
 ["„Åï„Çã„Å≥„ÅÇ‰∏∏","C","„Ç∏„Ç™","„Åï„Çã„Å≥„ÅÇ„Åæ„Çã"],
 ["„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","C","„Éï„Éº„Éâ","„Å∫„Å∫„Çç„Çì„Å°„Éº„ÅÆ"],
 ["„Éù„É™„Éó„É≠„Éî„É¨„É≥","C","„Çµ„Ç§„Ç®„É≥„Çπ","„ÅΩ„Çä„Å∑„Çç„Å¥„Çå„Çì"],
 ["„Çµ„É©„Ç®„Éú‰∫ã‰ª∂","C","„Éí„Çπ„Éà„É™„Éº","„Åï„Çâ„Åà„Åº„Åò„Åë„Çì"],
 ["„ÇØ„Éû„É≥„Éê„ÉÅ","D","„Ç¢„Éã„Éû„É´","„Åè„Åæ„Çì„Å∞„Å°"],
 ["ÁúåÂ∫ÅÊâÄÂú®Âú∞","D","„Ç∏„Ç™","„Åë„Çì„Å°„Çá„ÅÜ„Åó„Çá„Åñ„ÅÑ„Å°"],
 ["ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","D","„Éï„Éº„Éâ","„Å¶„Çä„ÇÑ„Åç„Å°„Åç„Çì"],
 ["„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","D","„Éï„Éº„Éâ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠"],
 ["„Çπ„É´„É°„Ç§„Ç´","D","„Ç¢„Éã„Éû„É´","„Åô„Çã„ÇÅ„ÅÑ„Åã"],
 ["Êú¨Ë≥™","X","„Ç≥„É≥„Çª„Éó„Éà","„Åª„Çì„Åó„Å§"],
 ["Ë¶ã„Åà„ÇãÂåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åø„Åà„Çã„Åã"],
 ["Ëá™ÂàÜ„Åî„Å®Âåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åò„Å∂„Çì„Åî„Å®„Åã"],
 ["Ëß£ÂÉèÂ∫¶","X","„Ç≥„É≥„Çª„Éó„Éà","„Åã„ÅÑ„Åû„ÅÜ„Å©"]
];
const makeW=i=>makeWordObject(WORDS_BASE[i]);

const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false,history:new Set(),suppressAffToastOnce:false};
let forceSwitch=false;

const left =()=>state.A.team[state.A.i];
const right =()=>state.B.team[state.B.i];

function barRow(label,val,max){
  const pct=Math.min(100,(val/max)*100);
  return `<div class="barRow"><div class="barLabel">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="barVal">${val}</div></div>`;
}

/* setupMini */
function miniCard(idx){
  const w=makeW(idx);
  return `<div class="setupMini" style="--typeC:${typeColor(w.type)}" data-type="${w.type}">
  <div class="head" style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
    <div>${w.name}</div><div style="color:var(--typeC)">${w.type}</div>
  </div>
  <div class="statGrid">
    ${barRow('HP',w.maxhp,800)}
    ${barRow('ATK',w.atk,120)}
    ${barRow('DEF',w.def,120)}
    ${barRow('EVA',w.eva,30)}
  </div></div>`;
}
function renderMini(side){
  const root=side==='A'?$('statsA'):$('statsB');
  root.innerHTML='';
  for(let i=0;i<3;i++){
    const idx=Number($(`${side}-${i}`).value)||0;
    root.innerHTML+=miniCard(idx);
  }
}

/* „É©„É≥„ÉÄ„É†„É¶„Éã„Éº„ÇØÈÅ∏Êäû */
function uniqueRandom(n, sourceLen){
  const arr=[]; const pool=Array.from({length:sourceLen},(_,i)=>i);
  for(let i=0;i<n;i++){
    const idx=Math.floor(Math.random()*pool.length);
    arr.push(pool[idx]); pool.splice(idx,1);
  }
  return arr;
}
function makeTeam(root,side){
  root.innerHTML='';
  for(let i=0;i<3;i++){
    const div=document.createElement('div');div.className='slot';
    const pill=document.createElement('span');pill.className='pill';pill.textContent='#'+(i+1);
    const sel=document.createElement('select');sel.id=`${side}-${i}`;
    WORDS_BASE.forEach((w,idx)=>{
      const o=document.createElement('option');
      o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;
      sel.append(o);
    });
    sel.addEventListener('change',()=>{ renderMini(side); });
    div.append(pill,sel);root.append(div);
  }
  const picks=uniqueRandom(3,WORDS_BASE.length);
  picks.forEach((v,i)=>$(`${side}-${i}`).value=v);
  renderMini(side);
}

function randomizeTeam(side){
  const picks=uniqueRandom(3,WORDS_BASE.length);
  for(let i=0;i<3;i++){
    $(`${side}-${i}`).value = picks[i];
  }
  renderMini(side);
}

const collect=side=>[0,1,2].map(i=>{
  const idx=Number($(`${side}-${i}`).value)||0;
  return {...makeW(idx),side};
});

function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  state.busy=false; lockInputs(false); 
  checkAffinity();
  
  setTimeout(()=>{
    if(state.busy) return;
    const cpu = right(); const player = left();
    const m = typeMult(cpu.type, player.type);
    if(m <= 0.7 && cpu.lock === 0 && cpu.hp > 0){
      const reserves = [0,1,2].filter(i => i !== state.B.i && state.B.team[i].hp > 0);
      const best = reserves.find(i => typeMult(state.B.team[i].type, player.type) >= 1.5);
      if(best !== undefined && Math.random() < 0.7){ cpuSwitchAction(best); return; }
    }
  }, 1200);

  state.timer=setInterval(()=>{
    if(state.busy)return;
    state.remain--;
    $('countNum').textContent=state.remain;
    if(state.remain<=0){
      pick(['G','C','P'][Math.floor(Math.random()*3)]);
    }
  },1000);
}

async function cpuSwitchAction(nextIdx){
  state.busy = true; clearInterval(state.timer); lockInputs(true);
  try {
    log('CPU„Åå‰∫§‰ª£„ÇíÈÅ∏ÊäûÔºÅ', 'highlight'); await delay(1000);
    state.B.i = nextIdx; state.B.sp = 0;
    state.suppressAffToastOnce = true; // ‰∫§‰ª£Áõ¥Âæå„ÅÆÁõ∏ÊÄß„Éà„Éº„Çπ„ÉàÊäëÂà∂
    renderSides();
    showFloatingText('rightWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${right().name}`,'info',{duration:2200});
    log(`Áõ∏Êâã„ÅØ ${right().name} „Å´‰∫§‰ª£„Åó„ÅüÔºÅ`, 'highlight'); await delay(1000);
    log('Áõ∏Êâã„ÅÆÈöô„Å†ÔºÅÊîªÊíÉ„ÅÆ„ÉÅ„É£„É≥„ÇπÔºÅ', 'highlight');
    const ended = await doTurn('ally');
    if(!ended){
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      startRound();
    }
  } catch(e){ console.error(e); startRound(); } finally { state.busy = false; lockInputs(false); }
}

function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}

function baseDamage(att, def){
  let mult = typeMult(att.type, def.type);
  let val = 100 * (1 + att.atk/100) / (1 + def.def/120) * mult;
  return val * (Math.random() * 0.4 + 0.8);
}

/* Áõ∏ÊÄßË°®Á§∫Ôºã„Éà„Éº„Çπ„ÉàÔºà‰∫§‰ª£Áõ¥Âæå‰∏ÄÂõû„Å†„ÅëÊäëÂà∂Ôºâ */
function checkAffinity(){
  const a = left(), b = right();
  const pairKey = `${a.name}:${b.name}`;
  const m1 = typeMult(a.type, b.type);
  const m2 = typeMult(b.type, a.type);

  const setBadge = (el, m) => {
    if(!el) return; el.className = 'affTag';
    if(m>=1.5){ el.textContent='‚ñ≤ ÊúâÂà©'; el.className='affTag adv show'; }
    else if(m<=0.7){ el.textContent='‚ñº ‰∏çÂà©'; el.className='affTag dis show'; }
    else { el.className='affTag even'; }
  };
  setBadge(qs('#affA'), m1);
  setBadge(qs('#affB'), m2);

  // ‰∫§‰ª£Áõ¥Âæå‰∏ÄÂõû„Å†„ÅëÁõ∏ÊÄß„Éà„Éº„Çπ„Éà„ÇíÊäëÂà∂
  if(state.suppressAffToastOnce){
    state.suppressAffToastOnce = false;
    return;
  }

  if(!state.history.has(pairKey)){
    state.history.add(pairKey);
    if(m1 >= 1.5) {
      showFloatingText('leftWrap', 'Áõ∏ÊÄßÊúâÂà©!', 'advTop');
      log(`„ÄêÊúâÂà©„Äë${a.name}„ÅØ${b.name}„Å´Âº∑„ÅÑÔºÅ`,'heal');
    } else if(m1 <= 0.7) {
      showFloatingText('leftWrap', 'Áõ∏ÊÄß‰∏çÂà©...', 'disTop');
      log(`„Äê‰∏çÂà©„Äë${a.name}„ÅØ${b.name}„Å´Âº±„ÅÑ...`,'dmg');
    }
  }
}

/* „Ç´„Éº„ÉâÊèèÁîª */
function renderCard(u,role,opp){
  const sp=role==='ally'?state.A.sp:state.B.sp;
  const owner=role==='ally'?'YOU':'CPU';
  const img=IMG[u.name]?`<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none'">`:'<span style="font-size:40px">üì¶</span>';
  const skill=(SKILLS[u.name]||['‚Äî','‚Äî']);
  const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  let badges='';
  if(u.lock>0) badges+=`<div class="stBadge">üîí‰∫§‰ª£‰∏çÂèØ</div>`;
  if(u.doom>0) badges+=`<div class="stBadge">üëæÊñáÂ≠óÂåñ„Åë</div>`;
  if(u.selfHurt>0) badges+=`<div class="stBadge">üåÄÂ¥©Â£ä</div>`;
  
  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}">
    <div class="unitInner">
      <div class="cardHeader"><span class="ownerBadge ${role}">${owner}</span><span class="typeIcon">${u.type}</span></div>
      <div class="cardName" id="nm-${role}">${u.name}</div>
      <div class="artArea" id="art-${role}">
        ${img}
      </div>
      
      <div class="statsArea">
         <div class="hpRow" style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:2px;font-family:'Teko'">
            <span style="font-size:12px;color:#fff;font-weight:700;line-height:1">HP</span>
            <div style="font-size:16px;color:#fff;font-weight:600;line-height:0.9">
              <span id="hpnum-${role}">${u.hp}</span>
              <span style="font-size:10px;color:#fff">/ ${u.maxhp}</span>
            </div>
         </div>
         <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
         <div class="statusRow">${badges}</div>
      </div>

      <div class="bottomSection">
        <div class="skillInfo">
          <div class="skillN">ÊäÄ: ${skill[0]}</div>
          <div class="skillD">${skill[1]}</div>
        </div>
        <div class="spRow">${pips}</div>
        <div class="footer">
           <span class="typeBadge" style="color:#94a3b8;font-size:10px">ATK:${u.atk} DEF:${u.def} EVA:${u.eva}%</span>
           <button class="btnStat" onclick="window._sh('${u.name}')">Ë©≥Á¥∞</button>
        </div>
      </div>
    </div></div>`;
}

/* Êéß„Åà„Ç®„É™„Ç¢„ÅÆË°®Á§∫ÔºöÊ®™‰∏ÄÂàó */
function buildBoxes(){
  const row = $('benchRow');
  if(!row) return;

  const mk=(u,i,isActive)=>`
    <div class="resIcon ${u.hp<=0?'dead':''} ${isActive?'active':''}"
         onclick="window._sh('${u.name}')"
         style="border-color:${typeColor(u.type)}">
      ${u.name.charAt(0)}
    </div>`;

  const leftIcons = state.A.team.map((u,i)=>mk(u,i,i===state.A.i)).join('');
  const rightIcons = state.B.team.map((u,i)=>mk(u,i,i===state.B.i)).join('');

  row.innerHTML = `
    <span class="benchLabel" style="color:#4da6ff">YOU</span>
    ${leftIcons}
    <span class="benchLabel" style="color:#9ca3af">VS</span>
    ${rightIcons}
    <span class="benchLabel" style="color:#ff5c6c">CPU</span>
  `;
}

function renderSides(){
  $('leftWrap').innerHTML=renderCard(state.A.team[state.A.i],'ally',state.B.team[state.B.i]);
  $('rightWrap').innerHTML=renderCard(state.B.team[state.B.i],'enemy',state.A.team[state.A.i]);
  fitName(qs('#nm-ally')); fitName(qs('#nm-enemy'));
  buildBoxes(); updateSPBtn(); updateHPUI('ally',left().hp,left().maxhp); updateHPUI('enemy',right().hp,right().maxhp); checkAffinity();
}

window._sh=(n)=>{
  const u=[...state.A.team,...state.B.team].find(x=>x.name===n); if(!u)return;
  const skill = SKILLS[u.name]||['?','?'];
  const html = `
    <div style="text-align:center;margin-bottom:12px">
      <h2 style="margin:0;color:${typeColor(u.type)};font-size:20px">${u.name}</h2>
      <div style="font-size:12px;color:#ccc;margin-top:4px">[${u.rank}„É©„É≥„ÇØ / ${u.type}„Çø„Ç§„Éó]</div>
    </div>
    <div class="setupMini" style="margin-bottom:12px;background:rgba(0,0,0,0.3)">
      <div class="statGrid" style="gap:12px">
        ${barRow('HP', u.hp, u.maxhp)} ${barRow('ATK', u.atk, 120)}
        ${barRow('DEF', u.def, 120)} ${barRow('EVA', u.eva, 30)}
      </div>
    </div>
    <div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;border:1px solid #444">
      <div style="font-weight:bold;color:#ffd900;margin-bottom:6px;font-size:14px">ÂøÖÊÆ∫ÊäÄ: ${skill[0]}</div>
      <div style="font-size:12px;line-height:1.5;color:#ccc">${skill[1]}</div>
    </div>
  `;
  $('infoBody').innerHTML=html; $('infoModal').classList.add('show');
};

function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
  let mult=1, multiSeq=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', skillUser=att.name, notes=[];
  const useName=forcedName??att.name;
  const [title] = (SKILLS[useName]||['‚Äî','‚Äî']);
  skillTitle=title;
  switch(useName){
    case '„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä': mult=2.2; break;
    case '„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº': mult=1; notes.push('Âë≥ÊñπÂÖ®Âì°ÂõûÂæ©'); break;
    case '„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä': mult=1.6; att.endure=true; showFloatingText(role==='ally'?'leftWrap':'rightWrap','Ê†πÊÄß','buff'); break;
    case '„Åù„Åº„Çç„Åî„ÅØ„Çì': multiSeq=[0.75,0.5,0.25]; break;
    case '„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©': mult=1.5; att.atk13=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ATK UP','buff'); break;
    case 'ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ': mult=1.4; att.eva60=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ÂõûÈÅøUP','buff'); break;
    case '‰πùÂìÅ‰ªè': mult=1.6; att.shield=2; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ËªΩÊ∏õ','buff'); break;
    case '„Åë„Çì„Å°„ÇìÊ±Å': mult=1.2; notes.push('Ëá™Â∑±ÂõûÂæ©'); break;
    case '„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂':
    case '„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶':
    case '„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢':
    case '„Éê„Éì„É≠„É≥ÊçïÂõö':
    case '„Éù„É™„Éó„É≠„Éî„É¨„É≥':
    case '„ÇØ„Éû„É≥„Éê„ÉÅ':
    case 'ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥':
      def.lock=4; showFloatingText(role==='ally'?'rightWrap':'leftWrap','LOCKED','debuff'); break;
    case '„Çø„É©„É≥„ÉÅ„É•„É©':
    case '„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥':
    case '„Çµ„É©„Ç®„Éú‰∫ã‰ª∂':
    case '„Åï„Çã„Å≥„ÅÇ‰∏∏':
      def.stun=true; showFloatingText(role==='ally'?'rightWrap':'leftWrap','„Çπ„Çø„É≥','debuff'); break;
    case '„Éî„É≠„É™Ëèå':
    case '„Ç´„É©„É°„É´Ëâ≤Á¥†':
    case 'È≥•ÂèñÁ†Ç‰∏ò':
    case '„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú':
    case '„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé':
    case '„Çπ„É´„É°„Ç§„Ç´':
    case '„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠':
      def.selfHurt=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','Â¥©Â£ä','debuff'); break;
    case 'Ê∏°Êù•‰∫∫':
    case 'ÁúåÂ∫ÅÊâÄÂú®Âú∞':
      def.doom=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','ÊñáÂ≠óÂåñ„Åë','debuff'); break;
    case 'Êú¨Ë≥™':
    case 'Ë¶ã„Åà„ÇãÂåñ':
    case 'Ëá™ÂàÜ„Åî„Å®Âåñ':
    case 'Ëß£ÂÉèÂ∫¶':
      if(!mirrorMode){ mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; } break;
  }
  return {mult,multiSeq,skillTitle,skillUser,notes};
}
async function spEffectPost(att,def,role,usedName){
  switch(usedName){
    case '„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä':
      if(role==='ally'){state.B.sp=0;}else{state.A.sp=0;}
      break;
    case '„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº': {
      const team = (role==='ally'?state.A.team:state.B.team);
      team.forEach(u=>{ if(u.hp<u.maxhp){ u.hp=Math.min(u.maxhp,u.hp+60); } });
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+60','heal');
      renderSides(); 
      break;
    }
    case '„Åë„Çì„Å°„ÇìÊ±Å': {
      att.hp=Math.min(att.maxhp,att.hp+150); 
      showFloatingText(role==='ally'?'leftWrap':'rightWrap','+150','heal');
      renderSides(); 
      break;
    }
  }
}

async function startOfAction(side){
  const me=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  if(me.eva60>0)me.eva60--;
  if(me.atk13>0)me.atk13--;
  if(me.lock>0)me.lock--;
  if(me.doom>0){
    me.doom--;
    if(me.doom<=0){
      me.hp=0; renderSides();
      showFloatingText(side==='ally'?'leftWrap':'rightWrap','ÊñáÂ≠óÂåñ„Åë„ÅßÂÄí„Çå„Åü‚Ä¶','debuff',{duration:2200});
      qs(side==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${me.name}„ÅØÊñáÂ≠óÂåñ„Åë„ÅßÂÄí„Çå„ÅüÔºÅ`,'highlight');
      const ended=await handleKO(side); return false===ended;
    }
  }
  if(me.stun){
    me.stun=false; renderSides();
    log(`${me.name}„ÅØÂãï„Åë„Å™„ÅÑÔºÅ`,'highlight'); await delay(1000);
    return false;
  }
  return true;
}

async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true; clearInterval(state.timer); lockInputs(true);
  try{
    const cpu=['G','C','P'][Math.floor(Math.random()*3)];
    const res=judge(h,cpu);
    await playJankenAnim(h,cpu,res);
    
    let ko=false;
    if(res>0){
      if(await startOfAction('ally')) ko=await doTurn('ally');
    } else if(res<0){
      if(await startOfAction('enemy')) ko=await doTurn('enemy');
    }
    if(!ko){
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      if(state.A.sp<6)state.spAnnA=false;
      renderSides(); log('Ê¨°„ÅÆ„Çø„Éº„É≥','normal'); await delay(600); startRound();
    }
  }catch(e){console.error(e); startRound();}
}

async function doTurn(side){
  const att=side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  let def=side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse=(side==='ally'&&state.spOn&&state.A.sp>=6)||(side==='enemy'&&state.B.sp>=6);
  
  let mult=1, multi=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', usedName=att.name;
  
  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; } else { state.B.sp=0; }
    playSE('skill');

    if(['Êú¨Ë≥™','Ë¶ã„Åà„ÇãÂåñ','Ëá™ÂàÜ„Åî„Å®Âåñ','Ëß£ÂÉèÂ∫¶'].includes(att.name)){
      const foe=(side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X'&&u.hp>0);
      if(foe.length){
        const pick=foe[Math.floor(Math.random()*foe.length)];
        const pre=spEffectPre(att,def,side,pick.name,true);
        mult=pre.mult*2.0; multi=pre.multiSeq?pre.multiSeq.map(x=>x*2.0):null;
        skillTitle=pre.skillTitle; usedName=pick.name;
        await showCutIn(skillTitle, att.name);
        log(`Èè°ÊñáÂ≠óÔºö${pick.name}„Çí„Ç≥„Éî„ÉºÔºÅ`,'sp');
      }else{
        mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; await showCutIn(skillTitle, att.name);
      }
    } else {
      const pre=spEffectPre(att,def,side);
      mult=pre.mult; multi=pre.multiSeq; skillTitle=pre.skillTitle;
      await showCutIn(skillTitle, att.name);
      if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
    }
  } else {
    log(`${att.name}„ÅÆÊîªÊíÉ`,'atk'); await delay(400);
  }

  const eva=def.eva60>0?60:def.eva;
  if(!spUse && Math.random()<(eva/100)){
    showFloatingText(side==='ally'?'rightWrap':'leftWrap', "MISS", "miss");
    log('ÊîªÊíÉ„ÇíÂõûÈÅø„Åó„ÅüÔºÅ','miss'); 
    await delay(800);
    return false;
  }

  let targetRole=side==='ally'?'enemy':'ally';
  const dmgList=(Array.isArray(multi)?multi:[mult]);
  
  for(let i=0; i<dmgList.length; i++){
    let m=dmgList[i];
    let base = baseDamage(att,def) * m;
    if(att.atk13>0) base *= 1.3;
    if(def.shield>0){ base*=0.5; def.shield--; showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','GUARD','buff'); }
    
    let damage = Math.max(1, Math.floor(base));
    
    def.hp=Math.max(0,def.hp-damage);
    updateHPUI(targetRole, def.hp, def.maxhp);

    playSE('hit');

    qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit');
    shakeScreen();
    showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap', `-${damage}`, 'dmg');
    
    log(`${def.name}„Å´ ${damage} „ÉÄ„É°„Éº„Ç∏`,'dmg');
    await delay(1200); 
    qs('.unit.hit')?.classList.remove('hit');

    if(def.hp<=0 && def.endure){
      def.endure=false; def.hp=1; 
      updateHPUI(targetRole, 1, def.maxhp);
      showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap', 'Ê†πÊÄß', 'buff');
      log('Ê†πÊÄß„ÅßËÄê„Åà„ÅüÔºÅ','highlight');
    }
    else if(def.hp<=0){
      qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('fall');
      await delay(1000);
      log(`${def.name}„ÅØÂÄí„Çå„ÅüÔºÅ`,'highlight');
      const ended=await handleKO(targetRole==='enemy'?'enemy':'ally');
      if(ended) return true;
      if(i<dmgList.length-1){
        def=(side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i]);
        targetRole=side==='ally'?'enemy':'ally';
      }
    }
  }

  if(att.selfHurt>0){
    att.selfHurt--;
    if(Math.random()<0.33){
      log('„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£äÔºÅ','dmg');
      att.hp=Math.max(0,att.hp-100); 
      const myRole=side==='ally'?'ally':'enemy';
      updateHPUI(myRole, att.hp, att.maxhp);
      showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','-100','dmg');
      if(att.hp<=0){
        showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','Â¥©Â£ä„ÅßËá™ÊªÖ','debuff',{duration:2200});
        qs(myRole==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall');
        await delay(1000);
        log(`${att.name}„ÅØËá™ÊªÖ„Åó„Åü`,'highlight');
        return await handleKO(side);
      }
    }
  }
  if(spUse) await spEffectPost(att,def,side,usedName);
  return false;
}

async function handleKO(side){
  playSE('ko');

  const team = side==='ally' ? state.A.team : state.B.team;
  const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);

  if(survivors.length===0){
    stopBGM();
    $('resTitle').textContent = side==='enemy' ? 'YOU WIN!' : 'YOU LOSE...';
    $('result').classList.add('show');
    await delay(3000);
    $('result').classList.remove('show');
    $('battle').style.display='none';
    $('setup').style.display='grid';
    return true;
  }

  if(side==='enemy'){
    state.B.i = survivors[0].i;
    state.B.sp=0;
    state.suppressAffToastOnce = true;
    renderSides();
    showFloatingText('rightWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${team[state.B.i].name}`,'info',{duration:2200});
    log(`Áõ∏Êâã„ÅØ ${team[state.B.i].name} „ÇíÁπ∞„ÇäÂá∫„Åó„Åü`, 'highlight');
    await delay(1000);
    startRound();
    return true;
  }

  forceSwitch = true;
  openForceSwitch(survivors.map(o=>o.i));
  return true;
}

/* ‰∫§‰ª£UI */
const swModal=$('switchModal'), swGrid=$('switchGrid'), swDo=$('swDo'); let swIdx=null;

function openSwitch(){
  if(left().lock>0){ log('Ë®ÄË´ñÁµ±Âà∂„Å´„Çà„Çä‰∫§‰ª£‰∏çÂèØÔºÅ', 'highlight'); showFloatingText('leftWrap','LOCKED','debuff'); return; }
  forceSwitch = false;
  swGrid.innerHTML=''; swIdx=null; swDo.disabled=true;
  const idxs=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!idxs.length){ log('‰∫§‰ª£„Åß„Åç„ÇãÊéß„Åà„Åå„ÅÑ„Åæ„Åõ„Çì'); return; }
  const enemy = right();
  
  idxs.forEach(i=>{
    const u=state.A.team[i];
    const skill = SKILLS[u.name]||['?','?'];
    const m = typeMult(u.type, enemy.type);
    let affText = '„Éº Á≠âÂÄç'; let affClass = 'color:#8ba0c0';
    if(m>=1.5){ affText='‚óé ÊúâÂà©'; affClass='color:#4effa5'; }
    if(m<=0.7){ affText='‚ñ≥ ‰∏çÂà©'; affClass='color:#ff5c6c'; }

    const div=document.createElement('div'); div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`
      <div class="head"><div>${u.name}</div></div>
      <div style="font-size:11px;font-weight:bold;${affClass};margin-bottom:4px">ÂØæ ${enemy.name}: ${affText}</div>
      <div class="statGrid">
        ${barRow('HP',u.hp,u.maxhp)} ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)} ${barRow('EVA',u.eva,30)}
      </div>
      <div style="font-size:10px;color:#ccc;margin-top:4px">ÂøÖÊÆ∫: ${skill[0]}</div>
    `;
    div.onclick=()=>{
      document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected'));
      div.classList.add('selected');
      swIdx=i; swDo.disabled=false;
    };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}

function openForceSwitch(indices){
  swGrid.innerHTML=''; swIdx=null; swDo.disabled=true;
  const enemy = right();

  indices.forEach(i=>{
    const u = state.A.team[i];
    if(u.hp<=0) return;
    const skill = SKILLS[u.name]||['?','?'];
    const m = typeMult(u.type, enemy.type);
    let affText = '„Éº Á≠âÂÄç'; let affClass = 'color:#8ba0c0';
    if(m>=1.5){ affText='‚óé ÊúâÂà©'; affClass='color:#4effa5'; }
    if(m<=0.7){ affText='‚ñ≥ ‰∏çÂà©'; affClass='color:#ff5c6c'; }

    const div=document.createElement('div'); div.className='setupMini selCard';
    div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`
      <div class="head"><div>${u.name}</div></div>
      <div style="font-size:11px;font-weight:bold;${affClass};margin-bottom:4px">ÂØæ ${enemy.name}: ${affText}</div>
      <div class="statGrid">
        ${barRow('HP',u.hp,u.maxhp)} ${barRow('ATK',u.atk,120)}
        ${barRow('DEF',u.def,120)} ${barRow('EVA',u.eva,30)}
      </div>
      <div style="font-size:10px;color:#ccc;margin-top:4px">ÂøÖÊÆ∫: ${skill[0]}</div>
    `;
    div.onclick=()=>{
      document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected'));
      div.classList.add('selected');
      swIdx=i; swDo.disabled=false;
    };
    swGrid.appendChild(div);
  });

  swModal.classList.add('show');
}

$('btnSwitch').onclick=()=>{ if(!inputLocked) openSwitch(); };
$('swCancel').onclick=()=>swModal.classList.remove('show');

swDo.onclick=async()=>{
  if(swIdx===null)return;
  swModal.classList.remove('show');

  const newUnit = state.A.team[swIdx];
  state.A.i=swIdx; state.A.sp=0; state.spOn=false;
  state.suppressAffToastOnce = true; // ‚òÖ ‰∫§‰ª£Áõ¥Âæå„ÅØÁõ∏ÊÄß„Éà„Éº„Çπ„Éà„ÇíÊäëÂà∂
  renderSides();
  showFloatingText('leftWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${newUnit.name}`,'info',{duration:2200});
  log(`${newUnit.name} „Å´‰∫§‰ª£ÔºÅ`, 'highlight');

  if(forceSwitch){
    forceSwitch = false;
    await delay(600);
    startRound();
  } else {
    await delay(500); 
    const ended = await doTurn('enemy');
    if(!ended) {
      state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1);
      startRound();
    }
  }
};

/* „É¢„Éº„ÉÄ„É´„ÅÆËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã */
['switchModal','infoModal','rulesModal'].forEach(id=>{
  $(id).addEventListener('click', (e)=>{
    if(e.target === $(id)) $(id).classList.remove('show');
  });
});

document.addEventListener('DOMContentLoaded',()=>{
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');

  $('btnStart').onclick=async()=>{
    state.A.team=collect('A'); state.B.team=collect('B'); state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0; state.spOn=false; state.spAnnA=false;
    state.history=new Set(); state.suppressAffToastOnce=false;
    $('battleLog').innerHTML='';
    $('setup').style.display='none';
    $('battle').style.display='block';

    playBGM();
    await preloadImgs([...state.A.team, ...state.B.team].map(u=>u.name));
    renderSides(); 
    log('„Éê„Éà„É´ÈñãÂßãÔºÅ', 'highlight');
    showFloatingText('leftWrap','„Éê„Éà„É´ÈñãÂßãÔºÅ','info',{duration:1800});
    checkAffinity();
    await delay(800); startRound();
  };

  $('btnG').onclick=()=>pick('G');
  $('btnC').onclick=()=>pick('C');
  $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{
    if(!inputLocked && state.A.sp>=6){
      state.spOn = !state.spOn;
      updateSPBtn();
    }
  };
  $('btnRules').onclick=()=>$('rulesModal').classList.add('show');
  $('rulesClose').onclick=()=>$('rulesModal').classList.remove('show');
  $('infoClose').onclick=()=>$('infoModal').classList.remove('show');
  $('btnRand').onclick=()=>{ randomizeTeam('A'); randomizeTeam('B'); };
});
})();
</script>
</body>
</html>
