<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLEï½œå¯¾æˆ¦ v7.1.5</title>
<style>
  :root{--bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;--ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;--hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;--border:#1d2440}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px}.sub{margin:4px 0 12px;color:var(--muted)}
  .grid{display:grid;gap:16px}.cols-2{grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}.ghost{background:transparent;border:1px dashed #2b3a70}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}

  /* --- ã“ã“ãŒä»Šå›ã®å¤‰æ›´ç‚¹ï¼ˆç·¨æˆâ†’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸‹ã«2åˆ—Ã—3æ®µï¼‰ --- */
  #setup{ grid-template-columns:1fr !important; }             /* setup ã‚’1ã‚«ãƒ©ãƒ å›ºå®š */
  #statsGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  #statsGrid .statsCol{ display:grid; grid-template-rows:repeat(3,auto); gap:10px; }
  .setupMini{ background:#0b1227; border:1px solid #1a2b54; border-radius:10px; padding:8px; }
  .setupMini .head{ display:flex; justify-content:space-between; font-weight:700 }
  .setupMini .nums{ margin-top:4px; font-size:12px; color:#cfe2ff; display:grid; grid-template-columns:repeat(2,1fr); gap:4px }

  /* battle full */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  body.battleMode #battle .arena{min-height:100vh;border:none;border-radius:0}

  .arena{position:relative;background:#0d1326;border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px}
  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:220px}
  .unit{background:var(--panel2);border:1px solid #22325c;border-radius:12px;padding:10px}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .40s}
  .gauge{display:flex;gap:4px;margin-top:6px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:var(--gauge);opacity:1}
  .readyPulse{animation:pulse 1.2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  .pad{position:relative;display:grid;place-items:center;margin-top:6px}
  .padInner{position:relative;width:min(520px,90vw);height:220px}
  .rps{position:absolute;display:grid;place-items:center;width:88px;height:88px;border-radius:999px;border:none;color:#061225;font-size:18px}
  .rps.g{left:10%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}  /* èµ¤ */
  .rps.c{right:10%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)} /* é’ */
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)} /* ç·‘ */
  .switchBtn{position:absolute;right:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}
  .benchChip .type{color:#bcd}.benchChip .ratio{color:#9fe3ff;font-variant-numeric:tabular-nums}

  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .miniCard.ally{outline:2px solid var(--ally)} .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:var(--hpBack);border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .4s}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:30}
  .sheet{background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;padding:12px}
  .sheet h3{margin:0 0 8px;font-size:16px}
  .opt{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #213a6d;background:#0b1833;border-radius:10px;padding:8px;margin:6px 0;transition:.15s}
  .opt .right{display:flex;gap:10px;align-items:center}
  .badge{font-size:10px;padding:2px 6px;border:1px solid #2b3a70;border-radius:999px;color:#bcd}
  .badge.best{border-color:#ffd166;color:#ffd166}
  .opt.selected{outline:2px solid #ffd166; box-shadow:0 0 0 4px rgba(255,209,102,.25)}

  .fx{position:absolute;inset:0;display:none;place-items:center;z-index:40}
  .fx .bang{font-weight:900;font-size:min(9vw,48px);padding:18px 22px;border-radius:18px;background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.25), transparent), linear-gradient(180deg,#fff3,transparent);border:2px solid #ffe066;color:#ffe9a3;filter:drop-shadow(0 0 20px #ffef99)}
  .fx.show{display:grid;animation:fxpop .8s ease}
  @keyframes fxpop{0%{transform:scale(.9);opacity:.2}60%{transform:scale(1.03);opacity:1}100%{transform:scale(1)}}

  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(12px);padding:10px 14px;border-radius:12px;background:rgba(12,22,50,.92);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}
</style>
</head>
<body>
<header><div class="container">
  <h1>å¯¾æˆ¦ v7.1.5</h1>
  <div class="sub">ç·¨æˆä¸‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’2åˆ—Ã—3æ®µã«å›ºå®šï¼ã‚¯ãƒªãƒƒã‚¯ä¸ç™ºä¿®æ­£ï¼15ç§’ã‚«ã‚¦ãƒ³ãƒˆï¼å¿…æ®ºONè‰²æ›¿ãˆ</div>
</div></header>

<main class="container">
  <!-- ç·¨æˆ -->
  <section id="setup" class="grid cols-2">
    <section class="card">
      <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
      <div class="body">
        <div class="grid cols-2">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">ã‚ãªãŸ</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="randBoth" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">å¯¾æˆ¦é–‹å§‹</button>
        </div>
      </div>
    </section>

    <!-- â–¼ã“ã“ãŒä¸‹ã«æ¥ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆ2åˆ—Ã—3æ®µï¼‰ -->
    <section class="card">
      <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <div class="body">
        <div id="statsGrid">
          <div class="statsCol" id="statsA"></div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </section>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">ãƒãƒˆãƒ«</h2>
      <div class="body">
        <div class="arena">
          <div class="fx" id="fx"><div class="bang" id="fxText">å¿…æ®ºï¼</div></div>
          <div class="vsrow"><div id="leftWrap"></div><div id="rightWrap"></div></div>

          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG">âœŠ ã‚°ãƒ¼</button>
              <button class="rps c" id="handC">âœŒï¸ ãƒãƒ§ã‚­</button>
              <button class="rps p" id="handP">ğŸ– ãƒ‘ãƒ¼</button>
              <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
              <button class="spToggle" id="btnSP">âœ¨ å¿…æ®º OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <div class="timer"><span class="label">é¸æŠã¾ã§</span><span class="num" id="countNum">15</span><span class="label">ç§’</span></div>
          <div id="sixStats"></div>
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">ãƒãƒˆãƒ«æº–å‚™ä¸­</div>
          <button id="backSetup">ç·¨æˆã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="switchModal">
  <div class="sheet">
    <h3 id="switchTitle">äº¤ä»£å…ˆã‚’é¸æŠ</h3>
    <div id="switchList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button style="background:linear-gradient(90deg,#69d3ff,#2fb1ff);border:none;color:#061225" id="doSwitch">äº¤ä»£ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ================== ãƒ‡ãƒ¼ã‚¿ ================== */
const WORDS=[
  ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],
  ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
  ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],
  ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
  ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],
  ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
  ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],
  ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
  ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],
  ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
  ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],
  ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
  ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],
  ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
  ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],
  ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
  ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],
  ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
  ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],
  ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
  ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],
  ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
  ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],
  ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
  ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],
  ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
  ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],
  ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
  ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],
  ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
  ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],
  ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]
];
// Bã€œD çŠ¶æ…‹ç•°å¸¸å‰²å½“ï¼ˆå¹³æº–åŒ–ï¼‰
const BD_ASSIGN={
  B:{ "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"kotobagari","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"genron","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"kotobagari","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"genron","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"genron","ãƒ”ãƒ­ãƒªèŒ":"gestalt","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"gestalt" },
  C:{ "ã•ã‚‹ã³ã‚ä¸¸":"kotobagari","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"kotobagari","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"genron","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"genron","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"gestalt","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"gestalt","é³¥å–ç ‚ä¸˜":"mojibake","æ¸¡æ¥äºº":"mojibake" },
  D:{ "ã‚¯ãƒãƒ³ãƒãƒ":"genron","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"gestalt","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"gestalt","çœŒåºæ‰€åœ¨åœ°":"mojibake","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"mojibake" }
};
const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};
const EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
const BASE_POWER=100, GAUGE_NEEDED=6;

/* å††ç’°å‹ç›¸æ€§ï¼ˆ+1,+2æœ‰åˆ© / -1,-2ä¸åˆ©ï¼‰ */
const RING=["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"];
const TYPE_ADV=Object.fromEntries(RING.map((t,i)=>{const n=RING.length;return [t,{strong:[RING[(i+1)%n],RING[(i+2)%n]],weak:[RING[(i-1+n)%n],RING[(i-2+n)%n]]}] }));

/* A/S/X å¿…æ®º */
const SPECIALS={
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":{ id:"ãªã‚“ãã‚‹ãªã„ã•ãƒ¼", kind:"buff_endure", params:{atkMult:1.6} },
  "ãã¼ã‚ã”ã¯ã‚“":    { id:"ãã¼ã‚ä¹±èˆ",       kind:"multi",       params:{hits:[0.75,0.5,0.25]} },
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":{ id:"ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":    { id:"ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©",     kind:"evasion",     params:{atkMult:1.4,evade:0.60,turns:3} },
  "ä¹å“ä»":          { id:"ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§", kind:"atk_def",     params:{atkMult:1.6,defMult:1.8,turns:3} },
  "ã‘ã‚“ã¡ã‚“æ±":      { id:"é•·å¯¿ã®ç§˜è¨£",       kind:"atk_heal",    params:{atkMult:1.2,heal:150} },
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ": { id:"å¦¨å®³é›»æ³¢",         kind:"atk_drain",   params:{atkMult:2.5} },
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":{ id:"ä¸€æ¯ã„ã‹ãŒ",  kind:"heal_attack_all", params:{self:60,allies:60} },
};
/* B/C/D çŠ¶æ…‹ç•°å¸¸ */
const AIL={
  kotobagari:{name:"è¨€è‘‰ç‹©ã‚Š",icon:"ğŸš«",apply:(st)=>{st.skipTurns=Math.max(st.skipTurns,1)},desc:"1Tè¡Œå‹•ä¸å¯"},
  genron:{name:"è¨€è«–çµ±åˆ¶",icon:"ğŸ”’",apply:(st)=>{st.genronTurns=Math.max(st.genronTurns,4)},desc:"4Täº¤ä»£ä¸å¯"},
  gestalt:{name:"ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š",icon:"ğŸŒ€",apply:(st)=>{st.gestaltTurns=Math.max(st.gestaltTurns,4)},desc:"4T 1/3ã§è‡ªå‚·100"},
  mojibake:{name:"æ–‡å­—åŒ–ã‘",icon:"â˜ ï¸",apply:(st)=>{st.doomTurns=Math.max(st.doomTurns,3)},desc:"3Tå¾Œã«å³æ­»"}
};

/* ========== util ========= */
const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
const visibleLength=(s)=>[...s].length;
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));

function hiraRatioForEvasion(name){
  const letters=[...name].filter(isKanaOrKanji);
  if(!letters.length) return 0;
  const hira=letters.filter(isHira).length;
  return hira/letters.length;
}
function rKataForStructure(name){
  const kata=[...name].filter(isKataLetter).length;
  const kan=[...name].filter(isKanji).length;
  const den=kata+kan;
  if(!den) return null;
  return kata/den;
}
function phoneticDensities(readingHira){
  const kata=[...hiraToKata(readingHira)].filter(isKataLetter); const L=kata.length||1;
  const smalls=new Set("ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®".split("")); const voiced=new Set("ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒãƒ´".split(""));
  const last=kata[kata.length-1]||""; const plos=new Set("ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ‘ãƒ”ãƒ—ãƒšãƒãƒãƒ“ãƒ–ãƒ™ãƒœ".split(""));
  const d=kata.filter(ch=>voiced.has(ch)).length/L; const s=kata.filter(ch=>'ãƒƒ'===ch).length/L; const m=kata.filter(ch=>smalls.has(ch)).length/L; const e=plos.has(last)?1:0;
  return {d,s,m,e};
}

/* ========== ã‚¹ãƒ†ç®— ========= */
function calcStats(name, rank, type, readingHira){
  const T=visibleLength(name);
  // æ§‹æˆ25%
  let atk_struct,def_struct;{
    const r=rKataForStructure(name);
    if(r===null){ atk_struct=0.125; def_struct=0.125; }
    else { atk_struct=0.25*r; def_struct=0.25-atk_struct; }
  }
  // éŸ³20%
  let atk_phon,def_phon;{
    const {d,s,m,e}=phoneticDensities(readingHira);
    const Lw=0.05, Uw=0.45;
    const s_raw=0.6*d+0.25*(s+m)+0.15*e;
    const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);
    atk_phon=0.2*(0.5+0.5*s_ph);
    def_phon=0.2-atk_phon;
  }
  // é•·ã•20%
  let atk_len,def_len;{
    const s_len=clamp((6-T)/6,-1,1);
    atk_len=0.2*(0.5+0.5*s_len);
    def_len=0.2-atk_len;
  }
  const atk_pct=0.175+atk_struct+atk_phon+atk_len;
  const def_pct=0.175+def_struct+def_phon+def_len;
  const P=P_RANK[rank];
  const ATK=Math.round(P*atk_pct);
  const DEF=Math.round(P*def_pct);
  const HP=HP_BASE[rank]+20*(T-5);
  let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];
  eva=clamp(eva,5,35);
  return {ATK,DEF,HP,Evasion:eva};
}

const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};

function createFighter([name,rank,type,reading]){
  const st=calcStats(name,rank,type,reading);
  return {name,rank,type,reading,base:st,hp:st.HP,gauge:0,atkMult:1,defMult:1,atkTurns:0,defTurns:0,evadeOverride:null,endure:false,skipTurns:0,gestaltTurns:0,doomTurns:0,genronTurns:0,_gorillaActive:false,_manualForce:false,_gFull:false};
}

function computeDamageDetailed(att,def,isSpecial,rng){
  if(!isSpecial){
    const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
    if(rng()<eva) return {dmg:0,miss:true,luck:'normal',matchup:'even'};
  }
  let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
  dmg*=att.atkMult;
  const tm=typeMult(att.type,def.type); dmg*=tm;
  const r=rng(); let luck='normal';
  if(r<0.2){ dmg*=1.2; luck='lucky'; } else if(r<0.4){ dmg*=0.8; luck='unlucky'; }
  const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
  return {dmg,miss:false,luck,matchup};
}

/* ========== ãƒˆãƒ¼ã‚¹ãƒˆ(1.5å€) ========== */
const TOAST_MS=4200;
const toast=document.getElementById('toast'); let queue=[],busy=false;
function show(text,ms=TOAST_MS){ queue.push({text,ms}); if(!busy) nextToast(); }
function nextToast(){ if(queue.length===0){ busy=false; return; } busy=true; const {text,ms}=queue.shift(); toast.textContent=text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(nextToast,180); }, ms); }

/* ========== ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
const handLabel=h=>h==='g'?'ã‚°ãƒ¼':(h==='c'?'ãƒãƒ§ã‚­':'ãƒ‘ãƒ¼');
function narrRPS(my,cpu,res){
  const me=handLabel(my||'g'), op=handLabel(cpu);
  const result = res===-1?'ã‚ã„ã“':(res===0?'ã‚ãªãŸã®ï¼ˆå‹ã¡ï¼‰':'ã‚ãªãŸã®ï¼ˆè² ã‘ï¼‰');
  show(`ã‚ãªãŸã¯ï¼ˆ${me}ï¼‰ã€‚ç›¸æ‰‹ã¯ï¼ˆ${op}ï¼‰ã€‚${result}ã€‚`);
}
function narrAttackLine(attackerName,dmg,luck,matchup){
  const luckTxt = luck==='lucky'?'ï¼ˆãƒ©ãƒƒã‚­ãƒ¼ï¼ï¼‰': luck==='unlucky'?'ï¼ˆã‚¢ãƒ³ãƒ©ãƒƒã‚­ãƒ¼â€¦ï¼‰':'';
  const muTxt   = matchup==='good'?' ç›¸æ€§æŠœç¾¤ï¼': matchup==='bad'?' ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':'';
  show(`${attackerName}ã®æ”»æ’ƒï¼${luckTxt} ${Math.round(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${muTxt}`);
}

/* ========== å¿…æ®ºFX ========== */
const fx=document.getElementById('fx'), fxText=document.getElementById('fxText');
function playSpFx(title){ fxText.textContent=title; fx.classList.add('show'); setTimeout(()=>fx.classList.remove('show'), 900); }

/* ========== ã‚¢ã‚¿ãƒƒã‚¯ ========== */
function dealAttack(actor,target,isSpecial,rng){
  if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; show(`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100`); return {self:true, msg:`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100`}; }
  const sp=SPECIALS[actor.name];
  if(isSpecial && sp && sp.kind==='multi'){
    const keep=actor.atkMult; let total=0, anyLucky=false, anyUnlucky=false, matchup='even';
    for(const s of sp.params.hits){
      actor.atkMult=keep*s;
      const info=computeDamageDetailed(actor,target,true,rng);
      total+=info.dmg;
      if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
      if(info.luck==='lucky') anyLucky=true; if(info.luck==='unlucky') anyUnlucky=true;
      if(info.matchup==='good') matchup='good'; else if(info.matchup==='bad' && matchup!=='good') matchup='bad';
      if(target.hp<=0) break;
    }
    actor.atkMult=keep;
    const luck = anyLucky? 'lucky': anyUnlucky? 'unlucky':'normal';
    return { dmg:total, luck, matchup };
  } else {
    const info=computeDamageDetailed(actor,target,isSpecial,rng);
    if(info.miss) { show(`${actor.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`); return {dmg:0,miss:true}; }
    if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
    return info;
  }
}

/* ========== ã‚¿ãƒ¼ãƒ³é€²è¡Œ ========== */
function endOfTick(f){
  if(f.atkTurns>0 && --f.atkTurns===0) f.atkMult=1;
  if(f.defTurns>0 && --f.defTurns===0) f.defMult=1;
  if(f.evadeOverride && --f.evadeOverride.turns<=0) f.evadeOverride=null;
  if(f.skipTurns>0) f.skipTurns--;
  if(f.gestaltTurns>0) f.gestaltTurns--;
  if(f.genronTurns>0) f.genronTurns--;
  if(f.doomTurns>0 && --f.doomTurns===0) f.hp=0;
}
function endTurnAdjustments(f){ if(f._gorillaActive){ f.atkMult=1.3; f._gorillaActive=false; } }
function bdDesc(u){
  const eff = BD_ASSIGN[u.rank]?.[u.name];
  if(!eff) return 'çŠ¶æ…‹ç•°å¸¸å‹';
  return ({kotobagari:'è¨€è‘‰ç‹©ã‚Šï¼ˆè¡Œå‹•ä¸å¯1Tï¼‰',genron:'è¨€è«–çµ±åˆ¶ï¼ˆäº¤ä»£ä¸å¯4Tï¼‰',gestalt:'ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼ˆ4Tãƒ»1/3ã§è‡ªå‚·100ï¼‰',mojibake:'æ–‡å­—åŒ–ã‘ï¼ˆ3Tå¾Œå³æ­»ï¼‰'})[eff];
}
function briefDesc(sp){
  const k=sp.kind,p=sp.params;
  return ({
    buff_endure:`æ”»${p.atkMult}Ã—ï¼‹æ ¹æ€§1å›`,
    multi:`å¤šæ®µ ${p.hits.join(' / ')}Ã—`,
    gorilla:`åˆ${p.first}Ã—â†’${p.turns}T ${p.next}Ã—`,
    evasion:`æ”»${p.atkMult}Ã—ï¼‹å›é¿${Math.round(p.evade*100)}%Ã—${p.turns}T`,
    atk_def:`æ”»${p.atkMult}Ã—ï¼‹é˜²${p.defMult}Ã—(${p.turns}T)`,
    atk_heal:`æ”»${p.atkMult}Ã—ï¼‹å›å¾©${p.heal}`,
    atk_drain:`æ”»${p.atkMult}Ã—ï¼‹ç›¸æ‰‹ã‚²ãƒ¼ã‚¸0`,
    heal_attack_all:`é€šå¸¸ï¼‹è‡ª${p.self}/å‘³${p.allies}å›å¾©`,
  })[k] || '';
}

function applySpecialPre(actor,target,allies,enemies,rng){
  if(actor.gauge<GAUGE_NEEDED||actor.skipTurns>0) return {used:false};
  if(target.genronTurns>0 && typeMult(actor.type,target.type)<1.0 && !actor._manualForce) return {used:false};
  let used=false, label='', explain='';

  if(actor.rank==='X'){
    const cands=enemies.filter(e=>e.rank!=='X'&&e.hp>0);
    if(cands.length){
      const picked=cands[Math.floor(rng()*cands.length)];
      actor.atkMult*=2.0; actor.atkTurns=Math.max(actor.atkTurns,1);
      const bn=actor.name, br=actor.rank, gKeep=actor.gauge;
      actor.name=picked.name; actor.rank=picked.rank;
      const _=applySpecialPre(actor,target,allies,enemies,rng);
      actor.name=bn; actor.rank=br; actor.gauge=gKeep;
      used=true; label=`å¿…æ®ºï¼é¡æ–‡å­— â†’ ${picked.name}`;
    }
  } else if(actor.rank==='A'||actor.rank==='S'){
    const sp=SPECIALS[actor.name];
    if(sp){
      label=`å¿…æ®ºï¼${sp.id}`;
      switch(sp.kind){
        case 'buff_endure': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.endure=true; used=true; explain=briefDesc(sp); break;
        case 'multi': used=true; explain=briefDesc(sp); break;
        case 'gorilla': actor.atkMult=sp.params.first; actor.atkTurns=Math.max(actor.atkTurns,1+sp.params.turns); actor._gorillaActive=true; used=true; explain=briefDesc(sp); break;
        case 'evasion': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.evadeOverride={rate:sp.params.evade,turns:sp.params.turns}; used=true; explain=briefDesc(sp); break;
        case 'atk_def': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.defMult*=sp.params.defMult; actor.defTurns=Math.max(actor.defTurns,sp.params.turns); used=true; explain=briefDesc(sp); break;
        case 'atk_heal': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.heal); used=true; explain=briefDesc(sp); break;
        case 'atk_drain': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); target.gauge=0; used=true; explain=briefDesc(sp); break;
        case 'heal_attack_all': actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.self); for(const al of allies){ if(al!==actor) al.hp=Math.min(al.base.HP, al.hp+sp.params.allies); } used=true; explain=briefDesc(sp); break;
      }
    }
  } else {
    const eff=BD_ASSIGN[actor.rank]?.[actor.name];
    if(eff){ AIL[eff].apply(target); used=true; label=`å¿…æ®ºï¼${AIL[eff].name} ${AIL[eff].icon}`; explain=AIL[eff].desc; }
  }

  if(used){ actor.gauge=Math.max(0,actor.gauge-GAUGE_NEEDED); actor._gFull=false; }
  return {used,label,explain};
}

/* ========== DOM/ç·¨æˆUI ========== */
const $=id=>document.getElementById(id);
const els={teamA:$('teamA'), teamB:$('teamB'), rand:$('randBoth'), toBattle:$('toBattle'), setup:$('setup'), battle:$('battle'), back:$('backSetup')};
function el(tag,attrs={},children=[]){ const e=document.createElement(tag); for(const k in attrs){ if(k==='class') e.className=attrs[k]; else if(k==='html') e.innerHTML=attrs[k]; else e.setAttribute(k,attrs[k]); } children.forEach(c=>e.append(c)); return e; }
function selectTpl(i){ return el('div',{class:'slot'},[ el('span',{class:'pill'},['#'+(i+1)]), buildSelect() ]); }
function buildSelect(){ const s=el('select'); for(const [n,r,t] of WORDS){ s.append( el('option',{value:n},[document.createTextNode(`${n} [${r}/${t}]`)]) ); } return s; }
function getSelections(box){ const sels=[...box.querySelectorAll('select')]; return sels.map(s=> WORDS.find(w=>w[0]===s.value)); }

const statsA=$('statsA'), statsB=$('statsB');
function setupMiniCard(tup){
  if(!tup) return null;
  const [n,r,t,read]=tup; const st=calcStats(n,r,t,read);
  const d=document.createElement('div'); d.className='setupMini';
  d.innerHTML=`<div class="head"><div>${n}</div><div class="small muted">[${r}/${t}]</div></div>
  <div class="nums"><div>HP ${st.HP}</div><div>å›é¿ ${st.Evasion.toFixed(1)}%</div><div>ATK ${st.ATK}</div><div>DEF ${st.DEF}</div></div>`;
  return d;
}
function renderSetupStatsCols(){
  const A=getSelections(els.teamA), B=getSelections(els.teamB);
  statsA.innerHTML=''; statsB.innerHTML='';
  A.forEach(t=>{const c=setupMiniCard(t); if(c) statsA.appendChild(c);});
  B.forEach(t=>{const c=setupMiniCard(t); if(c) statsB.appendChild(c);});
}
function updateOptionDisables(){
  const allSelects=[...els.teamA.querySelectorAll('select'), ...els.teamB.querySelectorAll('select')];
  allSelects.forEach(sel=>{ [...sel.options].forEach(opt=>opt.disabled=false); });
  const selected = new Map();
  allSelects.forEach(sel=> selected.set(sel, sel.value));
  allSelects.forEach(sel=>{
    [...sel.options].forEach(opt=>{
      const usedByOthers = [...selected.entries()].some(([s,v])=> s!==sel && v===opt.value);
      if(usedByOthers) opt.disabled=true;
    });
  });
}
function updateStats(){ renderSetupStatsCols(); updateOptionDisables(); }

for(let i=0;i<3;i++){ els.teamA.append(selectTpl(i)); els.teamB.append(selectTpl(i)); }
els.teamA.addEventListener('change',updateStats);
els.teamB.addEventListener('change',updateStats);

function initDifferentDefaults(){
  const all=[...els.teamA.querySelectorAll('select'), ...els.teamB.querySelectorAll('select')];
  const used=new Set();
  all.forEach((s,i)=>{ const pick = WORDS[(i*3)%WORDS.length][0]; s.value=used.has(pick)? WORDS[(i*5+7)%WORDS.length][0] : pick; used.add(s.value); });
  updateStats();
}
initDifferentDefaults();

function randomizeBoth(){
  const doBox=(box)=>{
    const sels=[...box.querySelectorAll('select')];
    const taken=new Set();
    sels.forEach(s=>{
      const opts=WORDS.filter(w=>!taken.has(w[0]) && ![...els.teamA.querySelectorAll('select'),...els.teamB.querySelectorAll('select')].some(other=>other!==s && other.value===w[0]));
      const pick=(opts.length?opts:WORDS)[Math.floor(Math.random()*(opts.length?opts.length:WORDS.length))];
      s.value=pick[0]; taken.add(pick[0]);
    });
  };
  doBox(els.teamA); doBox(els.teamB);
  updateStats();
}
$('randBoth').addEventListener('click', randomizeBoth);

/* ========== ç”»é¢é·ç§» ========== */
$('toBattle').addEventListener('click', ()=>{
  const okA=[...els.teamA.querySelectorAll('select')].every(Boolean);
  const okB=[...els.teamB.querySelectorAll('select')].every(Boolean);
  if(!okA||!okB){ alert('3ä½“ãšã¤é¸ã‚“ã§ãã ã•ã„'); return; }
  els.setup.classList.add('hidden'); els.battle.classList.remove('hidden'); document.body.classList.add('battleMode');
  els.setup.style.display='none'; els.battle.style.display='block';
  startNewSession(); renderHUD(SESSION);
  document.querySelector('.vsrow')?.scrollIntoView({block:'start'});
});
$('backSetup').addEventListener('click', ()=>{
  stopTimer();
  els.setup.classList.remove('hidden'); els.battle.classList.add('hidden'); document.body.classList.remove('battleMode');
  els.setup.style.display=''; els.battle.style.display='none';
});

/* ========== HUD ========== */
const leftWrap=$('leftWrap'), rightWrap=$('rightWrap'), benchBar=$('benchBar'), summary=$('summary'), sixStats=$('sixStats'), countNum=$('countNum');
function unitView(u,foe,side){
  const wrap=el('div',{class:'unit '+(side==='ally'?'ally':'enemy')});
  wrap.append( el('div',{class:'nameRow'},[ el('div',{class:'name'},[u.name]), el('div',{class:'tag'},[`[${u.type}]`]) ]) );
  const hpRow=el('div'); hpRow.append( el('div',{class:'small muted'},[`HP ${Math.max(0,Math.ceil(u.hp))}/${u.base.HP}`]) );
  const bar=el('div',{class:'bar'},[ el('span',{style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`}) ]);
  hpRow.append(bar); wrap.append(hpRow);
  const g=el('div',{class:'gauge'}); const gShow=Math.min(6,Math.max(0,Math.floor(u.gauge)));
  for(let i=0;i<6;i++){ const p=el('div',{class:'pip'+(i<gShow?' on':'')}); if(i===5 && gShow===6) p.classList.add('readyPulse'); g.append(p); }
  wrap.append(g);
  const mu=foe?typeMult(u.type,foe.type).toFixed(2):'1.00';
  const meta=el('div',{class:'meta'},[
    el('div',{class:'line'},[ el('span',{},['ç›¸æ€§']), el('span',{},[`Ã—${mu}`]) ]),
    el('div',{class:'line'},[ el('span',{},['å¿…æ®º']),
      el('span',{},[ SPECIALS[u.name] ? `${SPECIALS[u.name].id}ï½œ${briefDesc(SPECIALS[u.name])}` : bdDesc(u) ])
    ])
  ]);
  wrap.append(meta);
  return wrap;
}
function miniCard(u,side){
  if(!u) return el('div');
  const card=el('div',{class:'miniCard '+side});
  card.append( el('div',{class:'miniHead'},[ el('div',{},[u.name]), el('div',{class:'small muted'},[`[${u.type}]`]) ]) );
  card.append( el('div',{class:'small muted'},[`HP ${Math.max(0,Math.ceil(u.hp))}/${u.base.HP}`]) );
  card.append( el('div',{class:'miniBar'},[ el('span',{style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`}) ]) );
  return card;
}
function renderSixStats(A,B){
  sixStats.innerHTML='';
  for(let i=0;i<3;i++){ sixStats.append( miniCard(A[i],'ally') ); sixStats.append( miniCard(B[i],'enemy') ); }
}
function benchChips(A,ia,foe){
  benchBar.innerHTML='';
  const bench=A.slice(ia+1).filter(x=>x.hp>0).slice(0,2);
  bench.forEach(u=>{
    const chip=el('div',{class:'benchChip'});
    chip.innerHTML=`<span class="name">${u.name}</span><span class="type">[${u.type}]</span><span class="ratio">Ã—${typeMult(u.type,foe.type).toFixed(2)}</span>`;
    benchBar.append(chip);
  });
}
function renderHUD(s){
  leftWrap.innerHTML=''; rightWrap.innerHTML='';
  const a=s.A[s.ia], b=s.B[s.ib];
  if(a) leftWrap.append( unitView(a,b,'ally') );
  if(b) rightWrap.append( unitView(b,a,'enemy') );
  benchChips(s.A,s.ia,b);
  renderSixStats(s.A,s.B);
}

/* ========== æ‰‹ãƒ»å¿…æ®ºãƒ»äº¤ä»£ ========== */
let SELECTED_HAND=null, USE_SP=false;
let REQUEST_SWITCH=false, SWITCH_TARGET_INDEX=null;
let WAITING_KO=false;
const rpsRes=(a,b)=> a===b?-1 : ((a==='g'&&b==='c')||(a==='c'&&b==='p')||(a==='p'&&b==='g')?0:1);

$('handG').onclick=()=>{ if(WAITING_KO) return; SELECTED_HAND='g'; stepNow(); };
$('handC').onclick=()=>{ if(WAITING_KO) return; SELECTED_HAND='c'; stepNow(); };
$('handP').onclick=()=>{ if(WAITING_KO) return; SELECTED_HAND='p'; stepNow(); };
$('btnSP').onclick=()=>{ USE_SP=!USE_SP; $('btnSP').textContent=USE_SP?'âœ¨ å¿…æ®º ON':'âœ¨ å¿…æ®º OFF'; $('btnSP').classList.toggle('on', USE_SP); };

const switchModal=$('switchModal'), switchList=$('switchList'), switchTitle=$('switchTitle');
$('btnSwitch').onclick=()=>{ if(WAITING_KO) return; stopTimer(); openSwitchModal('manual'); };
$('cancelSwitch').onclick=()=>{ switchModal.style.display='none'; SWITCH_TARGET_INDEX=null; if(WAITING_KO) openSwitchModal('ko'); else startTimer(); };
$('doSwitch').onclick=()=>{
  if(SWITCH_TARGET_INDEX==null) return;
  if(WAITING_KO){
    switchIn(SESSION.A, SESSION.ia, SWITCH_TARGET_INDEX, 'A');
    const name=SESSION.A[SESSION.ia].name;
    show(`ã„ã‘ã€${name}ï¼`);
    switchModal.style.display='none'; SWITCH_TARGET_INDEX=null; WAITING_KO=false;
    renderHUD(SESSION); startTimer();
  }else{
    REQUEST_SWITCH=true; switchModal.style.display='none'; stepOnce();
  }
};
function openSwitchModal(mode){
  const s=SESSION;
  if(mode==='manual'){
    const bench=s.A.slice(s.ia+1).map((u,rel)=>({u,abs:s.ia+1+rel})).filter(x=>x.u.hp>0);
    if(bench.length===0){ show('æ§ãˆãŒã„ã¾ã›ã‚“'); startTimer(); return; }
    switchTitle.textContent='äº¤ä»£å…ˆã‚’é¸æŠ';
    switchList.innerHTML='';
    const foe=s.B[s.ib];
    bench.forEach(({u,abs})=>{
      const ratio=typeMult(u.type,foe.type);
      const opt=el('div',{class:'opt','data-abs':abs},[
        el('div',{},[`${u.name} [${u.type}]`]),
        el('div',{class:'right'},[
          el('span',{class:'badge'},[`Ã—${ratio.toFixed(2)}`]),
          ...(ratio>1.0?[el('span',{class:'badge best'},['ãŠã™ã™ã‚'])]:[])
        ])
      ]);
      opt.onclick=()=>{ [...switchList.children].forEach(ch=>ch.classList.remove('selected')); opt.classList.add('selected'); SWITCH_TARGET_INDEX=abs; };
      switchList.append(opt);
    });
    SWITCH_TARGET_INDEX=null;
    switchModal.style.display='grid';
  } else {
    const benchIdx=chooseBestCPUAfterKO(s.A,s.ia+1,s.B[s.ib]);
    if(benchIdx==null){ summary.textContent='çµæœï¼šCPUã®å‹ã¡'; renderHUD(s); stopTimer(); return; }
    switchTitle.textContent='äº¤ä»£å…ˆã‚’é¸æŠï¼ˆæ’ƒç ´ï¼‰';
    switchList.innerHTML='';
    const foe=s.B[s.ib];
    for(let i=s.ia+1;i<s.A.length;i++){
      if(s.A[i].hp<=0) continue;
      const u=s.A[i], ratio=typeMult(u.type,foe.type);
      const opt=el('div',{class:'opt','data-abs':i},[
        el('div',{},[`${u.name} [${u.type}]`]),
        el('div',{class:'right'},[
          el('span',{class:'badge'},[`Ã—${ratio.toFixed(2)}`]),
          ...(ratio>1.0?[el('span',{class:'badge best'},['ãŠã™ã™ã‚'])]:[])
        ])
      ]);
      opt.onclick=()=>{ [...switchList.children].forEach(ch=>ch.classList.remove('selected')); opt.classList.add('selected'); SWITCH_TARGET_INDEX=i; };
      switchList.append(opt);
    }
    switchModal.style.display='grid';
  }
}

/* ========== ä¹±æ•°/ã‚»ãƒƒã‚·ãƒ§ãƒ³/ã‚¿ã‚¤ãƒãƒ¼ ========== */
function LCG(sd){ let s=sd>>>0; return ()=> (s=(1664525*s+1013904223)>>>0, (s>>>8)/16777216); }
const SELECT_SECS=15;
let SESSION=null, TIMER=null, TLEFT=SELECT_SECS;

function startNewSession(){
  const A=getSelections(els.teamA), B=getSelections(els.teamB);
  const rng=LCG((Date.now()|0)>>>0);
  SESSION={ rng, A:A.map(createFighter), B:B.map(createFighter), ia:0, ib:0, tick:0 };
  summary.textContent='ãƒãƒˆãƒ«ä¸­';
  renderHUD(SESSION);
  startTimer();
}
function startTimer(){
  stopTimer(); if(WAITING_KO) return;
  TLEFT=SELECT_SECS; countNum.textContent=TLEFT;
  TIMER=setInterval(()=>{
    TLEFT--; countNum.textContent=TLEFT;
    if(TLEFT<=0){
      stopTimer();
      if(!SELECTED_HAND && !REQUEST_SWITCH){
        SELECTED_HAND=['g','c','p'][Math.floor(SESSION.rng()*3)];
      }
      stepOnce();
    }
  },1000);
}
function stopTimer(){ if(TIMER){ clearInterval(TIMER); TIMER=null; } }

/* ========== AIäº¤ä»£é–¢é€£ ========== */
function decideSwitchCPU(me,bench,opp,rng){
  if(me.genronTurns>0) return -1;
  const aliveIdx = bench.map((u,i)=>i).filter(i=>bench[i].hp>0);
  if(!aliveIdx.length) return -1;
  const mySP=me.gauge>=GAUGE_NEEDED && me.skipTurns<=0;
  const oppSP=opp.gauge>=GAUGE_NEEDED && opp.skipTurns<=0;
  const EVnow=computeDamageDetailed(me,opp,mySP,rng).dmg - computeDamageDetailed(opp,me,oppSP,rng).dmg;
  let bestRel=null, bestScore=-1;
  aliveIdx.forEach(rel=>{
    const cand=bench[rel];
    const score=typeMult(cand.type,opp.type);
    if(score>bestScore){ bestScore=score; bestRel=rel; }
  });
  const gain = bestScore - typeMult(me.type,opp.type);
  if(EVnow<-20 && gain>0.25) return bestRel;
  return -1;
}
function chooseBestCPUAfterKO(team,startIndex,foe){
  let bestIdx=null, bestScore=-1;
  for(let i=startIndex;i<team.length;i++){
    if(team[i].hp>0){
      const score=typeMult(team[i].type,foe.type);
      if(score>bestScore){ bestScore=score; bestIdx=i; }
    }
  }
  return bestIdx;
}

/* ========== ã‚²ãƒ¼ã‚¸é€šçŸ¥ ========== */
let gaugeNotices=[];
function incGauge(u,side){
  u.gauge=Math.min(GAUGE_NEEDED,u.gauge+1);
  if(u.gauge>=GAUGE_NEEDED && !u._gFull){ gaugeNotices.push({side,name:u.name}); u._gFull=true; }
}
function flushGaugeNotices(){
  if(gaugeNotices.length===0) return;
  const Afirst=gaugeNotices.filter(n=>n.side==='A');
  const Bnext =gaugeNotices.filter(n=>n.side==='B');
  [...Afirst,...Bnext].forEach(n=> show(`${n.name} ã®ã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼ å¿…æ®ºOK`) );
  gaugeNotices=[];
}

/* ========== äº¤ä»£&KO ========== */
function switchIn(team,iFrom,iTo,sideTag){
  [team[iFrom],team[iTo]]=[team[iTo],team[iFrom]];
  team[iFrom].gauge=0; team[iTo].gauge=0;
  team[iTo].skipTurns=team[iTo].gestaltTurns=team[iTo].doomTurns=team[iTo].genronTurns=0;
}
function handleKOImmediate(){
  const s=SESSION;

  while(s.ia<3 && s.A[s.ia].hp<=0){
    s.ia++;
    if(s.ia<3){
      WAITING_KO=true; openSwitchModal('ko'); renderHUD(s); stopTimer(); return 'wait';
    }else{ summary.textContent='çµæœï¼šCPUã®å‹ã¡'; renderHUD(s); stopTimer(); return 'end'; }
  }
  while(s.ib<3 && s.B[s.ib].hp<=0){
    s.ib++;
    if(s.ib<3){
      const bestIdx=chooseBestCPUAfterKO(s.B,s.ib,s.A[s.ia]);
      if(bestIdx!=null && bestIdx!==s.ib){ switchIn(s.B,s.ib,bestIdx,'B'); }
      show(`ç›¸æ‰‹ã¯ ${s.B[s.ib].name} ã‚’ãã‚Šã ã—ãŸï¼`);
    }else{ summary.textContent='çµæœï¼šã‚ãªãŸã®å‹ã¡'; renderHUD(s); stopTimer(); return 'end'; }
  }
  return 'cont';
}

/* ========== ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ ========== */
function stepNow(){ stopTimer(); if(!SELECTED_HAND && !REQUEST_SWITCH) return; stepOnce(); }
function stepOnce(){
  const s=SESSION; s.tick++;

  let stat=handleKOImmediate(); if(stat!=='cont') return;

  let a=s.A[s.ia], b=s.B[s.ib];

  // äººé–“ã®é€šå¸¸äº¤ä»£
  if(REQUEST_SWITCH && SWITCH_TARGET_INDEX!=null){
    switchIn(s.A,s.ia,SWITCH_TARGET_INDEX,'A'); a=s.A[s.ia];
    show(`ã„ã‘ã€${a.name}ï¼`);

    const used=applySpecialPre(b,a,s.B,s.A,s.rng);
    show(`ã‚ãªãŸã¯ï¼ˆäº¤ä»£ï¼‰ã€‚ç›¸æ‰‹ã¯ï¼ˆæ”»æ’ƒï¼‰ã€‚ã‚ãªãŸã®ï¼ˆè² ã‘ï¼‰ã€‚`);
    if(used.used){ playSpFx(used.label); show(`${used.label}`); if(used.explain) show(`åŠ¹æœï¼š${used.explain}`); }
    const info=dealAttack(b,a,used.used,s.rng);
    if(!info.miss) narrAttackLine(b.name,info.dmg,info.luck,info.matchup);

    endTurnAdjustments(b); endOfTick(a); endOfTick(b);

    stat=handleKOImmediate(); if(stat!=='cont'){ REQUEST_SWITCH=false; SWITCH_TARGET_INDEX=null; SELECTED_HAND=null; return; }

    REQUEST_SWITCH=false; SWITCH_TARGET_INDEX=null; SELECTED_HAND=null;
    incGauge(a,'A'); incGauge(b,'B'); renderHUD(s); flushGaugeNotices(); startTimer(); return;
  }

  // CPUäº¤ä»£
  const wantRel=decideSwitchCPU(b,s.B.slice(s.ib+1),a,s.rng);
  if(wantRel>=0){
    const absIdx=s.ib+1+wantRel;
    switchIn(s.B,s.ib,absIdx,'B'); b=s.B[s.ib];
    show(`ç›¸æ‰‹ã¯ ${b.name} ã‚’ãã‚Šã ã—ãŸï¼`);

    const used=applySpecialPre(a,b,s.A,s.B,s.rng);
    show(`ã‚ãªãŸã¯ï¼ˆæ”»æ’ƒï¼‰ã€‚ç›¸æ‰‹ã¯ï¼ˆäº¤ä»£ï¼‰ã€‚ã‚ãªãŸã®ï¼ˆå‹ã¡ï¼‰ã€‚`);
    if(used.used){ playSpFx(used.label); show(`${used.label}`); if(used.explain) show(`åŠ¹æœï¼š${used.explain}`); }
    const info=dealAttack(a,b,used.used,s.rng);
    if(!info.miss) narrAttackLine(a.name,info.dmg,info.luck,info.matchup);

    endTurnAdjustments(a); endOfTick(a); endOfTick(b);

    stat=handleKOImmediate(); if(stat!=='cont'){ SELECTED_HAND=null; return; }

    SELECTED_HAND=null;
    incGauge(a,'A'); incGauge(b,'B'); renderHUD(s); flushGaugeNotices(); startTimer(); return;
  }

  // ã˜ã‚ƒã‚“ã‘ã‚“
  const cpu=['g','c','p'][Math.floor(s.rng()*3)];
  const res=rpsRes(SELECTED_HAND||'g',cpu);
  narrRPS(SELECTED_HAND,cpu,res);

  if(res===-1){
    endOfTick(a); endOfTick(b);
    stat=handleKOImmediate(); if(stat!=='cont'){ SELECTED_HAND=null; return; }
    SELECTED_HAND=null;
    incGauge(a,'A'); incGauge(b,'B'); renderHUD(s); flushGaugeNotices(); startTimer(); return;
  }

  // å‹è€…è¡Œå‹•
  const actor=res===0?a:b, target=res===0?b:a;
  let usedInfo={used:false};
  if(actor.skipTurns<=0){
    if(actor===a && USE_SP) a._manualForce=true;
    usedInfo=applySpecialPre(actor,target,res===0?s.A:s.B,res===0?s.B:s.A,s.rng);
    a._manualForce=false;
    if(usedInfo.used){ playSpFx(usedInfo.label); show(`${usedInfo.label}`); if(usedInfo.explain) show(`åŠ¹æœï¼š${usedInfo.explain}`); }
    const rr=dealAttack(actor,target,usedInfo.used,s.rng);
    if(!rr.miss) narrAttackLine(actor.name,rr.dmg,rr.luck,rr.matchup);
    endTurnAdjustments(actor);
  } else {
    show(`${actor.name} ã¯è¨€è‘‰ç‹©ã‚Šã§è¡Œå‹•ä¸èƒ½`);
  }

  endOfTick(a); endOfTick(b);

  stat=handleKOImmediate(); if(stat!=='cont'){ SELECTED_HAND=null; return; }

  SELECTED_HAND=null;
  incGauge(a,'A'); incGauge(b,'B'); renderHUD(s); flushGaugeNotices(); startTimer();
}
}); // DOMContentLoaded
</script>
</body>
</html>
