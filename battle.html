<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLEï½œå¯¾æˆ¦ v7.4.1</title>
<style>
  :root{
    --bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;
    --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
    --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;--border:#1d2440;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px}.sub{margin:4px 0 12px;color:var(--muted)}
  .card{background:#0f1633;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}.ghost{background:transparent;border:1px dashed #2b3a70}

  /* ç·¨æˆï¼šç¸¦1ã‚«ãƒ©ãƒ ï¼‹ä¸‹ã«2åˆ—Ã—3æ®µã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
  #setup{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
  #statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #statsGrid .statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}

  .setupMini{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .setupMini .head{display:flex;justify-content:space-between;font-weight:700}
  .setupMini .nums{margin-top:4px;font-size:12px;color:#cfe2ff;display:grid;grid-template-columns:repeat(2,1fr);gap:4px}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}

  /* ãƒãƒˆãƒ«å…¨ç”»é¢ */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  .arena{position:relative;background:#0d1326;border-top:1px solid var(--border);padding:10px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;min-height:100vh}

  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:230px}
  .unit{border:1px solid #22325c;border-radius:12px;padding:10px;transition:transform .15s}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;color:#2a1700;background:#ffcf33;padding:2px 8px;border-radius:999px;border:1px solid #b08b13}
  .skillLine{margin-top:6px;padding:8px;border:1px solid #2c3a69;border-radius:10px;background:#0c1633}
  .skillTitle{display:flex;align-items:center;gap:8px;font-weight:900}
  .skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}

  .bar{height:12px;background:#12321f;border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:#6bff8b;width:0%}
  .hpAnim{transition:width .60s ease}

  .gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
  .gLabel{font-size:12px;color:#ffeaa7}
  .gauge{display:flex;gap:4px}
  .pip{width:14px;height:12px;background:#342b0b;border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:#ffe066;opacity:1}
  .readyPulse{animation:pulse 1.2s infinite} @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}

  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  /* ãƒ‘ãƒƒãƒ‰ï¼†æ§ãˆ */
  .pad{position:relative;margin-top:6px;border:1px solid #22335f;border-radius:14px;background:linear-gradient(180deg,#0d1530,#0b1428);padding:8px}
  .padInner{position:relative;width:min(520px,92vw);height:220px;margin:0 auto}
  .rps{position:absolute;display:grid;place-items:center;width:92px;height:92px;border-radius:999px;border:none;color:#061225}
  .rps .emo{font-size:34px;line-height:1}
  .rps .lbl{font-size:12px;margin-top:2px;font-weight:800}
  .rps.g{left:8%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
  .rps.c{right:8%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)}
  .switchBtn{position:absolute;right:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:132px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
  .spToggle:disabled{opacity:.5;filter:grayscale(.4);cursor:not-allowed}

  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-height:18vh;overflow:auto;padding:6px;border:1px dashed #2b3a70;border-radius:12px;background:#0a1733}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px;cursor:pointer}

  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{border:1px solid #1a2b54;border-radius:10px;padding:8px;cursor:pointer}
  .miniCard.ally{outline:2px solid var(--ally)} .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:#12321f;border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:#6bff8b;width:0%}

  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(12px);padding:10px 14px;border-radius:12px;background:rgba(12,22,50,.95);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50;max-width:min(92vw,720px);line-height:1.6}
  body.battleMode .toast{bottom:28vh}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}

  @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
  .shake{animation:shake .5s ease}

  /* ã‚¿ã‚¤ãƒ—è‰² */
  .t-ã‚¸ã‚ª{background:linear-gradient(180deg,#0f1730,#101f46)}
  .t-ã‚¢ãƒ‹ãƒãƒ«{background:linear-gradient(180deg,#0f1c30,#132c4f)}
  .t-ãƒ•ãƒ¼ãƒ‰{background:linear-gradient(180deg,#0f1a26,#1f2c46)}
  .t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ{background:linear-gradient(180deg,#12182e,#1b2544)}
  .t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹{background:linear-gradient(180deg,#0e1d2f,#0e2c48)}
  .t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼{background:linear-gradient(180deg,#12172a,#1b2142)}
  .t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³{background:linear-gradient(180deg,#121a28,#1e2941)}

  #bootErr{position:fixed;inset:10px 10px auto 10px;background:#2b0e12;color:#ffdede;border:1px solid #ff8080;border-radius:10px;padding:10px;display:none;z-index:100}
</style>
</head>
<body>
<header><div class="container">
  <h1>å¯¾æˆ¦ v7.4.1</h1>
  <div class="sub">é‡è¤‡å®£è¨€ä¿®æ­£ï¼å‹•ã‹ãªã„å•é¡Œè§£æ¶ˆç‰ˆ</div>
</div></header>

<div id="bootErr"></div>

<main class="container">
  <!-- ç·¨æˆ -->
  <section id="setup">
    <section class="card">
      <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
      <div class="body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">ã‚ãªãŸ</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="randBoth" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">å¯¾æˆ¦é–‹å§‹</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <div class="body">
        <div id="statsGrid">
          <div class="statsCol" id="statsA"></div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </section>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">ãƒãƒˆãƒ«</h2>
      <div class="body">
        <div class="arena">
          <div class="fx" id="fx" style="display:none;place-items:center;position:fixed;inset:0;z-index:60">
            <div id="fxText" style="font-weight:900;font-size:36px;padding:18px 24px;border-radius:14px;background:rgba(255,207,51,.95);color:#2a1700;border:2px solid #b08b13;box-shadow:0 8px 40px rgba(255,207,51,.35)">å¿…æ®ºï¼</div>
          </div>
          <div class="vsrow"><div id="leftWrap"></div><div id="rightWrap"></div></div>

          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
              <button class="rps c" id="handC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
              <button class="rps p" id="handP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
              <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
              <button class="spToggle" id="btnSP" disabled>âœ¨ å¿…æ®º OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <div class="timer"><span class="label">é¸æŠã¾ã§</span><span class="num" id="countNum">15</span><span class="label">ç§’</span></div>
          <div id="sixStats"></div>
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">ãƒãƒˆãƒ«æº–å‚™ä¸­</div>
          <button id="backSetup">ç·¨æˆã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="switchModal" style="display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:70">
  <div class="sheet" style="background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;max-width:min(92vw,520px);padding:12px">
    <h3 id="switchTitle" style="margin:0 0 8px;font-size:16px">äº¤ä»£å…ˆã‚’é¸æŠ</h3>
    <div id="switchList" style="max-height:50vh;overflow:auto"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button style="background:linear-gradient(90deg,#69d3ff,#2fb1ff);border:none;color:#061225" id="doSwitch">äº¤ä»£ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ -->
<div class="modal" id="infoModal" style="display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80">
  <div class="sheet" style="background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;max-width:min(92vw,520px);padding:12px">
    <h3 id="infoTitle" style="margin:0 0 8px;font-size:16px">æƒ…å ±</h3>
    <div id="infoBody" class="setupMini"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="infoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
(()=>{try{
/* ============= ãƒ‡ãƒ¼ã‚¿ ============= */
const WORDS=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const BD_ASSIGN={B:{"ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"kotobagari","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"genron","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"kotobagari","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"genron","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"genron","ãƒ”ãƒ­ãƒªèŒ":"gestalt","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"gestalt"},C:{"ã•ã‚‹ã³ã‚ä¸¸":"kotobagari","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"kotobagari","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"genron","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"genron","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"gestalt","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"gestalt","é³¥å–ç ‚ä¸˜":"mojibake","æ¸¡æ¥äºº":"mojibake"},D:{"ã‚¯ãƒãƒ³ãƒãƒ":"genron","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"gestalt","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"gestalt","çœŒåºæ‰€åœ¨åœ°":"mojibake","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"mojibake"}};
const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150}, HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500}, EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
const BASE_POWER=100, GAUGE_NEEDED=6;
const RING=["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"];
const TYPE_ADV=Object.fromEntries(RING.map((t,i)=>{const n=RING.length;return [t,{strong:[RING[(i+1)%n],RING[(i+2)%n]],weak:[RING[(i-1+n)%n],RING[(i-2+n)%n]]}] }));

const SPECIALS={
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":{ id:"ãªã‚“ãã‚‹ãªã„ã•ãƒ¼", kind:"buff_endure", params:{atkMult:1.6} },
  "ãã¼ã‚ã”ã¯ã‚“":{ id:"ãã¼ã‚ä¹±èˆ", kind:"multi", params:{hits:[0.75,0.5,0.25]} },
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":{ id:"ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":{ id:"ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©", kind:"evasion", params:{atkMult:1.4,evade:0.60,turns:3} },
  "ä¹å“ä»":{ id:"ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§", kind:"atk_def", params:{atkMult:1.6,defMult:1.8,turns:3} },
  "ã‘ã‚“ã¡ã‚“æ±":{ id:"é•·å¯¿ã®ç§˜è¨£", kind:"atk_heal", params:{atkMult:1.2,heal:150} },
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":{ id:"å¦¨å®³é›»æ³¢", kind:"atk_drain", params:{atkMult:2.5} },
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":{ id:"ä¸€æ¯ã„ã‹ãŒ", kind:"heal_attack_all", params:{self:60,allies:60} },
};
const AIL={
  kotobagari:{name:"è¨€è‘‰ç‹©ã‚Š",icon:"ğŸš«",desc:"1ã‚¿ãƒ¼ãƒ³ã®é–“ã€è¡Œå‹•ã§ããªããªã‚‹ã€‚"},
  genron:{name:"è¨€è«–çµ±åˆ¶",icon:"ğŸ”’",desc:"ä¸€å®šã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£ã§ããªããªã‚‹ã€‚"},
  gestalt:{name:"ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š",icon:"ğŸŒ€",desc:"ä¸€å®šã‚¿ãƒ¼ãƒ³ã®é–“ã€æ”»æ’ƒã®ãŸã³ã«1/3ã§è‡ªåˆ†ã«100ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"},
  mojibake:{name:"æ–‡å­—åŒ–ã‘",icon:"â˜ ï¸",desc:"3ã‚¿ãƒ¼ãƒ³å¾Œã«æ°—çµ¶ã™ã‚‹ã€‚äº¤ä»£ã§è§£é™¤ã§ãã‚‹ã€‚"}
};
const AIL_TURNS={kotobagari:1,genron:4,gestalt:4,mojibake:3};

/* ============= util ============= */
const $=id=>document.getElementById(id);
const isHira=c=>/[\u3041-\u3096]/.test(c);
const isKataLetter=c=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(c);
const isKanji=c=>{const x=c.codePointAt(0);return (x>=0x4E00&&x<=0x9FFF)||(x>=0x3400&&x<=0x4DBF)};
const isKanaOrKanji=c=>isHira(c)||isKataLetter(c)||isKanji(c);
const hiraToKata=s=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
const visibleLength=s=>[...s].length;
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
const typeClass=t=>'t-'+t;

/* ============= ã‚¹ãƒ†ç®— ============= */
function hiraRatioForEvasion(name){const letters=[...name].filter(isKanaOrKanji);if(!letters.length)return 0;const hira=letters.filter(isHira).length;return hira/letters.length;}
function rKataForStructure(name){const kata=[...name].filter(isKataLetter).length;const kan=[...name].filter(isKanji).length;const den=kata+kan;if(!den)return null;return kata/den;}
function phoneticDensities(readingHira){const kata=[...hiraToKata(readingHira)].filter(isKataLetter);const L=kata.length||1;const smalls=new Set("ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®".split(""));const voiced=new Set("ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒãƒ´".split(""));const last=kata[kata.length-1]||"";const plos=new Set("ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ‘ãƒ”ãƒ—ãƒšãƒãƒãƒ“ãƒ–ãƒ™ãƒœ".split(""));const d=kata.filter(ch=>voiced.has(ch)).length/L;const s=kata.filter(ch=>'ãƒƒ'===ch).length/L;const m=kata.filter(ch=>smalls.has(ch)).length/L;const e=plos.has(last)?1:0;return {d,s,m,e};}
function calcStats(name,rank,type,readingHira){
  const T=visibleLength(name);
  let atk_struct,def_struct;{const r=rKataForStructure(name);if(r===null){atk_struct=0.125;def_struct=0.125;}else{atk_struct=0.25*r;def_struct=0.25-atk_struct;}}
  let atk_phon,def_phon;{const {d,s,m,e}=phoneticDensities(readingHira);const Lw=0.05,Uw=0.45;const s_raw=0.6*d+0.25*(s+m)+0.15(e);const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);atk_phon=0.2*(0.5+0.5*s_ph);def_phon=0.2-atk_phon;}
  let atk_len,def_len;{const s_len=clamp((6-T)/6,-1,1);atk_len=0.2*(0.5+0.5*s_len);def_len=0.2-atk_len;}
  const atk_pct=0.175+atk_struct+atk_phon+atk_len, def_pct=0.175+def_struct+def_phon+def_len;
  const P=P_RANK[rank], ATK=Math.round(P*atk_pct), DEF=Math.round(P*def_pct);
  const HP=HP_BASE[rank]+20*(T-5);
  let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];eva=clamp(eva,5,35);
  return {ATK,DEF,HP,Evasion:eva};
}
const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT];if(!m)return 1;if(m.strong.includes(defT))return 1.5;if(m.weak.includes(defT))return 0.67;return 1};

/* ============= ãƒˆãƒ¼ã‚¹ãƒˆ ============= */
const toast=$('toast'); let queue=[],busy=false,afterEmpty=[];
const autoMs=text=>Math.max(1100,Math.min(Math.round(1200+text.length*25),3600));
function show(text,ms){queue.push({text,ms:ms??autoMs(text)});if(!busy)nextToast();}
function nextToast(){if(queue.length===0){busy=false;const q=afterEmpty.splice(0);q.forEach(fn=>fn());return;}busy=true;const{ text,ms }=queue.shift();toast.textContent=text;toast.classList.add('show');setTimeout(()=>{toast.classList.remove('show');setTimeout(nextToast,160);},ms);}
const runAfterAnnouncements=fn=>{(busy||queue.length)?afterEmpty.push(fn):fn();};
const fx=$('fx'), fxText=$('fxText'); const playSpFx=t=>{fxText.textContent=t;fx.style.display='grid';setTimeout(()=>fx.style.display='none',820);};

/* ============= ç·¨æˆUI ============= */
const els={teamA:$('teamA'), teamB:$('teamB'), setup:$('setup'), battle:$('battle')};
const statsA=$('statsA'), statsB=$('statsB');
const elmk=(tag,attrs={},children=[])=>{const e=document.createElement(tag);for(const k in attrs){if(k==='class')e.className=attrs[k];else if(k==='html')e.innerHTML=attrs[k];else e.setAttribute(k,attrs[k]);}children.forEach(c=>e.append(c));return e;};
const buildSelect=()=>{const s=elmk('select'); for(const [n,r,t] of WORDS){const o=elmk('option',{value:n},[document.createTextNode(`${n} [${r}/${t}]`)]); s.append(o);} return s;};
const selectTpl=i=>elmk('div',{class:'slot'},[ elmk('span',{class:'pill'},['#'+(i+1)]), buildSelect() ]);
const getSelections=box=>[...box.querySelectorAll('select')].map(s=>WORDS.find(w=>w[0]===s.value)).filter(Boolean);
const setupMiniCard=tup=>{if(!tup)return null;const [n,r,t,read]=tup;const st=calcStats(n,r,t,read);const d=document.createElement('div');d.className='setupMini '+typeClass(t);d.innerHTML=`<div class="head"><div>${n}</div><div class="small muted">[${t}]</div></div><div class="nums"><div>HP ${st.HP}</div><div>å›é¿ ${st.Evasion.toFixed(1)}%</div><div>ATK ${st.ATK}</div><div>DEF ${st.DEF}</div></div>`;return d;};
function renderSetupStatsCols(){const A=getSelections(els.teamA),B=getSelections(els.teamB);statsA.innerHTML='';statsB.innerHTML='';A.forEach(t=>statsA.append(setupMiniCard(t)));B.forEach(t=>statsB.append(setupMiniCard(t))); }
function updateOptionDisables(){const all=[...els.teamA.querySelectorAll('select'),...els.teamB.querySelectorAll('select')];const picked=new Set(all.map(s=>s.value));all.forEach(sel=>{[...sel.options].forEach(opt=>{opt.disabled=(opt.value!==sel.value)&&picked.has(opt.value);});});}
const updateStats=()=>{renderSetupStatsCols();updateOptionDisables();};
for(let i=0;i<3;i++){els.teamA.append(selectTpl(i));els.teamB.append(selectTpl(i));}
els.teamA.addEventListener('change',updateStats);els.teamB.addEventListener('change',updateStats);
function initDifferentDefaults(){const all=[...els.teamA.querySelectorAll('select'),...els.teamB.querySelectorAll('select')];const used=new Set();all.forEach((s,i)=>{let k=(i*4)%WORDS.length;while(used.has(WORDS[k][0]))k=(k+3)%WORDS.length;s.value=WORDS[k][0];used.add(s.value);});updateStats();}
initDifferentDefaults();
$('randBoth').onclick=()=>{const used=new Set();const fill=box=>{[...box.querySelectorAll('select')].forEach(s=>{const opts=WORDS.filter(w=>!used.has(w[0]));const pick=opts[Math.floor(Math.random()*opts.length)];s.value=pick[0];used.add(pick[0]);});};fill(els.teamA);fill(els.teamB);updateStats();};

/* ============= ç”»é¢é·ç§» ============= */
$('toBattle').onclick=()=>{if(getSelections(els.teamA).length<3||getSelections(els.teamB).length<3){alert('3ä½“ãšã¤é¸ã‚“ã§ãã ã•ã„');return;}els.setup.classList.add('hidden');els.battle.classList.remove('hidden');document.body.classList.add('battleMode');els.setup.style.display='none';els.battle.style.display='block';startNewSession();renderHUD(SESSION,true);const a0=SESSION.A[SESSION.ia].name,b0=SESSION.B[SESSION.ib].name;show(`ã„ã‘ã€${a0}ï¼ ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼`);show(`ç›¸æ‰‹ã¯${b0}ã‚’ãã‚Šã ã—ãŸï¼`);startTimerWhenIdle();};
$('backSetup').onclick=()=>{stopTimer();els.setup.classList.remove('hidden');els.battle.classList.add('hidden');document.body.classList.remove('battleMode');els.setup.style.display='';els.battle.style.display='none';};

/* ============= HUD / æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« ============= */
const leftWrap=$('leftWrap'), rightWrap=$('rightWrap'), benchBar=$('benchBar'), sixStats=$('sixStats'), countNum=$('countNum'), summary=$('summary'), btnSP=$('btnSP');
const infoModal=$('infoModal'), infoBody=$('infoBody'), infoTitle=$('infoTitle'); $('infoClose').onclick=()=>infoModal.style.display='none';
const briefDesc=sp=>({buff_endure:`ã“ã®æ”»æ’ƒã¯${sp.params.atkMult}å€ã€‚æ¬¡ã«è‡´æ­»ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã¦ã‚‚1ã§è¸ã¿ã¨ã©ã¾ã‚‹ï¼ˆ1å›ï¼‰ã€‚`,multi:`3å›é€£ç¶šã§æ”»æ’ƒï¼ˆ${sp.params.hits.join(' / ')}å€ï¼‰ã€‚é€”ä¸­ã§ç›¸æ‰‹ãŒå€’ã‚Œã¦ã‚‚æ¬¡ã¸ç¶šãã€‚`,gorilla:`ã“ã®æ”»æ’ƒã¯${sp.params.first}å€ã€‚ä»¥é™${sp.params.turns}ã‚¿ãƒ¼ãƒ³ã¯æ”»æ’ƒ${sp.params.next}å€ãŒç¶šãã€‚`,evasion:`ã“ã®æ”»æ’ƒã¯${sp.params.atkMult}å€ã€‚å›é¿${Math.round(sp.params.evade*100)}%ãŒ${sp.params.turns}ã‚¿ãƒ¼ãƒ³ç¶šãã€‚`,atk_def:`ã“ã®æ”»æ’ƒã¯${sp.params.atkMult}å€ã€‚ã•ã‚‰ã«${sp.params.turns}ã‚¿ãƒ¼ãƒ³ã€é˜²å¾¡ãŒ${sp.params.defMult}å€ã€‚`,atk_heal:`ã“ã®æ”»æ’ƒã¯${sp.params.atkMult}å€ã€‚HPã‚’${sp.params.heal}å›å¾©ã™ã‚‹ã€‚`,atk_drain:`ã“ã®æ”»æ’ƒã¯${sp.params.atkMult}å€ã€‚ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚`,heal_attack_all:`é€šå¸¸æ”»æ’ƒã®å¨åŠ›ã€‚è‡ªåˆ†ã¯${sp.params.self}å›å¾©ã€å‘³æ–¹ã¯${sp.params.allies}å›å¾©ã€‚`})[sp.kind]||'';
const bdDesc=u=>({kotobagari:'è¨€è‘‰ç‹©ã‚Šï¼ˆè¡Œå‹•ä¸å¯1Tï¼‰',genron:'è¨€è«–çµ±åˆ¶ï¼ˆäº¤ä»£ä¸å¯4Tï¼‰',gestalt:'ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼ˆ4Tãƒ»1/3ã§è‡ªå‚·100ï¼‰',mojibake:'æ–‡å­—åŒ–ã‘ï¼ˆ3Tå¾Œã«æ°—çµ¶ï¼‰'})[BD_ASSIGN[u.rank]?.[u.name]]||'çŠ¶æ…‹ç•°å¸¸å‹';

function skillBlock(u){const isX=(u.rank==='X');let title='',desc='';if(isX){title='é¡æ–‡å­—';desc='ç›¸æ‰‹ã®å¿…æ®ºã‚ã–ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã†ã€‚ã“ã®æ”»æ’ƒã¯2å€ã€‚';}else if(SPECIALS[u.name]){const sp=SPECIALS[u.name];title=sp.id;desc=briefDesc(sp);}else{const eff=BD_ASSIGN[u.rank]?.[u.name];title=eff?AIL[eff].name:'â€•';desc=eff?AIL[eff].desc:'â€•';}const blk=document.createElement('div');blk.className='skillLine';blk.innerHTML=`<div class="skillTitle"><span class="badge">å¿…æ®º</span><span>${title}</span></div><div class="skillDesc">${desc}</div>`;return blk;}
function showInfo(u){infoTitle.textContent=`${u.name} ã®æƒ…å ±`;infoBody.className='setupMini '+typeClass(u.type);infoBody.innerHTML=`<div class="head"><div>${u.name}</div><div class="small muted">[${u.type}]</div></div><div class="nums"><div>ï¼ˆåŸºç¤ï¼‰HP ${u.base.HP}</div><div>å›é¿ ${u.base.Evasion.toFixed(1)}%</div><div>ATK ${u.base.ATK}</div><div>DEF ${u.base.DEF}</div></div>`;infoModal.style.display='grid';}
function miniCard(u,side){if(!u)return elmk('div');const card=elmk('div',{class:'miniCard '+side+' '+typeClass(u.type)});card.append(elmk('div',{class:'miniHead'},[elmk('div',{},[u.name]),elmk('div',{class:'small muted'},[`[${u.type}]`]) ]));card.append(elmk('div',{class:'small muted'},[`HP ${Math.max(0,Math.ceil(u.hp))}/${u.base.HP}`]));card.append(elmk('div',{class:'miniBar'},[elmk('span',{style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`})]));card.addEventListener('click',()=>showInfo(u));return card;}
function renderSixStats(A,B){sixStats.innerHTML='';for(let i=0;i<3;i++){sixStats.append(miniCard(A[i],'ally'));sixStats.append(miniCard(B[i],'enemy'));}}
function benchChips(A,ia,foe){benchBar.innerHTML='';const bench=A.slice(ia+1).filter(x=>x.hp>0).slice(0,2);bench.forEach(u=>{const chip=elmk('div',{class:'benchChip '+typeClass(u.type)});chip.innerHTML=`<span class="name">${u.name}</span><span class="ratio">ç›¸æ€§ Ã—${typeMult(u.type,foe.type).toFixed(2)}</span>`;chip.addEventListener('click',()=>showInfo(u));benchBar.append(chip);});}
function unitView(u,foe,side){const wrap=elmk('div',{class:'unit '+(side==='ally'?'ally':'enemy')+' '+typeClass(u.type)});wrap.append(elmk('div',{class:'nameRow'},[elmk('div',{class:'name'},[u.name]),elmk('div',{class:'tag'},[`[${u.type}]`]) ]));const hpRow=elmk('div');hpRow.append(elmk('div',{class:'small muted'},[`HP ${Math.max(0,Math.ceil(u.hp))}/${u.base.HP}`]));const bar=elmk('div',{class:'bar'},[elmk('span',{class:'hpAnim',style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`})]);hpRow.append(bar);wrap.append(hpRow);const gWrap=elmk('div',{class:'gaugeWrap'});gWrap.append(elmk('div',{class:'gLabel'},['å¿…æ®ºã‚²ãƒ¼ã‚¸']));const g=elmk('div',{class:'gauge'});const gShow=Math.min(6,Math.max(0,Math.floor(u.gauge)));for(let i=0;i<6;i++){const p=elmk('div',{class:'pip'+(i<gShow?' on':'')});if(i===5&&gShow===6)p.classList.add('readyPulse');g.append(p);}gWrap.append(g);wrap.append(gWrap);const mu=foe?typeMult(u.type,foe.type).toFixed(2):'1.00';const meta=elmk('div',{class:'meta'},[elmk('div',{class:'line'},[elmk('span',{},['ç›¸æ€§']),elmk('span',{},[`Ã—${mu}`]) ]) ]);wrap.append(meta);wrap.append(skillBlock(u));wrap.addEventListener('click',()=>showInfo(u));return wrap;}
function renderHUD(s){const a=s.A[s.ia],b=s.B[s.ib];leftWrap.innerHTML='';rightWrap.innerHTML='';if(a)leftWrap.append(unitView(a,b,'ally'));if(b)rightWrap.append(unitView(b,a,'enemy'));benchChips(s.A,s.ia,b);renderSixStats(s.A,s.B);btnSP.disabled=!(a.gauge>=GAUGE_NEEDED&&a.skipTurns<=0);btnSP.classList.toggle('on',!btnSP.disabled&&USE_SP);btnSP.classList.toggle('readyPulse',!btnSP.disabled);}

/* ============= æ‰‹ãƒ»å¿…æ®ºãƒ»äº¤ä»£ ============= */
let SELECTED_HAND=null, USE_SP=false, REQUEST_SWITCH=false, SWITCH_TARGET_INDEX=null, WAITING_KO=false;
const rpsRes=(a,b)=>a===b?-1:((a==='g'&&b==='c')||(a==='c'&&b==='p')||(a==='p'&&b==='g')?0:1);
$('handG').onclick=()=>{if(WAITING_KO)return;SELECTED_HAND='g';stepNow();};
$('handC').onclick=()=>{if(WAITING_KO)return;SELECTED_HAND='c';stepNow();};
$('handP').onclick=()=>{if(WAITING_KO)return;SELECTED_HAND='p';stepNow();};
$('btnSP').onclick=()=>{if(btnSP.disabled)return;USE_SP=!USE_SP;btnSP.classList.toggle('on',USE_SP);btnSP.textContent=USE_SP?'âœ¨ å¿…æ®º ON':'âœ¨ å¿…æ®º OFF';};
const switchModal=$('switchModal'), switchList=$('switchList'), switchTitle=$('switchTitle');
$('btnSwitch').onclick=()=>{if(WAITING_KO)return;stopTimer();openSwitchModal('manual');};
$('cancelSwitch').onclick=()=>{switchModal.style.display='none';SWITCH_TARGET_INDEX=null;if(WAITING_KO)openSwitchModal('ko');else startTimerWhenIdle();};
$('doSwitch').onclick=()=>{if(SWITCH_TARGET_INDEX==null)return;if(WAITING_KO){switchIn(SESSION.A,SESSION.ia,SWITCH_TARGET_INDEX,'A');const name=SESSION.A[SESSION.ia].name;show(`ã„ã‘ã€${name}ï¼`);switchModal.style.display='none';SWITCH_TARGET_INDEX=null;WAITING_KO=false;renderHUD(SESSION);startTimerWhenIdle();}else{REQUEST_SWITCH=true;switchModal.style.display='none';stepOnce();}};

/* ============= RNG/Session/Timer ============= */
function LCG(sd){let s=sd>>>0;return()=> (s=(1664525*s+1013904223)>>>0,(s>>>8)/16777216);}
const SELECT_SECS=15; let SESSION=null, TIMER=null, TLEFT=SELECT_SECS;
function createFighter([name,rank,type,reading]){const st=calcStats(name,rank,type,reading);return {name,rank,type,reading,base:st,hp:st.HP,gauge:0,atkMult:1,defMult:1,atkTurns:0,defTurns:0,evadeOverride:null,endure:false,skipTurns:0,gestaltTurns:0,doomTurns:0,genronTurns:0,_gorillaActive:false,_gFull:false};}
function startNewSession(){const A=getSelections(els.teamA),B=getSelections(els.teamB);const rng=LCG((Date.now()|0)>>>0);SESSION={rng,A:A.map(createFighter),B:B.map(createFighter),ia:0,ib:0,tick:0};summary.textContent='ãƒãƒˆãƒ«ä¸­';USE_SP=false;btnSP.textContent='âœ¨ å¿…æ®º OFF';}
function startTimer(){stopTimer();if(WAITING_KO)return;TLEFT=SELECT_SECS;countNum.textContent=TLEFT;TIMER=setInterval(()=>{TLEFT--;countNum.textContent=TLEFT;if(TLEFT<=0){stopTimer();if(!SELECTED_HAND&&!REQUEST_SWITCH)SELECTED_HAND=['g','c','p'][Math.floor(SESSION.rng()*3)];stepOnce();}},1000);}
const startTimerWhenIdle=()=>runAfterAnnouncements(()=>startTimer());
function stopTimer(){if(TIMER){clearInterval(TIMER);TIMER=null;}}

/* ============= äº¤ä»£/AI/ã‚²ãƒ¼ã‚¸é€šçŸ¥ ============= */
function decideSwitchCPU(me,bench,opp,rng){if(me.genronTurns>0)return-1;const aliveIdx=bench.map((u,i)=>i).filter(i=>bench[i].hp>0);if(!aliveIdx.length)return-1;const mySP=me.gauge>=GAUGE_NEEDED&&me.skipTurns<=0,oppSP=opp.gauge>=GAUGE_NEEDED&&opp.skipTurns<=0;const EVnow=computeDamageDetailed(me,opp,mySP,rng).dmg-computeDamageDetailed(opp,me,oppSP,rng).dmg;let bestRel=null,bestScore=-1;aliveIdx.forEach(rel=>{const cand=bench[rel];const score=typeMult(cand.type,opp.type);if(score>bestScore){bestScore=score;bestRel=rel;}});const gain=bestScore-typeMult(me.type,opp.type);if(EVnow<-20&&gain>0.25)return bestRel;return-1;}
function chooseBestCPUAfterKO(team,startIndex,foe){let bestIdx=null,bestScore=-1;for(let i=startIndex;i<team.length;i++){if(team[i].hp>0){const sc=typeMult(team[i].type,foe.type);if(sc>bestScore){bestScore=sc;bestIdx=i;}}}return bestIdx;}
function switchIn(team,iFrom,iTo,sideTag){[team[iFrom],team[iTo]]=[team[iTo],team[iFrom]];team[iFrom].gauge=0;team[iTo].gauge=0;team[iTo].skipTurns=team[iTo].gestaltTurns=team[iTo].doomTurns=team[iTo].genronTurns=0;}
let gaugeNotices=[];function incGauge(u,side){u.gauge=Math.min(GAUGE_NEEDED,u.gauge+1);if(u.gauge>=GAUGE_NEEDED&&!u._gFull){gaugeNotices.push({side,name:u.name});u._gFull=true;}}
function flushGaugeNotices(){if(gaugeNotices.length===0)return;const Afirst=gaugeNotices.filter(n=>n.side==='A');const Bnext=gaugeNotices.filter(n=>n.side==='B');[...Afirst,...Bnext].forEach(n=>show(`${n.name}ã®ã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼ å¿…æ®ºOK`));gaugeNotices=[];}

/* ============= KO / è¨ˆç®— / é€²è¡Œ ============= */
function handleKOImmediate(){const s=SESSION;while(s.ia<3&&s.A[s.ia].hp<=0){const dead=s.A[s.ia].name;show(`${dead}ã¯å€’ã‚ŒãŸï¼`);s.ia++;if(s.ia<3){WAITING_KO=true;openSwitchModal('ko');renderHUD(s);stopTimer();return'wait';}else{summary.textContent='çµæœï¼šCPUã®å‹ã¡';renderHUD(s);stopTimer();return'end';}}while(s.ib<3&&s.B[s.ib].hp<=0){const dead=s.B[s.ib].name;show(`${dead}ã¯å€’ã‚ŒãŸï¼`);s.ib++;if(s.ib<3){const bestIdx=chooseBestCPUAfterKO(s.B,s.ib,s.A[s.ia]);if(bestIdx!=null&&bestIdx!==s.ib){switchIn(s.B,s.ib,bestIdx,'B');}show(`ç›¸æ‰‹ã¯${s.B[s.ib].name}ã‚’ãã‚Šã ã—ãŸï¼`);}else{summary.textContent='çµæœï¼šã‚ãªãŸã®å‹ã¡';renderHUD(s);stopTimer();return'end';}}return'cont';}
function computeDamageDetailed(att,def,isSpecial,rng){if(!isSpecial){const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);if(rng()<eva)return{dmg:0,miss:true,matchup:'even'};}let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);dmg*=att.atkMult;const tm=typeMult(att.type,def.type);dmg*=tm;const matchup=tm>1.0?'good':tm<1.0?'bad':'even';return{dmg,miss:false,matchup};}
function narrRPS(my,cpu,res){const lab=h=>h==='g'?'ã‚°ãƒ¼':(h==='c'?'ãƒãƒ§ã‚­':'ãƒ‘ãƒ¼');if(res===-1){show(`ã‚ã„ã“ã€‚`);return;}const result=res===0?'ã‚ãªãŸã®å‹ã¡ã€‚':'ã‚ãªãŸã®è² ã‘ã€‚';show(`ã‚ãªãŸã¯${lab(my||'g')}ã€‚ç›¸æ‰‹ã¯${lab(cpu)}ã€‚${result}`);}
function narrAttackLine(attackerName,dmg,matchup){const muTxt=matchup==='good'?' ç›¸æ€§æŠœç¾¤ï¼':matchup==='bad'?' ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':'';show(`${attackerName}ã®æ”»æ’ƒï¼ ${Math.round(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${muTxt}`);}
function shakeTarget(which){const box=(which==='A')?rightWrap:leftWrap;const unit=box.querySelector('.unit');if(unit){unit.classList.add('shake');setTimeout(()=>unit&&unit.classList.remove('shake'),500);}}
function endOfTick(f){if(f.atkTurns>0&&--f.atkTurns===0)f.atkMult=1;if(f.defTurns>0&&--f.defTurns===0)f.defMult=1;if(f.evadeOverride&&--f.evadeOverride.turns<=0)f.evadeOverride=null;if(f.skipTurns>0){f.skipTurns--;if(f.skipTurns>0)show(`è¨€è‘‰ç‹©ã‚Š æ®‹ã‚Š${f.skipTurns}ã‚¿ãƒ¼ãƒ³`);}if(f.gestaltTurns>0){f.gestaltTurns--;if(f.gestaltTurns>0)show(`ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š æ®‹ã‚Š${f.gestaltTurns}ã‚¿ãƒ¼ãƒ³`);}if(f.genronTurns>0){f.genronTurns--;if(f.genronTurns>0)show(`è¨€è«–çµ±åˆ¶ æ®‹ã‚Š${f.genronTurns}ã‚¿ãƒ¼ãƒ³`);}if(f.doomTurns>0){f.doomTurns--;if(f.doomTurns>0)show(`æ–‡å­—åŒ–ã‘ æ®‹ã‚Š${f.doomTurns}ã‚¿ãƒ¼ãƒ³`);else f.hp=0;}}
function endTurnAdjustments(f){if(f._gorillaActive){f.atkMult=1.3;f._gorillaActive=false;}}
function ailInitialExplain(key){const t=AIL_TURNS[key],a=AIL[key];if(key==='genron')return`${a.name} ã‚’ä»˜ä¸ã€‚æ®‹ã‚Š${t}ã‚¿ãƒ¼ãƒ³ã€‚åŠ¹æœï¼šäº¤ä»£ã§ããªããªã‚‹ã€‚`;if(key==='kotobagari')return`${a.name} ã‚’ä»˜ä¸ã€‚æ®‹ã‚Š${t}ã‚¿ãƒ¼ãƒ³ã€‚åŠ¹æœï¼šè¡Œå‹•ã§ããªããªã‚‹ã€‚`;if(key==='gestalt')return`${a.name} ã‚’ä»˜ä¸ã€‚æ®‹ã‚Š${t}ã‚¿ãƒ¼ãƒ³ã€‚åŠ¹æœï¼šæ”»æ’ƒã®ãŸã³ã«1/3ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`;if(key==='mojibake')return`${a.name} ã‚’ä»˜ä¸ã€‚æ®‹ã‚Š${t}ã‚¿ãƒ¼ãƒ³ã€‚åŠ¹æœï¼š3ã‚¿ãƒ¼ãƒ³å¾Œã«æ°—çµ¶ã€‚`;return'';}
function dealAttack(actor,target,isSpecial,rng){if(actor.gestaltTurns>0&&rng()<1/3){actor.hp-=100;show(`${actor.name}ã¯æ··ä¹±ï¼ è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸`);return{self:true};}const sp=SPECIALS[actor.name];if(isSpecial&&sp&&sp.kind==='multi'){const keep=actor.atkMult;let total=0,MU='even';for(const s of sp.params.hits){actor.atkMult=keep*s;const info=computeDamageDetailed(actor,target,true,rng);total+=info.dmg;if(target.endure&&target.hp-info.dmg<=0){target.hp=1;target.endure=false;}else target.hp-=info.dmg; if(info.matchup==='good')MU='good';else if(info.matchup==='bad'&&MU!=='good')MU='bad';if(target.hp<=0)break;}actor.atkMult=keep;return{dmg:total,matchup:MU};}else{const info=computeDamageDetailed(actor,target,isSpecial,rng);if(info.miss){show(`${actor.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`);return{dmg:0,miss:true};}if(target.endure&&target.hp-info.dmg<=0){target.hp=1;target.endure=false;}else target.hp-=info.dmg;return info;}}
function applySpecialPre(actor,target,allies,enemies,rng,isHuman=false,isCPU=false,wantSP=false){
  if(actor.gauge<GAUGE_NEEDED||actor.skipTurns>0||!wantSP) return {used:false};
  let used=false,label='',explain='';
  if(actor.rank==='X'){
    const cands=enemies.filter(e=>e.rank!=='X'&&e.hp>0);
    if(cands.length){const picked=cands[Math.floor(rng()*cands.length)];actor.atkMult*=2.0;actor.atkTurns=Math.max(actor.atkTurns,1);const bn=actor.name,br=actor.rank,g=actor.gauge;actor.name=picked.name;actor.rank=picked.rank;const _=applySpecialPre(actor,target,allies,enemies,rng,isHuman,isCPU,true);actor.name=bn;actor.rank=br;actor.gauge=g;used=true;label=`å¿…æ®ºï¼é¡æ–‡å­— â†’ ${picked.name}`;explain=`ç›¸æ‰‹ã®å¿…æ®ºã‚ã–ã‚’ã‚³ãƒ”ãƒ¼ã€‚ã“ã®æ”»æ’ƒã¯2å€ã€‚`;}
  } else if(actor.rank==='A'||actor.rank==='S'){
    const sp=SPECIALS[actor.name]; if(sp){ label=`å¿…æ®ºï¼${sp.id}`; switch(sp.kind){
      case 'buff_endure': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.endure=true; used=true; explain=briefDesc(sp); break;
      case 'multi': used=true; explain=briefDesc(sp); break;
      case 'gorilla': actor.atkMult=sp.params.first; actor.atkTurns=Math.max(actor.atkTurns,1+sp.params.turns); actor._gorillaActive=true; used=true; explain=briefDesc(sp); break;
      case 'evasion': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.evadeOverride={rate:sp.params.evade,turns:sp.params.turns}; used=true; explain=briefDesc(sp); break;
      case 'atk_def': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.defMult*=sp.params.defMult; actor.defTurns=Math.max(actor.defTurns,sp.params.turns); used=true; explain=briefDesc(sp); break;
      case 'atk_heal': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.heal); used=true; explain=briefDesc(sp); break;
      case 'atk_drain': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); target.gauge=0; used=true; explain=briefDesc(sp); break;
      case 'heal_attack_all': actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.self); for(const al of allies){ if(al!==actor) al.hp=Math.min(al.base.HP, al.hp+sp.params.allies); } used=true; explain=briefDesc(sp); break;
    }}}
  else{
    const eff=BD_ASSIGN[actor.rank]?.[actor.name];
    if(eff){ if(eff==='kotobagari')target.skipTurns=Math.max(target.skipTurns,1);
      if(eff==='gestalt')target.gestaltTurns=Math.max(target.gestaltTurns,4);
      if(eff==='mojibake')target.doomTurns=Math.max(target.doomTurns,3);
      if(eff==='genron')target.genronTurns=Math.max(target.genronTurns,4);
      used=true; label=`å¿…æ®ºï¼${AIL[eff].name} ${AIL[eff].icon}`; explain=ailInitialExplain(eff);
    }
  }
  if(used){actor.gauge=Math.max(0,actor.gauge-GAUGE_NEEDED);actor._gFull=false;}
  return {used,label,explain};
}
function openSwitchModal(kind){const s=SESSION;switchTitle.textContent=(kind==='ko')?'äº¤ä»£å…ˆã‚’é¸æŠï¼ˆå€’ã‚ŒãŸãŸã‚ï¼‰':'äº¤ä»£å…ˆã‚’é¸æŠ';switchList.innerHTML='';const bench=s.A.slice(s.ia+1).map((u,i)=>({u,index:s.ia+1+i})).filter(x=>x.u.hp>0);if(bench.length===0){switchList.innerHTML='<div class="small muted">æ§ãˆãŒã„ã¾ã›ã‚“</div>';}bench.forEach(({u,index})=>{const item=document.createElement('div');item.className='setupMini '+typeClass(u.type);item.style.cursor='pointer';item.style.marginBottom='8px';item.innerHTML=`<div class="head"><div>${u.name}</div><div class="small muted">[${u.type}]</div></div><div class="nums"><div>HP ${Math.ceil(u.hp)}/${u.base.HP}</div><div>ç›¸æ€§ Ã—${typeMult(u.type,SESSION.B[SESSION.ib].type).toFixed(2)}</div></div>`;item.onclick=()=>{[...switchList.children].forEach(n=>n.style.outline='none');item.style.outline='2px solid #69d3ff';SWITCH_TARGET_INDEX=index;};switchList.appendChild(item);});SWITCH_TARGET_INDEX=null;switchModal.style.display='grid';}

/* ============= é€²è¡Œ ============= */
let SELECTED=null;
function stepNow(){stopTimer();if(!SELECTED_HAND&&!REQUEST_SWITCH)return;stepOnce();}
function stepOnce(){
  const s=SESSION; s.tick++;
  let stat=handleKOImmediate(); if(stat!=='cont') return;
  let a=s.A[s.ia], b=s.B[s.ib];
  const humanWantsSP=(USE_SP&&a.gauge>=GAUGE_NEEDED&&a.skipTurns<=0);

  if(REQUEST_SWITCH && SWITCH_TARGET_INDEX!=null){
    switchIn(s.A,s.ia,SWITCH_TARGET_INDEX,'A'); a=s.A[s.ia];
    show(`ã„ã‘ã€${a.name}ï¼`);
    const used=applySpecialPre(b,a,s.B,s.A,s.rng,false,true,true);
    show(`ã‚ãªãŸã¯ãƒ‘ãƒ¼ã€‚ç›¸æ‰‹ã¯ã‚°ãƒ¼ã€‚ã‚ãªãŸã®è² ã‘ã€‚`);
    if(used.used){playSpFx(used.label);show(`${used.label}`);if(used.explain)show(`åŠ¹æœï¼š${used.explain}`);}
    const info=dealAttack(b,a,used.used,s.rng); if(!info.miss)narrAttackLine(b.name,info.dmg,info.matchup);
    endTurnAdjustments(b); endOfTick(a); endOfTick(b);
    stat=handleKOImmediate(); if(stat!=='cont'){REQUEST_SWITCH=false;SWITCH_TARGET_INDEX=null;SELECTED_HAND=null;runAfterAnnouncements(()=>renderHUD(s));return;}
    REQUEST_SWITCH=false;SWITCH_TARGET_INDEX=null;SELECTED_HAND=null;incGauge(a,'A');incGauge(b,'B');flushGaugeNotices();runAfterAnnouncements(()=>{shakeTarget('A');renderHUD(s);});startTimerWhenIdle();return;
  }

  const wantRel=decideSwitchCPU(b,s.B.slice(s.ib+1),a,s.rng);
  if(wantRel>=0){
    const abs=s.ib+1+wantRel; switchIn(s.B,s.ib,abs,'B'); b=s.B[s.ib]; show(`ç›¸æ‰‹ã¯${b.name}ã‚’ãã‚Šã ã—ãŸï¼`);
    const used=applySpecialPre(a,b,s.A,s.B,s.rng,true,false,humanWantsSP);
    show(`ã‚ãªãŸã¯ã‚°ãƒ¼ã€‚ç›¸æ‰‹ã¯ãƒãƒ§ã‚­ã€‚ã‚ãªãŸã®å‹ã¡ã€‚`);
    if(used.used){playSpFx(used.label);show(`${used.label}`);if(used.explain)show(`åŠ¹æœï¼š${used.explain}`);}
    const info=dealAttack(a,b,used.used,s.rng); if(!info.miss)narrAttackLine(a.name,info.dmg,info.matchup);
    endTurnAdjustments(a); endOfTick(a); endOfTick(b);
    stat=handleKOImmediate(); if(stat!=='cont'){SELECTED_HAND=null;runAfterAnnouncements(()=>renderHUD(s));return;}
    SELECTED_HAND=null; incGauge(a,'A');incGauge(b,'B');flushGaugeNotices();runAfterAnnouncements(()=>{shakeTarget('B');renderHUD(s);});startTimerWhenIdle();return;
  }

  const cpu=['g','c','p'][Math.floor(s.rng()*3)];
  const res=rpsRes(SELECTED_HAND||'g',cpu);
  narrRPS(SELECTED_HAND,cpu,res);
  if(res===-1){
    endOfTick(a); endOfTick(b);
    stat=handleKOImmediate(); if(stat!=='cont'){SELECTED_HAND=null;runAfterAnnouncements(()=>renderHUD(s));return;}
    SELECTED_HAND=null; incGauge(a,'A'); incGauge(b,'B'); flushGaugeNotices(); runAfterAnnouncements(()=>renderHUD(s)); startTimerWhenIdle(); return;
  }

  const actor=res===0?a:b, target=res===0?b:a, actorSide=(res===0?'A':'B');
  let usedInfo={used:false};
  if(actor.skipTurns<=0){
    const isHuman=(actor===a);
    const wantSP=isHuman?humanWantsSP:(actor.gauge>=GAUGE_NEEDED&&actor.skipTurns<=0);
    usedInfo=applySpecialPre(actor,target,res===0?s.A:s.B,res===0?s.B:s.A,s.rng,isHuman,!isHuman,wantSP);
    if(usedInfo.used){playSpFx(usedInfo.label);show(`${usedInfo.label}`);if(usedInfo.explain)show(`åŠ¹æœï¼š${usedInfo.explain}`);}
    const rr=dealAttack(actor,target,usedInfo.used,s.rng); if(!rr.miss)narrAttackLine(actor.name,rr.dmg,rr.matchup);
    endTurnAdjustments(actor);
  }else{show(`${(res===0)?a.name:b.name}ã¯è¨€è‘‰ç‹©ã‚Šã§è¡Œå‹•ã§ããªã„`);}

  endOfTick(a); endOfTick(b);
  stat=handleKOImmediate(); if(stat!=='cont'){SELECTED_HAND=null;runAfterAnnouncements(()=>renderHUD(s));return;}
  SELECTED_HAND=null; incGauge(a,'A'); incGauge(b,'B'); flushGaugeNotices();
  runAfterAnnouncements(()=>{shakeTarget(actorSide==='A'?'B':'A'); renderHUD(s);}); startTimerWhenIdle();
}

/* ============= åˆæœŸåŒ–å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ ============= */
setTimeout(()=>{const ok=els.teamA.querySelector('select')&&els.teamB.querySelector('select');if(!ok){const err=$('bootErr');err.style.display='block';err.textContent='åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚„å¼·åˆ¶å†èª­ã¿è¾¼ã¿ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚';}},350);

}catch(e){const err=$('bootErr');if(err){err.style.display='block';err.textContent='åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼š'+(e&&e.message?e.message:String(e));}console.error(e);}})();
</script>
</body>
</html>