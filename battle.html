<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOTOBA-BATTLE | å¯¾æˆ¦ v7.4.4</title>
<style>
:root{
  --bg:#0b1227; --panel:#0f1633; --muted:#99a7d6; --text:#eaf2ff; --border:#1c2447;
  --ally:#69d3ff; --ally2:#2fb1ff; --enemy:#ff9aa5; --enemy2:#ff6b7a;
  --hp:#6bff8b; --hpBack:#12321f; --gauge:#ffde66; --gaugeBack:#342b0b;
  --toast:#112042; --toastText:#eaf2ff;
  --ok:#61f5a2; --warn:#ffd166; --bad:#ff6b6b;

  /* ã‚¿ã‚¤ãƒ—èƒŒæ™¯è‰² */
  --geo:#112445; --animal:#09273e; --food:#0e2f1d; --concept:#121f44;
  --science:#0b2744; --history:#161e40; --human:#141d3f;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP",sans-serif}
h1{margin:0 0 8px 0;font-size:28px}
small.head{display:block;color:var(--muted);margin-bottom:12px}
.wrap{max-width:1120px;margin:18px auto;padding:0 12px}

/* ãƒ‘ãƒãƒ« */
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}}

.sectionTitle{font-size:20px;margin-bottom:10px}

/* é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.teamBox{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.teamBox h3{margin:0 0 8px 0}
.selRow{display:flex;align-items:center;gap:8px;margin:6px 0}
.selRow select{flex:1;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1330;color:var(--text)}
.btn{padding:12px 18px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
.btnPrimary{background:#44aaff}
.btnGhost{background:#14224a;border:1px dashed #2c3a70}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¸‹ã«2Ã—3ã‚°ãƒªãƒƒãƒ‰ã§ä¸¦ã¶ï¼‰ */
.six{margin-top:14px}
.sixGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(min-width:1020px){.sixGrid{grid-template-columns:repeat(3,1fr)}}
.sixCol h4{margin:4px 0 8px}
.mini{background:#0b1330;border:1px solid var(--border);border-radius:14px;padding:10px}

/* ãƒãƒˆãƒ« */
#battle{display:none;margin-top:14px}
.topRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.unit{position:relative;border-radius:14px;border:1px solid var(--border);padding:12px;min-height:170px}
.unit.ally{outline:2px solid var(--ally)}
.unit.enemy{outline:2px solid var(--enemy)}
.unit header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.badge{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:rgba(255,255,255,.04)}
.gauge{display:flex;gap:6px;margin:6px 0}
.dot{width:14px;height:14px;border-radius:4px;background:var(--gaugeBack);border:1px solid #5a4a14}
.dot.on{background:var(--gauge)}
.readyPulse{animation:blink .8s infinite}
@keyframes blink{0%,100%{filter:brightness(1)}50%{filter:brightness(1.7)}}

.hpRow{display:flex;align-items:center;gap:10px}
.hpBar{flex:1;height:11px;background:var(--hpBack);border-radius:8px;overflow:hidden}
.hpFill{height:100%;background:var(--hp);width:100%;transition:width .45s ease}
.hpNum{font-size:13px;width:96px;text-align:right}

.box{background:#0b1330;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
.box h5{margin:0 0 6px 0;font-size:14px}
.skillName{font-weight:800}
.typeRow{display:flex;gap:12px;align-items:center;margin-top:6px}
.typePill{padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--border);font-size:12px}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.stat{display:flex;align-items:center;gap:8px}
.sbar{flex:1;height:8px;background:#09102a;border-radius:8px;overflow:hidden}
.sfill{height:100%;background:#5577ff;width:0}

/* ã‚¿ã‚¤ãƒ—èƒŒæ™¯ï¼ˆã‚«ãƒ¼ãƒ‰å…¨ä½“ã®è‰²å‘³ï¼‰ */
.unit[data-type="ã‚¸ã‚ª"]{background:var(--geo)}
.unit[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{background:var(--animal)}
.unit[data-type="ãƒ•ãƒ¼ãƒ‰"]{background:var(--food)}
.unit[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{background:var(--concept)}
.unit[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{background:var(--science)}
.unit[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{background:var(--history)}
.unit[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{background:var(--human)}
/* è¼ªéƒ­å¼·åŒ– */
.unit[data-type="ã‚¸ã‚ª"]{box-shadow:0 0 0 2px #6aa1ff inset}
.unit[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{box-shadow:0 0 0 2px #5fc2ff inset}
.unit[data-type="ãƒ•ãƒ¼ãƒ‰"]{box-shadow:0 0 0 2px #8bd38b inset}
.unit[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{box-shadow:0 0 0 2px #7e9bff inset}
.unit[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{box-shadow:0 0 0 2px #56b2ff inset}
.unit[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{box-shadow:0 0 0 2px #8090ff inset}
.unit[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{box-shadow:0 0 0 2px #86a0ff inset}

/* æ“ä½œã‚¨ãƒªã‚¢ */
.controls{margin-top:14px;background:#0a132e;border:1px solid var(--border);border-radius:16px;padding:12px}
.ctrlTop{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.count{font-weight:900;font-size:18px}
.spBtn{min-width:120px}
.btnReady{animation:blink .8s infinite}
.rps{margin-top:10px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
.rps .big{width:120px;height:120px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:42px;border:none;cursor:pointer;font-weight:800}
.rps small{font-size:13px;margin-top:2px}
.big.g{background:linear-gradient(180deg,#ffb1b1,#ff8a8a)}
.big.p{background:linear-gradient(180deg,#aef5c6,#78e8a3)}
.big.c{background:linear-gradient(180deg,#c9d8ff,#a8bdff)}
.big.sw{background:#f8a98b;border-radius:14px;width:auto;height:auto;padding:12px 18px;border:none}

/* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ§ãˆé ˜åŸŸã‚’æ’¤å»ã—ãŸåˆ†ã€åº•ä¸Šã’ï¼‰ */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20vh;background:var(--toast);color:var(--toastText);
  border:1px solid #20335c;border-radius:12px;padding:14px 16px;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;
  z-index:40;max-width:min(90vw,720px)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆäº¤ä»£ï¼‰ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
.win{background:#0e1736;border:1px solid var(--border);border-radius:14px;padding:14px;max-width:560px;width:92vw}
.benchList{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
.benchItem{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1330;cursor:pointer}
.benchItem.rec{outline:2px solid var(--ok)}
.benchItem.disabled{opacity:.5;cursor:not-allowed}

/* æ”»æ’ƒã®æºã‚Œ */
.shake{animation:shake .5s}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}
}

/* ãƒ‡ãƒãƒƒã‚°è¡Œ  */
.diag{margin-top:8px;color:#a7b3ff;font-size:12px}
.hide{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>å¯¾æˆ¦ v7.4.4</h1>
  <small class="head">ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¯¾æˆ¦ ï¼ ç›¸æ€§ãƒ»ã‚¿ã‚¤ãƒ—è‰²åˆ†ã‘ ï¼ äºŒæ®µéšãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ï¼ å¿…æ®ºã‚²ãƒ¼ã‚¸åˆ¶å¾¡ï¼ˆ2025-08-12ä»•æ§˜ï¼‰</small>

  <!-- ç·¨æˆ -->
  <section id="build" class="card">
    <div class="sectionTitle">ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</div>
    <div class="teamBox">
      <div>
        <h3 style="color:var(--ally)">ã‚ãªãŸ</h3>
        <div id="selsA"></div>
      </div>
      <div>
        <h3 style="color:var(--enemy)">CPU</h3>
        <div id="selsB"></div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
      <button id="btnRand" class="btn btnGhost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
      <button id="btnGo" class="btn btnPrimary">å¯¾æˆ¦é–‹å§‹</button>
    </div>

    <div class="six">
      <div class="sectionTitle">é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      <div class="sixGrid">
        <div class="sixCol">
          <h4 style="color:var(--ally)">ã‚ãªãŸ</h4>
          <div id="miniA" class="mini"></div>
        </div>
        <div class="sixCol">
          <h4 style="color:var(--enemy)">CPU</h4>
          <div id="miniB" class="mini"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section id="battle" class="card">
    <div class="topRow">
      <div id="leftCard"></div>
      <div id="rightCard"></div>
    </div>

    <div class="controls">
      <div class="ctrlTop">
        <div class="count">æ®‹ã‚Š <span id="remain">15</span> ç§’</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnSP" class="btn spBtn">âœ¨ å¿…æ®º OFF</button>
          <button id="btnSwitch" class="btn">äº¤ä»£</button>
        </div>
      </div>
      <div class="rps">
        <button class="big g" id="btnG">âœŠ<small>ã‚°ãƒ¼</small></button>
        <button class="big p" id="btnP">ğŸ–ï¸<small>ãƒ‘ãƒ¼</small></button>
        <button class="big c" id="btnC">âœŒï¸<small>ãƒãƒ§ã‚­</small></button>
      </div>
    </div>

    <div class="diag" id="diag"></div>
  </section>
</div>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="dlg">
  <div class="win">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">äº¤ä»£å…ˆã‚’é¸æŠ</h3>
      <button id="dlgClose" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <div class="benchList" id="benchList"></div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div class="toast" id="toast"></div>

<script>
/* ========== ãƒ‡ãƒ¼ã‚¿ ========== */

/* ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ã‚¯ï¼ã‚¿ã‚¤ãƒ—ï¼èª­ã¿ï¼æŠ€åï¼‰ */
const WORDS = [
  // S
  ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª","å¦¨å®³é›»æ³¢"],
  ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼","ä¸€æ¯ã„ã‹ãŒ"],
  // A
  ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","ãªã‚“ãã‚‹ãªã„ã•ãƒ¼"],
  ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“","ãã¼ã‚ä¹±èˆ"],
  ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰","ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ"],
  ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰","ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©"],
  ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤","ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§"],
  ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹","é•·å¯¿ã®ç§˜è¨£"],
  // B
  ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†","è¨€è«–çµ±åˆ¶"],
  ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰","è¨€è‘‰ç‹©ã‚Š"],
  ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†","è¨€è«–çµ±åˆ¶"],
  ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™","è¨€è«–çµ±åˆ¶"],
  ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”","è¨€è‘‰ç‹©ã‚Š"],
  ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  // C
  ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†","è¨€è«–çµ±åˆ¶"],
  ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“","æ–‡å­—åŒ–ã‘"],
  ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹","è¨€è‘‰ç‹©ã‚Š"],
  ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“","è¨€è«–çµ±åˆ¶"],
  ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“","è¨€è‘‰ç‹©ã‚Š"],
  // D
  ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡","è¨€è«–çµ±åˆ¶"],
  ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡","æ–‡å­—åŒ–ã‘"],
  ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“","æ–‡å­—åŒ–ã‘"],
  ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹","ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š"],
  // X
  ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤","é¡æ–‡å­—"],
  ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹","é¡æ–‡å­—"],
  ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹","é¡æ–‡å­—"],
  ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©","é¡æ–‡å­—"],
];

/* ã‚¿ã‚¤ãƒ—ç›¸æ€§ï¼ˆå††ç’°ï¼‰ 1.5 / 0.67 */
const TYPE_RING = ["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"];
const TYPE_ADV = {}; // strong/weak ã‚’ä½œã‚‹
for(let i=0;i<TYPE_RING.length;i++){
  const me=TYPE_RING[i], fwd=TYPE_RING[(i+1)%TYPE_RING.length], bwd=TYPE_RING[(i+6)%TYPE_RING.length];
  const weak1=TYPE_RING[(i+3)%TYPE_RING.length], weak2=TYPE_RING[(i+4)%TYPE_RING.length];
  TYPE_ADV[me]={strong:[fwd,bwd], weak:[weak1,weak2]};
}

/* ã‚¿ã‚¤ãƒ—èƒŒæ™¯ */
const TYPE_BG = {
  "ã‚¸ã‚ª":"var(--geo)","ã‚¢ãƒ‹ãƒãƒ«":"var(--animal)","ãƒ•ãƒ¼ãƒ‰":"var(--food)",
  "ã‚³ãƒ³ã‚»ãƒ—ãƒˆ":"var(--concept)","ã‚µã‚¤ã‚¨ãƒ³ã‚¹":"var(--science)",
  "ãƒ’ã‚¹ãƒˆãƒªãƒ¼":"var(--history)","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³":"var(--human)"
};

/* ========== ã‚¹ãƒ†ç®—å‡ºï¼ˆä»•æ§˜ã©ãŠã‚Šã€‚EffectMul/RankMulã¯ä¸ä½¿ç”¨ï¼‰ ========== */
const P_RANK = {S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE = {S:560,A:540,B:520,C:500,D:480,X:500};

function kanaLen(k){ return [...k].length; } // è¦‹ãŸç›®é•·ã•ã®è¿‘ä¼¼
function hiraRatio(k){ // å…¨ã²ã‚‰ãŒãªã§ 1.0 ã«ãªã‚‹
  const arr=[...k]; const hira=arr.filter(ch=>/[\u3041-\u3096]/.test(ch)).length;
  return arr.length? hira/arr.length : 1;
}

function computeStats(word){
  const [name,rank,type,kana,skill]=word;
  const T=kanaLen(kana);
  // æ”»å®ˆé…åˆ†
  const baseA=17.5, baseD=17.5;
  // æ§‹æˆ25%ï¼šå…¨ã²ã‚‰ãŒãª â†’ ä¸­ç«‹12.5/12.5
  const compA=12.5, compD=12.5;
  // éŸ³20%ï¼šç°¡ç•¥ï¼ˆä¸­ç«‹ï¼‰
  const phA=10, phD=10;
  // é•·ã•20%ï¼š T=5ã‚’åŸºæº–
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const lenA=20*(0.5+0.5*s_len); const lenD=20-lenA;

  const atkPct=baseA+compA+phA+lenA;
  const defPct=baseD+compD+phD+lenD;

  const ATK = Math.round(P_RANK[rank]*atkPct/100);
  const DEF = Math.round(P_RANK[rank]*defPct/100);
  let HP = HP_BASE[rank] + 20*(T-5);

  // å›é¿ç‡
  const evaBase = 10 + 8*hiraRatio(kana) - 0.5*(T-5) + ({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0}[rank]);
  const EVA = Math.max(5,Math.min(35,Math.round(evaBase*10)/10));

  return {name,rank,type,kana,skill,HP,ATK,DEF,EVA};
}

const DATA = WORDS.map(computeStats);

/* ========== DOM util ========== */
const $=id=>document.getElementById(id);
const el=(tag,cls,html)=>{const e=document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e;}
const delay=ms=>new Promise(r=>setTimeout(r,ms));

/* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå¸¸ã«1.5ç§’ï¼‰ */
const toast=(msg)=>{
  const t=$('toast'); if(!t){alert(msg);return;}
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove('show'),1500);
};

/* ========== ç·¨æˆUI ========== */
const NAMES=DATA.map(x=>x.name);

function optionsHtml(selected){
  return NAMES.map(n=>`<option ${n===selected?'selected':''}>${n}</option>`).join('');
}
function makeSels(side,rootId){
  const box=$(rootId); box.innerHTML='';
  for(let i=0;i<3;i++){
    const row=el('div','selRow');
    row.innerHTML=`<span>#${i+1}</span>
      <select id="${side}-${i}">${optionsHtml(NAMES[i])}</select>`;
    box.appendChild(row);
  }
}
makeSels('A','selsA'); makeSels('B','selsB');

function getSelTeam(side){
  return [0,1,2].map(i=>$(`${side}-${i}`).value);
}

function syncDisable(side){
  const used=new Set(); for(let i=0;i<3;i++) used.add($(`${side}-${i}`).value);
  for(let i=0;i<3;i++){
    const sel=$(`${side}-${i}`);
    [...sel.options].forEach(o=>{ o.disabled = used.has(o.value) && o.value!==sel.value; });
  }
}

function miniHtml(side){
  const names=getSelTeam(side);
  return names.map(n=>{
    const u=DATA.find(x=>x.name===n);
    return `
    <div class="unit ${side==='A'?'ally':'enemy'}" data-type="${u.type}" style="background:${TYPE_BG[u.type]}">
      <header><div>${u.name} <span class="badge">${u.type}</span></div></header>
      <div class="stats">
        ${statRow('HP',u.HP,800)}
        ${statRow('æ”»æ’ƒ',u.ATK,120)}
        ${statRow('é˜²å¾¡',u.DEF,120)}
        ${statRow('å›é¿',u.EVA,20)}
      </div>
    </div>`;
  }).join('');
}

function statRow(label,val,max){
  const pct=Math.max(0,Math.min(100,Math.round(100*val/max)));
  return `<div class="stat"><div style="width:48px">${label}</div>
    <div class="sbar"><div class="sfill" style="width:${pct}%"></div></div>
    <div style="width:72px;text-align:right">${val}</div></div>`;
}

function renderMini(side){ $(side==='A'?'miniA':'miniB').innerHTML=miniHtml(side); }
['A','B'].forEach(s=>{
  for(let i=0;i<3;i++){
    $(`${s}-${i}`).addEventListener('change',()=>{ renderMini(s); syncDisable(s); });
  }
});
renderMini('A'); renderMini('B'); syncDisable('A'); syncDisable('B');

$('btnRand').addEventListener('click',()=>{
  const pick=()=>([...NAMES].sort(()=>Math.random()-0.5).slice(0,3));
  const a=pick(), b=pick();
  a.forEach((n,i)=>$(`A-${i}`).value=n);
  b.forEach((n,i)=>$(`B-${i}`).value=n);
  renderMini('A'); renderMini('B'); syncDisable('A'); syncDisable('B');
});

/* ========== ãƒãƒˆãƒ« ========== */
let state=null;

function buildFighter(name){
  const base=DATA.find(x=>x.name===name);
  return {
    ...structuredClone(base),
    hp:base.HP, sp:0,
    skipT:0, gestaltT:0, doomT:0, noswitchT:0,
    atkMul:1, atkMulT:0, evaOverride:null, evaT:0,
    endure:false
  };
}
function teamFromNames(names){ return names.map(buildFighter); }

function left(){ return state.A.team[state.A.i]; }
function right(){ return state.B.team[state.B.i]; }

function typeMult(attType, defType){
  const info=TYPE_ADV[attType]||{strong:[],weak:[]};
  if(info.strong.includes(defType)) return 1.5;
  if(info.weak.includes(defType)) return 0.67;
  return 1;
}

function hpPct(u){ return Math.max(0,Math.min(100,Math.round(100*u.hp/u.HP))); }

function unitHtml(u,role){
  return `
  <div class="unit ${role}" data-type="${u.type}" style="background:${TYPE_BG[u.type]}" id="card-${role}">
    <header>
      <div>${u.name} <span class="badge">${u.type}</span></div>
      <div class="badge">HP <span id="hpnum-${role}">${Math.max(0,Math.round(u.hp))}/${u.HP}</span></div>
    </header>
    <div class="hpRow">
      <div class="gauge">
        ${[0,1,2,3,4,5].map(i=>`<div class="dot ${i<u.sp?'on':''}" id="sp-${role}-${i}"></div>`).join('')}
      </div>
      <div class="hpBar"><div class="hpFill" id="hpbar-${role}" style="width:${hpPct(u)}%"></div></div>
      <div class="hpNum"></div>
    </div>

    <div class="box">
      <div class="skillName">âœ¨ å¿…æ®ºï¼š${u.skill}</div>
      <div id="skdesc-${role}" style="margin-top:6px;font-size:13px;color:var(--muted)">${skillDesc(u)}</div>
    </div>

    <div class="box">
      <div class="typeRow"><span class="badge">ç›¸æ€§</span>
        <span id="aff-${role}">x1.00ï¼ˆç­‰å€ï¼‰</span>
      </div>
    </div>

    <div class="box">
      <h5>åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h5>
      <div class="stats">
        ${statRow('HP',u.HP,800)}
        ${statRow('æ”»æ’ƒ',u.ATK,120)}
        ${statRow('é˜²å¾¡',u.DEF,120)}
        ${statRow('å›é¿',u.EVA,20)}
      </div>
    </div>
  </div>`;
}

function renderSides(){
  $('leftCard').innerHTML=unitHtml(left(),'ally');
  $('rightCard').innerHTML=unitHtml(right(),'enemy');
  updateAff();
  updateSPBtn();
}

function updateAff(){
  const lm=typeMult(left().type,right().type);
  const rm=typeMult(right().type,left().type);
  $('aff-ally').textContent = `x${lm.toFixed(2)}ï¼ˆ${lm>1?'æŠœç¾¤':lm<1?'ã„ã¾ã„ã¡':'ç­‰å€'}ï¼‰`;
  $('aff-enemy').textContent = `x${rm.toFixed(2)}ï¼ˆ${rm>1?'æŠœç¾¤':rm<1?'ã„ã¾ã„ã¡':'ç­‰å€'}ï¼‰`;
}

function updateHP(role,u){
  $('hpbar-'+role).style.width = hpPct(u)+'%';
  $('hpnum-'+role).textContent = `${Math.max(0,Math.round(u.hp))}/${u.HP}`;
}

function updateSPBtn(){
  const readyA = state.A.team[state.A.i].sp>=6;
  const readyB = state.B.team[state.B.i].sp>=6;
  const btn=$('btnSP');
  btn.disabled=!readyA;
  btn.classList.toggle('on',state.spOn);
  btn.classList.toggle('btnReady',readyA&&!state.spOn);
  btn.textContent = state.spOn ? 'âœ¨ å¿…æ®º ON' : 'âœ¨ å¿…æ®º OFF';
  for(let i=0;i<6;i++){
    $('sp-ally-'+i)?.classList.toggle('on',i<left().sp);
    $('sp-enemy-'+i)?.classList.toggle('on',i<right().sp);
  }
  $('leftCard').classList.toggle('readyPulse',readyA&&!state.spOn);
  $('rightCard').classList.toggle('readyPulse',readyB);
  if(readyA && !state.spAnnA){ toast('ã‚ãªãŸã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼'); state.spAnnA=true; }
  if(readyB && !state.spAnnB){ toast('ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ï¼'); state.spAnnB=true; }
}

/* å¿…æ®ºãƒ†ã‚­ã‚¹ãƒˆ */
function skillDesc(u){
  const n=u.name, r=u.rank, s=u.skill;
  const map={
    "å¦¨å®³é›»æ³¢":"æ”»æ’ƒ2.5å€ï¼‹ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã€‚",
    "ä¸€æ¯ã„ã‹ãŒ":"é€šå¸¸æ”»æ’ƒï¼‹å‘³æ–¹å…¨å“¡ã®HPã‚’60å›å¾©ã€‚",
    "ãªã‚“ãã‚‹ãªã„ã•ãƒ¼":"æ”»æ’ƒ1.5å€ã€‚æ¬¡ã®è¢«å¼¾ã§è‡´æ­»ã§ã‚‚HP1ã§è€ãˆã‚‹ï¼ˆ1å›ï¼‰ã€‚",
    "ãã¼ã‚ä¹±èˆ":"3é€£æ’ƒï¼ˆ0.75â†’0.50â†’0.25ï¼‰ã€‚é€”ä¸­ã§å€’ã—ã¦ã‚‚æ¬¡ã®æ•µã«ç¶šè¡Œã€‚",
    "ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ":"ã“ã®æ”»æ’ƒ1.5å€ã€‚ä»¥é™2Tã¯æ”»æ’ƒ1.3å€ãŒç¶™ç¶šã€‚",
    "ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©":"æ”»æ’ƒ1.4å€ï¼‹å›é¿ç‡60%ï¼ˆ3Tï¼‰ã€‚",
    "ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§":"æ”»æ’ƒ1.6å€ï¼‹è¢«ãƒ€ãƒ¡åŠæ¸›ï¼ˆ3Tï¼‰ã€‚",
    "é•·å¯¿ã®ç§˜è¨£":"æ”»æ’ƒ1.2å€ï¼‹HP150å›å¾©ã€‚",
    "é¡æ–‡å­—":"ç›¸æ‰‹ã®èª°ã‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦2å€ã§æ”¾ã¤ã€‚",
    "è¨€è‘‰ç‹©ã‚Š":"ç›¸æ‰‹ã‚’1Tè¡Œå‹•ä¸å¯ã€‚",
    "è¨€è«–çµ±åˆ¶":"ç›¸æ‰‹ã‚’4Täº¤ä»£ä¸å¯ã€‚",
    "ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š":"ç›¸æ‰‹ã«4Tä»˜ä¸ã€‚æ”»æ’ƒæ™‚33%ã§è‡ªå‚·100ã€‚",
    "æ–‡å­—åŒ–ã‘":"3Tå¾Œã«æˆ¦é—˜ä¸èƒ½ï¼ˆäº¤ä»£ã§è§£é™¤ï¼‰ã€‚"
  };
  return map[s]||"";
}

/* äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« */
function openSwitch(){
  const list=$('benchList'); list.innerHTML='';
  const me=state.A, opp=state.B;
  const cand=[0,1,2].filter(i=>i!==me.i && me.team[i].hp>0);
  if(!cand.length){ toast('æ§ãˆãŒã„ã¾ã›ã‚“'); return; }
  cand.forEach(i=>{
    const u=me.team[i];
    const rec = typeMult(u.type, opp.team[opp.i].type)>1;
    const item=el('div','benchItem'+(rec?' rec':''),`${u.name} <span class="badge">${u.type}</span>`);
    item.onclick=()=>{ me.i=i; clearFlags(me.team[i]); toast(`ã„ã‘ã€${u.name}ï¼`); $('dlg').style.display='none'; renderSides(); };
    list.appendChild(item);
  });
  $('dlg').style.display='flex';
}
$('btnSwitch').onclick=openSwitch;
$('dlgClose').onclick=()=>$('dlg').style.display='none';

/* çŠ¶æ…‹åˆæœŸåŒ– */
function clearFlags(u){
  u.skipT=0; u.gestaltT=0; u.doomT=0; u.noswitchT=0; u.atkMul=1; u.atkMulT=0; u.evaOverride=null; u.evaT=0; u.endure=false; u.sp=0;
}

/* ãƒãƒˆãƒ«é–‹å§‹ */
$('btnGo').addEventListener('click',()=>{
  state={
    A:{team:teamFromNames(getSelTeam('A')), i:0},
    B:{team:teamFromNames(getSelTeam('B')), i:0},
    spOn:false, spAnnA:false, spAnnB:false, busy:false, remain:15, _timer:null
  };
  $('build').style.display='none';
  $('battle').style.display='block';
  toast(`ã„ã‘ã€${left().name}ï¼ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼`);
  renderSides(); startRound();
});

/* 1ã‚¿ãƒ¼ãƒ³é€²è¡Œ */
function startRound(){
  clearInterval(state._timer);
  state.remain=15; $('remain').textContent=state.remain;
  state._timer=setInterval(()=>{
    state.remain--; $('remain').textContent=state.remain;
    if(state.remain<=0){
      if(forceSwitchIfKO()) { startRound(); return; }
      const r=['G','P','C'][Math.floor(Math.random()*3)];
      pick(r);
    }
  },1000);
}

function stopRound(){ clearInterval(state._timer); }

/* å…¥åŠ› */
$('btnG').onclick=()=>pick('G');
$('btnP').onclick=()=>pick('P');
$('btnC').onclick=()=>pick('C');
$('btnSP').onclick=()=>{ if(left().sp>=6){ state.spOn=!state.spOn; updateSPBtn(); } };

function forceSwitchIfKO(){
  if(left().hp>0) return false;
  const alive=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!alive.length) return false;
  state.A.i = alive[Math.floor(Math.random()*alive.length)];
  clearFlags(left());
  toast(`ã„ã‘ã€${left().name}ï¼`);
  renderSides();
  return true;
}

/* CPU æ‰‹ï¼ˆå˜ç´”ï¼šãƒ©ãƒ³ãƒ€ãƒ ï¼‹æº€ã‚¿ãƒ³ãªã‚‰å¿…æ®ºONï¼‰ */
function cpuChoice(){
  if(right().sp>=6) state.cpuSP=true; else state.cpuSP=false;
  return ['G','P','C'][Math.floor(Math.random()*3)];
}

function rpsResult(me,cpu){
  if(me===cpu) return 0;
  const win = (me==='G'&&cpu==='C')||(me==='C'&&cpu==='P')||(me==='P'&&cpu==='G');
  return win?1:-1;
}

/* ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®— */
function baseDamage(att,def){
  let dmg = 100 * (1+att.ATK/100) / (1+def.DEF/120);
  dmg *= att.atkMul;
  dmg *= typeMult(att.type,def.type);
  // 20%å¹¸é‹Â±20%
  const r=Math.random();
  if(r<0.2) dmg*=1.2; else if(r<0.4) dmg*=0.8;
  if(def.halfT>0) dmg*=0.5;
  return Math.max(0,Math.round(dmg));
}

async function pick(meHand){
  if(state.busy) return;
  state.busy=true; stopRound();

  // ã‚ã„ã“ã§ã‚‚ã‚²ãƒ¼ã‚¸+1ã€50%ã§+1ï¼ˆæœŸå¾…+1.5ï¼‰
  [left(),right()].forEach(u=>{
    u.sp += 1 + (Math.random()<0.5?1:0);
    if(u.sp>6) u.sp=6;
  });
  updateSPBtn();

  const cpuHand = cpuChoice();
  const res=rpsResult(meHand,cpuHand);
  toast(`ã‚ãªãŸã¯${handName(meHand)}ã€‚ç›¸æ‰‹ã¯${handName(cpuHand)}ã€‚`); await delay(900);
  toast(res>0?'ã‚ãªãŸã®å‹ã¡ã€‚': res<0?'ç›¸æ‰‹ã®å‹ã¡ã€‚':'ã‚ã„ã“ã€‚'); await delay(900);

  if(res===0){ // ã‚ã„ã“ï¼šåŠ¹æœã‚¿ãƒ¼ãƒ³ã¯æ¸›ã‚‹ï¼ˆ1ã‚¿ãƒ¼ãƒ³çµŒéï¼‰
    endOfTurn(left(),true); endOfTurn(right(),true);
    updateSPBtn(); state.busy=false; startRound(); return;
  }

  const actor = res>0? left() : right();
  const target = res>0? right() : left();
  const aRole = res>0? 'ally':'enemy';
  const dRole = res>0? 'enemy':'ally';

  const useSP = res>0? state.spOn && actor.sp>=6 : state.cpuSP && actor.sp>=6;

  if(actor.skipT>0){ // è¡Œå‹•ä¸å¯
    toast(`${actor.name}ã¯å‹•ã‘ãªã„ï¼`); await delay(900);
  }else{
    // å¿…æ®ºå‰å‡¦ç†ï¼ˆå®£è¨€ã¯ã˜ã‚ƒã‚“ã‘ã‚“å‰ã ã‘ã©ã€æ¼”å‡ºã¯ã“ã“ï¼‰
    if(useSP){
      await doSpecial(actor,target,res>0);
      actor.sp=0; updateSPBtn();
    }

    // ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆè‡ªå‚·
    if(actor.gestaltT>0 && Math.random()<1/3){
      toast(`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100ã€‚`); await delay(900);
      actor.hp -= 100 * (actor.halfT>0?0.5:1);
      if(actor.hp<=0 && actor.endure){ actor.hp=1; actor.endure=false; }
      updateHP(aRole,actor);
    }else{
      // æ”»æ’ƒ
      const card=$('card-'+dRole);
      card.classList.add('shake'); setTimeout(()=>card.classList.remove('shake'),500);

      let dmg = baseDamage(actor,target);
      // å‘½ä¸­ï¼ˆå¿…æ®ºã¯å›é¿ä¸å¯ï¼‰
      if(!useSP && Math.random()<target.EVA/100){
        toast(`${target.name}ã¯ã†ã¾ãé¿ã‘ãŸï¼`); await delay(900);
      }else{
        // ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ï¼ˆç›¸æ€§ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
        const tm=typeMult(actor.type,target.type);
        toast(`${actor.name}ã®æ”»æ’ƒï¼${tm>1?'ç›¸æ€§æŠœç¾¤ï¼':tm<1?'ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':''}`); await delay(900);

        // ãã¼ã‚ä¹±èˆ
        if(useSP && actor.skill==='ãã¼ã‚ä¹±èˆ'){
          const seq=[0.75,0.5,0.25];
          for(const m of seq){
            let d=Math.round(dmg*m);
            await applyDamage(target,d,dRole);
            if(target.hp<=0) break;
          }
        }else{
          await applyDamage(target,dmg,dRole);
        }
      }
    }
  }

  // æ’ƒç ´ï¼Ÿ
  if(target.hp<=0){
    toast(`${target.name}ã¯å€’ã‚ŒãŸï¼`); await delay(900);
    const side = res>0? 'B' : 'A';
    const tm = state[side].team;
    const alive=[0,1,2].filter(i=>tm[i].hp>0);
    if(!alive.length){ toast(res>0?'å‹åˆ©ï¼':'æ•—åŒ—â€¦'); return; }
    // ç›¸æ‰‹ã¯ã‚¿ã‚¤ãƒ—æœ‰åˆ©ã‚’å„ªå…ˆ
    const meType = (res>0?left():right()).type;
    const best = alive.sort((i,j)=>{
      const mi=typeMult(tm[i].type, meType), mj=typeMult(tm[j].type, meType);
      return mj-mi;
    })[0];
    state[side].i=best; clearFlags(state[side].team[best]);
    toast(`${res>0?'ç›¸æ‰‹':'ã‚ãªãŸ'}ã¯${tm[best].name}ã‚’ãã‚Šã ã—ãŸï¼`); await delay(900);
    renderSides();
  }

  // è‡ªå‹•ã§ã‚¿ãƒ¼ãƒ³æ¶ˆåŒ–
  endOfTurn(left()); endOfTurn(right());
  updateSPBtn(); renderSides();
  state.busy=false; startRound();
}

function handName(h){ return h==='G'?'ã‚°ãƒ¼':h==='P'?'ãƒ‘ãƒ¼':'ãƒãƒ§ã‚­'; }

async function applyDamage(def,dmg,role){
  if(def.endure && def.hp-dmg<=0){ def.hp=1; def.endure=false; }
  else def.hp=Math.max(0,def.hp-dmg);
  $('hpbar-'+role).style.width=hpPct(def)+'%';
  $('hpnum-'+role).textContent=`${Math.max(0,Math.round(def.hp))}/${def.HP}`;
  await delay(500);
}

/* å¿…æ®ºã®æœ¬ä½“ï¼ˆæ¼”å‡ºâ†’åŠ¹æœï¼‰ */
async function doSpecial(att,def,isPlayer){
  // æŠ€å â†’ åŠ¹æœ
  if(att.rank==='X'){ // é¡æ–‡å­—
    const pool=state.B.team.filter(u=>u.hp>0 && u.rank!=='X');
    if(pool.length){
      const src=pool[Math.floor(Math.random()*pool.length)];
      toast(`${att.name}ã®å¿…æ®ºã€ã€Œé¡æ–‡å­—ã€ï¼ ${src.name}ã®ã€Œ${src.skill}ã€ã‚’ã‚³ãƒ”ãƒ¼ï¼`); await delay(900);
      toast(skillDesc(src)); await delay(900);
    }
  }else{
    toast(`${att.name}ã®å¿…æ®ºã€ã€Œ${att.skill}ã€ï¼`); await delay(900);
    toast(skillDesc(att)); await delay(900);
  }

  // åŠ¹æœ
  const mul = att.rank==='X' ? 2.0 :
              att.skill==='å¦¨å®³é›»æ³¢'? 2.5 :
              att.skill==='ãªã‚“ãã‚‹ãªã„ã•ãƒ¼'? 1.5 :
              att.skill==='ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ'? 1.5 :
              att.skill==='ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©'? 1.4 :
              att.skill==='ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§'? 1.6 :
              att.skill==='é•·å¯¿ã®ç§˜è¨£'? 1.2 :
              att.skill==='ãã¼ã‚ä¹±èˆ'? 1.0 :
              1.6; // ãã®ä»–ï¼ˆä½¿ã‚ãªã„ï¼‰

  // S/Aï¼šãƒãƒ•/æ”»æ’ƒ/å›å¾©
  if(att.rank==='S'||att.rank==='A'||att.rank==='X'){
    if(att.skill==='ä¸€æ¯ã„ã‹ãŒ'){
      // é€šå¸¸æ”»æ’ƒï¼‹å…¨ä½“60å›å¾©
      const d=baseDamage(att,def);
      await applyDamage(def,d,'enemy');
      state.A.team.forEach(x=>x.hp=Math.min(x.HP,x.hp+60));
      toast(`å‘³æ–¹ã®HPãŒå›å¾©ï¼`); await delay(900);
    }else if(att.skill==='é•·å¯¿ã®ç§˜è¨£'){
      att.atkMul*=mul; att.hp=Math.min(att.HP,att.hp+150);
    }else if(att.skill==='ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©'){
      att.atkMul*=mul; att.evaOverride=60; att.evaT=3;
    }else if(att.skill==='ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§'){
      att.atkMul*=mul; att.halfT=3;
    }else if(att.skill==='ãªã‚“ãã‚‹ãªã„ã•ãƒ¼'){
      att.atkMul*=mul; att.endure=true;
    }else if(att.skill==='ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ'){
      att.atkMul*=mul; att.atkMulT=2; // æ¬¡2T 1.3å€ã®æ‰±ã„ã¯ endOfTurn ã§
    }else if(att.skill==='ãã¼ã‚ä¹±èˆ'){
      // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†ã¯æ”»æ’ƒæ™‚ã«
    }else if(att.skill==='å¦¨å®³é›»æ³¢'){
      att.atkMul*=mul; def.sp=0; updateSPBtn();
    }else if(att.rank==='X'){
      // ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡ã¯ baseDamage æ™‚ã« 2å€åŠ ç®—æ¸ˆã¿æ‰±ã„ã«ã—ãªã„ã®ã§ã“ã“ã§ä¸€æ™‚å¢—å¹…
      att.atkMul*=2.0; att._xOnce=true; // ã“ã®ã‚¿ãƒ¼ãƒ³ã®ã¿
    }
  }else{
    // Bã€œDï¼šçŠ¶æ…‹ç•°å¸¸
    if(att.skill==='è¨€è‘‰ç‹©ã‚Š'){ def.skipT=Math.max(def.skipT,1); }
    if(att.skill==='è¨€è«–çµ±åˆ¶'){ def.noswitchT=Math.max(def.noswitchT,4); }
    if(att.skill==='ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š'){ def.gestaltT=Math.max(def.gestaltT,4); }
    if(att.skill==='æ–‡å­—åŒ–ã‘'){ def.doomT=Math.max(def.doomT,3); }
  }
}

/* ã‚¿ãƒ¼ãƒ³çµ‚äº†ã§æŒç¶šã‚’å‡¦ç†ï¼ˆã˜ã‚ƒã‚“ã‘ã‚“1å›ï¼1ã‚¿ãƒ¼ãƒ³ï¼‰ */
function endOfTurn(u,aiko=false){
  if(u.atkMulT>0){ // ã‚´ãƒªãƒ©
    u.atkMulT--; u.atkMul = u.atkMulT>0 ? 1.3 : 1.0;
  }
  if(u.evaT>0){ u.evaT--; if(u.evaT<=0) u.evaOverride=null; }
  if(u.halfT>0){ u.halfT--; }
  if(u.skipT>0){ u.skipT--; }
  if(u.gestaltT>0){ u.gestaltT--; }
  if(u.noswitchT>0){ u.noswitchT--; }
  if(u.doomT>0){ u.doomT--; if(u.doomT===0) u.hp=0; }
  if(u._xOnce){ u._xOnce=false; u.atkMul=1.0; }
}

/* ========== ç”»é¢é·ç§»ãƒ»åˆæœŸUI ========== */
function diag(msg){
  $('diag').textContent=msg;
}
diag('JS: OK / UI: OK / Bind: OK');
</script>
</body>
</html>
