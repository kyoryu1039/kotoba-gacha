<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLEï½œå¯¾æˆ¦ v7.1.3</title>
<style>
  :root{
    --bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;
    --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
    --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;
    --border:#1d2440;--accent:#9b8cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px} .sub{margin:4px 0 12px;color:var(--muted)}
  .grid{display:grid;gap:16px} .cols-2{grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select,input{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}
  .ghost{background:transparent;border:1px dashed #2b3a70}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}
  .muted{color:var(--muted)} .small{font-size:12px}
  .divider{height:1px;background:#1d2440;margin:12px 0}

  /* å¯¾æˆ¦ä¸­ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆç·¨æˆã¯éš ã™ï¼‰ */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  body.battleMode #battle .arena{min-height:100vh;border:none;border-radius:0}

  /* ã‚¢ãƒªãƒ¼ãƒŠ */
  .arena{position:relative;background:#0d1326;border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px}
  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:220px}
  .unit{background:var(--panel2);border:1px solid #22325c;border-radius:12px;padding:10px}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .40s}
  .gauge{display:flex;gap:4px;margin-top:6px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:var(--gauge);opacity:1}
  .readyPulse{animation:pulse 1.2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  /* ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒƒãƒ‰ï¼ˆä¸‹ï¼‰ */
  .pad{position:relative;display:grid;place-items:center;margin-top:6px}
  .padInner{position:relative;width:min(520px,90vw);height:220px}
  .rps{position:absolute;display:grid;place-items:center;width:88px;height:88px;border-radius:999px;border:none;color:#061225;font-size:18px}
  .rps.g{left:10%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}  /* èµ¤ */
  .rps.c{right:10%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)} /* é’ */
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)} /* ç·‘ */
  .switchBtn{position:absolute;right:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}
  .benchChip .type{color:#bcd}
  .benchChip .ratio{color:#9fe3ff;font-variant-numeric:tabular-nums}

  /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  /* 6ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¸‹éƒ¨ 3Ã—2ï¼‰ */
  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .miniCard.ally{outline:2px solid var(--ally)}
  .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:var(--hpBack);border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .4s}

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆäº¤ä»£é¸æŠï¼‰ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:30}
  .sheet{background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;padding:12px}
  .sheet h3{margin:0 0 8px;font-size:16px}
  .opt{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #213a6d;background:#0b1833;border-radius:10px;padding:8px;margin:6px 0;transition:.15s}
  .opt .right{display:flex;gap:10px;align-items:center}
  .badge{font-size:10px;padding:2px 6px;border:1px solid #2b3a70;border-radius:999px;color:#bcd}
  .badge.best{border-color:#ffd166;color:#ffd166}
  .opt.selected{outline:2px solid #ffd166; box-shadow:0 0 0 4px rgba(255,209,102,.25)}

  /* å¿…æ®ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
  .fx{position:absolute;inset:0;display:none;place-items:center;z-index:40}
  .fx .bang{font-weight:900;font-size:min(9vw,48px);padding:18px 22px;border-radius:18px;background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.25), transparent), linear-gradient(180deg,#fff3,transparent);border:2px solid #ffe066;color:#ffe9a3;filter:drop-shadow(0 0 20px #ffef99)}
  .fx.show{display:grid;animation:fxpop .8s ease}
  @keyframes fxpop{0%{transform:scale(.9);opacity:.2}60%{transform:scale(1.03);opacity:1}100%{transform:scale(1)}}

  /* ã‚¹ãƒãƒ›ï¼šç·¨æˆã¯1ã‚«ãƒ©ãƒ ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸‹ã¸ï¼‰ */
  @media (max-width:900px){
    #setup .grid.cols-2{grid-template-columns:1fr!important}
  }
</style>
</head>
<body>
<header><div class="container">
  <h1>å¯¾æˆ¦ v7.1.3</h1>
  <div class="sub">äºŒæ®µéšãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼å¿…æ®ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ç›¸æ€§ãŠã™ã™ã‚è¡¨ç¤ºï¼ˆ2025-08-12ä»•æ§˜ï¼‰</div>
</div></header>

<main class="container">
  <!-- ç·¨æˆ -->
  <section id="setup" class="grid cols-2">
    <section class="card">
      <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
      <div class="body">
        <div class="grid cols-2">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">ã‚ãªãŸ</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button id="randBoth" class="ghost">ä¸¡ãƒãƒ¼ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ </button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">
            å¯¾æˆ¦é–‹å§‹
          </button>
        </div>
        <div class="small muted">â€» åŒã˜è¨€è‘‰ã¯ä¸¡ãƒãƒ¼ãƒ åˆè¨ˆã§1å›ã¾ã§ï¼ˆå€™è£œã‚’è‡ªå‹•ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰ã€‚</div>
      </div>
    </section>
    <section class="card">
      <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <div class="body"><div id="stats" class="grid cols-2"></div></div>
    </section>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">ãƒãƒˆãƒ«</h2>
      <div class="body">
        <div class="arena">
          <!-- FX -->
          <div class="fx" id="fx"><div class="bang" id="fxText">å¿…æ®ºï¼</div></div>

          <!-- å¯¾é¢ -->
          <div class="vsrow">
            <div id="leftWrap"></div>
            <div id="rightWrap"></div>
          </div>

          <!-- ã‚³ãƒãƒ³ãƒ‰ -->
          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG">âœŠ ã‚°ãƒ¼</button>
              <button class="rps c" id="handC">âœŒï¸ ãƒãƒ§ã‚­</button>
              <button class="rps p" id="handP">ğŸ– ãƒ‘ãƒ¼</button>
              <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
              <button class="spToggle" id="btnSP">âœ¨ å¿…æ®º OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
          <div class="timer"><span class="label">é¸æŠã¾ã§</span><span class="num" id="countNum">15</span><span class="label">ç§’</span></div>

          <!-- 6ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
          <div id="sixStats"></div>

          <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">ãƒãƒˆãƒ«æº–å‚™ä¸­</div>
          <button id="backSetup">ç·¨æˆã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="switchModal">
  <div class="sheet">
    <h3 id="switchTitle">äº¤ä»£å…ˆã‚’é¸æŠ</h3>
    <div id="switchList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button style="background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225" id="doSwitch">äº¤ä»£ã™ã‚‹</button>
    </div>
  </div>
</div>

<script type="module">
(()=>{'use strict';
  if(window.__KB_V713__) return; window.__KB_V713__=true;

  /********** ãƒ‡ãƒ¼ã‚¿ **********/
  const WORDS=[
    ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],
    ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
    ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],
    ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
    ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],
    ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
    ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],
    ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
    ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],
    ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
    ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],
    ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
    ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],
    ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
    ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],
    ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
    ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],
    ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
    ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],
    ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
    ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],
    ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
    ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],
    ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
    ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],
    ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
    ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],
    ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
    ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],
    ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
    ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],
    ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"],
  ];

  const BD_ASSIGN={
    B:{ "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"kotobagari","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"genron","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"kotobagari","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"genron","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"genron","ãƒ”ãƒ­ãƒªèŒ":"gestalt","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"gestalt" },
    C:{ "ã•ã‚‹ã³ã‚ä¸¸":"kotobagari","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"kotobagari","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"genron","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"genron","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"gestalt","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"gestalt","é³¥å–ç ‚ä¸˜":"mojibake","æ¸¡æ¥äºº":"mojibake" },
    D:{ "ã‚¯ãƒãƒ³ãƒãƒ":"genron","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"gestalt","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"gestalt","çœŒåºæ‰€åœ¨åœ°":"mojibake","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"mojibake" }
  };

  const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150};
  const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};
  const EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
  const BASE_POWER=100, GAUGE_NEEDED=6;

  const RING=["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"];
  const TYPE_ADV = Object.fromEntries(RING.map((t,i)=>{
    const n=RING.length;
    const strong=[RING[(i+1)%n], RING[(i+2)%n]];
    const weak=[RING[(i-1+n)%n], RING[(i-2+n)%n]];
    return [t,{strong,weak}];
  }));

  const SPECIALS={
    "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":{ id:"ãªã‚“ãã‚‹ãªã„ã•ãƒ¼", kind:"buff_endure", params:{atkMult:1.6} },
    "ãã¼ã‚ã”ã¯ã‚“":    { id:"ãã¼ã‚ä¹±èˆ",       kind:"multi",       params:{hits:[0.75,0.5,0.25]} },
    "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":{ id:"ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
    "æ¯›ã‚€ãã˜ã‚ƒã‚‰":    { id:"ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©",     kind:"evasion",     params:{atkMult:1.4,evade:0.60,turns:3} },
    "ä¹å“ä»":          { id:"ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§", kind:"atk_def",     params:{atkMult:1.6,defMult:1.8,turns:3} },
    "ã‘ã‚“ã¡ã‚“æ±":      { id:"é•·å¯¿ã®ç§˜è¨£",       kind:"atk_heal",    params:{atkMult:1.2,heal:150} },
    "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ": { id:"å¦¨å®³é›»æ³¢",         kind:"atk_drain",   params:{atkMult:2.5} },
    "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":{ id:"ä¸€æ¯ã„ã‹ãŒ",  kind:"heal_attack_all", params:{self:60,allies:60} },
  };
  const AIL={
    kotobagari:{name:"è¨€è‘‰ç‹©ã‚Š",icon:"ğŸš«",apply:(st)=>{st.skipTurns=Math.max(st.skipTurns,1)},desc:"1Tè¡Œå‹•ä¸å¯"},
    genron:{name:"è¨€è«–çµ±åˆ¶",icon:"ğŸ”’",apply:(st)=>{st.genronTurns=Math.max(st.genronTurns,4)},desc:"4Täº¤ä»£ä¸å¯"},
    gestalt:{name:"ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š",icon:"ğŸŒ€",apply:(st)=>{st.gestaltTurns=Math.max(st.gestaltTurns,4)},desc:"4T 1/3ã§è‡ªå‚·100"},
    mojibake:{name:"æ–‡å­—åŒ–ã‘",icon:"â˜ ï¸",apply:(st)=>{st.doomTurns=Math.max(st.doomTurns,3)},desc:"3Tå¾Œã«å³æ­»"}
  };

  /********** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ **********/
  const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
  const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
  const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
  const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
  const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
  const visibleLength=(s)=>[...s].length;
  const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
  function hiraRatioForEvasion(name){ const letters=[...name].filter(isKanaOrKanji); if(!letters.length) return 0; const hira=letters.filter(isHira).length; return hira/letters.length; }
  function rKataForStructure(name){ const kata=[...name].filter(isKataLetter).length; const kan=[...name].filter(isKanji).length; const den=kata+kan; if(!den) return null; return kata/den; }
  function phoneticDensities(readingHira){
    const kata=[...hiraToKata(readingHira)].filter(isKataLetter);
    const L=kata.length||1;
    const smalls=new Set("ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®".split(""));
    const voiced=new Set("ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒãƒ´".split(""));
    const last=kata[kata.length-1]||"";
    const plos=new Set("ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ‘ãƒ”ãƒ—ãƒšãƒãƒãƒ“ãƒ–ãƒ™ãƒœ".split(""));
    const d=kata.filter(ch=>voiced.has(ch)).length/L;
    const s=kata.filter(ch=>'ãƒƒ'===ch).length/L;
    const m=kata.filter(ch=>smalls.has(ch)).length/L;
    const e=plos.has(last)?1:0;
    return {d,s,m,e};
  }

  /********** ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— **********/
  function calcStats(name, rank, type, readingHira){
    const T=visibleLength(name);
    let atk_struct,def_struct;{
      const r=rKataForStructure(name);
      if(r===null){ atk_struct=0.125; def_struct=0.125; } else { atk_struct=0.25*r; def_struct=0.25-atk_struct; }
    }
    let atk_phon,def_phon;{
      const {d,s,m,e}=phoneticDensities(readingHira);
      const Lw=0.05, Uw=0.45;
      const s_raw=0.6*d+0.25*(s+m)+0.15*e;
      const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);
      atk_phon=0.2*(0.5+0.5*s_ph); def_phon=0.2-atk_phon;
    }
    let atk_len,def_len;{
      const s_len=clamp((6-T)/6,-1,1);
      atk_len=0.2*(0.5+0.5*s_len); def_len=0.2-atk_len;
    }
    const atk_pct=0.175+atk_struct+atk_phon+atk_len;
    const def_pct=0.175+def_struct+def_phon+def_len;
    const P=P_RANK[rank];
    const ATK=Math.round(P*atk_pct);
    const DEF=Math.round(P*def_pct);
    const HP=HP_BASE[rank]+20*(T-5);
    let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];
    eva=clamp(eva,5,35);
    return {ATK,DEF,HP,Evasion:eva};
  }

  /********** ãƒãƒˆãƒ«åŸºç›¤ **********/
  const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};

  function createFighter([name,rank,type,reading]){
    const st=calcStats(name,rank,type,reading);
    return {name,rank,type,reading,base:st,hp:st.HP,gauge:0,atkMult:1,defMult:1,atkTurns:0,defTurns:0,evadeOverride:null,endure:false,skipTurns:0,gestaltTurns:0,doomTurns:0,genronTurns:0,_gorillaActive:false,_manualForce:false,_gFull:false};
  }

  function computeDamageDetailed(att,def,isSpecial,rng){
    if(!isSpecial){
      const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
      if(rng()<eva) return {dmg:0,miss:true,luck:'normal',matchup:'even'};
    }
    let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
    dmg*=att.atkMult;
    const tm=typeMult(att.type,def.type); dmg*=tm;
    const r=rng(); let luck='normal';
    if(r<0.2){ dmg*=1.2; luck='lucky'; } else if(r<0.4){ dmg*=0.8; luck='unlucky'; }
    const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
    return {dmg,miss:false,luck,matchup};
  }

  /********** ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆ1.5å€ & é †åºä¿è¨¼ï¼‰ **********/
  const TOAST_MS = 4200; // 2800 * 1.5
  const toast = document.getElementById('toast');
  let queue=[], busy=false;
  function show(text, ms=TOAST_MS){ queue.push({text,ms}); if(!busy) nextToast(); }
  function nextToast(){ if(queue.length===0){ busy=false; return; } busy=true; const {text,ms}=queue.shift(); toast.textContent=text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(nextToast, 180); }, ms); }

  /********** ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è£œåŠ© **********/
  const handLabel=h=>h==='g'?'ã‚°ãƒ¼':(h==='c'?'ãƒãƒ§ã‚­':'ãƒ‘ãƒ¼');
  function narrRPS(my, cpu, res){
    const me=handLabel(my||'g'), op=handLabel(cpu);
    const result = res===-1?'ã‚ã„ã“':(res===0?'ã‚ãªãŸã®ï¼ˆå‹ã¡ï¼‰':'ã‚ãªãŸã®ï¼ˆè² ã‘ï¼‰');
    show(`ã‚ãªãŸã¯ï¼ˆ${me}ï¼‰ã€‚ç›¸æ‰‹ã¯ï¼ˆ${op}ï¼‰ã€‚${result}ã€‚`);
  }
  function narrAttackLine(attackerName, dmg, luck, matchup){
    const luckTxt = luck==='lucky'?'ï¼ˆãƒ©ãƒƒã‚­ãƒ¼ï¼ï¼‰': luck==='unlucky'?'ï¼ˆã‚¢ãƒ³ãƒ©ãƒƒã‚­ãƒ¼â€¦ï¼‰':'';
    const muTxt   = matchup==='good'?' ç›¸æ€§æŠœç¾¤ï¼': matchup==='bad'?' ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':'';
    show(`${attackerName}ã®æ”»æ’ƒï¼${luckTxt} ${Math.round(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${muTxt}`);
  }

  /********** å¿…æ®ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ **********/
  const fx=document.getElementById('fx'), fxText=document.getElementById('fxText');
  function playSpFx(title){ fxText.textContent=title; fx.classList.add('show'); setTimeout(()=>fx.classList.remove('show'), 900); }

  /********** ãƒ€ãƒ¡ãƒ¼ã‚¸é©ç”¨ **********/
  function dealAttack(actor,target,isSpecial,rng){
    if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; show(`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100`); return {self:true, msg:`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100`}; }
    const sp=SPECIALS[actor.name];
    if(isSpecial && sp && sp.kind==='multi'){
      const keep=actor.atkMult; let total=0, anyLucky=false, anyUnlucky=false, matchup='even';
      for(const s of sp.params.hits){
        actor.atkMult=keep*s;
        const info=computeDamageDetailed(actor,target,true,rng);
        total+=info.dmg;
        if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
        if(info.luck==='lucky') anyLucky=true; if(info.luck==='unlucky') anyUnlucky=true;
        
