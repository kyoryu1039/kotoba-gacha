<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>KOTOBA-BATTLE | 対戦 v7.4.10</title>
<style>
:root{
  --bg:#0b1020; --panel:#0f1633; --muted:#96a7d6; --text:#eaf2ff; --border:#1b2550;
  --ally:#67d2ff; --ally2:#2fb1ff; --enemy:#ff9ea1; --enemy2:#ff6b7a;
  --gaugeBack:#2f385f; --gauge:#f7a64b; --hp:#68ff8b; --hpBack:#12231f;
  --toast:#0e1a3a; --accent:#59f; --ok:#42d392; --warn:#ffcc00; --bad:#ff5c6b;

  /* タイプ色（ポップに） */
  --t-ジオ:#4fd1c5; --t-アニマル:#f6ad55; --t-フード:#f687b3;
  --t-コンセプト:#60a5fa; --t-サイエンス:#a78bfa; --t-ヒストリー:#f59e0b; --t-ヒューマン:#10b981;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,"Noto Sans JP",sans-serif;
}
header{
  position:sticky;top:0;z-index:5;
  background:rgba(11,18,39,.92);backdrop-filter:saturate(140%) blur(6px);
  border-bottom:1px solid var(--border);
  padding:14px 16px;font-weight:700;font-size:20px;letter-spacing:.05em;
}
.sub{font-weight:500;font-size:12px;color:var(--muted);margin-top:4px}

/* レイアウト */
.container{padding:16px;max-width:1100px;margin:0 auto}
.card{
  background:var(--panel); border:1px solid var(--border);
  border-radius:16px; padding:16px; margin-bottom:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.25)
}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 0}
.hd{font-size:18px;font-weight:800;margin-bottom:12px}

/* 編成 */
.teamBox{display:flex;gap:12px;flex-wrap:wrap}
.slot{
  background:#0c1431;border:1px dashed #234; border-radius:12px;
  padding:10px 12px;min-width:260px;color:#cfe6ff
}
.btn{
  user-select:none; cursor:pointer; text-align:center;
  border:1px solid #234; border-radius:12px; padding:12px 14px;
  background:linear-gradient(180deg,#1a2a57,#10204a); color:#eaf2ff; font-weight:700
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(180deg,#4aa9ff,#1a73ff)}
.btn.gray{background:linear-gradient(180deg,#162447,#0e1738);color:#b9c6ee}
.btn.disabled{opacity:.45;pointer-events:none}

/* ステータス表（編成時・バトル時共通） */
.statGrid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
@media (max-width:800px){ .statGrid{grid-template-columns:1fr 1fr} }
@media (max-width:640px){ .statGrid{grid-template-columns:1fr} }
.statCard{
  border:1px solid var(--border); border-radius:14px; padding:12px; background:#0c1431; position:relative;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)
}
.statHead{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.badge{font-size:11px;font-weight:800;padding:3px 8px;border-radius:99px;color:#001225; background:#9cf}
.typeChip{font-size:11px;font-weight:800;padding:3px 8px;border-radius:99px;background:#223;color:#bfe8ff}
.hpLine{height:10px;background:var(--hpBack);border-radius:999px;overflow:hidden}
.hpFill{height:100%;background:linear-gradient(90deg,var(--hp),#b7ffca);width:0%}
.gauge{display:flex;gap:4px;margin:6px 0}
.pip{width:12px;height:12px;border-radius:3px;background:var(--gaugeBack)}
.pip.on{background:linear-gradient(180deg,#f6b15a,#f08a2e)}
.statRow{display:grid;grid-template-columns:72px 1fr 58px;gap:8px;align-items:center}
.bar{height:8px;background:#13214a;border-radius:6px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#4ecbff,#7bf);width:0%}

/* バトルの盤面 */
.battle{display:none}
.board{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:820px){ .board{grid-template-columns:1fr 1fr} }
.cardUnit{
  position:relative;border:2px solid #1a244a;border-radius:18px;padding:12px;background:#0a1331;
  box-shadow:0 10px 26px rgba(0,0,0,.35)
}
.cardUnit.ally{outline:2px solid rgba(103,210,255,.35)}
.cardUnit.enemy{outline:2px solid rgba(255,122,130,.35)}
.cardUnit .name{font-size:18px;font-weight:900;letter-spacing:.03em}
.cardUnit .type{position:absolute;top:10px;right:12px;font-size:12px;font-weight:800;padding:3px 8px;border-radius:99px;background:#223}

/* タイプ色 */
.type[data-type="ジオ"]{background:var(--t-ジオ);color:#041c1a}
.type[data-type="アニマル"]{background:var(--t-アニマル);color:#2a1300}
.type[data-type="フード"]{background:var(--t-フード);color:#330419}
.type[data-type="コンセプト"]{background:var(--t-コンセプト);color:#031229}
.type[data-type="サイエンス"]{background:var(--t-サイエンス);color:#1a0d34}
.type[data-type="ヒストリー"]{background:var(--t-ヒストリー);color:#2b1600}
.type[data-type="ヒューマン"]{background:var(--t-ヒューマン);color:#001d16}

/* 必殺パネル */
.spPanel{margin-top:10px;border:1px solid #20305f;background:#0b173a;border-radius:12px;padding:10px}
.spTitle{font-weight:900;font-size:14px;margin-bottom:6px}
.spDesc{color:#cfe0ff;font-size:12px;line-height:1.5}

/* じゃんけん＆交代 UI */
.ctrl{
  margin-top:8px; display:grid; grid-template-columns:repeat(4,1fr); gap:8px
}
.rps{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  border-radius:99px; padding:12px 4px; font-weight:800; cursor:pointer;
  color:#001225; border:none
}
.rps span{font-size:13px}
.rps.g{background:radial-gradient(60% 60% at 50% 30%,#ffd2d2,#ff8f8f)}
.rps.c{background:radial-gradient(60% 60% at 50% 30%,#d2d9ff,#9bb0ff)}
.rps.p{background:radial-gradient(60% 60% at 50% 30%,#d4ffd8,#9df9b2)}
.rps.swap{background:radial-gradient(60% 60% at 50% 30%,#ffe3b5,#ffc46b)}
.rps.disabled{opacity:.5;pointer-events:none}

.toggle{grid-column:span 4; display:flex; gap:8px; align-items:center}
.spBtn{border:2px solid #2a3d7b;border-radius:12px;padding:10px 12px;font-weight:900;
  background:#0a1a47;color:#cfe6ff;cursor:pointer}
.spBtn.on{background:#d3a900;color:#1a1500;border-color:#f7d24f;animation:blink 1.2s linear infinite}
@keyframes blink{0%,60%{box-shadow:0 0 0 rgba(255,255,0,.0)} 80%{box-shadow:0 0 20px rgba(255,255,0,.55)} 100%{box-shadow:0 0 0 rgba(0,0,0,0)}}

.timer{margin-left:auto;color:#cfe6ff;font-weight:900}

/* トースト */
.toastWrap{position:fixed;left:16px;right:16px;bottom:16px;z-index:20;pointer-events:none}
.toast{
  margin:8px auto 0;max-width:960px; background:var(--toast);color:#e9f2ff;
  border:1px solid #243366; border-radius:12px;padding:12px 14px; font-weight:700;
  box-shadow:0 12px 30px rgba(0,0,0,.45)
}

/* カードの揺れ（被弾） */
.hit{animation:shake .4s ease}
@keyframes shake{
  0%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)}
  60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} 100%{transform:translateX(0)}
}

/* スクロール（控え） */
.bench{display:flex;gap:8px;overflow:auto;padding:6px 2px}
.bench::-webkit-scrollbar{height:8px}
.bench::-webkit-scrollbar-thumb{background:#2a396f;border-radius:99px}

/* ユーティリティ */
.flex{display:flex;gap:8px;align-items:center}
.end{justify-content:flex-end}
.sep{height:1px;background:#1e2a52;margin:8px 0}
.small{font-size:12px;color:#cfe0ff}
.hide{display:none !important}
</style>
</head>
<body>
<header>
  対戦 v7.4.10
  <div class="sub">色分け・HP長バー／相対バー／二段階アナウンス／必殺ゲージON点滅・6溜まりトースト／強制交代／Xコピー表示</div>
</header>

<div class="container">
  <!-- 編成 -->
  <section id="team" class="card">
    <div class="hd">チーム編成（あなた / CPU）</div>
    <div class="teamBox" id="teamBox"></div>
    <div class="flex end">
      <button id="btnRand" class="btn gray">ランダムでチームを編成</button>
      <button id="btnStart" class="btn primary">対戦開始</button>
    </div>
  </section>

  <!-- 選択中のステータス（編成時） -->
  <section id="pickStats" class="card">
    <div class="hd">選択中のステータス</div>
    <div class="statGrid" id="pickGrid"></div>
  </section>

  <!-- バトル -->
  <section id="battle" class="battle">
    <div class="card">
      <div class="board" id="board"></div>
      <div class="ctrl" id="ctrl">
        <button class="rps g" data-hand="g">✊<span>グー</span></button>
        <button class="rps c" data-hand="c">✌️<span>チョキ</span></button>
        <button class="rps p" data-hand="p">🖐️<span>パー</span></button>
        <button class="rps swap" id="btnSwap">🔁<span>交代</span></button>
        <div class="toggle">
          <button id="spToggle" class="spBtn">✨ 必殺 OFF</button>
          <div class="timer" id="timer">15 秒</div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="bench" id="bench"></div>
      <div class="sep"></div>
      <div class="statGrid" id="liveStats"></div>
    </div>
  </section>
</div>

<div class="toastWrap" id="toastWrap"></div>

<script>
/* ===========================================================
   安全ガード（多重読込防止）
=========================================================== */
if (window.__KB_BATTLE__) {
  console.warn("Already loaded");
} else {
  window.__KB_BATTLE__ = true;

/* ===========================================================
   データ（ワード・読み・ランク・タイプ・技）
   ※実ステは起動時に仕様式で算出
=========================================================== */
const RANKS = { "S":170,"A":165,"B":160,"C":150,"D":145,"X":150 };
const HP_BASE = { "S":560,"A":540,"B":520,"C":500,"D":480,"X":500 };
const MAXS = { HP:800, ATK:120, DEF:120, EVA:20 }; // 相対バー基準

// 7タイプの円環（強2・弱2）
const TYPE_RING = ["ヒストリー","ジオ","コンセプト","サイエンス","アニマル","ヒューマン","フード"];
function typeRel(a,b){
  const n = TYPE_RING.length;
  const ia = TYPE_RING.indexOf(a), ib = TYPE_RING.indexOf(b);
  if (ia<0||ib<0) return 1.0;
  const d = (ib-ia+n)%n;
  if (d===1||d===2) return 1.5;     // 強
  if (d===n-1||d===n-2) return 0.67;// 弱
  return 1.0;
}

// 必殺（A/Sは個別、B〜Dは状態異常）
const SPECIALS = {
  "パラボラアンテナ":{name:"妨害電波",desc:"攻撃2.2倍＋相手の必殺ゲージを0にする。", kind:"buff+drain", mult:2.2},
  "ネスカフェアンバサダー":{name:"一杯いかが",desc:"味方全員のHPを60回復（自分も60）。", kind:"healAll", healSelf:60, healAlly:60},
  "にんじんしりしり":{name:"なんくるないさー",desc:"攻撃1.5倍＋致死ダメージでも1だけ耐える（次の1回）。", kind:"buff+endure", mult:1.5},
  "そぼろごはん":{name:"そぼろ乱舞",desc:"3連撃（0.75→0.5→0.25倍）。途中で倒しても次の相手に続行。", kind:"multi", hits:[0.75,0.5,0.25]},
  "ニシローランドゴリラ":{name:"マウンテンビート",desc:"初回1.5倍＋以降2ターンは1.3倍。", kind:"gorilla", first:1.5, next:1.3, turns:2},
  "毛むくじゃら":{name:"ムクジャララ",desc:"攻撃1.4倍＋回避率60%を3ターン付与。", kind:"evadeBuff", mult:1.4, evade:0.60, turns:3},
  "九品仏":{name:"仏の顔も三度まで",desc:"攻撃1.6倍＋被ダメ1/2を3ターン。", kind:"half", mult:1.6, turns:3},
  "けんちん汁":{name:"長寿の秘訣",desc:"攻撃1.2倍＋HP150回復。", kind:"healBuff", mult:1.2, heal:150},
  // B〜D 状態異常（平準化例）
  "_kotobagari":{name:"言葉狩り",desc:"1ターン相手は行動できない。", kind:"stun", turns:1 },
  "_genron":{name:"言論統制",desc:"4ターン相手は交代できない。", kind:"noswitch", turns:4 },
  "_gestalt":{name:"ゲシュタルト崩壊",desc:"4ターン、攻撃時33%で自傷100。", kind:"selfhit", turns:4, self:100, prob:1/3 },
  "_mojibake":{name:"文字化け",desc:"3ターン後に気絶する。交代で解除。", kind:"doom", after:3 }
};

// ワード（読みはひらがな）
const WORDS = [
  // S
  ["パラボラアンテナ","S","サイエンス","ぱらぼらあんてな"],
  ["ネスカフェアンバサダー","S","ヒューマン","ねすかふぇあんばさだー"],
  // A
  ["にんじんしりしり","A","フード","にんじんしりしり"],
  ["そぼろごはん","A","フード","そぼろごはん"],
  ["ニシローランドゴリラ","A","アニマル","にしろーらんどごりら"],
  ["毛むくじゃら","A","アニマル","けむくじゃら"],
  ["九品仏","A","ジオ","くほんぶつ"],
  ["けんちん汁","A","フード","けんちんじる"],
  // B
  ["カムチャッカ半島","B","ジオ","かむちゃっかはんとう","_genron"],
  ["タランチュラ","B","アニマル","たらんちゅら","_kotobagari"],
  ["ハシビロコウ","B","アニマル","はしびろこう","_genron"],
  ["バルサミコ酢","B","フード","ばるさみこす","_genron"],
  ["ピロリ菌","B","サイエンス","ぴろりきん","_gestalt"],
  ["トリニダード・トバゴ","B","ジオ","とりにだーどとばご","_kotobagari"],
  ["カラメル色素","B","サイエンス","からめるしきそ","_gestalt"],
  // C
  ["バビロン捕囚","C","ヒストリー","ばびろんほしゅう","_genron"],
  ["鳥取砂丘","C","ジオ","とっとりさきゅう","_gestalt"],
  ["プラシーボ効果","C","サイエンス","ぷらしーぼこうか","_gestalt"],
  ["渡来人","C","ヒューマン","とらいじん","_mojibake"],
  ["さるびあ丸","C","ジオ","さるびあまる","_gestalt"],
  ["ペペロンチーノ","C","フード","ぺぺろんちーの","_gestalt"],
  ["ポリプロピレン","C","サイエンス","ぽりぷろぴれん","_genron"],
  ["サラエボ事件","C","ヒストリー","さらえぼじけん","_kotobagari"],
  // D
  ["クマンバチ","D","アニマル","くまんばち","_genron"],
  ["県庁所在地","D","ジオ","けんちょうしょざいち","_mojibake"],
  ["照り焼きチキン","D","フード","てりやきちきん","_mojibake"],
  ["ねるねるねるね","D","フード","ねるねるねるね","_gestalt"],
  ["スルメイカ","D","アニマル","するめいか","_gestalt"],
  // X
  ["本質","X","コンセプト","ほんしつ"],
  ["見える化","X","コンセプト","みえるか"],
  ["自分ごと化","X","コンセプト","じぶんごとか"],
  ["解像度","X","コンセプト","かいぞうど"],
];

// ひらがな/カタカナ判定＆音素密度
const HIRA=/[ぁ-ゖ]/g, KATA=/[ァ-ヶー]/g;
const DAKU=/[がぎぐげござじずぜぞだぢづでどばびぶべぼぱぴぷぺぽ]/g;
const SOKU=/っ/g, SMALL=/[ゃゅょぁぃぅぇぉ]/g;

// 実ステ算出
function computeStats(entry){
  const [name,rank,type,reading,bdEff] = entry;
  const T = [...reading].length;
  const baseHP = HP_BASE[rank] + 20*(T-5);
  // 構成25%：読みは全ひらがな扱い→12.5/12.5
  const atk_struct = 12.5, def_struct = 12.5;

  // 音20%
  const len = Math.max(1,[...reading].length);
  const d = ((reading.match(DAKU)||[]).length)/len;
  const s = ((reading.match(SOKU)||[]).length)/len;
  const m = ((reading.match(SMALL)||[]).length)/len;
  const e = /[つくちっ]$/.test(reading) ? 1:0;
  const s_raw = 0.6*d + 0.25*(s+m) + 0.15*e;
  const L=0.05,U=0.45;
  const s_ph = Math.max(-1,Math.min(1, ((s_raw-L)/(U-L))*2-1 ));
  const atk_sound = 20*(0.5+0.5*s_ph);
  const def_sound = 20-atk_sound;

  // 長さ20%
  const s_len = Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len = 20*(0.5+0.5*s_len);
  const def_len = 20-atk_len;

  const atkPerc = 17.5 + atk_struct + atk_sound + atk_len;
  const defPerc = 17.5 + def_struct + def_sound + def_len;

  const ATK = Math.round(RANKS[rank] * (atkPerc/100));
  const DEF = Math.round(RANKS[rank] * (defPerc/100));

  // 回避率
  const hiraN = (reading.match(HIRA)||[]).length;
  const kataN = (reading.match(KATA)||[]).length;
  const hiraRatio = Math.max(0, Math.min(1, hiraN / Math.max(1,hiraN+kataN)));
  let eva = 10 + 8*hiraRatio - 0.5*(T-5);
  const adj = rank==="S"?-1 : rank==="A"?-0.5 : rank==="C"?0.5 : rank==="D"?1 : 0;
  eva = Math.max(5, Math.min(35, eva + adj));
  return {
    name, rank, type, reading, hp:Math.round(baseHP), atk:ATK, def:DEF, eva:eva,
    bdEff: bdEff || null
  };
}
const ROSTER = WORDS.map(computeStats);

/* ===========================================================
   便利関数
=========================================================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function el(tag,cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

// トースト（全て 1.5s + 0.06s * 文字数）
function toast(msg){ 
  const box = el("div","toast"); box.textContent = msg;
  $("#toastWrap").appendChild(box);
  const t = 1500 + msg.length*60;
  setTimeout(()=>box.remove(), t);
}

// 相対バー %（HP800/ATK120/DEF120/EVA20）
function pct(val,max){ return clamp( (val/max)*100, 0, 100 ); }

/* ===========================================================
   編成 UI
=========================================================== */
const state = {
  teamA:[], teamB:[],
  selA:null, selB:null,
  battle:null
};

function buildTeamUI(){
  const box = $("#teamBox"); box.innerHTML = "";
  const side = (label,color,arr,isCPU)=> {
    const wrap = el("div","col");
    const head = el("div","hd"); head.textContent = isCPU ? "CPU" : "あなた"; head.style.color = isCPU?'var(--enemy2)':'var(--ally2)';
    wrap.appendChild(head);
    for(let i=0;i<3;i++){
      const slot = el("div","slot");
      const d = arr[i];
      slot.textContent = d ? `${d.name} [${d.rank}/${d.type}]` : `#${i+1}（未選択）`;
      slot.onclick = ()=> {
        const pick = selectWordModal(isCPU);
        pick.then(w=>{
          if(!w) return;
          // 重複禁止（同じチーム内）
          if(arr.some(x=>x && x.name===w.name)){ toast("同じチーム内で同じ言葉は選べません。"); return; }
          arr[i] = w; buildTeamUI(); renderPickStats();
        });
      };
      wrap.appendChild(slot);
    }
    return wrap;
  };
  box.appendChild(side("あなた","var(--ally2)",state.teamA,false));
  box.appendChild(side("CPU","var(--enemy2)",state.teamB,true));
}

function selectWordModal(isCPU){
  return new Promise(resolve=>{
    // 簡易ピッカー（スマホ前提でシンプルに）
    const list = el("div","card");
    list.style.position="fixed"; list.style.inset="24px 16px auto 16px"; list.style.zIndex="30"; list.style.maxHeight="70vh"; list.style.overflow="auto";
    const hd = el("div","hd"); hd.textContent = "言葉を選ぶ"; list.appendChild(hd);
    ROSTER.forEach(w=>{
      // 相手チームと重複不可
      const other = isCPU?state.teamB:state.teamA;
      const dup = other.some(x=>x && x.name===w.name);
      const btn = el("div","btn" + (dup?" disabled":""));
      btn.style.marginBottom="8px";
      btn.textContent = `${w.name} [${w.rank}/${w.type}]`;
      btn.onclick = ()=>{ if(dup) return; list.remove(); resolve(w); };
      list.appendChild(btn);
    });
    const cancel = el("div","btn gray"); cancel.textContent="キャンセル"; cancel.onclick=()=>{ list.remove(); resolve(null); };
    list.appendChild(cancel);
    document.body.appendChild(list);
  });
}

function renderPickStats(){
  const g = $("#pickGrid"); g.innerHTML = "";
  const mk = (side, arr, color)=> {
    const box = el("div","statCard");
    const h = el("div","statHead");
    const b = el("span","badge"); b.textContent = side; b.style.background=color; box.appendChild(h); h.appendChild(b);
    g.appendChild(box);
    if(arr.length){
      arr.filter(Boolean).forEach(w=>{
        box.appendChild(renderStatsMini(w));
      });
    }else{
      const s = el("div","small"); s.textContent="未選択"; box.appendChild(s);
    }
  };
  mk("あなた", state.teamA, "linear-gradient(180deg,var(--ally),var(--ally2))");
  mk("CPU", state.teamB, "linear-gradient(180deg,var(--enemy),var(--enemy2))");
}

function renderStatsMini(w){
  const wrap = el("div"); wrap.style.margin="8px 0";
  const row = el("div","flex"); row.style.justifyContent="space-between";
  const nm = el("div"); nm.textContent = `${w.name} [${w.rank}/${w.type}]`;
  const chip = el("div","typeChip"); chip.textContent = w.type; chip.style.background=`var(--t-${w.type})`; chip.style.color="#03121a";
  row.appendChild(nm); row.appendChild(chip); wrap.appendChild(row);

  [["HP",w.hp,MAXS.HP],["攻撃",w.atk,MAXS.ATK],["防御",w.def,MAXS.DEF],["回避",w.eva,MAXS.EVA]].forEach(([k,v,m])=>{
    const r = el("div","statRow");
    const kdiv = el("div"); kdiv.textContent=k;
    const bar = el("div","bar"); const f = el("div","fill"); f.style.width=pct(v,m)+"%"; bar.appendChild(f);
    const vdiv = el("div"); vdiv.textContent = (k==="回避"?v.toFixed(1)+"%":v);
    r.appendChild(kdiv); r.appendChild(bar); r.appendChild(vdiv); wrap.appendChild(r);
  });
  return wrap;
}

$("#btnRand").onclick = ()=>{
  const pick3 = ()=> {
    const pool=[...ROSTER]; const out=[];
    while(out.length<3 && pool.length){ const i=Math.floor(Math.random()*pool.length); const w=pool.splice(i,1)[0]; out.push(w); }
    return out;
  };
  state.teamA = pick3(); state.teamB = pick3();
  buildTeamUI(); renderPickStats();
};

$("#btnStart").onclick = ()=>{
  if(state.teamA.filter(Boolean).length<3 || state.teamB.filter(Boolean).length<3){
    toast("両チームとも3体そろえてください。"); return;
  }
  startBattle();
};

/* ===========================================================
   バトル
=========================================================== */
const BASE_POWER = 100;
const NEED = 6;          // 必殺ゲージ必要ポイント
const TURN_LIMIT = 15;   // 秒
let timerId=null, left=TURN_LIMIT;

function unitFrom(w, side){
  return {
    side, ...w,
    hpNow:w.hp,
    gauge:0,
    endure:false,
    half:0,
    evadeOv:0, evadeRate:0,
    gorTurns:0, gorBuff:1.0,
    stun:0, noswitch:0, selfhit:0, doom:0,
    alive:true
  };
}

function startBattle(){
  // 画面遷移
  $("#team").classList.add("hide");
  $("#pickStats").classList.add("hide");
  $("#battle").style.display="block";

  // チーム生成
  const A = state.teamA.map(w=>unitFrom(w,"A"));
  const B = state.teamB.map(w=>unitFrom(w,"B"));
  state.battle = {A,B, ia:0, ib:0, aHand:null, bHand:null, wantSP:false};
  toast(`いけ、${A[0].name}！ バトルスタート！`);
  renderBoard(); renderLiveStats(); buildBench(); setupRPS();
  startTimer();
}

function renderBoard(){
  const bd = $("#board"); bd.innerHTML="";

  const draw = (u, isEnemy)=>{
    const box = el("div","cardUnit " + (isEnemy?"enemy":"ally"));
    const name = el("div","name"); name.textContent = u.name; box.appendChild(name);
    const tp = el("div","type"); tp.dataset.type=u.type; tp.textContent=u.type; box.appendChild(tp);

    const hpRow = el("div","flex"); hpRow.style.justifyConte
