<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLE｜対戦 v7.1.3</title>
<style>
  :root{
    --bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;
    --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
    --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;
    --border:#1d2440;--accent:#9b8cff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px} .sub{margin:4px 0 12px;color:var(--muted)}
  .grid{display:grid;gap:16px} .cols-2{grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select,input{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}
  .ghost{background:transparent;border:1px dashed #2b3a70}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}
  .muted{color:var(--muted)} .small{font-size:12px}
  .divider{height:1px;background:#1d2440;margin:12px 0}

  /* 対戦中フルスクリーン（編成は隠す） */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  body.battleMode #battle .arena{min-height:100vh;border:none;border-radius:0}

  /* アリーナ */
  .arena{position:relative;background:#0d1326;border:1px solid var(--border);border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px}
  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:220px}
  .unit{background:var(--panel2);border:1px solid #22325c;border-radius:12px;padding:10px}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .40s}
  .gauge{display:flex;gap:4px;margin-top:6px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:var(--gauge);opacity:1}
  .readyPulse{animation:pulse 1.2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  /* コマンドパッド（下） */
  .pad{position:relative;display:grid;place-items:center;margin-top:6px}
  .padInner{position:relative;width:min(520px,90vw);height:220px}
  .rps{position:absolute;display:grid;place-items:center;width:88px;height:88px;border-radius:999px;border:none;color:#061225;font-size:18px}
  .rps.g{left:10%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}  /* 赤 */
  .rps.c{right:10%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)} /* 青 */
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)} /* 緑 */
  .switchBtn{position:absolute;right:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}
  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}
  .benchChip .type{color:#bcd}
  .benchChip .ratio{color:#9fe3ff;font-variant-numeric:tabular-nums}

  /* カウントダウン */
  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  /* 6体ステータス（下部 3×2） */
  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .miniCard.ally{outline:2px solid var(--ally)}
  .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:var(--hpBack);border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .4s}

  /* モーダル（交代選択） */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:30}
  .sheet{background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;padding:12px}
  .sheet h3{margin:0 0 8px;font-size:16px}
  .opt{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #213a6d;background:#0b1833;border-radius:10px;padding:8px;margin:6px 0;transition:.15s}
  .opt .right{display:flex;gap:10px;align-items:center}
  .badge{font-size:10px;padding:2px 6px;border:1px solid #2b3a70;border-radius:999px;color:#bcd}
  .badge.best{border-color:#ffd166;color:#ffd166}
  .opt.selected{outline:2px solid #ffd166; box-shadow:0 0 0 4px rgba(255,209,102,.25)}

  /* 必殺エフェクト */
  .fx{position:absolute;inset:0;display:none;place-items:center;z-index:40}
  .fx .bang{font-weight:900;font-size:min(9vw,48px);padding:18px 22px;border-radius:18px;background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.25), transparent), linear-gradient(180deg,#fff3,transparent);border:2px solid #ffe066;color:#ffe9a3;filter:drop-shadow(0 0 20px #ffef99)}
  .fx.show{display:grid;animation:fxpop .8s ease}
  @keyframes fxpop{0%{transform:scale(.9);opacity:.2}60%{transform:scale(1.03);opacity:1}100%{transform:scale(1)}}

  /* スマホ：編成は1カラム（ステータスを下へ） */
  @media (max-width:900px){
    #setup .grid.cols-2{grid-template-columns:1fr!important}
  }
</style>
</head>
<body>
<header><div class="container">
  <h1>対戦 v7.1.3</h1>
  <div class="sub">二段階ナレーション／必殺エフェクト／相性おすすめ表示（2025-08-12仕様）</div>
</div></header>

<main class="container">
  <!-- 編成 -->
  <section id="setup" class="grid cols-2">
    <section class="card">
      <h2>チーム編成（あなた / CPU）</h2>
      <div class="body">
        <div class="grid cols-2">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">あなた</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button id="randBoth" class="ghost">両チームをランダム</button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">
            対戦開始
          </button>
        </div>
        <div class="small muted">※ 同じ言葉は両チーム合計で1回まで（候補を自動グレーアウト）。</div>
      </div>
    </section>
    <section class="card">
      <h2>選択中のステータス</h2>
      <div class="body"><div id="stats" class="grid cols-2"></div></div>
    </section>
  </section>

  <!-- バトル -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">バトル</h2>
      <div class="body">
        <div class="arena">
          <!-- FX -->
          <div class="fx" id="fx"><div class="bang" id="fxText">必殺！</div></div>

          <!-- 対面 -->
          <div class="vsrow">
            <div id="leftWrap"></div>
            <div id="rightWrap"></div>
          </div>

          <!-- コマンド -->
          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG">✊ グー</button>
              <button class="rps c" id="handC">✌️ チョキ</button>
              <button class="rps p" id="handP">🖐 パー</button>
              <button class="switchBtn" id="btnSwitch">🔁 交代</button>
              <button class="spToggle" id="btnSP">✨ 必殺 OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <!-- カウントダウン -->
          <div class="timer"><span class="label">選択まで</span><span class="num" id="countNum">15</span><span class="label">秒</span></div>

          <!-- 6体ステータス -->
          <div id="sixStats"></div>

          <!-- トースト -->
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">バトル準備中</div>
          <button id="backSetup">編成に戻る</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- 交代モーダル -->
<div class="modal" id="switchModal">
  <div class="sheet">
    <h3 id="switchTitle">交代先を選択</h3>
    <div id="switchList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">キャンセル</button>
      <button style="background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225" id="doSwitch">交代する</button>
    </div>
  </div>
</div>

<script type="module">
(()=>{'use strict';
  if(window.__KB_V713__) return; window.__KB_V713__=true;

  /********** データ **********/
  const WORDS=[
    ["パラボラアンテナ","S","サイエンス","ぱらぼらあんてな"],
    ["ネスカフェアンバサダー","S","ヒューマン","ねすかふぇあんばさだー"],
    ["にんじんしりしり","A","フード","にんじんしりしり"],
    ["そぼろごはん","A","フード","そぼろごはん"],
    ["ニシローランドゴリラ","A","アニマル","にしろーらんどごりら"],
    ["毛むくじゃら","A","アニマル","けむくじゃら"],
    ["九品仏","A","ジオ","くほんぶつ"],
    ["けんちん汁","A","フード","けんちんじる"],
    ["カムチャッカ半島","B","ジオ","かむちゃっかはんとう"],
    ["タランチュラ","B","アニマル","たらんちゅら"],
    ["ハシビロコウ","B","アニマル","はしびろこう"],
    ["バルサミコ酢","B","フード","ばるさみこす"],
    ["ピロリ菌","B","サイエンス","ぴろりきん"],
    ["トリニダード・トバゴ","B","ジオ","とりにだーどとばご"],
    ["カラメル色素","B","サイエンス","からめるしきそ"],
    ["バビロン捕囚","C","ヒストリー","ばびろんほしゅう"],
    ["鳥取砂丘","C","ジオ","とっとりさきゅう"],
    ["プラシーボ効果","C","サイエンス","ぷらしーぼこうか"],
    ["渡来人","C","ヒューマン","とらいじん"],
    ["さるびあ丸","C","ジオ","さるびあまる"],
    ["ペペロンチーノ","C","フード","ぺぺろんちーの"],
    ["ポリプロピレン","C","サイエンス","ぽりぷろぴれん"],
    ["サラエボ事件","C","ヒストリー","さらえぼじけん"],
    ["クマンバチ","D","アニマル","くまんばち"],
    ["県庁所在地","D","ジオ","けんちょうしょざいち"],
    ["照り焼きチキン","D","フード","てりやきちきん"],
    ["ねるねるねるね","D","フード","ねるねるねるね"],
    ["スルメイカ","D","アニマル","するめいか"],
    ["本質","X","コンセプト","ほんしつ"],
    ["見える化","X","コンセプト","みえるか"],
    ["自分ごと化","X","コンセプト","じぶんごとか"],
    ["解像度","X","コンセプト","かいぞうど"],
  ];

  const BD_ASSIGN={
    B:{ "タランチュラ":"kotobagari","バルサミコ酢":"genron","トリニダード・トバゴ":"kotobagari","カムチャッカ半島":"genron","ハシビロコウ":"genron","ピロリ菌":"gestalt","カラメル色素":"gestalt" },
    C:{ "さるびあ丸":"kotobagari","サラエボ事件":"kotobagari","バビロン捕囚":"genron","ポリプロピレン":"genron","プラシーボ効果":"gestalt","ペペロンチーノ":"gestalt","鳥取砂丘":"mojibake","渡来人":"mojibake" },
    D:{ "クマンバチ":"genron","ねるねるねるね":"gestalt","スルメイカ":"gestalt","県庁所在地":"mojibake","照り焼きチキン":"mojibake" }
  };

  const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150};
  const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};
  const EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
  const BASE_POWER=100, GAUGE_NEEDED=6;

  const RING=["ヒストリー","ジオ","コンセプト","サイエンス","アニマル","ヒューマン","フード"];
  const TYPE_ADV = Object.fromEntries(RING.map((t,i)=>{
    const n=RING.length;
    const strong=[RING[(i+1)%n], RING[(i+2)%n]];
    const weak=[RING[(i-1+n)%n], RING[(i-2+n)%n]];
    return [t,{strong,weak}];
  }));

  const SPECIALS={
    "にんじんしりしり":{ id:"なんくるないさー", kind:"buff_endure", params:{atkMult:1.6} },
    "そぼろごはん":    { id:"そぼろ乱舞",       kind:"multi",       params:{hits:[0.75,0.5,0.25]} },
    "ニシローランドゴリラ":{ id:"マウンテンビート", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
    "毛むくじゃら":    { id:"ムクジャララ",     kind:"evasion",     params:{atkMult:1.4,evade:0.60,turns:3} },
    "九品仏":          { id:"仏の顔も三度まで", kind:"atk_def",     params:{atkMult:1.6,defMult:1.8,turns:3} },
    "けんちん汁":      { id:"長寿の秘訣",       kind:"atk_heal",    params:{atkMult:1.2,heal:150} },
    "パラボラアンテナ": { id:"妨害電波",         kind:"atk_drain",   params:{atkMult:2.5} },
    "ネスカフェアンバサダー":{ id:"一杯いかが",  kind:"heal_attack_all", params:{self:60,allies:60} },
  };
  const AIL={
    kotobagari:{name:"言葉狩り",icon:"🚫",apply:(st)=>{st.skipTurns=Math.max(st.skipTurns,1)},desc:"1T行動不可"},
    genron:{name:"言論統制",icon:"🔒",apply:(st)=>{st.genronTurns=Math.max(st.genronTurns,4)},desc:"4T交代不可"},
    gestalt:{name:"ゲシュタルト崩壊",icon:"🌀",apply:(st)=>{st.gestaltTurns=Math.max(st.gestaltTurns,4)},desc:"4T 1/3で自傷100"},
    mojibake:{name:"文字化け",icon:"☠️",apply:(st)=>{st.doomTurns=Math.max(st.doomTurns,3)},desc:"3T後に即死"}
  };

  /********** ユーティリティ **********/
  const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
  const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
  const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
  const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
  const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
  const visibleLength=(s)=>[...s].length;
  const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
  function hiraRatioForEvasion(name){ const letters=[...name].filter(isKanaOrKanji); if(!letters.length) return 0; const hira=letters.filter(isHira).length; return hira/letters.length; }
  function rKataForStructure(name){ const kata=[...name].filter(isKataLetter).length; const kan=[...name].filter(isKanji).length; const den=kata+kan; if(!den) return null; return kata/den; }
  function phoneticDensities(readingHira){
    const kata=[...hiraToKata(readingHira)].filter(isKataLetter);
    const L=kata.length||1;
    const smalls=new Set("ァィゥェォャュョヮ".split(""));
    const voiced=new Set("ガギグゲゴザジズゼゾダヂヅデドバビブベボパピプペポヴ".split(""));
    const last=kata[kata.length-1]||"";
    const plos=new Set("カキクケコサシスセソタチツテトパピプペポバビブベボ".split(""));
    const d=kata.filter(ch=>voiced.has(ch)).length/L;
    const s=kata.filter(ch=>'ッ'===ch).length/L;
    const m=kata.filter(ch=>smalls.has(ch)).length/L;
    const e=plos.has(last)?1:0;
    return {d,s,m,e};
  }

  /********** ステータス計算 **********/
  function calcStats(name, rank, type, readingHira){
    const T=visibleLength(name);
    let atk_struct,def_struct;{
      const r=rKataForStructure(name);
      if(r===null){ atk_struct=0.125; def_struct=0.125; } else { atk_struct=0.25*r; def_struct=0.25-atk_struct; }
    }
    let atk_phon,def_phon;{
      const {d,s,m,e}=phoneticDensities(readingHira);
      const Lw=0.05, Uw=0.45;
      const s_raw=0.6*d+0.25*(s+m)+0.15*e;
      const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);
      atk_phon=0.2*(0.5+0.5*s_ph); def_phon=0.2-atk_phon;
    }
    let atk_len,def_len;{
      const s_len=clamp((6-T)/6,-1,1);
      atk_len=0.2*(0.5+0.5*s_len); def_len=0.2-atk_len;
    }
    const atk_pct=0.175+atk_struct+atk_phon+atk_len;
    const def_pct=0.175+def_struct+def_phon+def_len;
    const P=P_RANK[rank];
    const ATK=Math.round(P*atk_pct);
    const DEF=Math.round(P*def_pct);
    const HP=HP_BASE[rank]+20*(T-5);
    let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];
    eva=clamp(eva,5,35);
    return {ATK,DEF,HP,Evasion:eva};
  }

  /********** バトル基盤 **********/
  const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};

  function createFighter([name,rank,type,reading]){
    const st=calcStats(name,rank,type,reading);
    return {name,rank,type,reading,base:st,hp:st.HP,gauge:0,atkMult:1,defMult:1,atkTurns:0,defTurns:0,evadeOverride:null,endure:false,skipTurns:0,gestaltTurns:0,doomTurns:0,genronTurns:0,_gorillaActive:false,_manualForce:false,_gFull:false};
  }

  function computeDamageDetailed(att,def,isSpecial,rng){
    if(!isSpecial){
      const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
      if(rng()<eva) return {dmg:0,miss:true,luck:'normal',matchup:'even'};
    }
    let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
    dmg*=att.atkMult;
    const tm=typeMult(att.type,def.type); dmg*=tm;
    const r=rng(); let luck='normal';
    if(r<0.2){ dmg*=1.2; luck='lucky'; } else if(r<0.4){ dmg*=0.8; luck='unlucky'; }
    const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
    return {dmg,miss:false,luck,matchup};
  }

  /********** トースト（1.5倍 & 順序保証） **********/
  const TOAST_MS = 4200; // 2800 * 1.5
  const toast = document.getElementById('toast');
  let queue=[], busy=false;
  function show(text, ms=TOAST_MS){ queue.push({text,ms}); if(!busy) nextToast(); }
  function nextToast(){ if(queue.length===0){ busy=false; return; } busy=true; const {text,ms}=queue.shift(); toast.textContent=text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(nextToast, 180); }, ms); }

  /********** ナレーション補助 **********/
  const handLabel=h=>h==='g'?'グー':(h==='c'?'チョキ':'パー');
  function narrRPS(my, cpu, res){
    const me=handLabel(my||'g'), op=handLabel(cpu);
    const result = res===-1?'あいこ':(res===0?'あなたの（勝ち）':'あなたの（負け）');
    show(`あなたは（${me}）。相手は（${op}）。${result}。`);
  }
  function narrAttackLine(attackerName, dmg, luck, matchup){
    const luckTxt = luck==='lucky'?'（ラッキー！）': luck==='unlucky'?'（アンラッキー…）':'';
    const muTxt   = matchup==='good'?' 相性抜群！': matchup==='bad'?' 相性はいまいち…':'';
    show(`${attackerName}の攻撃！${luckTxt} ${Math.round(dmg)}ダメージ！${muTxt}`);
  }

  /********** 必殺エフェクト **********/
  const fx=document.getElementById('fx'), fxText=document.getElementById('fxText');
  function playSpFx(title){ fxText.textContent=title; fx.classList.add('show'); setTimeout(()=>fx.classList.remove('show'), 900); }

  /********** ダメージ適用 **********/
  function dealAttack(actor,target,isSpecial,rng){
    if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; show(`${actor.name}は混乱！自傷100`); return {self:true, msg:`${actor.name}は混乱！自傷100`}; }
    const sp=SPECIALS[actor.name];
    if(isSpecial && sp && sp.kind==='multi'){
      const keep=actor.atkMult; let total=0, anyLucky=false, anyUnlucky=false, matchup='even';
      for(const s of sp.params.hits){
        actor.atkMult=keep*s;
        const info=computeDamageDetailed(actor,target,true,rng);
        total+=info.dmg;
        if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
        if(info.luck==='lucky') anyLucky=true; if(info.luck==='unlucky') anyUnlucky=true;
        
