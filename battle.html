<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLEï½œå¯¾æˆ¦ v7.3.0</title>
<style>
  :root{
    --bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;
    --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
    --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;--border:#1d2440;
    --badge:#ffcf33;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px}.sub{margin:4px 0 12px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}.ghost{background:transparent;border:1px dashed #2b3a70}

  /* ç·¨æˆï¼šç¸¦1ã‚«ãƒ©ãƒ ï¼‹ä¸‹ã«2åˆ—Ã—3æ®µã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
  #setup{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
  #statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #statsGrid .statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}

  .setupMini{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .setupMini .head{display:flex;justify-content:space-between;font-weight:700}
  .setupMini .nums{margin-top:4px;font-size:12px;color:#cfe2ff;display:grid;grid-template-columns:repeat(2,1fr);gap:4px}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}

  /* ãƒãƒˆãƒ«å…¨ç”»é¢ */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  .arena{position:relative;background:#0d1326;border-top:1px solid var(--border);padding:10px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;min-height:100vh}

  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:220px}
  .unit{border:1px solid #22325c;border-radius:12px;padding:10px;transition:transform .15s}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;color:#2a1700;background:var(--badge);padding:2px 8px;border-radius:999px;border:1px solid #b08b13}
  .skillLine{margin-top:6px;padding:8px;border:1px solid #2c3a69;border-radius:10px;background:#0c1633}
  .skillTitle{display:flex;align-items:center;gap:8px;font-weight:900}
  .skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}

  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%}
  .hpAnim{transition:width .60s ease} /* HP ã¯ã‚¢ãƒŠã‚¦ãƒ³ã‚¹å¾Œã«æ›´æ–° */

  .gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
  .gLabel{font-size:12px;color:#ffeaa7}
  .gauge{display:flex;gap:4px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:var(--gauge);opacity:1}
  .readyPulse{animation:pulse 1.2s infinite} @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}

  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  .pad{position:relative;display:grid;place-items:center;margin-top:6px}
  .padInner{position:relative;width:min(520px,90vw);height:220px}
  .rps{position:absolute;display:grid;place-items:center;width:88px;height:88px;border-radius:999px;border:none;color:#061225;font-size:18px}
  .rps.g{left:10%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
  .rps.c{right:10%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)}
  .switchBtn{position:absolute;right:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}

  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}

  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .miniCard.ally{outline:2px solid var(--ally)} .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:var(--hpBack);border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:var(--hp);width:0%}

  /* ãƒˆãƒ¼ã‚¹ãƒˆï¼šãƒãƒˆãƒ«æ™‚ã¯ä¸‹ã‹ã‚‰28vhã€è¢«ã‚‰ãªã„ä½ç½® */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(12px);padding:10px 14px;border-radius:12px;background:rgba(12,22,50,.95);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50;max-width:min(92vw,720px);line-height:1.6}
  body.battleMode .toast{bottom:28vh}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}

  /* ã‚¿ã‚¤ãƒ—è‰² */
  .t-ã‚¸ã‚ª{background:linear-gradient(180deg,#0f1730,#101f46)}
  .t-ã‚¢ãƒ‹ãƒãƒ«{background:linear-gradient(180deg,#0f1c30,#132c4f)}
  .t-ãƒ•ãƒ¼ãƒ‰{background:linear-gradient(180deg,#0f1a26,#1f2c46)}
  .t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ{background:linear-gradient(180deg,#12182e,#1b2544)}
  .t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹{background:linear-gradient(180deg,#0e1d2f,#0e2c48)}
  .t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼{background:linear-gradient(180deg,#12172a,#1b2142)}
  .t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³{background:linear-gradient(180deg,#121a28,#1e2941)}
</style>
</head>
<body>
<header><div class="container">
  <h1>å¯¾æˆ¦ v7.3.0</h1>
  <div class="sub">ä¸å¯§ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼æ®‹ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºï¼å¿…æ®ºãƒˆã‚°ãƒ«å³å¯†åŒ–ï¼HPå¾Œè¿½ã„ã‚¢ãƒ‹ãƒ¡</div>
</div></header>

<main class="container">
  <!-- ç·¨æˆ -->
  <section id="setup">
    <section class="card">
      <h2>ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
      <div class="body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">ã‚ãªãŸ</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="randBoth" class="ghost">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">å¯¾æˆ¦é–‹å§‹</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>é¸æŠä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <div class="body">
        <div id="statsGrid">
          <div class="statsCol" id="statsA"></div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </section>
  </section>

  <!-- ãƒãƒˆãƒ« -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">ãƒãƒˆãƒ«</h2>
      <div class="body">
        <div class="arena">
          <div class="fx" id="fx" style="display:none;place-items:center;position:fixed;inset:0;z-index:60">
            <div id="fxText" style="font-weight:900;font-size:36px;padding:18px 24px;border-radius:14px;background:rgba(255,207,51,.95);color:#2a1700;border:2px solid #b08b13;box-shadow:0 8px 40px rgba(255,207,51,.35)">å¿…æ®ºï¼</div>
          </div>
          <div class="vsrow"><div id="leftWrap"></div><div id="rightWrap"></div></div>

          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG">âœŠ ã‚°ãƒ¼</button>
              <button class="rps c" id="handC">âœŒï¸ ãƒãƒ§ã‚­</button>
              <button class="rps p" id="handP">ğŸ– ãƒ‘ãƒ¼</button>
              <button class="switchBtn" id="btnSwitch">ğŸ” äº¤ä»£</button>
              <button class="spToggle" id="btnSP">âœ¨ å¿…æ®º OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <div class="timer"><span class="label">é¸æŠã¾ã§</span><span class="num" id="countNum">15</span><span class="label">ç§’</span></div>
          <div id="sixStats"></div>
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">ãƒãƒˆãƒ«æº–å‚™ä¸­</div>
          <button id="backSetup">ç·¨æˆã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="switchModal" style="display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:30">
  <div class="sheet" style="background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;padding:12px">
    <h3 id="switchTitle" style="margin:0 0 8px;font-size:16px">äº¤ä»£å…ˆã‚’é¸æŠ</h3>
    <div id="switchList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button style="background:linear-gradient(90deg,#69d3ff,#2fb1ff);border:none;color:#061225" id="doSwitch">äº¤ä»£ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ================== ãƒ‡ãƒ¼ã‚¿ ================== */
const WORDS=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const BD_ASSIGN={B:{"ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"kotobagari","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"genron","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"kotobagari","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"genron","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"genron","ãƒ”ãƒ­ãƒªèŒ":"gestalt","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"gestalt"},C:{"ã•ã‚‹ã³ã‚ä¸¸":"kotobagari","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"kotobagari","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"genron","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"genron","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"gestalt","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"gestalt","é³¥å–ç ‚ä¸˜":"mojibake","æ¸¡æ¥äºº":"mojibake"},D:{"ã‚¯ãƒãƒ³ãƒãƒ":"genron","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"gestalt","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"gestalt","çœŒåºæ‰€åœ¨åœ°":"mojibake","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"mojibake"}};
const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150}, HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500}, EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
const BASE_POWER=100, GAUGE_NEEDED=6;
const RING=["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"];
const TYPE_ADV=Object.fromEntries(RING.map((t,i)=>{const n=RING.length;return [t,{strong:[RING[(i+1)%n],RING[(i+2)%n]],weak:[RING[(i-1+n)%n],RING[(i-2+n)%n]]}] }));

const SPECIALS={
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":{ id:"ãªã‚“ãã‚‹ãªã„ã•ãƒ¼", kind:"buff_endure", params:{atkMult:1.6} },
  "ãã¼ã‚ã”ã¯ã‚“":{ id:"ãã¼ã‚ä¹±èˆ", kind:"multi", params:{hits:[0.75,0.5,0.25]} },
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":{ id:"ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":{ id:"ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©", kind:"evasion", params:{atkMult:1.4,evade:0.60,turns:3} },
  "ä¹å“ä»":{ id:"ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§", kind:"atk_def", params:{atkMult:1.6,defMult:1.8,turns:3} },
  "ã‘ã‚“ã¡ã‚“æ±":{ id:"é•·å¯¿ã®ç§˜è¨£", kind:"atk_heal", params:{atkMult:1.2,heal:150} },
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":{ id:"å¦¨å®³é›»æ³¢", kind:"atk_drain", params:{atkMult:2.5} },
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":{ id:"ä¸€æ¯ã„ã‹ãŒ", kind:"heal_attack_all", params:{self:60,allies:60} },
};
const AIL={
  kotobagari:{name:"è¨€è‘‰ç‹©ã‚Š",icon:"ğŸš«",desc:"1ã‚¿ãƒ¼ãƒ³ã®é–“ã€è¡Œå‹•ã§ããªããªã‚‹ã€‚"},
  genron:{name:"è¨€è«–çµ±åˆ¶",icon:"ğŸ”’",desc:"ä¸€å®šã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£ã§ããªããªã‚‹ã€‚"},
  gestalt:{name:"ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š",icon:"ğŸŒ€",desc:"ä¸€å®šã‚¿ãƒ¼ãƒ³ã®é–“ã€æ”»æ’ƒã®ãŸã³ã«1/3ã§è‡ªåˆ†ã«100ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"},
  mojibake:{name:"æ–‡å­—åŒ–ã‘",icon:"â˜ ï¸",desc:"3ã‚¿ãƒ¼ãƒ³å¾Œã«æ°—çµ¶ã™ã‚‹ã€‚äº¤ä»£ã§è§£é™¤ã§ãã‚‹ã€‚"}
};
const AIL_TURNS={kotobagari:1,genron:4,gestalt:4,mojibake:3};

/* ===== util ===== */
const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
const visibleLength=(s)=>[...s].length;
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));

/* ===== ã‚¹ãƒ†ç®— ===== */
function hiraRatioForEvasion(name){const letters=[...name].filter(isKanaOrKanji);if(!letters.length) return 0;const hira=letters.filter(isHira).length;return hira/letters.length;}
function rKataForStructure(name){const kata=[...name].filter(isKataLetter).length;const kan=[...name].filter(isKanji).length;const den=kata+kan;if(!den) return null;return kata/den;}
function phoneticDensities(readingHira){const kata=[...hiraToKata(readingHira)].filter(isKataLetter);const L=kata.length||1;const smalls=new Set("ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®".split(""));const voiced=new Set("ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒãƒ´".split(""));const last=kata[kata.length-1]||"";const plos=new Set("ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ‘ãƒ”ãƒ—ãƒšãƒãƒãƒ“ãƒ–ãƒ™ãƒœ".split(""));const d=kata.filter(ch=>voiced.has(ch)).length/L;const s=kata.filter(ch=>'ãƒƒ'===ch).length/L;const m=kata.filter(ch=>smalls.has(ch)).length/L;const e=plos.has(last)?1:0;return {d,s,m,e};}
function calcStats(name, rank, type, readingHira){
  const T=visibleLength(name);
  // æ§‹æˆ25%
  let atk_struct,def_struct;{const r=rKataForStructure(name);if(r===null){atk_struct=0.125;def_struct=0.125;}else{atk_struct=0.25*r;def_struct=0.25-atk_struct;}}
  // éŸ³20%
  let atk_phon,def_phon;{const {d,s,m,e}=phoneticDensities(readingHira);const Lw=0.05, Uw=0.45;const s_raw=0.6*d+0.25*(s+m)+0.15(e);const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);atk_phon=0.2*(0.5+0.5*s_ph);def_phon=0.2-atk_phon;}
  // é•·ã•20%
  let atk_len,def_len;{const s_len=clamp((6-T)/6,-1,1);atk_len=0.2*(0.5+0.5*s_len);def_len=0.2-atk_len;}
  const atk_pct=0.175+atk_struct+atk_phon+atk_len, def_pct=0.175+def_struct+def_phon+def_len;
  const P=P_RANK[rank], ATK=Math.round(P*atk_pct), DEF=Math.round(P*def_pct);
  const HP=HP_BASE[rank]+20*(T-5);
  let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];eva=clamp(eva,5,35);
  return {ATK,DEF,HP,Evasion:eva};
}
const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};

/* ===== FX / ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå®Œäº†æ¤œçŸ¥ï¼‰ ===== */
const toast=document.getElementById('toast'); let queue=[],busy=false,afterEmpty=[];
function show(text,ms=4800){ queue.push({text,ms}); if(!busy) nextToast(); }
function nextToast(){ if(queue.length===0){ busy=false; const q=afterEmpty.splice(0); q.forEach(fn=>fn()); return; } busy=true; const {text,ms}=queue.shift(); toast.textContent=text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(nextToast,200); }, ms); }
function runAfterAnnouncements(fn){ if(busy||queue.length){ afterEmpty.push(fn); } else { fn(); } }

const fx=document.getElementById('fx'), fxText=document.getElementById('fxText');
function playSpFx(title){ fxText.textContent=title; fx.style.display='grid'; setTimeout(()=>fx.style.display='none', 900); }

/* ===== æ”»æ’ƒ/è¨ˆç®— ===== */
function computeDamageDetailed(att,def,isSpecial,rng){
  if(!isSpecial){
    const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
    if(rng()<eva) return {dmg:0,miss:true,matchup:'even'};
  }
  let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
  dmg*=att.atkMult; const tm=typeMult(att.type,def.type); dmg*=tm;
  const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
  return {dmg,miss:false,matchup};
}
function narrRPS(my,cpu,res){
  const lab=h=>h==='g'?'ã‚°ãƒ¼':(h==='c'?'ãƒãƒ§ã‚­':'ãƒ‘ãƒ¼');
  if(res===-1){ show(`ã‚ã„ã“ã€‚`); return; }
  const result = res===0?'ã‚ãªãŸã®å‹ã¡ã€‚':'ã‚ãªãŸã®è² ã‘ã€‚';
  show(`ã‚ãªãŸã¯${lab(my||'g')}ã€‚ç›¸æ‰‹ã¯${lab(cpu)}ã€‚${result}`);
}
function narrAttackLine(attackerName,dmg,matchup){
  const muTxt   = matchup==='good'?' ç›¸æ€§æŠœç¾¤ï¼': matchup==='bad'?' ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':'';
  show(`${attackerName}ã®æ”»æ’ƒï¼ ${Math.round(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${muTxt}`);
}
function dealAttack(actor,target,isSpecial,rng){
  // ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆè‡ªå‚·ï¼ˆå‘½ä¸­å‰ã«ãƒã‚§ãƒƒã‚¯ï¼‰
  if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; show(`${actor.name}ã¯æ··ä¹±ï¼ è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸`); return {self:true}; }
  const sp=SPECIALS[actor.name];
  if(isSpecial && sp && sp.kind==='multi'){
    const keep=actor.atkMult; let total=0, MU='even';
    for(const s of sp.params.hits){
      actor.atkMult=keep*s;
      const info=computeDamageDetailed(actor,target,true,rng);
      total+=info.dmg;
      if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
      if(info.matchup==='good') MU='good'; else if(info.matchup==='bad' && MU!=='good') MU='bad';
      if(target.hp<=0) break;
    }
    actor.atkMult=keep; return {dmg:total,matchup:MU};
  } else {
    const info=computeDamageDetailed(actor,target,isSpecial,rng);
    if(info.miss){ show(`${actor.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`); return {dmg:0,miss:true}; }
    if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
    return info;
  }
}

/* ===== ã‚¿ãƒ¼ãƒ³ç®¡ç†ï¼çŠ¶æ…‹ç•°å¸¸ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º ===== */
function endOfTick(f,tag=''){
  const msgs=[];
  if(f.atkTurns>0 && --f.atkTurns===0) f.atkMult=1;
  if(f.defTurns>0 && --f.defTurns===0) f.defMult=1;
  if(f.evadeOverride && --f.evadeOverride.turns<=0) f.evadeOverride=null;
  if(f.skipTurns>0){ f.skipTurns--; if(f.skipTurns>0) msgs.push(`è¨€è‘‰ç‹©ã‚Š æ®‹ã‚Š${f.skipTurns}ã‚¿ãƒ¼ãƒ³`); }
  if(f.gestaltTurns>0){ f.gestaltTurns--; if(f.gestaltTurns>0) msgs.push(`ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š æ®‹ã‚Š${f.gestaltTurns}ã‚¿ãƒ¼ãƒ³`); }
  if(f.genronTurns>0){ f.genronTurns--; if(f.genronTurns>0) msgs.push(`è¨€è«–çµ±åˆ¶ æ®‹ã‚Š${f.genronTurns}ã‚¿ãƒ¼ãƒ³`); }
  if(f.doomTurns>0){ f.doomTurns--; if(f.doomTurns>0) msgs.push(`æ–‡å­—åŒ–ã‘ æ®‹ã‚Š${f.doomTurns}ã‚¿ãƒ¼ãƒ³`); else f.hp=0; }
  m
