<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLE｜対戦 v7.3.0</title>
<style>
  :root{
    --bg:#0b1020;--panel:#101833;--panel2:#0c1530;--muted:#8fa2d1;--text:#e8f0ff;
    --ally:#69d3ff;--ally2:#2fb1ff;--enemy:#ff9aa5;--enemy2:#ff6b7a;
    --hp:#6bff8b;--hpBack:#12321f;--gauge:#ffe066;--gaugeBack:#342b0b;--border:#1d2440;
    --badge:#ffcf33;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px}.sub{margin:4px 0 12px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,select{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;font-weight:700}.ghost{background:transparent;border:1px dashed #2b3a70}

  /* 編成：縦1カラム＋下に2列×3段ステータス */
  #setup{display:grid;grid-template-columns:1fr;gap:16px;margin-top:8px}
  #statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #statsGrid .statsCol{display:grid;grid-template-rows:repeat(3,auto);gap:10px}

  .setupMini{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .setupMini .head{display:flex;justify-content:space-between;font-weight:700}
  .setupMini .nums{margin-top:4px;font-size:12px;color:#cfe2ff;display:grid;grid-template-columns:repeat(2,1fr);gap:4px}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}

  /* バトル全画面 */
  .hidden{display:none!important}
  body.battleMode{height:100vh;overflow:hidden}
  body.battleMode header{display:none}
  body.battleMode main.container{max-width:none;padding:0!important}
  body.battleMode #setup{display:none!important}
  body.battleMode #battle{display:block!important}
  body.battleMode #battle .card{background:transparent;border:none;border-radius:0;box-shadow:none}
  .arena{position:relative;background:#0d1326;border-top:1px solid var(--border);padding:10px;display:grid;grid-template-rows:auto 1fr auto auto auto;gap:10px;min-height:100vh}

  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start;min-height:220px}
  .unit{border:1px solid #22325c;border-radius:12px;padding:10px;transition:transform .15s}
  .unit.ally{box-shadow:0 0 0 2px var(--ally) inset}
  .unit.enemy{box-shadow:0 0 0 2px var(--enemy) inset}
  .nameRow{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .name{font-weight:800}.tag{font-size:11px;color:#c7d7ff}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;color:#2a1700;background:var(--badge);padding:2px 8px;border-radius:999px;border:1px solid #b08b13}
  .skillLine{margin-top:6px;padding:8px;border:1px solid #2c3a69;border-radius:10px;background:#0c1633}
  .skillTitle{display:flex;align-items:center;gap:8px;font-weight:900}
  .skillDesc{margin-top:4px;font-size:12px;color:#cfe2ff}

  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative;margin-top:4px}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%}
  .hpAnim{transition:width .60s ease} /* HP はアナウンス後に更新 */

  .gaugeWrap{display:flex;align-items:center;gap:8px;margin-top:6px}
  .gLabel{font-size:12px;color:#ffeaa7}
  .gauge{display:flex;gap:4px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
  .pip.on{background:var(--gauge);opacity:1}
  .readyPulse{animation:pulse 1.2s infinite} @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.5)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}

  .meta{margin-top:6px;font-size:12px;color:#cfe2ff}
  .meta .line{display:flex;justify-content:space-between;gap:6px}

  .pad{position:relative;display:grid;place-items:center;margin-top:6px}
  .padInner{position:relative;width:min(520px,90vw);height:220px}
  .rps{position:absolute;display:grid;place-items:center;width:88px;height:88px;border-radius:999px;border:none;color:#061225;font-size:18px}
  .rps.g{left:10%;top:8%;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
  .rps.c{right:10%;top:8%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
  .rps.p{left:50%;transform:translateX(-50%);bottom:26%;background:linear-gradient(180deg,#defae5,#8bffb5)}
  .switchBtn{position:absolute;right:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b;font-weight:900}
  .spToggle{position:absolute;left:4%;bottom:6%;width:128px;height:56px;border-radius:14px;background:#0e1530;border:2px solid #f2c94c;color:#f2c94c;font-weight:900;transition:.2s}
  .spToggle.on{background:linear-gradient(90deg,#ffe066,#ffcf33)!important;color:#2a1700!important;border-color:#ffcf33!important}

  .benchBar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}

  .timer{display:flex;gap:8px;justify-content:center;align-items:center;font-weight:800}
  .timer .num{font-size:22px;padding:4px 10px;border-radius:10px;background:#0b1833;border:1px solid #243159}
  .timer .label{font-size:12px;color:#bcd}

  #sixStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .miniCard{border:1px solid #1a2b54;border-radius:10px;padding:8px}
  .miniCard.ally{outline:2px solid var(--ally)} .miniCard.enemy{outline:2px solid var(--enemy)}
  .miniHead{display:flex;justify-content:space-between;font-weight:700}
  .miniBar{height:8px;background:var(--hpBack);border-radius:6px;overflow:hidden;margin-top:4px}
  .miniBar>span{display:block;height:100%;background:var(--hp);width:0%}

  /* トースト：バトル時は下から28vh、被らない位置 */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(12px);padding:10px 14px;border-radius:12px;background:rgba(12,22,50,.95);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;pointer-events:none;z-index:50;max-width:min(92vw,720px);line-height:1.6}
  body.battleMode .toast{bottom:28vh}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);transition:.22s ease}

  /* タイプ色 */
  .t-ジオ{background:linear-gradient(180deg,#0f1730,#101f46)}
  .t-アニマル{background:linear-gradient(180deg,#0f1c30,#132c4f)}
  .t-フード{background:linear-gradient(180deg,#0f1a26,#1f2c46)}
  .t-コンセプト{background:linear-gradient(180deg,#12182e,#1b2544)}
  .t-サイエンス{background:linear-gradient(180deg,#0e1d2f,#0e2c48)}
  .t-ヒストリー{background:linear-gradient(180deg,#12172a,#1b2142)}
  .t-ヒューマン{background:linear-gradient(180deg,#121a28,#1e2941)}
</style>
</head>
<body>
<header><div class="container">
  <h1>対戦 v7.3.0</h1>
  <div class="sub">丁寧アナウンス／残ターン表示／必殺トグル厳密化／HP後追いアニメ</div>
</div></header>

<main class="container">
  <!-- 編成 -->
  <section id="setup">
    <section class="card">
      <h2>チーム編成（あなた / CPU）</h2>
      <div class="body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--ally)">あなた</strong></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong style="color:var(--enemy)">CPU</strong></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="randBoth" class="ghost">ランダムでチームを編成</button>
          <button id="toBattle" style="margin-left:auto;background:linear-gradient(90deg,var(--ally),var(--ally2));border:none;color:#061225">対戦開始</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>選択中のステータス</h2>
      <div class="body">
        <div id="statsGrid">
          <div class="statsCol" id="statsA"></div>
          <div class="statsCol" id="statsB"></div>
        </div>
      </div>
    </section>
  </section>

  <!-- バトル -->
  <section id="battle" class="hidden" style="display:none">
    <section class="card"><h2 style="display:none">バトル</h2>
      <div class="body">
        <div class="arena">
          <div class="fx" id="fx" style="display:none;place-items:center;position:fixed;inset:0;z-index:60">
            <div id="fxText" style="font-weight:900;font-size:36px;padding:18px 24px;border-radius:14px;background:rgba(255,207,51,.95);color:#2a1700;border:2px solid #b08b13;box-shadow:0 8px 40px rgba(255,207,51,.35)">必殺！</div>
          </div>
          <div class="vsrow"><div id="leftWrap"></div><div id="rightWrap"></div></div>

          <div class="pad">
            <div class="padInner">
              <button class="rps g" id="handG">✊ グー</button>
              <button class="rps c" id="handC">✌️ チョキ</button>
              <button class="rps p" id="handP">🖐 パー</button>
              <button class="switchBtn" id="btnSwitch">🔁 交代</button>
              <button class="spToggle" id="btnSP">✨ 必殺 OFF</button>
            </div>
            <div class="benchBar" id="benchBar"></div>
          </div>

          <div class="timer"><span class="label">選択まで</span><span class="num" id="countNum">15</span><span class="label">秒</span></div>
          <div id="sixStats"></div>
          <div class="toast" id="toast">...</div>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div id="summary" class="small muted">バトル準備中</div>
          <button id="backSetup">編成に戻る</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- 交代モーダル -->
<div class="modal" id="switchModal" style="display:none;place-items:center;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:30">
  <div class="sheet" style="background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:320px;padding:12px">
    <h3 id="switchTitle" style="margin:0 0 8px;font-size:16px">交代先を選択</h3>
    <div id="switchList"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="cancelSwitch">キャンセル</button>
      <button style="background:linear-gradient(90deg,#69d3ff,#2fb1ff);border:none;color:#061225" id="doSwitch">交代する</button>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ================== データ ================== */
const WORDS=[["パラボラアンテナ","S","サイエンス","ぱらぼらあんてな"],["ネスカフェアンバサダー","S","ヒューマン","ねすかふぇあんばさだー"],["にんじんしりしり","A","フード","にんじんしりしり"],["そぼろごはん","A","フード","そぼろごはん"],["ニシローランドゴリラ","A","アニマル","にしろーらんどごりら"],["毛むくじゃら","A","アニマル","けむくじゃら"],["九品仏","A","ジオ","くほんぶつ"],["けんちん汁","A","フード","けんちんじる"],["カムチャッカ半島","B","ジオ","かむちゃっかはんとう"],["タランチュラ","B","アニマル","たらんちゅら"],["ハシビロコウ","B","アニマル","はしびろこう"],["バルサミコ酢","B","フード","ばるさみこす"],["ピロリ菌","B","サイエンス","ぴろりきん"],["トリニダード・トバゴ","B","ジオ","とりにだーどとばご"],["カラメル色素","B","サイエンス","からめるしきそ"],["バビロン捕囚","C","ヒストリー","ばびろんほしゅう"],["鳥取砂丘","C","ジオ","とっとりさきゅう"],["プラシーボ効果","C","サイエンス","ぷらしーぼこうか"],["渡来人","C","ヒューマン","とらいじん"],["さるびあ丸","C","ジオ","さるびあまる"],["ペペロンチーノ","C","フード","ぺぺろんちーの"],["ポリプロピレン","C","サイエンス","ぽりぷろぴれん"],["サラエボ事件","C","ヒストリー","さらえぼじけん"],["クマンバチ","D","アニマル","くまんばち"],["県庁所在地","D","ジオ","けんちょうしょざいち"],["照り焼きチキン","D","フード","てりやきちきん"],["ねるねるねるね","D","フード","ねるねるねるね"],["スルメイカ","D","アニマル","するめいか"],["本質","X","コンセプト","ほんしつ"],["見える化","X","コンセプト","みえるか"],["自分ごと化","X","コンセプト","じぶんごとか"],["解像度","X","コンセプト","かいぞうど"]];
const BD_ASSIGN={B:{"タランチュラ":"kotobagari","バルサミコ酢":"genron","トリニダード・トバゴ":"kotobagari","カムチャッカ半島":"genron","ハシビロコウ":"genron","ピロリ菌":"gestalt","カラメル色素":"gestalt"},C:{"さるびあ丸":"kotobagari","サラエボ事件":"kotobagari","バビロン捕囚":"genron","ポリプロピレン":"genron","プラシーボ効果":"gestalt","ペペロンチーノ":"gestalt","鳥取砂丘":"mojibake","渡来人":"mojibake"},D:{"クマンバチ":"genron","ねるねるねるね":"gestalt","スルメイカ":"gestalt","県庁所在地":"mojibake","照り焼きチキン":"mojibake"}};
const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150}, HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500}, EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
const BASE_POWER=100, GAUGE_NEEDED=6;
const RING=["ヒストリー","ジオ","コンセプト","サイエンス","アニマル","ヒューマン","フード"];
const TYPE_ADV=Object.fromEntries(RING.map((t,i)=>{const n=RING.length;return [t,{strong:[RING[(i+1)%n],RING[(i+2)%n]],weak:[RING[(i-1+n)%n],RING[(i-2+n)%n]]}] }));

const SPECIALS={
  "にんじんしりしり":{ id:"なんくるないさー", kind:"buff_endure", params:{atkMult:1.6} },
  "そぼろごはん":{ id:"そぼろ乱舞", kind:"multi", params:{hits:[0.75,0.5,0.25]} },
  "ニシローランドゴリラ":{ id:"マウンテンビート", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
  "毛むくじゃら":{ id:"ムクジャララ", kind:"evasion", params:{atkMult:1.4,evade:0.60,turns:3} },
  "九品仏":{ id:"仏の顔も三度まで", kind:"atk_def", params:{atkMult:1.6,defMult:1.8,turns:3} },
  "けんちん汁":{ id:"長寿の秘訣", kind:"atk_heal", params:{atkMult:1.2,heal:150} },
  "パラボラアンテナ":{ id:"妨害電波", kind:"atk_drain", params:{atkMult:2.5} },
  "ネスカフェアンバサダー":{ id:"一杯いかが", kind:"heal_attack_all", params:{self:60,allies:60} },
};
const AIL={
  kotobagari:{name:"言葉狩り",icon:"🚫",desc:"1ターンの間、行動できなくなる。"},
  genron:{name:"言論統制",icon:"🔒",desc:"一定ターンの間、交代できなくなる。"},
  gestalt:{name:"ゲシュタルト崩壊",icon:"🌀",desc:"一定ターンの間、攻撃のたびに1/3で自分に100のダメージ。"},
  mojibake:{name:"文字化け",icon:"☠️",desc:"3ターン後に気絶する。交代で解除できる。"}
};
const AIL_TURNS={kotobagari:1,genron:4,gestalt:4,mojibake:3};

/* ===== util ===== */
const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
const visibleLength=(s)=>[...s].length;
const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));

/* ===== ステ算 ===== */
function hiraRatioForEvasion(name){const letters=[...name].filter(isKanaOrKanji);if(!letters.length) return 0;const hira=letters.filter(isHira).length;return hira/letters.length;}
function rKataForStructure(name){const kata=[...name].filter(isKataLetter).length;const kan=[...name].filter(isKanji).length;const den=kata+kan;if(!den) return null;return kata/den;}
function phoneticDensities(readingHira){const kata=[...hiraToKata(readingHira)].filter(isKataLetter);const L=kata.length||1;const smalls=new Set("ァィゥェォャュョヮ".split(""));const voiced=new Set("ガギグゲゴザジズゼゾダヂヅデドバビブベボパピプペポヴ".split(""));const last=kata[kata.length-1]||"";const plos=new Set("カキクケコサシスセソタチツテトパピプペポバビブベボ".split(""));const d=kata.filter(ch=>voiced.has(ch)).length/L;const s=kata.filter(ch=>'ッ'===ch).length/L;const m=kata.filter(ch=>smalls.has(ch)).length/L;const e=plos.has(last)?1:0;return {d,s,m,e};}
function calcStats(name, rank, type, readingHira){
  const T=visibleLength(name);
  // 構成25%
  let atk_struct,def_struct;{const r=rKataForStructure(name);if(r===null){atk_struct=0.125;def_struct=0.125;}else{atk_struct=0.25*r;def_struct=0.25-atk_struct;}}
  // 音20%
  let atk_phon,def_phon;{const {d,s,m,e}=phoneticDensities(readingHira);const Lw=0.05, Uw=0.45;const s_raw=0.6*d+0.25*(s+m)+0.15(e);const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);atk_phon=0.2*(0.5+0.5*s_ph);def_phon=0.2-atk_phon;}
  // 長さ20%
  let atk_len,def_len;{const s_len=clamp((6-T)/6,-1,1);atk_len=0.2*(0.5+0.5*s_len);def_len=0.2-atk_len;}
  const atk_pct=0.175+atk_struct+atk_phon+atk_len, def_pct=0.175+def_struct+def_phon+def_len;
  const P=P_RANK[rank], ATK=Math.round(P*atk_pct), DEF=Math.round(P*def_pct);
  const HP=HP_BASE[rank]+20*(T-5);
  let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];eva=clamp(eva,5,35);
  return {ATK,DEF,HP,Evasion:eva};
}
const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};

/* ===== FX / トースト（完了検知） ===== */
const toast=document.getElementById('toast'); let queue=[],busy=false,afterEmpty=[];
function show(text,ms=4800){ queue.push({text,ms}); if(!busy) nextToast(); }
function nextToast(){ if(queue.length===0){ busy=false; const q=afterEmpty.splice(0); q.forEach(fn=>fn()); return; } busy=true; const {text,ms}=queue.shift(); toast.textContent=text; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(nextToast,200); }, ms); }
function runAfterAnnouncements(fn){ if(busy||queue.length){ afterEmpty.push(fn); } else { fn(); } }

const fx=document.getElementById('fx'), fxText=document.getElementById('fxText');
function playSpFx(title){ fxText.textContent=title; fx.style.display='grid'; setTimeout(()=>fx.style.display='none', 900); }

/* ===== 攻撃/計算 ===== */
function computeDamageDetailed(att,def,isSpecial,rng){
  if(!isSpecial){
    const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
    if(rng()<eva) return {dmg:0,miss:true,matchup:'even'};
  }
  let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
  dmg*=att.atkMult; const tm=typeMult(att.type,def.type); dmg*=tm;
  const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
  return {dmg,miss:false,matchup};
}
function narrRPS(my,cpu,res){
  const lab=h=>h==='g'?'グー':(h==='c'?'チョキ':'パー');
  if(res===-1){ show(`あいこ。`); return; }
  const result = res===0?'あなたの勝ち。':'あなたの負け。';
  show(`あなたは${lab(my||'g')}。相手は${lab(cpu)}。${result}`);
}
function narrAttackLine(attackerName,dmg,matchup){
  const muTxt   = matchup==='good'?' 相性抜群！': matchup==='bad'?' 相性はいまいち…':'';
  show(`${attackerName}の攻撃！ ${Math.round(dmg)}ダメージ！${muTxt}`);
}
function dealAttack(actor,target,isSpecial,rng){
  // ゲシュタルト自傷（命中前にチェック）
  if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; show(`${actor.name}は混乱！ 自分に100ダメージ`); return {self:true}; }
  const sp=SPECIALS[actor.name];
  if(isSpecial && sp && sp.kind==='multi'){
    const keep=actor.atkMult; let total=0, MU='even';
    for(const s of sp.params.hits){
      actor.atkMult=keep*s;
      const info=computeDamageDetailed(actor,target,true,rng);
      total+=info.dmg;
      if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
      if(info.matchup==='good') MU='good'; else if(info.matchup==='bad' && MU!=='good') MU='bad';
      if(target.hp<=0) break;
    }
    actor.atkMult=keep; return {dmg:total,matchup:MU};
  } else {
    const info=computeDamageDetailed(actor,target,isSpecial,rng);
    if(info.miss){ show(`${actor.name}の攻撃は外れた！`); return {dmg:0,miss:true}; }
    if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; } else target.hp-=info.dmg;
    return info;
  }
}

/* ===== ターン管理／状態異常カウント表示 ===== */
function endOfTick(f,tag=''){
  const msgs=[];
  if(f.atkTurns>0 && --f.atkTurns===0) f.atkMult=1;
  if(f.defTurns>0 && --f.defTurns===0) f.defMult=1;
  if(f.evadeOverride && --f.evadeOverride.turns<=0) f.evadeOverride=null;
  if(f.skipTurns>0){ f.skipTurns--; if(f.skipTurns>0) msgs.push(`言葉狩り 残り${f.skipTurns}ターン`); }
  if(f.gestaltTurns>0){ f.gestaltTurns--; if(f.gestaltTurns>0) msgs.push(`ゲシュタルト崩壊 残り${f.gestaltTurns}ターン`); }
  if(f.genronTurns>0){ f.genronTurns--; if(f.genronTurns>0) msgs.push(`言論統制 残り${f.genronTurns}ターン`); }
  if(f.doomTurns>0){ f.doomTurns--; if(f.doomTurns>0) msgs.push(`文字化け 残り${f.doomTurns}ターン`); else f.hp=0; }
  m
