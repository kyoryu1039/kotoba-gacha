<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOTOBA-BATTLEï½œå¯¾æˆ¦ v5ï¼ˆãƒã‚±ãƒ¢ãƒ³é¢¨UIï¼‰</title>
<style>
  :root{
    --bg:#0b1020;--panel:#121a32;--panel2:#0e1530;--muted:#8fa2d1;--text:#e8f0ff;
    --accent:#5ee1ff;--accent2:#9b8cff;--hp:#6bff8b;--hpBack:#12321f;--gauge:#5ee1ff;--gaugeBack:#0b2430;
    --danger:#ff6b6b;--ok:#6bff8b;--border:#1d2440
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:linear-gradient(180deg,#0b1020,#0b1227);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:rgba(11,16,32,.85);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:8px 0 0;font-size:28px} .sub{margin:4px 0 12px;color:var(--muted)}
  .grid{display:grid;gap:16px} .cols-2{grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:18px}
  .card .body{padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{justify-content:flex-end}
  label{font-size:12px;color:var(--muted)}
  select,button,input{appearance:none;background:#0e1530;border:1px solid #243159;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  button{cursor:pointer;user-select:none}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#07121e;font-weight:700}
  button.ghost{background:transparent;border:1px dashed #2b3a70}
  .pill{border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #2b3a70;color:#bcd}
  .team{display:grid;gap:8px}.slot{display:flex;gap:8px;align-items:center}.slot select{flex:1}
  .small{font-size:12px}.muted{color:var(--muted)} .space{height:8px}
  .divider{height:1px;background:#1d2440;margin:12px 0}
  footer{color:#9fb0d8;padding:20px 16px;text-align:center}

  /* BATTLE HUD */
  #battle.hidden{display:none}
  .arena{position:relative;background:#0d1326;border:1px solid var(--border);border-radius:14px;padding:12px;min-height:70vh;display:grid;grid-template-rows:auto 1fr auto auto;gap:8px}
  .centerTop{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
  .chip{border:1px solid #2b3a70;border-radius:999px;padding:6px 10px;font-size:12px;background:#0a1430}
  .chip.btn{cursor:pointer}
  .vsrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
  .unit{background:var(--panel2);border:1px solid #22325c;border-radius:12px;padding:10px}
  .unit.active{outline:2px solid var(--accent)}
  .nameRow{display:flex;justify-content:space-between;gap:8px}
  .name{font-weight:700}.tag{font-size:11px;color:#c7d7ff}
  .bar{height:12px;background:var(--hpBack);border-radius:8px;overflow:hidden;position:relative}
  .bar>span{display:block;height:100%;background:var(--hp);width:0%;transition:width .25s}
  .gauge{display:flex;gap:4px;margin-top:6px}
  .pip{width:14px;height:12px;background:var(--gaugeBack);border:1px solid #2b4b66;border-radius:3px}
  .pip.on{background:var(--gauge)}
  .status{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .st{font-size:12px;padding:2px 6px;border:1px solid #2b3a70;border-radius:999px;background:#0a1430}
  .bench{display:grid;grid-template-columns:1fr;gap:8px}
  .bench .mini{background:#0b1227;border:1px solid #1a2b54;border-radius:10px;padding:8px;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;opacity:.9}
  .mini .bar{height:8px}

  /* Command bar */
  .cmd{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:6px}
  .btnCmd{min-width:72px;padding:12px 14px;border-radius:12px;border:1px solid #29406e;background:#0f1a36;font-size:14px}
  .btnCmd.on{outline:2px solid var(--accent)}
  .btnWide{min-width:140px}
  #benchBar{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .benchChip{display:flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2b3a70;background:#0b1833;border-radius:999px;font-size:12px}
  .benchChip .type{color:#bcd}
  .benchChip .ratio{color:#9fe3ff;font-variant-numeric:tabular-nums}

  /* Toast/FX */
  .toast{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(8,14,32,.9);border:1px solid #2b3a70;border-radius:12px;padding:10px 14px;font-weight:700;opacity:0;pointer-events:none;transition:opacity .2s;max-width:min(90vw,520px);text-align:center}
  .toast.show{opacity:1}

  .hint{font-size:12px;color:var(--muted);text-align:center}

  /* Switch modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:30}
  .sheet{background:#0f1430;border:1px solid var(--border);border-radius:14px;min-width:280px;padding:12px}
  .sheet h3{margin:0 0 8px;font-size:16px}
  .opt{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid #213a6d;background:#0b1833;border-radius:10px;padding:8px;margin:6px 0}
  .opt.disabled{opacity:.35;pointer-events:none}

  /* å¿…æ®ºReadyãƒ‘ãƒ«ã‚¹ */
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255,208,0,.55); }
    70%{ box-shadow: 0 0 0 14px rgba(255,208,0,0); }
    100%{ box-shadow: 0 0 0 0 rgba(255,208,0,0); }
  }
  .btnCmd.ready{animation:pulse 1.2s infinite;border-color:#f2c94c}
</style>
</head>
<body>
<header><div class="container">
  <h1>å¯¾æˆ¦ v5</h1>
  <div class="sub">KOTOBA-BATTLEï½œç·¨æˆâ†’ãƒãƒˆãƒ«ï¼æ¼”å‡ºå¼·åŒ–ï¼ç›¸æ€§ãƒ»å¿…æ®ºãƒ»äº¤ä»£UIï¼ˆ2025-08-12ä»•æ§˜ï¼‰</div>
</div></header>

<main class="container" id="app">
  <!-- SETUP -->
  <section id="setup" class="grid cols-2">
    <section class="card">
      <h2>ãƒãƒ¼ãƒ ç·¨æˆ</h2>
      <div class="body">
        <div class="grid cols-2">
          <div>
            <div class="row" style="justify-content:space-between"><strong>ã‚ãªãŸ</strong><button class="ghost" id="randA">ãƒ©ãƒ³ãƒ€ãƒ </button></div>
            <div class="team" id="teamA"></div>
          </div>
          <div>
            <div class="row" style="justify-content:space-between"><strong>CPU</strong><button class="ghost" id="randB">ãƒ©ãƒ³ãƒ€ãƒ </button></div>
            <div class="team" id="teamB"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row right">
          <label>è©¦åˆæ•°</label><input type="number" id="nMatches" min="1" max="2000" step="1" value="1" />
          <label>Seed</label><input type="number" id="seed" value="20250812" />
        </div>
        <div class="row">
          <button class="primary" id="toBattle">ãƒãƒˆãƒ«ã¸</button>
          <button id="demo">ãƒ‡ãƒ¢ç·¨æˆ</button>
        </div>
        <div class="space"></div>
        <div class="small muted">â€» åŒã˜è¨€è‘‰ã¯ä¸¡ãƒãƒ¼ãƒ åˆè¨ˆã§1å›ã¾ã§ï¼ˆå€™è£œã¯è‡ªå‹•ã§ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰ã€‚</div>
      </div>
    </section>
    <section class="card">
      <h2>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé¸æŠä¸­6ä½“ï¼‰</h2>
      <div class="body">
        <div id="stats" class="grid cols-2"></div>
      </div>
    </section>
  </section>

  <!-- BATTLE -->
  <section id="battle" class="hidden">
    <section class="card"><h2>ãƒãƒˆãƒ«</h2>
      <div class="body">
        <div class="arena">
          <div class="centerTop">
            <span class="chip" id="ratioAB">ã‚ãªãŸâ†’ç›¸æ‰‹ Ã—-</span>
            <span class="chip" id="ratioBA">ç›¸æ‰‹â†’ã‚ãªãŸ Ã—-</span>
            <span class="chip btn" id="spName">å¿…æ®ºï¼š-</span>
          </div>

          <div class="vsrow">
            <div id="leftWrap"></div>
            <div id="rightWrap"></div>
          </div>

          <div class="cmd">
            <button class="btnCmd" id="handG">âœŠ ã‚°ãƒ¼</button>
            <button class="btnCmd" id="handC">âœŒï¸ ãƒãƒ§ã‚­</button>
            <button class="btnCmd" id="handP">ğŸ– ãƒ‘ãƒ¼</button>
            <button class="btnCmd" id="btnSwitch">ğŸ” äº¤ä»£</button>
            <button class="btnCmd" id="btnSP">âœ¨ å¿…æ®º OFF</button>
            <button class="btnCmd btnWide" id="btnStep">â–¶ 1ã‚¿ãƒ¼ãƒ³é€²ã‚ã‚‹</button>
            <button class="btnCmd btnWide" id="btnAuto">è‡ªå‹•é–‹å§‹</button>
          </div>
          <div id="benchBar"></div>

          <div class="hint">ã˜ã‚ƒã‚“ã‘ã‚“1å›ï¼1ã‚¿ãƒ¼ãƒ³ã€‚äº¤ä»£ã‚¿ãƒ¼ãƒ³ã¯ã˜ã‚ƒã‚“ã‘ã‚“ç„¡ã—ã§CPUæ”»æ’ƒã€‚å¿…æ®ºã¯å›é¿ä¸å¯ï¼äº¤ä»£ã§çŠ¶æ…‹ç•°å¸¸è§£é™¤ï¼†ã‚²ãƒ¼ã‚¸0ã€‚</div>
          <div class="toast" id="toast">...</div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:space-between">
          <div id="summary" class="chip">æœªé–‹å§‹</div>
          <button id="backSetup">ç·¨æˆã«æˆ»ã‚‹</button>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- Switch Modal -->
<div class="modal" id="switchModal">
  <div class="sheet">
    <h3>äº¤ä»£å…ˆã‚’é¸æŠ</h3>
    <div id="switchList"></div>
    <div class="row right" style="margin-top:8px">
      <button id="cancelSwitch">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="primary" id="doSwitch">äº¤ä»£ã™ã‚‹</button>
    </div>
  </div>
</div>

<footer><div class="container small">Â© KOTOBA-BATTLE / v5 HUDã€‚GitHub Pages / ã‚¹ãƒãƒ›OKã€‚</div></footer>

<script>
(()=>{'use strict';
  if(window.__KB_V5__) return; window.__KB_V5__=true;

  /****************** ãƒ‡ãƒ¼ã‚¿ï¼ˆç¢ºå®šä»•æ§˜ï¼‰ ******************/
  const WORDS=[
    // S
    ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],
    ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
    // A
    ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],
    ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
    ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],
    ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
    ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],
    ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
    // B
    ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],
    ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
    ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],
    ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
    ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],
    ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
    ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],
    // C
    ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
    ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],
    ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
    ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],
    ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
    ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],
    ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
    ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],
    // D
    ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
    ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],
    ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
    ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],
    ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
    // X
    ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],
    ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
    ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],
    ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"],
  ];

  // Bã€œDã®çŠ¶æ…‹ç•°å¸¸å‰²å½“ï¼ˆç¢ºå®šï¼‰
  const BD_ASSIGN={
    B:{
      "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"kotobagari",
      "ãƒãƒ«ã‚µãƒŸã‚³é…¢":"genron",
      "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"kotobagari",
      "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"genron",
      "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"genron",
      "ãƒ”ãƒ­ãƒªèŒ":"gestalt",
      "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"gestalt"
    },
    C:{
      "ã•ã‚‹ã³ã‚ä¸¸":"kotobagari",
      "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"kotobagari",
      "ãƒãƒ“ãƒ­ãƒ³æ•å›š":"genron",
      "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"genron",
      "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"gestalt",
      "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"gestalt",
      "é³¥å–ç ‚ä¸˜":"mojibake",
      "æ¸¡æ¥äºº":"mojibake"
    },
    D:{
      "ã‚¯ãƒãƒ³ãƒãƒ":"genron",
      "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"gestalt",
      "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"gestalt",
      "çœŒåºæ‰€åœ¨åœ°":"mojibake",
      "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"mojibake"
    }
  };

  // ä»•æ§˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const P_RANK={S:170,A:165,B:160,C:150,D:145,X:150};
  const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};
  const EV_RANK={S:-1,A:-0.5,B:0,C:0.5,D:1,X:0};
  const BASE_POWER=100, GAUGE_NEEDED=6;

  // ç›¸æ€§ï¼ˆã‚·ãƒ³ãƒ¡ãƒˆãƒªãƒ¼ï¼šå¼·2/å¼±2ï¼‰
  const TYPE_ADV={
    "ãƒ’ã‚¹ãƒˆãƒªãƒ¼":{strong:["ã‚¸ã‚ª","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"],weak:["ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]},
    "ã‚¸ã‚ª":{strong:["ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‚¢ãƒ‹ãƒãƒ«"],weak:["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ãƒ•ãƒ¼ãƒ‰"]},
    "ã‚³ãƒ³ã‚»ãƒ—ãƒˆ":{strong:["ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ãƒ•ãƒ¼ãƒ‰"],weak:["ã‚¸ã‚ª","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]},
    "ã‚µã‚¤ã‚¨ãƒ³ã‚¹":{strong:["ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ã‚¹ãƒˆãƒªãƒ¼"],weak:["ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ãƒ•ãƒ¼ãƒ‰"]},
    "ã‚¢ãƒ‹ãƒãƒ«":{strong:["ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ãƒ•ãƒ¼ãƒ‰"],weak:["ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‚¸ã‚ª"]},
    "ãƒ’ãƒ¥ãƒ¼ãƒãƒ³":{strong:["ã‚¸ã‚ª","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"],weak:["ã‚¢ãƒ‹ãƒãƒ«","ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]},
    "ãƒ•ãƒ¼ãƒ‰":{strong:["ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã‚µã‚¤ã‚¨ãƒ³ã‚¹"],weak:["ã‚¢ãƒ‹ãƒãƒ«","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]},
  };

  // å¿…æ®ºï¼ˆA/Sï¼‰ã€‚Xã¯é¡æ–‡å­—ï¼ˆã‚³ãƒ”ãƒ¼ï¼‹2.0Ã—ï¼‰
  const SPECIALS={
    "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":{ id:"ãªã‚“ãã‚‹ãªã„ã•ãƒ¼", kind:"buff_endure", params:{atkMult:1.5} },
    "ãã¼ã‚ã”ã¯ã‚“":    { id:"ãã¼ã‚ä¹±èˆ",       kind:"multi",       params:{hits:[0.75,0.5,0.25]} },
    "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":{ id:"ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ", kind:"gorilla", params:{first:1.5,next:1.3,turns:2} },
    "æ¯›ã‚€ãã˜ã‚ƒã‚‰":    { id:"ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©",     kind:"evasion",     params:{atkMult:1.4,evade:0.60,turns:3} },
    "ä¹å“ä»":          { id:"ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§", kind:"atk_def",     params:{atkMult:1.6,defMult:1.8,turns:3} },
    "ã‘ã‚“ã¡ã‚“æ±":      { id:"é•·å¯¿ã®ç§˜è¨£",       kind:"atk_heal",    params:{atkMult:1.2,heal:150} },
    "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ": { id:"å¦¨å®³é›»æ³¢",         kind:"atk_drain",   params:{atkMult:2.5} },
    "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":{ id:"ä¸€æ¯ã„ã‹ãŒ",  kind:"heal_attack_all", params:{self:60,allies:60} },
  };

  const AIL={
    kotobagari:{name:"è¨€è‘‰ç‹©ã‚Š",icon:"ğŸš«", apply:(st)=>{st.skipTurns=Math.max(st.skipTurns,1)}},
    genron:{name:"è¨€è«–çµ±åˆ¶",icon:"ğŸ”’", apply:(st)=>{st.genronTurns=Math.max(st.genronTurns,4)}},
    gestalt:{name:"ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š",icon:"ğŸŒ€", apply:(st)=>{st.gestaltTurns=Math.max(st.gestaltTurns,4)}},
    mojibake:{name:"æ–‡å­—åŒ–ã‘",icon:"â˜ ï¸", apply:(st)=>{st.doomTurns=Math.max(st.doomTurns,3)}},
  };

  /****************** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ******************/
  const isHira=(ch)=>/[\u3041-\u3096]/.test(ch);
  const isKataLetter=(ch)=>/[\u30a1-\u30fa\u30fd-\u30ff]/.test(ch);
  const isKanji=(ch)=>{const c=ch.codePointAt(0);return(c>=0x4E00&&c<=0x9FFF)||(c>=0x3400&&c<=0x4DBF)};
  const isKanaOrKanji=(ch)=>isHira(ch)||isKataLetter(ch)||isKanji(ch);
  const hiraToKata=(s)=>s.replace(/[\u3041-\u3096]/g,m=>String.fromCharCode(m.charCodeAt(0)+0x60));
  const visibleLength=(s)=>[...s].length;
  const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
  function hiraRatioForEvasion(name){ const letters=[...name].filter(isKanaOrKanji); if(!letters.length) return 0; const hira=letters.filter(isHira).length; return hira/letters.length; }
  function rKataForStructure(name){ const kata=[...name].filter(isKataLetter).length; const kan=[...name].filter(isKanji).length; const den=kata+kan; if(!den) return null; return kata/den; }
  function phoneticDensities(readingHira){ const kata=[...hiraToKata(readingHira)].filter(isKataLetter); const L=kata.length||1; const smalls=new Set("ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®".split("")); const voiced=new Set("ã‚¬ã‚®ã‚°ã‚²ã‚´ã‚¶ã‚¸ã‚ºã‚¼ã‚¾ãƒ€ãƒ‚ãƒ…ãƒ‡ãƒ‰ãƒãƒ“ãƒ–ãƒ™ãƒœãƒ‘ãƒ”ãƒ—ãƒšãƒãƒ´".split("")); const last=kata[kata.length-1]||""; const plos=new Set("ã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒ‘ãƒ”ãƒ—ãƒšãƒãƒãƒ“ãƒ–ãƒ™ãƒœ".split("")); const d=kata.filter(ch=>voiced.has(ch)).length/L; const s=kata.filter(ch=>'ãƒƒ'===ch).length/L; const m=kata.filter(ch=>smalls.has(ch)).length/L; const e=plos.has(last)?1:0; return {d,s,m,e}; }

  /****************** ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— ******************/
  function calcStats(name, rank, type, readingHira){
    const T=visibleLength(name);
    // æ§‹æˆ25%
    let atk_struct,def_struct;{
      const r=rKataForStructure(name);
      if(r===null){ atk_struct=0.125; def_struct=0.125; } else { atk_struct=0.25*r; def_struct=0.25-atk_struct; }
    }
    // éŸ³20%
    let atk_phon,def_phon;{
      const {d,s,m,e}=phoneticDensities(readingHira);
      const Lw=0.05, Uw=0.45;
      const s_raw=0.6*d+0.25*(s+m)+0.15*e;
      const s_ph=clamp(((s_raw-Lw)/(Uw-Lw))*2-1,-1,1);
      atk_phon=0.2*(0.5+0.5*s_ph); def_phon=0.2-atk_phon;
    }
    // é•·ã•20%
    let atk_len,def_len;{
      const s_len=clamp((6-T)/6,-1,1);
      atk_len=0.2*(0.5+0.5*s_len); def_len=0.2-atk_len;
    }
    const atk_pct=0.175+atk_struct+atk_phon+atk_len;
    const def_pct=0.175+def_struct+def_phon+def_len;
    const P=P_RANK[rank];
    const ATK=Math.round(P*atk_pct);
    const DEF=Math.round(P*def_pct);
    const HP=HP_BASE[rank]+20*(T-5);
    let eva=10+8*hiraRatioForEvasion(name)-0.5*(T-5)+EV_RANK[rank];
    eva=clamp(eva,5,35);
    return {ATK,DEF,HP,Evasion:eva};
  }

  /****************** ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ ******************/
  const typeMult=(atkT,defT)=>{const m=TYPE_ADV[atkT]; if(!m) return 1; if(m.strong.includes(defT)) return 1.5; if(m.weak.includes(defT)) return 0.67; return 1};
  const sample=(arr,rng)=>arr[Math.floor(rng()*arr.length)];

  function createFighter([name,rank,type,reading]){ const st=calcStats(name,rank,type,reading); return {name,rank,type,reading,base:st,hp:st.HP,gauge:0,atkMult:1,defMult:1,atkTurns:0,defTurns:0,evadeOverride:null,endure:false,skipTurns:0,gestaltTurns:0,doomTurns:0,genronTurns:0,_gorillaActive:false,_manualForce:false}; }

  function computeDamageDetailed(att,def,isSpecial,rng){
    // å‘½ä¸­ï¼ˆå¿…æ®ºã¯å›é¿ä¸å¯ï¼‰
    if(!isSpecial){
      const eva=(def.evadeOverride&&def.evadeOverride.turns>0&&def.evadeOverride.rate!=null)?def.evadeOverride.rate:(def.base.Evasion/100);
      if(rng()<eva) return {dmg:0,miss:true,luck:'normal',matchup:'even'};
    }
    let dmg=BASE_POWER*(1+att.base.ATK/100)/(1+(def.base.DEF*def.defMult)/120);
    dmg*=att.atkMult;
    const tm=typeMult(att.type,def.type);
    dmg*=tm;
    const r=rng();
    let luck='normal';
    if(r<0.2){ dmg*=1.2; luck='lucky'; }
    else if(r<0.4){ dmg*=0.8; luck='unlucky'; }
    const matchup = tm>1.0?'good': tm<1.0?'bad':'even';
    return {dmg,miss:false,luck,matchup};
  }

  function composeMsg(attacker, dmg, luck, matchup){
    const luckTxt = luck==='lucky'?'ãƒ©ãƒƒã‚­ãƒ¼ï¼ ': luck==='unlucky'?'ã‚¢ãƒ³ãƒ©ãƒƒã‚­ãƒ¼â€¦ ':'';
    const muTxt   = matchup==='good'?' ç›¸æ€§æŠœç¾¤ï¼': matchup==='bad'?' ç›¸æ€§ã¯ã„ã¾ã„ã¡â€¦':'';
    return `${luckTxt}${attacker}ã®æ”»æ’ƒã€‚${Math.round(dmg)}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼${muTxt}`;
  }

  function dealAttack(actor,target,isSpecial,rng){
    if(actor.gestaltTurns>0 && rng()<1/3){ actor.hp-=100; return {self:true, msg:`${actor.name}ã¯æ··ä¹±ï¼è‡ªå‚·100`}; }
    const sp=SPECIALS[actor.name];
    if(isSpecial && sp && sp.kind==='multi'){
      const keep=actor.atkMult; let total=0, anyLucky=false, anyUnlucky=false, matchup='even';
      for(const s of sp.params.hits){
        actor.atkMult=keep*s;
        const info=computeDamageDetailed(actor,target,true,rng);
        total+=info.dmg;
        if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; }
        else target.hp-=info.dmg;
        if(info.luck==='lucky') anyLucky=true; if(info.luck==='unlucky') anyUnlucky=true;
        if(info.matchup==='good') matchup='good'; else if(info.matchup==='bad' && matchup!=='good') matchup='bad';
        if(target.hp<=0) break;
      }
      actor.atkMult=keep;
      const luck = anyLucky? 'lucky': anyUnlucky? 'unlucky':'normal';
      return { dmg:total, msg: composeMsg(actor.name, total, luck, matchup) };
    } else {
      const info=computeDamageDetailed(actor,target,isSpecial,rng);
      if(info.miss) return {dmg:0, msg:`${actor.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`};
      if(target.endure && target.hp-info.dmg<=0){ target.hp=1; target.endure=false; }
      else target.hp-=info.dmg;
      return { dmg:info.dmg, msg: composeMsg(actor.name, info.dmg, info.luck, info.matchup) };
    }
  }

  function endOfTick(f){
    if(f.atkTurns>0 && --f.atkTurns===0) f.atkMult=1;
    if(f.defTurns>0 && --f.defTurns===0) f.defMult=1;
    if(f.evadeOverride && --f.evadeOverride.turns<=0) f.evadeOverride=null;
    if(f.skipTurns>0) f.skipTurns--;
    if(f.gestaltTurns>0) f.gestaltTurns--;
    if(f.genronTurns>0) f.genronTurns--;
    if(f.doomTurns>0 && --f.doomTurns===0) f.hp=0;
  }
  function endTurnAdjustments(f){ if(f._gorillaActive){ f.atkMult=1.3; f._gorillaActive=false; } }

  function applyAilment(rank,name,target,log){
    const eff=BD_ASSIGN[rank]?.[name]; if(!eff) return false;
    AIL[eff].apply(target); log && log.push(`${AIL[eff].icon}${AIL[eff].name}`); return true;
  }

  function briefDesc(sp){
    const k=sp.kind,p=sp.params;
    return ({
      buff_endure:`æ”»${p.atkMult}Ã—ï¼‹æ ¹æ€§1å›`,
      multi:`å¤šæ®µ ${p.hits.join(' / ')}Ã—`,
      gorilla:`åˆ${p.first}Ã—â†’${p.turns}T ${p.next}Ã—`,
      evasion:`æ”»${p.atkMult}Ã—ï¼‹å›é¿${Math.round(p.evade*100)}%Ã—${p.turns}T`,
      atk_def:`æ”»${p.atkMult}Ã—ï¼‹é˜²${p.defMult}Ã—(${p.turns}T)`,
      atk_heal:`æ”»${p.atkMult}Ã—ï¼‹å›å¾©${p.heal}`,
      atk_drain:`æ”»${p.atkMult}Ã—ï¼‹ç›¸æ‰‹ã‚²ãƒ¼ã‚¸0`,
      heal_attack_all:`é€šå¸¸ï¼‹è‡ª${p.self}/å‘³${p.allies}å›å¾©`,
    })[k] || '';
  }
  function fullDesc(sp){ return briefDesc(sp); }
  function bdDesc(u){
    if(!u) return '-';
    const eff = BD_ASSIGN[u.rank]?.[u.name];
    if(!eff) return 'çŠ¶æ…‹ç•°å¸¸å‹';
    return ({kotobagari:'è¨€è‘‰ç‹©ã‚Šï¼ˆè¡Œå‹•ä¸å¯1Tï¼‰',genron:'è¨€è«–çµ±åˆ¶ï¼ˆäº¤ä»£ä¸å¯4Tï¼‰',gestalt:'ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼ˆ4Tãƒ»1/3ã§è‡ªå‚·100ï¼‰',mojibake:'æ–‡å­—åŒ–ã‘ï¼ˆ3Tå¾Œå³æ­»ï¼‰'})[eff];
  }

  function applySpecialPre(actor,target,allies,enemies,rng,log){
    if(actor.gauge<GAUGE_NEEDED||actor.skipTurns>0) return false;
    // è¨€è«–çµ±åˆ¶ä¸­ã¯ç›¸æ€§ä¸åˆ©ãªã‚‰æ’ƒãŸãªã„ï¼ˆæ‰‹å‹•ONã¯ _manualForce ã§å¼·åˆ¶ï¼‰
    if(target.genronTurns>0 && typeMult(actor.type,target.type)<1.0 && !actor._manualForce) return false;
    let used=false;
    if(actor.rank==='X'){
      const cands=enemies.filter(e=>e.rank!=='X'&&e.hp>0);
      if(cands.length){
        const picked=sample(cands,rng);
        actor.atkMult*=2.0; actor.atkTurns=Math.max(actor.atkTurns,1);
        log && log.push(`é¡æ–‡å­—â†’${picked.name}`);
        const bn=actor.name, br=actor.rank;
        actor.name=picked.name; actor.rank=picked.rank;
        const _=applySpecialPre(actor,target,allies,enemies,rng,log);
        actor.name=bn; actor.rank=br;
        used=true;
      }
    } else if(actor.rank==='A'||actor.rank==='S'){
      const sp=SPECIALS[actor.name];
      if(sp){
        switch(sp.kind){
          case 'buff_endure': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.endure=true; used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'multi': used=true; log && log.push(`${sp.id}ï¼ˆå¤šæ®µï¼‰`); break;
          case 'gorilla': actor.atkMult=sp.params.first; actor.atkTurns=Math.max(actor.atkTurns,1+sp.params.turns); actor._gorillaActive=true; used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'evasion': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.evadeOverride={rate:sp.params.evade,turns:sp.params.turns}; used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'atk_def': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.defMult*=sp.params.defMult; actor.defTurns=Math.max(actor.defTurns,sp.params.turns); used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'atk_heal': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.heal); used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'atk_drain': actor.atkMult*=sp.params.atkMult; actor.atkTurns=Math.max(actor.atkTurns,1); target.gauge=0; used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
          case 'heal_attack_all': actor.hp=Math.min(actor.base.HP, actor.hp+sp.params.self); for(const al of allies){ if(al!==actor) al.hp=Math.min(al.base.HP, al.hp+sp.params.allies); } used=true; log && log.push(`${sp.id}ï¼ˆ${briefDesc(sp)}ï¼‰`); break;
        }
      }
    } else { used=applyAilment(actor.rank,actor.name,target,log); }
    if(used){ actor.gauge=Math.max(0,actor.gauge-GAUGE_NEEDED); }
    return used;
  }

  /****************** UIï¼šDOMãƒ˜ãƒ«ãƒ‘ ******************/
  const $=id=>document.getElementById(id);
  function el(tag,attrs={},children=[]){ const e=document.createElement(tag); for(const k in attrs){ if(k==='class') e.className=attrs[k]; else if(k==='html') e.innerHTML=attrs[k]; else e.setAttribute(k,attrs[k]); } children.forEach(c=>e.append(c)); return e; }

  /****************** ç·¨æˆç”»é¢ ******************/
  const teamA=$('teamA'), teamB=$('teamB'), statsMount=$('stats');
  function selectTpl(i){ return el('div',{class:'slot'},[ el('span',{class:'pill'},[document.createTextNode('#'+(i+1))]), buildSelect() ]); }
  function buildSelect(){ const s=el('select'); for(const [n,r,t] of WORDS){ s.append( el('option',{value:n},[document.createTextNode(`${n} [${r}/${t}]`)]) ); } return s; }
  function getSelections(box){ const sels=[...box.querySelectorAll('select')]; return sels.map(s=> WORDS.find(w=>w[0]===s.value)); }
  function renderStats(list){ statsMount.innerHTML=''; for(const it of list){ if(!it) continue; const [n,r,t,read]=it; const st=calcStats(n,r,t,read); const card=el('div',{class:'card'},[ el('h2',{},[document.createTextNode(n+' '), el('span',{class:'tag'},[document.createTextNode(`[${r}/${t}]`)]) ]), el('div',{class:'body'},[ el('div',{class:'grid cols-2'},[ el('div',{},[el('div',{class:'muted'},['HP']), document.createTextNode(String(st.HP))]), el('div',{},[el('div',{class:'muted'},['ATK']), document.createTextNode(String(st.ATK))]), el('div',{},[el('div',{class:'muted'},['DEF']), document.createTextNode(String(st.DEF))]), el('div',{},[el('div',{class:'muted'},['å›é¿%']), document.createTextNode(String(st.Evasion.toFixed(1)))]) ]) ]) ]); statsMount.append(card);} }
  for(let i=0;i<3;i++){ teamA.append(selectTpl(i)); teamB.append(selectTpl(i)); }
  function updateStats(){ renderStats([ ...getSelections(teamA), ...getSelections(teamB) ]); updateOptionDisables(); }
  teamA.addEventListener('change',updateStats); teamB.addEventListener('change',updateStats); updateStats();
  $('randA').onclick=()=>randomize(teamA);
  $('randB').onclick=()=>randomize(teamB);
  function randomize(box){
    const sels=[...box.querySelectorAll('select')];
    const used = new Set([ ...getSelections(teamA), ...getSelections(teamB) ].filter(Boolean).map(v=>v[0]));
    const pool = WORDS.filter(w=>!used.has(w[0]));
    sels.forEach((s,i)=>{ const avail = WORDS.filter(w=> ![...sels].some(x=>x!==s && x.value===w[0]) && !used.has(w[0]) ); const pick = (avail.length?avail:WORDS)[Math.floor(Math.random()* (avail.length?avail.length:WORDS.length))]; s.value=pick[0]; used.add(pick[0]); });
    updateOptionDisables(); updateStats();
  }
  function updateOptionDisables(){
    const selected = new Set([ ...getSelections(teamA), ...getSelections(teamB) ].filter(Boolean).map(v=>v[0]));
    [teamA,teamB].forEach(box=>{
      [...box.querySelectorAll('select')].forEach(sel=>{
        [...sel.options].forEach(opt=>{
          const isOwn = sel.value===opt.value;
          opt.disabled = !isOwn && selected.has(opt.value);
        });
      });
    });
  }
  $('demo').onclick=()=>{ const set=(box,arr)=>{ const sels=[...box.querySelectorAll('select')]; arr.forEach((nm,i)=>{ if(sels[i]) sels[i].value=nm; }); }; set(teamA,["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©"]); set(teamB,["é³¥å–ç ‚ä¸˜","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©"]); updateStats(); };

  /****************** ç”»é¢é·ç§» ******************/
  const setup=$('setup'), battle=$('battle');
  $('toBattle').onclick=()=>{ if(!getSelections(teamA).every(Boolean)||!getSelections(teamB).every(Boolean)){ alert('ãƒãƒ¼ãƒ ã‚’3ä½“ãšã¤é¸ã‚“ã§ãã ã•ã„'); return; } setup.classList.add('hidden'); battle.classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); startNewSession(true); };
  $('backSetup').onclick=()=>{ stopAuto(); setup.classList.remove('hidden'); battle.classList.add('hidden'); };

  /****************** ãƒãƒˆãƒ«HUD ******************/
  const leftWrap=$('leftWrap'), rightWrap=$('rightWrap'), ratioAB=$('ratioAB'), ratioBA=$('ratioBA'), spName=$('spName'), summary=$('summary'), toast=$('toast'), benchBar=$('benchBar');

  function unitView(u, active=false){
    const wrap=el('div',{class:'unit'+(active?' active':'')});
    wrap.append( el('div',{class:'nameRow'},[ el('div',{class:'name'},[document.createTextNode(u.name)]), el('div',{class:'tag'},[document.createTextNode(`[${u.type}]`)]) ]) );
    const hpRow=el('div'); hpRow.append( el('div',{class:'small muted'},[document.createTextNode(`HP ${Math.max(0,Math.ceil(u.hp))}/${u.base.HP}`)]) );
    const bar=el('div',{class:'bar'},[ el('span',{style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`}) ]);
    hpRow.append(bar); wrap.append(hpRow);
    const g=el('div',{class:'gauge'}); for(let i=0;i<6;i++){ g.append(el('div',{class:'pip'+(i<Math.floor(u.gauge)?' on':'')})); } wrap.append(g);
    const st=el('div',{class:'status'});
    if(u.skipTurns>0) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸš«Ã—${u.skipTurns}`)]) );
    if(u.genronTurns>0) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸ”’Ã—${u.genronTurns}`)]) );
    if(u.gestaltTurns>0) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸŒ€Ã—${u.gestaltTurns}`)]) );
    if(u.doomTurns>0) st.append( el('span',{class:'st'},[document.createTextNode(`â˜ ï¸Ã—${u.doomTurns}`)]) );
    if(u.endure) st.append( el('span',{class:'st'},[document.createTextNode('ğŸ›¡æ ¹æ€§')]) );
    if(u.evadeOverride && u.evadeOverride.turns>0) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸŸ¦å›é¿${Math.round(u.evadeOverride.rate*100)}%Ã—${u.evadeOverride.turns}`)]) );
    if(u.defTurns>0) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸŸ©é˜²Ã—${u.defTurns}`)]) );
    if(u.atkTurns>0 && u.atkMult>1) st.append( el('span',{class:'st'},[document.createTextNode(`ğŸŸ¥æ”»${u.atkMult.toFixed(2)}Ã—Ã—${u.atkTurns}`)]) );
    return wrap;
  }
  function benchView(units){ const box=el('div',{class:'bench'}); for(const u of units){ box.append( el('div',{class:'mini'},[ el('div',{class:'name'},[document.createTextNode(u.name)]), el('div',{class:'bar'},[ el('span',{style:`width:${Math.max(0,Math.min(100,u.hp/u.base.HP*100)).toFixed(1)}%`}) ]) ]) ); } return box; }

  function renderHUD(A,ia,B,ib){
    leftWrap.innerHTML=''; rightWrap.innerHTML='';
    const al=[A[ia], ...A.slice(ia+1).filter(x=>x.hp>0)];
    const bl=[B[ib], ...B.slice(ib+1).filter(x=>x.hp>0)];
    if(al[0]) leftWrap.append( unitView(al[0], true) );
    leftWrap.append( benchView(al.slice(1)) );
    if(bl[0]) rightWrap.append( unitView(bl[0], true) );
    rightWrap.append( benchView(bl.slice(1)) );

    ratioAB.textContent = `ã‚ãªãŸâ†’ç›¸æ‰‹ Ã—${typeMult(A[ia]?.type,B[ib]?.type).toFixed(2)}`;
    ratioBA.textContent = `ç›¸æ‰‹â†’ã‚ãªãŸ Ã—${typeMult(B[ib]?.type,A[ia]?.type).toFixed(2)}`;

    // å¿…æ®ºåï¼‹èª¬æ˜
    const nm=A[ia]?.name; const sp=SPECIALS[nm];
    const desc= sp ? briefDesc(sp) : bdDesc(A[ia]);
    spName.textContent = `å¿…æ®ºï¼š${ sp ? `${sp.id}ï½œ${desc}` : desc }`;
    spName.onclick=()=> alert( sp ? `${sp.id}\n${fullDesc(sp)}` : `Bã€œDï¼š${desc}`);

    // å¿…æ®ºReadyãƒ‘ãƒ«ã‚¹
    const spReady = A[ia] && A[ia].gauge>=GAUGE_NEEDED && A[ia].skipTurns<=0;
    $('btnSP').classList.toggle('ready', !!spReady);

    // ãƒœã‚¿ãƒ³ä¸‹ãƒ™ãƒ³ãƒï¼ˆã‚¿ã‚¤ãƒ—ï¼‹ç›¸æ€§ï¼‰
    benchBar.innerHTML='';
    const foe=B[ib];
    A.slice(ia+1).filter(x=>x.hp>0).forEach(u=>{
      const chip=document.createElement('div'); chip.className='benchChip';
      const r=typeMult(u.type, foe.type);
      chip.innerHTML = `<span class="name">${u.name}</span><span class="type">[${u.type}]</span><span class="ratio">Ã—${r.toFixed(2)}</span>`;
      benchBar.append(chip);
    });
  }

  function showToast(text, ms=1800){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),ms); }

  /****************** ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ ******************/
  let SESSION=null, AUTO=null, SELECTED_HAND='g', USE_SP=false, REQUEST_SWITCH=false, SWITCH_TARGET_INDEX=null;
  const handButtons=[$('handG'),$('handC'),$('handP')];
  $('handG').onclick=()=>setHand('g'); $('handC').onclick=()=>setHand('c'); $('handP').onclick=()=>setHand('p');
  function setHand(h){ SELECTED_HAND=h; handButtons.forEach(b=>b.classList.remove('on')); ({g:$('handG'),c:$('handC'),p:$('handP')})[h].classList.add('on'); }
  setHand('g');
  $('btnSP').onclick=()=>{ USE_SP=!USE_SP; $('btnSP').textContent = USE_SP?'âœ¨ å¿…æ®º ON':'âœ¨ å¿…æ®º OFF'; $('btnSP').classList.toggle('on', USE_SP); };

  // äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ‰‹å‹•ï¼‰
  const switchModal=$('switchModal'), switchList=$('switchList');
  $('btnSwitch').onclick=()=>{ if(!SESSION){ startNewSession(true); } openSwitchModal(); };
  $('cancelSwitch').onclick=()=>{ switchModal.style.display='none'; SWITCH_TARGET_INDEX=null; };
  $('doSwitch').onclick=()=>{ if(SWITCH_TARGET_INDEX==null) return; REQUEST_SWITCH=true; switchModal.style.display='none'; stepOnce(); };
  function openSwitchModal(){
    const s=SESSION; if(!s) return;
    const benchIdxs = Array.from({length:s.A.length-s.ia-1},(_,k)=>k+s.ia+1).filter(k=>s.A[k].hp>0);
    switchList.innerHTML='';
    benchIdxs.forEach((idx)=>{ const u=s.A[idx]; const row=el('div',{class:'opt'},[ el('div',{},[ el('div',{class:'name'},[document.createTextNode(u.name)]), el('div',{class:'small muted'},[document.createTextNode(`[${u.type}]  HP ${Math.ceil(u.hp)}/${u.base.HP}`)]) ]), el('button',{class:'ghost'},[document.createTextNode('é¸æŠ')]) ]); row.querySelector('button').onclick=()=>{ document.querySelectorAll('#switchList .opt').forEach(x=>x.classList.remove('on')); row.classList.add('on'); SWITCH_TARGET_INDEX=idx; }; switchList.append(row); });
    if(!benchIdxs.length) switchList.innerHTML='<div class="small muted">æ§ãˆãŒã„ã¾ã›ã‚“</div>';
    switchModal.style.display='grid';
  }

  function LCG(sd){ let s=sd>>>0; return ()=> (s=(1664525*s+1013904223)>>>0, (s>>>8)/16777216); }
  const rpsRes=(a,b)=> a===b?-1 : ((a==='g'&&b==='c')||(a==='c'&&b==='p')||(a==='p'&&b==='g')?0:1);
  const handLabel=h=>h==='g'?'ã‚°ãƒ¼':(h==='c'?'ãƒãƒ§ã‚­':'ãƒ‘ãƒ¼');

  function startNewSession(reset=false){
    const A=getSelections(teamA), B=getSelections(teamB);
    if(A.some(v=>!v)||B.some(v=>!v)){ alert('ãƒãƒ¼ãƒ ã‚’3ä½“ãšã¤é¸ã‚“ã§ãã ã•ã„'); return false; }
    const rng=LCG(Number($('seed').value)||20250812);
    SESSION={ rng, A:A.map(createFighter), B:B.map(createFighter), ia:0, ib:0, tick:0 };
    summary.textContent='ãƒãƒˆãƒ«ä¸­'; renderHUD(SESSION.A,SESSION.ia,SESSION.B,SESSION.ib);
    if(reset){ stopAuto(); USE_SP=false; $('btnSP').textContent='âœ¨ å¿…æ®º OFF'; $('btnSP').classList.remove('on'); }
    return true;
  }

  $('btnStep').onclick=()=>{ stopAuto(); stepOnce(); };
  $('btnAuto').onclick=()=>{ AUTO?stopAuto():startAuto(); };
  function startAuto(){ if(!SESSION && !startNewSession(true)) return; $('btnAuto').textContent='è‡ªå‹•åœæ­¢'; AUTO=setInterval(stepOnce, 220); }
  function stopAuto(){ if(!AUTO) return; clearInterval(AUTO); AUTO=null; $('btnAuto').textContent='è‡ªå‹•é–‹å§‹'; }

  function stepOnce(){
    if(!SESSION){ if(!startNewSession(true)) return; }
    const s=SESSION; s.tick++;

    // æˆ¦é—˜ä¸èƒ½ç‰‡ä»˜ã‘
    while(s.ia<3 && s.A[s.ia].hp<=0){ s.ia++; if(s.ia<3){ s.A[s.ia].hp=s.A[s.ia].base.HP; s.A[s.ia].gauge=0; } }
    while(s.ib<3 && s.B[s.ib].hp<=0){ s.ib++; if(s.ib<3){ s.B[s.ib].hp=s.B[s.ib].base.HP; s.B[s.ib].gauge=0; } }
    if(s.ia>=3||s.ib>=3){ summary.textContent=`çµæœï¼š${s.ib>=3?'ã‚ãªãŸã®å‹ã¡':'CPUã®å‹ã¡'}`; renderHUD(s.A,s.ia,s.B,s.ib); stopAuto(); return; }

    let a=s.A[s.ia], b=s.B[s.ib];

    // æ‰‹å‹•äº¤ä»£ï¼šã“ã®ã‚¿ãƒ¼ãƒ³ã¯CPUã®ã¿æ”»æ’ƒï¼ˆã˜ã‚ƒã‚“ã‘ã‚“ç„¡ã—ï¼‰
    if(REQUEST_SWITCH && SWITCH_TARGET_INDEX!=null){
      switchIn(s.A, s.ia, SWITCH_TARGET_INDEX); a=s.A[s.ia]; REQUEST_SWITCH=false; SWITCH_TARGET_INDEX=null;
      showToast('äº¤ä»£ï¼ â†’ ' + a.name, 1200);
      // CPUæ”»æ’ƒ
      const used=applySpecialPre(b,a,s.B,s.A,s.rng,null);
      const rr=dealAttack(b,a,used,s.rng,null);
      showToast(rr.msg, 2000);
      if(a.hp<=0){ s.ia++; if(s.ia<3){ s.A[s.ia].hp=s.A[s.ia].base.HP; s.A[s.ia].gauge=0; } }
      endTurnAdjustments(b); endOfTick(a); endOfTick(b);
      renderHUD(s.A,s.ia,s.B,s.ib); return;
    }

    // ---- AIäº¤ä»£å¸Œæœ›åˆ¤å®šï¼ˆçœŸå½ã®ã¿ï¼‰----
    const wantA = decideSwitch(a, s.A.slice(s.ia+1), b, s.rng);
    const wantB = decideSwitch(b, s.B.slice(s.ib+1), a, s.rng);

    // åŒæ™‚äº¤ä»£ â†’ åŒæ–¹äº¤ä»£ã®ã¿ï¼ˆæ”»æ’ƒãªã—ï¼‰
    if(wantA && wantB){
      const idxA = randomBenchIndex(s.A, s.ia, s.rng);
      const idxB = randomBenchIndex(s.B, s.ib, s.rng);
      if(idxA!=null) switchIn(s.A, s.ia, idxA);
      if(idxB!=null) switchIn(s.B, s.ib, idxB);
      showToast('åŒæ–¹äº¤ä»£ï¼', 1200);
      endOfTick(s.A[s.ia]); endOfTick(s.B[s.ib]);
      renderHUD(s.A,s.ia,s.B,s.ib);
      return;
    }
    // ç‰‡å´ã ã‘äº¤ä»£ â†’ äº¤ä»£å´ã ã‘äº¤ä»£ï¼ç›¸æ‰‹ã¯æ”»æ’ƒ
    if(wantA){
      const idxA = randomBenchIndex(s.A, s.ia, s.rng);
      if(idxA!=null){ switchIn(s.A, s.ia, idxA); a=s.A[s.ia]; showToast('ã‚ãªãŸã¯äº¤ä»£ï¼', 1000); }
      const used=applySpecialPre(b,a,s.B,s.A,s.rng,null);
      const rr=dealAttack(b,a,used,s.rng,null);
      showToast(rr.msg, 2000);
      endTurnAdjustments(b); endOfTick(a); endOfTick(b);
      renderHUD(s.A,s.ia,s.B,s.ib);
      return;
    }
    if(wantB){
      const idxB = randomBenchIndex(s.B, s.ib, s.rng);
      if(idxB!=null){ switchIn(s.B, s.ib, idxB); b=s.B[s.ib]; showToast('CPUã¯äº¤ä»£ï¼', 1000); }
      const used=applySpecialPre(a,b,s.A,s.B,s.rng,null);
      const rr=dealAttack(a,b,used,s.rng,null);
      showToast(rr.msg, 2000);
      endTurnAdjustments(a); endOfTick(a); endOfTick(b);
      renderHUD(s.A,s.ia,s.B,s.ib);
      return;
    }

    // ---- ã˜ã‚ƒã‚“ã‘ã‚“ï¼†ã‚²ãƒ¼ã‚¸ ----
    const gInc=(s.rng()<0.5?1:2); a.gauge+=gInc; b.gauge+=gInc;
    const cpu=['g','c','p'][Math.floor(s.rng()*3)];
    const res=rpsRes(SELECTED_HAND,cpu);
    if(res===-1){ showToast(`ã‚ã„ã“ï¼š${handLabel(SELECTED_HAND)} / ${handLabel(cpu)}`, 1200); endOfTick(a); endOfTick(b); renderHUD(s.A,s.ia,s.B,s.ib); return; }
    // å‹è€…ã®æ”»æ’ƒãƒ¡ãƒƒã‚»ã«çµ±ä¸€
    const actor = res===0? a:b; const target = res===0? b:a; const allies = res===0? s.A:s.B; const enemies = res===0? s.B:s.A;

    if(actor.skipTurns<=0){
      if(actor===a && USE_SP) actor._manualForce=true;
      const used=applySpecialPre(actor,target,allies,enemies,s.rng,null);
      actor._manualForce=false;
      const rr=dealAttack(actor,target,used,s.rng,null);
      showToast(rr.msg, 2000);
      if(target.hp<=0){
        if(target===a){ s.ia++; if(s.ia<3){ s.A[s.ia].hp=s.A[s.ia].base.HP; s.A[s.ia].gauge=0; } }
        else { s.ib++; if(s.ib<3){ s.B[s.ib].hp=s.B[s.ib].base.HP; s.B[s.ib].gauge=0; } }
      }
      endTurnAdjustments(actor);
    } else {
      showToast(`${actor.name} ã¯è¨€è‘‰ç‹©ã‚Šã§è¡Œå‹•ä¸èƒ½`, 1400);
    }

    // çµŒé
    endOfTick(a); endOfTick(b);
    if(s.ia>=3||s.ib>=3){ summary.textContent=`çµæœï¼š${s.ib>=3?'ã‚ãªãŸã®å‹ã¡':'CPUã®å‹ã¡'}`; stopAuto(); }
    renderHUD(s.A,s.ia,s.B,s.ib);
  }

  // AIï¼šäº¤ä»£ã™ã‚‹ã‹ã©ã†ã‹
  function decideSwitch(me,bench,opp,rng){
    if(me.genronTurns>0) return false;
    const alive=bench.filter(u=>u.hp>0); if(!alive.length) return false;
    const mySP=me.gauge>=GAUGE_NEEDED && me.skipTurns<=0;
    const oppSP=opp.gauge>=GAUGE_NEEDED && opp.skipTurns<=0;
    const myDmg=computeDamageDetailed(me,opp,mySP,rng).dmg;
    const theirDmg=computeDamageDetailed(opp,me,oppSP,rng).dmg;
    const EVnow=myDmg-theirDmg;

    if(opp.genronTurns>0){
      // ãƒ­ãƒƒã‚¯ä¸­ã¯ç›¸æ€§æœ‰åˆ©ã‚’ç‹™ã†ä¾¡å€¤ãŒé«˜ã„
      const bestM=Math.max(...alive.map(b=>typeMult(b.type,opp.type)));
      const cur=typeMult(me.type,opp.type);
      const gain=Math.max(0,bestM-cur);
      const horizon=Math.min(4,opp.genronTurns);
      const meFactor=(1+me.base.ATK/100)/(1+opp.base.DEF/120);
      const dpsGain=BASE_POWER*gain*meFactor;
      const EVlock=dpsGain*horizon;
      const risk=computeDamageDetailed(opp, sample(alive,rng), oppSP, rng).dmg;
      return (EVlock-risk)>-5;
    }
    const expIncoming = alive.length ? alive.map(b=>computeDamageDetailed(opp,b,oppSP,rng).dmg).reduce((a,b)=>a+b,0)/alive.length : 999;
    return (EVnow<-20)&&(expIncoming<me.hp*0.9);
  }
  // ãƒ™ãƒ³ãƒé¸ã³ã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆç­‰ç¢ºç‡ï¼‰
  function randomBenchIndex(team, iActive, rng){
    const idxs = Array.from({length:team.length-(iActive+1)},(_,k)=>k+iActive+1).filter(i=>team[i].hp>0);
    if(!idxs.length) return null;
    return idxs[Math.floor(rng()*idxs.length)];
  }

  function switchIn(team,iFrom,iTo){
    [team[iFrom],team[iTo]]=[team[iTo],team[iFrom]];
    team[iFrom].gauge=0; // é€€ã„ãŸå´
    // å…¥ã£ãŸå´ã®ç•°å¸¸è§£é™¤
    team[iTo].skipTurns=team[iTo].gestaltTurns=team[iTo].doomTurns=team[iTo].genronTurns=0;
  }

})();
</script>
</body>
</html>