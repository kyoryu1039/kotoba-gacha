<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£ ‚Äî Hypnagogia Edition v4.7</title>
<style>
:root{--bg:#0b0f1c;--ink:#eef2ff;--muted:#aab3d6;--panel:#12172b;--edge:#1d2a55;--gold:#f7d774;--amber:#ffbd63;--aqua:#63ead9;--blue:#8fb1ff;--gray:#94a3b8;--bad:#ff6b6b}
*{box-sizing:border-box}body{margin:0;color:var(--ink);background:
radial-gradient(1200px 800px at 80% -20%, rgba(255,255,255,.04), transparent 60%),
radial-gradient(1000px 800px at 10% 0%, #121a3b, #0b0f1c 60%);
font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:linear-gradient(180deg,rgba(10,14,28,.9),rgba(10,14,28,.65));border-bottom:1px solid var(--edge);padding:8px 10px 12px}
.titleRow{display:flex;align-items:center;justify-content:center;gap:8px}
.title{font-weight:900;letter-spacing:.3px;font-size:18px;white-space:nowrap;max-width:80vw;text-overflow:ellipsis;overflow:hidden}
.ver{font-size:10px;color:#0b0f1c;background:linear-gradient(180deg,#b5ffdf,#63ead9);border-radius:999px;padding:3px 8px;font-weight:900}

/* === ‰∏ªÂΩπ„Ç¨„ÉÅ„É£„Éú„Çø„É≥ÔºàÂÖâÊ≤¢„ÅÇ„ÇäÔºâ === */
button.cta.main {
  font-size: 15px;
  padding: 10px 16px;
  border-radius: 12px;
  border: none;
  position: relative;
  overflow: hidden;
  color: #081224;
  font-weight: 900;
  cursor: pointer;
  background: linear-gradient(180deg,#ffd36b,#f0b100); /* ÈáëËâ≤ */
  box-shadow: 0 6px 16px rgba(0,0,0,.35);
  transition: transform .1s, filter .25s;
  flex:1;
}
button.cta.main.b5 {
  background: linear-gradient(180deg,#a4d7ff,#5cc6ff); /* ÈùíËâ≤ */
}
button.cta.main:hover {
  filter: brightness(1.08);
  transform: translateY(-1px);
}
button.cta.main::before {
  content:"";
  position:absolute;
  top:0; left:-50%;
  width:200%; height:100%;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,.4) 50%,
    rgba(255,255,255,0) 100%);
  transform: skewX(-20deg);
  animation: shine 3s infinite;
}
@keyframes shine {
  0%   {left:-120%;}
  50%  {left:120%;}
  100% {left:120%;}
}

/* Ë£úÂä©„Éú„Çø„É≥Áæ§ */
.ctrlRow{margin-top:8px;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center}
.bigActions{display:flex;gap:10px;justify-content:center;width:100%}
.auxRow{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:8px}
button.cta{appearance:none;border:none;cursor:pointer;font-weight:900;letter-spacing:.2px;border-radius:12px;transition:transform .08s}
button.cta:active{transform:translateY(1px) scale(.99)}
.bgm{background:linear-gradient(180deg,#ffd1e8,#ff9ecf)}
.info{background:linear-gradient(180deg,#e8ecff,#c9d4ff)}

.segRow{display:flex;align-items:center;justify-content:center;padding-top:8px}
.seg{display:inline-flex;border:1px solid var(--edge);border-radius:999px;overflow:hidden;background:#0e1429}
.seg button{border:none;background:transparent;color:#aab3d6;padding:8px 14px;font-weight:700;font-size:12px}
.seg button.active{background:linear-gradient(180deg,#b5ffdf,#63ead9);color:#0b0f1c}

.vol{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--edge);background:#0e1429;color:#cfd7ff;font-size:12px}
@media (max-width:480px){
  .bigActions{flex-direction:column}
  .cta.main{width:min(92vw,420px)}
}

main{padding:12px;display:grid;gap:12px}.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--edge);border-radius:16px;padding:12px}
.progress{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px;justify-content:center}
.pill{position:relative;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);border-radius:999px;padding:6px 12px;background:#0e1429;font-size:12px;color:#cfd7ff;overflow:hidden}
.pill .bar{position:absolute;inset:0;background:linear-gradient(90deg,rgba(99,234,217,.22),rgba(99,234,217,0));transform-origin:left;transform:scaleX(var(--p))}

.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.card{position:relative;display:flex;gap:10px;padding:12px;border:1px solid var(--edge);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.014));animation:pop .28s}
@keyframes pop{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}
.rar{width:36px;text-align:center;font-size:22px}
.word{font-weight:900;font-size:18px;letter-spacing:.2px}.note{font-size:12px;color:#aab3d6;margin-top:2px}
.exp{font-size:12.5px;margin-top:6px;line-height:1.35}.exp.s{color:#ffe9a6}.exp.a{color:#ffd7a8}.exp.b{color:#bff6ef}.exp.c{color:#cfd7ff}.exp.d{color:#b9c1d6}.exp.x{color:#ffb4b4}
.new{font-size:10px;color:#111;background:linear-gradient(180deg,#b5ffdf,#63ead9);border-radius:999px;padding:2px 6px;margin-left:6px}
.s{border-color:#5a4300}.a{border-color:#6a3a00}.b{border-color:#0f5448}.c{border-color:#173a6e}.d{border-color:#2a3450}.x{border-color:#5a1a1a}
.rar.s{color:var(--gold)}.rar.a{color:var(--amber)}.rar.b{color:var(--aqua)}.rar.c{color:var(--blue)}.rar.d{color:var(--gray)}.rar.x{color:var(--bad)}
.srOverlay{position:fixed;inset:0;display:none;place-items:center;z-index:25;background:radial-gradient(70% 70% at 50% 50%,rgba(247,215,116,.12),rgba(247,215,116,0) 60%)}
.srOverlay.show{display:grid;animation:fadeOut 1600ms ease forwards}@keyframes fadeOut{0%{opacity:0}10%{opacity:1}100%{opacity:0}}
.srBadge{border:2px solid #f7d774;color:#0b0f1c;background:linear-gradient(180deg,#fff2b0,#f7d774);padding:10px 16px;border-radius:999px;font-weight:900;letter-spacing:.4px;box-shadow:0 10px 40px rgba(247,215,116,.35)}
.confetti{position:absolute;inset:0;pointer-events:none}.shard{position:absolute;width:9px;height:16px;opacity:0;animation:fall 1500ms ease-in forwards;border-radius:2px}
@keyframes fall{0%{opacity:0;transform:translateY(-20px) rotate(0)}10%{opacity:1}100%{opacity:1;transform:translateY(260px) rotate(360deg)}}
.summary{position:fixed;inset:0;display:none;place-items:center;z-index:26;background:rgba(0,0,0,.4)}.summary.show{display:grid}
.sumCard{background:linear-gradient(180deg,#1b2348,#111633);border:1px solid var(--edge);border-radius:16px;padding:16px;width:min(520px,92vw)}
.footer{color:#aab3d6;font-size:12px;padding:10px 14px 18px;text-align:center}
.bgmGrid{display:grid;gap:10px}.track{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--edge);border-radius:12px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.014))}
.meta{display:flex;align-items:center;gap:10px}.tag{font-size:10px;color:#0b0f1c;background:#b5ffdf;border-radius:999px;padding:2px 6px;font-weight:900}.lock{color:#ffd36b}

/* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞Â∫ÉÂëä */
.ad-float{position:fixed;right:16px;bottom:16px;z-index:9999;width:min(90vw,320px);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);overflow:hidden;backdrop-filter:saturate(1.1);animation:popIn .22s ease-out both}
.ad-float img{display:block;width:100%;height:auto}
.ad-close{position:absolute;top:6px;right:6px;width:28px;height:28px;border:none;border-radius:50%;background:rgba(0,0,0,.55);color:#fff;font-weight:700;cursor:pointer}
@media (min-width:1024px){.ad-float{width:300px}}
@keyframes popIn{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}

/* „Ç≥„É°„É≥„Éà„É¢„Éº„ÉÄ„É´ */
.cm-modal{position:fixed;inset:0;display:none;z-index:9998}
.cm-modal.show{display:block}
.cm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
.cm-dialog{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,560px);background:#0b1329;color:#e8f0ff;border:1px solid var(--edge);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:16px 18px 18px}
.cm-title{font-weight:900;letter-spacing:.06em;margin:2px 32px 8px 2px}
.cm-text{line-height:1.75;color:#b9c6ea;white-space:pre-wrap}
.cm-close{position:absolute;right:10px;top:10px;width:32px;height:32px;border-radius:8px;border:1px solid var(--edge);background:#0a1430;color:#e8f0ff;cursor:pointer;font-size:18px}
.cm-close:hover{filter:brightness(1.1)}
</style></head><body>
<header>
  <div class="titleRow"><div class="title">„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£</div><div class="ver">v4.7</div></div>

  <div class="ctrlRow">
    <div class="bigActions">
      <button class="cta main b1" id="roll1">ÂçòÁô∫„ÅßÂºï„Åè</button>
      <button class="cta main b5" id="roll5">5ÈÄ£„ÅßÂºï„Åè</button>
    </div>
    <div class="auxRow">
      <button class="cta bgm" id="bgmBtn">‚ô™ BGM OFF</button>
      <span class="vol"><span>Èü≥Èáè</span><input type="range" id="vol" min="0" max="1" step="0.01" value="0.35"></span>
      <button class="cta info" id="info">‚ÑπÔ∏è</button>
    </div>
  </div>

  <div class="segRow"><div class="seg">
    <button id="tabResults" class="active">ÈñãÂ∞ÅÁµêÊûú</button>
    <button id="tabCollection">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥</button>
    <button id="tabCPU">CPUÂØæÊà¶</button>
    <button id="tabBGM">BGM</button>
  </div></div>
</header>

<main>
  <section id="resultsPanel" class="panel">
    <div id="progress" class="progress"></div>
    <div id="cards" class="cards"></div>
  </section>
  <section id="collectionPanel" class="panel" style="display:none">
    <div id="counts" style="color:#aab3d6;font-size:12px;margin-bottom:8px"></div>
    <div id="collection" style="display:grid;gap:12px"></div>
  </section>
  <section id="bgmPanel" class="panel" style="display:none">
    <div style="font-weight:900;margin-bottom:8px">BGM „Çª„É¨„ÇØ„Çø„Éº</div>
    <div class="bgmGrid" id="bgmGrid"></div>
  </section>

  <div class="ad-float" role="dialog" aria-label="Â∫ÉÂëä„Éê„Éä„Éº">
    <a href="nekologia.html" target="_blank" rel="noopener">
      <img src="images/necologia_banner.jpg" alt="„Éç„Ç≥„É≠„Ç∏„Ç¢ | 9.31Áô∫Â£≤ DVD„Éª„Éñ„É´„Éº„É¨„Ç§">
    </a>
    <button class="ad-close" aria-label="Èñâ„Åò„Çã">√ó</button>
  </div>
</main>

<div class="footer">„ÅÇ„Å™„Åü„ÅÆÂ•Ω„Åç„Å™Ë®ÄËëâ„ÅØ‰Ωï„Åß„Åô„Åã„ÄÇ</div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop preload="auto"></audio>
<div id="srLayer" class="srOverlay" aria-hidden="true"><div class="srBadge">üåü S RARE!</div><div class="confetti" id="confetti"></div></div>
<div id="summary" class="summary" aria-hidden="true"><div class="sumCard"><div style="font-weight:900">ÈñãÂ∞Å„Åæ„Å®„ÇÅ</div><div id="sumText" style="color:#aab3d6;font-size:13px;margin-top:4px"></div><div id="sumRow" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div></div></div>
<div id="completeAll" class="summary" aria-hidden="true"><div class="sumCard"><div style="font-weight:900;font-size:18px">üéâ ÂÖ®„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Âà∂Ë¶áÔºÅ</div><div style="color:#aab3d6;font-size:13px;margin-top:4px">S„ÄúD„Å®X„Åæ„Åß„ÄÅ„Åô„Åπ„Å¶ÈõÜ„Åæ„Çä„Åæ„Åó„Åü„ÄÇ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div></div></div>
<div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111633;border:1px solid var(--edge);padding:10px 14px;border-radius:12px;display:none;z-index:40;box-shadow:0 10px 30px rgba(0,0,0,.35)"></div>

<div class="cm-modal" id="cmModal" aria-hidden="true">
  <div class="cm-backdrop" id="cmBackdrop"></div>
  <div class="cm-dialog" role="dialog" aria-modal="true" aria-labelledby="cmTitle">
    <button class="cm-close" id="cmClose" aria-label="Èñâ„Åò„Çã">√ó</button>
    <div class="cm-title" id="cmTitle"></div>
    <div class="cm-text" id="cmText"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* Â∫ÉÂëä„Éê„Éä„ÉºÈñâ„Åò„Çã */
document.querySelector('.ad-close')?.addEventListener('click', () => {
  document.querySelector('.ad-float')?.remove();
});

/* ====== „Éó„Éº„É´ÔºèÁ¢∫Áéá ====== */
const pools={S:["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº"],
A:["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","„Åù„Åº„Çç„Åî„ÅØ„Çì","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","‰πùÂìÅ‰ªè","„Åë„Çì„Å°„ÇìÊ±Å"],
B:["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","„Çø„É©„É≥„ÉÅ„É•„É©","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","„Éî„É≠„É™Ëèå","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","„Ç´„É©„É°„É´Ëâ≤Á¥†"],
C:["„Éê„Éì„É≠„É≥ÊçïÂõö","È≥•ÂèñÁ†Ç‰∏ò","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","Ê∏°Êù•‰∫∫","„Åï„Çã„Å≥„ÅÇ‰∏∏","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","„Éù„É™„Éó„É≠„Éî„É¨„É≥","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂"],
D:["„ÇØ„Éû„É≥„Éê„ÉÅ","ÁúåÂ∫ÅÊâÄÂú®Âú∞","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","„Çπ„É´„É°„Ç§„Ç´"],
X:["Êú¨Ë≥™","Ë¶ã„Åà„ÇãÂåñ","Ëá™ÂàÜ„Åî„Å®Âåñ","Ëß£ÂÉèÂ∫¶"]};
const probs={S:.02,A:.08,B:.20,C:.30,D:.30,X:.10};
const icons={S:"üåü",A:"üíé",B:"üî∑",C:"üîπ",D:"üî∏",X:"‚ùå"};
const classes={S:"s",A:"a",B:"b",C:"c",D:"d",X:"x"};

/* ====== „Ç≥„É°„É≥„Éà ====== */
const exp={
  "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"Â£∞„Å´Âá∫„Åó„Å¶Ë™≠„Åø„Åü„ÅÑÊó•Êú¨Ë™û„É©„É≥„Ç≠„É≥„Ç∞Á¨¨1‰Ωç„ÄÇ",
  "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"Ë™∞„ÇÇ„Åå‰∫∫Áîü„Åß‰∏ÄÂ∫¶„ÅØÂ∞±‰ªª„Åó„Å¶„Åø„Åü„ÅÑÊÜß„Çå„ÅÆËÇ©Êõ∏„Åç„ÄÇ",
  "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"Ê≤ñÁ∏Ñ„ÅÆ„Ç≠„ÉÉ„ÉÅ„É≥„Åã„ÇâÂ±ä„Åè„ÄÅÁàΩ„ÇÑ„Åã„Å™„Åè„ÇäËøî„ÅóË®ÄËëâ„ÄÇ",
  "„Åù„Åº„Çç„Åî„ÅØ„Çì":"Âè£„ÅÆ‰∏≠„Çí‰ΩìÁèæ„Åó„Åü„Çà„ÅÜ„Å™Ë™ûÊÑü„ÄÇ",
  "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"ÂêçÂâç„Åã„Çâ„Éì„Ç∑„Éì„Ç∑„Å®‰ºù„Çè„Å£„Å¶„Åè„ÇãÂ®ÅÂé≥„ÄÇ„Åè„Çå„Åê„Çå„ÇÇVIPÂæÖÈÅá„Åß„ÄÇ",
  "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"ÊØõ„ÅØÁü•„Å£„Å¶„Çã„Åë„Å©„ÄÅ„ÇÄ„Åè„Åò„ÇÉ„Çâ„Å£„Å¶‰Ωï„Å™„ÅÆ„Åï„ÄÇ",
  "‰πùÂìÅ‰ªè":"Èõ£Ë™≠Âú∞Âêç„ÅåÁπî„Çä„Å™„Åô„É™„Ç∫„É†„ÄÇ",
  "„Åë„Çì„Å°„ÇìÊ±Å":"Èüø„Åç„Å†„Åë„Åß„ÄÅ„ÇÇ„ÅÜ„ÅÇ„Å£„Åü„Åã„ÅÑ„ÄÇ",
  "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"ÂØíÊ∞ó„Å®ÁÜ±Ê∞ó„ÅåÂêåÂ±Ö„Åô„ÇãÊ•µÊù±„ÅÆÂú∞„Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ",
  "„Çø„É©„É≥„ÉÅ„É•„É©":"„Éï„Ç°„É≥„Ç∑„Éº„Å™„ÅäËèìÂ≠ê„Åø„Åü„ÅÑ„ÄÇÁåõÊØíÁ≥ª„Çπ„Ç§„Éº„ÉÑ„ÄÇ",
  "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"ÈñìÊäú„Åë„ÅÆÈ≥•„Å´„ÅØÈñìÊäú„Åë„Å™Ë™ûÊÑü„ÄÇ",
  "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"„Åæ„Çã„ÅßÂë™Êñá„ÄÇ",
  "„Éî„É≠„É™Ëèå":"ÂèØÊÑõ„ÅÑ„Åµ„Çä„Åó„Å¶„Çè„Çä„Å®„ÇÑ„Çã„ÇÇ„Çì„Å†„Å≠„ÄÇ",
  "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"ÂÆπËµ¶„Å™„ÅÑÊøÅÈü≥„Å®„Éà„ÅÆÂøúÈÖ¨„ÄÇ",
  "„Ç´„É©„É°„É´Ëâ≤Á¥†":"„Åä„ÇÑ„Å§„ÅÆË®òÊÜ∂„Å´„É©„Éú„ÅÆÂåÇ„ÅÑ„ÄÇ",
  "„Éê„Éì„É≠„É≥ÊçïÂõö":"„ÅÑ„Åã„Å´„ÇÇÊçï„Åæ„Å£„Åü„ÅÅ„Å£„Å¶ÊÑü„Åò„ÄÇ",
  "È≥•ÂèñÁ†Ç‰∏ò":"ËçíÈáé„ÇíÂ≠êÈü≥„ÅåË∑≥„Å≠Âõû„Çã„ÄÇ",
  "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"Ë®ÄËëâ„Å´Ëàê„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ",
  "Ê∏°Êù•‰∫∫":"ÊúùÈÆÆÂçäÂ≥∂„Åã„Çâ„ÅÆÊåëÊà¶„ÄÇ",
  "„Åï„Çã„Å≥„ÅÇ‰∏∏":"Èñì„ÅÆÊäú„Åë„ÅüÊóÖ„Å´„Å™„Çä„Åù„ÅÜ„ÄÇ",
  "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"ÂîêËæõÂ≠ê„ÅåË∫çÂãï„Åô„ÇãÂè£ÂÜÖ„ÄÇ",
  "„Éù„É™„Éó„É≠„Éî„É¨„É≥":"ÂçäÊøÅÈü≥„ÅÆÁéãÊßò„ÄÇ",
  "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"„Åï„Çâ„Å£„Å®Âßã„Åæ„Å£„Åü„ÅØ„Åö„Å†„Å£„Åü„ÅÆ„Å´„ÄÇ",
  "„ÇØ„Éû„É≥„Éê„ÉÅ":"„Äå„Çì„Äç„ÅÆÂ¶ô„ÄÇ","ÁúåÂ∫ÅÊâÄÂú®Âú∞":"Â†Ç„ÄÖ„Å®„Åó„Å¶„Çã„Çà„Å≠„ÄÇ","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"ÁîòËæõ„Éì„Éº„Éà„Å´‰πó„Å£„Å°„ÇÉ„Å£„Å¶„ÄÇ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"„Ç™„Çª„É≠„Å†„Å£„Åü„ÇâÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„ÄÇ","„Çπ„É´„É°„Ç§„Ç´":"Âôõ„ÇÅ„Å∞Âôõ„ÇÄ„Åª„Å©Âë≥„ÅåÂá∫„ÇãÂêçÂâç„ÄÇ",
  "Êú¨Ë≥™":"„Åü„Å®„Åà„ÅÇ„Å£„Åü„Å®„Åó„Å¶„ÇÇ„ÄÅËªΩ„ÄÖ„Åó„ÅèÂè£„Å´Âá∫„Åô„Çà„ÅÜ„Å™‰∫∫„ÅØ‰∏ÄÁîüËøë„Å•„Åë„Å™„ÅÑ„Å®ÊÄù„ÅÜ„Çì„Åß„Åô„ÄÇ",
  "Ë¶ã„Åà„ÇãÂåñ":"ÂèØË¶ñÂåñ„Å£„Å¶Áü•„Å£„Å¶„Åæ„Åô„Åã„ÄÇ","Ëá™ÂàÜ„Åî„Å®Âåñ":"„ÄåËá™ÂàÜ„Åî„Å®„Äç„Åß„ÇÇÂ´å„Å™„ÅÆ„Å´„ÄÅ„ÄåÂåñ„Äç„Åæ„Åß„Å§„Åë„Çâ„Çå„ÅüÊó•„Å´„ÅØ‚Ä¶","Ëß£ÂÉèÂ∫¶":"„Å™„Çã„Åª„Å©„ÄÅ„Éî„ÇØ„Çª„É´Êï∞„ÅåÈ´ò„Åæ„Çä„Åæ„Åó„ÅüÔºÅ"
};

/* ====== „Çπ„Éà„É¨„Éº„Ç∏ ====== */
const storeSeen="kotoba_collection_seen_v4_7";
const storeBGM="kotoba_bgm_selected_v4_7";
const seen=new Set(JSON.parse(localStorage.getItem(storeSeen)||"[]"));
let selectedBGM=localStorage.getItem(storeBGM)||"default";
const tiers=["S","A","B","C","D","X"];

/* ====== DOMÂèÇÁÖß ====== */
const cards=document.getElementById('cards');
const progress=document.getElementById('progress');
const counts=document.getElementById('counts');
const collectionBox=document.getElementById('collection');
const resultsPanel=document.getElementById('resultsPanel');
const collectionPanel=document.getElementById('collectionPanel');
const bgmPanel=document.getElementById('bgmPanel');
const tabResults=document.getElementById('tabResults');
const tabCollection=document.getElementById('tabCollection');
const tabBGM=document.getElementById('tabBGM');
const tabCPU=document.getElementById('tabCPU');
const toastEl=document.getElementById('toast');

/* ====== BGM ====== */
const bgmEl=document.getElementById('bgm');
const bgmBtn=document.getElementById('bgmBtn');
const vol=document.getElementById('vol');
let bgmOn=false;
bgmEl.volume=parseFloat(vol.value);
vol.addEventListener('input',()=>bgmEl.volume=parseFloat(vol.value));
bgmBtn.addEventListener('click',async()=>{bgmOn=!bgmOn;bgmBtn.textContent=bgmOn?"‚ô™ BGM ON":"‚ô™ BGM OFF";try{bgmOn?await bgmEl.play():bgmEl.pause();}catch(e){}});

/* ====== ÂäπÊûúÈü≥ÔºàÈÄöÁü•„Éú„Çø„É≥ÂâäÈô§„Å´‰º¥„ÅÑËá™ÂãïONÂõ∫ÂÆö„ÄÅ„Ç¨„Éº„Éâ‰ªò„ÅçÔºâ ====== */
let audioEnabled=true;let audioCtx=null;
const soundBtn=document.getElementById('sound');
if(soundBtn){
  soundBtn.addEventListener('click',()=>{audioEnabled=!audioEnabled;soundBtn.textContent=audioEnabled?"üîä ON":"üîá OFF";if(audioEnabled) getCtx();});
}
function getCtx(){if(!audioEnabled)return null;if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==="suspended")audioCtx.resume();return audioCtx;}
function tone(f=880,d=0.15,t='triangle',v=0.15){const c=getCtx();if(!c)return;const o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.0001,c.currentTime);g.gain.exponentialRampToValueAtTime(v,c.currentTime+0.02);o.start();g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+d);o.stop(c.currentTime+d+0.02);}
function chimeLong(){tone(659,0.14);setTimeout(()=>tone(880,0.18),140);setTimeout(()=>tone(1047,0.22),320);setTimeout(()=>tone(1319,0.26),520);}
function drawSfx(i){tone(420+i*40,0.10,'square',0.12);}
function duck(fn){const b=bgmEl.volume;bgmEl.volume=Math.max(0,b*0.6);setTimeout(()=>{bgmEl.volume=parseFloat(vol.value);},700);fn&&fn();}

/* ====== SÊºîÂá∫ ====== */
const srLayer=document.getElementById('srLayer');const confetti=document.getElementById('confetti');
function showSOverlay(){srLayer.classList.remove('show');confetti.innerHTML="";
const palette=["#f7d774","#ff8bd1","#63ead9","#8fb1ff","#fff07a","#ff6b6b"];
for(let i=0;i<110;i++){const s=document.createElement('div');s.className='shard';
s.style.left=(5+Math.random()*90)+"%";s.style.top=(-10-Math.random()*40)+"px";
s.style.background=palette[Math.floor(Math.random()*palette.length)];
s.style.animationDelay=(Math.random()*0.6)+"s";confetti.appendChild(s);}
srLayer.classList.add('show');duck(chimeLong);setTimeout(()=>srLayer.classList.remove('show'),1600);}

/* ====== UIË£úÂä© ====== */
function toast(msg){toastEl.textContent=msg;toastEl.style.display='block';toastEl.style.opacity='0';toastEl.style.transition='opacity .2s';requestAnimationFrame(()=>toastEl.style.opacity='1');setTimeout(()=>{toastEl.style.opacity='0';setTimeout(()=>toastEl.style.display='none',200)},1600);}
function hasTier(t){return pools[t].every(w=>seen.has(w));}

/* ====== ÈÄ≤Êçó ====== */
function renderProgress(){
  progress.innerHTML=tiers.map(t=>{
    const tot=pools[t].length;const have=pools[t].filter(w=>seen.has(w)).length;const p=tot?(have/tot):0;
    return `<span class="pill" style="--p:${p}"><span class="bar"></span><span>${icons[t]}</span>${t} ${have}/${tot}</span>`;
  }).join("");
}

/* ====== „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ ====== */
function renderCollection(){
  const by={S:[],A:[],B:[],C:[],D:[],X:[]};
  for(const t of tiers){for(const w of pools[t]) if(seen.has(w)) by[t].push(w);}
  const total=Object.values(by).reduce((a,x)=>a+x.length,0);
  counts.textContent=`„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ôºö${total}Êûö / S:${by.S.length} A:${by.A.length} B:${by.B.length} C:${by.C.length} D:${by.D.length} X:${by.X.length}`;
  collectionBox.innerHTML="";
  for(const t of tiers){
    const sec=document.createElement('div');
    const h=document.createElement('div');h.style.fontSize="13px";h.style.color="#aab3d6";h.style.margin="6px 0 4px";h.textContent=`${t}„É©„É≥„ÇØ`;sec.appendChild(h);
    const row=document.createElement('div');row.style.display="flex";row.style.flexWrap="wrap";row.style.gap="8px";sec.appendChild(row);
    const arr=by[t];
    if(arr.length===0){
      const tag=document.createElement('div');tag.className='pill';tag.textContent="‚Äî Êú™ÂÖ•Êâã ‚Äî";row.appendChild(tag);
    }else{
      for(const w of arr){
        const tag=document.createElement('div');
        tag.className='pill collection-item';
        tag.dataset.word = w;
        tag.tabIndex = 0;
        tag.setAttribute('role','button');
        tag.setAttribute('aria-label', `${w} „ÅÆ„Ç≥„É°„É≥„Éà„ÇíÈñã„Åè`);
        tag.innerHTML=`<span>${icons[t]}</span>${w}`;
        row.appendChild(tag);
      }
    }
    collectionBox.appendChild(sec);
  }
}

/* ====== BGM„Çø„Éñ ====== */
const bgmGrid=document.getElementById('bgmGrid');
function bgmTracks(){
  return [
    {id:"default",name:"„Éí„Éó„Éä„Ç¥„Ç∏„Ç¢Èü≥È†≠",tier:"FREE",unlocked:true,src:"audio/Hypnagogiaondo.mp3"},
    {id:"kingyobachi",name: hasTier("S")?"ÈáëÈ≠öÈâ¢":"ÔºüÔºüÔºü",tier:"S",unlocked:hasTier("S"),src:"audio/Kingyobachi.mp3"},
    {id:"kuganebutsu",name: hasTier("A")?"‰πùÂìÅ‰ªèÂ•áË≠ö":"ÔºüÔºüÔºü",tier:"A",unlocked:hasTier("A"),src:"audio/Kuhonbutsukitan.mp3"},
    {id:"necology",name: hasTier("B")?"„Éç„Ç≥„É≠„Ç∏„Ç¢":"ÔºüÔºüÔºü",tier:"B",unlocked:hasTier("B"),src:"audio/Nekologia.mp3"},
    {id:"kingyobachi_chorus",name: (["S","A","B","C","D","X"].every(t=>hasTier(t)))?"ÈáëÈ≠öÈâ¢ÔºàÂêàÂî±ver.Ôºâ":"ÔºüÔºüÔºü",tier:"ALL",unlocked:["S","A","B","C","D","X"].every(t=>hasTier(t)),src:"audio/Kingyobachi_chorus.mp3"},
  ];
}
function renderBGMTab(){
  bgmGrid.innerHTML="";
  bgmTracks().forEach(tr=>{
    const wrap=document.createElement('div');wrap.className='track';
    const left=document.createElement('div');left.className='meta';
    const badge=document.createElement('span');badge.className='tag';badge.textContent=(tr.tier==='FREE'?'FREEËß£Êîæ':tr.tier+' ÂÆå‰∫Ü„ÅßËß£Êîæ');
    const name=document.createElement('div');name.style.fontWeight='900';name.textContent=tr.name+(selectedBGM===tr.id?'ÔºàÈÅ∏Êäû‰∏≠Ôºâ':'');
    left.appendChild(badge);left.appendChild(name);wrap.appendChild(left);
    const right=document.createElement('div');right.style.display='flex';right.style.gap='8px';
    if(tr.unlocked){
      const sel=document.createElement('button');sel.className='cta b5';sel.textContent='ÈÅ∏Êäû';
      sel.onclick=()=>{switchBGM(tr.id,tr.src);renderBGMTab();toast('BGM„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü');};
      right.appendChild(sel);
    }else{
      const lock=document.createElement('div');lock.className='lock';lock.textContent='üîí Êú™Ëß£Êîæ'; right.appendChild(lock);
    }
    wrap.appendChild(right);bgmGrid.appendChild(wrap);
  });
}
function switchBGM(id,src){
  if(!src){
    const map={default:"audio/Hypnagogiaondo.mp3","kingyobachi":"audio/Kingyobachi.mp3","kuganebutsu":"audio/Kuhonbutsukitan.mp3","necology":"audio/Nekologia.mp3","kingyobachi_chorus":"audio/Kingyobachi_chorus.mp3"};
    src=map[id]||map.default;
  }
  bgmEl.pause(); bgmEl.src=src; if(bgmOn){bgmEl.play().catch(()=>{});} selectedBGM=id; localStorage.setItem(storeBGM,id);
}

/* ====== ÊäΩÈÅ∏ ====== */
function saveSeen(w){seen.add(w);localStorage.setItem(storeSeen,JSON.stringify([...seen]));}
function pickTier(){const r=Math.random();let a=0;for(const k of ["S","A","B","C","D","X"]){a+=probs[k];if(r<a)return k;}return "D";}
function pickWord(t){const a=pools[t];return a[Math.floor(Math.random()*a.length)];}
function addCard(t,w){
  const prev=pools[t].filter(x=>seen.has(x)).length;
  const c=document.createElement('div');c.className=`card ${classes[t]}`;
  const icon=document.createElement('div');icon.className=`rar ${classes[t]}`;icon.textContent=icons[t];
  const b=document.createElement('div');const wd=document.createElement('div');wd.className='word';wd.textContent=w;
  const n=document.createElement('div');n.className='note';n.textContent=`${t}„É©„É≥„ÇØ`;
  b.appendChild(wd);b.appendChild(n);
  const e=document.createElement('div');e.className='exp '+classes[t];e.textContent=exp[w]||"Ë™ûÊÑü„Å´Ëß¶„Çå„ÇãÂñú„Å≥„ÄÇ";b.appendChild(e);
  if(!seen.has(w)){const nm=document.createElement('span');nm.className='new';nm.textContent="New";wd.appendChild(nm);}
  c.appendChild(icon);c.appendChild(b);cards.prepend(c);
  saveSeen(w);
  if(t==='S')showSOverlay();
  tryCompleteTier(t,prev);
  renderProgress();
}
function openOnce(i=0){const t=pickTier();const w=pickWord(t);addCard(t,w);drawSfx(i);return [t,w];}
function openMulti(n){
  let i=0;const rs=[];
  const step=()=>{if(i>=n){showSummary(rs);checkCompleteAll();return;}
    const r=openOnce(i);rs.push(r);i++;setTimeout(step,720)};
  step();
}

/* ====== „Åæ„Å®„ÇÅË°®Á§∫ ====== */
const summary=document.getElementById('summary');const sumText=document.getElementById('sumText');const sumRow=document.getElementById('sumRow');
function showSummary(items){
  const cnt=items.reduce((m,[t])=>(m[t]=(m[t]||0)+1,m),{});
  sumText.textContent=`S:${cnt.S||0} / A:${cnt.A||0} / B:${cnt.B||0} / C:${cnt.C||0} / D:${cnt.D||0} / X:${cnt.X||0}`;
  sumRow.innerHTML="";
  items.forEach(([t,w])=>{const d=document.createElement('div');d.className='pill';d.innerHTML=`<span>${icons[t]}</span>${w}`;sumRow.appendChild(d);});
  summary.classList.add('show');setTimeout(()=>summary.classList.remove('show'),1600);
}

/* ====== „Ç≥„É≥„Éó„É™„Éº„ÉàÂà§ÂÆö ====== */
const completeAll=document.getElementById('completeAll');
const unlock={FREE:true,S:false,A:false,B:false,ALL:false};
function tryCompleteTier(tier,prev){
  if(!["S","A","B","C","D","X"].includes(tier))return;
  const tot=pools[tier].length;const now=pools[tier].filter(w=>seen.has(w)).length;
  if(prev<tot && now===tot){
    if(!unlock[tier]){
      unlock[tier]=true;
      if(tier==="S"||tier==="A"||tier==="B"){
        const name=tier==="S"?"ÈáëÈ≠öÈâ¢":tier==="A"?"‰πùÂìÅ‰ªèÂ•áË≠ö":"„Éç„Ç≥„É≠„Ç∏„Ç¢";
        toast(`Êñ∞„Åó„ÅÑBGM„Äå${name}„Äç„ÅåÈñãÊîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ`);
        duck(chimeLong);
        renderBGMTab();
      }
    }
    const ov=document.createElement('div');ov.className='summary show';
    ov.innerHTML=`<div class="sumCard"><div style="font-weight:900">${tier}„É©„É≥„ÇØ „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ</div><div style="color:#aab3d6;font-size:13px;margin-top:4px">ÂÖ®${tot}Êûö„ÇíÁç≤Âæó„Åó„Åæ„Åó„Åü„ÄÇ</div></div>`;
    document.body.appendChild(ov);setTimeout(()=>ov.remove(),1600);
  }
}
function checkCompleteAll(){
  const all=["S","A","B","C","D","X"].every(t=>hasTier(t));
  if(all){
    completeAll.classList.add('show');
    duck(()=>{chimeLong();setTimeout(chimeLong,700)});
    setTimeout(()=>completeAll.classList.remove('show'),2200);
    toast('Êñ∞„Åó„ÅÑBGM„ÄåÈáëÈ≠öÈâ¢ÔºàÂêàÂî±ver.Ôºâ„Äç„ÅåÈñãÊîæ„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
    switchBGM('kingyobachi_chorus');
    renderBGMTab();
  }
}

/* ====== „Çø„Éñ ====== */
tabResults.onclick=()=>{resultsPanel.style.display="block";collectionPanel.style.display="none";bgmPanel.style.display="none";tabResults.classList.add('active');tabCollection.classList.remove('active');tabBGM.classList.remove('active');};
tabCollection.onclick=()=>{renderCollection();resultsPanel.style.display="none";collectionPanel.style.display="block";bgmPanel.style.display="none";tabCollection.classList.add('active');tabResults.classList.remove('active');tabBGM.classList.remove('active');};
/* ËøΩÂä†ÔºöCPUÂØæÊà¶„ÅØÊñ∞Ë¶è„Çø„Éñ„ÅßÈÅ∑Áßª */
tabCPU.onclick=()=>{window.open("https://kyoryu1039.github.io/kotoba-gacha/kotobattle","_blank","noopener");};
tabBGM.onclick=()=>{renderBGMTab();resultsPanel.style.display="none";collectionPanel.style.display="none";bgmPanel.style.display="block";tabBGM.classList.add('active');tabResults.classList.remove('active');tabCollection.classList.remove('active');};

/* ====== „Éú„Çø„É≥ ====== */
document.getElementById('roll1').onclick=async()=>{if(bgmOn){try{await bgmEl.play()}catch(e){}} openOnce(0);};
document.getElementById('roll5').onclick=async()=>{if(bgmOn){try{await bgmEl.play()}catch(e){}} openMulti(5);};
/* ÂâäÈô§: „ÇØ„É™„Ç¢„Éú„Çø„É≥ */
const clearBtn=document.getElementById('clear');
if(clearBtn){
  clearBtn.onclick=()=>{cards.innerHTML="";localStorage.setItem(storeSeen,JSON.stringify([]));seen.clear();renderProgress();renderBGMTab();renderCollection();toast('„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');};
}
document.getElementById('info').onclick=()=>alert("ÊéíÂá∫ÁéáÔºöS2% A8% B20% C30% D30% X10%\nÁ´ØÊú´ÂÜÖ„Å´„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Çí‰øùÂ≠ò„Åó„Åæ„ÅôÔºàlocalStorageÔºâ„ÄÇ\nÈü≥„ÅåÂá∫„Å™„ÅÑÊôÇ„ÅØ„Äå‚ô™ BGM ON„Äç„ÇíÊäº„Åó„Å¶„Å≠„ÄÇ");

/* ====== „Ç≥„É°„É≥„Éà„É¢„Éº„ÉÄ„É´ ====== */
const cmModal=document.getElementById('cmModal');
const cmTitle=document.getElementById('cmTitle');
const cmText=document.getElementById('cmText');
const cmClose=document.getElementById('cmClose');
const cmBack =document.getElementById('cmBackdrop');

function openComment(word){
  cmTitle.textContent = word;
  cmText.textContent  = exp[word] ?? "Ôºà„Ç≥„É°„É≥„ÉàÊú™ÁôªÈå≤Ôºâ";
  cmModal.classList.add('show');
  cmModal.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}
function closeComment(){
  cmModal.classList.remove('show');
  cmModal.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
}
cmClose?.addEventListener('click',closeComment);
cmBack ?.addEventListener('click',closeComment);
document.addEventListener('keydown',e=>{if(e.key==='Escape') closeComment();});

/* „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Ê¨Ñ„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´ */
collectionBox.addEventListener('click',e=>{
  const el=e.target.closest('.collection-item');
  if(!el) return;
  openComment(el.dataset.word);
});
collectionBox.addEventListener('keydown',e=>{
  if(e.key!=='Enter' && e.key!==' ') return;
  const el=e.target.closest('.collection-item');
  if(!el) return;
  e.preventDefault();
  openComment(el.dataset.word);
});

/* ====== ÂàùÊúüÊèèÁîª ====== */
(function init(){
  renderProgress();renderCollection();renderBGMTab();
  if(selectedBGM!=="default") switchBGM(selectedBGM);
})();
}); /* DOMContentLoaded */
</script>
</body></html>
