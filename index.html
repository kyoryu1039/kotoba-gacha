<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ã“ã¨ã°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¬ãƒãƒ£ â€” Hypnagogia Edition v4.7</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f1c">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{--bg:#0b0f1c;--ink:#eef2ff;--muted:#aab3d6;--panel:#12172b;--edge:#1d2a55;--gold:#f7d774;--amber:#ffbd63;--aqua:#63ead9;--blue:#8fb1ff;--gray:#94a3b8;--bad:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;color:var(--ink);background:
  radial-gradient(1200px 800px at 80% -20%, rgba(255,255,255,.04), transparent 60%),
  radial-gradient(1000px 800px at 10% 0%, #121a3b, #0b0f1c 60%);
  font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:linear-gradient(180deg,rgba(10,14,28,.9),rgba(10,14,28,.65));border-bottom:1px solid var(--edge);padding:8px 10px 12px}
.titleRow{display:flex;align-items:center;justify-content:center;gap:8px}
.title{font-weight:900;letter-spacing:.3px;font-size:18px;white-space:nowrap;max-width:80vw;text-overflow:ellipsis;overflow:hidden}
.ver{font-size:10px;color:#0b0f1c;background:linear-gradient(180deg,#b5ffdf,#63ead9);border-radius:999px;padding:3px 8px;font-weight:900}
  
/* === ä¸»å½¹ãƒœã‚¿ãƒ³ === */
button.cta.main{font-size:15px;padding:10px 16px;border-radius:12px;border:none;position:relative;overflow:hidden;color:#081224;font-weight:900;cursor:pointer;background:linear-gradient(180deg,#ffd36b,#f0b100);box-shadow:0 6px 16px rgba(0,0,0,.35);transition:transform .1s,filter .25s;flex:1}
button.cta.main.b5{background:linear-gradient(180deg,#a4d7ff,#5cc6ff)}
button.cta.main:hover{filter:brightness(1.08);transform:translateY(-1px)}
button.cta.main::before{content:"";position:absolute;top:0;left:-50%;width:200%;height:100%;
  background:linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.4) 50%,rgba(255,255,255,0) 100%);
  transform:skewX(-20deg);animation:shine 3s infinite}
@keyframes shine{0%{left:-120%}50%{left:120%}100%{left:120%}}

/* è£œåŠ© */
.ctrlRow{margin-top:8px;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center}
.bigActions{display:flex;gap:10px;justify-content:center;width:100%}
.auxRow{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:8px}
button.cta{appearance:none;border:none;cursor:pointer;font-weight:900;letter-spacing:.2px;border-radius:12px;transition:transform .08s}
button.cta:active{transform:translateY(1px) scale(.99)}
.bgm{background:linear-gradient(180deg,#ffd1e8,#ff9ecf)}
.info{background:linear-gradient(180deg,#e8ecff,#c9d4ff)}

.segRow{display:flex;align-items:center;justify-content:center;padding-top:8px}
.seg{display:inline-flex;border:1px solid var(--edge);border-radius:999px;overflow:hidden;background:#0e1429}
.seg button{border:none;background:transparent;color:#aab3d6;padding:8px 14px;font-weight:700;font-size:10px}
.seg button.active{background:linear-gradient(180deg,#b5ffdf,#63ead9);color:#0b0f1c}

.vol{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--edge);background:#0e1429;color:#cfd7ff;font-size:12px}
@media (max-width:480px){.bigActions{flex-direction:column}.cta.main{width:min(92vw,420px)}}

main{padding:12px;display:grid;gap:12px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--edge);border-radius:16px;padding:12px}
.progress{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px;justify-content:center}
.pill{position:relative;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);border-radius:999px;padding:6px 12px;background:#0e1429;font-size:12px;color:#cfd7ff;overflow:hidden}
.pill .bar{position:absolute;inset:0;background:linear-gradient(90deg,rgba(99,234,217,.22),rgba(99,234,217,0));transform-origin:left;transform:scaleX(var(--p))}

.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.card{position:relative;display:flex;gap:10px;padding:12px;border:1px solid var(--edge);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.014));animation:pop .28s}
@keyframes pop{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}
.rar{width:36px;text-align:center;font-size:22px}
.word{font-weight:900;font-size:18px;letter-spacing:.2px}.note{font-size:12px;color:#aab3d6;margin-top:2px}
.exp{font-size:12.5px;margin-top:6px;line-height:1.35}.exp.s{color:#ffe9a6}.exp.a{color:#ffd7a8}.exp.b{color:#bff6ef}.exp.c{color:#cfd7ff}.exp.d{color:#b9c1d6}.exp.x{color:#ffb4b4}
.new{font-size:10px;color:#111;background:linear-gradient(180deg,#b5ffdf,#63ead9);border-radius:999px;padding:2px 6px;margin-left:6px}
.s{border-color:#5a4300}.a{border-color:#6a3a00}.b{border-color:#0f5448}.c{border-color:#173a6e}.d{border-color:#2a3450}.x{border-color:#5a1a1a}
.rar.s{color:var(--gold)}.rar.a{color:var(--amber)}.rar.b{color:var(--aqua)}.rar.c{color:var(--blue)}.rar.d{color:var(--gray)}.rar.x{color:var(--bad)}
.srOverlay{position:fixed;inset:0;display:none;place-items:center;z-index:25;background:radial-gradient(70% 70% at 50% 50%,rgba(247,215,116,.12),rgba(247,215,116,0) 60%)}
.srOverlay.show{display:grid;animation:fadeOut 1600ms ease forwards}
@keyframes fadeOut{0%{opacity:0}10%{opacity:1}100%{opacity:0}}
.srBadge{border:2px solid #f7d774;color:#0b0f1c;background:linear-gradient(180deg,#fff2b0,#f7d774);padding:10px 16px;border-radius:999px;font-weight:900;letter-spacing:.4px;box-shadow:0 10px 40px rgba(247,215,116,.35)}
.confetti{position:absolute;inset:0;pointer-events:none}.shard{position:absolute;width:9px;height:16px;opacity:0;animation:fall 1500ms ease-in forwards;border-radius:2px}
@keyframes fall{0%{opacity:0;transform:translateY(-20px) rotate(0)}10%{opacity:1}100%{opacity:1;transform:translateY(260px) rotate(360deg)}}
.summary{position:fixed;inset:0;display:none;place-items:center;z-index:26;background:rgba(0,0,0,.4)}.summary.show{display:grid}
.sumCard{background:linear-gradient(180deg,#1b2348,#111633);border:1px solid var(--edge);border-radius:16px;padding:16px;width:min(520px,92vw)}
.footer{color:#aab3d6;font-size:12px;padding:10px 14px 18px;text-align:center}
.bgmGrid{display:grid;gap:10px}
.track{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--edge);border-radius:12px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.014))}
.meta{display:flex;align-items:center;gap:10px}
.tag{font-size:10px;color:#0b0f1c;background:#b5ffdf;border-radius:999px;padding:2px 6px;font-weight:900}
.lock{color:#ffd36b}

/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åºƒå‘Š */
.ad-float{position:fixed;right:16px;bottom:16px;z-index:9999;width:min(90vw,320px);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);overflow:hidden;backdrop-filter:saturate(1.1);animation:popIn .22s ease-out both}
.ad-float img{display:block;width:100%;height:auto}
.ad-close{position:absolute;top:6px;right:6px;width:28px;height:28px;border:none;border-radius:50%;background:rgba(0,0,0,.55);color:#fff;font-weight:700;cursor:pointer}
@media (min-width:1024px){.ad-float{width:300px}}
@keyframes popIn{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
.cm-modal{position:fixed;inset:0;display:none;z-index:9998}
.cm-modal.show{display:block}
.cm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
.cm-dialog{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,560px);background:#0b1329;color:#e8f0ff;border:1px solid var(--edge);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:16px 18px 18px}
.cm-title{font-weight:900;letter-spacing:.06em;margin:2px 32px 8px 2px}
.cm-text{line-height:1.75;color:#b9c6ea;white-space:pre-wrap}
.cm-close{position:absolute;right:10px;top:10px;width:32px;height:32px;border-radius:8px;border:1px solid var(--edge);background:#0a1430;color:#e8f0ff;cursor:pointer;font-size:18px}
.cm-close:hover{filter:brightness(1.1)}

/* Infoç”¨ã¡ã‚‡ã„è£…é£¾ */
.infoLead{font-weight:900;font-size:16px;margin:6px 0 10px}
.infoGrid{display:grid;gap:10px}
.infoBox{border:1px solid var(--edge);border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02))}
.infoBox h3{margin:0 0 6px;font-size:14px}
.infoSmall{color:#aab3d6;font-size:12px;line-height:1.7}
.badgeSoft{display:inline-block;padding:2px 8px;border-radius:999px;background:linear-gradient(180deg,#b5ffdf,#63ead9);color:#082235;font-weight:900;font-size:11px;margin-right:6px}
</style></head>
<body>
<header>
  <div class="titleRow"><div class="title">ã“ã¨ã°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¬ãƒãƒ£</div><div class="ver">v4.7</div></div>

  <div class="ctrlRow">
    <div class="bigActions">
      <button class="cta main b1" id="roll1">å˜ç™ºã§å¼•ã</button>
      <button class="cta main b5" id="roll5">5é€£ã§å¼•ã</button>
    </div>
    <div class="auxRow">
      <button class="cta bgm" id="bgmBtn">â™ª BGM OFF</button>
      <span class="vol"><span>éŸ³é‡</span><input type="range" id="vol" min="0" max="1" step="0.01" value="0.35"></span>
      <button class="cta info" id="info">â„¹ï¸</button>
    </div>
  </div>

  <div class="segRow"><div class="seg">
    <button id="tabResults" class="active">é–‹å°çµæœ</button>
    <button id="tabCollection">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</button>
    <button id="tabCPU">CPUå¯¾æˆ¦</button>
    <button id="tabBGM">BGM</button>
    <button id="tabInfo">Info</button><!-- â† è¿½åŠ  -->
  </div></div>
</header>

<main>
  <section id="resultsPanel" class="panel">
    <div id="progress" class="progress"></div>
    <div id="cards" class="cards"></div>
  </section>

  <section id="collectionPanel" class="panel" style="display:none">
    <div id="counts" style="color:#aab3d6;font-size:12px;margin-bottom:8px"></div>
    <div id="collection" style="display:grid;gap:12px"></div>
  </section>

  <section id="bgmPanel" class="panel" style="display:none">
    <div style="font-weight:900;margin-bottom:8px">BGM ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</div>
    <div class="bgmGrid" id="bgmGrid"></div>
  </section>

  <!-- â–¼ æ–°è¦ï¼šInfo ãƒšãƒ¼ã‚¸ï¼ˆåŒä¸€URLå†…ã§åˆ‡æ›¿ï¼‰ -->
  <section id="infoPanel" class="panel" style="display:none">
    <div class="infoLead"><span class="badgeSoft">Info</span>ã“ã¨ã°å‹Ÿé›†ä¸­</div>
    <div class="infoGrid">
      <div class="infoBox">
        <h3>ã“ã¨ã°å‹Ÿé›†ä¸­ï¼†ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹</h3>
        <div class="infoSmall">
          ä»¥ä¸‹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã€Œã“ã‚Œã¯ï¼ã€ã¨ã„ã†è¨€è‘‰ã‚’å‹Ÿé›†ä¸­ã§ã™ã€‚<br>
          ãƒ»å£°ã«å‡ºã—ã¦èª­ã¿ãŸã„æ—¥æœ¬èªãƒ»ãƒ»ãƒ»æ€ã‚ãšå£°ã«å‡ºã—ã¦èª­ã¿ãŸããªã‚‹ãƒªã‚ºãƒŸã‚«ãƒ«ãªè¨€è‘‰<br>ï¼ˆä¾‹ï¼šãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠã€ãƒãƒ«ã‚µãƒŸã‚³é…¢ã€ä¸­äº¬å¤§ä¸­äº¬ï¼‰<br>
          ãƒ»ã‚­ãƒ¡ãƒ©è¨€è‘‰ãƒ»ãƒ»ãƒ»ã©ã“ã‚’è¦‹ã‚Œã°ã„ã„ã®ã‹åˆ†ã‹ã‚‰ãªã„ã®ã§ã€è¿·å­ã«ãªã‚Šç«‹ã¡å°½ãã—ã¦ã—ã¾ã†è¨€è‘‰<br>ï¼ˆä¾‹ï¼šãƒšãƒªã‚«ãƒ³ãƒãƒ³ã‚´ãƒ¼ã€ãƒŠãƒãƒ¬ã‚ªãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã€ç†±å·ãƒãƒŠãƒŠãƒ¯ãƒ‹åœ’ï¼‰<br>
          ãƒ»çŸ¥ã£ã¦ã‚‹ã¤ã‚‚ã‚Šè¨€è‘‰ãƒ»ãƒ»ãƒ»èã„ãŸã“ã¨ã¯ã‚ã‚‹ã—ä½•ã¨ãªãã¯ã‚ã‹ã‚‹ã‘ã©ã€èª°ã‚‚æ­£ã—ãèª¬æ˜ã§ããªã„è¨€è‘‰<br>ï¼ˆä¾‹ï¼šãƒ”ãƒ­ãƒ†ã‚£ã€ãƒ©ãƒ—ã‚½ãƒ‡ã‚£ã€ã‚³ãƒ³ã‚³ãƒ¼ã‚¹ï¼‰<br>
          ãƒ»æ†§ã‚Œã®è‚©æ›¸ãƒ»ãƒ»ãƒ»ãªã‚“ã‹ä¸€è¦‹ã™ã”ãã†ãªã‚„ã¤ï¼ˆä¾‹ï¼šãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼ã€æ¸©æ³‰ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã€é‡èœã‚½ãƒ ãƒªã‚¨ï¼‰<br>
          ãƒ»å†·ã‚ã‚‹è¨€è‘‰ãƒ»ãƒ»ãƒ»è¨€ã‚ã‚ŒãŸã‚‰ä¸€æ°—ã«èãæ°—ãŒå¤±ã›ã‚‹è¨€è‘‰ï¼ˆä¾‹ï¼šæœ¬è³ªã€è¦‹ãˆã‚‹åŒ–ã€è‡ªåˆ†ã”ã¨åŒ–ï¼‰<br>
        </div>
      </div>
      <div class="infoBox">
        <h3>ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹</h3>
        <div class="infoSmall">
          åˆ¶ä½œã«ã¯ä»¥ä¸‹ã®AIã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚<br>
          ãƒ»BGMä½œæˆï¼šSuno AI<br>
          ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆï¼šChat-GPT<br>
          ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢æä¾›ï¼šChat-GPTã€Gemini<br>
          <br>ã€€<br>
          ã¾ãŸã€æ¬¡ã®ä½œå“ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‹ã‚‰å¤šãã®ç¤ºå”†ã‚’å—ã‘ã¦ã„ã¾ã™ã€‚<br>
          ãƒ»éŸ³æ¥½ï¼šThe Gregory Brothersã€å˜‰é–€é”å¤«ã€æ°´æ›œæ—¥ã®ã‚«ãƒ³ãƒ‘ãƒãƒ©<br>
          ãƒ»ã‚²ãƒ¼ãƒ ï¼šã«ã»ã‚“ã®ã‚ã‚‰ãã„ã€ç”²è™«ç‹è€…ãƒ ã‚·ã‚­ãƒ³ã‚°ã€ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼<br>
          ãƒ»ã‚¢ã‚¤ãƒ‡ã‚¢ï¼šã€ŒMBSãƒ¤ãƒ³ã‚°ã‚¿ã‚¦ãƒ³ç«æ›œæ—¥ï¼ˆå˜‰é–€é”å¤«ãƒ»æ²³åˆå¥ˆä¿å­ï¼‰ã€å†…ã‚³ãƒ¼ãƒŠãƒ¼ã€Œã‚¸ãƒŸãƒ¼ï¼†ãƒãƒ‡ãƒ¼ã€ã€ã€Œçˆ†ç¬‘å•é¡Œã‚«ãƒ¼ãƒœãƒ¼ã‚¤ã€å†…ã‚³ãƒ¼ãƒŠãƒ¼ã€Œå¤ªç”°æµè¡Œèªå¤§è³ã€ã€ç§‹å±±ç«œæ¬¡ã€Œã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚ºãƒ•ã‚¡ã‚¤ãƒ«ã€ã»ã‹
        </div>
      </div>
    </div>
  </section>

  <div class="ad-float" role="dialog" aria-label="åºƒå‘ŠãƒãƒŠãƒ¼">
    <a href="nekologia.html" target="_blank" rel="noopener">
      <img src="images/necologia_banner.jpg" alt="ãƒã‚³ãƒ­ã‚¸ã‚¢ | 9.31ç™ºå£² DVDãƒ»ãƒ–ãƒ«ãƒ¼ãƒ¬ã‚¤">
    </a>
    <button class="ad-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
  </div>
</main>

<div class="footer">ã‚ãªãŸã®å¥½ããªè¨€è‘‰ã¯ä½•ã§ã™ã‹ã€‚</div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop preload="auto"></audio>
<div id="srLayer" class="srOverlay" aria-hidden="true"><div class="srBadge">ğŸŒŸ S RARE!</div><div class="confetti" id="confetti"></div></div>
<div id="summary" class="summary" aria-hidden="true"><div class="sumCard"><div style="font-weight:900">é–‹å°ã¾ã¨ã‚</div><div id="sumText" style="color:#aab3d6;font-size:13px;margin-top:4px"></div><div id="sumRow" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div></div></div>
<div id="completeAll" class="summary" aria-hidden="true"><div class="sumCard"><div style="font-weight:900;font-size:18px">ğŸ‰ å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åˆ¶è¦‡ï¼</div><div style="color:#aab3d6;font-size:13px;margin-top:4px">Sã€œDã¨Xã¾ã§ã€ã™ã¹ã¦é›†ã¾ã‚Šã¾ã—ãŸã€‚ãŠã‚ã§ã¨ã†ï¼</div></div></div>
<div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111633;border:1px solid var(--edge);padding:10px 14px;border-radius:12px;display:none;z-index:40;box-shadow:0 10px 30px rgba(0,0,0,.35)"></div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="cm-modal" id="cmModal" aria-hidden="true">
  <div class="cm-backdrop" id="cmBackdrop"></div>
  <div class="cm-dialog" role="dialog" aria-modal="true" aria-labelledby="cmTitle">
    <button class="cm-close" id="cmClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <div class="cm-title" id="cmTitle"></div>
    <div class="cm-text" id="cmText"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* åºƒå‘Šé–‰ã˜ã‚‹ */
document.querySelector('.ad-close')?.addEventListener('click',()=>{document.querySelector('.ad-float')?.remove();});

/* ====== ãƒ—ãƒ¼ãƒ«ï¼ç¢ºç‡ ====== */
const pools={S:["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼"],
A:["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","ãã¼ã‚ã”ã¯ã‚“","ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","æ¯›ã‚€ãã˜ã‚ƒã‚‰","ä¹å“ä»","ã‘ã‚“ã¡ã‚“æ±"],
B:["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","ãƒãƒ«ã‚µãƒŸã‚³é…¢","ãƒ”ãƒ­ãƒªèŒ","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ "],
C:["ãƒãƒ“ãƒ­ãƒ³æ•å›š","é³¥å–ç ‚ä¸˜","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","æ¸¡æ¥äºº","ã•ã‚‹ã³ã‚ä¸¸","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶"],
D:["ã‚¯ãƒãƒ³ãƒãƒ","çœŒåºæ‰€åœ¨åœ°","ç…§ã‚Šç„¼ããƒã‚­ãƒ³","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«"],
X:["æœ¬è³ª","è¦‹ãˆã‚‹åŒ–","è‡ªåˆ†ã”ã¨åŒ–","è§£åƒåº¦"]};
const probs={S:.02,A:.08,B:.20,C:.30,D:.30,X:.10};
const icons={S:"ğŸŒŸ",A:"ğŸ’",B:"ğŸ”·",C:"ğŸ”¹",D:"ğŸ”¸",X:"âŒ"};
const classes={S:"s",A:"a",B:"b",C:"c",D:"d",X:"x"};

/* ====== ã‚³ãƒ¡ãƒ³ãƒˆ ====== */
const exp={
  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"å£°ã«å‡ºã—ã¦èª­ã¿ãŸã„æ—¥æœ¬èªãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¬¬1ä½ã€‚",
  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"èª°ã‚‚ãŒäººç”Ÿã§ä¸€åº¦ã¯å°±ä»»ã—ã¦ã¿ãŸã„æ†§ã‚Œã®è‚©æ›¸ãã€‚",
  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"æ²–ç¸„ã®ã‚­ãƒƒãƒãƒ³ã‹ã‚‰å±Šãã€çˆ½ã‚„ã‹ãªãã‚Šè¿”ã—è¨€è‘‰ã€‚",
  "ãã¼ã‚ã”ã¯ã‚“":"å£ã®ä¸­ã‚’ä½“ç¾ã—ãŸã‚ˆã†ãªèªæ„Ÿã€‚",
  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"åå‰ã‹ã‚‰ãƒ“ã‚·ãƒ“ã‚·ã¨ä¼ã‚ã£ã¦ãã‚‹å¨å³ã€‚ãã‚Œãã‚Œã‚‚VIPå¾…é‡ã§ã€‚",
  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":"æ¯›ã¯çŸ¥ã£ã¦ã‚‹ã‘ã©ã€ã‚€ãã˜ã‚ƒã‚‰ã£ã¦ä½•ãªã®ã•ã€‚",
  "ä¹å“ä»":"é›£èª­åœ°åãŒç¹”ã‚Šãªã™ãƒªã‚ºãƒ ã€‚",
  "ã‘ã‚“ã¡ã‚“æ±":"éŸ¿ãã ã‘ã§ã€ã‚‚ã†ã‚ã£ãŸã‹ã„ã€‚",
  "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"å¯’æ°—ã¨ç†±æ°—ãŒåŒå±…ã™ã‚‹æ¥µæ±ã®åœ°ã¸ã‚ˆã†ã“ãã€‚",
  "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"ãƒ•ã‚¡ãƒ³ã‚·ãƒ¼ãªãŠè“å­ã¿ãŸã„ã€‚çŒ›æ¯’ç³»ã‚¹ã‚¤ãƒ¼ãƒ„ã€‚",
  "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"é–“æŠœã‘ã®é³¥ã«ã¯é–“æŠœã‘ãªèªæ„Ÿã€‚",
  "ãƒãƒ«ã‚µãƒŸã‚³é…¢":"ã¾ã‚‹ã§å‘ªæ–‡ã€‚",
  "ãƒ”ãƒ­ãƒªèŒ":"å¯æ„›ã„ãµã‚Šã—ã¦ã‚ã‚Šã¨ã‚„ã‚‹ã‚‚ã‚“ã ã­ã€‚",
  "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"å®¹èµ¦ãªã„æ¿éŸ³ã¨ãƒˆã®å¿œé…¬ã€‚",
  "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"ãŠã‚„ã¤ã®è¨˜æ†¶ã«ãƒ©ãƒœã®åŒ‚ã„ã€‚",
  "ãƒãƒ“ãƒ­ãƒ³æ•å›š":"ã„ã‹ã«ã‚‚æ•ã¾ã£ãŸãã£ã¦æ„Ÿã˜ã€‚",
  "é³¥å–ç ‚ä¸˜":"è’é‡ã‚’å­éŸ³ãŒè·³ã­å›ã‚‹ã€‚",
  "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"è¨€è‘‰ã«èˆã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚",
  "æ¸¡æ¥äºº":"æœé®®åŠå³¶ã‹ã‚‰ã®æŒ‘æˆ¦ã€‚",
  "ã•ã‚‹ã³ã‚ä¸¸":"é–“ã®æŠœã‘ãŸæ—…ã«ãªã‚Šãã†ã€‚",
  "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"å”è¾›å­ãŒèºå‹•ã™ã‚‹å£å†…ã€‚",
  "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"åŠæ¿éŸ³ã®ç‹æ§˜ã€‚",
  "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"ã•ã‚‰ã£ã¨å§‹ã¾ã£ãŸã¯ãšã ã£ãŸã®ã«ã€‚",
  "ã‚¯ãƒãƒ³ãƒãƒ":"ã€Œã‚“ã€ã®å¦™ã€‚","çœŒåºæ‰€åœ¨åœ°":"å ‚ã€…ã¨ã—ã¦ã‚‹ã‚ˆã­ã€‚","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"ç”˜è¾›ãƒ“ãƒ¼ãƒˆã«ä¹—ã£ã¡ã‚ƒã£ã¦ã€‚","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"ã‚ªã‚»ãƒ­ã ã£ãŸã‚‰æ°—æŒã¡ã„ã„ã€‚","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"å™›ã‚ã°å™›ã‚€ã»ã©å‘³ãŒå‡ºã‚‹åå‰ã€‚",
  "æœ¬è³ª":"ãŸã¨ãˆã‚ã£ãŸã¨ã—ã¦ã‚‚ã€è»½ã€…ã—ãå£ã«å‡ºã™ã‚ˆã†ãªäººã¯ä¸€ç”Ÿè¿‘ã¥ã‘ãªã„ã¨æ€ã†ã‚“ã§ã™ã€‚",
  "è¦‹ãˆã‚‹åŒ–":"å¯è¦–åŒ–ã£ã¦çŸ¥ã£ã¦ã¾ã™ã‹ã€‚","è‡ªåˆ†ã”ã¨åŒ–":"ã€Œè‡ªåˆ†ã”ã¨ã€ã§ã‚‚å«Œãªã®ã«ã€ã€ŒåŒ–ã€ã¾ã§ã¤ã‘ã‚‰ã‚ŒãŸæ—¥ã«ã¯â€¦","è§£åƒåº¦":"ãªã‚‹ã»ã©ã€ãƒ”ã‚¯ã‚»ãƒ«æ•°ãŒé«˜ã¾ã‚Šã¾ã—ãŸï¼"
};

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ====== */
const storeSeen="kotoba_collection_seen_v4_7";
const storeBGM="kotoba_bgm_selected_v4_7";
const seen=new Set(JSON.parse(localStorage.getItem(storeSeen)||"[]"));
let selectedBGM=localStorage.getItem(storeBGM)||"default";
const tiers=["S","A","B","C","D","X"];

/* ====== DOM ====== */
const cards=document.getElementById('cards');
const progress=document.getElementById('progress');
const counts=document.getElementById('counts');
const collectionBox=document.getElementById('collection');
const resultsPanel=document.getElementById('resultsPanel');
const collectionPanel=document.getElementById('collectionPanel');
const bgmPanel=document.getElementById('bgmPanel');
const infoPanel=document.getElementById('infoPanel');       // è¿½åŠ 
const tabResults=document.getElementById('tabResults');
const tabCollection=document.getElementById('tabCollection');
const tabBGM=document.getElementById('tabBGM');
const tabCPU=document.getElementById('tabCPU');
const tabInfo=document.getElementById('tabInfo');           // è¿½åŠ 
const toastEl=document.getElementById('toast');

/* ====== BGM ====== */
const bgmEl=document.getElementById('bgm');
const bgmBtn=document.getElementById('bgmBtn');
const vol=document.getElementById('vol');
let bgmOn=false;
bgmEl.volume=parseFloat(vol.value);
vol.addEventListener('input',()=>bgmEl.volume=parseFloat(vol.value));
bgmBtn.addEventListener('click',async()=>{bgmOn=!bgmOn;bgmBtn.textContent=bgmOn?"â™ª BGM ON":"â™ª BGM OFF";try{bgmOn?await bgmEl.play():bgmEl.pause();}catch(e){}});

/* ====== åŠ¹æœéŸ³ ====== */
let audioEnabled=true;let audioCtx=null;
const soundBtn=document.getElementById('sound');
if(soundBtn){soundBtn.addEventListener('click',()=>{audioEnabled=!audioEnabled;soundBtn.textContent=audioEnabled?"ğŸ”Š ON":"ğŸ”‡ OFF";if(audioEnabled) getCtx();});}
function getCtx(){if(!audioEnabled)return null;if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==="suspended")audioCtx.resume();return audioCtx;}
function tone(f=880,d=0.15,t='triangle',v=0.15){const c=getCtx();if(!c)return;const o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.0001,c.currentTime);g.gain.exponentialRampToValueAtTime(v,c.currentTime+0.02);o.start();g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+d);o.stop(c.currentTime+d+0.02);}
function chimeLong(){tone(659,0.14);setTimeout(()=>tone(880,0.18),140);setTimeout(()=>tone(1047,0.22),320);setTimeout(()=>tone(1319,0.26),520);}
function drawSfx(i){tone(420+i*40,0.10,'square',0.12);}
function duck(fn){const b=bgmEl.volume;bgmEl.volume=Math.max(0,b*0.6);setTimeout(()=>{bgmEl.volume=parseFloat(vol.value);},700);fn&&fn();}

/* ====== Sæ¼”å‡º ====== */
const srLayer=document.getElementById('srLayer');const confetti=document.getElementById('confetti');
function showSOverlay(){srLayer.classList.remove('show');confetti.innerHTML="";
const palette=["#f7d774","#ff8bd1","#63ead9","#8fb1ff","#fff07a","#ff6b6b"];
for(let i=0;i<110;i++){const s=document.createElement('div');s.className='shard';
s.style.left=(5+Math.random()*90)+"%";s.style.top=(-10-Math.random()*40)+"px";
s.style.background=palette[Math.floor(Math.random()*palette.length)];
s.style.animationDelay=(Math.random()*0.6)+"s";confetti.appendChild(s);}
srLayer.classList.add('show');duck(chimeLong);setTimeout(()=>srLayer.classList.remove('show'),1600);}

/* ====== UIè£œåŠ© ====== */
function toast(msg){toastEl.textContent=msg;toastEl.style.display='block';toastEl.style.opacity='0';toastEl.style.transition='opacity .2s';requestAnimationFrame(()=>toastEl.style.opacity='1');setTimeout(()=>{toastEl.style.opacity='0';setTimeout(()=>toastEl.style.display='none',200)},1600);}
function hasTier(t){return pools[t].every(w=>seen.has(w));}

/* ====== é€²æ— ====== */
function renderProgress(){
  progress.innerHTML=tiers.map(t=>{
    const tot=pools[t].length;const have=pools[t].filter(w=>seen.has(w)).length;const p=tot?(have/tot):0;
    return `<span class="pill" style="--p:${p}"><span class="bar"></span><span>${icons[t]}</span>${t} ${have}/${tot}</span>`;
  }).join("");
}

/* ====== ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ ====== */
function renderCollection(){
  const by={S:[],A:[],B:[],C:[],D:[],X:[]};
  for(const t of tiers){for(const w of pools[t]) if(seen.has(w)) by[t].push(w);}
  const total=Object.values(by).reduce((a,x)=>a+x.length,0);
  counts.textContent=`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼š${total}æš / S:${by.S.length} A:${by.A.length} B:${by.B.length} C:${by.C.length} D:${by.D.length} X:${by.X.length}`;
  collectionBox.innerHTML="";
  for(const t of tiers){
    const sec=document.createElement('div');
    const h=document.createElement('div');h.style.fontSize="13px";h.style.color="#aab3d6";h.style.margin="6px 0 4px";h.textContent=`${t}ãƒ©ãƒ³ã‚¯`;sec.appendChild(h);
    const row=document.createElement('div');row.style.display="flex";row.style.flexWrap="wrap";row.style.gap="8px";sec.appendChild(row);
    const arr=by[t];
    if(arr.length===0){
      const tag=document.createElement('div');tag.className='pill';tag.textContent="â€” æœªå…¥æ‰‹ â€”";row.appendChild(tag);
    }else{
      for(const w of arr){
        const tag=document.createElement('div');tag.className='pill collection-item';tag.dataset.word=w;tag.tabIndex=0;
        tag.setAttribute('role','button');tag.setAttribute('aria-label',`${w} ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é–‹ã`);
        tag.innerHTML=`<span>${icons[t]}</span>${w}`;row.appendChild(tag);
      }
    }
    collectionBox.appendChild(sec);
  }
}

/* ====== BGMã‚¿ãƒ– ====== */
const bgmGrid=document.getElementById('bgmGrid');
function bgmTracks(){
  return [
    {id:"default",name:"ãƒ’ãƒ—ãƒŠã‚´ã‚¸ã‚¢éŸ³é ­",tier:"FREE",unlocked:true,src:"audio/Hypnagogiaondo.mp3"},
    {id:"kingyobachi",name: hasTier("S")?"é‡‘é­šé‰¢":"ï¼Ÿï¼Ÿï¼Ÿ",tier:"S",unlocked:hasTier("S"),src:"audio/Kingyobachi.mp3"},
    {id:"kuganebutsu",name: hasTier("A")?"ä¹å“ä»å¥‡è­š":"ï¼Ÿï¼Ÿï¼Ÿ",tier:"A",unlocked:hasTier("A"),src:"audio/Kuhonbutsukitan.mp3"},
    {id:"necology",name: hasTier("B")?"ãƒã‚³ãƒ­ã‚¸ã‚¢":"ï¼Ÿï¼Ÿï¼Ÿ",tier:"B",unlocked:hasTier("B"),src:"audio/Nekologia.mp3"},
    {id:"kingyobachi_chorus",name: (["S","A","B","C","D","X"].every(t=>hasTier(t)))?"é‡‘é­šé‰¢ï¼ˆåˆå”±ver.ï¼‰":"ï¼Ÿï¼Ÿï¼Ÿ",tier:"ALL",unlocked:["S","A","B","C","D","X"].every(t=>hasTier(t)),src:"audio/Kingyobachi_chorus.mp3"},
  ];
}
function renderBGMTab(){
  bgmGrid.innerHTML="";
  bgmTracks().forEach(tr=>{
    const wrap=document.createElement('div');wrap.className='track';
    const left=document.createElement('div');left.className='meta';
    const badge=document.createElement('span');badge.className='tag';badge.textContent=(tr.tier==='FREE'?'FREEè§£æ”¾':tr.tier+' å®Œäº†ã§è§£æ”¾');
    const name=document.createElement('div');name.style.fontWeight='900';name.textContent=tr.name+(selectedBGM===tr.id?'ï¼ˆé¸æŠä¸­ï¼‰':'');
    left.appendChild(badge);left.appendChild(name);wrap.appendChild(left);
    const right=document.createElement('div');right.style.display='flex';right.style.gap='8px';
    if(tr.unlocked){
      const sel=document.createElement('button');sel.className='cta b5';sel.textContent='é¸æŠ';
      sel.onclick=()=>{switchBGM(tr.id,tr.src);renderBGMTab();toast('BGMã‚’å¤‰æ›´ã—ã¾ã—ãŸ');};
      right.appendChild(sel);
    }else{
      const lock=document.createElement('div');lock.className='lock';lock.textContent='ğŸ”’ æœªè§£æ”¾'; right.appendChild(lock);
    }
    wrap.appendChild(right);bgmGrid.appendChild(wrap);
  });
}
function switchBGM(id,src){
  if(!src){
    const map={default:"audio/Hypnagogiaondo.mp3","kingyobachi":"audio/Kingyobachi.mp3","kuganebutsu":"audio/Kuhonbutsukitan.mp3","necology":"audio/Nekologia.mp3","kingyobachi_chorus":"audio/Kingyobachi_chorus.mp3"};
    src=map[id]||map.default;
  }
  bgmEl.pause(); bgmEl.src=src; if(bgmOn){bgmEl.play().catch(()=>{});} selectedBGM=id; localStorage.setItem(storeBGM,id);
}

/* ====== æŠ½é¸ ====== */
function saveSeen(w){seen.add(w);localStorage.setItem(storeSeen,JSON.stringify([...seen]));}
function pickTier(){const r=Math.random();let a=0;for(const k of ["S","A","B","C","D","X"]){a+=probs[k];if(r<a)return k;}return "D";}
function pickWord(t){const a=pools[t];return a[Math.floor(Math.random()*a.length)];}
function addCard(t,w){
  const prev=pools[t].filter(x=>seen.has(x)).length;
  const c=document.createElement('div');c.className=`card ${classes[t]}`;
  const icon=document.createElement('div');icon.className=`rar ${classes[t]}`;icon.textContent=icons[t];
  const b=document.createElement('div');const wd=document.createElement('div');wd.className='word';wd.textContent=w;
  const n=document.createElement('div');n.className='note';n.textContent=`${t}ãƒ©ãƒ³ã‚¯`;
  b.appendChild(wd);b.appendChild(n);
  const e=document.createElement('div');e.className='exp '+classes[t];e.textContent=exp[w]||"èªæ„Ÿã«è§¦ã‚Œã‚‹å–œã³ã€‚";b.appendChild(e);
  if(!seen.has(w)){const nm=document.createElement('span');nm.className='new';nm.textContent="New";wd.appendChild(nm);}
  c.appendChild(icon);c.appendChild(b);cards.prepend(c);
  saveSeen(w);
  if(t==='S')showSOverlay();
  tryCompleteTier(t,prev);
  renderProgress();
}
function openOnce(i=0){const t=pickTier();const w=pickWord(t);addCard(t,w);drawSfx(i);return [t,w];}
function openMulti(n){
  let i=0;const rs=[];
  const step=()=>{if(i>=n){showSummary(rs);checkCompleteAll();return;}
    const r=openOnce(i);rs.push(r);i++;setTimeout(step,720)};
  step();
}

/* ====== ã¾ã¨ã‚è¡¨ç¤º ====== */
const summary=document.getElementById('summary');const sumText=document.getElementById('sumText');const sumRow=document.getElementById('sumRow');
function showSummary(items){
  const cnt=items.reduce((m,[t])=>(m[t]=(m[t]||0)+1,m),{});
  sumText.textContent=`S:${cnt.S||0} / A:${cnt.A||0} / B:${cnt.B||0} / C:${cnt.C||0} / D:${cnt.D||0} / X:${cnt.X||0}`;
  sumRow.innerHTML="";
  items.forEach(([t,w])=>{const d=document.createElement('div');d.className='pill';d.innerHTML=`<span>${icons[t]}</span>${w}`;sumRow.appendChild(d);});
  summary.classList.add('show');setTimeout(()=>summary.classList.remove('show'),1600);
}

/* ====== ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆåˆ¤å®š ====== */
const completeAll=document.getElementById('completeAll');
const unlock={FREE:true,S:false,A:false,B:false,ALL:false};
function tryCompleteTier(tier,prev){
  if(!["S","A","B","C","D","X"].includes(tier))return;
  const tot=pools[tier].length;const now=pools[tier].filter(w=>seen.has(w)).length;
  if(prev<tot && now===tot){
    if(!unlock[tier]){
      unlock[tier]=true;
      if(tier==="S"||tier==="A"||tier==="B"){
        const name=tier==="S"?"é‡‘é­šé‰¢":tier==="A"?"ä¹å“ä»å¥‡è­š":"ãƒã‚³ãƒ­ã‚¸ã‚¢";
        toast(`æ–°ã—ã„BGMã€Œ${name}ã€ãŒé–‹æ”¾ã•ã‚Œã¾ã—ãŸï¼`);
        duck(chimeLong);
        renderBGMTab();
      }
    }
    const ov=document.createElement('div');ov.className='summary show';
    ov.innerHTML=`<div class="sumCard"><div style="font-weight:900">${tier}ãƒ©ãƒ³ã‚¯ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼</div><div style="color:#aab3d6;font-size:13px;margin-top:4px">å…¨${tot}æšã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</div></div>`;
    document.body.appendChild(ov);setTimeout(()=>ov.remove(),1600);
  }
}
function checkCompleteAll(){
  const all=["S","A","B","C","D","X"].every(t=>hasTier(t));
  if(all){
    completeAll.classList.add('show');
    duck(()=>{chimeLong();setTimeout(chimeLong,700)});
    setTimeout(()=>completeAll.classList.remove('show'),2200);
    toast('æ–°ã—ã„BGMã€Œé‡‘é­šé‰¢ï¼ˆåˆå”±ver.ï¼‰ã€ãŒé–‹æ”¾ã•ã‚Œã¾ã—ãŸï¼');
    switchBGM('kingyobachi_chorus');
    renderBGMTab();
  }
}

/* ====== ã‚¿ãƒ–åˆ‡æ›¿ ====== */
function showPanel(target){
  // å…¨ãƒ‘ãƒãƒ«éè¡¨ç¤º
  resultsPanel.style.display="none";
  collectionPanel.style.display="none";
  bgmPanel.style.display="none";
  infoPanel.style.display="none";
  // å…¨ã‚¿ãƒ– inactive
  [tabResults,tabCollection,tabBGM,tabCPU,tabInfo].forEach(b=>b.classList.remove('active'));
  // å¯¾è±¡è¡¨ç¤º
  if(target==='results'){resultsPanel.style.display="block";tabResults.classList.add('active');}
  if(target==='collection'){collectionPanel.style.display="block";tabCollection.classList.add('active');}
  if(target==='bgm'){bgmPanel.style.display="block";tabBGM.classList.add('active');}
  if(target==='info'){infoPanel.style.display="block";tabInfo.classList.add('active');}
}
tabResults.onclick=()=>showPanel('results');
tabCollection.onclick=()=>{renderCollection();showPanel('collection');};
/* CPUå¯¾æˆ¦ã¯æ–°è¦ã‚¿ãƒ– */
tabCPU.onclick=()=>{window.open("https://kyoryu1039.github.io/kotoba-gacha/kotobattle","_blank","noopener");};
/* BGM/Info */
tabBGM.onclick=()=>{renderBGMTab();showPanel('bgm');};
tabInfo.onclick=()=>{showPanel('info');};

/* ====== ãƒœã‚¿ãƒ³ ====== */
document.getElementById('roll1').onclick=async()=>{if(bgmOn){try{await bgmEl.play()}catch(e){}} openOnce(0);};
document.getElementById('roll5').onclick=async()=>{if(bgmOn){try{await bgmEl.play()}catch(e){}} openMulti(5);};
/* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å¯¾å¿œ */
const clearBtn=document.getElementById('clear');
if(clearBtn){
  clearBtn.onclick=()=>{cards.innerHTML="";localStorage.setItem(storeSeen,JSON.stringify([]));seen.clear();renderProgress();renderBGMTab();renderCollection();toast('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');};
}
document.getElementById('info').onclick=()=>alert("æ’å‡ºç‡ï¼šS2% A8% B20% C30% D30% X10%\nç«¯æœ«å†…ã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆlocalStorageï¼‰ã€‚\néŸ³ãŒå‡ºãªã„æ™‚ã¯ã€Œâ™ª BGM ONã€ã‚’æŠ¼ã—ã¦ã­ã€‚");

/* ====== ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
const cmModal=document.getElementById('cmModal');
const cmTitle=document.getElementById('cmTitle');
const cmText=document.getElementById('cmText');
const cmClose=document.getElementById('cmClose');
const cmBack =document.getElementById('cmBackdrop');

function openComment(word){
  cmTitle.textContent = word;
  cmText.textContent  = exp[word] ?? "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœªç™»éŒ²ï¼‰";
  cmModal.classList.add('show');
  cmModal.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}
function closeComment(){
  cmModal.classList.remove('show');
  cmModal.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
}
cmClose?.addEventListener('click',closeComment);
cmBack ?.addEventListener('click',closeComment);
document.addEventListener('keydown',e=>{if(e.key==='Escape') closeComment();});

/* ====== åˆæœŸæç”» ====== */
(function init(){
  renderProgress();renderCollection();renderBGMTab();
  if(selectedBGM!=="default") switchBGM(selectedBGM);
})();
}); /* DOMContentLoaded */
</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body></html>
