<!doctype html> 
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>KOTOBA-BATTLE | Cyber Edition v2</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#050b14">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Teko:wght@500;700&family=M+PLUS+1p:wght@700;900&display=swap" rel="stylesheet">

<style>
/* === „Éô„Éº„ÇπË®≠ÂÆö & Â§âÊï∞ === */
:root{
  --bg-deep: #050b14;
  --text-main: #e2e8f0;
  --primary: #3b82f6;
  --accent: #f59e0b;
  --glass-border: rgba(255, 255, 255, 0.15);
  --font-main: 'Noto Sans JP', sans-serif;
  --font-num: 'Teko', sans-serif;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{ height:100%; margin:0; padding:0; overflow:hidden; background: var(--bg-deep); color: var(--text-main); font-family: var(--font-main); }

/* === ËÉåÊôØ & Á©∫ÈñìÊºîÂá∫ === */
.bg-anim {
  position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at 50% 120%, #1e293b 0%, #020617 70%);
}
.bg-anim::after {
  content: ""; position: absolute; inset: 0;
  background-image: 
    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 50px 50px;
  mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
  animation: bgFloat 30s linear infinite;
}
@keyframes bgFloat { from{transform:scale(1);} 50%{transform:scale(1.1);} to{transform:scale(1);} }

/* === „Ç≥„É≥„ÉÜ„Éä„É¨„Ç§„Ç¢„Ç¶„Éà === */
.container{ max-width:600px; margin:0 auto; height:100%; display:flex; flex-direction:column; padding: 10px; overflow-y: auto;}
#battle { display:none; flex-direction:column; height:100dvh; width:100%; max-width:600px; margin:0 auto; overflow:hidden; }

/* === 1. „Ç¢„É™„Éº„ÉäÔºà„Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢Ôºâ === */
.arena {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 10px; perspective: 1000px; z-index: 1; min-height: 0;
}
.vsrow {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  width: 100%; height: 100%; max-height: 420px; align-items: end;
}
.vsrow > div { height: 100%; min-width: 0; }

/* „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ (Cyber Card Style) */
.unit {
  position: relative; width: 100%; height: 100%;
  border-radius: 12px; padding: 3px;
  /* „Çø„Ç§„Éó„Ç´„É©„Éº„Çí„Éú„Éº„ÉÄ„Éº„Å®ÂΩ±„Å´ÂèçÊò† */
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid var(--typeColor); 
  box-shadow: 0 0 15px rgba(0,0,0,0.5), 0 0 5px var(--typeColor), inset 0 0 20px rgba(0,0,0,0.5);
  display: flex; flex-direction: column;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: visible !important;
}

/* „É©„É≥„ÇØÂà•Âº∑Ë™ø */
.unit[data-rank="S"] { box-shadow: 0 0 20px rgba(255,215,0,0.4), 0 0 10px #ffd700; border-color: #ffd700; }
.unit[data-rank="X"] { box-shadow: 0 0 20px rgba(217,70,239,0.4), 0 0 10px #d946ef; border-color: #d946ef; }

/* „Ç´„Éº„ÉâÂÜÖÈÉ® */
.unitInner {
  flex: 1; display: flex; flex-direction: column;
  /* ‰∏ãÈÉ®„Å´„Çø„Ç§„ÉóËâ≤„Çí„ÅÜ„Å£„Åô„Çâ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„Åï„Åõ„Çã */
  background: linear-gradient(180deg, #1e293b 0%, #0f172a 60%, var(--typeColor) 180%);
  border-radius: 9px; overflow: hidden; position: relative; z-index: 2;
}

/* „Éò„ÉÉ„ÉÄ„Éº */
.cardHeader {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 6px; background: rgba(0,0,0,0.4);
  border-bottom: 1px solid rgba(255,255,255,0.1); flex: 0 0 auto;
}
.ownerBadge { font-size: 10px; font-weight: 900; color: #94a3b8; }
.typeIcon {
  font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 12px;
  background: var(--typeColor); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  box-shadow: 0 0 8px var(--typeColor);
}
.cardName {
  flex: 0 0 auto;
  font-weight: 900; font-size: 13px; text-align: center; color: #fff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  padding: 4px 0; letter-spacing: 0.05em; white-space: nowrap;
}

/* „Ç¢„Éº„Éà„ÉØ„Éº„ÇØ„Ç®„É™„Ç¢ */
.artArea {
  flex: 1; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(circle, rgba(255,255,255,0.05), transparent 80%);
  overflow: hidden; position: relative; min-height: 0;
}
.mainImg {
  max-width: 90%; max-height: 90%; object-fit: contain; width: auto; height: auto;
  filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8));
  animation: floatImg 3s ease-in-out infinite alternate;
}
@keyframes floatImg { from{transform:translateY(0) scale(1);} to{transform:translateY(-5px) scale(1.02);} }

/* „Çπ„ÉÜ„Éº„Çø„Çπ„Ç®„É™„Ç¢ */
.statsArea { flex: 0 0 auto; padding: 6px; background: rgba(2, 6, 23, 0.6); border-top: 1px solid rgba(255,255,255,0.1); }
.hpRow { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 4px; }
.hpLabel { font-size: 10px; color: #94a3b8; font-weight: 700; }
.hpNum { font-family: var(--font-num); font-size: 16px; font-weight: 700; line-height: 1; color: #fff; }
.hpSlash,.hpMax { font-size: 12px; color: #64748b; }
.hpBarBg {
  height: 6px; background: #334155; border-radius: 4px; overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
}
.hpBar {
  height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative; overflow: hidden;
}
.hpBar::after {
  content: ""; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transform: skewX(-20deg) translateX(-150%);
  animation: shineBar 2s infinite;
}
@keyframes shineBar { 100% { transform: skewX(-20deg) translateX(250%); } }
.hpBar.high { background: linear-gradient(90deg, #10b981, #34d399); box-shadow: 0 0 10px rgba(16,185,129,0.5); }
.hpBar.mid { background: linear-gradient(90deg, #eab308, #facc15); box-shadow: 0 0 10px rgba(234,179,8,0.5); }
.hpBar.low { background: linear-gradient(90deg, #ef4444, #f87171); box-shadow: 0 0 10px rgba(239,68,68,0.5); }

.statusRow { display: flex; gap: 2px; min-height: 14px; margin-top: 2px; justify-content: flex-end; flex-wrap: wrap; }
.stBadge { font-size: 9px; padding: 0 4px; border-radius: 4px; background: rgba(239,68,68,0.2); color: #fca5a5; border: 1px solid #ef4444; }

/* „Çπ„Ç≠„É´„ÉªSP„Ç≤„Éº„Ç∏ */
.bottomSection { flex: 0 0 auto; padding: 4px; }
.skillInfo {
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  padding: 6px; border-radius: 6px; margin-bottom: 4px; min-height: 48px;
  display: flex; flex-direction: column; justify-content: center;
}
.skillN { color: var(--accent); font-size: 11px; font-weight: 900; margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.skillD { font-size: 10px; color: #94a3b8; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.spRow { display: flex; gap: 4px; justify-content: center; height: 6px; margin-top: 4px; }
.pip {
  flex: 1; height: 100%; background: #334155; border-radius: 2px;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
}
.pip.on {
  background: #f59e0b; box-shadow: 0 0 6px #f59e0b;
  animation: glowPip 1s infinite alternate;
}
.footer { display: flex; justify-content: space-between; align-items: center; font-size: 9px; color: #64748b; font-family: 'Teko'; padding: 0 4px; margin-top: 2px; }
.btnStat { border: 1px solid #3b82f6; color: #60a5fa; background: transparent; border-radius: 3px; padding: 0 6px; font-size: 9px; cursor: pointer; }

/* === 2. „É≠„Ç∞„Ç®„É™„Ç¢ (‰øÆÊ≠£Ê∏à„Åø) === */
.logWrapper {
  flex: 0 0 100px; /* È´ò„Åï„ÇíÂõ∫ÂÆö */
  height: 100px;
  margin-bottom: 4px;
  background: rgba(2, 6, 23, 0.85);
  border-top: 1px solid var(--glass-border);
  backdrop-filter: blur(4px);
  display: flex; flex-direction: column;
  position: relative; z-index: 10;
  overflow: hidden; /* „Ç≥„É≥„ÉÜ„ÉäËá™‰Ωì„ÅØ‰º∏„Å≥„Å™„ÅÑ */
}
.logHeader {
  font-size: 10px; color: #64748b; background: rgba(255,255,255,0.05);
  padding: 2px 8px; font-weight: 900; letter-spacing: 1px; flex: 0 0 auto;
}
.logContainer {
  flex: 1; 
  padding: 6px 12px; 
  overflow-y: scroll; /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÇíÂº∑Âà∂ */
  font-size: 11px;
  font-family: 'M PLUS 1p', sans-serif; 
  display: flex; flex-direction: column; gap: 3px;
  mask-image: linear-gradient(transparent, black 15px); /* ‰∏äÈÉ®„Çí„Éï„Çß„Éº„Éâ */
}
.logLine { text-shadow: 0 1px 2px rgba(0,0,0,0.8); flex-shrink: 0; }
.logLine.dmg { color: #fca5a5; }
.logLine.heal { color: #86efac; }
.logLine.sp { color: #fcd34d; }
.logLine.miss { color: #cbd5e1; }
.logLine.highlight { color: #fcd34d; font-weight: bold; }

/* === 3. Êéß„Åà„Éª„Éô„É≥„ÉÅ === */
.benchRow {
  flex: 0 0 40px; display: flex; align-items: center; justify-content: center; gap: 12px;
  background: rgba(15,23,42,0.9); border-top: 1px solid var(--glass-border);
  box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 10;
}
.benchLabel{ font-weight:900; font-family:'Teko'; font-size:12px; color:#64748b; }
.resIcon {
  width: 28px; height: 28px; border-radius: 6px;
  background: #1e293b; border: 2px solid #475569; color: #fff;
  font-size: 12px; font-weight: 900; display: grid; place-items: center;
  transition: all 0.2s; cursor: pointer;
}
.resIcon.active {
  border-color: #fff !important; transform: scale(1.15) translateY(-2px);
  box-shadow: 0 4px 12px rgba(255,255,255,0.3); z-index: 2;
}
.resIcon.dead { filter: grayscale(1); opacity: 0.4; }

/* === 4. „Ç≥„ÉÉ„ÇØ„Éî„ÉÉ„ÉàÔºàÊìç‰Ωú„Éë„Éç„É´Ôºâ === */
.padCard {
  flex: 0 0 auto;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(12px);
  padding: 12px 16px 24px;
  border-radius: 24px 24px 0 0;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.6);
  border-top: 1px solid rgba(255,255,255,0.15);
  z-index: 20;
}
.padHead {
  display: flex; justify-content: center; align-items: center;
  margin-bottom: 12px; color: #94a3b8; font-family: var(--font-num); font-size: 14px;
}
.timerVal { font-size: 28px; color: #fff; margin-left: 8px; text-shadow: 0 0 10px var(--primary); font-weight: 700; }

.padInner { display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; }

.rpsArea { display: flex; gap: 16px; justify-content: center; }
.rps {
  width: 64px; height: 64px; border-radius: 50%; border: none;
  display: grid; place-items: center; cursor: pointer; position: relative;
  transition: transform 0.1s, filter 0.2s;
  box-shadow: 0 6px 0 rgba(0,0,0,0.4), 0 12px 20px rgba(0,0,0,0.5); top:0;
}
.rps:active:not([disabled]) { top: 6px; box-shadow: 0 0 0 rgba(0,0,0,0.4); }
.rps::before {
  content:""; position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle at 50% 30%, rgba(255,255,255,0.6), transparent 60%);
}
.rps.g { background: linear-gradient(145deg, #ef4444, #991b1b); border: 2px solid #f87171; }
.rps.c { background: linear-gradient(145deg, #3b82f6, #1e40af); border: 2px solid #60a5fa; }
.rps.p { background: linear-gradient(145deg, #22c55e, #166534); border: 2px solid #4ade80; }
.rps:disabled { filter: grayscale(1) brightness(0.5); cursor: not-allowed; top: 6px; box-shadow: none; }
.emo { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); z-index: 2; }

.sideBtns { display: flex; gap: 8px; width: 100%; max-width: 300px; }
.cmdBtn {
  flex: 1; padding: 12px 0; border: none; border-radius: 8px;
  font-weight: 800; font-size: 14px; color: #fff; cursor: pointer;
  box-shadow: 0 4px 0 rgba(0,0,0,0.4); transition: transform 0.1s;
  position: relative; overflow: hidden; top: 0;
}
.cmdBtn:active:not([disabled]) { top: 4px; box-shadow: none; }
.btn-sp {
  background: linear-gradient(to bottom, #475569, #1e293b);
  border: 1px solid rgba(255,255,255,0.1);
}
.btn-sp.ready {
  background: linear-gradient(45deg, #f59e0b, #d97706);
  box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
  animation: pulseReady 1.5s infinite; border: 1px solid #fcd34d;
}
.btn-sp.on {
  background: linear-gradient(45deg, #ef4444, #b91c1c);
  box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
  animation: pulse 0.8s infinite;
}
.btn-switch { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); }

/* === „ÉÄ„É°„Éº„Ç∏ÊºîÂá∫ === */
.floatingText {
  position: absolute; left: 50%; top: 30%; transform: translate(-50%, -50%);
  font-family: 'M PLUS 1p'; font-weight: 900; font-size: 32px;
  pointer-events: none; z-index: 100;
  text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
  animation: popUp 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  white-space: pre-wrap; text-align: center;
}
.floatingText.dmg { color: #fff; -webkit-text-stroke: 1px #ef4444; }
.floatingText.heal { color: #a7f3d0; font-size: 24px; -webkit-text-stroke: 1px #059669; }
.floatingText.miss { color: #cbd5e1; font-size: 24px; }
@keyframes popUp {
  0% { opacity: 0; transform: translate(-50%, 20px) scale(0.5); }
  20% { opacity: 1; transform: translate(-50%, -20px) scale(1.2); }
  100% { opacity: 0; transform: translate(-50%, -60px) scale(1); }
}

@keyframes pulseReady { 0% { box-shadow: 0 0 5px #f59e0b; } 50% { box-shadow: 0 0 20px #f59e0b, 0 0 10px #fcd34d inset; } 100% { box-shadow: 0 0 5px #f59e0b; } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes hitAnim { 0% { transform: translate(0,0) rotate(0); filter: brightness(2); } 20% { transform: translate(-10px, 0) rotate(-5deg); } 40% { transform: translate(10px, 0) rotate(5deg); } 100% { transform: translate(0,0); filter: brightness(1); } }
.unit.hit { animation: hitAnim 0.4s ease-out; }
.unit.fall { animation: fallDown 0.8s forwards; filter: grayscale(1) brightness(0.4); }
@keyframes fallDown { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(80px) rotate(20deg); opacity: 0; } }
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translate(-3px,2px)}20%,80%{transform:translate(2px,-3px)}30%,50%,70%{transform:translate(-5px,3px)}40%,60%{transform:translate(5px,-3px)}}

/* === „É¢„Éº„ÉÄ„É´ === */
.card {
  background: rgba(15, 23, 42, 0.8); border: 1px solid var(--glass-border);
  backdrop-filter: blur(8px); box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  border-radius: 12px; margin-bottom: 12px;
}
.card h2 {
  background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--glass-border);
  color: #94a3b8; font-family: var(--font-num); letter-spacing: 2px;
  margin:0; padding:12px; font-size: 14px; display: flex; justify-content: space-between; align-items: center;
}
.card .body { padding: 12px; }

.btnTiny { padding: 4px 8px; font-size: 10px; border-radius: 4px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #cbd5e1; cursor: pointer; }
.btn3d {
  appearance: none; border: none; font-family: 'Noto Sans JP'; font-weight: 800; font-size: 14px; color: #fff; padding: 10px 20px; border-radius: 6px; display: inline-flex; justify-content: center; align-items: center; gap: 4px;
  text-transform: uppercase; letter-spacing: 1px;
  box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s; cursor: pointer;
}
.btn3d:active { transform: translateY(4px); box-shadow: none; }
.btn-primary { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); }
.btn-ghost { background: linear-gradient(to bottom, #475569, #1e293b); border: 1px solid rgba(255,255,255,0.1); }

.setupMini {
  border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 8px;
  background: rgba(30, 41, 59, 0.6); display: flex; flex-direction: column; gap: 4px; margin-bottom:6px;
}
.selCard { transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
.selCard.selected {
  border-color: #facc15 !important; background: rgba(250, 204, 21, 0.15);
  box-shadow: 0 0 10px rgba(250, 204, 21, 0.4);
}
.barRow{margin:1px 0;display:grid;grid-template-columns:30px 1fr 30px;align-items:center;gap:6px;font-size:10px; color:#cbd5e1;}
.barBox{height:6px;background:#020617;border-radius:3px;overflow:hidden}
.barFill{height:100%;background:var(--primary); box-shadow: 0 0 4px var(--primary);}
.slot { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); margin-bottom: 6px;}
.pill { width: 20px; height: 20px; border-radius: 4px; background: #334155; color: #0f172a; font-weight: 800; font-size: 11px; display: grid; place-items: center; }
.slot select { flex: 1; background: transparent; border: none; color: #fff; font-weight: 700; font-size: 13px; outline: none; }
.slot select option { background: #0f172a; color: #fff; }

#jankenOverlay,#cutIn,#switchModal,#infoModal,#rulesModal,#result{position:fixed;inset:0;z-index:100;pointer-events:none;display:none;align-items:center;justify-content:center}
#switchModal,#infoModal,#rulesModal,#result{background:rgba(0,0,0,0.85);pointer-events:auto;backdrop-filter:blur(8px)}
#jankenOverlay.active{display:flex;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
#cutIn.show,#switchModal.show,#infoModal.show,#rulesModal.show,#result.show{display:flex}

.modalCard {
  width:min(400px,90vw); max-height:80vh; overflow-y:auto;
  background: linear-gradient(160deg, #1e293b, #0f172a);
  border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.8); animation: popIn 0.2s
}
.modalHead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; }
@keyframes popIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}

.jkWrap{display:flex;flex-direction:column;align-items:center;gap:30px}
.jkHands{display:flex;gap:40px;align-items:center}
.jkHand{font-size:80px;transition:transform .2s;opacity:0;transform:scale(0)}
.jkHand.show{opacity:1;transform:scale(1)}
.jkHand#jkHandA.win { transform: scale(1.4) rotate(-20deg) !important; filter: drop-shadow(0 0 30px #fcd34d); z-index: 10; }
.jkHand#jkHandB.win { transform: scale(1.4) rotate(20deg) !important; filter: drop-shadow(0 0 30px #ef4444); z-index: 10; }
.jkHand.lose { filter: grayscale(1) brightness(0.3); opacity: 0.5; transform: scale(0.8); }
.jkResult{font-family:'Teko';font-size:80px;font-weight:700;color:#fff;text-shadow:0 0 30px rgba(255,255,255,0.5);opacity:0;transform:translateY(20px);transition:all .3s}
.jkResult.show{opacity:1;transform:translateY(0)}

#cutIn {
  background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.9) 20%, rgba(59, 130, 246, 0.9) 80%, transparent 100%);
  border-top: 2px solid #93c5fd; border-bottom: 2px solid #93c5fd;
  transform: skewX(-10deg) scaleY(0); transform-origin: center;
  box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); flex-direction:column; height:120px;
}
#cutIn.show { transform: skewX(-10deg) scaleY(1); }
.cutInText { 
  font-family: 'M PLUS 1p'; font-style: italic; font-size: 36px; font-weight: 900; color: #fff;
  text-shadow: 0 0 10px rgba(255,255,255,0.8); letter-spacing: 0.1em;
}
.cutInSub{font-size:14px;color:#93c5fd;font-weight:700;}

@media(min-width: 600px) {
  .padInner { gap: 32px; flex-wrap: nowrap; }
  .sideBtns { width: 120px; flex-direction: column; }
  .rps { width: 80px; height: 80px; }
}
</style>
</head>
<body>

<div class="bg-anim"></div>

<div class="container" id="setup">
  <section class="card">
    <h2>
      <button class="btnTiny" id="btnBack">‚Üê Êàª„Çã</button>
      <span>TEAM SETUP</span>
      <button class="btnTiny" id="btnRules">„É´„Éº„É´</button>
    </h2>
    <div class="body">
      <div id="teamGrid">
        <div style="margin-bottom:8px"><div class="statsHead" style="color:#60a5fa;font-weight:900;font-size:12px;margin-bottom:4px">YOU</div><div id="teamA"></div></div>
        <div><div class="statsHead" style="color:#f87171;font-weight:900;font-size:12px;margin-bottom:4px">CPU</div><div id="teamB"></div></div>
      </div>
      <div style="display:flex; gap:8px; margin-top:16px">
        <button id="btnRand" class="btn3d btn-ghost" style="flex:0 0 auto">„É©„É≥„ÉÄ„É†</button>
        <button id="btnStart" class="btn3d btn-primary" style="flex:1">BATTLE START</button>
      </div>
    </div>
  </section>
  <section class="card">
    <h2><span>STATUS DETAIL</span></h2>
    <div class="body">
      <div id="statsGrid">
        <div style="margin-bottom:8px"><div class="statsCol" id="statsA"></div></div>
        <div><div class="statsCol" id="statsB"></div></div>
      </div>
    </div>
  </section>
</div>

<div id="battle">
  <div class="arena" id="arena">
    <div class="vsrow">
      <div id="leftWrap"></div>
      <div id="rightWrap"></div>
    </div>
  </div>
  <div class="logWrapper">
    <div class="logHeader">BATTLE LOG</div>
    <div class="logContainer" id="battleLog"></div>
  </div>
  <div class="benchRow" id="benchRow"></div>
  <section class="padCard" id="pad">
    <div class="padHead">
      <div style="flex:1"></div>
      <div>TIME <span class="timerVal" id="countNum">15</span></div>
      <div style="flex:1"></div>
    </div>
    <div class="padInner">
      <div class="rpsArea">
        <button class="rps g" id="btnG"><div class="emo">‚úä</div></button>
        <button class="rps c" id="btnC"><div class="emo">‚úåÔ∏è</div></button>
        <button class="rps p" id="btnP"><div class="emo">üñê</div></button>
      </div>
      <div class="sideBtns">
        <button class="cmdBtn btn-sp" id="btnSP" disabled>ÂøÖÊÆ∫ÊäÄ</button>
        <button class="cmdBtn btn-switch" id="btnSwitch">‰∫§‰ª£</button>
      </div>
    </div>
  </section>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">‚úä</div><div style="color:#fff;font-weight:900;font-size:30px;font-family:'Teko'">VS</div><div class="jkHand" id="jkHandB">‚úåÔ∏è</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px">„É°„É≥„Éê„Éº‰∫§‰ª£</h3><button class="btnTiny" id="swCancel">Èñâ„Åò„Çã</button></div><div id="switchGrid"></div><button id="swDo" class="btn3d btn-primary" style="width:100%;margin-top:16px" disabled>„Åì„ÅÆ„Ç≠„É£„É©„Å´‰∫§‰ª£</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px">Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„Çπ</h3><button class="btnTiny" id="infoClose">Èñâ„Åò„Çã</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px">„É´„Éº„É´Ë™¨Êòé</h3><button class="btnTiny" id="rulesClose">Èñâ„Åò„Çã</button></div><ul style="padding-left:20px;line-height:1.8;color:#cbd7f0;font-size:13px;list-style-type:square"><li>3‰Ωì„ÅÆ„ÄåË®ÄËëâ„Äç„Åß„ÉÅ„Éº„É†„ÇíÁµÑ„Çì„ÅßÊà¶„ÅÜ„Çø„Éº„É≥Âà∂„Éê„Éà„É´„ÄÇ</li><li>„Åò„ÇÉ„Çì„Åë„Çì„Å´<strong>Âãù„Å§„Å®ÊîªÊíÉ</strong>„ÄÅ<strong>Ë≤†„Åë„Çã„Å®Èò≤Âæ°</strong>„ÄÇ</li><li><strong>„Çø„Ç§„ÉóÁõ∏ÊÄß</strong>„ÅåÈáçË¶ÅÔºàÊúâÂà©1.5ÂÄç / ‰∏çÂà©0.67ÂÄçÔºâ„ÄÇ</li><li>ÊîªÊíÉ„ÉªË¢´Âºæ„Åß„Ç≤„Éº„Ç∏„ÅåÊ∫ú„Åæ„Çä„ÄÅMAX(6)„Åß<strong>ÂøÖÊÆ∫ÊäÄ</strong>Áô∫ÂãïÔºÅ</li><li>Áõ∏Êâã„ÉÅ„Éº„É†„ÇíÂÖ®Âì°ÂÄí„Åõ„Å∞ÂãùÂà©ÔºÅ</li></ul></div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:32px;background:rgba(15,23,42,0.95)"><h1 id="resTitle" style="color:#fff;margin:0 0 16px;font-size:48px;font-family:'Teko';text-shadow:0 0 30px rgba(255,255,255,0.6)">WIN</h1><p style="color:#94a3b8;font-size:12px;font-family:'Teko';letter-spacing:0.1em">RETURNING TO SETUP...</p></div></div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop></audio>
<audio id="seHit" src="audio/hit.mp3"></audio>
<audio id="seSkill" src="audio/skill.mp3"></audio>
<audio id="seKO" src="audio/ko.mp3"></audio>

<script>
(()=> {
'use strict';
const $ = id => document.getElementById(id);
const qs = (s, el = document) => el.querySelector(s);
const delay = ms => new Promise(r => setTimeout(r, ms));

function playBGM(){ const a = $('bgm'); if(!a) return; if(a.paused){ a.volume = 0.25; a.play().catch(()=>{}); } }
function stopBGM(){ const a = $('bgm'); if(a){ a.pause(); a.currentTime = 0; } }
function playSE(type){
  let el = null; if(type === 'hit') el = $('seHit'); else if(type === 'skill') el = $('seSkill'); else if(type === 'ko') el = $('seKO');
  if(el){ try{ el.currentTime = 0; el.play(); }catch(e){} }
}

const IMG = {
  "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"parabola_antenna.png", "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"nescafe_ambassador.png",
  "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"ninjin_shirishiri.png", "„Åù„Åº„Çç„Åî„ÅØ„Çì":"soboro_gohan.png",
  "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"western_lowland_gorilla.png", "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"kemukujara.png",
  "‰πùÂìÅ‰ªè":"kuhonbutsu.png", "„Åë„Çì„Å°„ÇìÊ±Å":"kenchin_jiru.png",
  "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"kamchatka_peninsula.png", "„Çø„É©„É≥„ÉÅ„É•„É©":"tarantula.png",
  "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"shoebill.png", "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"balsamic_vinegar.png",
  "„Éî„É≠„É™Ëèå":"helicobacter_pylori.png", "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"trinidad_and_tobago.png",
  "„Ç´„É©„É°„É´Ëâ≤Á¥†":"caramel_color.png", "„Éê„Éì„É≠„É≥ÊçïÂõö":"babylonian_captivity.png",
  "È≥•ÂèñÁ†Ç‰∏ò":"tottori_sand_dunes.png", "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"placebo_effect.png",
  "Ê∏°Êù•‰∫∫":"torai_jin.png", "„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png",
  "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"peperoncino.png", "„Éù„É™„Éó„É≠„Éî„É¨„É≥":"polypropylene.png",
  "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"sarajevo_incident.png", "„ÇØ„Éû„É≥„Éê„ÉÅ":"kumabachi.png",
  "ÁúåÂ∫ÅÊâÄÂú®Âú∞":"prefectural_capital.png", "ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"teriyaki_chicken.png",
  "„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"nerunerunerune.png", "„Çπ„É´„É°„Ç§„Ç´":"surume_ika.png",
  "Êú¨Ë≥™":"essence.png", "Ë¶ã„Åà„ÇãÂåñ":"mieruka.png",
  "Ëá™ÂàÜ„Åî„Å®Âåñ":"jibungotoka.png", "Ëß£ÂÉèÂ∫¶":"resolution.png"
};
function preloadImgs(names){
  const unique = [...new Set(names.map(n => IMG[n]).filter(Boolean))];
  unique.forEach(f => { const im = new Image(); im.src = `images/${f}`; });
}

function log(msg, type = 'normal'){
  const c = $('battleLog'); if(!c) return;
  const d = document.createElement('div');
  let icon = ''; if(type === 'atk') icon = '‚öîÔ∏è'; else if(type === 'dmg') icon = 'üí•'; else if(type === 'heal') icon = 'üíñ'; else if(type === 'sp') icon = '‚ú®'; else if(type === 'miss') icon = 'üí®';
  d.className = 'logLine ' + type; d.textContent = (icon ? icon + ' ' : '') + msg;
  c.appendChild(d); c.scrollTop = c.scrollHeight;
}

function updateHPUI(role, val, max){
  const bar = $(`hp-${role}`); const num = $(`hpnum-${role}`);
  if(bar){
    const pct = (val / max) * 100; bar.style.width = `${pct}%`; bar.className = 'hpBar';
    if(pct > 50) bar.classList.add('high'); else if(pct > 20) bar.classList.add('mid'); else bar.classList.add('low');
  }
  if(num) num.textContent = val;
}

function fitName(el){
  if(!el) return; const len = el.textContent.length;
  if(len > 10) el.style.fontSize = '10px'; else if(len > 7) el.style.fontSize = '11px'; else el.style.fontSize = '13px';
}

function showFloatingText(targetId, text, type, opts = {}){
  const wrap = $(targetId); if(!wrap) return;
  const existing = wrap.querySelectorAll('.floatingText');
  existing.forEach(e => e.remove());

  const el = document.createElement('div'); el.className = 'floatingText ' + type; el.textContent = text;
  wrap.appendChild(el); setTimeout(() => el.remove(), opts.duration || 1500);
}

async function showCutIn(skill, user){
  $('cutInName').textContent = skill; $('cutInUser').textContent = user;
  const el = $('cutIn'); el.classList.add('show'); await delay(1200); el.classList.remove('show'); await delay(200);
}

function shakeScreen(){
  const a = $('arena'); a.classList.remove('shake'); void a.offsetWidth; a.classList.add('shake');
}

let inputLocked = false;
function lockInputs(on){
  inputLocked = on; const p = $('pad'); if(p) p.style.opacity = on ? 0.6 : 1;
  ['btnG','btnC','btnP','btnSwitch'].forEach(id => { const el = $(id); if(el) el.disabled = on; });
  updateSPBtn();
}

const TYPES_RING = ['„Éí„Çπ„Éà„É™„Éº','„Ç∏„Ç™','„Ç≥„É≥„Çª„Éó„Éà','„Çµ„Ç§„Ç®„É≥„Çπ','„Ç¢„Éã„Éû„É´','„Éí„É•„Éº„Éû„É≥','„Éï„Éº„Éâ'];
const TYPE_COLORS = {
  '„Ç∏„Ç™':'#6366f1', '„Ç¢„Éã„Éû„É´':'#22c55e', '„Éï„Éº„Éâ':'#f97316',
  '„Ç≥„É≥„Çª„Éó„Éà':'#d946ef', '„Çµ„Ç§„Ç®„É≥„Çπ':'#06b6d4', '„Éí„Çπ„Éà„É™„Éº':'#ec4899', '„Éí„É•„Éº„Éû„É≥':'#84cc16'
};
const typeColor = t => TYPE_COLORS[t] || '#94a3b8';

const typeMult = (atk, def) => {
  const n = TYPES_RING.length; const i = TYPES_RING.indexOf(atk); const j = TYPES_RING.indexOf(def);
  if(i < 0 || j < 0) return 1;
  const st = [(i+1)%n,(i+2)%n]; const wk = [(i-1+n)%n,(i-2+n)%n];
  if(st.includes(j)) return 1.5; if(wk.includes(j)) return 0.67; return 1;
};
const PRANK = {S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE = {S:560,A:540,B:520,C:500,D:480,X:500};
const toKatakana = s => (s || '').replace(/[„ÅÅ-„Çì]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
const visualLen = s => (s || '').replace(/[„Éª\s]/g,'').length;
const reKanaH = /[„ÅÅ-„Çü]/g, reKanaK = /[„Ç†-„Éø„Éº]/g, reKanji = /[‰∏Ä-Èæ•„ÄÖ„ÄÜ„Éµ„É∂]/g;
function countClass(name){
  const H = (name.match(reKanaH) || []).length; const K = (name.match(reKanaK) || []).length; const J = (name.match(reKanji) || []).length;
  return {H,K,J,total:H+K+J};
}
const reSmallK = /[„Ç°„Ç£„Ç•„Çß„Ç©„É£„É•„Éß„ÉÆ„á∞-„áø]/g, reSokuon=/„ÉÉ/g, reVoiced=/[„Ç¨-„Éù„É¥]/g, rePlosiveEnd=/[„ÉÑ„ÉÉ„ÇØ„Ç≠„ÉÅ„ÉÜ„Éà„Éó„Éî„Éö„Éù„Ç´„Çø]$/;
function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5; const cls = countClass(name);
  if(cls.J+cls.K===0){ atkP += 12.5; defP += 12.5; }else{ const r = cls.K/(cls.J+cls.K); atkP += 25*r; defP += 25*(1-r); }
  const Lph = yomiKatakana.length || 1;
  const d = (yomiKatakana.match(reVoiced)||[]).length/Lph; const s = (yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m = (yomiKatakana.match(reSmallK)||[]).length/Lph; const e = rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw = 0.6*d + 0.25*(s+m) + 0.15*e;
  const L = 0.05, U = 0.45; const s_ph = Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph = 20*(0.5+0.5*s_ph); atkP += atk_ph; defP += 20-atk_ph;
  const T = visualLen(name); const s_len = Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len = 20*(0.5+0.5*s_len); atkP += atk_len; defP += 20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
  const cls = countClass(name); const hiraRatio = cls.total ? (cls.H/cls.total) : 0;
  const rankAdj = ({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank] ?? 0;
  let eva = 10 + 8*hiraRatio - 0.5*(T-5) + rankAdj; eva = Math.round(eva*10)/10;
  return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiH]){
  const y = toKatakana(yomiH || name); const {atkP,defP,T} = calcAttackDefense(name,y);
  const ATK = Math.round(PRANK[rank]*(atkP/100)); const DEF = Math.round(PRANK[rank]*(defP/100));
  const HP  = Math.round(HP_BASE[rank]+20*(T-5)); const EVA = calcEvasion(name,T,rank);
  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,
          shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

const SKILLS = {
  "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":["Â¶®ÂÆ≥ÈõªÊ≥¢","Â®ÅÂäõ2.2ÂÄç„ÄÇÁõ∏Êâã„ÅÆÂøÖÊÆ∫„Ç≤„Éº„Ç∏„Çí0„Å´„Åô„Çã„ÄÇ"],
  "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":["‰∏ÄÊùØ„ÅÑ„Åã„Åå","ÊîªÊíÉÂæå„ÄÅÂë≥ÊñπÂÖ®Âì°HP60ÂõûÂæ©„ÄÇ"],
  "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":["„Å™„Çì„Åè„Çã„Å™„ÅÑ„Åï„Éº","Â®ÅÂäõ1.6ÂÄç„ÄÇËá¥ÂëΩÂÇ∑„Çí1ÂõûHP1„ÅßËÄê„Åà„Çã„ÄÇ"],
  "„Åù„Åº„Çç„Åî„ÅØ„Çì":["„Åù„Åº„Çç‰π±Ëàû","3ÂõûÈÄ£Á∂öÊîªÊíÉÔºà0.75‚Üí0.5‚Üí0.25ÂÄçÔºâ„ÄÇ"],
  "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":["„Éû„Ç¶„É≥„ÉÜ„É≥„Éì„Éº„Éà","Â®ÅÂäõ1.5ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅËá™ÂàÜÊîªÊíÉ1.3ÂÄç„ÄÇ"],
  "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":["„É†„ÇØ„Ç∏„É£„É©„É©","Â®ÅÂäõ1.4ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅÂõûÈÅøÁéá60%Âõ∫ÂÆö„ÄÇ"],
  "‰πùÂìÅ‰ªè":["‰ªè„ÅÆÈ°î„ÇÇ‰∏âÂ∫¶„Åæ„Åß","Â®ÅÂäõ1.6ÂÄç„ÄÇÊ¨°„ÅÆ2Âõû„ÄÅË¢´„ÉÄ„É°ÂçäÊ∏õ„ÄÇ"],
  "„Åë„Çì„Å°„ÇìÊ±Å":["Èï∑ÂØø„ÅÆÁßòË®£","Â®ÅÂäõ1.2ÂÄç„ÄÇËá™ÂàÜHP150ÂõûÂæ©„ÄÇ"],
  "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"], "„Çø„É©„É≥„ÉÅ„É•„É©":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
  "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"], "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
  "„Éî„É≠„É™Ëèå":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"], "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
  "„Ç´„É©„É°„É´Ëâ≤Á¥†":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"], "„Éê„Éì„É≠„É≥ÊçïÂõö":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
  "È≥•ÂèñÁ†Ç‰∏ò":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"], "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
  "Ê∏°Êù•‰∫∫":["ÊñáÂ≠óÂåñ„Åë","Áõ∏Êâã„ÅØ3„Çø„Éº„É≥Âæå„Å´Êà¶Èóò‰∏çËÉΩ„ÄÇ"], "„Åï„Çã„Å≥„ÅÇ‰∏∏":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"],
  "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"], "„Éù„É™„Éó„É≠„Éî„É¨„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
  "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":["Ë®ÄËëâÁã©„Çä","Áõ∏Êâã„ÅØÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„ÄÇ"], "„ÇØ„Éû„É≥„Éê„ÉÅ":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
  "ÁúåÂ∫ÅÊâÄÂú®Âú∞":["ÊñáÂ≠óÂåñ„Åë","Áõ∏Êâã„ÅØ3„Çø„Éº„É≥Âæå„Å´Êà¶Èóò‰∏çËÉΩ„ÄÇ"], "ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":["Ë®ÄË´ñÁµ±Âà∂","Áõ∏Êâã„ÅØ4„Çø„Éº„É≥‰∫§‰ª£‰∏çÂèØ„ÄÇ"],
  "„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"], "„Çπ„É´„É°„Ç§„Ç´":["„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£ä","Áõ∏Êâã„Å´Ëá™ÂÇ∑ÂäπÊûúÔºà3TÔºâ„ÄÇ"],
  "Êú¨Ë≥™":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"], "Ë¶ã„Åà„ÇãÂåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"],
  "Ëá™ÂàÜ„Åî„Å®Âåñ":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"], "Ëß£ÂÉèÂ∫¶":["Èè°ÊñáÂ≠ó","Áõ∏Êâã„ÅÆÂøÖÊÆ∫„Çí„Ç≥„Éî„ÉºÔºàÂ®ÅÂäõ2ÂÄçÔºâ„ÄÇ"]
};
const WORDS_BASE = [
  ["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","S","„Çµ„Ç§„Ç®„É≥„Çπ","„Å±„Çâ„Åº„Çâ„ÅÇ„Çì„Å¶„Å™"], ["„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº","S","„Éí„É•„Éº„Éû„É≥","„Å≠„Åô„Åã„Åµ„Åá„ÅÇ„Çì„Å∞„Åï„Å†„Éº"],
  ["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","A","„Éï„Éº„Éâ","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä"], ["„Åù„Åº„Çç„Åî„ÅØ„Çì","A","„Éï„Éº„Éâ","„Åù„Åº„Çç„Åî„ÅØ„Çì"],
  ["„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","A","„Ç¢„Éã„Éû„É´","„Å´„Åó„Çç„Éº„Çâ„Çì„Å©„Åî„Çä„Çâ"], ["ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","A","„Ç¢„Éã„Éû„É´","„Åë„ÇÄ„Åè„Åò„ÇÉ„Çâ"],
  ["‰πùÂìÅ‰ªè","A","„Ç∏„Ç™","„Åè„Åª„Çì„Å∂„Å§"], ["„Åë„Çì„Å°„ÇìÊ±Å","A","„Éï„Éº„Éâ","„Åë„Çì„Å°„Çì„Åò„Çã"],
  ["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","B","„Ç∏„Ç™","„Åã„ÇÄ„Å°„ÇÉ„Å£„Åã„ÅØ„Çì„Å®„ÅÜ"], ["„Çø„É©„É≥„ÉÅ„É•„É©","B","„Ç¢„Éã„Éû„É´","„Åü„Çâ„Çì„Å°„ÇÖ„Çâ"],
  ["„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","B","„Ç¢„Éã„Éû„É´","„ÅØ„Åó„Å≥„Çç„Åì„ÅÜ"], ["„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","B","„Éï„Éº„Éâ","„Å∞„Çã„Åï„Åø„Åì„Åô"],
  ["„Éî„É≠„É™Ëèå","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Å¥„Çç„Çä„Åç„Çì"], ["„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","B","„Ç∏„Ç™","„Å®„Çä„Å´„Å†„Éº„Å©„Å®„Å∞„Åî"],
  ["„Ç´„É©„É°„É´Ëâ≤Á¥†","B","„Çµ„Ç§„Ç®„É≥„Çπ","„Åã„Çâ„ÇÅ„Çã„Åó„Åç„Åù"], ["„Éê„Éì„É≠„É≥ÊçïÂõö","C","„Éí„Çπ„Éà„É™„Éº","„Å∞„Å≥„Çç„Çì„Åª„Åó„ÇÖ„ÅÜ"],
  ["È≥•ÂèñÁ†Ç‰∏ò","C","„Ç∏„Ç™","„Å®„Å£„Å®„Çä„Åï„Åç„ÇÖ„ÅÜ"], ["„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","C","„Çµ„Ç§„Ç®„É≥„Çπ","„Å∑„Çâ„Åó„Éº„Åº„Åì„ÅÜ„Åã"],
  ["Ê∏°Êù•‰∫∫","C","„Éí„É•„Éº„Éû„É≥","„Å®„Çâ„ÅÑ„Åò„Çì"], ["„Åï„Çã„Å≥„ÅÇ‰∏∏","C","„Ç∏„Ç™","„Åï„Çã„Å≥„ÅÇ„Åæ„Çã"],
  ["„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","C","„Éï„Éº„Éâ","„Å∫„Å∫„Çç„Çì„Å°„Éº„ÅÆ"], ["„Éù„É™„Éó„É≠„Éî„É¨„É≥","C","„Çµ„Ç§„Ç®„É≥„Çπ","„ÅΩ„Çä„Å∑„Çç„Å¥„Çå„Çì"],
  ["„Çµ„É©„Ç®„Éú‰∫ã‰ª∂","C","„Éí„Çπ„Éà„É™„Éº","„Åï„Çâ„Åà„Åº„Åò„Åë„Çì"], ["„ÇØ„Éû„É≥„Éê„ÉÅ","D","„Ç¢„Éã„Éû„É´","„Åè„Åæ„Çì„Å∞„Å°"],
  ["ÁúåÂ∫ÅÊâÄÂú®Âú∞","D","„Ç∏„Ç™","„Åë„Çì„Å°„Çá„ÅÜ„Åó„Çá„Åñ„ÅÑ„Å°"], ["ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","D","„Éï„Éº„Éâ","„Å¶„Çä„ÇÑ„Åç„Å°„Åç„Çì"],
  ["„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","D","„Éï„Éº„Éâ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠"], ["„Çπ„É´„É°„Ç§„Ç´","D","„Ç¢„Éã„Éû„É´","„Åô„Çã„ÇÅ„ÅÑ„Åã"],
  ["Êú¨Ë≥™","X","„Ç≥„É≥„Çª„Éó„Éà","„Åª„Çì„Åó„Å§"], ["Ë¶ã„Åà„ÇãÂåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åø„Åà„Çã„Åã"],
  ["Ëá™ÂàÜ„Åî„Å®Âåñ","X","„Ç≥„É≥„Çª„Éó„Éà","„Åò„Å∂„Çì„Åî„Å®„Åã"], ["Ëß£ÂÉèÂ∫¶","X","„Ç≥„É≥„Çª„Éó„Éà","„Åã„ÅÑ„Åû„ÅÜ„Å©"]
];
const makeW = i => makeWordObject(WORDS_BASE[i]);

const state = { A:{team:[],i:0,sp:0}, B:{team:[],i:0,sp:0}, remain:15, timer:null, spOn:false, busy:false, spAnnA:false, history:new Set(), suppressAffToastOnce:false };
let forceSwitch = false;
const left  = () => state.A.team[state.A.i]; const right = () => state.B.team[state.B.i];

function barRow(label,val,max){
  const pct = Math.min(100,(val/max)*100);
  return `<div class="barRow"><div class="barLabel">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="barVal">${val}</div></div>`;
}
function miniCard(idx){
  const w = makeW(idx);
  return `<div class="setupMini" style="--typeC:${typeColor(w.type)}" data-type="${w.type}">
    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px;font-weight:700"><div>${w.name}</div><div style="color:var(--typeC)">${w.type}/${w.rank}</div></div>
    <div class="statGrid">${barRow('HP',w.maxhp,800)}${barRow('ATK',w.atk,120)}${barRow('DEF',w.def,120)}${barRow('EVA',w.eva,30)}</div></div>`;
}
function renderMini(side){
  const root = side === 'A' ? $('statsA') : $('statsB'); root.innerHTML = '';
  for(let i=0;i<3;i++){
    const idx = Number($(`${side}-${i}`).value) || 0; root.innerHTML += miniCard(idx);
    const pill = $(`${side}-pill-${i}`);
    if(pill){ pill.style.background = typeColor(WORDS_BASE[idx][2]); pill.style.color = '#fff'; pill.style.boxShadow='0 0 6px var(--glass-border)'; }
  }
}
function uniqueRandom(n, sourceLen){
  const arr = []; const pool = Array.from({length:sourceLen},(_,i)=>i);
  for(let i=0;i<n;i++){ const idx = Math.floor(Math.random()*pool.length); arr.push(pool[idx]); pool.splice(idx,1); }
  return arr;
}
function makeTeam(root,side){
  root.innerHTML = '';
  for(let i=0;i<3;i++){
    const div = document.createElement('div'); div.className = 'slot';
    const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = '#' + (i+1); pill.id = `${side}-pill-${i}`;
    const sel = document.createElement('select'); sel.id = `${side}-${i}`;
    WORDS_BASE.forEach((w,idx)=>{ const o = document.createElement('option'); o.value = idx; o.textContent = `${w[0]} [${w[2]}/${w[1]}]`; sel.append(o); });
    sel.addEventListener('change', () => renderMini(side)); div.append(pill,sel); root.append(div);
  }
  const picks = uniqueRandom(3,WORDS_BASE.length); picks.forEach((v,i) => $(`${side}-${i}`).value = v); renderMini(side);
}
function randomizeTeam(side){
  const picks = uniqueRandom(3,WORDS_BASE.length); for(let i=0;i<3;i++){ $(`${side}-${i}`).value = picks[i]; } renderMini(side);
}
const collect = side => [0,1,2].map(i=>{ const idx = Number($(`${side}-${i}`).value) || 0; return {...makeW(idx), side}; });

function updateSPBtn(){
  const btn = $('btnSP'); if(!btn) return;
  const ready = state.A.sp >= 6; const canPress = !inputLocked && ready && !state.busy;
  btn.disabled = !canPress;
  if(state.spOn){ btn.innerHTML = '<span>‚ú®</span> ON'; btn.className = 'cmdBtn btn-sp on'; }
  else if(ready && !inputLocked){ btn.innerHTML = '<span>PUSH!</span>'; btn.className = 'cmdBtn btn-sp ready'; }
  else{ btn.innerHTML = '<span>ÂøÖÊÆ∫ÊäÄ</span>'; btn.className = 'cmdBtn btn-sp'; }
  if(ready && !state.spAnnA){ log('ÂøÖÊÆ∫„Ç≤„Éº„Ç∏MAXÔºÅ','highlight'); state.spAnnA = true; }
}

async function playJankenAnim(myH,cpuH,res){
  const map={G:'‚úä',C:'‚úåÔ∏è',P:'üñê'}; const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
  ov.classList.add('active'); hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
  hA.textContent=map[myH]; hB.textContent=map[cpuH];
  await delay(50); hA.classList.add('show'); hB.classList.add('show'); await delay(400);
  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
  else{ rs.textContent='DRAW'; rs.style.color='#ffd900'; }
  rs.classList.add('show'); await delay(800); ov.classList.remove('active');
}

function checkAffinity(){
  const a = left(), b = right(); const pairKey = `${a.name}:${b.name}`; const m1 = typeMult(a.type,b.type);
  if(state.suppressAffToastOnce){ state.suppressAffToastOnce = false; return; }
  if(!state.history.has(pairKey)){
    state.history.add(pairKey);
    if(m1>=1.5){ showFloatingText('leftWrap','Áõ∏ÊÄßÊúâÂà©!','heal'); log(`„ÄêÊúâÂà©„Äë${a.name}„ÅØ${b.name}„Å´Âº∑„ÅÑÔºÅ`,'heal'); }
    else if(m1<=0.7){ showFloatingText('leftWrap','Áõ∏ÊÄß‰∏çÂà©...','dmg'); log(`„Äê‰∏çÂà©„Äë${a.name}„ÅØ${b.name}„Å´Âº±„ÅÑ...`,'dmg'); }
  }
}

function buildBoxes(){
  const row = $('benchRow'); if(!row) return;
  const mk = (u,i,isActive) => `<div class="resIcon ${u.hp<=0?'dead':''} ${isActive?'active':''}" onclick="window._sh('${u.name}')" style="border-color:${typeColor(u.type)}">${u.name.charAt(0)}</div>`;
  const l = state.A.team.map((u,i)=>mk(u,i,i===state.A.i)).join(''); const r = state.B.team.map((u,i)=>mk(u,i,i===state.B.i)).join('');
  row.innerHTML = `<span class="benchLabel">YOU</span>${l}<span class="benchLabel" style="margin:0 4px">VS</span>${r}<span class="benchLabel">CPU</span>`;
}

function renderCard(u,role){
  const sp = role==='ally'?state.A.sp:state.B.sp; const owner = role==='ally'?'YOU':'CPU';
  const img = IMG[u.name] ? `<img src="images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none';">` : `<span style="font-size:40px">üì¶</span>`;
  const skill = (SKILLS[u.name] || ['‚Äî','‚Äî']);
  const pips = [...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
  let badges = ''; if(u.lock>0) badges += `<div class="stBadge">üîíLOCKED</div>`;
  if(u.doom>0) badges += `<div class="stBadge">üëæÊñáÂ≠óÂåñ„Åë</div>`; if(u.selfHurt>0) badges += `<div class="stBadge">üåÄÂ¥©Â£ä</div>`;

  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}"><div class="unitInner">
      <div class="cardHeader"><span class="ownerBadge ${role}">${owner}</span><span class="typeIcon">${u.type}</span></div>
      <div class="cardName" id="nm-${role}">${u.name}</div>
      <div class="artArea" id="art-${role}">${img}</div>
      <div class="statsArea">
        <div class="hpRow"><span class="hpLabel">HP</span><div class="hpNum"><span class="hpCurr" id="hpnum-${role}">${u.hp}</span><span class="hpSlash">/</span><span class="hpMax">${u.maxhp}</span></div></div>
        <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
        <div class="statusRow">${badges}</div>
      </div>
      <div class="bottomSection">
        <div class="skillInfo"><div class="skillN">${skill[0]}</div><div class="skillD">${skill[1]}</div></div>
        <div class="spRow">${pips}</div>
        <div class="footer"><span style="color:#94a3b8">ATK:${u.atk} DEF:${u.def} EVA:${u.eva}%</span><button class="btnStat" onclick="window._sh('${u.name}')">Ë©≥Á¥∞</button></div>
      </div></div></div>`;
}

function renderSides(){
  $('leftWrap').innerHTML  = renderCard(left(),'ally'); $('rightWrap').innerHTML = renderCard(right(),'enemy');
  fitName(qs('#nm-ally')); fitName(qs('#nm-enemy'));
  buildBoxes(); updateSPBtn();
  updateHPUI('ally',left().hp,left().maxhp); updateHPUI('enemy',right().hp,right().maxhp);
  checkAffinity();
}

window._sh = (n)=>{
  const u = [...state.A.team,...state.B.team].find(x=>x.name===n); if(!u) return;
  const skill = SKILLS[u.name] || ['?','?'];
  $('infoBody').innerHTML = `
    <div style="text-align:center;margin-bottom:8px"><h2 style="margin:0;color:${typeColor(u.type)};font-size:18px">${u.name}</h2><div style="font-size:12px;color:#cbd5e1">[${u.rank}/${u.type}]</div></div>
    <div class="setupMini" style="margin-bottom:8px;background:rgba(0,0,0,0.3)"><div class="statGrid">${barRow('HP',u.maxhp,800)}${barRow('ATK',u.atk,120)}${barRow('DEF',u.def,120)}${barRow('EVA',u.eva,30)}</div></div>
    <div style="background:rgba(0,0,0,0.3);padding:8px;border-radius:6px"><div style="font-weight:bold;color:#fcd34d;font-size:13px;margin-bottom:4px">ÊäÄ: ${skill[0]}</div><div style="font-size:12px;color:#cbd5e1;line-height:1.4">${skill[1]}</div></div>`;
  $('infoModal').classList.add('show');
};

function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
  let mult=1, multiSeq=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', skillUser=att.name, notes=[];
  const useName=forcedName ?? att.name; const [title] = (SKILLS[useName]||['‚Äî','‚Äî']); skillTitle=title;
  switch(useName){
    case '„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä': mult=2.2; break; case '„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº': mult=1; notes.push('Âë≥ÊñπÂÖ®Âì°ÂõûÂæ©'); break;
    case '„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä': mult=1.6; att.endure=true; showFloatingText(role==='ally'?'leftWrap':'rightWrap','Ê†πÊÄß','heal'); break;
    case '„Åù„Åº„Çç„Åî„ÅØ„Çì': multiSeq=[0.75,0.5,0.25]; break;
    case '„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©': mult=1.5; att.atk13=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ATK UP','heal'); break;
    case 'ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ': mult=1.4; att.eva60=3; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ÂõûÈÅøUP','heal'); break;
    case '‰πùÂìÅ‰ªè': mult=1.6; att.shield=2; showFloatingText(role==='ally'?'leftWrap':'rightWrap','ËªΩÊ∏õ','heal'); break;
    case '„Åë„Çì„Å°„ÇìÊ±Å': mult=1.2; notes.push('Ëá™Â∑±ÂõûÂæ©'); break;
    case '„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂': case '„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶': case '„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢': case '„Éê„Éì„É≠„É≥ÊçïÂõö': case '„Éù„É™„Éó„É≠„Éî„É¨„É≥': case '„ÇØ„Éû„É≥„Éê„ÉÅ': case 'ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥':
      def.lock=4; showFloatingText(role==='ally'?'rightWrap':'leftWrap','LOCKED','dmg'); break;
    case '„Çø„É©„É≥„ÉÅ„É•„É©': case '„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥': case '„Çµ„É©„Ç®„Éú‰∫ã‰ª∂': case '„Åï„Çã„Å≥„ÅÇ‰∏∏':
      def.stun=true; showFloatingText(role==='ally'?'rightWrap':'leftWrap','„Çπ„Çø„É≥','dmg'); break;
    case '„Éî„É≠„É™Ëèå': case '„Ç´„É©„É°„É´Ëâ≤Á¥†': case 'È≥•ÂèñÁ†Ç‰∏ò': case '„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú': case '„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé': case '„Çπ„É´„É°„Ç§„Ç´': case '„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠':
      def.selfHurt=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','Â¥©Â£ä','dmg'); break;
    case 'Ê∏°Êù•‰∫∫': case 'ÁúåÂ∫ÅÊâÄÂú®Âú∞': def.doom=3; showFloatingText(role==='ally'?'rightWrap':'leftWrap','ÊñáÂ≠óÂåñ„Åë','dmg'); break;
    case 'Êú¨Ë≥™': case 'Ë¶ã„Åà„ÇãÂåñ': case 'Ëá™ÂàÜ„Åî„Å®Âåñ': case 'Ëß£ÂÉèÂ∫¶': if(!mirrorMode){ mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; } break;
  }
  return {mult,multiSeq,skillTitle,skillUser,notes};
}
async function spEffectPost(att,def,role,usedName){
  if(usedName==='„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä'){ if(role==='ally') state.B.sp=0; else state.A.sp=0; }
  else if(usedName==='„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº'){
    (role==='ally'?state.A.team:state.B.team).forEach(u => { if(u.hp<u.maxhp) u.hp = Math.min(u.maxhp,u.hp+60); });
    showFloatingText(role==='ally'?'leftWrap':'rightWrap','+60','heal'); renderSides();
  }
  else if(usedName==='„Åë„Çì„Å°„ÇìÊ±Å'){ att.hp=Math.min(att.maxhp,att.hp+150); showFloatingText(role==='ally'?'leftWrap':'rightWrap','+150','heal'); renderSides(); }
}

async function startOfAction(side){
  const me = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  if(me.eva60>0) me.eva60--; if(me.atk13>0) me.atk13--; if(me.lock>0) me.lock--;
  if(me.doom>0){
    me.doom--; if(me.doom<=0){
      me.hp=0; renderSides(); showFloatingText(side==='ally'?'leftWrap':'rightWrap','ÊñáÂ≠óÂåñ„Åë„ÅßÂÄí„Çå„Åü‚Ä¶','dmg',{duration:2200});
      qs(side==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall'); await delay(1000);
      log(`${me.name}„ÅØÊñáÂ≠óÂåñ„Åë„ÅßÂÄí„Çå„ÅüÔºÅ`,'highlight'); const ended = await handleKO(side); return !ended;
    }
  }
  if(me.stun){ me.stun=false; renderSides(); log(`${me.name}„ÅØÂãï„Åë„Å™„ÅÑÔºÅ`,'highlight'); await delay(1000); return false; }
  return true;
}

function judge(a,b){ if(a===b) return 0; if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G')) return 1; return -1; }
function baseDamage(att,def){
  let mult = typeMult(att.type,def.type);
  let val = 100 * (1 + att.atk/100) / (1 + def.def/120) * mult;
  return val * (Math.random()*0.4+0.8);
}

async function doTurn(side){
  const att = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
  let    def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
  const spUse = (side==='ally' && state.spOn && state.A.sp>=6) || (side==='enemy' && state.B.sp>=6);
  let mult=1, multi=null, skillTitle='ÈÄöÂ∏∏ÊîªÊíÉ', usedName=att.name;

  if(spUse){
    if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; } else{ state.B.sp=0; } playSE('skill');
    if(['Êú¨Ë≥™','Ë¶ã„Åà„ÇãÂåñ','Ëá™ÂàÜ„Åî„Å®Âåñ','Ëß£ÂÉèÂ∫¶'].includes(att.name)){
      const foe = (side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X' && u.hp>0);
      if(foe.length){
        const pick = foe[Math.floor(Math.random()*foe.length)]; const pre = spEffectPre(att,def,side,pick.name,true);
        mult=pre.mult*2.0; multi=pre.multiSeq?pre.multiSeq.map(x=>x*2.0):null; skillTitle=pre.skillTitle; usedName=pick.name;
        await showCutIn(skillTitle,att.name); log(`Èè°ÊñáÂ≠óÔºö${pick.name}„Çí„Ç≥„Éî„ÉºÔºÅ`,'sp');
      }else{ mult=2.0; skillTitle='Èè°ÊñáÂ≠ó'; await showCutIn(skillTitle,att.name); }
    }else{
      const pre = spEffectPre(att,def,side); mult=pre.mult; multi=pre.multiSeq; skillTitle=pre.skillTitle;
      await showCutIn(skillTitle,att.name); if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
    }
  }else{ log(`${att.name}„ÅÆÊîªÊíÉ`,'atk'); await delay(400); }

  const eva = def.eva60>0?60:def.eva;
  if(!spUse && Math.random() < (eva/100)){ showFloatingText(side==='ally'?'rightWrap':'leftWrap','MISS','miss'); log('ÊîªÊíÉ„ÇíÂõûÈÅø„Åó„ÅüÔºÅ','miss'); await delay(800); return false; }

  let targetRole = side==='ally'?'enemy':'ally'; const dmgList = (Array.isArray(multi)?multi:[mult]);
  for(let i=0;i<dmgList.length;i++){
    let m = dmgList[i]; let base = baseDamage(att,def)*m; if(att.atk13>0) base *= 1.3;
    if(def.shield>0){ base *= 0.5; def.shield--; showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','GUARD','heal'); }
    let damage = Math.max(1,Math.floor(base)); def.hp = Math.max(0,def.hp-damage); updateHPUI(targetRole,def.hp,def.maxhp);
    playSE('hit'); qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit'); shakeScreen();
    showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap',`-${damage}`,'dmg'); log(`${def.name}„Å´ ${damage} „ÉÄ„É°„Éº„Ç∏`,'dmg');
    await delay(1200); const hitUnit = qs('.unit.hit'); if(hitUnit) hitUnit.classList.remove('hit');
    if(def.hp<=0 && def.endure){ def.endure=false; def.hp=1; updateHPUI(targetRole,1,def.maxhp); showFloatingText(targetRole==='enemy'?'rightWrap':'leftWrap','Ê†πÊÄß','heal'); log('Ê†πÊÄß„ÅßËÄê„Åà„ÅüÔºÅ','highlight'); }
    else if(def.hp<=0){
      qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('fall'); await delay(1000);
      log(`${def.name}„ÅØÂÄí„Çå„ÅüÔºÅ`,'highlight'); const ended = await handleKO(targetRole==='enemy'?'enemy':'ally');
      if(ended) return true;
      if(i<dmgList.length-1){ def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i]; targetRole = side==='ally'?'enemy':'ally'; }
    }
  }

  if(att.selfHurt>0){
    att.selfHurt--;
    if(Math.random()<0.33){
      log('„Ç≤„Ç∑„É•„Çø„É´„ÉàÂ¥©Â£äÔºÅ','dmg'); att.hp = Math.max(0,att.hp-100); const myRole = side==='ally'?'ally':'enemy'; updateHPUI(myRole,att.hp,att.maxhp);
      showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','-100','dmg');
      if(att.hp<=0){ showFloatingText(myRole==='ally'?'leftWrap':'rightWrap','Â¥©Â£ä„ÅßËá™ÊªÖ','dmg',{duration:2200}); qs(myRole==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall'); await delay(1000); log(`${att.name}„ÅØËá™ÊªÖ„Åó„Åü`,'highlight'); return await handleKO(side); }
    }
  }
  if(spUse) await spEffectPost(att,def,side,usedName);
  return false;
}

function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer); state.busy=false; lockInputs(false); checkAffinity();
  setTimeout(()=>{
    if(state.busy) return;
    const cpu = right(); const player = left(); const m = typeMult(cpu.type,player.type);
    if(m<=0.7 && cpu.lock===0 && cpu.hp>0){
      const reserves = [0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0); const best = reserves.find(i => typeMult(state.B.team[i].type,player.type)>=1.5);
      if(best!==undefined && Math.random()<0.7){ cpuSwitchAction(best); return; }
    }
  },1200);
  state.timer=setInterval(()=>{
    if(state.busy) return; state.remain--; $('countNum').textContent=state.remain;
    if(state.remain<=0){ pick(['G','C','P'][Math.floor(Math.random()*3)]); }
  },1000);
}

async function cpuSwitchAction(nextIdx){
  state.busy=true; clearInterval(state.timer); lockInputs(true);
  try{
    log('CPU„Åå‰∫§‰ª£„ÇíÈÅ∏ÊäûÔºÅ','highlight'); await delay(1000);
    state.B.i = nextIdx; state.B.sp = 0; state.suppressAffToastOnce = true; renderSides();
    showFloatingText('rightWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${right().name}`,'heal',{duration:2200}); log(`Áõ∏Êâã„ÅØ ${right().name} „Å´‰∫§‰ª£„Åó„ÅüÔºÅ`,'highlight');
    await delay(1000); log('Áõ∏Êâã„ÅÆÈöô„Å†ÔºÅÊîªÊíÉ„ÅÆ„ÉÅ„É£„É≥„ÇπÔºÅ','highlight');
    const ended = await doTurn('ally'); if(!ended){ state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); startRound(); }
  }catch(e){ console.error(e); startRound(); }finally{ state.busy=false; lockInputs(false); }
}

async function pick(h){
  if(state.busy || inputLocked) return;
  state.busy=true; clearInterval(state.timer); lockInputs(true);
  try{
    const cpu = ['G','C','P'][Math.floor(Math.random()*3)]; const res = judge(h,cpu); await playJankenAnim(h,cpu,res);
    let ko=false; if(res>0){ if(await startOfAction('ally')) ko = await doTurn('ally'); } else if(res<0){ if(await startOfAction('enemy')) ko = await doTurn('enemy'); }
    if(!ko){ state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); if(state.A.sp<6) state.spAnnA=false; renderSides(); log('Ê¨°„ÅÆ„Çø„Éº„É≥','normal'); await delay(600); startRound(); }
  }catch(e){ console.error(e); startRound(); }
}

async function handleKO(side){
  playSE('ko'); const team = side==='ally'?state.A.team:state.B.team; const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);
  if(survivors.length===0){
    stopBGM(); $('resTitle').textContent = side==='enemy'?'YOU WIN!':'YOU LOSE...'; $('result').classList.add('show');
    await delay(3000); $('result').classList.remove('show'); $('battle').style.display='none'; $('setup').style.display='flex'; return true;
  }
  if(side==='enemy'){
    state.B.i = survivors[0].i; state.B.sp = 0; state.suppressAffToastOnce = true; renderSides();
    showFloatingText('rightWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${team[state.B.i].name}`,'heal',{duration:2200}); log(`Áõ∏Êâã„ÅØ ${team[state.B.i].name} „ÇíÁπ∞„ÇäÂá∫„Åó„Åü`,'highlight');
    await delay(1000); startRound(); return true;
  }
  forceSwitch = true; openForceSwitch(survivors.map(o=>o.i)); return true;
}

let swModal, swGrid, swDo, swIdx = null;
function openSwitch(){
  if(left().lock>0){ log('Ë®ÄË´ñÁµ±Âà∂„Å´„Çà„Çä‰∫§‰ª£‰∏çÂèØÔºÅ','highlight'); showFloatingText('leftWrap','LOCKED','dmg'); return; }
  forceSwitch = false; if(!swModal || !swGrid || !swDo) return;
  swGrid.innerHTML = ''; swIdx = null; swDo.disabled = true;
  const idxs = [0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
  if(!idxs.length){ log('‰∫§‰ª£„Åß„Åç„ÇãÊéß„Åà„Åå„ÅÑ„Åæ„Åõ„Çì'); return; }
  const enemy = right();
  idxs.forEach(i=>{
    const u = state.A.team[i]; const skill = SKILLS[u.name]||['?','?']; const m = typeMult(u.type,enemy.type);
    let affText='„Éº Á≠âÂÄç', affClass='color:#cbd5e1'; if(m>=1.5){ affText='‚óé ÊúâÂà©'; affClass='color:#4effa5'; } if(m<=0.7){ affText='‚ñ≥ ‰∏çÂà©'; affClass='color:#ff5c6c'; }
    const div = document.createElement('div'); div.className='setupMini selCard'; div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`<div style="font-size:11px;margin-bottom:2px;font-weight:700">${u.name}</div><div style="font-size:10px;font-weight:bold;${affClass};margin-bottom:2px">ÂØæ ${enemy.name}: ${affText}</div><div class="statGrid">${barRow('HP',u.hp,u.maxhp)}${barRow('ATK',u.atk,120)}${barRow('DEF',u.def,120)}${barRow('EVA',u.eva,30)}</div><div style="font-size:10px;color:#94a3b8;margin-top:2px">ÂøÖÊÆ∫: ${skill[0]}</div>`;
    div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx = i; swDo.disabled = false; };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}
function openForceSwitch(indices){
  if(!swModal || !swGrid || !swDo) return; swGrid.innerHTML=''; swIdx=null; swDo.disabled=true; const enemy = right();
  indices.forEach(i=>{
    const u = state.A.team[i]; if(u.hp<=0) return; const skill = SKILLS[u.name]||['?','?']; const m = typeMult(u.type,enemy.type);
    let affText='„Éº Á≠âÂÄç', affClass='color:#cbd5e1'; if(m>=1.5){ affText='‚óé ÊúâÂà©'; affClass='color:#4effa5'; } if(m<=0.7){ affText='‚ñ≥ ‰∏çÂà©'; affClass='color:#ff5c6c'; }
    const div=document.createElement('div'); div.className='setupMini selCard'; div.style.setProperty('--typeC',typeColor(u.type));
    div.innerHTML=`<div style="font-size:11px;margin-bottom:2px;font-weight:700">${u.name}</div><div style="font-size:10px;font-weight:bold;${affClass};margin-bottom:2px">ÂØæ ${enemy.name}: ${affText}</div><div class="statGrid">${barRow('HP',u.hp,u.maxhp)}${barRow('ATK',u.atk,120)}${barRow('DEF',u.def,120)}${barRow('EVA',u.eva,30)}</div><div style="font-size:10px;color:#94a3b8;margin-top:2px">ÂøÖÊÆ∫: ${skill[0]}</div>`;
    div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx=i; swDo.disabled=false; };
    swGrid.appendChild(div);
  });
  swModal.classList.add('show');
}

document.addEventListener('DOMContentLoaded', () => {
  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
  $('btnStart').onclick = async () => {
    state.A.team = collect('A'); state.B.team = collect('B'); state.A.i = 0; state.B.i = 0; state.A.sp = 0; state.B.sp = 0; state.spOn = false; state.spAnnA = false; state.history = new Set(); state.suppressAffToastOnce = false;
    $('battleLog').innerHTML = ''; $('setup').style.display = 'none'; $('battle').style.display = 'flex';
    playBGM(); preloadImgs([...state.A.team,...state.B.team].map(u=>u.name)); renderSides(); log('„Éê„Éà„É´ÈñãÂßãÔºÅ','highlight'); 
    
    showFloatingText('leftWrap','„Éê„Éà„É´ÈñãÂßãÔºÅ','heal',{duration:1800}); 
    await delay(1000);
    checkAffinity(); 
    await delay(800); startRound();
  };
  $('btnG').onclick = () => pick('G'); $('btnC').onclick = () => pick('C'); $('btnP').onclick = () => pick('P');
  $('btnSP').onclick = () => { if(!inputLocked && state.A.sp>=6){ state.spOn = !state.spOn; updateSPBtn(); } };
  $('btnRand').onclick = () => { randomizeTeam('A'); randomizeTeam('B'); };
  $('btnRules').onclick = () => $('rulesModal').classList.add('show'); $('rulesClose').onclick = () => $('rulesModal').classList.remove('show'); $('infoClose').onclick = () => $('infoModal').classList.remove('show');
  const btnBack = $('btnBack'); if(btnBack){ btnBack.onclick = () => { window.location.href = 'https://kyoryu1039.github.io/kotoba-gacha/'; }; }
  swModal = $('switchModal'); swGrid = $('switchGrid'); swDo = $('swDo'); const btnSwitch = $('btnSwitch'); const swCancel = $('swCancel');
  if(btnSwitch) btnSwitch.onclick = () => { if(!inputLocked) openSwitch(); }; if(swCancel && swModal) swCancel.onclick = () => swModal.classList.remove('show');
  if(swDo){
    swDo.onclick = async () => {
      if(swIdx === null) return; swModal.classList.remove('show'); const newUnit = state.A.team[swIdx];
      state.A.i = swIdx; state.A.sp = 0; state.spOn = false; state.suppressAffToastOnce = true; renderSides();
      showFloatingText('leftWrap',`‰∫§‰ª£ÔºÅ\n„ÇÜ„Åë„ÄÅ${newUnit.name}`,'heal',{duration:2200}); log(`${newUnit.name} „Å´‰∫§‰ª£ÔºÅ`,'highlight');
      if(forceSwitch){ forceSwitch = false; await delay(600); startRound(); }else{ await delay(500); const ended = await doTurn('enemy'); if(!ended){ state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); startRound(); } }
    };
  }
  ['switchModal','infoModal','rulesModal'].forEach(id => { const el = $(id); if(!el) return; el.addEventListener('click', e => { if(e.target === el) el.classList.remove('show'); }); });
});
})(); 
</script>
</body>
</html>
