<!doctype html> 
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>KOTOBA-BATTLE | v46.00 Interlink Fix</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#020617">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700;900&family=Teko:wght@500;600;700&family=M+PLUS+1p:wght@800;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">

<style>
:root{
Â  --bg: #020617; --text: #f1f5f9;
Â  --primary: #3b82f6; --accent: #f59e0b;
Â  /* ã‚¿ã‚¤ãƒ—è‰² */
Â  --t-ã‚¸ã‚ª:#6366f1; --t-ã‚¢ãƒ‹ãƒãƒ«:#22c55e; --t-ãƒ•ãƒ¼ãƒ‰:#f59e0b; 
Â  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#d946ef; --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#06b6d4; --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ec4899; --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#84cc16;
}

*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{ height:100%; margin:0; padding:0; overscroll-behavior: none; }
body{
Â  background-color: var(--bg); color: var(--text);
Â  font-family: 'Noto Sans JP', sans-serif;
Â  background-image: radial-gradient(circle at 50% 30%, #1e293b 0%, #020617 80%);
Â  overflow: hidden;
}

/* CRTèµ°æŸ»ç·š */
body::after {
Â  content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
Â  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
Â  z-index: 999; background-size: 100% 3px, 3px 100%; pointer-events: none;
}

/* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ */
.bg-anim {
Â  position: fixed; inset: -50%; z-index: -1;
Â  background: 
Â  Â  linear-gradient(transparent 98%, rgba(59, 130, 246, 0.08) 99%, transparent 100%),
Â  Â  linear-gradient(90deg, transparent 98%, rgba(59, 130, 246, 0.08) 99%, transparent 100%);
Â  background-size: 80px 80px;
Â  transform: perspective(500px) rotateX(60deg);
Â  opacity: 0.5;
}

.container{ 
Â  max-width:800px; margin:0 auto; padding:8px; 
Â  height: 100%; 
Â  display: flex; flex-direction: column; 
Â  overflow-y: auto; -webkit-overflow-scrolling: touch;
}

/* === ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ === */
#battle {
Â  display: none; flex-direction: column;
Â  height: 100dvh; max-height: 100dvh; width: 100%; max-width: 600px;
Â  margin: 0 auto; padding-bottom: env(safe-area-inset-bottom);
Â  overflow: hidden; gap: 4px;
}

/* é€šçŸ¥ã‚¨ãƒªã‚¢ */
#toastArea {
Â  position: absolute; top: 60px; left: 0; width: 100%;
Â  display: flex; flex-direction: column; align-items: center; gap: 4px;
Â  pointer-events: none; z-index: 200;
}
.sysToast {
Â  font-family: 'M PLUS 1p'; font-weight: 900; font-size: 14px; color: #fff;
Â  background: rgba(0,0,0,0.85); border: 1px solid rgba(255,255,255,0.3);
Â  padding: 4px 12px; border-radius: 4px;
Â  animation: slideInFade 3.5s forwards;
Â  text-shadow: 0 1px 2px rgba(0,0,0,0.8);
Â  max-width: 90%; white-space: nowrap;
}
.sysToast.warn { border-color: #facc15; color: #fef08a; }
.sysToast.info { border-color: #38bdf8; color: #bae6fd; }
.sysToast.heal { border-color: #4ade80; color: #bbf7d0; }
@keyframes slideInFade {
Â  0% { opacity: 0; transform: translateY(10px); }
Â  10% { opacity: 1; transform: translateY(0); }
Â  90% { opacity: 1; transform: translateY(0); }
Â  100% { opacity: 0; transform: translateY(-20px); }
}

/* ã‚¢ãƒªãƒ¼ãƒŠ (ãƒ­ã‚°è¢«ã‚Šå¯¾ç­–: padding-bottomã‚’å¤§å¹…ã«ç¢ºä¿) */
.arena { 
Â  flex: 1; min-height: 0; display: flex; flex-direction: column; 
Â  padding: 6px 6px 20px 6px; /* ä¸‹éƒ¨ã«ååˆ†ãªä½™ç™½ */
Â  position: relative; z-index: 1; 
}
.vsrow { 
Â  flex: 1; min-height: 0; 
Â  display: grid; grid-template-columns: 1fr 1fr; gap: 8px; 
Â  align-items: stretch; perspective: 800px; 
}
.vsrow > div { 
Â  min-width: 0; height: 100%; 
Â  display: flex; flex-direction: column; 
}

/* ãƒ­ã‚° */
.logWrapper { 
Â  flex: 0 0 90px; height: 90px; min-height: 90px;
Â  border-top: 1px solid #334155; border-bottom: 1px solid #334155; 
Â  background: rgba(2, 6, 23, 0.95); 
Â  display: flex; flex-direction: column; position: relative; z-index: 10;
Â  font-family: 'Consolas', monospace;
}
.logHeader { 
Â  background: #1e293b; color: #94a3b8; font-size: 10px; padding: 2px 8px; 
Â  font-weight: 700; flex: 0 0 auto; letter-spacing: 1px; border-bottom: 1px solid #334155;
}
.logContainer { 
Â  flex: 1; overflow-y: auto; padding: 4px 8px; font-size: 11px; 
Â  display: flex; flex-direction: column; gap: 2px; 
Â  -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
}
.logLine { padding: 1px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); flex-shrink: 0; color: #cbd5e1; }
.logLine.highlight { color: #f59e0b; } 
.logLine.dmg { color: #f87171; } .logLine.heal { color: #34d399; }

/* æ§ãˆå¸¯ */
.benchRow { 
Â  flex: 0 0 40px; height: 40px;
Â  display:flex; align-items:center; justify-content:center; gap:8px; 
Â  width:100%; background: rgba(15, 23, 42, 0.95); border-top: 1px solid #334155;
Â  z-index: 10;
}
.benchLabel{ font-weight:700; font-family:'Orbitron'; font-size:9px; color:#64748b; letter-spacing: 1px; }
.resIcon { 
Â  width: 32px; height: 32px; 
Â  background: #1e293b; border: 2px solid #334155; border-radius: 4px;
Â  color: #fff; font-size: 12px; font-weight: 900;
Â  display: grid; place-items: center; cursor: pointer; transition: 0.2s;
Â  position: relative;
}
.resIcon[data-type] { background: var(--typeC); color: #fff; border-color: rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
.resIcon.dead { filter: grayscale(1) brightness(0.3); border-color: #334155; color: #64748b; }
.resIcon.active { transform: scale(1.15); z-index: 2; box-shadow: 0 0 10px #fff; border-color: #fff; }

/* æ“ä½œãƒ‘ãƒãƒ« */
.padCard { 
Â  flex: 0 0 auto; background: rgba(15, 23, 42, 0.95); 
Â  padding: 8px 16px 12px; display: flex; flex-direction: column; justify-content: center;
Â  border-top: 2px solid #334155; position: relative; z-index: 20;
}
.padHead { display: flex; justify-content: center; align-items: center; margin-bottom: 6px; font-size: 11px; color: #94a3b8; font-family: 'Orbitron'; flex: 0 0 auto; }
.timerVal { font-size: 24px; color: #38bdf8; font-weight: 700; margin-left: 8px; text-shadow: 0 0 10px #38bdf8; }

.padInner { display: flex; flex-direction: column; gap: 12px; align-items: center; justify-content: center; }
.rpsArea { display: flex; gap: 20px; justify-content: center; align-items: center; flex: 0 0 auto; }

.rps { 
Â  width: 64px; height: 64px; clip-path: circle(50%);
Â  background: #1e293b; border: none; cursor: pointer; 
Â  display: grid; place-items: center; transition: all .2s;
Â  box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
Â  position: relative; color: #fff;
}
.rps::after { content:''; position:absolute; inset:2px; border-radius:50%; border: 2px solid rgba(255,255,255,0.2); }
.rps.g { background: linear-gradient(145deg, #ef4444, #991b1b); box-shadow: 0 4px 0 #7f1d1d; }
.rps.c { background: linear-gradient(145deg, #3b82f6, #1e40af); box-shadow: 0 4px 0 #1e3a8a; }
.rps.p { background: linear-gradient(145deg, #22c55e, #166534); box-shadow: 0 4px 0 #14532d; }
.rps:active:not([disabled]) { transform: translateY(4px); box-shadow: none; }
.rps:disabled { filter: grayscale(1); opacity: 0.3; cursor: not-allowed; background: #334155; box-shadow: none; }
.emo { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

.sideBtns { display: flex; gap: 8px; width: 100%; max-width: 300px; justify-content: center; flex: 0 0 auto; }
.cmdBtn { 
Â  flex: 1; padding: 12px 0; font-family: 'Noto Sans JP'; font-weight: 800; font-size: 13px; 
Â  border: none; cursor: pointer; color: #fff; transition: .2s;
Â  background: #1e293b; letter-spacing: 0.1em; border-radius: 4px;
}
.cmdBtn:active:not([disabled]) { transform: translateY(2px); }
.cmdBtn:disabled { opacity: 0.4; background: #0f172a; color: #475569; }

.btn-sp { border-bottom: 4px solid #b45309; }
.btn-switch { border-bottom: 4px solid #1e3a8a; }
.btn-sp.ready { 
Â  background: #f59e0b; color: #fff; border-bottom-color: #b45309;
Â  animation: flashBtn 0.8s infinite alternate;
}
.btn-sp.on { background: #dc2626; color: #fff; border-bottom-color: #7f1d1d; animation: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
@keyframes flashBtn { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0.6; transform: scale(0.98); } }

@media(min-width: 600px) {
Â  .padInner { flex-direction: row; gap: 32px; }
Â  .sideBtns { flex-direction: column; width: 140px; }
}

/* === ã‚«ãƒ¼ãƒ‰è©³ç´° === */
.unit {
Â  position: relative; width: 100%; height: 100%; min-height: 0;
Â  border-radius: 6px; padding: 2px;
Â  background: #1e293b; 
Â  display: flex; flex-direction: column;
Â  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
Â  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ ç·šè¨­å®šï¼ˆå¤ªã•ã‚’3pxã«çµ±ä¸€ï¼‰ */
Â  border-width: 3px;
Â  border-style: solid;
Â  border-color: #334155;
}

/* Sãƒ©ãƒ³ã‚¯: çœŸãƒ»è™¹è‰²ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ + å¼·åŠ›ãªè¼ã */
.unit[data-rank="S"] {
Â  border-color: transparent; 
Â  background-image: linear-gradient(#1e293b, #1e293b), 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(120deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
Â  background-size: 100% 100%, 300% 300%;
Â  background-origin: border-box;
Â  background-clip: content-box, border-box;
Â  box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3);
Â  animation: rainbowBorder 3s linear infinite;
}
@keyframes rainbowBorder {
Â  0% { background-position: 0 0, 0% 50%; }
Â  100% { background-position: 0 0, 100% 50%; }
}
.unit[data-rank="S"]::after {
Â  content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 10;
Â  background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.3) 45%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.3) 55%, transparent 70%);
Â  background-size: 250% 250%;
Â  mix-blend-mode: overlay;
Â  animation: shine 4s infinite;
Â  opacity: 0.8;
Â  border-radius: 4px;
}

/* Aãƒ©ãƒ³ã‚¯: é‡‘è‰² */
.unit[data-rank="A"] {
Â  border-color: transparent;
Â  background-image: linear-gradient(#1e293b, #1e293b), linear-gradient(135deg, #b45309, #facc15, #b45309);
Â  background-origin: border-box;
Â  background-clip: content-box, border-box;
Â  box-shadow: 0 0 10px rgba(234, 179, 8, 0.4);
}
.unit[data-rank="A"]::after {
Â  content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 10;
Â  background: linear-gradient(115deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
Â  background-size: 250% 250%;
Â  animation: shine 6s infinite;
Â  opacity: 0.6;
Â  border-radius: 4px;
}

/* Bãƒ©ãƒ³ã‚¯: éŠ€è‰² */
.unit[data-rank="B"] {
Â  border-color: transparent;
Â  background-image: linear-gradient(#1e293b, #1e293b), linear-gradient(135deg, #64748b, #cbd5e1, #64748b);
Â  background-origin: border-box;
Â  background-clip: content-box, border-box;
Â  box-shadow: 0 0 8px rgba(148, 163, 184, 0.4);
}

/* C/D/Xãƒ©ãƒ³ã‚¯: å¤ªã•ã‚’3pxã«çµ±ä¸€ã—ã¦æ˜ç¤º */
.unit[data-rank="C"] { border-color: #a85b26; }
.unit[data-rank="D"] { border-color: #64748b; }
.unit[data-rank="X"] { border-color: #d946ef; animation: glitchBorder 0.2s infinite; }

@keyframes shine { 0% { background-position: 200% 200%; } 100% { background-position: -100% -100%; } }


.unitInner {
Â  flex: 1; display: flex; flex-direction: column;
Â  background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(15, 23, 42, 0.6) 100%);
Â  border-radius: 4px; overflow: hidden; height: 100%; position: relative; z-index: 1;
}
.unitInner::before {
Â  content:""; position:absolute; inset:0; pointer-events:none;
Â  box-shadow: inset 0 -10px 40px -10px var(--typeColor);
Â  opacity: 0.5; z-index: 2;
}

.cardHeader { 
Â  flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; 
Â  padding: 4px 8px; background: rgba(0,0,0,0.6); 
Â  border-bottom: 1px solid rgba(255,255,255,0.1);
Â  position: relative; z-index: 2;
}
.ownerBadge { font-family: 'Orbitron'; font-size: 9px; padding: 1px 4px; background: #0f172a; color: #94a3b8; border-radius: 2px; border: 1px solid #334155; }
.ownerBadge.ally { color: #60a5fa; border-color: #1e40af; }
.ownerBadge.enemy { color: #fca5a5; border-color: #991b1b; }

.typeIcon { 
Â  font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 0; 
Â  background: var(--typeColor); color: #000; 
Â  clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); 
Â  text-shadow: none; letter-spacing: normal; 
}

.cardName { 
Â  flex: 0 0 auto; font-weight: 900; font-size: 14px; color: #fff; 
Â  text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
Â  white-space: nowrap; text-align: center; height: 24px; line-height: 24px; 
Â  background: linear-gradient(90deg, transparent, rgba(var(--typeColor), 0.3), transparent);
Â  letter-spacing: 0.05em; margin-top: 2px;
Â  position: relative; z-index: 2;
}

.subInfo { height: 16px; display: flex; justify-content: center; align-items: center; gap: 6px; margin-bottom: 2px; position:relative; z-index:5; }
.affTag { font-size: 10px; padding: 0 6px; border-radius: 3px; color: #fff; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.2); }
.affTag.good { background: #16a34a; border-color: #4ade80; }
.affTag.bad { background: #dc2626; border-color: #f87171; }

.artArea {
Â  position: relative; width: 100%; flex: 1; min-height: 0; margin: 0; 
Â  display: flex; align-items: center; justify-content: center;
Â  overflow: hidden;
Â  /* ã‚ªãƒ¼ãƒ© */
Â  background: radial-gradient(circle, var(--typeColor) 0%, transparent 70%);
Â  opacity: 0.9; 
}
.artArea::before {
Â  content:''; position: absolute; inset:0; pointer-events:none;
Â  box-shadow: inset 0 -10px 40px -10px var(--typeColor);
Â  z-index: 0;
}

.mainImg {
Â  max-height: 85%; max-width: 85%; width: auto; height: auto;
Â  object-fit: contain; filter: drop-shadow(0 0 15px var(--typeColor));
Â  transform: none !important; animation: none !important;
Â  z-index: 1;
}

.statsArea { 
Â  flex: 0 0 auto; padding: 6px; background: rgba(15, 23, 42, 0.9); 
Â  position: relative; z-index: 3; border-top: 1px solid rgba(255,255,255,0.1); 
}
.hpRow{ display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:2px; font-family:'Teko'; }
.hpLabel{ font-size:12px; color:#94a3b8; }
.hpNum{ display:flex; align-items:baseline; gap:1px; font-weight:700; color:#fff; font-size:16px; letter-spacing: 1px; }
.hpSlash,.hpMax{ font-size:12px; color:#64748b; }

.hpBarBg { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; }
.hpBar { 
Â  height: 100%; width: 100%; transition: width 0.3s; 
Â  background: #3b82f6; box-shadow: none; animation: none;
}

.statusRow { display: flex; gap: 2px; min-height: 14px; margin-top: 2px; justify-content: flex-end; flex-wrap: wrap; }
.stBadge { font-size: 9px; padding: 0 4px; background: #450a0a; color: #fca5a5; border: 1px solid #991b1b; border-radius: 2px; }

.bottomSection { flex: 0 0 auto; display: flex; flex-direction: column; gap: 2px; padding: 4px; background: rgba(0,0,0,0.2); margin-top: 1px; z-index: 3; }
.skillInfo { 
Â  background: rgba(30, 41, 59, 0.6); padding: 4px; border-radius: 4px;
Â  flex: 0 0 auto; min-height: 40px; display:flex; flex-direction:column; justify-content:center; 
Â  border-left: 3px solid var(--typeColor);
}
.skillN { font-size: 11px; font-weight: 900; color: #fcd34d; margin-bottom: 1px; }
.skillD { font-size: 9px; line-height: 1.2; color: #cbd5e1; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

.spRow { display: flex; gap: 2px; justify-content: center; height: 6px; margin: 4px 0; }
.pip { width: 100%; height: 100%; background: #334155; border-radius: 2px; }
.pip.on { background: #f59e0b; box-shadow: 0 0 4px #f59e0b; }

.footer { display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: #64748b; font-family: 'Teko'; padding: 0 2px; }
.btnStat { border: 1px solid #3b82f6; color: #60a5fa; background: transparent; padding: 0 6px; font-size: 10px; cursor: pointer; border-radius: 3px; }

.unit.hit { animation: hitAnim 0.2s ease; filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); }
@keyframes hitAnim{ 0%,100%{transform:translateX(0)} 20%,80%{transform:translateX(-4px)} 40%,60%{transform:translateX(4px)} }
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}
.unit.fall { animation: fallDown 0.8s forwards; filter: grayscale(1) brightness(0.3); opacity: 0.6; pointer-events: none; }
@keyframes fallDown { 100% { transform: translateY(40px) rotate(10deg); opacity: 0; } }

/* å…±é€šUIãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ« */
#jankenOverlay,#cutIn,#switchModal,#infoModal,#rulesModal,#result{position:fixed;inset:0;z-index:100;pointer-events:none;display:none;align-items:center;justify-content:center}
#switchModal,#infoModal,#rulesModal,#result{background:rgba(0,0,0,0.85);pointer-events:auto;backdrop-filter:blur(4px)}
#jankenOverlay.active{display:flex;background:rgba(0,0,0,0.3)}
#cutIn.show,#switchModal.show,#infoModal.show,#rulesModal.show,#result.show{display:flex}

.jkWrap{display:flex;flex-direction:column;align-items:center;gap:30px}
.jkHands{display:flex;gap:40px;align-items:center}
.jkHand{font-size:80px;transition:transform .2s;opacity:0;transform:scale(0); filter: drop-shadow(0 0 20px rgba(0,0,0,0.8)); }
.jkHand.show{opacity:1;transform:scale(1)}
.jkHand#jkHandA.win { transform: scale(1.5) rotate(-15deg) !important; filter: drop-shadow(0 0 30px #fcd34d); z-index: 10; }
.jkHand#jkHandB.win { transform: scale(1.5) rotate(15deg) !important; filter: drop-shadow(0 0 30px #ef4444); z-index: 10; }
.jkHand.lose { filter: grayscale(1) brightness(0.3); opacity: 0.6; transform: scale(0.8); }

.jkResult{font-family:'Orbitron';font-size:80px;font-weight:900;color:#fff;text-shadow:0 0 30px #fff;opacity:0;transform:translateY(20px);transition:all .2s}
.jkResult.show{opacity:1;transform:translateY(0)}

#cutIn{
Â  background:linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.9) 20%, rgba(37, 99, 235, 0.9) 80%, transparent);
Â  height:100px; border-top:2px solid #60a5fa; border-bottom:2px solid #60a5fa; 
Â  flex-direction:column; transform:scaleX(0); transition:.2s cubic-bezier(0.23, 1, 0.32, 1);
Â  z-index: 90;
}
#cutIn.show{display:flex;transform:scaleX(1)}
.cutInText{font-size:36px;font-weight:900;color:#fff;font-style:italic;text-shadow: 0 2px 10px rgba(0,0,0,0.8); font-family: 'Noto Sans JP';}
.cutInSub{font-size:12px;color:#bfdbfe;font-weight:700;letter-spacing: 0.2em; font-family: 'Orbitron'; margin-top: 4px;}

.modalCard{
Â  width:min(400px,90vw);max-height:80vh;overflow-y:auto;
Â  background:#0f172a; border:1px solid #334155; border-radius: 12px;
Â  padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.8); animation:popIn 0.2s; z-index: 300;
}
.modalHead{ display:flex; justify-content:space-between; align-items:center; width:100%; margin-bottom:16px; }

@keyframes popIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}

/* Setup Screen */
.card { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; margin-bottom: 8px; border-radius: 8px; }
.card h2 { margin:0; padding:10px 12px; font-size:14px; font-weight:800; color: #e2e8f0; background: rgba(0,0,0,0.3); border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; font-family: 'Orbitron'; letter-spacing: 1px; }
.card .body { padding: 12px; }
.btnTiny { padding: 4px 8px; font-size: 10px; background: rgba(255,255,255,0.05); border: 1px solid #475569; color: #cbd5e1; cursor: pointer; border-radius: 4px;}
.btn3d { appearance: none; border: none; font-family: 'Orbitron'; font-weight: 800; font-size: 14px; color: #fff; padding: 12px 16px; display: inline-flex; justify-content: center; align-items: center; gap: 4px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
.btn-primary { background: #2563eb; box-shadow: 0 3px 0 #1e3a8a; }
.btn-primary:active { transform: translateY(3px); box-shadow: none; }
.btn-ghost { background: #334155; border: 1px solid #475569; }

/* æ•°å€¤ãƒˆãƒ¼ã‚¹ãƒˆ (ã‚­ãƒ£ãƒ©ä¸Š) */
.floatingText { 
Â  position: absolute; left: 50%; top: 30%; 
Â  transform: translate(-50%, 0); 
Â  font-family: 'M PLUS 1p'; font-weight: 900; font-size: 24px; color: #fff; 
Â  pointer-events: none; z-index: 100; 
Â  animation: floatUp 1.5s ease-out forwards;
Â  text-shadow: 0 2px 0 rgba(0,0,0,0.8);
Â  white-space: nowrap;
}
.floatingText.dmg Â { color:#f87171; }
.floatingText.heal { color:#4ade80; }
.floatingText.miss { color:#94a3b8; font-size: 18px; }
@keyframes floatUp { 
Â  0% { opacity: 0; transform: translate(-50%, 10px); } 
Â  20% { opacity: 1; transform: translate(-50%, -10px); } 
Â  100% { opacity: 0; transform: translate(-50%, -40px); } 
}

.slot { display: flex; gap: 6px; align-items: center; background: rgba(255,255,255,0.03); padding: 8px; margin-bottom: 4px; border: 1px solid #1e293b; border-radius: 6px;}
.pill { width: 20px; height: 20px; background: #334155; color: #fff; font-weight: 800; font-size: 10px; display: grid; place-items: center; border-radius: 4px;}
.slot select { flex: 1; background: transparent; border: none; color: #f1f5f9; font-weight: 700; font-size: 14px; font-family: 'Noto Sans JP'; outline: none; }
.barRow{margin:2px 0;display:grid;grid-template-columns:30px 1fr 30px;align-items:center;gap:4px;font-size:10px; font-family: 'Orbitron'; color: #94a3b8;}
.barBox{height:6px;background:#0f172a;overflow:hidden; border-radius: 3px;}
.barFill{height:100%;background:#3b82f6;}
.setupMini { 
Â  border: 1px solid #334155; padding: 6px; background: #0f172a; display: flex; flex-direction: column; gap: 2px; margin-bottom:4px;
Â  border-radius: 6px; flex-shrink: 0;
}
.selCard.selected { border: 2px solid #facc15 !important; background: rgba(250, 204, 21, 0.1); }
</style>
</head>
<body>

<div class="bg-anim"></div>
<div id="toastArea"></div>

<div class="container" id="setup">
Â  <section class="card">
Â  Â  <h2>
Â  Â  Â  <button class="btnTiny" id="btnBack">BACK</button>
Â  Â  Â  <span>TEAM SETUP</span>
Â  Â  Â  <button class="btnTiny" id="btnRules">RULES</button>
Â  Â  </h2>
Â  Â  <div class="body">
Â  Â  Â  <div id="teamGrid">
Â  Â  Â  Â  <div style="margin-bottom:8px"><div class="statsHead" style="color:#3b82f6;font-weight:900;font-size:12px;font-family:'Orbitron'">YOU</div><div id="teamA"></div></div>
Â  Â  Â  Â  <div><div class="statsHead" style="color:#ef4444;font-weight:900;font-size:12px;font-family:'Orbitron'">CPU</div><div id="teamB"></div></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex; gap:8px; margin-top:16px">
Â  Â  Â  Â  <button id="btnRand" class="btn3d btn-ghost" style="flex:0 0 auto">RANDOM</button>
Â  Â  Â  Â  <button id="btnStart" class="btn3d btn-primary" style="flex:1">BATTLE START</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>
Â  <section class="card">
Â  Â  <h2><span>STATUS DETAIL</span></h2>
Â  Â  <div class="body">
Â  Â  Â  <div id="statsGrid">
Â  Â  Â  Â  <div style="margin-bottom:8px"><div class="statsCol" id="statsA"></div></div>
Â  Â  Â  Â  <div><div class="statsCol" id="statsB"></div></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>
</div>

<div id="battle">
Â  <div class="arena" id="arena">
Â  Â  <div class="vsrow">
Â  Â  Â  <div id="leftWrap"></div>
Â  Â  Â  <div id="rightWrap"></div>
Â  Â  </div>
Â  </div>
Â  <div class="logWrapper">
Â  Â  <div class="logHeader">SYSTEM LOG</div>
Â  Â  <div class="logContainer" id="battleLog"></div>
Â  </div>
Â  <div class="benchRow" id="benchRow"></div>
Â  <section class="padCard" id="pad">
Â  Â  <div class="padHead">
Â  Â  Â  <div style="flex:1" id="padMsg"></div>
Â  Â  Â  <div>TIME <span class="timerVal" id="countNum">15</span></div>
Â  Â  Â  <div style="flex:1"></div>
Â  Â  </div>
Â  Â  <div class="padInner">
Â  Â  Â  <div class="rpsArea">
Â  Â  Â  Â  <button class="rps g" id="btnG"><div class="emo">âœŠ</div></button>
Â  Â  Â  Â  <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div></button>
Â  Â  Â  Â  <button class="rps p" id="btnP"><div class="emo">ğŸ–</div></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="sideBtns">
Â  Â  Â  Â  <button class="cmdBtn btn-sp" id="btnSP" disabled>å¿…æ®ºæŠ€</button>
Â  Â  Â  Â  <button class="cmdBtn btn-switch" id="btnSwitch">äº¤ä»£</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>
</div>

<div id="jankenOverlay"><div class="jkWrap"><div class="jkResult" id="jkResult">WIN</div><div class="jkHands"><div class="jkHand" id="jkHandA">âœŠ</div><div style="color:#fff;font-weight:900;font-size:30px;font-family:'Orbitron'">VS</div><div class="jkHand" id="jkHandB">âœŒï¸</div></div></div></div>
<div id="cutIn"><div class="cutInText" id="cutInName">SKILL</div><div class="cutInSub" id="cutInUser">User</div></div>
<div id="switchModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px;font-family:'Orbitron'">SWITCH MEMBER</h3><button class="btnTiny" id="swCancel">CLOSE</button></div><div id="switchGrid"></div><button id="swDo" class="btn3d btn-primary" style="width:100%;margin-top:16px" disabled>äº¤ä»£</button></div></div>
<div id="infoModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px;font-family:'Orbitron'">STATUS DATA</h3><button class="btnTiny" id="infoClose">CLOSE</button></div><div id="infoBody"></div></div></div>
<div id="rulesModal"><div class="modalCard"><div class="modalHead"><h3 class="modalTitle" style="color:#fff;margin:0;font-size:16px;font-family:'Orbitron'">RULES</h3><button class="btnTiny" id="rulesClose">CLOSE</button></div>
Â  <div style="padding:0 8px; color:#cbd7f0; font-size:13px; line-height:1.6;">
Â  Â  <p><strong>ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘</strong><br>3å¯¾3ã®ãƒãƒ¼ãƒ æˆ¦ã€‚ã˜ã‚ƒã‚“ã‘ã‚“ã«å‹ã¤ã¨æ”»æ’ƒã€è² ã‘ã‚‹ã¨é˜²å¾¡ã€‚HPãŒ0ã«ãªã‚‹ã¨äº¤ä»£ã€‚å…¨å“¡å€’ã›ã°å‹åˆ©ï¼</p>
Â  Â  <p><strong>ã€ã‚¿ã‚¤ãƒ—ç›¸æ€§ã€‘</strong><br>æœ‰åˆ©(1.5å€) / ä¸åˆ©(0.67å€) ãŒå­˜åœ¨ã€‚<br>ãƒ’ã‚¹ãƒˆãƒªãƒ¼ > ã‚¸ã‚ª > ã‚³ãƒ³ã‚»ãƒ—ãƒˆ > ã‚µã‚¤ã‚¨ãƒ³ã‚¹ > ã‚¢ãƒ‹ãƒãƒ« > ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ > ãƒ•ãƒ¼ãƒ‰ > ãƒ’ã‚¹ãƒˆãƒªãƒ¼...</p>
Â  Â  <p><strong>ã€çŠ¶æ…‹ç•°å¸¸ã€‘</strong><br>
Â  Â  ğŸ”’ <strong>ãƒ­ãƒƒã‚¯</strong>ï¼šäº¤ä»£ãŒã§ããªããªã‚‹<br>
Â  Â  âš¡ <strong>ã‚¹ã‚¿ãƒ³</strong>ï¼šæ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½<br>
Â  Â  ğŸŒ€ <strong>å´©å£Š</strong>ï¼šç¢ºç‡ã§è‡ªåˆ†ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹<br>
Â  Â  ğŸ‘¾ <strong>æ–‡å­—åŒ–ã‘</strong>ï¼šã‚«ã‚¦ãƒ³ãƒˆ0ã§å³æ­»</p>
Â  </div>
</div></div>
<div id="result"><div class="modalCard" style="text-align:center;padding:32px;background:rgba(15,23,42,0.95)"><h1 id="resTitle" style="color:#fff;margin:0 0 16px;font-size:48px;font-family:'Orbitron';text-shadow:0 0 30px rgba(255,255,255,0.6)">WIN</h1><p style="color:#94a3b8;font-size:12px;font-family:'Orbitron';letter-spacing:0.1em">RETURNING TO SETUP...</p></div></div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop></audio>
<audio id="seHit" src="audio/hit.mp3"></audio>
<audio id="seSkill" src="audio/skill.mp3"></audio>
<audio id="seKO" src="audio/ko.mp3"></audio>

<script>
(() => {
'use strict';
const $ = id => document.getElementById(id);
const qs = (s, el = document) => el.querySelector(s);
const delay = ms => new Promise(r => setTimeout(r, ms));

// --- EXTERNAL LINK DATA ---
const STORAGE_KEY = 'kotoba_collection_seen_v4_7';
const STORAGE_PULLS_KEY = 'kotoba_pull_counts_v1';
const GACHA_BASE_URL = 'https://kyoryu1039.github.io/kotoba-gacha/';

function playBGM(){ const a = $('bgm'); if(!a) return; if(a.paused){ a.volume = 0.1; a.play().catch(()=>{}); } }
function stopBGM(){ const a = $('bgm'); if(a){ a.pause(); a.currentTime = 0; } }
function playSE(type){
Â  let el = null; if(type === 'hit') el = $('seHit'); else if(type === 'skill') el = $('seSkill'); else if(type === 'ko') el = $('seKO');
Â  if(el){ 
Â  Â  try{ el.currentTime = 0; }catch(e){} 
Â  Â  el.play().catch(()=>{}); 
Â  }
}

const IMG = {
Â  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"parabola_antenna.png", "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"nescafe_ambassador.png",
Â  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"ninjin_shirishiri.png", "ãã¼ã‚ã”ã¯ã‚“":"soboro_gohan.png",
Â  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"western_lowland_gorilla.png", "æ¯›ã‚€ãã˜ã‚ƒã‚‰":"kemukujara.png",
Â  "ä¹å“ä»":"kuhonbutsu.png", "ã‘ã‚“ã¡ã‚“æ±":"kenchin_jiru.png",
Â  "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"kamchatka_peninsula.png", "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"tarantula.png",
Â  "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"shoebill.png", "ãƒãƒ«ã‚µãƒŸã‚³é…¢":"balsamic_vinegar.png",
Â  "ãƒ”ãƒ­ãƒªèŒ":"helicobacter_pylori.png", "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"trinidad_and_tobago.png",
Â  "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"caramel_color.png", "ãƒãƒ“ãƒ­ãƒ³æ•å›š":"babylonian_captivity.png",
Â  "é³¥å–ç ‚ä¸˜":"tottori_sand_dunes.png", "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"placebo_effect.png",
Â  "æ¸¡æ¥äºº":"torai_jin.png", "ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png",
Â  "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"peperoncino.png", "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"polypropylene.png",
Â  "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"sarajevo_incident.png", "ã‚¯ãƒãƒ³ãƒãƒ":"kumabachi.png",
Â  "çœŒåºæ‰€åœ¨åœ°":"prefectural_capital.png", "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"teriyaki_chicken.png",
Â  "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"nerunerunerune.png", "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"surume_ika.png",
Â  "æœ¬è³ª":"essence.png", "è¦‹ãˆã‚‹åŒ–":"mieruka.png",
Â  "è‡ªåˆ†ã”ã¨åŒ–":"jibungotoka.png", "è§£åƒåº¦":"resolution.png"
};
function preloadImgs(names){
Â  const unique = [...new Set(names.map(n => IMG[n]).filter(Boolean))];
Â  unique.forEach(f => { const im = new Image(); im.src = `${GACHA_BASE_URL}images/${f}`; });
}

function log(msg, type = 'normal'){
Â  const c = $('battleLog'); if(!c) return;
Â  const d = document.createElement('div');
Â  let icon = ''; if(type === 'atk') icon = 'âš”ï¸'; else if(type === 'dmg') icon = 'ğŸ’¥'; else if(type === 'heal') icon = 'ğŸ’–'; else if(type === 'sp') icon = 'âœ¨'; else if(type === 'miss') icon = 'ğŸ’¨';
Â  d.className = 'logLine ' + type; d.textContent = (icon ? icon + ' ' : '') + msg;
Â  c.appendChild(d); c.scrollTop = c.scrollHeight;
}

function updateHPUI(role, val, max){
Â  const bar = $(`hp-${role}`); const num = $(`hpnum-${role}`);
Â  if(bar){
Â  Â  const pct = (val / max) * 100; bar.style.width = `${pct}%`; bar.className = 'hpBar';
Â  Â  if(pct > 50) bar.classList.add('high'); else if(pct > 20) bar.classList.add('mid'); else bar.classList.add('low');
Â  }
Â  if(num) num.textContent = val;
}

function fitName(el){
Â  if(!el) return; const len = visualLen(el.textContent);
Â  if(len > 10) el.style.fontSize = '10px'; else if(len > 7) el.style.fontSize = '11px'; else el.style.fontSize = '13px';
}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
function showFloatingText(targetId, text, type, opts = {}){
Â  const wrap = $(targetId); if(!wrap) return;
Â  const el = document.createElement('div'); 
Â  el.className = 'floatingText ' + type; 
Â  el.textContent = text;
Â  const rndX = (Math.random() - 0.5) * 40;
Â  const rndY = (Math.random() - 0.5) * 30;
Â  el.style.transform = `translate(calc(-50% + ${rndX}px), ${rndY}px)`;
Â  wrap.appendChild(el); setTimeout(() => el.remove(), opts.duration || 3000);
}

/* é€šçŸ¥ã‚¨ãƒªã‚¢ */
function showSysToast(text, type='info') {
Â  const area = $('toastArea'); if(!area) return;
Â  const el = document.createElement('div');
Â  el.className = `sysToast ${type}`;
Â  el.textContent = text;
Â  area.appendChild(el);
Â  setTimeout(()=>el.remove(), 3500);
}

/* æ•°å€¤æ¼”å‡º */
function showDamageText(targetId, text, type) {
Â  const wrap = $(targetId); if(!wrap) return;
Â  const el = document.createElement('div');
Â  el.className = `floatingText ${type}`;
Â  el.textContent = text;
Â  const rndX = (Math.random() - 0.5) * 60;
Â  const rndY = (Math.random() - 0.5) * 20;
Â  el.style.transform = `translate(calc(-50% + ${rndX}px), ${rndY}px)`;
Â  wrap.appendChild(el);
Â  setTimeout(() => el.remove(), 1500);
}

async function showCutIn(skill, user){
Â  $('cutInName').textContent = skill; $('cutInUser').textContent = user;
Â  const el = $('cutIn'); el.classList.add('show'); await delay(1200); el.classList.remove('show'); await delay(200);
}

function shakeScreen(){
Â  const a = $('arena'); a.classList.remove('shake'); void a.offsetWidth; a.classList.add('shake');
}

let inputLocked = false;
function lockInputs(on){
Â  inputLocked = on; const p = $('pad'); if(p) p.style.opacity = on ? 0.6 : 1;
Â  ['btnG','btnC','btnP','btnSwitch'].forEach(id => { const el = $(id); if(el) el.disabled = on; });
Â  updateSPBtn();
Â  const msg = $('padMsg');
Â  if(msg) {
Â  Â  if(on) msg.textContent = '';
Â  Â  else msg.innerHTML = '<span style="color:#4ade80;animation:flashBtn 1s infinite">HANDS READY?</span>';
Â  }
}

const TYPES_RING = ['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeColor = t => getComputedStyle(document.documentElement).getPropertyValue(`--t-${t}`) || '#7aa0ff';
const typeMult = (atk, def) => {
Â  const n = TYPES_RING.length; const i = TYPES_RING.indexOf(atk); const j = TYPES_RING.indexOf(def);
Â  if(i < 0 || j < 0) return 1;
Â  const st = [(i+1)%n,(i+2)%n]; const wk = [(i-1+n)%n,(i-2+n)%n];
Â  if(st.includes(j)) return 1.5; if(wk.includes(j)) return 0.67; return 1;
};
const PRANK = {S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE = {S:560,A:540,B:520,C:500,D:480,X:500};
const toKatakana = s => (s || '').replace(/[ã-ã‚“]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
const visualLen = s => (s || '').replace(/[ãƒ»\s]/g,'').length;
const reKanaH = /[ã-ã‚Ÿ]/g, reKanaK = /[ã‚ -ãƒ¿ãƒ¼]/g, reKanji = /[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g;
function countClass(name){
Â  const H = (name.match(reKanaH) || []).length; const K = (name.match(reKanaK) || []).length; const J = (name.match(reKanji) || []).length;
Â  return {H,K,J,total:H+K+J};
}
const reSmallK = /[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°-ã‡¿]/g, reSokuon=/ãƒƒ/g, reVoiced=/[ã‚¬-ãƒãƒ´]/g, rePlosiveEnd=/[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
function calcAttackDefense(name,yomiKatakana){
Â  let atkP=17.5, defP=17.5; const cls = countClass(name);
Â  if(cls.J+cls.K===0){ atkP += 12.5; defP += 12.5; }else{ const r = cls.K/(cls.J+cls.K); atkP += 25*r; defP += 25*(1-r); }
Â  const Lph = yomiKatakana.length || 1;
Â  const d = (yomiKatakana.match(reVoiced)||[]).length/Lph; const s = (yomiKatakana.match(reSokuon)||[]).length/Lph;
Â  const m = (yomiKatakana.match(reSmallK)||[]).length/Lph; const e = rePlosiveEnd.test(yomiKatakana)?1:0;
Â  const s_raw = 0.6*d + 0.25*(s+m) + 0.15*e;
Â  const L = 0.05, U = 0.45; const s_ph = Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
Â  const atk_ph = 20*(0.5+0.5*s_ph); atkP += atk_ph; defP += 20-atk_ph;
Â  const T = visualLen(name); const s_len = Math.max(-1,Math.min(1,(6-T)/6));
Â  const atk_len = 20*(0.5+0.5*s_len); atkP += atk_len; defP += 20-atk_len;
Â  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
Â  const cls = countClass(name); const hiraRatio = cls.total ? (cls.H/cls.total) : 0;
Â  const rankAdj = ({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank] ?? 0;
Â  let eva = 10 + 8*hiraRatio - 0.5*(T-5) + rankAdj; eva = Math.round(eva*10)/10;
Â  return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiH]){
Â  const y = toKatakana(yomiH || name); const {atkP,defP,T} = calcAttackDefense(name,y);
Â  const ATK = Math.round(PRANK[rank]*(atkP/100)); const DEF = Math.round(PRANK[rank]*(defP/100));
Â  const HP Â = Math.round(HP_BASE[rank]+20*(T-5)); const EVA = calcEvasion(name,T,rank);
Â  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,
Â  Â  Â  Â  Â  shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

const SKILLS = {
Â  "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","å¨åŠ›2.2å€ã€‚ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
Â  "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","æ”»æ’ƒå¾Œã€å‘³æ–¹å…¨å“¡HP60å›å¾©ã€‚"],
Â  "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","å¨åŠ›1.6å€ã€‚è‡´æ­»ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’HP1ã§1å›è€ãˆã‚‹ã€‚"],
Â  "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›é€£ç¶šæ”»æ’ƒï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚"],
Â  "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","å¨åŠ›1.5å€ã€‚3ã‚¿ãƒ¼ãƒ³ã®é–“ã€è‡ªåˆ†æ”»æ’ƒ1.3å€ã€‚"],
Â  "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","å¨åŠ›1.4å€ã€‚3ã‚¿ãƒ¼ãƒ³ã®é–“ã€å›é¿ç‡60%å›ºå®šã€‚"],
Â  "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","å¨åŠ›1.6å€ã€‚æ¬¡ã®è¢«å¼¾2å›ã¾ã§è¢«ãƒ€ãƒ¡åŠæ¸›ã€‚"],
Â  "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","å¨åŠ›1.2å€ã€‚è‡ªåˆ†HP150å›å¾©ã€‚"],
Â  "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"], "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ï¼šæ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
Â  "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"], "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"],
Â  "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"], "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ï¼šæ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
Â  "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"], "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"],
Â  "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"], "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"],
Â  "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³çµŒéå¾Œã«å³æ­»ã€‚"], "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ï¼šæ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"],
Â  "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"], "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"],
Â  "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ï¼šæ¬¡ã®ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€‚"], "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"],
Â  "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³çµŒéå¾Œã«å³æ­»ã€‚"], "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ï¼š4ã‚¿ãƒ¼ãƒ³ã®é–“ã€äº¤ä»£å°å°ã€‚"],
Â  "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"], "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ï¼š3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç¢ºç‡(33%)ã§è‡ªå‚·ãƒ€ãƒ¡ã€‚"],
Â  "æœ¬è³ª":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"], "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
Â  "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"], "è§£åƒåº¦":["é¡æ–‡å­—","ç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};
const WORDS_BASE = [
Â  ["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"], ["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],
Â  ["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"], ["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],
Â  ["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"], ["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],
Â  ["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"], ["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],
Â  ["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"], ["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],
Â  ["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"], ["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],
Â  ["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"], ["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],
Â  ["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"], ["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],
Â  ["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"], ["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],
Â  ["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"], ["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],
Â  ["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"], ["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],
Â  ["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"], ["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],
Â  ["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"], ["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],
Â  ["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"], ["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],
Â  ["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"], ["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],
Â  ["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"], ["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]
];

const makeW = i => makeWordObject(WORDS_BASE[i]);

// --- LOCAL STORAGE INTERLINK ---
const STORAGE_KEY = 'kotoba_collection_seen_v4_7';

function loadUnlockedWords() {
Â  const seenJson = localStorage.getItem(STORAGE_KEY);
Â  try {
Â  Â  const seenArray = JSON.parse(seenJson) || [];
Â  Â  return new Set(seenArray);
Â  } catch (e) {
Â  Â  return new Set();
Â  }
}
const UNLOCKED_WORD_NAMES = loadUnlockedWords();

const AVAILABLE_WORDS = WORDS_BASE.filter(wordData => UNLOCKED_WORD_NAMES.has(wordData[0]));

// --- GAME STATE ---
const state = { A:{team:[],i:0,sp:0}, B:{team:[],i:0,sp:0}, remain:15, timer:null, spOn:false, busy:false, spAnnA:false, history:new Set(), suppressAffToastOnce:false };
let forceSwitch = false;
const left Â = () => state.A.team[state.A.i]; const right = () => state.B.team[state.B.i];

function barRow(label,val,max){
Â  const pct = Math.min(100,(val/max)*100);
Â  return `<div class="barRow"><div class="barLabel">${label}</div><div class="barBox"><div class="barFill" style="width:${pct}%"></div></div><div class="barVal">${val}</div></div>`;
}
function miniCard(idx){
Â  const w = makeW(idx);
Â  return `<div class="setupMini" style="--typeC:${typeColor(w.type)}" data-type="${w.type}">
Â  Â  <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px"><div>${w.name}</div><div style="color:var(--typeC)">${w.type}/${w.rank}</div></div>
Â  Â  <div class="statGrid">${barRow('HP',w.maxhp,800)}${barRow('ATK',w.atk,120)}${barRow('DEF',w.def,120)}${barRow('EVA',w.eva,30)}</div></div>`;
}

function renderMini(side){
Â  const root = side === 'A' ? $('statsA') : $('statsB'); root.innerHTML = '';
Â  // Check if any words are available before trying to render
Â  if (AVAILABLE_WORDS.length === 0 && side === 'A') {
Â  Â  root.innerHTML = '<div style="color:#f87171;font-weight:700;padding:10px;">ã‚¬ãƒãƒ£ã§è¨€è‘‰ã‚’é›†ã‚ã‚ˆã†ï¼</div>';
Â  Â  $('btnStart').disabled = true;
Â  Â  return;
Â  }

Â  for(let i=0;i<3;i++){
Â  Â  const idx = Number($(`${side}-${i}`).value) || 0; root.innerHTML += miniCard(idx);
Â  Â  const pill = $(`${side}-pill-${i}`);
Â  Â  if(pill){ pill.style.background = typeColor(WORDS_BASE[idx][2]); pill.style.color = '#020617'; pill.style.boxShadow='0 0 4px rgba(0,0,0,0.5)'; }
Â  }
}

function uniqueRandom(n, sourceLen){
Â  const arr = []; const pool = Array.from({length:sourceLen},(_,i)=>i);
Â  for(let i=0;i<n;i++){ const idx = Math.floor(Math.random()*pool.length); arr.push(pool[idx]); pool.splice(idx,1); }
Â  return arr;
}
function makeTeam(root,side){
Â  root.innerHTML = '';
Â  // Use the available words list to populate dropdowns for Player A
Â  const listToUse = side === 'A' ? AVAILABLE_WORDS : WORDS_BASE; 

Â  for(let i=0;i<3;i++){
Â  Â  const div = document.createElement('div'); div.className = 'slot';
Â  Â  const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = '#' + (i+1); pill.id = `${side}-pill-${i}`;
Â  Â  const sel = document.createElement('select'); sel.id = `${side}-${i}`;
Â  Â  
Â  Â  listToUse.forEach((w,idx)=>{ 
Â  Â  Â  const o = document.createElement('option'); 
Â  Â  Â  // If Player A, find the original index used by makeW. If CPU, the index is the same.
Â  Â  Â  const originalIndex = WORDS_BASE.findIndex(origW => origW[0] === w[0]);
Â  Â  Â  o.value = originalIndex; 
Â  Â  Â  o.textContent = `${w[0]} [${w[2]}/${w[1]}]`; 
Â  Â  Â  sel.append(o); 
Â  Â  });
Â  Â  
Â  Â  sel.addEventListener('change', () => renderMini(side)); div.append(pill,sel); root.append(div);
Â  }
Â  // Set initial random values ensuring they are within the available range
Â  const picks = uniqueRandom(3, listToUse.length); 
Â  picks.forEach((v,i) => {
Â  Â  // Set the value based on the original index, derived from the pick in listToUse
Â  Â  const originalIndex = WORDS_BASE.findIndex(origW => origW[0] === listToUse[v][0]);
Â  Â  $(`${side}-${i}`).value = originalIndex;
Â  });
Â  
Â  renderMini(side);
}
function randomizeTeam(side){
Â  const list = side === 'A' ? AVAILABLE_WORDS : WORDS_BASE;
Â  const picks = uniqueRandom(3, list.length); 
Â  for(let i=0;i<3;i++){ 
Â  Â  const originalIndex = WORDS_BASE.findIndex(origW => origW[0] === list[picks[i]][0]);
Â  Â  $(`${side}-${i}`).value = originalIndex; 
Â  } 
Â  renderMini(side);
}
const collect = side => [0,1,2].map(i=>{ const idx = Number($(`${side}-${i}`).value) || 0; return {...makeW(idx), side}; });

function updateSPBtn(){
Â  const btn = $('btnSP'); if(!btn) return;
Â  const ready = state.A.sp >= 6; const canPress = !inputLocked && ready && !state.busy;
Â  btn.disabled = !canPress;
Â  if(state.spOn){ btn.innerHTML = '<span>âœ¨</span> ON'; btn.className = 'cmdBtn btn-sp on'; }
Â  else if(ready && !inputLocked){ btn.innerHTML = '<span>PUSH!</span>'; btn.className = 'cmdBtn btn-sp ready'; }
Â  else{ btn.innerHTML = '<span>å¿…æ®ºæŠ€</span>'; btn.className = 'cmdBtn btn-sp'; }
Â  if(ready && !state.spAnnA){ 
Â  Â  log('å¿…æ®ºã‚²ãƒ¼ã‚¸MAXï¼','highlight'); 
Â  Â  showSysToast('å¿…æ®ºæŠ€OK!', 'info'); 
Â  Â  state.spAnnA = true; 
Â  }
}

async function playJankenAnim(myH,cpuH,res){
Â  const map={G:'âœŠ',C:'âœŒï¸',P:'ğŸ–'}; const ov=$('jankenOverlay'), hA=$('jkHandA'), hB=$('jkHandB'), rs=$('jkResult');
Â  ov.classList.add('active'); hA.className='jkHand'; hB.className='jkHand'; rs.className='jkResult';
Â  hA.textContent=map[myH]; hB.textContent=map[cpuH];
Â  await delay(50); hA.classList.add('show'); hB.classList.add('show'); await delay(400);
Â  if(res>0){ rs.textContent='WIN!'; rs.style.color='#4effa5'; hA.classList.add('win'); hB.classList.add('lose'); }
Â  else if(res<0){ rs.textContent='LOSE'; rs.style.color='#ff5c6c'; hA.classList.add('lose'); hB.classList.add('win'); }
Â  else{ rs.textContent='DRAW'; rs.style.color='#ffd900'; }
Â  rs.classList.add('show'); await delay(800); ov.classList.remove('active');
}

function checkAffinity(){
Â  const a = left(), b = right(); const pairKey = `${a.name}:${b.name}`; const m1 = typeMult(a.type,b.type);
Â  if(state.suppressAffToastOnce){ state.suppressAffToastOnce = false; return; }
Â  if(!state.history.has(pairKey)){
Â  Â  state.history.add(pairKey);
Â  Â  if(m1>=1.5){ showSysToast('ç›¸æ€§æœ‰åˆ©!','heal'); log(`ã€æœ‰åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼·ã„ï¼`,'heal'); }
Â  Â  else if(m1<=0.7){ showSysToast('ç›¸æ€§ä¸åˆ©...','dmg'); log(`ã€ä¸åˆ©ã€‘${a.name}ã¯${b.name}ã«å¼±ã„...`,'dmg'); }
Â  }
}

function buildBoxes(){
Â  const row = $('benchRow'); if(!row) return;
Â  const mk = (u,i,isActive) => `<div class="resIcon ${u.hp<=0?'dead':''} ${isActive?'active':''}" onclick="window._sh('${u.name}')" style="--typeC:${typeColor(u.type)}" data-type="${u.type}">${u.name.charAt(0)}</div>`;
Â  const l = state.A.team.map((u,i)=>mk(u,i,i===state.A.i)).join(''); const r = state.B.team.map((u,i)=>mk(u,i,i===state.B.i)).join('');
Â  row.innerHTML = `<span class="benchLabel">YOU</span>${l}<span class="benchLabel" style="margin:0 4px">VS</span>${r}<span class="benchLabel">CPU</span>`;
}

function renderCard(u,role){
Â  const sp = role==='ally'?state.A.sp:state.B.sp; const owner = role==='ally'?'YOU':'CPU';
Â  const img = IMG[u.name] ? `<img src="${GACHA_BASE_URL}images/${IMG[u.name]}" class="mainImg" onerror="this.style.display='none';">` : `<span style="font-size:40px">ğŸ“¦</span>`;
Â  const skill = (SKILLS[u.name] || ['â€”','â€”']);
Â  const pips = [...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');
Â  let badges = ''; if(u.lock>0) badges += `<div class="stBadge">ğŸ”’LOCKED</div>`;
Â  if(u.doom>0) badges += `<div class="stBadge">ğŸ‘¾æ–‡å­—åŒ–ã‘</div>`; if(u.selfHurt>0) badges += `<div class="stBadge">ğŸŒ€å´©å£Š</div>`;

Â  let affTag = '';
Â  if(role==='enemy'){
Â  Â  Â const m = typeMult(left().type, u.type);
Â  Â  Â if(m>=1.5) affTag = `<span class="affTag good">æœ‰åˆ©</span>`;
Â  Â  Â else if(m<=0.7) affTag = `<span class="affTag bad">ä¸åˆ©</span>`;
Â  }

Â  return `<div class="unit" style="--typeColor:${typeColor(u.type)}" data-rank="${u.rank}"><div class="unitInner">
Â  Â  Â  <div class="cardHeader"><span class="ownerBadge ${role}">${owner}</span><span class="typeIcon">${u.type}</span></div>
Â  Â  Â  <div class="cardName" id="nm-${role}">${u.name}</div>
Â  Â  Â  <div class="subInfo">${affTag}</div>
Â  Â  Â  <div class="artArea" id="art-${role}">${img}</div>
Â  Â  Â  <div class="statsArea">
Â  Â  Â  Â  <div class="hpRow"><span class="hpLabel">HP</span><div class="hpNum"><span class="hpCurr" id="hpnum-${role}">${u.hp}</span><span class="hpSlash">/</span><span class="hpMax">${u.maxhp}</span></div></div>
Â  Â  Â  Â  <div class="hpBarBg"><div class="hpBar" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div>
Â  Â  Â  Â  <div class="statusRow">${badges}</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="bottomSection">
Â  Â  Â  Â  <div class="skillInfo"><div class="skillN">${skill[0]}</div><div class="skillD">${skill[1]}</div></div>
Â  Â  Â  Â  <div class="spRow">${pips}</div>
Â  Â  Â  Â  <div class="footer"><span style="color:#94a3b8">ATK:${u.atk} DEF:${u.def} EVA:${u.eva}%</span><button class="btnStat" onclick="window._sh('${u.name}')">DATA</button></div>
Â  Â  Â  </div></div></div>`;
}

function renderSides(){
Â  $('leftWrap').innerHTML Â = renderCard(left(),'ally'); $('rightWrap').innerHTML = renderCard(right(),'enemy');
Â  fitName(qs('#nm-ally')); fitName(qs('#nm-enemy'));
Â  buildBoxes(); updateSPBtn();
Â  updateHPUI('ally',left().hp,left().maxhp); updateHPUI('enemy',right().hp,right().maxhp);
Â  checkAffinity();
}

function spEffectPre(att,def,role,forcedName=null,mirrorMode=false){
Â  let mult=1, multiSeq=null, skillTitle='é€šå¸¸æ”»æ’ƒ', skillUser=att.name, notes=[];
Â  const useName=forcedName ?? att.name; const [title] = (SKILLS[useName]||['â€”','â€”']); skillTitle=title;
Â  
Â  const notify = (txt, type='info') => showSysToast(txt, type);
Â  const debuff = (txt) => showSysToast(txt, 'warn');

Â  switch(useName){
Â  Â  case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': mult=2.2; debuff('ã‚²ãƒ¼ã‚¸æ¶ˆæ»…ï¼'); break; 
Â  Â  case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': mult=1; notes.push('å‘³æ–¹å…¨å“¡å›å¾©'); notify('å…¨ä½“å›å¾©ï¼','heal'); break;
Â  Â  case 'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š': mult=1.6; att.endure=true; notify('æ ¹æ€§ä»˜ä¸','info'); break;
Â  Â  case 'ãã¼ã‚ã”ã¯ã‚“': multiSeq=[0.75,0.5,0.25]; notify('3å›æ”»æ’ƒï¼','info'); break;
Â  Â  case 'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©': mult=1.5; att.atk13=3; notify('ATK UP!','info'); break;
Â  Â  case 'æ¯›ã‚€ãã˜ã‚ƒã‚‰': mult=1.4; att.eva60=3; notify('å›é¿UP!','info'); break;
Â  Â  case 'ä¹å“ä»': mult=1.6; att.shield=2; notify('ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›','info'); break;
Â  Â  case 'ã‘ã‚“ã¡ã‚“æ±': mult=1.2; notes.push('è‡ªå·±å›å¾©'); notify('HPå›å¾©','heal'); break;
Â  Â  case 'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶': case 'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦': case 'ãƒãƒ«ã‚µãƒŸã‚³é…¢': case 'ãƒãƒ“ãƒ­ãƒ³æ•å›š': case 'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³': case 'ã‚¯ãƒãƒ³ãƒãƒ': case 'ç…§ã‚Šç„¼ããƒã‚­ãƒ³':
Â  Â  Â  def.lock=4; debuff('äº¤ä»£å°å°ï¼'); break;
Â  Â  case 'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©': case 'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´': case 'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶': case 'ã•ã‚‹ã³ã‚ä¸¸':
Â  Â  Â  def.stun=true; debuff('ã‚¹ã‚¿ãƒ³ï¼'); break;
Â  Â  case 'ãƒ”ãƒ­ãƒªèŒ': case 'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ': case 'é³¥å–ç ‚ä¸˜': case 'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ': case 'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ': case 'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«': case 'ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­':
Â  Â  Â  def.selfHurt=3; debuff('å´©å£Šä»˜ä¸ï¼'); break;
Â  Â  case 'æ¸¡æ¥äºº': case 'çœŒåºæ‰€åœ¨åœ°': def.doom=3; debuff('æ–‡å­—åŒ–ã‘ä»˜ä¸ï¼'); break;
Â  Â  case 'æœ¬è³ª': case 'è¦‹ãˆã‚‹åŒ–': case 'è‡ªåˆ†ã”ã¨åŒ–': case 'è§£åƒåº¦': if(!mirrorMode){ mult=2.0; skillTitle='é¡æ–‡å­—'; notify('æŠ€ã‚³ãƒ”ãƒ¼ï¼','info'); } break;
Â  }
Â  return {mult,multiSeq,skillTitle,skillUser,notes};
}
async function spEffectPost(att,def,role,usedName){
Â  if(usedName==='ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ'){ if(role==='ally') state.B.sp=0; else state.A.sp=0; }
Â  else if(usedName==='ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼'){
Â  Â  (role==='ally'?state.A.team:state.B.team).forEach(u => { if(u.hp<u.maxhp) u.hp = Math.min(u.maxhp,u.hp+60); });
Â  Â  showDamageText(role==='ally'?'leftWrap':'rightWrap','+60','heal'); renderSides();
Â  }
Â  else if(usedName==='ã‘ã‚“ã¡ã‚“æ±'){ att.hp=Math.min(att.maxhp,att.hp+150); showDamageText(role==='ally'?'leftWrap':'rightWrap','+150','heal'); renderSides(); }
}

async function startOfAction(side){
Â  const me = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
Â  const myWrap = side==='ally'?'leftWrap':'rightWrap';
Â  
Â  if(me.eva60>0){ me.eva60--; if(me.eva60===0) showSysToast('å›é¿UPçµ‚äº†', 'info'); }
Â  if(me.atk13>0){ me.atk13--; if(me.atk13===0) showSysToast('æ”»æ’ƒUPçµ‚äº†', 'info'); }
Â  if(me.lock>0){ me.lock--; if(me.lock===0) showSysToast('ãƒ­ãƒƒã‚¯è§£é™¤', 'info'); }
Â  
Â  if(me.doom>0){
Â  Â  me.doom--; if(me.doom<=0){
Â  Â  Â  me.hp=0; renderSides(); showDamageText(myWrap,'æ–‡å­—åŒ–ã‘ã§å€’ã‚ŒãŸâ€¦','dmg');
Â  Â  Â  qs(side==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall'); await delay(1000);
Â  Â  Â  log(`${me.name}ã¯æ–‡å­—åŒ–ã‘ã§å€’ã‚ŒãŸï¼`,'highlight'); const ended = await handleKO(side); return !ended;
Â  Â  }
Â  }
Â  if(me.stun){ 
Â  Â  me.stun=false; renderSides(); 
Â  Â  log(`${me.name}ã¯å‹•ã‘ãªã„ï¼`,'highlight'); 
Â  Â  showSysToast('å‹•ã‘ãªã„ï¼', 'warn'); 
Â  Â  await delay(1000); return false; 
Â  }
Â  return true;
}

function judge(a,b){ if(a===b) return 0; if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G')) return 1; return -1; }
function baseDamage(att,def){
Â  let mult = typeMult(att.type,def.type);
Â  let val = 100 * (1 + att.atk/100) / (1 + def.def/120) * mult;
Â  return val * (Math.random()*0.4+0.8);
}

async function doTurn(side){
Â  const att = side==='ally'?state.A.team[state.A.i]:state.B.team[state.B.i];
Â  let Â  Â def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i];
Â  const spUse = (side==='ally' && state.spOn && state.A.sp>=6) || (side==='enemy' && state.B.sp>=6);
Â  let mult=1, multi=null, skillTitle='é€šå¸¸æ”»æ’ƒ', usedName=att.name;

Â  if(spUse){
Â  Â  if(side==='ally'){ state.A.sp=0; state.spOn=false; state.spAnnA=false; } else{ state.B.sp=0; } playSE('skill');
Â  Â  if(['æœ¬è³ª','è¦‹ãˆã‚‹åŒ–','è‡ªåˆ†ã”ã¨åŒ–','è§£åƒåº¦'].includes(att.name)){
Â  Â  Â  const foe = (side==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X' && u.hp>0);
Â  Â  Â  if(foe.length){
Â  Â  Â  Â  const pick = foe[Math.floor(Math.random()*foe.length)]; const pre = spEffectPre(att,def,side,pick.name,true);
Â  Â  Â  Â  mult=pre.mult*2.0; multi=pre.multiSeq?pre.multiSeq.map(x=>x*2.0):null; skillTitle=pre.skillTitle; usedName=pick.name;
Â  Â  Â  Â  await showCutIn(skillTitle,att.name); log(`é¡æ–‡å­—ï¼š${pick.name}ã‚’ã‚³ãƒ”ãƒ¼ï¼`,'sp');
Â  Â  Â  }else{ mult=2.0; skillTitle='é¡æ–‡å­—'; await showCutIn(skillTitle,att.name); }
Â  Â  }else{
Â  Â  Â  const pre = spEffectPre(att,def,side); mult=pre.mult; multi=pre.multiSeq; skillTitle=pre.skillTitle;
Â  Â  Â  await showCutIn(skillTitle,att.name); if(pre.notes) pre.notes.forEach(n=>log(n,'sp'));
Â  Â  }
Â  }else{ log(`${att.name}ã®æ”»æ’ƒ`,'atk'); await delay(400); }

Â  const eva = def.eva60>0?60:def.eva;
Â  if(!spUse && Math.random() < (eva/100)){ showDamageText(side==='ally'?'rightWrap':'leftWrap','MISS','miss'); log('æ”»æ’ƒã‚’å›é¿ã—ãŸï¼','miss'); await delay(800); return false; }

Â  let targetRole = side==='ally'?'enemy':'ally'; const dmgList = (Array.isArray(multi)?multi:[mult]);
Â  for(let i=0;i<dmgList.length;i++){
Â  Â  let m = dmgList[i]; let base = baseDamage(att,def)*m; if(att.atk13>0) base *= 1.3;
Â  Â  if(def.shield>0){ 
Â  Â  Â  base *= 0.5; def.shield--; 
Â  Â  Â  showDamageText(targetRole==='enemy'?'rightWrap':'leftWrap','GUARD','heal'); 
Â  Â  Â  if(def.shield===0) setTimeout(()=>showSysToast('è»½æ¸›çµ‚äº†','info'), 500);
Â  Â  }
Â  Â  let damage = Math.max(1,Math.floor(base)); def.hp = Math.max(0,def.hp-damage); updateHPUI(targetRole,def.hp,def.maxhp);
Â  Â  playSE('hit'); qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('hit'); shakeScreen();
Â  Â  showDamageText(targetRole==='enemy'?'rightWrap':'leftWrap',`-${damage}`,'dmg'); log(`${def.name}ã« ${damage} ãƒ€ãƒ¡ãƒ¼ã‚¸`,'dmg');
Â  Â  await delay(1200); const hitUnit = qs('.unit.hit'); if(hitUnit) hitUnit.classList.remove('hit');
Â  Â  if(def.hp<=0 && def.endure){ def.endure=false; def.hp=1; updateHPUI(targetRole,1,def.maxhp); showDamageText(targetRole==='enemy'?'rightWrap':'leftWrap','æ ¹æ€§!','heal'); log('æ ¹æ€§ã§è€ãˆãŸï¼','highlight'); }
Â  Â  else if(def.hp<=0){
Â  Â  Â  qs(targetRole==='enemy'?'#rightWrap .unit':'#leftWrap .unit').classList.add('fall'); await delay(1000);
Â  Â  Â  log(`${def.name}ã¯å€’ã‚ŒãŸï¼`,'highlight'); const ended = await handleKO(targetRole==='enemy'?'enemy':'ally');
Â  Â  Â  if(ended) return true;
Â  Â  Â  if(i<dmgList.length-1){ def = side==='ally'?state.B.team[state.B.i]:state.A.team[state.A.i]; targetRole = side==='ally'?'enemy':'ally'; }
Â  Â  }
Â  }

Â  if(att.selfHurt>0){
Â  Â  att.selfHurt--;
Â  Â  if(Math.random()<0.33){
Â  Â  Â  log('ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼','dmg'); 
Â  Â  Â  const myRole = side==='ally'?'ally':'enemy'; 
Â  Â  Â  const myWrap = myRole==='ally'?'leftWrap':'rightWrap';
Â  Â  Â  playSE('hit'); shakeScreen();
Â  Â  Â  showSysToast('âš ï¸å´©å£Šãƒ€ãƒ¡ãƒ¼ã‚¸ï¼','warn');
Â  Â  Â  await delay(600);
Â  Â  Â  att.hp = Math.max(0,att.hp-100); updateHPUI(myRole,att.hp,att.maxhp);
Â  Â  Â  showDamageText(myWrap,'-100','dmg');
Â  Â  Â  
Â  Â  Â  if(att.hp<=0){ showDamageText(myWrap,'è‡ªæ»…','dmg'); qs(myRole==='ally'?'#leftWrap .unit':'#rightWrap .unit').classList.add('fall'); await delay(1000); log(`${att.name}ã¯è‡ªæ»…ã—ãŸ`,'highlight'); return await handleKO(side); }
Â  Â  }
Â  Â  if(att.selfHurt===0) setTimeout(()=>showSysToast('å´©å£Šè§£é™¤','info'), 1000);
Â  }
Â  if(spUse) await spEffectPost(att,def,side,usedName);
Â  return false;
}

function startRound(){
Â  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer); state.busy=false; lockInputs(false); checkAffinity();
Â  setTimeout(()=>{
Â  Â  if(state.busy) return;
Â  Â  const cpu = right(); const player = left(); const m = typeMult(cpu.type,player.type);
Â  Â  if(m<=0.7 && cpu.lock===0 && cpu.hp>0){
Â  Â  Â  const reserves = [0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0); const best = reserves.find(i => typeMult(state.B.team[i].type,player.type)>=1.5);
Â  Â  Â  if(best!==undefined && Math.random()<0.7){ cpuSwitchAction(best); return; }
Â  Â  }
Â  },1200);
Â  state.timer=setInterval(()=>{
Â  Â  if(state.busy) return; state.remain--; $('countNum').textContent=state.remain;
Â  Â  if(state.remain<=0){ pick(['G','C','P'][Math.floor(Math.random()*3)]); }
Â  },1000);
}

// ã‚¹ãƒ ãƒ¼ã‚ºãªäº¤ä»£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
async function animateSwitch(side, callback) {
Â  const wrap = $(side === 'ally' ? 'leftWrap' : 'rightWrap');
Â  const unit = wrap.querySelector('.unit');
Â  if(unit) {
Â  Â  unit.style.transition = 'transform 0.3s ease-in, opacity 0.3s';
Â  Â  unit.style.transform = 'translateX(' + (side==='ally' ? '-50px' : '50px') + ')';
Â  Â  unit.style.opacity = '0';
Â  }
Â  await delay(300);
Â  callback(); 
Â  const newUnit = wrap.querySelector('.unit');
Â  if(newUnit) {
Â  Â  newUnit.style.opacity = '0';
Â  Â  newUnit.style.transform = 'translateX(' + (side==='ally' ? '-50px' : '50px') + ')';
Â  Â  void newUnit.offsetWidth;
Â  Â  newUnit.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s';
Â  Â  newUnit.style.opacity = '1';
Â  Â  newUnit.style.transform = 'translateX(0)';
Â  }
Â  await delay(400);
}

async function cpuSwitchAction(nextIdx){
Â  state.busy=true; clearInterval(state.timer); lockInputs(true);
Â  try{
Â  Â  log('CPUãŒäº¤ä»£ã‚’é¸æŠï¼','highlight'); await delay(500);
Â  Â  await animateSwitch('enemy', () => {
Â  Â  Â  state.B.i = nextIdx; state.B.sp = 0; state.suppressAffToastOnce = true; renderSides();
Â  Â  });
Â  Â  showSysToast(`CPUäº¤ä»£: ${right().name}`, 'info');
Â  Â  await delay(800);
Â  Â  const ended = await doTurn('ally'); if(!ended){ state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); startRound(); }
Â  }catch(e){ console.error(e); startRound(); }finally{ state.busy=false; lockInputs(false); }
}

async function pick(h){
Â  if(state.busy || inputLocked) return;
Â  state.busy=true; clearInterval(state.timer); lockInputs(true);
Â  try{
Â  Â  const cpu = ['G','C','P'][Math.floor(Math.random()*3)]; const res = judge(h,cpu); await playJankenAnim(h,cpu,res);
Â  Â  let ko=false; if(res>0){ if(await startOfAction('ally')) ko = await doTurn('ally'); } else if(res<0){ if(await startOfAction('enemy')) ko = await doTurn('enemy'); }
Â  Â  if(!ko){ 
Â  Â  Â  state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); if(state.A.sp<6) state.spAnnA=false; 
Â  Â  Â  renderSides(); log('æ¬¡ã®ã‚¿ãƒ¼ãƒ³','normal'); await delay(600); startRound(); 
Â  Â  }
Â  }catch(e){ console.error(e); startRound(); }
}

async function handleKO(side){
Â  playSE('ko'); const team = side==='ally'?state.A.team:state.B.team; const survivors = team.map((u,i)=>({u,i})).filter(o=>o.u.hp>0);
Â  if(survivors.length===0){
Â  Â  stopBGM(); $('resTitle').textContent = side==='enemy'?'YOU WIN!':'YOU LOSE...'; $('result').classList.add('show');
Â  Â  await delay(3000); $('result').classList.remove('show'); $('battle').style.display='none'; $('setup').style.display='grid'; return true;
Â  }
Â  if(side==='enemy'){
Â  Â  await animateSwitch('enemy', () => {
Â  Â  Â  state.B.i = survivors[0].i; state.B.sp = 0; state.suppressAffToastOnce = true; renderSides();
Â  Â  });
Â  Â  showSysToast(`CPUäº¤ä»£: ${team[state.B.i].name}`, 'info');
Â  Â  await delay(1000); startRound(); return true;
Â  }
Â  forceSwitch = true; openForceSwitch(survivors.map(o=>o.i)); 
Â  return true; 
}

let swModal, swGrid, swDo, swIdx = null;
function openSwitch(){
Â  if(left().lock>0){ showSysToast('äº¤ä»£ç¦æ­¢ï¼','warn'); return; }
Â  forceSwitch = false; if(!swModal || !swGrid || !swDo) return;
Â  swGrid.innerHTML = ''; swIdx = null; swDo.disabled = true;
Â  const idxs = [0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
Â  if(!idxs.length){ log('äº¤ä»£ã§ãã‚‹æ§ãˆãŒã„ã¾ã›ã‚“'); return; }
Â  const enemy = right();
Â  idxs.forEach(i=>{
Â  Â  const u = state.A.team[i]; const skill = SKILLS[u.name]||['?','?']; const m = typeMult(u.type,enemy.type);
Â  Â  let affText='ãƒ¼ ç­‰å€', affClass='color:#8ba0c0'; if(m>=1.5){ affText='â— æœ‰åˆ©'; affClass='color:#4effa5'; } if(m<=0.7){ affText='â–³ ä¸åˆ©'; affClass='color:#ff5c6c'; }
Â  Â  const div = document.createElement('div'); div.className='setupMini selCard'; div.style.setProperty('--typeC',typeColor(u.type));
Â  Â  div.innerHTML=`<div style="font-size:11px;margin-bottom:2px">${u.name}</div><div style="font-size:10px;font-weight:bold;${affClass};margin-bottom:2px">å¯¾ ${enemy.name}: ${affText}</div><div class="statGrid">${barRow('HP',u.hp,u.maxhp)}${barRow('ATK',u.atk,120)}${barRow('DEF',u.def,120)}${barRow('EVA',u.eva,30)}</div><div style="font-size:10px;color:#ccc;margin-top:2px">å¿…æ®º: ${skill[0]}</div>`;
Â  Â  div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx = i; swDo.disabled = false; };
Â  Â  swGrid.appendChild(div);
Â  });
Â  swModal.classList.add('show');
}
function openForceSwitch(indices){
Â  if(!swModal || !swGrid || !swDo) return; swGrid.innerHTML=''; swIdx=null; swDo.disabled=true; const enemy = right();
Â  indices.forEach(i=>{
Â  Â  const u = state.A.team[i]; if(u.hp<=0) return; const skill = SKILLS[u.name]||['?','?']; const m = typeMult(u.type,enemy.type);
Â  Â  let affText='ãƒ¼ ç­‰å€', affClass='color:#8ba0c0'; if(m>=1.5){ affText='â— æœ‰åˆ©'; affClass='color:#4effa5'; } if(m<=0.7){ affText='â–³ ä¸åˆ©'; affClass='color:#ff5c6c'; }
Â  Â  const div=document.createElement('div'); div.className='setupMini selCard'; div.style.setProperty('--typeC',typeColor(u.type));
Â  Â  div.innerHTML=`<div style="font-size:11px;margin-bottom:2px">${u.name}</div><div style="font-size:10px;font-weight:bold;${affClass};margin-bottom:2px">å¯¾ ${enemy.name}: ${affText}</div><div class="statGrid">${barRow('HP',u.hp,u.maxhp)}${barRow('ATK',u.atk,120)}${barRow('DEF',u.def,120)}${barRow('EVA',u.eva,30)}</div><div style="font-size:10px;color:#ccc;margin-top:2px">å¿…æ®º: ${skill[0]}</div>`;
Â  Â  div.onclick=()=>{ document.querySelectorAll('.selCard').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); swIdx=i; swDo.disabled=false; };
Â  Â  swGrid.appendChild(div);
Â  });
Â  swModal.classList.add('show');
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«_shé–¢æ•°ã‚’å®šç¾©
window._sh = (n) => {
Â  const u = [...state.A.team, ...state.B.team].find(x => x.name === n);
Â  if (!u) return;
Â  const skill = SKILLS[u.name] || ['?', '?'];
Â  const modalBody = document.getElementById('infoBody');
Â  if (modalBody) {
Â  Â  modalBody.innerHTML = `
Â  Â  Â  <div style="text-align:center;margin-bottom:8px">
Â  Â  Â  Â  <h2 style="margin:0;color:${typeColor(u.type)};font-size:18px;font-family:'M PLUS 1p'">${u.name}</h2>
Â  Â  Â  Â  <div style="font-size:10px;color:#94a3b8">[${u.rank}/${u.type}]</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="setupMini" style="margin-bottom:8px;background:rgba(0,0,0,0.3);--typeC:${typeColor(u.type)}">
Â  Â  Â  Â  <div class="statGrid">
Â  Â  Â  Â  Â  ${barRow('HP', u.maxhp, 800)}
Â  Â  Â  Â  Â  ${barRow('ATK', u.atk, 120)}
Â  Â  Â  Â  Â  ${barRow('DEF', u.def, 120)}
Â  Â  Â  Â  Â  ${barRow('EVA', u.eva, 30)}
Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div style="background:rgba(30, 41, 59, 0.6);padding:8px;border-radius:6px;border-left:3px solid ${typeColor(u.type)}">
Â  Â  Â  Â  <div style="font-weight:bold;color:#fcd34d;font-size:12px;margin-bottom:4px">æŠ€: ${skill[0]}</div>
Â  Â  Â  Â  <div style="font-size:11px;color:#cbd5e1;line-height:1.4">${skill[1]}</div>
Â  Â  Â  </div>`;
Â  Â  document.getElementById('infoModal').classList.add('show');
Â  }
};

document.addEventListener('DOMContentLoaded', () => {
Â  if (AVAILABLE_WORDS.length === 0) {
Â  Â  const setupEl = $('setup');
Â  Â  setupEl.innerHTML = '<div style="color:#f87171;font-weight:700;text-align:center;padding:50px 20px;">è¨€è‘‰ãŒä¸€ã¤ã‚‚è§£æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ã‚¬ãƒãƒ£ã§è¨€è‘‰ã‚’é›†ã‚ã¦ãã¦ãã ã•ã„ï¼</div>';
Â  Â  return; 
Â  }

Â  makeTeam($('teamA'),'A'); makeTeam($('teamB'),'B');
Â  $('btnStart').onclick = async () => {
Â  Â  state.A.team = collect('A'); state.B.team = collect('B'); state.A.i = 0; state.B.i = 0; state.A.sp = 0; state.B.sp = 0; state.spOn = false; state.spAnnA = false; state.history = new Set(); state.suppressAffToastOnce = false;
Â  Â  $('battleLog').innerHTML = ''; $('setup').style.display = 'none'; $('battle').style.display = 'flex';
Â  Â  playBGM(); preloadImgs([...state.A.team,...state.B.team].map(u=>u.name)); renderSides(); log('ãƒãƒˆãƒ«é–‹å§‹ï¼','highlight'); 
Â  Â  
Â  Â  showSysToast('ãƒãƒˆãƒ«é–‹å§‹ï¼', 'info');
Â  Â  await delay(1000);
Â  Â  checkAffinity(); 
Â  Â  await delay(800); startRound();
Â  };
Â  $('btnG').onclick = () => pick('G'); $('btnC').onclick = () => pick('C'); $('btnP').onclick = () => pick('P');
Â  $('btnSP').onclick = () => { if(!inputLocked && state.A.sp>=6){ state.spOn = !state.spOn; updateSPBtn(); } };
Â  $('btnRand').onclick = () => { randomizeTeam('A'); randomizeTeam('B'); };
Â  $('btnRules').onclick = () => $('rulesModal').classList.add('show'); $('rulesClose').onclick = () => $('rulesModal').classList.remove('show'); $('infoClose').onclick = () => $('infoModal').classList.remove('show');
Â  const btnBack = $('btnBack'); if(btnBack){ btnBack.onclick = () => { window.location.href = GACHA_BASE_URL; }; }
Â  swModal = $('switchModal'); swGrid = $('switchGrid'); swDo = $('swDo'); const btnSwitch = $('btnSwitch'); const swCancel = $('swCancel');
Â  if(btnSwitch) btnSwitch.onclick = () => { if(!inputLocked && !state.busy) openSwitch(); }; if(swCancel && swModal) swCancel.onclick = () => swModal.classList.remove('show');
Â  if(swDo){
Â  Â  swDo.onclick = async () => {
Â  Â  Â  if(swIdx === null) return; swModal.classList.remove('show'); const newUnit = state.A.team[swIdx];
Â  Â  Â  
Â  Â  Â  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äº¤ä»£ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
Â  Â  Â  await animateSwitch('ally', () => {
Â  Â  Â  Â  state.A.i = swIdx; state.A.sp = 0; state.spOn = false; state.suppressAffToastOnce = true; renderSides();
Â  Â  Â  });

Â  Â  Â  showSysToast(`äº¤ä»£: ${newUnit.name}`, 'info');
Â  Â  Â  if(forceSwitch){ 
Â  Â  Â  Â  forceSwitch = false; 
Â  Â  Â  Â  await delay(600); 
Â  Â  Â  Â  startRound(); 
Â  Â  Â  }else{ 
Â  Â  Â  Â  await delay(500); 
Â  Â  Â  Â  const ended = await doTurn('enemy'); 
Â  Â  Â  Â  if(!ended){ 
Â  Â  Â  Â  Â  state.A.sp=Math.min(6,state.A.sp+1); state.B.sp=Math.min(6,state.B.sp+1); startRound(); 
Â  Â  Â  Â  } 
Â  Â  Â  }
Â  Â  };
Â  }
Â  ['switchModal','infoModal','rulesModal'].forEach(id => { const el = $(id); if(!el) return; el.addEventListener('click', e => { if(e.target === el) el.classList.remove('show'); }); });
});
})(); 
</script>
</body>
</html>
