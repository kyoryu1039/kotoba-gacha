<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>KOTOBA-BATTLE | å¯¾æˆ¦ v7.42</title>
<style>
/* ===== THEME ===== */
:root{
  --bg:#0b1228; --text:#eaf2ff; --muted:#cfe2ff;
  --panel:#0f1633; --panel2:#0e1530; --border:#20335f; --shadow:0 18px 44px rgba(0,0,0,.18);
  --ally:#27b1ff; --enemy:#ff6b7a;
  --hp:#63ff8c; --hpBack:#0f2a1c; --gauge:#ffe066; --gaugeBack:#31260a;
  --rel:#8bd3ff; --padGrad:linear-gradient(180deg,#102047,#0b1428);

  --t-ã‚¸ã‚ª:#7aa0ff;       --tbg-ã‚¸ã‚ª:linear-gradient(180deg,#0f1837 0%, rgba(122,160,255,.6) 100%);
  --t-ã‚¢ãƒ‹ãƒãƒ«:#34d790;   --tbg-ã‚¢ãƒ‹ãƒãƒ«:linear-gradient(180deg,#0a2725 0%, rgba(52,215,144,.6) 100%);
  --t-ãƒ•ãƒ¼ãƒ‰:#ffbf4d;     --tbg-ãƒ•ãƒ¼ãƒ‰:linear-gradient(180deg,#261a07 0%, rgba(255,191,77,.6) 100%);
  --t-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:#b68cff; --tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:linear-gradient(180deg,#221742 0%, rgba(182,140,255,.6) 100%);
  --t-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:#2dd6ff; --tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹:linear-gradient(180deg,#0c2638 0%, rgba(45,214,255,.6) 100%);
  --t-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:#ff7a9a;--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼:linear-gradient(180deg,#2b1522 0%, rgba(255,122,154,.6) 100%);
  --t-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:#5ff3d3; --tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³:linear-gradient(180deg,#123235 0%, rgba(95,243,211,.6) 100%);
}
*{box-sizing:border-box;-webkit-text-size-adjust:100%}
html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,"Noto Sans JP",sans-serif;overflow-x:hidden}
.container{max-width:1024px;width:100%;margin:0 auto;padding:10px}
.note{color:#c9d7ff;font-size:12px}

/* ===== LAYOUT ===== */
.inSetup{display:block}.inBattle{display:none}
.battleMode .inSetup{display:none}.battleMode .inBattle{display:block}

.arena{display:grid;grid-template-rows:auto auto auto auto;gap:10px}
.vsrow{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:start}
@media(max-width:600px){.vsrow{gap:6px}}

/* ===== CARD ===== */
.cardwrap{position:relative}
.unit{
  position:relative;border-radius:18px;overflow:hidden;padding:14px;
  background:
    linear-gradient(#0f1833,#0f1833) padding-box,
    var(--rank-grad,linear-gradient(180deg,#c9aa71,#8a6a2a)) border-box;
  border:3px solid transparent;
  box-shadow:0 8px 28px rgba(0,0,0,.25);
}
.unit[data-type="ã‚¸ã‚ª"]{--type-grad:var(--tbg-ã‚¸ã‚ª)} .unit[data-type="ã‚¢ãƒ‹ãƒãƒ«"]{--type-grad:var(--tbg-ã‚¢ãƒ‹ãƒãƒ«)}
.unit[data-type="ãƒ•ãƒ¼ãƒ‰"]{--type-grad:var(--tbg-ãƒ•ãƒ¼ãƒ‰)} .unit[data-type="ã‚³ãƒ³ã‚»ãƒ—ãƒˆ"]{--type-grad:var(--tbg-ã‚³ãƒ³ã‚»ãƒ—ãƒˆ)}
.unit[data-type="ã‚µã‚¤ã‚¨ãƒ³ã‚¹"]{--type-grad:var(--tbg-ã‚µã‚¤ã‚¨ãƒ³ã‚¹)} .unit[data-type="ãƒ’ã‚¹ãƒˆãƒªãƒ¼"]{--type-grad:var(--tbg-ãƒ’ã‚¹ãƒˆãƒªãƒ¼)}
.unit[data-type="ãƒ’ãƒ¥ãƒ¼ãƒãƒ³"]{--type-grad:var(--tbg-ãƒ’ãƒ¥ãƒ¼ãƒãƒ³)}
.unit::before{
  content:"";position:absolute;inset:0;background:var(--type-grad);opacity:.85;z-index:0;
}
/* rank border grad */
.unit[data-rank="S"]{--rank-grad:linear-gradient(135deg,#ff7ab5,#ffd86b,#7bff9f,#79e6ff,#b28bff,#ff7ab5)}
.unit[data-rank="A"]{--rank-grad:linear-gradient(135deg,#ffe49a,#d7a22f)}
.unit[data-rank="B"]{--rank-grad:linear-gradient(135deg,#e9edf2,#9aa4b2)}
.unit[data-rank="C"]{--rank-grad:linear-gradient(135deg,#f1c08a,#9b6a39)}
.unit[data-rank="D"]{--rank-grad:linear-gradient(135deg,#bfc6d2,#6b7484)}
.unit[data-rank="X"]{--rank-grad:linear-gradient(135deg,#2b2b2b,#0e0e0e)}

.headRow{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.owner{font-size:12px;padding:4px 10px;border-radius:999px;background:#0a1230;border:1px solid #2b3a70}
.owner.ally{color:var(--ally)} .owner.enemy{color:var(--enemy)}
.typeTag{font-size:12px;padding:4px 10px;border-radius:999px;color:#061225;border:none;background:rgba(255,255,255,.7)}

.titleWrap{position:relative;z-index:1;margin:2px 0 8px;height:28px;display:flex;align-items:center;justify-content:center}
.title{font-weight:900;white-space:nowrap;max-width:100%;transform-origin:left center;text-shadow:0 2px 4px rgba(0,0,0,.35)}
/* auto-fit base size; scriptã§ç¸®å° */
.title{font-size:22px}
@media(max-width:600px){.title{font-size:20px}}

.illustWrap{position:relative;z-index:1;display:flex;justify-content:center;margin:6px 0 10px}
.illustBox{
  width:66%;aspect-ratio:1;border-radius:12px;display:grid;place-items:center;
  background:var(--illu-bg,#f7f3e5);
  box-shadow:0 12px 30px rgba(0,0,0,.25), inset 0 0 0 2px rgba(255,255,255,.15);
  border:2px solid transparent;
  background-image:linear-gradient(var(--illu-bg,#f7f3e5),var(--illu-bg,#f7f3e5)), var(--illu-border,linear-gradient(135deg,#ffe49a,#d7a22f));
  background-clip:padding-box,border-box;
}
.unit[data-rank="S"] .illustBox{--illu-border:linear-gradient(135deg,#ff7ab5,#ffd86b,#7bff9f,#79e6ff,#b28bff,#ff7ab5)}
.unit[data-rank="A"] .illustBox{--illu-border:linear-gradient(135deg,#ffe49a,#d7a22f)}
.unit[data-rank="B"] .illustBox{--illu-border:linear-gradient(135deg,#e9edf2,#9aa4b2)}
.unit[data-rank="C"] .illustBox{--illu-border:linear-gradient(135deg,#f1c08a,#9b6a39)}
.unit[data-rank="D"] .illustBox{--illu-border:linear-gradient(135deg,#bfc6d2,#6b7484)}
.unit[data-rank="X"] .illustBox{--illu-border:linear-gradient(135deg,#2b2b2b,#0e0e0e)}
.illust{width:66%;height:66%;object-fit:contain;filter:drop-shadow(0 8px 12px rgba(0,0,0,.35))}

/* HP & gauge */
.hpRow{display:flex;align-items:center;gap:10px;margin-top:2px;z-index:1;position:relative}
.hpBox{flex:1;height:14px;background:var(--hpBack);border-radius:8px;overflow:hidden}
.hpFill{height:100%;background:var(--hp)}
.hpNum{font-size:12px;width:120px;text-align:right}

.gRow{display:flex;align-items:center;gap:10px;margin:4px 0 8px;z-index:1}
.gBox{flex:1;height:12px;background:#132031;border:1px solid #2a3a6b;border-radius:7px;display:flex;align-items:center;padding:0 6px;gap:6px}
.pip{width:14px;height:8px;background:var(--gaugeBack);border:1px solid #5a480c;border-radius:3px;opacity:.7}
.pip.on{background:var(--gauge);opacity:1}

/* skill & affinity */
.skill{z-index:1;border-radius:12px;background:#0c1938;color:#eaf2ff;border:1px solid #2b3a70;padding:10px;margin-top:6px}
.skillTitle{font-weight:900;margin-bottom:4px}
.skillDesc{font-size:12px;line-height:1.35}
.affRow{display:flex;align-items:center;gap:10px;justify-content:flex-start;margin-top:6px}
.affTxt{font-size:12px;white-space:nowrap}
.statBtn{margin-left:auto;background:#0e1530;border:1px solid #2b3a70;border-radius:8px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px}

/* æ“ä½œãƒ‘ãƒƒãƒ‰ */
.pad{border:1px solid #233562;border-radius:18px;background:linear-gradient(180deg,#122755,#0b1428);padding:12px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
.pad.disabled{opacity:.55;filter:saturate(.8)}
.padInner{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center}
.rpsArea{position:relative;height:170px}
.rps{position:absolute;display:grid;place-items:center;width:90px;height:90px;border-radius:999px;border:none;color:#061225;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.rps .emo{font-size:34px}.rps .lbl{font-size:12px;margin-top:2px;font-weight:800}
.rps.g{left:50%;transform:translateX(-50%);top:8px;background:linear-gradient(180deg,#ffdfde,#ff8b8b)}
.rps.c{left:12%;bottom:6%;background:linear-gradient(180deg,#e0e8ff,#8bb1ff)}
.rps.p{right:12%;bottom:6%;background:linear-gradient(180deg,#defae5,#8bffb5)}
.ctrls{display:flex;gap:10px}
.btnSP,.btnSW{flex:1;border-radius:12px;padding:10px 14px;border:2px solid #f2c94c;background:#0e1530;color:#f2c94c;font-weight:900}
.btnSW{background:linear-gradient(90deg,#ffd89b,#fda085);border:none;color:#26110b}
.btnSP.small,.btnSW.small{transform:scale(.9);transform-origin:left center}
.btnReady{animation:pulse 1.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,224,102,.55)}70%{box-shadow:0 0 0 14px rgba(255,224,102,0)}100%{box-shadow:0 0 0 0 rgba(255,224,102,0)}}
.rps[disabled]{pointer-events:none;opacity:1;filter:none}

/* Box list */
.boxGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.boxCol{background:var(--panel2);border:1px solid #233562;border-radius:12px;padding:8px}
.mini{border:1px solid #1a2b54;border-radius:12px;padding:8px;cursor:pointer;position:relative;display:grid;gap:4px}
.mini .bar{height:11px;background:#11321f;border-radius:6px;overflow:hidden}
.mini .bar>span{display:block;height:100%;background:var(--hp)}
.mini .tag{position:absolute;right:8px;top:8px;font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.18);backdrop-filter:blur(2px)}

/* timer & toast */
.timer{display:flex;justify-content:center;gap:8px;align-items:center;font-weight:900}
.timer .num{font-size:28px}
.toastArea{min-height:60px}
.toast{margin:8px auto 0;max-width:min(96vw,720px);padding:12px 16px;border-radius:14px;background:rgba(12,22,50,.96);border:1px solid #2b3a70;color:#eaf3ff;opacity:0;transform:translateY(8px);transition:.22s ease}
.toast.show{opacity:1;transform:translateY(0);cursor:pointer}

/* SHAKES */
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
.shake{animation:shake .5s ease}

/* SWITCH MODAL */
#switchModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:60}
.modalCard{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;width:min(84vw,540px)}
.selCard{cursor:pointer} .selCard.selected{outline:3px solid #ffe066}

/* loading */
#loading{position:fixed;inset:0;background:rgba(6,10,26,.85);display:none;place-items:center;z-index:80;color:#eaf2ff}
.spinner{width:48px;height:48px;border:5px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* mobile */
@media(max-width:600px){
  html{font-size:13.5px}
  .rps{width:78px;height:78px}.rps .emo{font-size:30px}
  .btnSP,.btnSW{padding:8px 12px}
}
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div><div style="margin-top:12px">å¯¾æˆ¦æº–å‚™ä¸­â€¦</div></div>

<!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆç°¡ç•¥ï¼‰ -->
<div class="container inSetup" id="setup">
  <section style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow)">
    <h2 style="margin:0 0 8px">ãƒãƒ¼ãƒ ç·¨æˆï¼ˆã‚ãªãŸ / CPUï¼‰</h2>
    <div id="teamGrid" style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
      <div>
        <div style="font-weight:900;color:#27b1ff">ã‚ãªãŸ</div>
        <div id="teamA"></div>
      </div>
      <div>
        <div style="font-weight:900;color:#ff6b7a">CPU</div>
        <div id="teamB"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <button id="btnRand" style="padding:8px 12px;border-radius:10px;border:1px solid #2b3a70;background:#0b1430;color:#eaf2ff">ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆ</button>
      <button id="btnStart" style="margin-left:auto;padding:8px 12px;border-radius:10px;border:none;background:#2dd6ff;color:#061225;font-weight:900">å¯¾æˆ¦é–‹å§‹</button>
    </div>
  </section>
</div>

<!-- ãƒãƒˆãƒ« -->
<div id="battle" class="container inBattle">
  <section style="background:transparent;border:none;padding:0">
    <div class="arena">
      <div class="vsrow">
        <div id="leftWrap" class="cardwrap"></div>
        <div id="rightWrap" class="cardwrap"></div>
      </div>

      <!-- æ“ä½œãƒ‘ãƒƒãƒ‰ -->
      <div class="pad" id="pad">
        <div class="padInner">
          <div class="rpsArea">
            <button class="rps g" id="btnG"><div class="emo">âœŠ</div><div class="lbl">ã‚°ãƒ¼</div></button>
            <button class="rps c" id="btnC"><div class="emo">âœŒï¸</div><div class="lbl">ãƒãƒ§ã‚­</div></button>
            <button class="rps p" id="btnP"><div class="emo">ğŸ–</div><div class="lbl">ãƒ‘ãƒ¼</div></button>
          </div>
          <div class="ctrls">
            <button class="btnSP small" id="btnSP" disabled>âœ¨ å¿…æ®º OFF</button>
            <button class="btnSW small" id="btnSwitch">ğŸ” äº¤ä»£</button>
          </div>
        </div>
      </div>

      <div class="toastArea"><div class="toast" id="toast" title="ã‚¿ãƒƒãƒ—ã§æ—©é€ã‚Š"></div></div>
      <div class="timer">é¸æŠã¾ã§ <span class="num" id="countNum">15</span> ç§’</div>

      <!-- ãƒœãƒƒã‚¯ã‚¹ -->
      <div class="boxGrid">
        <div class="boxCol">
          <div style="font-weight:900;color:#27b1ff">ã‚ãªãŸã®ãƒœãƒƒã‚¯ã‚¹</div>
          <div id="sixA"></div>
        </div>
        <div class="boxCol">
          <div style="font-weight:900;color:#ff6b7a">CPUã®ãƒœãƒƒã‚¯ã‚¹</div>
          <div id="sixB"></div>
        </div>
      </div>

    </div>
  </section>
</div>

<!-- äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="switchModal">
  <div class="modalCard">
    <div style="font-weight:900;margin-bottom:8px">äº¤ä»£å…ˆã‚’é¸æŠ</div>
    <div id="switchGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
    <div style="display:flex;justify-content:space-between;margin-top:10px">
      <div id="swTimer" class="note">è‡ªå‹•äº¤ä»£ã¾ã§ 15 ç§’</div>
      <div>
        <button id="swCancel" style="padding:6px 10px;border-radius:8px;border:1px solid #2b3a70;background:#0b1430;color:#eaf2ff">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="swDo" style="padding:6px 10px;border-radius:8px;border:none;background:#ffe066;color:#2a1700;font-weight:900" disabled>äº¤ä»£ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<audio id="bgm" src="audio/Hypnagogiaondo.mp3" loop preload="auto" style="display:none"></audio>

<script>
(()=>{'use strict';
const $=id=>document.getElementById(id);
const delay=ms=>new Promise(r=>setTimeout(r,ms));
const qs=(s,el=document)=>el.querySelector(s);

/* ===== assets ===== */
const IMG = {
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":"parabola_antenna.png","ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":"nescafe_ambassador.png","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":"ninjin_shirishiri.png","ãã¼ã‚ã”ã¯ã‚“":"soboro_gohan.png","ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":"western_lowland_gorilla.png","æ¯›ã‚€ãã˜ã‚ƒã‚‰":"kemukujara.png","ä¹å“ä»":"kuhonbutsu.png","ã‘ã‚“ã¡ã‚“æ±":"kenchin_jiru.png","ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":"kamchatka_peninsula.png","ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":"tarantula.png","ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":"shoebill.png","ãƒãƒ«ã‚µãƒŸã‚³é…¢":"balsamic_vinegar.png","ãƒ”ãƒ­ãƒªèŒ":"helicobacter_pylori.png","ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":"trinidad_and_tobago.png","ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":"caramel_color.png","ãƒãƒ“ãƒ­ãƒ³æ•å›š":"babylonian_captivity.png","é³¥å–ç ‚ä¸˜":"tottori_sand_dunes.png","ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":"placebo_effect.png","æ¸¡æ¥äºº":"torai_jin.png","ã•ã‚‹ã³ã‚ä¸¸":"sarubia_maru.png","ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":"peperoncino.png","ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":"polypropylene.png","ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":"sarajevo_incident.png","ã‚¯ãƒãƒ³ãƒãƒ":"kumabachi.png","çœŒåºæ‰€åœ¨åœ°":"prefectural_capital.png","ç…§ã‚Šç„¼ããƒã‚­ãƒ³":"teriyaki_chicken.png","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":"nerunerunerune.png","ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":"surume_ika.png","æœ¬è³ª":"essence.png","è¦‹ãˆã‚‹åŒ–":"mieruka.png","è‡ªåˆ†ã”ã¨åŒ–":"jibungotoka.png","è§£åƒåº¦":"resolution.png"
};
function preloadImgs(names){
  names.forEach(n=>{
    const f=IMG[n]; if(!f) return;
    const link=document.createElement('link'); link.rel='preload'; link.as='image'; link.href=`images/${f}`; document.head.appendChild(link);
    const im=new Image(); im.decoding="async"; im.loading="eager"; im.src=`images/${f}`;
  });
}

/* ===== helper ===== */
const MAX={HP:800,ATK:120,DEF:120,EVA:20};
const TYPES_RING=['ãƒ’ã‚¹ãƒˆãƒªãƒ¼','ã‚¸ã‚ª','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ','ã‚µã‚¤ã‚¨ãƒ³ã‚¹','ã‚¢ãƒ‹ãƒãƒ«','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³','ãƒ•ãƒ¼ãƒ‰'];
const typeMult=(atk,def)=>{const n=TYPES_RING.length,i=TYPES_RING.indexOf(atk),j=TYPES_RING.indexOf(def);if(i<0||j<0)return 1;const st=[(i+1)%n,(i+2)%n], wk=[(i-1+n)%n,(i-2+n)%n];if(st.includes(j))return 1.5;if(wk.includes(j))return 0.67;return 1;};
const PRANK={S:170,A:165,B:160,C:150,D:145,X:150};
const HP_BASE={S:560,A:540,B:520,C:500,D:480,X:500};

/* === status calc (v7.4) === */
const toKatakana = (s)=> (s||"").replace(/[ã-ã‚“]/g, ch => String.fromCharCode(ch.charCodeAt(0)+0x60));
const reKanaH = /[ã-ã‚Ÿ]/g, reKanaK = /[ã‚ -ãƒ¿ãƒ¼]/g, reKanji = /[ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]/g;
function countClass(name){const H=(name.match(reKanaH)||[]).length,K=(name.match(reKanaK)||[]).length,J=(name.match(reKanji)||[]).length;return{H,K,J,total:H+K+J};}
const reSmallK = /[ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§ãƒ®ã‡°-ã‡¿]/g, reSokuon=/ãƒƒ/g, reVoiced=/[ã‚¬-ãƒãƒ´]/g, rePlosiveEnd=/[ãƒ„ãƒƒã‚¯ã‚­ãƒãƒ†ãƒˆãƒ—ãƒ”ãƒšãƒã‚«ã‚¿]$/;
const visualLen = (s)=> (s||"").replace(/[ãƒ»\s]/g,"").length;

function calcAttackDefense(name,yomiKatakana){
  let atkP=17.5, defP=17.5;
  const cls=countClass(name);
  if(cls.J+cls.K===0){atkP+=12.5;defP+=12.5;}
  else{const r=cls.K/(cls.J+cls.K);atkP+=25*r;defP+=25*(1-r);}
  const Lph=yomiKatakana.length||1;
  const d=(yomiKatakana.match(reVoiced)||[]).length/Lph;
  const s=(yomiKatakana.match(reSokuon)||[]).length/Lph;
  const m=(yomiKatakana.match(reSmallK)||[]).length/Lph;
  const e=rePlosiveEnd.test(yomiKatakana)?1:0;
  const s_raw=0.6*d+0.25*(s+m)+0.15*e, L=0.05, U=0.45;
  const s_ph=Math.max(-1,Math.min(1,((s_raw-L)/(U-L))*2-1));
  const atk_ph=20*(0.5+0.5*s_ph);
  atkP+=atk_ph; defP+=20-atk_ph;
  const T=visualLen(name);
  const s_len=Math.max(-1,Math.min(1,(6-T)/6));
  const atk_len=20*(0.5+0.5*s_len);
  atkP+=atk_len; defP+=20-atk_len;
  return {atkP,defP,T};
}
function calcEvasion(name,T,rank){
  const cls=countClass(name);const hiraRatio=cls.total?(cls.H/cls.total):0;
  const rankAdj=({S:-1,A:-0.5,B:0,C:0.5,D:1,X:0})[rank]??0;
  let eva=10+8*hiraRatio-0.5*(T-5)+rankAdj; eva=Math.round(eva*10)/10;
  return Math.max(5,Math.min(35,eva));
}
function makeWordObject([name,rank,type,yomiH]){
  const y=toKatakana(yomiH||name);
  const {atkP,defP,T}=calcAttackDefense(name,y);
  const ATK=Math.round(PRANK[rank]*(atkP/100));
  const DEF=Math.round(PRANK[rank]*(defP/100));
  const HP=Math.round(HP_BASE[rank]+20*(T-5));
  const EVA=calcEvasion(name,T,rank);
  return {name,rank,type,yomi:y,maxhp:HP,hp:HP,atk:ATK,def:DEF,eva:EVA,
    shield:0,eva60:0,atk13:0,lock:0,doom:0,selfHurt:0,stun:false,endure:false};
}

/* skill defs (å¦¨å®³é›»æ³¢ 2.2å€) */
const SKILLS={
 "ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ":["å¦¨å®³é›»æ³¢","ã“ã®ä¸€æ’ƒã¯2.2å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ã‚’0ã«ã™ã‚‹ã€‚"],
 "ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼":["ä¸€æ¯ã„ã‹ãŒ","é€šå¸¸æ”»æ’ƒã®ã‚ã¨ã€å‘³æ–¹å…¨å“¡ã®HPã‚’60å›å¾©ã™ã‚‹ï¼ˆè‡ªåˆ†ã‚‚60ï¼‰ã€‚"],
 "ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š":["ãªã‚“ãã‚‹ãªã„ã•ãƒ¼","ã“ã®ä¸€æ’ƒã¯1.6å€ã§ã‚ã‚‹ã€‚æ¬¡ã«å—ã‘ã‚‹è‡´å‘½å‚·ã‚’1å›ã ã‘HP1ã§è€ãˆã‚‹ã€‚"],
 "ãã¼ã‚ã”ã¯ã‚“":["ãã¼ã‚ä¹±èˆ","3å›é€£ç¶šã§æ”»æ’ƒã™ã‚‹ï¼ˆ0.75â†’0.5â†’0.25å€ï¼‰ã€‚ç›¸æ‰‹ã‚’å€’ã—ãŸã‚‰æ¬¡ã®ç›¸æ‰‹ã«ã‚‚ç¶šãã€‚"],
 "ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©":["ãƒã‚¦ãƒ³ãƒ†ãƒ³ãƒ“ãƒ¼ãƒˆ","ã“ã®ä¸€æ’ƒã¯1.5å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«æ¬¡ã®2å›ã®è‡ªåˆ†ã®æ”»æ’ƒã¯1.3å€ã«ãªã‚‹ã€‚"],
 "æ¯›ã‚€ãã˜ã‚ƒã‚‰":["ãƒ ã‚¯ã‚¸ãƒ£ãƒ©ãƒ©","ã“ã®ä¸€æ’ƒã¯1.4å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«æ¬¡ã®2å›ã®è‡ªåˆ†ã®æ”»æ’ƒã®ã‚ã„ã å›é¿ç‡ãŒ60%ã«ãªã‚‹ã€‚"],
 "ä¹å“ä»":["ä»ã®é¡”ã‚‚ä¸‰åº¦ã¾ã§","ã“ã®ä¸€æ’ƒã¯1.6å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«æ¬¡ã®2å›ã®ç›¸æ‰‹ã‹ã‚‰ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’åŠåˆ†ã«ã™ã‚‹ã€‚"],
 "ã‘ã‚“ã¡ã‚“æ±":["é•·å¯¿ã®ç§˜è¨£","ã“ã®ä¸€æ’ƒã¯1.2å€ã§ã‚ã‚‹ã€‚ã•ã‚‰ã«è‡ªåˆ†ã®HPã‚’150å›å¾©ã™ã‚‹ã€‚"],
 "ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã«è¡Œå‹•ã§ããªã„ã€‚"],
 "ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ãƒãƒ«ã‚µãƒŸã‚³é…¢":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ãƒ”ãƒ­ãƒªèŒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã«è¡Œå‹•ã§ããªã„ã€‚"],
 "ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "ãƒãƒ“ãƒ­ãƒ³æ•å›š":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "é³¥å–ç ‚ä¸˜":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "æ¸¡æ¥äºº":["æ–‡å­—åŒ–ã‘","3ã‚¿ãƒ¼ãƒ³å¾Œã«è‡ªåˆ†ãŒæˆ¦é—˜ä¸èƒ½ã«ãªã‚‹ï¼ˆäº¤ä»£ã§è§£é™¤ï¼‰ã€‚"],
 "ã•ã‚‹ã³ã‚ä¸¸":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã«è¡Œå‹•ã§ããªã„ã€‚"],
 "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶":["è¨€è‘‰ç‹©ã‚Š","ç›¸æ‰‹ã¯æ¬¡ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã«è¡Œå‹•ã§ããªã„ã€‚"],
 "ã‚¯ãƒãƒ³ãƒãƒ":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "çœŒåºæ‰€åœ¨åœ°":["æ–‡å­—åŒ–ã‘","3ã‚¿ãƒ¼ãƒ³å¾Œã«è‡ªåˆ†ãŒæˆ¦é—˜ä¸èƒ½ã«ãªã‚‹ï¼ˆäº¤ä»£ã§è§£é™¤ï¼‰ã€‚"],
 "ç…§ã‚Šç„¼ããƒã‚­ãƒ³":["è¨€è«–çµ±åˆ¶","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®è‡ªåˆ†ã®æ”»æ’ƒãŒçµ‚ã‚ã‚‹ã¾ã§äº¤ä»£ã§ããªã„ã€‚"],
 "ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«":["ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š","ç›¸æ‰‹ã¯æ¬¡ã®3å›ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã®ãŸã³ã€33%ã®ç¢ºç‡ã§è‡ªåˆ†ã«100ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚"],
 "æœ¬è³ª":["é¡æ–‡å­—","ãƒ©ãƒ³ãƒ€ãƒ ãªç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã€åŠ¹æœã‚‚å«ã‚ã¦æ”¾ã¤ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è¦‹ãˆã‚‹åŒ–":["é¡æ–‡å­—","ãƒ©ãƒ³ãƒ€ãƒ ãªç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã€åŠ¹æœã‚‚å«ã‚ã¦æ”¾ã¤ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è‡ªåˆ†ã”ã¨åŒ–":["é¡æ–‡å­—","ãƒ©ãƒ³ãƒ€ãƒ ãªç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã€åŠ¹æœã‚‚å«ã‚ã¦æ”¾ã¤ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"],
 "è§£åƒåº¦":["é¡æ–‡å­—","ãƒ©ãƒ³ãƒ€ãƒ ãªç›¸æ‰‹ã®å¿…æ®ºã‚’ã‚³ãƒ”ãƒ¼ã—ã€åŠ¹æœã‚‚å«ã‚ã¦æ”¾ã¤ï¼ˆå¨åŠ›2å€ï¼‰ã€‚"]
};

/* words */
const WORDS_BASE=[["ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ","S","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã±ã‚‰ã¼ã‚‰ã‚ã‚“ã¦ãª"],["ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼","S","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã­ã™ã‹ãµã‡ã‚ã‚“ã°ã•ã ãƒ¼"],["ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š","A","ãƒ•ãƒ¼ãƒ‰","ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š"],["ãã¼ã‚ã”ã¯ã‚“","A","ãƒ•ãƒ¼ãƒ‰","ãã¼ã‚ã”ã¯ã‚“"],["ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©","A","ã‚¢ãƒ‹ãƒãƒ«","ã«ã—ã‚ãƒ¼ã‚‰ã‚“ã©ã”ã‚Šã‚‰"],["æ¯›ã‚€ãã˜ã‚ƒã‚‰","A","ã‚¢ãƒ‹ãƒãƒ«","ã‘ã‚€ãã˜ã‚ƒã‚‰"],["ä¹å“ä»","A","ã‚¸ã‚ª","ãã»ã‚“ã¶ã¤"],["ã‘ã‚“ã¡ã‚“æ±","A","ãƒ•ãƒ¼ãƒ‰","ã‘ã‚“ã¡ã‚“ã˜ã‚‹"],["ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶","B","ã‚¸ã‚ª","ã‹ã‚€ã¡ã‚ƒã£ã‹ã¯ã‚“ã¨ã†"],["ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©","B","ã‚¢ãƒ‹ãƒãƒ«","ãŸã‚‰ã‚“ã¡ã‚…ã‚‰"],["ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦","B","ã‚¢ãƒ‹ãƒãƒ«","ã¯ã—ã³ã‚ã“ã†"],["ãƒãƒ«ã‚µãƒŸã‚³é…¢","B","ãƒ•ãƒ¼ãƒ‰","ã°ã‚‹ã•ã¿ã“ã™"],["ãƒ”ãƒ­ãƒªèŒ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã´ã‚ã‚Šãã‚“"],["ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´","B","ã‚¸ã‚ª","ã¨ã‚Šã«ã ãƒ¼ã©ã¨ã°ã”"],["ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ","B","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã‹ã‚‰ã‚ã‚‹ã—ãã"],["ãƒãƒ“ãƒ­ãƒ³æ•å›š","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã°ã³ã‚ã‚“ã»ã—ã‚…ã†"],["é³¥å–ç ‚ä¸˜","C","ã‚¸ã‚ª","ã¨ã£ã¨ã‚Šã•ãã‚…ã†"],["ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã·ã‚‰ã—ãƒ¼ã¼ã“ã†ã‹"],["æ¸¡æ¥äºº","C","ãƒ’ãƒ¥ãƒ¼ãƒãƒ³","ã¨ã‚‰ã„ã˜ã‚“"],["ã•ã‚‹ã³ã‚ä¸¸","C","ã‚¸ã‚ª","ã•ã‚‹ã³ã‚ã¾ã‚‹"],["ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ","C","ãƒ•ãƒ¼ãƒ‰","ãºãºã‚ã‚“ã¡ãƒ¼ã®"],["ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³","C","ã‚µã‚¤ã‚¨ãƒ³ã‚¹","ã½ã‚Šã·ã‚ã´ã‚Œã‚“"],["ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶","C","ãƒ’ã‚¹ãƒˆãƒªãƒ¼","ã•ã‚‰ãˆã¼ã˜ã‘ã‚“"],["ã‚¯ãƒãƒ³ãƒãƒ","D","ã‚¢ãƒ‹ãƒãƒ«","ãã¾ã‚“ã°ã¡"],["çœŒåºæ‰€åœ¨åœ°","D","ã‚¸ã‚ª","ã‘ã‚“ã¡ã‚‡ã†ã—ã‚‡ã–ã„ã¡"],["ç…§ã‚Šç„¼ããƒã‚­ãƒ³","D","ãƒ•ãƒ¼ãƒ‰","ã¦ã‚Šã‚„ãã¡ãã‚“"],["ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­","D","ãƒ•ãƒ¼ãƒ‰","ã­ã‚‹ã­ã‚‹ã­ã‚‹ã­"],["ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«","D","ã‚¢ãƒ‹ãƒãƒ«","ã™ã‚‹ã‚ã„ã‹"],["æœ¬è³ª","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã»ã‚“ã—ã¤"],["è¦‹ãˆã‚‹åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã¿ãˆã‚‹ã‹"],["è‡ªåˆ†ã”ã¨åŒ–","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã˜ã¶ã‚“ã”ã¨ã‹"],["è§£åƒåº¦","X","ã‚³ãƒ³ã‚»ãƒ—ãƒˆ","ã‹ã„ãã†ã©"]];
const makeW=i=>makeWordObject(WORDS_BASE[i]);

/* ===== state ===== */
const state={A:{team:[],i:0,sp:0},B:{team:[],i:0,sp:0},remain:15,timer:null,spOn:false,busy:false,spAnnA:false,spAnnB:false};
const left =()=>state.A.team[state.A.i], right=()=>state.B.team[state.B.i];

/* ===== toast (tap to fast-forward) ===== */
const toastQueue=[]; let toastBusy=false; let inputLocked=false; let toastSkip=false;
const baseToast=1500, perChar=60;
function toastDuration(msg){return Math.min(9000, baseToast + String(msg).length*perChar) + 120;}
function lockInputs(on){inputLocked=on; disableRPS(on); $('btnSwitch').disabled=on; $('btnSP').disabled= on || state.A.sp<6; $('pad').classList.toggle('disabled',on);}
$('toast').onclick=()=>{toastSkip=true;};
function toast(msg){toastQueue.push(String(msg)); if(!toastBusy) runToast();}
async function runToast(){toastBusy=true; lockInputs(true);
  while(toastQueue.length){
    const t=$('toast'), m=toastQueue.shift(), base=toastDuration(m);
    t.textContent=m; t.classList.add('show'); toastSkip=false;
    const start=performance.now();
    while(true){
      if(toastSkip) break;
      const elapsed=performance.now()-start;
      if(elapsed>=base) break;
      await delay(60);
    }
    t.classList.remove('show'); await delay(120);
  }
  toastBusy=false; lockInputs(false);
}
async function waitToasts(){while(toastBusy || toastQueue.length){await delay(40);}}

/* ===== audio ===== */
let bgmArmed=false;
function armBGM(){ if(bgmArmed) return; bgmArmed=true; const a=$('bgm'); a.volume=.2; a.play().catch(()=>{}); }
document.addEventListener('click',armBGM,{once:true});

/* ===== UI bits ===== */
function titleAutoFit(el){
  // å˜ä¸€è¡Œã§å¿…ãšåã¾ã‚‹ã‚ˆã†ç¸®å°
  const max= parseFloat(getComputedStyle(el).getPropertyValue('font-size')) || 22;
  let size=max;
  el.style.fontSize=size+'px';
  const parent = el.parentElement;
  while((el.scrollWidth > parent.clientWidth) && size>12){ size-=0.5; el.style.fontSize=size+'px'; }
}
function hpTween(bar,from,to,dur=1600){
  return new Promise(res=>{
    const start=performance.now();
    function step(now){
      const p=Math.min(1,(now-start)/dur);
      const v=from+(to-from)*p;
      bar.style.width=v+'%';
      if(p<1) requestAnimationFrame(step); else res();
    }
    requestAnimationFrame(step);
  });
}
function barRow(label,val,max){const pct=label==='å›é¿'?Math.max(0,Math.min(100,(val/MAX.EVA)*100)):Math.max(0,Math.min(100,(val/max)*100));return `<div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div style="width:76px;font-size:12px;color:${'var(--muted)'}">${label}</div><div style="flex:1;height:16px;background:#0e1b31;border:1px solid #2a3a6b;border-radius:8px;overflow:hidden"><div style="height:100%;background:${'var(--rel)'};width:${pct}%"></div></div><div style="font-size:12px;width:90px;text-align:right">${label==='å›é¿'?val+'%':val}</div></div>`;}
function miniCard(u){
  return `<div class="mini" data-name="${u.name}" data-type="${u.type}">
    <div style="font-weight:900">${u.name}</div>
    <span class="tag">${u.type}</span>
    <div class="bar"><span style="width:${100*u.hp/u.maxhp}%"></span></div>
    <div style="font-size:12px">HP ${u.hp}/${u.maxhp}</div>
  </div>`;
}

/* ===== SP gauge button ===== */
function updateSPBtn(){
  const readyA=state.A.sp>=6, readyB=state.B.sp>=6, btn=$('btnSP');
  if(btn){btn.disabled=inputLocked || !readyA;btn.classList.toggle('btnReady',readyA&&!state.spOn);btn.textContent=state.spOn?'âœ¨ å¿…æ®º ON':'âœ¨ å¿…æ®º OFF';}
  $('gA')?.classList.toggle('btnReady',readyA); $('gB')?.classList.toggle('btnReady',readyB);
  if(readyA && !state.spAnnA){toast('ã‚ãªãŸã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã«ãªã£ãŸã€‚'); state.spAnnA=true;}
  if(readyB && !state.spAnnB){toast('ç›¸æ‰‹ã®å¿…æ®ºã‚²ãƒ¼ã‚¸ãŒæº€ã‚¿ãƒ³ã«ãªã£ãŸã€‚'); state.spAnnB=true;}
}

/* ===== timer ===== */
function startRound(){
  state.remain=15; $('countNum').textContent=state.remain; clearInterval(state.timer);
  disableRPS(false);
  state.timer=setInterval(()=>{ if(toastBusy) return; state.remain--; $('countNum').textContent=state.remain; if(state.remain<=0){const r=['G','C','P'][Math.floor(Math.random()*3)]; pick(r);} },1000);
}
async function restartRoundAfterToasts(){clearInterval(state.timer); await waitToasts(); startRound();}

/* ===== damage/defense calc ===== */
function baseDamage(att,def){
  let mult=typeMult(att.type,def.type);
  if(att.atk13>0) mult*=1.3;
  let dmg=100*(1+att.atk/100)/(1+def.def/120)*mult;
  if(def.shield>0) dmg*=0.5;
  return dmg;
}

/* ===== persistent statuses ===== */
function phrases(u){
  const arr=[];
  if(u.shield>0)arr.push(`è¢«ãƒ€ãƒ¡åŠæ¸›ï¼ˆæ®‹ã‚Š${u.shield}å›ï¼‰`);
  if(u.eva60>0)arr.push(`å›é¿60%ï¼ˆæ®‹ã‚Š${u.eva60}å›ï¼‰`);
  if(u.atk13>0)arr.push(`ä¸ãƒ€ãƒ¡1.3å€ï¼ˆæ®‹ã‚Š${u.atk13}å›ï¼‰`);
  if(u.lock>0)arr.push(`äº¤ä»£ä¸å¯ï¼ˆæ®‹ã‚Š${u.lock}å›ï¼‰`);
  if(u.doom>0)arr.push(`æ–‡å­—åŒ–ã‘ï¼ˆ${u.doom}Tå¾Œã«æˆ¦é—˜ä¸èƒ½ï¼‰`);
  if(u.selfHurt>0)arr.push(`ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼ˆæ®‹ã‚Š${u.selfHurt}å›ï¼‰`);
  if(u.endure)arr.push(`æ ¹æ€§1ï¼ˆæœªä½¿ç”¨ï¼‰`);
  return arr;
}
async function announceEndStatuses(){
  const a=phrases(left()); const b=phrases(right());
  if(a.length) toast(`ã‚ãªãŸï¼š${a.join(' / ')}`);
  if(b.length) toast(`ç›¸æ‰‹ï¼š${b.join(' / ')}`);
  await waitToasts();
}

/* ===== action gates ===== */
async function startOfAction(side){
  const me = side==='ally'?left():right();
  if(me.shield>0)me.shield--;
  if(me.eva60>0)me.eva60--;
  if(me.atk13>0)me.atk13--;
  if(me.lock>0)me.lock--;
  if(me.selfHurt>0)me.selfHurt--;

  if(me.doom>0){me.doom--; if(me.doom<=0){me.hp=0; renderSides(); buildBoxes(); toast(`${me.name}ã¯æ–‡å­—åŒ–ã‘ã®åŠ¹æœã§å€’ã‚ŒãŸï¼`); await waitToasts(); await handleKO(side==='ally'?'ally':'enemy'); return false;}}
  if(me.stun){me.stun=false; toast(`${me.name}ã¯è¨€è‘‰ç‹©ã‚Šã®åŠ¹æœã§ã€ã“ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³ã¯è¡Œå‹•ã§ããªã„ã€‚`); await waitToasts(); return false;}
  return true;
}

/* ===== SP pre/post ===== */
function spEffectPre(att,def,role){
  let mult=1, multiSeq=null, name=(SKILLS[att.name]||['â€”'])[0], desc=(SKILLS[att.name]||['â€”','â€”'])[1], usedReal=att.name;
  switch(att.name){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': mult=2.2; break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': mult=1; break;
    case 'ã«ã‚“ã˜ã‚“ã—ã‚Šã—ã‚Š': mult=1.6; att.endure=true; break;
    case 'ãã¼ã‚ã”ã¯ã‚“': multiSeq=[0.75,0.5,0.25]; break;
    case 'ãƒ‹ã‚·ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰ã‚´ãƒªãƒ©': mult=1.5; att.atk13=2; break;
    case 'æ¯›ã‚€ãã˜ã‚ƒã‚‰': mult=1.4; att.eva60=2; break;
    case 'ä¹å“ä»': mult=1.6; att.shield=2; break;
    case 'ã‘ã‚“ã¡ã‚“æ±': mult=1.2; break;
    case 'ã‚«ãƒ ãƒãƒ£ãƒƒã‚«åŠå³¶': case 'ãƒã‚·ãƒ“ãƒ­ã‚³ã‚¦': case 'ãƒãƒ«ã‚µãƒŸã‚³é…¢':
    case 'ãƒãƒ“ãƒ­ãƒ³æ•å›š': case 'ãƒãƒªãƒ—ãƒ­ãƒ”ãƒ¬ãƒ³': case 'ã‚¯ãƒãƒ³ãƒãƒ': case 'ç…§ã‚Šç„¼ããƒã‚­ãƒ³':
      def.lock=3; break;
    case 'ã‚¿ãƒ©ãƒ³ãƒãƒ¥ãƒ©': case 'ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´': case 'ã‚µãƒ©ã‚¨ãƒœäº‹ä»¶': case 'ã•ã‚‹ã³ã‚ä¸¸':
      def.stun=true; break;
    case 'ãƒ”ãƒ­ãƒªèŒ': case 'ã‚«ãƒ©ãƒ¡ãƒ«è‰²ç´ ': case 'é³¥å–ç ‚ä¸˜': case 'ãƒ—ãƒ©ã‚·ãƒ¼ãƒœåŠ¹æœ': case 'ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ': case 'ã‚¹ãƒ«ãƒ¡ã‚¤ã‚«':
      def.selfHurt=3; break; // â† å—ã‘ãŸå´
    case 'æ¸¡æ¥äºº': case 'çœŒåºæ‰€åœ¨åœ°':
      def.doom=3; break;
    case 'æœ¬è³ª': case 'è¦‹ãˆã‚‹åŒ–': case 'è‡ªåˆ†ã”ã¨åŒ–': case 'è§£åƒåº¦': {
      // é¡æ–‡å­—ï¼šç›¸æ‰‹ã®å¿…æ®ºã‚’åŠ¹æœã”ã¨ã‚³ãƒ”ãƒ¼ã€å¨åŠ›2å€
      const foe=(role==='ally'?state.B.team:state.A.team).filter(u=>u.rank!=='X' && u.hp>0);
      if(foe.length){
        const pick=foe[Math.floor(Math.random()*foe.length)];
        const p=spEffectPre({...att,name:pick.name},def,role);
        mult=2.0*(p.mult||1); multiSeq=p.multiSeq? p.multiSeq.map(x=>x*2.0) : null;
        name='é¡æ–‡å­—'; desc=`${pick.name}ã®ã€Œ${(SKILLS[pick.name]||['â€”'])[0]}ã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ”¾ã¤ã€‚`; usedReal=pick.name;
      }else{ mult=2.0; name='é¡æ–‡å­—'; desc='ã‚³ãƒ”ãƒ¼ã§ãã‚‹å¿…æ®ºãŒã„ãªã„ãŸã‚ã€å¨åŠ›2å€ã®ä¸€æ’ƒã®ã¿ã€‚'; }
      break;
    }
  }
  return {mult,multiSeq,name,desc,usedReal};
}
function spEffectPost(att,def,role,used){
  switch(used){
    case 'ãƒ‘ãƒ©ãƒœãƒ©ã‚¢ãƒ³ãƒ†ãƒŠ': if(role==='ally'){state.B.sp=0;state.spAnnB=false;} else {state.A.sp=0;state.spAnnA=false;} break;
    case 'ãƒã‚¹ã‚«ãƒ•ã‚§ã‚¢ãƒ³ãƒã‚µãƒ€ãƒ¼': {
      const t = role==='ally'?state.A.team:state.B.team;
      t.forEach(u=>u.hp=Math.min(u.maxhp,u.hp+60));
      break;
    }
    case 'ã‘ã‚“ã¡ã‚“æ±': att.hp=Math.min(att.maxhp,att.hp+150); break;
  }
}

/* ===== render cards ===== */
function gaugeHtml(sp,tag){const pips=[...Array(6)].map((_,i)=>`<span class="pip ${i<sp?'on':''}"></span>`).join('');return `<div class="gRow"><div style="width:44px">å¿…æ®ºã‚²ãƒ¼ã‚¸</div><div class="gBox" id="g${tag}">${pips}</div><div style="width:30px;text-align:right">${sp}/6</div></div>`;}
function statBarsHtml(u){return `<div style="margin-top:6px">${barRow('HP',u.maxhp,MAX.HP)}${barRow('æ”»æ’ƒ',u.atk,MAX.ATK)}${barRow('é˜²å¾¡',u.def,MAX.DEF)}${barRow('å›é¿',u.eva,MAX.EVA)}</div>`;}
function cardHtml(u,role,opp){
  const illuBG = {'ã‚¸ã‚ª':'#e8f0ff','ã‚¢ãƒ‹ãƒãƒ«':'#eaf9f1','ãƒ•ãƒ¼ãƒ‰':'#fff6e6','ã‚³ãƒ³ã‚»ãƒ—ãƒˆ':'#efe8ff','ã‚µã‚¤ã‚¨ãƒ³ã‚¹':'#e8f7ff','ãƒ’ã‚¹ãƒˆãƒªãƒ¼':'#ffe9ef','ãƒ’ãƒ¥ãƒ¼ãƒãƒ³':'#e9fbf6'}[u.type]||'#f7f3e5';
  const aff=typeMult(u.type,opp.type), affText=aff===1.5?'x1.5ï¼ˆæŠœç¾¤ï¼‰':aff===0.67?'x0.67ï¼ˆã„ã¾ã„ã¡ï¼‰':'x1.0ï¼ˆç­‰å€ï¼‰';
  const sp=role==='ally'?state.A.sp:state.B.sp, tag=role==='ally'?'A':'B';
  const owner=role==='ally'?'ã‚ãªãŸ':'CPU';
  return `<div class="unit" data-type="${u.type}" data-rank="${u.rank}">
    <div class="headRow"><span class="owner ${role==='ally'?'ally':'enemy'}">${owner}</span><span class="typeTag">${u.type}</span></div>
    <div class="titleWrap"><div class="title">${u.name}</div></div>
    <div class="illustWrap"><div class="illustBox" style="--illu-bg:${illuBG}"><img class="illust" alt="" src="images/${IMG[u.name]||''}"></div></div>
    <div class="hpRow"><div>HP</div><div class="hpBox"><div class="hpFill" id="hp-${role}" style="width:${100*u.hp/u.maxhp}%"></div></div><div class="hpNum" id="hpnum-${role}">${u.hp}/${u.maxhp}</div></div>
    ${gaugeHtml(sp,tag)}
    <div class="skill"><div class="skillTitle">âœ¨ å¿…æ®ºï¼š${(SKILLS[u.name]||['â€”'])[0]}</div><div class="skillDesc">${(SKILLS[u.name]||['â€”','â€”'])[1]}</div></div>
    <div class="affRow"><div class="affTxt">ç›¸æ€§ ${affText}</div><button class="statBtn" data-open-stat="${u.name}">â–¶ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª</button></div>
  </div>`;
}
function renderSides(){
  $('leftWrap').innerHTML=`<div id="card-ally">${cardHtml(left(),'ally',right())}</div>`;
  $('rightWrap').innerHTML=`<div id="card-enemy">${cardHtml(right(),'enemy',left())}</div>`;
  // fit titles
  document.querySelectorAll('.title').forEach(titleAutoFit);
  // bind stat buttons
  document.querySelectorAll('[data-open-stat]').forEach(btn=>{
    btn.onclick=()=>{const n=btn.dataset.openStat; const u=[...state.A.team,...state.B.team].find(x=>x.name===n); if(!u) return;
      showStat(u);
    };
  });
  updateSPBtn();
}
function showStat(u){
  const body = `<div style="margin-bottom:6px"><span class="typeTag">${u.type}</span></div>
  ${statBarsHtml(u)}
  <div class="skill" style="margin-top:8px"><div class="skillTitle">âœ¨ å¿…æ®ºï¼š${(SKILLS[u.name]||['â€”'])[0]}</div><div class="skillDesc">${(SKILLS[u.name]||['â€”','â€”'])[1]}</div></div>`;
  const m=document.createElement('div'); m.id='infoModal'; m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.55);display:grid;place-items:center;z-index:70';
  m.innerHTML=`<div class="modalCard" style="width:min(92vw,560px)"><div style="font-weight:900;margin-bottom:8px">${u.name}</div>${body}<div style="text-align:right;margin-top:8px"><button id="infoClose" style="padding:6px 10px;border-radius:8px;border:1px solid #2b3a70;background:#0b1430;color:#eaf2ff">é–‰ã˜ã‚‹</button></div></div>`;
  document.body.appendChild(m); $('infoClose').onclick=()=>m.remove(); m.onclick=(e)=>{if(e.target.id==='infoModal') m.remove();};
}

/* build boxes */
function buildBoxes(){
  $('sixA').innerHTML=state.A.team.map(miniCard).join('');
  $('sixB').innerHTML=state.B.team.map(miniCard).join('');
  document.querySelectorAll('#sixA .mini, #sixB .mini').forEach(div=>{
    div.onclick=()=>{const n=div.dataset.name;const u=[...state.A.team,...state.B.team].find(x=>x.name===n);if(!u)return; showStat(u); };
  });
}

/* ===== RPS enable/disable ===== */
function disableRPS(dis){['btnG','btnC','btnP'].forEach(id=>{const b=$(id); if(b) b.disabled=dis;});}

/* ===== ATTACK CORE ===== */
async function doAttack(att,def,useSP,role){
  if(att.hp<=0) return {ko:false};
  let mult=1, multi=null, spName='', spDesc='', usedReal=att.name;
  if(useSP){
    const pre=spEffectPre(att,def,role);
    mult=pre.mult; multi=pre.multiSeq; spName=pre.name; spDesc=pre.desc; usedReal=pre.usedReal;
    toast(`${role==='ally'?'ã‚ãªãŸ':'ç›¸æ‰‹'}ã®å¿…æ®ºã€ã€Œ${spName}ã€ï¼`); await waitToasts();
    (role==='ally'?$('card-ally'):$('card-enemy'))?.classList.add('shake'); setTimeout(()=> (role==='ally'?$('card-ally'):$('card-enemy'))?.classList.remove('shake'),500);
  }

  const eva = def.eva60>0 ? 60 : def.eva;
  const miss = (!useSP && Math.random() < (eva/100));
  if(miss){ toast(`${att.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`); await waitToasts(); return {ko:false}; }

  const victimRole = (role==='ally'?'enemy':'ally');
  async function applyDamage(dmg){
    const bar=$('hp-'+victimRole);
    const from = parseFloat(bar.style.width)||0;
    const to = Math.max(0, (def.hp - dmg)/def.maxhp*100);
    toast(`${def.name}ã« ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    setTimeout(()=>{$('card-'+victimRole)?.classList.add('shake');setTimeout(()=>$('card-'+victimRole)?.classList.remove('shake'),500);},120);
    await waitToasts();
    def.hp = Math.max(0, def.hp - dmg);
    await hpTween(bar,from,to,1800); // çµ±ä¸€ã®é…ã•
    $('hpnum-'+victimRole).textContent=`${def.hp}/${def.maxhp}`;
  }

  let defeated=false;
  if(useSP && Array.isArray(multi)){
    for(let i=0;i<multi.length;i++){
      const d = Math.max(1, Math.round(baseDamage(att,def)*multi[i]));
      await applyDamage(d);
      if(def.hp<=0){
        if(def.endure){
          def.endure=false; def.hp=1; $('hpnum-'+victimRole).textContent=`${def.hp}/${def.maxhp}`; $('hp-'+victimRole).style.width=(100*def.hp/def.maxhp)+'%';
          toast(`${def.name}ã¯æ ¹æ€§ã§1ã ã‘æ®‹ã—ã¦è€ãˆãŸï¼`); await waitToasts();
        }else{
          toast(`${def.name}ã¯å€’ã‚ŒãŸï¼`); await waitToasts(); defeated=true;
          // ã¾ã é€£æ’ƒãŒæ®‹ã£ã¦ã„ã‚Œã°äº¤ä»£ã•ã›ã¦ç¶™ç¶š
          if(i < multi.length-1){
            const ok = await forceSwitch(victimRole); // auto pick
            if(!ok) break;
            // æ–°ã—ã„defã«å·®ã—æ›¿ãˆ
            def = (victimRole==='enemy')? right() : left();
          }else break;
        }
      }
    }
  }else{
    const d = Math.max(1, Math.round(baseDamage(att,def)*mult));
    await applyDamage(d);
    if(def.hp<=0){
      if(def.endure){
        def.endure=false; def.hp=1; $('hpnum-'+victimRole).textContent=`${def.hp}/${def.maxhp}`; $('hp-'+victimRole).style.width=(100*def.hp/def.maxhp)+'%';
        toast(`${def.name}ã¯æ ¹æ€§ã§1ã ã‘æ®‹ã—ã¦è€ãˆãŸï¼`); await waitToasts();
      }else{
        toast(`${def.name}ã¯å€’ã‚ŒãŸï¼`); await waitToasts(); defeated=true;
      }
    }
  }

  // è‡ªå‚·ï¼ˆã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šï¼šå¯¾è±¡ã®â€œæ”»æ’ƒã‚¿ãƒ¼ãƒ³â€ã”ã¨ã«åˆ¤å®šï¼‰
  if(att.selfHurt>0 && Math.random()<0.33){
    const myRole = role==='ally'?'ally':'enemy';
    const bar=$('hp-'+myRole);
    const from=parseFloat(bar.style.width)||0;
    const to=Math.max(0,(att.hp-100)/att.maxhp*100);
    toast(`${att.name}ï¼ˆ${role==='ally'?'ã‚ãªãŸ':'ç›¸æ‰‹'}ï¼‰ã¯ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šã§è‡ªå‚·100ï¼`);
    await waitToasts();
    att.hp=Math.max(0,att.hp-100);
    await hpTween(bar,from,to,1800);
    $('hpnum-'+myRole).textContent=`${att.hp}/${att.maxhp}`;
    if(att.hp<=0){toast(`${att.name}ã¯å€’ã‚ŒãŸï¼`); await waitToasts(); await handleKO(myRole); return {ko:true};}
  }

  if(useSP){ spEffectPost(att,def,role,usedReal); if(spDesc){ toast(spDesc); await waitToasts(); } }
  return {ko:defeated};
}

/* KO handling & forced switch */
async function forceSwitch(sideTag){
  if(sideTag==='ally'){
    const can=[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0);
    if(!can.length){ showResult(false); return false;}
    const i=can[0]; state.A.i=i; state.A.sp=0; state.spOn=false; updateSPBtn(); renderSides(); buildBoxes(); toast(`ã„ã‘ã€${left().name}ï¼`); await waitToasts(); return true;
  }else{
    const can=[0,1,2].filter(i=>i!==state.B.i && state.B.team[i].hp>0);
    if(!can.length){ showResult(true); return false; }
    let best=can[0],m0=typeMult(state.B.team[best].type,left().type);
    for(const k of can){const m=typeMult(state.B.team[k].type,left().type); if(m>m0){best=k;m0=m;}}
    state.B.i=best; state.B.sp=0; updateSPBtn(); renderSides(); buildBoxes(); toast(`ç›¸æ‰‹ã¯ ${right().name} ã‚’ãã‚Šã ã—ãŸï¼`); await waitToasts(); return true;
  }
}
async function handleKO(side){ await forceSwitch(side); }

/* ===== flow ===== */
function addGaugeAfterAttack(skip=false){
  if(skip) return;
  const a0=state.A.sp,b0=state.B.sp;
  state.A.sp=Math.min(6,a0+1);
  state.B.sp=Math.min(6,b0+1);
  if(state.A.sp>=6 && a0<6)state.spAnnA=false;
  if(state.B.sp>=6 && b0<6)state.spAnnB=false;
}

function judge(a,b){if(a===b)return 0;if((a==='G'&&b==='C')||(a==='C'&&b==='P')||(a==='P'&&b==='G'))return 1;return -1;}

async function pick(h){
  if(state.busy || inputLocked) return; state.busy=true; clearInterval(state.timer); disableRPS(true);
  const cpuH=['G','C','P'][Math.floor(Math.random()*3)]; const map={G:'ã‚°ãƒ¼',C:'ãƒãƒ§ã‚­',P:'ãƒ‘ãƒ¼'};
  toast(`ã‚ãªãŸã¯ ${map[h]}ã€ç›¸æ‰‹ã¯ ${map[cpuH]}ã€‚${judge(h,cpuH)>0?'ã‚ãªãŸã®æ”»æ’ƒã ã€‚':judge(h,cpuH)<0?'ç›¸æ‰‹ã®æ”»æ’ƒã ã€‚':'ã‚ã„ã“ã ã€‚'}`); await waitToasts();

  let ko=false;
  if(judge(h,cpuH)>0){
    if(await startOfAction('ally')){ const r=await doAttack(left(),right(), state.spOn && state.A.sp>=6,'ally'); ko=r.ko; if(state.spOn && state.A.sp>=6){state.A.sp=0; state.spOn=false; state.spAnnA=false;}}
  }else if(judge(h,cpuH)<0){
    if(await startOfAction('enemy')){ const r=await doAttack(right(),left(), state.B.sp>=6,'enemy'); ko=r.ko; if(state.B.sp>=6){state.B.sp=0;state.spAnnB=false;}}
  }

  addGaugeAfterAttack(ko); // KO â†’ å……é›»ãªã—
  renderSides(); buildBoxes(); updateSPBtn();
  await announceEndStatuses();
  state.busy=false; await restartRoundAfterToasts();
}

/* ===== render setup ===== */
function setupSelect(rootId,side){
  const root=$(rootId); root.innerHTML='';
  for(let i=0;i<3;i++){
    const s=document.createElement('select'); s.id=`${side}-${i}`;
    s.style.cssText='width:100%;margin:6px 0;padding:8px;border-radius:10px;border:1px solid #2b3a70;background:#0b1430;color:#eaf2ff';
    WORDS_BASE.forEach((w,idx)=>{const o=document.createElement('option');o.value=idx;o.textContent=`${w[0]} [${w[1]}/${w[2]}]`;s.append(o);});
    root.append(s);
  }
  [0,1,2].forEach(i=>$( `${side}-${i}` ).value = Math.floor(Math.random()*WORDS_BASE.length));
}
function collect(side){ return [0,1,2].map(i=> ({...makeW( Number($(`${side}-${i}`).value) ),side}) ); }

/* ===== modals ===== */
const modal=$('switchModal'),grid=$('switchGrid'),doBtn=$('swDo'),cancelBtn=$('swCancel'),swTimer=$('swTimer');let selectIdx=null,swInterval=null;
function openSwitch(){ if(left().lock>0){toast('ä»Šã¯äº¤ä»£ã§ããªã„ï¼ˆè¨€è«–çµ±åˆ¶ã®åŠ¹æœï¼‰ã€‚'); return Promise.resolve(null);} return openSwitchAuto(15,null,true); }
function openSwitchAuto(sec=15,canList=null,allowCancel=false){
  return new Promise(resolve=>{
    grid.innerHTML='';selectIdx=null;doBtn.disabled=true;modal.style.display='grid';
    const idxs=(canList??[0,1,2].filter(i=>i!==state.A.i && state.A.team[i].hp>0));
    if(!idxs.length){ swTimer.textContent='äº¤ä»£ã§ãã‚‹æ§ãˆãŒã„ãªã„ã€‚'; doBtn.disabled=true; }
    idxs.forEach(i=>{
      const u=state.A.team[i], mul=typeMult(u.type,right().type);
      const div=document.createElement('div');div.className='mini selCard';div.setAttribute('data-type',u.type);
      div.innerHTML=`<div style="font-weight:900">${u.name}</div><span class="tag">${u.type}</span><div class="bar"><span style="width:${100*u.hp/u.maxhp}%"></span></div><div>HP ${u.hp}/${u.maxhp}</div><div style="font-size:12px;margin-top:4px">ç›¸æ€§ï¼š${mul===1.5?'x1.5ï¼ˆæŠœç¾¤ï¼‰':mul===0.67?'x0.67ï¼ˆã„ã¾ã„ã¡ï¼‰':'x1.0ï¼ˆç­‰å€ï¼‰'}</div>`;
      div.addEventListener('click',()=>{document.querySelectorAll('.selCard').forEach(x=>x.classList.remove('selected'));div.classList.add('selected');selectIdx=i;doBtn.disabled=false;});
      grid.append(div);
    });
    let remain=sec; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`; clearInterval(swInterval);
    swInterval=setInterval(()=>{ if(toastBusy) return; remain--; swTimer.textContent=`è‡ªå‹•äº¤ä»£ã¾ã§ ${remain} ç§’`; if(remain<=0){clearInterval(swInterval); auto();}},1000);
    const close=i=>{modal.style.display='none';clearInterval(swInterval);resolve(i);};
    const auto=()=>{const r=idxs[Math.floor(Math.random()*idxs.length)];close(r);};
    doBtn.onclick=()=>{if(selectIdx==null)return;close(selectIdx);};
    cancelBtn.onclick=()=>{ if(allowCancel){ close(null); } else { auto(); } };
  });
}

/* ===== results ===== */
function showResult(win){
  const m=document.createElement('div'); m.style.cssText='position:fixed;inset:0;background:rgba(6,10,26,.82);display:grid;place-items:center;z-index:75';
  m.innerHTML=`<div style="background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:26px 28px;text-align:center;box-shadow:var(--shadow)">
    <h1 style="margin:0 0 8px">${win?'YOU WIN!':'YOU LOSE...'}</h1><p style="margin:4px 0 0;color:var(--muted)">3ç§’å¾Œã«ç·¨æˆã¸æˆ»ã‚‹â€¦</p></div>`;
  document.body.appendChild(m);
  setTimeout(()=>{m.remove();document.body.classList.remove('battleMode');$('battle').style.display='none';$('setup').style.display='block';},3000);
}

/* ===== bindings ===== */
function bind(){
  $('btnRand').onclick=()=>{setupSelect('teamA','A');setupSelect('teamB','B');toast('ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒãƒ¼ãƒ ã‚’ç·¨æˆã—ãŸã€‚');};
  $('btnStart').onclick=async()=>{
    // build teams
    state.A.team=collect('A'); state.B.team=collect('B'); state.A.i=0; state.B.i=0; state.A.sp=0; state.B.sp=0; state.spOn=false; state.spAnnA=false; state.spAnnB=false;
    document.body.classList.add('battleMode'); $('setup').style.display='none'; $('battle').style.display='block';
    // loading overlay until images areè§¦ã£ã¦ã‹ã‚‰
    $('loading').style.display='grid';
    preloadImgs([left().name,right().name, ...state.A.team.map(x=>x.name), ...state.B.team.map(x=>x.name)]);
    renderSides(); buildBoxes();
    await delay(400); // ç°¡æ˜“ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    $('loading').style.display='none';
    toast(`ã„ã‘ã€${left().name}ï¼ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼`); await waitToasts(); startRound(); armBGM();
  };
  $('btnG').onclick=()=>pick('G'); $('btnC').onclick=()=>pick('C'); $('btnP').onclick=()=>pick('P');
  $('btnSP').onclick=()=>{if(state.A.sp>=6 && !inputLocked){state.spOn=!state.spOn;updateSPBtn();}};
  $('btnSwitch').onclick=async()=>{ if(inputLocked) return; const i=await openSwitch(); if(i!=null){state.A.i=i; state.A.sp=0; state.spOn=false; updateSPBtn(); toast(`ã„ã‘ã€${left().name}ï¼`); await waitToasts(); renderSides(); buildBoxes(); const r=await doAttack(right(), left(), state.B.sp>=6, 'enemy'); if(state.B.sp>=6){state.B.sp=0;state.spAnnB=false;} addGaugeAfterAttack(r.ko); renderSides(); buildBoxes(); updateSPBtn(); await announceEndStatuses(); await restartRoundAfterToasts();}};
}

/* ===== init ===== */
function init(){ setupSelect('teamA','A'); setupSelect('teamB','B'); bind(); }
document.addEventListener('DOMContentLoaded',init);
})();
</script>
</body>
</html>
