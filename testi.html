<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£ Ultimate</title>
<meta name="theme-color" content="#0b0f1c">

<style>
/* === Core Variables === */
:root {
  --bg: #0b0f1c; --panel: #141b2e; --edge: #2a3555;
  --ink: #eef2ff; --muted: #94a3b8;
  --gold: #ffd700; --amber:#ffbd63; --aqua: #63ead9; --blue:#8fb1ff; --gray:#94a3b8; --bad: #ff4d4d;
  --nav-height: 64px;
  --safe-b: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  margin: 0; background: var(--bg); color: var(--ink);
  font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
  overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
}

/* === Idea H: CRT / Scanline Effects === */
.crt-overlay {
  position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
  background-size: 100% 3px, 3px 100%;
}
.vignette {
  position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
}

/* === Backgrounds === */
.bg-ambient {
  position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at 50% -20%, #1e2a4a, #0b0f1c 70%);
}
/* Idea F: Screen Shake Classes */
.shake-small { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
.shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; transform-origin: center; }
@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* === Layout === */
#app { flex: 1; position: relative; overflow: hidden; transition: transform 0.1s; }
.view {
  position: absolute; inset: 0; padding: 16px 16px calc(var(--nav-height) + var(--safe-b) + 16px);
  overflow-y: auto; scroll-behavior: smooth;
  opacity: 0; transform: scale(0.98); pointer-events: none; transition: .3s ease;
  display: flex; flex-direction: column; gap: 16px;
}
.view.active { opacity: 1; transform: scale(1); pointer-events: auto; }

/* === Header === */
header{
  flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 12px; border-bottom: 1px solid var(--edge);
  background: rgba(11, 15, 28, 0.8); backdrop-filter: blur(12px); z-index: 10;
}
.title{font-weight:900; font-size:16px; letter-spacing:1px; text-shadow: 0 0 10px rgba(99,234,217,0.3);}
.ver{font-size:9px; color:#000; background:var(--aqua); border-radius:4px; padding:2px 5px; font-weight:900}

/* === Gacha Machine (Updated for Charge) === */
.machine-container {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 280px; position: relative;
}
.core-orb {
  width: 140px; height: 140px; border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), var(--aqua) 20%, transparent 60%);
  box-shadow: 0 0 50px rgba(99,234,217,0.3), inset 0 0 20px rgba(99,234,217,0.5);
  position: relative; z-index: 2;
  transition: transform 0.1s, box-shadow 0.1s; /* For charge anim */
}
/* Charging State */
.core-orb.charging {
  animation: pulseCharge 0.1s infinite;
  box-shadow: 0 0 80px rgba(99,234,217,0.8), inset 0 0 40px rgba(255,255,255,0.8);
}
@keyframes pulseCharge { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

.orb-ring {
  position: absolute; width: 240px; height: 240px; border: 1px solid rgba(99,234,217,0.3);
  border-radius: 50%; animation: spin 20s linear infinite; z-index: 1;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Idea A: Charge Buttons */
.machine-actions { width: 100%; display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
.btn-summon {
  flex: 1; max-width: 160px; position: relative;
  background: linear-gradient(160deg, #1e293b, #0f172a);
  border: 1px solid var(--edge); border-radius: 12px; padding: 16px 12px;
  cursor: pointer; overflow: hidden; transition: transform .1s;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  user-select: none; -webkit-user-select: none;
}
.btn-summon:active { transform: scale(0.96); }
.btn-summon.single { border-color: var(--blue); }
.btn-summon.multi { border-color: var(--gold); }
.btn-label { font-size: 16px; font-weight: 900; letter-spacing: 0.5px; color: #fff; z-index: 2; pointer-events: none; }
.btn-sub { font-size: 10px; color:var(--muted); font-weight:700; z-index: 2; pointer-events: none; }

/* Charge Progress Bar inside Button */
.btn-progress {
  position: absolute; bottom: 0; left: 0; height: 100%; width: 0%;
  background: rgba(255,255,255,0.2); z-index: 1;
  transition: width 0.1s linear;
}
.btn-summon.charging .btn-progress { width: 100%; transition: width 1s linear; }

/* === Card Design (Idea D: 3D Hologram) === */
.card-stage {
  perspective: 1000px;
  display: flex; justify-content: center; align-items: center;
}
.result-card {
  width: 300px; padding: 32px 24px; border-radius: 20px;
  background: rgba(16, 24, 45, 0.95);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.1);
  text-align: center; position: relative;
  transform-style: preserve-3d; /* For 3D tilt */
  transform: scale(0.8); opacity: 0; transition: transform .1s, opacity .4s;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 0 30px rgba(0,0,0,0.4);
}
.result-card.show { transform: scale(1); opacity: 1; }

/* Holographic Overlay */
.holo-sheen {
  position: absolute; inset: 0; border-radius: 20px; pointer-events: none;
  background: linear-gradient(135deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 60%);
  background-size: 300% 300%;
  opacity: 0; mix-blend-mode: overlay; z-index: 5;
}
.result-card.S .holo-sheen, .result-card.A .holo-sheen { opacity: 1; }

.result-card.S { border: 2px solid var(--gold); box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); }
.result-card.A { border: 1px solid var(--amber); }
.result-card.B { border: 1px solid var(--aqua); }
.result-card.C { border: 1px solid var(--blue); }
.result-card.X { border: 2px solid var(--bad); }

.result-rarity { font-size: 48px; margin-bottom: 12px; transform: translateZ(30px); }
.result-word { font-size: 26px; font-weight: 900; margin: 12px 0; line-height: 1.3; transform: translateZ(20px); text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
.result-desc { font-size: 13px; color: var(--muted); line-height: 1.7; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top: 12px; transform: translateZ(10px); }

.badge {
  position: absolute; top: -6px; right: -6px;
  background: var(--bad); color: #fff; font-size: 10px; font-weight: 900;
  padding: 4px 10px; border-radius: 12px;
  box-shadow: 0 4px 10px rgba(255, 77, 77, 0.4);
  transform: rotate(10deg) translateZ(40px); z-index: 10;
  animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* === Summary List === */
.summary-container {
  width: 100%; max-width: 360px; max-height: 60vh; overflow-y: auto;
  display: flex; flex-direction: column; gap: 10px; padding: 10px;
  mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
}
.summary-card {
  display: flex; align-items: flex-start; gap: 12px;
  background: rgba(20, 27, 46, 0.9); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px; padding: 12px; text-align: left;
}
.summary-card.S { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
.s-icon { font-size: 24px; flex-shrink: 0; }
.s-content { flex: 1; }
.s-word { font-size: 14px; font-weight: 800; color: var(--ink); margin-bottom: 4px; }
.s-desc { font-size: 11px; color: var(--muted); line-height: 1.4; }

/* === Common UI === */
.btn-play {
  background: transparent; border: 1px solid var(--aqua); color: var(--aqua);
  padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: 700;
  cursor: pointer; transition: .2s;
}
.btn-play:active { background: rgba(99,234,217,0.1); transform: scale(0.95); }
.coll-item {
  aspect-ratio: 1; border: 1px solid var(--edge); border-radius: 12px;
  background: rgba(255,255,255,0.03); display: flex; flex-direction: column;
  align-items: center; justify-content: center; text-align: center; padding: 4px;
  font-size: 11px; font-weight: 700; cursor: pointer; transition: .2s;
}
.coll-item.locked { opacity: 0.3; filter: grayscale(1); }
#coll-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }

.bottom-nav {
  position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-b));
  background: rgba(11, 15, 28, 0.95); backdrop-filter: blur(16px);
  border-top: 1px solid var(--edge);
  display: grid; grid-template-columns: repeat(5, 1fr);
  padding-bottom: var(--safe-b); z-index: 100;
}
.nav-btn {
  background: none; border: none; color: var(--muted);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; font-size: 9px; font-weight: 700; cursor: pointer; transition: .2s;
}
.nav-btn.active { color: var(--ink); }
.nav-btn.active .icon { filter: grayscale(0) drop-shadow(0 0 5px var(--aqua)); transform: scale(1.1); }

/* Overlays */
#gacha-overlay {
  position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95);
  display: none; align-items: center; justify-content: center; flex-direction: column;
}
#gacha-overlay.active { display: flex; }
.summon-circle {
  width:200px; height:200px; border:2px solid var(--aqua); border-radius:50%;
  animation:spin 1.5s linear infinite; position:absolute; transition: opacity 0.3s;
}

/* Modal, Toast, Info, Ad (Standard) */
.cm-modal{position:fixed;inset:0;display:none;z-index:9998;align-items:center;justify-content:center}
.cm-modal.show{display:flex}
.cm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.cm-dialog{position:relative;width:min(85vw,400px);background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:20px;box-shadow:0 20px 60px #000;}
.cm-close{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;}
#toast {
  position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
  background: rgba(11, 15, 28, 0.95); border: 1px solid var(--aqua); padding: 10px 20px;
  border-radius: 30px; font-size: 12px; font-weight: 700; z-index: 300;
  opacity: 0; pointer-events: none; transition: .3s;
}
#toast.show { opacity: 1; top: 90px; }
.ad-float{position:fixed;right:16px;bottom:calc(var(--nav-height) + var(--safe-b) + 16px);z-index:150;width:min(90vw,300px);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.35);overflow:hidden;animation:popIn .22s ease-out both}
.ad-float img{display:block;width:100%;height:auto}
.ad-close{position:absolute; top:6px; right:6px; width:36px; height:36px; border:none; border-radius:50%; background:rgba(0,0,0,.6); color:#fff; font-weight:700; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center;}
@keyframes popIn{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}
</style>
</head>
<body>

<div class="crt-overlay"></div>
<div class="vignette"></div>
<div class="bg-ambient"></div>

<header>
  <div class="title">„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£</div>
  <div class="ver">Ultimate</div>
</header>

<div id="app">
  <section id="view-gacha" class="view active">
    <div class="machine-container">
      <div class="orb-ring"></div>
      <div class="core-orb" id="coreOrb"></div>
    </div>
    
    <div class="machine-actions">
      <button class="btn-summon single" id="btn-roll-1">
        <div class="btn-progress"></div>
        <div class="btn-label">1 pull</div>
        <div class="btn-sub">HOLD TO CHARGE</div>
      </button>
      <button class="btn-summon multi" id="btn-roll-5">
        <div class="btn-progress"></div>
        <div class="btn-label">5 pulls</div>
        <div class="btn-sub">HOLD TO CHARGE</div>
      </button>
    </div>
  </section>

  <section id="view-coll" class="view">
    <h2 style="justify-content:space-between">Âõ≥Èëë <span id="coll-stats" style="font-size:11px; color:var(--muted)"></span></h2>
    <div id="coll-grid"></div>
  </section>

  <section id="view-bgm" class="view">
    <h2>Èü≥ÈüøË®≠ÂÆö</h2>
    <div class="panel-box">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <span style="font-size:12px; font-weight:700">„Éû„Çπ„Çø„ÉºÈü≥Èáè</span>
        <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.3">
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <span style="font-size:12px; font-weight:700">BGMÂÜçÁîü</span>
        <button id="btn-bgm-toggle" class="btn-play" style="border-radius:4px;">OFF</button>
      </div>
      <div id="bgm-list"></div>
    </div>
  </section>

  <section id="view-cpu" class="view">
    <h2>„Åì„Å®„Å∞„Éê„Éà„É´</h2>
    <div class="panel-box" style="text-align:center;">
      <div style="font-size:40px; margin-bottom:10px;">‚öîÔ∏è</div>
      <h3 style="margin:0 0 10px; color:var(--aqua)">CPUÂØæÊà¶„É¢„Éº„Éâ</h3>
      <p style="font-size:12px; color:var(--muted); line-height:1.6; margin-bottom:20px;">
        Â§ñÈÉ®„Çµ„Ç§„Éà„ÄåKOTOBA BATTLE„Äç„Å∏ÁßªÂãï„Åó„Åæ„Åô„ÄÇ
      </p>
      <button class="btn-summon single" style="width:100%; max-width:200px; margin:0 auto;" onclick="window.open('https://kyoryu1039.github.io/kotoba-gacha/kotobattle')">
        <span class="btn-label">ÂØæÊà¶„ÇíÈñãÂßã</span>
      </button>
    </div>
  </section>

  <section id="view-info" class="view">
    <h2>Ë®≠ÂÆö & ÊÉÖÂ†±</h2>
    <div class="panel-box">
      <h3 style="font-size:14px; margin-top:0">„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
      <button class="btn-play" style="width:100%; border-color:var(--bad); color:var(--bad); padding:10px;" id="btn-reset">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ</button>
      <button class="btn-play" style="width:100%; margin-top:10px;" id="btn-rates">ÊéíÂá∫Áéá„ÇíË°®Á§∫</button>
    </div>
  </section>
</div>

<div class="ad-float">
  <a href="nekologia.html" target="_blank" rel="noopener">
    <img src="images/necologia_banner.jpg" alt="„Éç„Ç≥„É≠„Ç∏„Ç¢ | 9.31Áô∫Â£≤ DVD„Éª„Éñ„É´„Éº„É¨„Ç§">
  </a>
  <button class="ad-close" aria-label="Èñâ„Åò„Çã">√ó</button>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="switchTab('gacha')" id="tabGacha"><span class="icon">üîÆ</span><span>„Ç¨„ÉÅ„É£</span></button>
  <button class="nav-btn" onclick="switchTab('coll')" id="tabColl"><span class="icon">üìñ</span><span>Âõ≥Èëë</span></button>
  <button class="nav-btn" onclick="switchTab('bgm')" id="tabBgm"><span class="icon">üéµ</span><span>Èü≥Èüø</span></button>
  <button class="nav-btn" onclick="switchTab('cpu')" id="tabCpu"><span class="icon">‚öîÔ∏è</span><span>ÂØæÊà¶</span></button>
  <button class="nav-btn" onclick="switchTab('info')" id="tabInfo"><span class="icon">‚öôÔ∏è</span><span>Ë®≠ÂÆö</span></button>
</nav>

<div id="gacha-overlay">
  <div class="summon-circle"></div>
  <div id="res-container" style="z-index:10; perspective: 1000px; display:flex; flex-direction:column; align-items:center; gap:16px; width:100%"></div>
</div>

<div id="toast">Message</div>
<audio id="bgm-player" loop></audio>

<div class="cm-modal" id="cmModal" aria-hidden="true">
  <div class="cm-backdrop" id="cmBackdrop"></div>
  <div class="cm-dialog">
    <button class="cm-close" id="cmClose">√ó</button>
    <div class="cm-title" id="cmTitle" style="font-size:18px; color:var(--aqua)"></div>
    <div class="cm-text" id="cmText" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* === DATA === */
const pools={S:["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº"],A:["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","„Åù„Åº„Çç„Åî„ÅØ„Çì","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","‰πùÂìÅ‰ªè","„Åë„Çì„Å°„ÇìÊ±Å"],B:["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","„Çø„É©„É≥„ÉÅ„É•„É©","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","„Éî„É≠„É™Ëèå","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","„Ç´„É©„É°„É´Ëâ≤Á¥†"],C:["„Éê„Éì„É≠„É≥ÊçïÂõö","È≥•ÂèñÁ†Ç‰∏ò","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","Ê∏°Êù•‰∫∫","„Åï„Çã„Å≥„ÅÇ‰∏∏","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","„Éù„É™„Éó„É≠„Éî„É¨„É≥","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂"],D:["„ÇØ„Éû„É≥„Éê„ÉÅ","ÁúåÂ∫ÅÊâÄÂú®Âú∞","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","„Çπ„É´„É°„Ç§„Ç´"],X:["Êú¨Ë≥™","Ë¶ã„Åà„ÇãÂåñ","Ëá™ÂàÜ„Åî„Å®Âåñ","Ëß£ÂÉèÂ∫¶"]};
const probs={S:.02,A:.08,B:.20,C:.30,D:.30,X:.10};
const icons={S:"üåü",A:"üíé",B:"üî∑",C:"üîπ",D:"üî∏",X:"‚ùå"};
const exp={"„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"Â£∞„Å´Âá∫„Åó„Å¶Ë™≠„Åø„Åü„ÅÑÊó•Êú¨Ë™û„É©„É≥„Ç≠„É≥„Ç∞Á¨¨1‰Ωç„ÄÇ","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"Ë™∞„ÇÇ„Åå‰∫∫Áîü„Åß‰∏ÄÂ∫¶„ÅØÂ∞±‰ªª„Åó„Å¶„Åø„Åü„ÅÑÊÜß„Çå„ÅÆËÇ©Êõ∏„Åç„ÄÇ","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"Ê≤ñÁ∏Ñ„ÅÆ„Ç≠„ÉÉ„ÉÅ„É≥„Åã„ÇâÂ±ä„Åè„ÄÅÁàΩ„ÇÑ„Åã„Å™„Åè„ÇäËøî„ÅóË®ÄËëâ„ÄÇ","„Åù„Åº„Çç„Åî„ÅØ„Çì":"Âè£„ÅÆ‰∏≠„Çí‰ΩìÁèæ„Åó„Åü„Çà„ÅÜ„Å™Ë™ûÊÑü„ÄÇ","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"ÂêçÂâç„Åã„Çâ„Éì„Ç∑„Éì„Ç∑„Å®‰ºù„Çè„Å£„Å¶„Åè„ÇãÂ®ÅÂé≥„ÄÇ„Åè„Çå„Åê„Çå„ÇÇVIPÂæÖÈÅá„Åß„ÄÇ","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"ÊØõ„ÅØÁü•„Å£„Å¶„Çã„Åë„Å©„ÄÅ„ÇÄ„Åè„Åò„ÇÉ„Çâ„Å£„Å¶‰Ωï„Å™„ÅÆ„Åï„ÄÇ","‰πùÂìÅ‰ªè":"Èõ£Ë™≠Âú∞Âêç„ÅåÁπî„Çä„Å™„Åô„É™„Ç∫„É†„ÄÇ","„Åë„Çì„Å°„ÇìÊ±Å":"Èüø„Åç„Å†„Åë„Åß„ÄÅ„ÇÇ„ÅÜ„ÅÇ„Å£„Åü„Åã„ÅÑ„ÄÇ","„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"ÂØíÊ∞ó„Å®ÁÜ±Ê∞ó„ÅåÂêåÂ±Ö„Åô„ÇãÊ•µÊù±„ÅÆÂú∞„Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ","„Çø„É©„É≥„ÉÅ„É•„É©":"„Éï„Ç°„É≥„Ç∑„Éº„Å™„ÅäËèìÂ≠ê„Åø„Åü„ÅÑ„ÄÇÁåõÊØíÁ≥ª„Çπ„Ç§„Éº„ÉÑ„ÄÇ","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"ÈñìÊäú„Åë„ÅÆÈ≥•„Å´„ÅØÈñìÊäú„Åë„Å™Ë™ûÊÑü„ÄÇ","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"„Åæ„Çã„ÅßÂë™Êñá„ÄÇ","„Éî„É≠„É™Ëèå":"ÂèØÊÑõ„ÅÑ„Åµ„Çä„Åó„Å¶„Çè„Çä„Å®„ÇÑ„Çã„ÇÇ„Çì„Å†„Å≠„ÄÇ","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"ÂÆπËµ¶„Å™„ÅÑÊøÅÈü≥„Å®„Éà„ÅÆÂøúÈÖ¨„ÄÇ","„Ç´„É©„É°„É´Ëâ≤Á¥†":"„Åä„ÇÑ„Å§„ÅÆË®òÊÜ∂„Å´„É©„Éú„ÅÆÂåÇ„ÅÑ„ÄÇ","„Éê„Éì„É≠„É≥ÊçïÂõö":"„ÅÑ„Åã„Å´„ÇÇÊçï„Åæ„Å£„Åü„ÅÅ„Å£„Å¶ÊÑü„Åò„ÄÇ","È≥•ÂèñÁ†Ç‰∏ò":"ËçíÈáé„ÇíÂ≠êÈü≥„ÅåË∑≥„Å≠Âõû„Çã„ÄÇ","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"Ë®ÄËëâ„Å´Ëàê„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ","Ê∏°Êù•‰∫∫":"ÊúùÈÆÆÂçäÂ≥∂„Åã„Çâ„ÅÆÊåëÊà¶„ÄÇ","„Åï„Çã„Å≥„ÅÇ‰∏∏":"Èñì„ÅÆÊäú„Åë„ÅüÊóÖ„Å´„Å™„Çä„Åù„ÅÜ„ÄÇ","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"ÂîêËæõÂ≠ê„ÅåË∫çÂãï„Åô„ÇãÂè£ÂÜÖ„ÄÇ","„Éù„É™„Éó„É≠„Éî„É¨„É≥":"ÂçäÊøÅÈü≥„ÅÆÁéãÊßò„ÄÇ","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"„Åï„Çâ„Å£„Å®Âßã„Åæ„Å£„Åü„ÅØ„Åö„Å†„Å£„Åü„ÅÆ„Å´„ÄÇ","„ÇØ„Éû„É≥„Éê„ÉÅ":"„Äå„Çì„Äç„ÅÆÂ¶ô„ÄÇ","ÁúåÂ∫ÅÊâÄÂú®Âú∞":"Â†Ç„ÄÖ„Å®„Åó„Å¶„Çã„Çà„Å≠„ÄÇ","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"ÁîòËæõ„Éì„Éº„Éà„Å´‰πó„Å£„Å°„ÇÉ„Å£„Å¶„ÄÇ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"„Ç™„Çª„É≠„Å†„Å£„Åü„ÇâÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„ÄÇ","„Çπ„É´„É°„Ç§„Ç´":"Âôõ„ÇÅ„Å∞Âôõ„ÇÄ„Åª„Å©Âë≥„ÅåÂá∫„ÇãÂêçÂâç„ÄÇ","Êú¨Ë≥™":"„Åü„Å®„Åà„ÅÇ„Å£„Åü„Å®„Åó„Å¶„ÇÇ„ÄÅËªΩ„ÄÖ„Åó„ÅèÂè£„Å´Âá∫„Åô„Çà„ÅÜ„Å™‰∫∫„ÅØ‰∏ÄÁîüËøë„Å•„Åë„Å™„ÅÑ„Å®ÊÄù„ÅÜ„Çì„Åß„Åô„ÄÇ","Ë¶ã„Åà„ÇãÂåñ":"ÂèØË¶ñÂåñ„Å£„Å¶Áü•„Å£„Å¶„Åæ„Åô„Åã„ÄÇ","Ëá™ÂàÜ„Åî„Å®Âåñ":"„ÄåËá™ÂàÜ„Åî„Å®„Äç„Åß„ÇÇÂ´å„Å™„ÅÆ„Å´„ÄÅ„ÄåÂåñ„Äç„Åæ„Åß„Å§„Åë„Çâ„Çå„ÅüÊó•„Å´„ÅØ‚Ä¶","Ëß£ÂÉèÂ∫¶":"„Å™„Çã„Åª„Å©„ÄÅ„Éî„ÇØ„Çª„É´Êï∞„ÅåÈ´ò„Åæ„Çä„Åæ„Åó„ÅüÔºÅ"};

const storeSeen="kotoba_collection_seen_v4_7";
const storeBGM="kotoba_bgm_selected_v4_7";
const seen=new Set(JSON.parse(localStorage.getItem(storeSeen)||"[]"));
let selectedBGM=localStorage.getItem(storeBGM)||"default";
const tiers=["S","A","B","C","D","X"];

/* === AUDIO SYSTEM (Enhanced) === */
const bgmPlayer=document.getElementById('bgm-player');
const bgmBtn=document.getElementById('btn-bgm-toggle');
const volSlider=document.getElementById('vol-slider');
let isBgmOn=false;

bgmPlayer.volume=parseFloat(volSlider.value);
volSlider.addEventListener('input',()=>bgmPlayer.volume=parseFloat(volSlider.value));
bgmBtn.onclick=()=>{
  isBgmOn=!isBgmOn;
  bgmBtn.textContent=isBgmOn?"ON":"OFF";
  bgmBtn.style.borderColor=isBgmOn?"var(--aqua)":"var(--edge)";
  bgmBtn.style.color=isBgmOn?"var(--aqua)":"var(--muted)";
  if(isBgmOn){bgmPlayer.play().catch(()=>{});}else{bgmPlayer.pause();}
};

let audioCtx=null;
function getCtx(){if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==="suspended")audioCtx.resume();return audioCtx;}
function tone(f,d,t='triangle'){const c=getCtx();if(!c)return;const o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.05,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+d);o.start();o.stop(c.currentTime+d+0.05);}

// Charge Sound (Rising Pitch)
let chargeOsc=null, chargeGain=null;
function startChargeSound(){
  const c=getCtx(); if(!c)return;
  chargeOsc=c.createOscillator(); chargeGain=c.createGain();
  chargeOsc.type='sawtooth'; chargeOsc.frequency.setValueAtTime(100,c.currentTime);
  chargeOsc.frequency.exponentialRampToValueAtTime(800,c.currentTime+1); // Rise
  chargeGain.gain.setValueAtTime(0.05,c.currentTime);
  chargeOsc.connect(chargeGain); chargeGain.connect(c.destination);
  chargeOsc.start();
}
function stopChargeSound(){
  if(chargeOsc){
    const c=getCtx();
    chargeGain.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.1);
    chargeOsc.stop(c.currentTime+0.1); chargeOsc=null;
  }
}

function sfxTap(){tone(800,0.05);}
function sfxRare(){tone(600,0.1,'sine');setTimeout(()=>tone(1200,0.3,'square'),100);}
function sfxGlitch(){tone(100,0.1,'sawtooth');setTimeout(()=>tone(50,0.1,'sawtooth'),100);}

/* === CHARGE LOGIC (Idea A) === */
function setupChargeBtn(id, count){
  const btn = document.getElementById(id);
  let timer = null;
  
  const start = (e) => {
    e.preventDefault();
    if(overlay.classList.contains('active')) return;
    btn.classList.add('charging');
    document.getElementById('coreOrb').classList.add('charging'); // Idea A: Orb reaction
    startChargeSound();
    
    // Idea F: Mild haptic
    if(navigator.vibrate) navigator.vibrate(50);

    timer = setTimeout(() => {
      // CHARGE COMPLETE
      stopChargeSound();
      btn.classList.remove('charging');
      document.getElementById('coreOrb').classList.remove('charging');
      roll(count); // Fire!
    }, 1000); // 1s charge time
  };

  const cancel = (e) => {
    if(timer){
      clearTimeout(timer); timer=null;
      btn.classList.remove('charging');
      document.getElementById('coreOrb').classList.remove('charging');
      stopChargeSound();
    }
  };

  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchstart', start);
  btn.addEventListener('mouseup', cancel);
  btn.addEventListener('mouseleave', cancel);
  btn.addEventListener('touchend', cancel);
}

setupChargeBtn('btn-roll-1', 1);
setupChargeBtn('btn-roll-5', 5);

/* === GAME LOGIC === */
function switchTab(id){
  document.querySelectorAll('.view').forEach(v=>{v.classList.remove('active');});
  const target = document.getElementById(`view-${id}`);
  target.classList.add('active'); target.scrollTop = 0;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const btnId = 'tab'+id.charAt(0).toUpperCase()+id.slice(1);
  const btn = document.getElementById(btnId);
  if(btn) btn.classList.add('active');
  sfxTap();
  if(id==='coll') renderCollection();
  if(id==='bgm') renderBGMList();
}

const overlay=document.getElementById('gacha-overlay');
const resCont=document.getElementById('res-container');
const summonCircle = document.querySelector('.summon-circle');

function pickTier(){const r=Math.random();let a=0;for(const k of tiers){a+=probs[k];if(r<a)return k;}return "D";}
function pickWord(t){const a=pools[t];return a[Math.floor(Math.random()*a.length)];}

// Idea F: Shake function
function shakeScreen(hard=false){
  const app = document.getElementById('app');
  app.classList.remove('shake-small','shake-hard');
  void app.offsetWidth; // trigger reflow
  app.classList.add(hard ? 'shake-hard' : 'shake-small');
  if(navigator.vibrate) navigator.vibrate(hard ? 200 : 50);
}

async function roll(count){
  if(isBgmOn && bgmPlayer.paused) bgmPlayer.play().catch(()=>{});
  
  shakeScreen(true); // Fire Shake!
  overlay.classList.add('active'); resCont.innerHTML="";
  summonCircle.style.display = 'block';

  const waitRoll = count > 1 ? 200 : 600;
  const waitShow = count > 1 ? 800 : 1400;

  try {
    const results = [];
    for(let i=0;i<count;i++){
      await new Promise(r=>setTimeout(r, waitRoll)); 
      try { tone(200+i*50,0.1,'square'); } catch(e){}
      
      const t=pickTier();
      const w=pickWord(t);
      const isNew=!seen.has(w);
      if(isNew){ seen.add(w); localStorage.setItem(storeSeen,JSON.stringify([...seen])); }
      results.push({t, w, isNew});
      
      // Render Card
      const cardWrap = document.createElement('div');
      cardWrap.className = 'card-stage';
      const card=document.createElement('div');
      card.className=`result-card ${t}`;
      if(t==='X') document.body.classList.add('glitch-mode');
      
      // Idea D: Holographic Sheen added
      card.innerHTML=`<div class="holo-sheen"></div><div class="result-rarity">${icons[t]}</div><div class="result-word">${w}</div><div class="result-desc">${exp[w]||""}</div>${isNew?'<div class="badge">NEW</div>':''}`;
      
      // Idea D: 3D Tilt Effect for Single view
      if(t==='S' || t==='A') {
        document.addEventListener('mousemove', (e) => tiltCard(e, card));
        if(window.DeviceOrientationEvent) window.addEventListener('deviceorientation', (e) => tiltCardMobile(e, card));
      }

      cardWrap.appendChild(card);
      resCont.innerHTML=""; resCont.appendChild(cardWrap);
      
      if(t==='S'){ try{sfxRare(); confetti(); shakeScreen(true);}catch(e){} }
      else if(t==='X'){ try{sfxGlitch();}catch(e){} }
      else { try{sfxTap();}catch(e){} }
      
      setTimeout(()=>card.classList.add('show'),50);
      tryUnlock(t);
      
      await new Promise(r=>setTimeout(r, waitShow));
      document.body.classList.remove('glitch-mode');
    }

    if (count === 1) {
      await new Promise(r=>setTimeout(r, 1000));
      closeOverlay();
    } else {
      summonCircle.style.display = 'none';
      resCont.innerHTML = `
        <h3 style="margin-bottom:10px; color:var(--aqua)">RESULTS</h3>
        <div class="summary-container"></div>
        <div class="result-card show" style="background:none;box-shadow:none;border:none;padding:0; margin-top:10px;">
          <button class="btn-summon single" onclick="closeOverlay()"><div class="btn-label">Èñâ„Åò„Çã</div></button>
        </div>
      `;
      const grid = resCont.querySelector('.summary-container');
      results.forEach(r => {
        const d = document.createElement('div');
        d.className = `summary-card ${r.t}`;
        d.innerHTML = `
          <div class="s-icon">${icons[r.t]}</div>
          <div class="s-content"><div class="s-word">${r.w}</div><div class="s-desc">${exp[r.w] || ""}</div></div>
          ${r.isNew ? '<div class="badge" style="top:-4px;right:-4px;font-size:9px;">NEW</div>' : ''}
        `;
        grid.appendChild(d);
      });
    }

  } catch(e) {
    console.error(e);
    closeOverlay();
  }
}

// Idea D: Tilt Logic
function tiltCard(e, card) {
  const rect = card.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const cx = rect.width / 2;
  const cy = rect.height / 2;
  const dx = (x - cx) / cx;
  const dy = (y - cy) / cy;
  card.style.transform = `scale(1) rotateY(${dx * 15}deg) rotateX(${-dy * 15}deg)`;
  const sheen = card.querySelector('.holo-sheen');
  if(sheen) sheen.style.backgroundPosition = `${50 + (dx * 50)}% ${50 + (dy * 50)}%`;
}
function tiltCardMobile(e, card) {
  const dx = e.gamma / 45; // Tilt left/right
  const dy = e.beta / 45;  // Tilt up/down
  card.style.transform = `scale(1) rotateY(${dx * 15}deg) rotateX(${-dy * 15}deg)`;
}

function closeOverlay(){ overlay.classList.remove('active'); sfxTap(); }

function confetti(){
  const colors=['#ffd700','#63ead9','#ff4d4d'];
  for(let i=0;i<30;i++){
    const s=document.createElement('div'); s.className='shard';
    s.style.background=colors[Math.floor(Math.random()*3)];
    s.style.left=Math.random()*100+'%'; s.style.top='-10px';
    s.style.animationDuration=(1+Math.random())+'s';
    s.addEventListener('animationend', () => s.remove());
    overlay.appendChild(s);
  }
}

function renderCollection(){
  const grid=document.getElementById('coll-grid'); grid.innerHTML="";
  let total=0, have=0;
  tiers.forEach(t=>{
    pools[t].forEach(w=>{
      total++; if(seen.has(w)) have++;
      const el=document.createElement('div');
      const known=seen.has(w);
      el.className=`coll-item ${known?'':'locked'}`;
      el.innerHTML=`<div style="color:${known?'var(--aqua)':'inherit'}">${icons[t]}</div><div>${known?w:'???'}</div>`;
      if(known) el.onclick=()=>showModal(w, exp[w]);
      grid.appendChild(el);
    });
  });
  document.getElementById('coll-stats').textContent=`${have}/${total}`;
}

function hasTier(t){return pools[t].every(w=>seen.has(w));}
function getTracks(){
  return [
    {id:"default",name:"„Éí„Éó„Éä„Ç¥„Ç∏„Ç¢Èü≥È†≠",ul:true,src:"audio/Hypnagogiaondo.mp3"},
    {id:"kingyobachi",name:"ÈáëÈ≠öÈâ¢",ul:hasTier("S"),src:"audio/Kingyobachi.mp3",hint:"S„Ç≥„É≥„Éó"},
    {id:"kuganebutsu",name:"‰πùÂìÅ‰ªèÂ•áË≠ö",ul:hasTier("A"),src:"audio/Kuhonbutsukitan.mp3",hint:"A„Ç≥„É≥„Éó"},
    {id:"necology",name:"„Éç„Ç≥„É≠„Ç∏„Ç¢",ul:hasTier("B"),src:"audio/Nekologia.mp3",hint:"B„Ç≥„É≥„Éó"},
    {id:"chorus",name:"ÈáëÈ≠öÈâ¢(ÂêàÂî±)",ul:tiers.every(t=>hasTier(t)),src:"audio/Kingyobachi_chorus.mp3",hint:"ÂÖ®„Ç≥„É≥„Éó"}
  ];
}
function renderBGMList(){
  const list=document.getElementById('bgm-list'); list.innerHTML="";
  getTracks().forEach(t=>{
    const d=document.createElement('div'); d.className='track-row';
    d.innerHTML=`
      <div class="track-info">
        <div class="track-name" style="color:${t.ul?'var(--ink)':'var(--muted)'}">${t.ul?t.name:'ÔºüÔºüÔºü'}</div>
        <div class="track-status">${t.ul?'Ëß£ÊîæÊ∏à':t.hint+'„ÅßËß£Êîæ'}</div>
      </div>
      <button class="btn-play" ${t.ul?'':'disabled'}>${selectedBGM===t.id?'ÂÜçÁîü‰∏≠':'ÂÜçÁîü'}</button>
    `;
    if(t.ul){
      d.querySelector('button').onclick=()=>{
        selectedBGM=t.id; localStorage.setItem(storeBGM,t.id);
        bgmPlayer.src=t.src; if(isBgmOn) bgmPlayer.play();
        renderBGMList();
      };
    }
    list.appendChild(d);
  });
}

const unlockedState={S:false,A:false,B:false};
function tryUnlock(t){
  if(["S","A","B"].includes(t) && hasTier(t) && !unlockedState[t]){
    unlockedState[t]=true;
    showToast(`Rank ${t} „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅBGMËß£Êîæ`);
  }
}

const toast=document.getElementById('toast');
function showToast(msg){
  toast.textContent=msg; toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),3000);
}

const modal=document.getElementById('cmModal');
function showModal(title, text){
  document.getElementById('cmTitle').textContent=title;
  document.getElementById('cmText').textContent=text||"";
  modal.classList.add('show');
}
document.getElementById('cmClose').onclick=()=>modal.classList.remove('show');
document.getElementById('cmBackdrop').onclick=()=>modal.classList.remove('show');

document.querySelector('.ad-close')?.addEventListener('click',()=>{
  document.querySelector('.ad-float')?.remove();
});

document.getElementById('btn-reset').onclick=()=>{
  if(confirm('Êú¨ÂΩì„Å´„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü')) {
    seen.clear(); localStorage.setItem(storeSeen,"[]"); location.reload();
  }
};
document.getElementById('btn-rates').onclick=()=>{
  alert("ÊéíÂá∫Áéá:\nS:2% A:8% B:20% C:30% D:30% X:10%");
};

const savedTrack = getTracks().find(t=>t.id===selectedBGM);
if(savedTrack) bgmPlayer.src = savedTrack.src;
</script>
</body>
</html>
