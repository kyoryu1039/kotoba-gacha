<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£ Ultimate v18</title>
<meta name="theme-color" content="#0b0f1c">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/* === Core Variables === */
:root {
  --bg: #0b0f1c; --panel: #141b2e; --edge: #2a3555;
  --ink: #eef2ff; --muted: #94a3b8;
  --gold: #ffd700; --amber:#ffbd63; --aqua: #63ead9; --blue:#8fb1ff; --gray:#94a3b8; --bad: #ff4d4d;
  --spotify: #1DB954;
  --nav-height: 64px;
  --header-height: 50px;
  --safe-b: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  margin: 0; background: var(--bg); color: var(--ink);
  font-family: "Zen Kaku Gothic New", sans-serif;
  overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
}

/* === Visual Effects === */
.crt-overlay {
  position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
  background-size: 100% 3px, 3px 100%;
}
.vignette {
  position: fixed; inset: 0; pointer-events: none; z-index: 999;
  background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
}
.bg-ambient {
  position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at 50% -20%, #1e2a4a, #0b0f1c 70%);
}
.shake-small { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
.shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; transform-origin: center; }
@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* === Layout === */
#app { flex: 1; position: relative; overflow: hidden; transition: transform 0.1s; }
.view {
  position: absolute; inset: 0; padding: 16px 16px calc(var(--nav-height) + var(--safe-b) + 16px);
  overflow-y: auto; scroll-behavior: smooth;
  opacity: 0; transform: scale(0.98); pointer-events: none; transition: .3s ease;
  display: flex; flex-direction: column; gap: 16px;
}
.view.active { opacity: 1; transform: scale(1); pointer-events: auto; }

header{
  height: var(--header-height);
  flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 0 12px; border-bottom: 1px solid var(--edge);
  background: rgba(11, 15, 28, 0.8); backdrop-filter: blur(12px); z-index: 10;
}
.title{font-weight:900; font-size:16px; letter-spacing:1px; text-shadow: 0 0 10px rgba(99,234,217,0.3);}
.ver{font-size:9px; color:#000; background:var(--aqua); border-radius:4px; padding:2px 5px; font-weight:900}

/* === Gacha Machine === */
.machine-container {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 280px; position: relative; padding-top: 20px; 
}
.core-orb {
  width: 140px; height: 140px; border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), var(--aqua) 20%, transparent 60%);
  box-shadow: 0 0 50px rgba(99,234,217,0.3), inset 0 0 20px rgba(99,234,217,0.5);
  position: relative; z-index: 2; transition: transform 0.1s, box-shadow 0.1s;
}
.core-orb.charging {
  animation: pulseCharge 0.1s infinite;
  box-shadow: 0 0 80px rgba(99,234,217,0.8), inset 0 0 40px rgba(255,255,255,0.8);
}
@keyframes pulseCharge { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

.orb-ring {
  position: absolute; width: 240px; height: 240px; border: 1px solid rgba(99,234,217,0.3);
  border-radius: 50%; animation: spin 20s linear infinite; z-index: 1;
}
@keyframes spin { to { transform: rotate(360deg); } }

.machine-actions { width: 100%; display: flex; justify-content: center; gap: 16px; margin-top: 24px; padding-bottom: 20px; }
.btn-summon {
  flex: 1; max-width: 160px; position: relative;
  background: linear-gradient(160deg, #1e293b, #0f172a);
  border: 1px solid var(--edge); border-radius: 12px; padding: 16px 12px;
  cursor: pointer; overflow: hidden; transition: transform .1s;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  user-select: none; -webkit-user-select: none;
}
.btn-summon:active { transform: scale(0.96); }
.btn-summon.single { border-color: var(--blue); }
.btn-summon.multi { border-color: var(--gold); }
.btn-label { font-size: 16px; font-weight: 900; letter-spacing: 0.5px; color: #fff; z-index: 2; pointer-events: none; }
.btn-sub { font-size: 10px; color:var(--muted); font-weight:700; z-index: 2; pointer-events: none; }
.btn-progress {
  position: absolute; bottom: 0; left: 0; height: 100%; width: 0%;
  background: rgba(255,255,255,0.2); z-index: 1; transition: width 0.1s linear;
}
.btn-summon.charging .btn-progress { width: 100%; transition: width 1s linear; }

/* === Card Design === */
.card-stage {
  perspective: 1000px; display: flex; justify-content: center; align-items: center;
  width: 300px; height: 420px; position: relative;
}
.result-card {
  width: 100%; height: 100%; padding: 24px 20px; border-radius: 20px;
  background: rgba(16, 24, 45, 0.95); backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.1); text-align: center; position: relative;
  transform-style: preserve-3d; transform: scale(0.8); opacity: 0; transition: opacity .4s;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 0 30px rgba(0,0,0,0.4);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
}
.result-card.show { transform: scale(1); opacity: 1; }
.holo-sheen {
  position: absolute; inset: 0; border-radius: 20px; pointer-events: none;
  background: linear-gradient(135deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 60%);
  background-size: 300% 300%; opacity: 0; mix-blend-mode: overlay; z-index: 5;
}
.result-card.S .holo-sheen, .result-card.A .holo-sheen { opacity: 1; }
.result-card.S { border: 2px solid var(--gold); box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); }
.result-card.A { border: 1px solid var(--amber); }
.result-card.B { border: 1px solid var(--aqua); }
.result-card.C { border: 1px solid var(--blue); }
.result-card.X { border: 2px solid var(--bad); }

/* Images */
.result-img-container {
  width: 160px; height: 160px; margin-bottom: 16px; position: relative;
  transform: translateZ(30px);
  display: flex; align-items: center; justify-content: center;
}
.result-img {
  max-width: 100%; max-height: 100%; object-fit: contain;
  filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5));
}
.result-rarity { font-size: 48px; margin-bottom: 12px; transform: translateZ(30px); }
.result-word { font-size: 24px; font-weight: 900; margin: 8px 0; line-height: 1.3; transform: translateZ(20px); text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
.result-desc { font-size: 13px; color: var(--muted); line-height: 1.7; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top: 8px; transform: translateZ(10px); }
.badge {
  position: absolute; top: -6px; right: -6px;
  background: var(--bad); color: #fff; font-size: 10px; font-weight: 900;
  padding: 4px 10px; border-radius: 12px;
  box-shadow: 0 4px 10px rgba(255, 77, 77, 0.4);
  transform: rotate(10deg) translateZ(40px); z-index: 10;
  animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* === Summary List === */
.summary-container {
  width: 100%; max-width: 360px; max-height: 55vh; overflow-y: auto;
  display: flex; flex-direction: column; gap: 10px; padding: 10px;
  mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
}
.summary-card {
  display: flex; align-items: center; gap: 12px;
  background: rgba(20, 27, 46, 0.9); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px; padding: 10px; text-align: left;
}
.summary-card.S { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); }
.s-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.s-img { max-width: 100%; max-height: 100%; object-fit: contain; }
.s-content { flex: 1; }
.s-word { font-size: 13px; font-weight: 800; color: var(--ink); margin-bottom: 2px; }
.s-desc { font-size: 10px; color: var(--muted); line-height: 1.4; }

/* === Collection View === */
.coll-total-box {
  background: var(--panel); border: 1px solid var(--edge); border-radius: 12px;
  padding: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
}
.coll-total-label { font-size: 12px; color: var(--muted); font-weight: 700; }
.coll-total-val { font-size: 20px; color: var(--ink); font-weight: 900; }

.tier-section { margin-bottom: 24px; }
.tier-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 6px; 
}
.tier-title { font-size: 16px; font-weight: 900; display:flex; align-items:center; gap:6px; }
.tier-counts { font-size: 12px; font-weight: 700; color: var(--muted); }

.tier-progress-track {
  height: 4px; width: 100%; background: rgba(255,255,255,0.1);
  border-radius: 2px; margin-bottom: 12px; overflow: hidden;
}
.tier-progress-fill {
  height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.tier-reward {
  font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 12px;
  background: rgba(255,255,255,0.05); color: var(--muted);
  display: flex; align-items: center; gap: 4px; transition: .2s; margin-right: 8px;
}
.tier-reward.unlocked {
  background: rgba(99, 234, 217, 0.15); color: var(--aqua); border: 1px solid var(--aqua);
  box-shadow: 0 0 10px rgba(99,234,217,0.2); cursor: pointer;
}
.tier-reward.unlocked:active { transform: scale(0.95); background: rgba(99, 234, 217, 0.3); }

/* === FIXED: Collection Item Layout (Issue 1) === */
.coll-item {
  aspect-ratio: 0.8; /* Changed from 1 to 0.8 (Taller) */
  border: 1px solid var(--edge); border-radius: 12px;
  background: rgba(255,255,255,0.03); 
  display: flex; flex-direction: column; justify-content: space-between; /* Distribute */
  text-align: center; padding: 6px;
  cursor: pointer; transition: .2s; position: relative; overflow: hidden;
}
.coll-item-img-box {
  height: 65%; width: 100%; /* Fixed height percentage */
  display: flex; align-items: center; justify-content: center;
}
.coll-img { 
  max-width: 100%; max-height: 100%; 
  object-fit: contain; transition: .2s; 
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); 
}
.coll-item.locked .coll-img { display: none; }
.coll-icon-locked { font-size: 24px; opacity: 0.3; }

.coll-item-name {
  height: 35%; width: 100%; /* Remaining space for text */
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; line-height: 1.2; 
  overflow: hidden; word-break: break-all;
  color: var(--ink);
}
.coll-item.locked .coll-item-name { color: var(--muted); }

.coll-grid-tier { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }

/* Tier Colors */
.tier-S .tier-title { color: var(--gold); }
.tier-S .tier-progress-fill { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
.tier-S .coll-item { border-color: rgba(255,215,0,0.3); }
.tier-A .tier-title { color: var(--amber); }
.tier-A .tier-progress-fill { background: var(--amber); box-shadow: 0 0 10px var(--amber); }
.tier-A .coll-item { border-color: rgba(255,189,99,0.3); }
.tier-B .tier-title { color: var(--aqua); }
.tier-B .tier-progress-fill { background: var(--aqua); box-shadow: 0 0 10px var(--aqua); }
.tier-B .coll-item { border-color: rgba(99,234,217,0.3); }
.tier-X .tier-title { color: var(--bad); }
.tier-X .tier-progress-fill { background: var(--bad); box-shadow: 0 0 10px var(--bad); }
.tier-X .coll-item { border-color: rgba(255,77,77,0.3); }
.tier-C .tier-progress-fill, .tier-D .tier-progress-fill { background: var(--blue); }

/* === CPU Battle Mode Styles === */
.cyber-grid {
  position: absolute; inset: -50%; width: 200%; height: 200%;
  background-image: 
    linear-gradient(transparent 0%, var(--bg) 100%),
    linear-gradient(0deg, rgba(99,234,217,0.2) 1px, transparent 1px),
    linear-gradient(90deg, rgba(99,234,217,0.2) 1px, transparent 1px);
  background-size: 40px 40px;
  transform: perspective(500px) rotateX(60deg);
  animation: gridMove 1s linear infinite;
  z-index: -1; pointer-events: none; opacity: 0.5;
}
@keyframes gridMove {
  0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
  100% { transform: perspective(500px) rotateX(60deg) translateY(40px); }
}

.cpu-interface {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center; text-align: center;
  position: relative; z-index: 2; padding-bottom: 40px;
}

.cpu-status {
  font-size: 10px; letter-spacing: 4px; color: var(--aqua); opacity: 0.7;
  margin-bottom: 12px; text-shadow: 0 0 10px rgba(99,234,217,0.5);
  animation: blink 2s infinite;
}

.cpu-main-text {
  font-size: 32px; font-weight: 900; color: #fff;
  letter-spacing: 2px; margin-bottom: 60px;
  text-shadow: 0 0 20px rgba(255,255,255,0.2);
}

.btn-battle-large {
  background: transparent; border: 2px solid var(--aqua);
  color: var(--aqua); padding: 16px 60px;
  border-radius: 4px; cursor: pointer; position: relative;
  transition: .3s cubic-bezier(0.25, 1, 0.5, 1);
  overflow: hidden;
}
.btn-battle-large .label {
  font-size: 18px; font-weight: 900; letter-spacing: 4px; position: relative; z-index: 2;
}
.btn-battle-large::before {
  content: ""; position: absolute; inset: 0; background: var(--aqua);
  transform: scaleX(0); transform-origin: left; transition: transform .3s ease; z-index: 1;
}
.btn-battle-large:active { transform: scale(0.95); }
.btn-battle-large:active::before { transform: scaleX(1); }
.btn-battle-large:active .label { color: var(--bg); }

.btn-battle-large { animation: pulseAqua 3s infinite; }
@keyframes pulseAqua {
  0% { box-shadow: 0 0 0 0 rgba(99, 234, 217, 0.4); }
  70% { box-shadow: 0 0 0 15px rgba(99, 234, 217, 0); }
  100% { box-shadow: 0 0 0 0 rgba(99, 234, 217, 0); }
}

.cpu-footer-text {
  position: absolute; bottom: 40px; width: 100%; text-align: center;
  font-size: 10px; color: var(--muted); opacity: 0.5; letter-spacing: 1px;
}

/* === Common UI === */
.btn-play {
  background: transparent; border: 1px solid var(--aqua); color: var(--aqua);
  padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: 700;
  cursor: pointer; transition: .2s; display:flex; align-items:center; gap:6px;
}
.btn-play:active { background: rgba(99,234,217,0.1); transform: scale(0.95); }

.btn-spotify {
  background: rgba(29, 185, 84, 0.1); border: 1px solid var(--spotify); color: var(--spotify);
  width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-size: 16px; cursor: pointer; transition: .2s; text-decoration: none;
}
.btn-spotify:hover { background: var(--spotify); color: #fff; box-shadow: 0 0 10px rgba(29, 185, 84, 0.4); }
.btn-spotify svg { width: 16px; height: 16px; fill: currentColor; }

/* === Navigation === */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-b));
  background: rgba(11, 15, 28, 0.95); backdrop-filter: blur(16px);
  border-top: 1px solid var(--edge);
  display: grid; grid-template-columns: repeat(5, 1fr);
  padding-bottom: var(--safe-b); z-index: 100;
  position: relative;
}
.nav-btn {
  background: none; border: none; color: var(--muted);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; font-size: 9px; font-weight: 700; cursor: pointer; transition: .2s; z-index: 2;
}
.nav-btn.active { color: var(--ink); }
.nav-btn.active .icon { filter: grayscale(0) drop-shadow(0 0 5px var(--aqua)); transform: scale(1.1); }
#nav-indicator {
  position: absolute; top: 0; left: 0; width: 20%; height: 100%;
  background: radial-gradient(circle at 50% 0%, rgba(99, 234, 217, 0.15), transparent 70%);
  border-top: 2px solid var(--aqua);
  transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1); pointer-events: none; z-index: 1;
}

/* === Overlays === */
#gacha-overlay {
  position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.95);
  display: none; align-items: center; justify-content: center; flex-direction: column;
}
#gacha-overlay.active { display: flex; }
.summon-circle {
  width:200px; height:200px; border:2px solid var(--aqua); border-radius:50%;
  animation:spin 1.5s linear infinite; position:absolute; transition: opacity 0.3s;
}

#full-ad-overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.4s ease;
}
#full-ad-overlay.active { display: flex; }
#full-ad-overlay img {
  width: 100%; max-width: 400px; height: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.8); border-top: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* === Modal Design === */
.cm-modal{position:fixed;inset:0;display:none;z-index:9998;align-items:center;justify-content:center}
.cm-modal.show{display:flex}
.cm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}

.cm-dialog {
  position:relative; width:min(85vw,400px);
  background: rgba(20, 27, 46, 0.95);
  border: 1px solid var(--target-color, var(--aqua));
  border-radius: 4px; padding: 24px;
  box-shadow: 0 0 30px rgba(99, 234, 217, 0.15);
  background-image: 
    linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
  background-size: 20px 20px;
  display: flex; flex-direction: column; align-items: center;
}
.cm-dialog::before, .cm-dialog::after {
  content:""; position:absolute; width:20px; height:20px; border-color: var(--target-color, var(--aqua));
}
.cm-dialog::before { top:-1px; left:-1px; border-top:2px solid; border-left:2px solid; }
.cm-dialog::after { bottom:-1px; right:-1px; border-bottom:2px solid; border-right:2px solid; }

.cm-close { position:absolute; top:10px; right:10px; background:none; border:none; color:var(--target-color, var(--aqua)); font-size:20px; cursor:pointer; }
.cm-title {
  font-size: 20px; font-weight: 900; color: var(--target-color, var(--aqua));
  border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 12px;
  text-shadow: 0 0 8px rgba(0,0,0,0.5); width: 100%; text-align: left;
}
.cm-img { max-width: 120px; max-height: 120px; object-fit: contain; margin: 10px 0; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }
.cm-text { width: 100%; margin-top: 10px; font-size: 14px; line-height: 1.8; color: #eef2ff; min-height: 40px; text-align: left; }
.cursor::after { content: "|"; animation: blink 1s step-start infinite; color: var(--target-color, var(--aqua)); }
@keyframes blink { 50% { opacity: 0; } }

/* Toast */
#toast {
  position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
  background: rgba(11, 15, 28, 0.95); border: 1px solid var(--aqua); padding: 10px 20px;
  border-radius: 30px; font-size: 12px; font-weight: 700; z-index: 300;
  opacity: 0; pointer-events: none; transition: .3s;
}
#toast.show { opacity: 1; top: 90px; }

/* Info Styles */
.infoLead{font-weight:900;font-size:16px;margin:6px 0 10px; color:var(--aqua)}
.infoGrid{display:grid; gap:12px; }
.infoBox{ border:1px solid var(--edge); border-radius:12px; padding:16px; background: rgba(255,255,255,0.03); }
.infoBox h3{margin:0 0 8px; font-size:14px; color:var(--ink); font-weight: 800;}
.infoSmall{color: #cbd5e1; font-size:12px; line-height:1.7;}

/* Accordion for Special Thanks */
details.infoBox { cursor: pointer; transition: background .2s; }
details.infoBox:hover { background: rgba(255,255,255,0.05); }
summary { font-size: 14px; font-weight: 800; color: var(--ink); outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center; }
summary::-webkit-details-marker { display: none; }
summary::after { content: "+"; font-weight: 900; color: var(--aqua); margin-left: 10px; transition: .3s; }
details[open] summary::after { transform: rotate(45deg); color: var(--bad); }
details[open] summary { margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }

/* BGM List */
.track-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.track-row:last-child { border-bottom: none; }
.track-info { display: flex; flex-direction: column; gap: 4px; }
.track-name { font-size: 14px; font-weight: 700; transition: color .2s; }
.track-status { font-size: 10px; color: var(--muted); }
</style>
</head>
<body>

<div class="crt-overlay"></div>
<div class="vignette"></div>
<div class="bg-ambient"></div>

<header>
  <div class="title">„Åì„Å®„Å∞„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Ç¨„ÉÅ„É£</div>
  <div class="ver">Ultimate</div>
</header>

<div id="app">
  <section id="view-gacha" class="view active">
    <div class="machine-container">
      <div class="orb-ring"></div>
      <div class="core-orb" id="coreOrb"></div>
    </div>
    
    <div class="machine-actions">
      <button class="btn-summon single" id="btn-roll-1">
        <div class="btn-progress"></div>
        <div class="btn-label">1 pull</div>
        <div class="btn-sub">HOLD TO CHARGE</div>
      </button>
      <button class="btn-summon multi" id="btn-roll-5">
        <div class="btn-progress"></div>
        <div class="btn-label">5 pulls</div>
        <div class="btn-sub">HOLD TO CHARGE</div>
      </button>
    </div>
  </section>

  <section id="view-coll" class="view">
    <div class="coll-total-box">
      <div class="coll-total-label">TOTAL COLLECTION</div>
      <div class="coll-total-val" id="coll-total-val">0 / 0</div>
    </div>
    <div id="coll-container"></div>
  </section>

  <section id="view-bgm" class="view">
    <h2>BGM</h2>
    <div class="panel-box">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <span style="font-size:12px; font-weight:700">„Éû„Çπ„Çø„ÉºÈü≥Èáè</span>
        <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.3">
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <span style="font-size:12px; font-weight:700">BGMÂÜçÁîü</span>
        <button id="btn-bgm-toggle" class="btn-play" style="border-radius:4px;">OFF</button>
      </div>
      <div id="bgm-list"></div>
    </div>
  </section>

  <section id="view-cpu" class="view">
    <div class="cyber-grid"></div>
    <div class="cpu-interface">
      <div class="cpu-status">CONNECTION ESTABLISHED</div>
      <div class="cpu-main-text">KOTOBA BATTLE</div>
      <button class="btn-battle-large" onclick="window.open('https://kyoryu1039.github.io/kotoba-gacha/kotobattle')">
        <span class="label">START</span>
      </button>
      <div class="cpu-footer-text">Make Sense Out of Nonsense</div>
    </div>
  </section>

  <section id="view-info" class="view">
    <h2>Information</h2>
    <div class="panel-box" style="margin-bottom:16px">
      <h3 style="font-size:14px; margin-top:0">„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
      <button class="btn-play" style="width:100%; border-color:var(--bad); color:var(--bad); padding:10px;" id="btn-reset">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ</button>
      <button class="btn-play" style="width:100%; margin-top:10px;" id="btn-rates">ÊéíÂá∫Áéá„ÇíË°®Á§∫</button>
    </div>
    <div class="infoLead">„Åì„Å®„Å∞ÂãüÈõÜÔºÜ„Çπ„Éö„Ç∑„É£„É´„Çµ„É≥„ÇØ„Çπ</div>
    <div class="infoGrid">
      <div class="infoBox">
        <h3>„Åì„Å®„Å∞ÂãüÈõÜ‰∏≠ÔºÅ</h3>
        <div class="infoSmall">
          ‰ª•‰∏ã„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Éº„Åß„Äå„Åì„Çå„ÅØÔºÅ„Äç„Å®„ÅÑ„ÅÜË®ÄËëâ„ÇíÂãüÈõÜ‰∏≠„Åß„Åô„ÄÇ<br>
          ‚ë†„ÄåÂ£∞„Å´Âá∫„Åó„Å¶Ë™≠„Åø„Åü„ÅÑË®ÄËëâ„Äç<br>
          ‚ë°„Äå„Ç≠„É°„É©Ë®ÄËëâ„Äç<br>
          ‚ë¢„ÄåÁü•„Å£„Å¶„Çã„Å§„ÇÇ„ÇäË®ÄËëâ„Äç<br>
          ‚ë£„ÄåÂÜ∑„ÇÅ„ÇãË®ÄËëâ„Äç
        </div>
      </div>
      <details class="infoBox">
        <summary>„Çπ„Éö„Ç∑„É£„É´„Çµ„É≥„ÇØ„Çπ</summary>
        <div class="infoSmall">
          Âà∂‰Ωú„Å´„ÅØ‰ª•‰∏ã„ÅÆAI„Çí‰ΩøÁî®„Åó„Åæ„Åó„Åü„ÄÇ<br>
          „ÉªBGM‰ΩúÊàêÔºöSuno AI<br>
          „Éª„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Éª„Ç§„É©„Çπ„ÉàÔºöChat-GPT„ÄÅGemini<br><br>
          „Åæ„Åü„ÄÅÊ¨°„ÅÆ‰ΩúÂìÅ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº„Åã„ÇâÂ§ö„Åè„ÅÆÁ§∫ÂîÜ„ÇíÂèó„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>
          „ÉªÈü≥Ê•ΩÔºöThe Gregory Brothers„ÄÅÊ∞¥ÊõúÊó•„ÅÆ„Ç´„É≥„Éë„Éç„É©<br>
          „Éª„Ç≤„Éº„É†Ôºö„Å´„Åª„Çì„ÅÆ„ÅÇ„Çâ„Åù„ÅÑ„ÄÅÁî≤Ëô´ÁéãËÄÖ„É†„Ç∑„Ç≠„É≥„Ç∞„ÄÅ„Éù„Ç±„ÉÉ„Éà„É¢„É≥„Çπ„Çø„Éº
        </div>
      </details>
    </div>
  </section>
</div>

<nav class="bottom-nav">
  <div id="nav-indicator"></div>
  <button class="nav-btn active" onclick="switchTab('gacha', 0)" id="tabGacha"><span class="icon">üîÆ</span><span>„Ç¨„ÉÅ„É£</span></button>
  <button class="nav-btn" onclick="switchTab('coll', 1)" id="tabColl"><span class="icon">üìñ</span><span>Âõ≥Èëë</span></button>
  <button class="nav-btn" onclick="switchTab('bgm', 2)" id="tabBgm"><span class="icon">üéµ</span><span>BGM</span></button>
  <button class="nav-btn" onclick="switchTab('cpu', 3)" id="tabCpu"><span class="icon">‚öîÔ∏è</span><span>ÂØæÊà¶</span></button>
  <button class="nav-btn" onclick="switchTab('info', 4)" id="tabInfo"><span class="icon">‚öôÔ∏è</span><span>Info</span></button>
</nav>

<div id="gacha-overlay">
  <div class="summon-circle"></div>
  <div id="res-container" style="z-index:10; perspective: 1000px; display:flex; flex-direction:column; align-items:center; gap:16px; width:100%"></div>
</div>

<div id="full-ad-overlay">
  <div style="color:var(--muted); font-size:12px; margin-bottom:12px; letter-spacing:2px; font-weight:700;">SPONSORED</div>
  <a href="nekologia.html" target="_blank" rel="noopener">
    <img src="images/necologia_banner.jpg" alt="„Éç„Ç≥„É≠„Ç∏„Ç¢ | 9.31Áô∫Â£≤ DVD„Éª„Éñ„É´„Éº„É¨„Ç§">
  </a>
  <button class="btn-play" style="margin-top:24px; border-color:white; color:white; padding:10px 30px; font-size:14px;" onclick="closeFullScreenAd()">√ó Èñâ„Åò„Çã</button>
</div>

<div id="toast">Message</div>
<audio id="bgm-player" loop></audio>

<div class="cm-modal" id="cmModal" aria-hidden="true">
  <div class="cm-backdrop" id="cmBackdrop"></div>
  <div class="cm-dialog">
    <button class="cm-close" id="cmClose">√ó</button>
    <div class="cm-title" id="cmTitle">TITLE</div>
    <img src="" class="cm-img" id="cmImg">
    <div class="cm-text" id="cmText"></div>
  </div>
</div>

<script>
/* === IMAGE DATA === */
const IMAGE_BASE_URL = "https://raw.githubusercontent.com/kyoryu1039/kotoba-gacha/main/images/";
const wordImages = {
  "„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"parabola_antenna.png",
  "„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"nescafe_ambassador.png",
  "„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"ninjin_shirishiri.png",
  "„Åù„Åº„Çç„Åî„ÅØ„Çì":"soboro_gohan.png",
  "„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"western_lowland_gorilla.png",
  "ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"kemukujara.png",
  "‰πùÂìÅ‰ªè":"kuhonbutsu.png",
  "„Åë„Çì„Å°„ÇìÊ±Å":"kenchin_jiru.png",
  "„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"kamchatka_peninsula.png",
  "„Çø„É©„É≥„ÉÅ„É•„É©":"tarantula.png",
  "„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"shoebill.png",
  "„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"balsamic_vinegar.png",
  "„Éî„É≠„É™Ëèå":"helicobacter_pylori.png",
  "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"trinidad_and_tobago.png",
  "„Ç´„É©„É°„É´Ëâ≤Á¥†":"caramel_color.png",
  "„Éê„Éì„É≠„É≥ÊçïÂõö":"babylonian_captivity.png",
  "È≥•ÂèñÁ†Ç‰∏ò":"tottori_sand_dunes.png",
  "„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"placebo_effect.png",
  "Ê∏°Êù•‰∫∫":"torai_jin.png",
  "„Åï„Çã„Å≥„ÅÇ‰∏∏":"sarubia_maru.png",
  "„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"peperoncino.png",
  "„Éù„É™„Éó„É≠„Éî„É¨„É≥":"polypropylene.png",
  "„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"sarajevo_incident.png",
  "„ÇØ„Éû„É≥„Éê„ÉÅ":"kumabachi.png",
  "ÁúåÂ∫ÅÊâÄÂú®Âú∞":"prefectural_capital.png",
  "ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"teriyaki_chicken.png",
  "„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"nerunerunerune.png",
  "„Çπ„É´„É°„Ç§„Ç´":"surume_ika.png",
  "Êú¨Ë≥™":"essence.png",
  "Ë¶ã„Åà„ÇãÂåñ":"mieruka.png",
  "Ëá™ÂàÜ„Åî„Å®Âåñ":"jibungotoka.png",
  "Ëß£ÂÉèÂ∫¶":"resolution.png"
};

/* === DATA === */
const pools={S:["„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº"],A:["„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä","„Åù„Åº„Çç„Åî„ÅØ„Çì","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ","‰πùÂìÅ‰ªè","„Åë„Çì„Å°„ÇìÊ±Å"],B:["„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂","„Çø„É©„É≥„ÉÅ„É•„É©","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢","„Éî„É≠„É™Ëèå","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥","„Ç´„É©„É°„É´Ëâ≤Á¥†"],C:["„Éê„Éì„É≠„É≥ÊçïÂõö","È≥•ÂèñÁ†Ç‰∏ò","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú","Ê∏°Êù•‰∫∫","„Åï„Çã„Å≥„ÅÇ‰∏∏","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé","„Éù„É™„Éó„É≠„Éî„É¨„É≥","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂"],D:["„ÇØ„Éû„É≥„Éê„ÉÅ","ÁúåÂ∫ÅÊâÄÂú®Âú∞","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠","„Çπ„É´„É°„Ç§„Ç´"],X:["Êú¨Ë≥™","Ë¶ã„Åà„ÇãÂåñ","Ëá™ÂàÜ„Åî„Å®Âåñ","Ëß£ÂÉèÂ∫¶"]};
const probs={S:.02,A:.08,B:.20,C:.30,D:.30,X:.10};
const icons={S:"üåü",A:"üíé",B:"üî∑",C:"üîπ",D:"üî∏",X:"‚ùå"};
const tierColors={S:"var(--gold)", A:"var(--amber)", B:"var(--aqua)", C:"var(--blue)", D:"var(--gray)", X:"var(--bad)"};
const exp={"„Éë„É©„Éú„É©„Ç¢„É≥„ÉÜ„Éä":"Â£∞„Å´Âá∫„Åó„Å¶Ë™≠„Åø„Åü„ÅÑÊó•Êú¨Ë™û„É©„É≥„Ç≠„É≥„Ç∞Á¨¨1‰Ωç„ÄÇ","„Éç„Çπ„Ç´„Éï„Çß„Ç¢„É≥„Éê„Çµ„ÉÄ„Éº":"Ë™∞„ÇÇ„Åå‰∫∫Áîü„Åß‰∏ÄÂ∫¶„ÅØÂ∞±‰ªª„Åó„Å¶„Åø„Åü„ÅÑÊÜß„Çå„ÅÆËÇ©Êõ∏„Åç„ÄÇ","„Å´„Çì„Åò„Çì„Åó„Çä„Åó„Çä":"Ê≤ñÁ∏Ñ„ÅÆ„Ç≠„ÉÉ„ÉÅ„É≥„Åã„ÇâÂ±ä„Åè„ÄÅÁàΩ„ÇÑ„Åã„Å™„Åè„ÇäËøî„ÅóË®ÄËëâ„ÄÇ","„Åù„Åº„Çç„Åî„ÅØ„Çì":"Âè£„ÅÆ‰∏≠„Çí‰ΩìÁèæ„Åó„Åü„Çà„ÅÜ„Å™Ë™ûÊÑü„ÄÇ","„Éã„Ç∑„É≠„Éº„É©„É≥„Éâ„Ç¥„É™„É©":"ÂêçÂâç„Åã„Çâ„Éì„Ç∑„Éì„Ç∑„Å®‰ºù„Çè„Å£„Å¶„Åè„ÇãÂ®ÅÂé≥„ÄÇ„Åè„Çå„Åê„Çå„ÇÇVIPÂæÖÈÅá„Åß„ÄÇ","ÊØõ„ÇÄ„Åè„Åò„ÇÉ„Çâ":"ÊØõ„ÅØÁü•„Å£„Å¶„Çã„Åë„Å©„ÄÅ„ÇÄ„Åè„Åò„ÇÉ„Çâ„Å£„Å¶‰Ωï„Å™„ÅÆ„Åï„ÄÇ","‰πùÂìÅ‰ªè":"Èõ£Ë™≠Âú∞Âêç„ÅåÁπî„Çä„Å™„Åô„É™„Ç∫„É†„ÄÇ","„Åë„Çì„Å°„ÇìÊ±Å":"Èüø„Åç„Å†„Åë„Åß„ÄÅ„ÇÇ„ÅÜ„ÅÇ„Å£„Åü„Åã„ÅÑ„ÄÇ","„Ç´„É†„ÉÅ„É£„ÉÉ„Ç´ÂçäÂ≥∂":"ÂØíÊ∞ó„Å®ÁÜ±Ê∞ó„ÅåÂêåÂ±Ö„Åô„ÇãÊ•µÊù±„ÅÆÂú∞„Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ","„Çø„É©„É≥„ÉÅ„É•„É©":"„Éï„Ç°„É≥„Ç∑„Éº„Å™„ÅäËèìÂ≠ê„Åø„Åü„ÅÑ„ÄÇÁåõÊØíÁ≥ª„Çπ„Ç§„Éº„ÉÑ„ÄÇ","„Éè„Ç∑„Éì„É≠„Ç≥„Ç¶":"ÈñìÊäú„Åë„ÅÆÈ≥•„Å´„ÅØÈñìÊäú„Åë„Å™Ë™ûÊÑü„ÄÇ","„Éê„É´„Çµ„Éü„Ç≥ÈÖ¢":"„Åæ„Çã„ÅßÂë™Êñá„ÄÇ","„Éî„É≠„É™Ëèå":"ÂèØÊÑõ„ÅÑ„Åµ„Çä„Åó„Å¶„Çè„Çä„Å®„ÇÑ„Çã„ÇÇ„Çì„Å†„Å≠„ÄÇ","„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥":"ÂÆπËµ¶„Å™„ÅÑÊøÅÈü≥„Å®„Éà„ÅÆÂøúÈÖ¨„ÄÇ","„Ç´„É©„É°„É´Ëâ≤Á¥†":"„Åä„ÇÑ„Å§„ÅÆË®òÊÜ∂„Å´„É©„Éú„ÅÆÂåÇ„ÅÑ„ÄÇ","„Éê„Éì„É≠„É≥ÊçïÂõö":"„ÅÑ„Åã„Å´„ÇÇÊçï„Åæ„Å£„Åü„ÅÅ„Å£„Å¶ÊÑü„Åò„ÄÇ","È≥•ÂèñÁ†Ç‰∏ò":"ËçíÈáé„ÇíÂ≠êÈü≥„ÅåË∑≥„Å≠Âõû„Çã„ÄÇ","„Éó„É©„Ç∑„Éº„ÉúÂäπÊûú":"Ë®ÄËëâ„Å´Ëàê„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ","Ê∏°Êù•‰∫∫":"ÊúùÈÆÆÂçäÂ≥∂„Åã„Çâ„ÅÆÊåëÊà¶„ÄÇ","„Åï„Çã„Å≥„ÅÇ‰∏∏":"Èñì„ÅÆÊäú„Åë„ÅüÊóÖ„Å´„Å™„Çä„Åù„ÅÜ„ÄÇ","„Éö„Éö„É≠„É≥„ÉÅ„Éº„Éé":"ÂîêËæõÂ≠ê„ÅåË∫çÂãï„Åô„ÇãÂè£ÂÜÖ„ÄÇ","„Éù„É™„Éó„É≠„Éî„É¨„É≥":"ÂçäÊøÅÈü≥„ÅÆÁéãÊßò„ÄÇ","„Çµ„É©„Ç®„Éú‰∫ã‰ª∂":"„Åï„Çâ„Å£„Å®Âßã„Åæ„Å£„Åü„ÅØ„Åö„Å†„Å£„Åü„ÅÆ„Å´„ÄÇ","„ÇØ„Éû„É≥„Éê„ÉÅ":"„Äå„Çì„Äç„ÅÆÂ¶ô„ÄÇ","ÁúåÂ∫ÅÊâÄÂú®Âú∞":"Â†Ç„ÄÖ„Å®„Åó„Å¶„Çã„Çà„Å≠„ÄÇ","ÁÖß„ÇäÁÑº„Åç„ÉÅ„Ç≠„É≥":"ÁîòËæõ„Éì„Éº„Éà„Å´‰πó„Å£„Å°„ÇÉ„Å£„Å¶„ÄÇ","„Å≠„Çã„Å≠„Çã„Å≠„Çã„Å≠":"„Ç™„Çª„É≠„Å†„Å£„Åü„ÇâÊ∞óÊåÅ„Å°„ÅÑ„ÅÑ„ÄÇ","„Çπ„É´„É°„Ç§„Ç´":"Âôõ„ÇÅ„Å∞Âôõ„ÇÄ„Åª„Å©Âë≥„ÅåÂá∫„ÇãÂêçÂâç„ÄÇ","Êú¨Ë≥™":"„Åü„Å®„Åà„ÅÇ„Å£„Åü„Å®„Åó„Å¶„ÇÇ„ÄÅËªΩ„ÄÖ„Åó„ÅèÂè£„Å´Âá∫„Åô„Çà„ÅÜ„Å™‰∫∫„ÅØ‰∏ÄÁîüËøë„Å•„Åë„Å™„ÅÑ„Å®ÊÄù„ÅÜ„Çì„Åß„Åô„ÄÇ","Ë¶ã„Åà„ÇãÂåñ":"ÂèØË¶ñÂåñ„Å£„Å¶Áü•„Å£„Å¶„Åæ„Åô„Åã„ÄÇ","Ëá™ÂàÜ„Åî„Å®Âåñ":"„ÄåËá™ÂàÜ„Åî„Å®„Äç„Åß„ÇÇÂ´å„Å™„ÅÆ„Å´„ÄÅ„ÄåÂåñ„Äç„Åæ„Åß„Å§„Åë„Çâ„Çå„ÅüÊó•„Å´„ÅØ‚Ä¶","Ëß£ÂÉèÂ∫¶":"„Å™„Çã„Åª„Å©„ÄÅ„Éî„ÇØ„Çª„É´Êï∞„ÅåÈ´ò„Åæ„Çä„Åæ„Åó„ÅüÔºÅ"};

const rewards={
  S: {name:"ÈáëÈ≠öÈâ¢", type:"BGM", id:"kingyobachi"},
  A: {name:"‰πùÂìÅ‰ªèÂ•áË≠ö", type:"BGM", id:"kuganebutsu"},
  B: {name:"„Éç„Ç≥„É≠„Ç∏„Ç¢", type:"BGM", id:"necology"}
};

const storeSeen="kotoba_collection_seen_v4_7";
const storeBGM="kotoba_bgm_selected_v4_7";
const storeUnlocked="kotoba_unlocked_tiers_v4_7";
const seen=new Set(JSON.parse(localStorage.getItem(storeSeen)||"[]"));
const unlockedTiers=new Set(JSON.parse(localStorage.getItem(storeUnlocked)||"[]"));
let selectedBGM=localStorage.getItem(storeBGM)||"default";
const tiers=["S","A","B","C","D","X"];

/* === AUDIO SYSTEM === */
const bgmPlayer=document.getElementById('bgm-player');
const bgmBtn=document.getElementById('btn-bgm-toggle');
const volSlider=document.getElementById('vol-slider');
let isBgmOn=false;

bgmPlayer.volume=parseFloat(volSlider.value);
volSlider.addEventListener('input',()=>bgmPlayer.volume=parseFloat(volSlider.value));

function setBgmState(on){
  isBgmOn = on;
  bgmBtn.textContent=isBgmOn?"ON":"OFF";
  bgmBtn.style.borderColor=isBgmOn?"var(--aqua)":"var(--edge)";
  bgmBtn.style.color=isBgmOn?"var(--aqua)":"var(--muted)";
  if(isBgmOn){bgmPlayer.play().catch(()=>{});}else{bgmPlayer.pause();}
}
bgmBtn.onclick=()=>setBgmState(!isBgmOn);

let audioCtx=null;
function getCtx(){if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==="suspended")audioCtx.resume();return audioCtx;}
function tone(f,d,t='triangle'){const c=getCtx();if(!c)return;const o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.05,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+d);o.start();o.stop(c.currentTime+d+0.05);}

let chargeOsc=null, chargeGain=null;
function startChargeSound(){
  const c=getCtx(); if(!c)return;
  chargeOsc=c.createOscillator(); chargeGain=c.createGain();
  chargeOsc.type='sawtooth'; chargeOsc.frequency.setValueAtTime(100,c.currentTime);
  chargeOsc.frequency.exponentialRampToValueAtTime(800,c.currentTime+1);
  chargeGain.gain.setValueAtTime(0.05,c.currentTime);
  chargeOsc.connect(chargeGain); chargeGain.connect(c.destination);
  chargeOsc.start();
}
function stopChargeSound(){
  if(chargeOsc){
    const c=getCtx();
    chargeGain.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.1);
    chargeOsc.stop(c.currentTime+0.1); chargeOsc=null;
  }
}

function sfxTap(){tone(800,0.05);}
function sfxRare(){tone(600,0.1,'sine');setTimeout(()=>tone(1200,0.3,'square'),100);}
function sfxGlitch(){tone(100,0.1,'sawtooth');setTimeout(()=>tone(50,0.1,'sawtooth'),100);}

/* === CHARGE LOGIC === */
function setupChargeBtn(id, count){
  const btn = document.getElementById(id);
  let timer = null;
  const start = (e) => {
    e.preventDefault();
    if(overlay.classList.contains('active')) return;
    btn.classList.add('charging');
    document.getElementById('coreOrb').classList.add('charging');
    startChargeSound();
    if(navigator.vibrate) navigator.vibrate(50);
    timer = setTimeout(() => {
      stopChargeSound();
      btn.classList.remove('charging');
      document.getElementById('coreOrb').classList.remove('charging');
      roll(count);
    }, 1000);
  };
  const cancel = (e) => {
    if(timer){
      clearTimeout(timer); timer=null;
      btn.classList.remove('charging');
      document.getElementById('coreOrb').classList.remove('charging');
      stopChargeSound();
    }
  };
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchstart', start);
  btn.addEventListener('mouseup', cancel);
  btn.addEventListener('mouseleave', cancel);
  btn.addEventListener('touchend', cancel);
}
setupChargeBtn('btn-roll-1', 1);
setupChargeBtn('btn-roll-5', 5);

/* === GAME LOGIC === */
function switchTab(id, idx){
  document.querySelectorAll('.view').forEach(v=>{v.classList.remove('active');});
  const target = document.getElementById(`view-${id}`);
  target.classList.add('active'); target.scrollTop = 0;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const btnId = 'tab'+id.charAt(0).toUpperCase()+id.slice(1);
  const btn = document.getElementById(btnId);
  if(btn) btn.classList.add('active');
  const indicator = document.getElementById('nav-indicator');
  indicator.style.left = `${idx * 20}%`;
  sfxTap();
  if(id==='coll') renderCollection();
  if(id==='bgm') renderBGMList();
}

const overlay=document.getElementById('gacha-overlay');
const resCont=document.getElementById('res-container');
const summonCircle = document.querySelector('.summon-circle');

function pickTier(){const r=Math.random();let a=0;for(const k of tiers){a+=probs[k];if(r<a)return k;}return "D";}
function pickWord(t){const a=pools[t];return a[Math.floor(Math.random()*a.length)];}

function shakeScreen(hard=false){
  const app = document.getElementById('app');
  app.classList.remove('shake-small','shake-hard');
  void app.offsetWidth;
  app.classList.add(hard ? 'shake-hard' : 'shake-small');
  if(navigator.vibrate) navigator.vibrate(hard ? 200 : 50);
}

const adOverlay = document.getElementById('full-ad-overlay');
function onCloseMultiResult() {
  if (Math.random() < 0.2) { adOverlay.classList.add('active'); sfxTap(); } else { closeOverlay(); }
}
function closeFullScreenAd() { adOverlay.classList.remove('active'); closeOverlay(); }

// Helper: Preload Image
function preloadImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = url;
    img.onload = resolve;
    img.onerror = resolve;
  });
}

async function roll(count){
  if(isBgmOn && bgmPlayer.paused) bgmPlayer.play().catch(()=>{});
  shakeScreen(true);
  overlay.classList.add('active'); resCont.innerHTML="";
  summonCircle.style.display = 'block';

  const waitRoll = count > 1 ? 200 : 600;
  const waitShow = count > 1 ? 800 : 1400;

  try {
    // 1. Pre-calculate results
    const results = [];
    for(let i=0;i<count;i++){
      const t=pickTier();
      const w=pickWord(t);
      const isNew=!seen.has(w);
      if(isNew){ seen.add(w); localStorage.setItem(storeSeen,JSON.stringify([...seen])); }
      results.push({t, w, isNew});
    }

    // 2. Preload Images (Issue Fix 2)
    const imgPromises = results.map(r => {
      if(wordImages[r.w]) return preloadImage(IMAGE_BASE_URL + wordImages[r.w]);
      return Promise.resolve();
    });
    await Promise.all(imgPromises);

    // 3. Animate Results
    for(let i=0; i<count; i++){
      await new Promise(r=>setTimeout(r, waitRoll)); 
      try { tone(200+i*50,0.1,'square'); } catch(e){}
      
      const {t, w, isNew} = results[i];
      
      const cardWrap = document.createElement('div'); cardWrap.className = 'card-stage';
      const card=document.createElement('div'); card.className=`result-card ${t}`;
      if(t==='X') document.body.classList.add('glitch-mode');
      
      const imgPath = wordImages[w] ? (IMAGE_BASE_URL + wordImages[w]) : '';
      const imgHtml = imgPath ? `<div class="result-img-container"><img src="${imgPath}" class="result-img" alt="${w}"></div>` : `<div class="result-rarity">${icons[t]}</div>`;

      card.innerHTML=`<div class="holo-sheen"></div>${imgHtml}<div class="result-word">${w}</div><div class="result-desc">${exp[w]||""}</div>${isNew?'<div class="badge">NEW</div>':''}`;
      
      if(t==='S' || t==='A') {
        cardWrap.addEventListener('mousemove', (e) => tiltCard(e, card));
        cardWrap.addEventListener('mouseleave', () => resetCardTilt(card));
        if(window.DeviceOrientationEvent) window.addEventListener('deviceorientation', (e) => tiltCardMobile(e, card));
      }
      cardWrap.appendChild(card);
      resCont.innerHTML=""; resCont.appendChild(cardWrap);
      
      if(t==='S'){ try{sfxRare(); confetti(); shakeScreen(true);}catch(e){} }
      else if(t==='X'){ try{sfxGlitch();}catch(e){} }
      else { try{sfxTap();}catch(e){} }
      setTimeout(()=>card.classList.add('show'),50);
      tryUnlock(t);
      await new Promise(r=>setTimeout(r, waitShow));
      document.body.classList.remove('glitch-mode');
    }

    if (count === 1) {
      await new Promise(r=>setTimeout(r, 1000));
      closeOverlay();
    } else {
      summonCircle.style.display = 'none';
      // FIXED: Use simple div for button container to prevent stretching (Issue 3)
      resCont.innerHTML = `
        <h3 style="margin-bottom:10px; color:var(--aqua)">RESULTS</h3>
        <div class="summary-container"></div>
        <div style="margin-top:20px; display:flex; justify-content:center; width:100%;">
          <button class="btn-summon single" onclick="onCloseMultiResult()"><div class="btn-label">Èñâ„Åò„Çã</div></button>
        </div>
      `;
      const grid = resCont.querySelector('.summary-container');
      results.forEach(r => {
        const d = document.createElement('div');
        d.className = `summary-card ${r.t}`;
        const rImg = wordImages[r.w] ? (IMAGE_BASE_URL + wordImages[r.w]) : null;
        const iconHtml = rImg ? `<div class="s-icon"><img src="${rImg}" class="s-img"></div>` : `<div class="s-icon">${icons[r.t]}</div>`;
        
        d.innerHTML = `
          ${iconHtml}
          <div class="s-content"><div class="s-word">${r.w}</div><div class="s-desc">${exp[r.w] || ""}</div></div>
          ${r.isNew ? '<div class="badge" style="top:-4px;right:-4px;font-size:9px;">NEW</div>' : ''}
        `;
        grid.appendChild(d);
      });
    }
  } catch(e) { console.error(e); closeOverlay(); }
}

function tiltCard(e, card) {
  const rect = card.getBoundingClientRect();
  const x = e.clientX - rect.left; const y = e.clientY - rect.top;
  const cx = rect.width / 2; const cy = rect.height / 2;
  const dx = (x - cx) / cx; const dy = (y - cy) / cy;
  card.style.transform = `scale(1) rotateY(${dx * 15}deg) rotateX(${-dy * 15}deg)`;
  const sheen = card.querySelector('.holo-sheen');
  if(sheen) sheen.style.backgroundPosition = `${50 + (dx * 50)}% ${50 + (dy * 50)}%`;
}
function resetCardTilt(card){
  card.style.transform = `scale(1) rotateY(0) rotateX(0)`;
}
function tiltCardMobile(e, card) {
  const dx = e.gamma / 45; const dy = e.beta / 45;
  card.style.transform = `scale(1) rotateY(${dx * 15}deg) rotateX(${-dy * 15}deg)`;
}

function closeOverlay(){ overlay.classList.remove('active'); sfxTap(); }
function confetti(){
  const colors=['#ffd700','#63ead9','#ff4d4d'];
  for(let i=0;i<30;i++){
    const s=document.createElement('div'); s.className='shard';
    s.style.background=colors[Math.floor(Math.random()*3)];
    s.style.left=Math.random()*100+'%'; s.style.top='-10px';
    s.style.animationDuration=(1+Math.random())+'s';
    s.addEventListener('animationend', () => s.remove());
    overlay.appendChild(s);
  }
}

/* === COLLECTION & MODAL === */
function renderCollection(){
  const cont = document.getElementById('coll-container'); cont.innerHTML="";
  let allTotal=0, allHave=0;
  
  tiers.forEach(t => {
    let tTotal=0, tHave=0;
    pools[t].forEach(w => { allTotal++; tTotal++; if(seen.has(w)) { allHave++; tHave++; } });
    const pct = tTotal === 0 ? 0 : (tHave / tTotal) * 100;
    const sect = document.createElement('div');
    sect.className = `tier-section tier-${t}`;
    
    let rewardHtml = "";
    if(rewards[t]){
      const isUl = tHave === tTotal && tTotal > 0;
      const rewardName = isUl ? rewards[t].name : "ÔºüÔºüÔºü";
      const clickAttr = isUl ? `onclick="playTrack('${rewards[t].id}')"` : "";
      rewardHtml = `<div class="tier-reward ${isUl?'unlocked':''}" ${clickAttr}><span>${isUl?'üéµ':'üîí'}</span> ${rewardName}</div>`;
    }

    sect.innerHTML = `
      <div class="tier-header">
        <div class="tier-title">${icons[t]} Rank ${t}</div>
        <div style="display:flex; align-items:center; gap:8px;">
           ${rewardHtml}
           <div class="tier-counts">${tHave}/${tTotal}</div>
        </div>
      </div>
      <div class="tier-progress-track"><div class="tier-progress-fill" style="width:${pct}%"></div></div>
      <div class="coll-grid-tier"></div>
    `;
    
    const grid = sect.querySelector('.coll-grid-tier');
    pools[t].forEach(w => {
      const el=document.createElement('div');
      const known=seen.has(w);
      el.className=`coll-item ${known?'':'locked'}`;
      
      const imgPath = (known && wordImages[w]) ? (IMAGE_BASE_URL + wordImages[w]) : null;
      const contentHtml = imgPath 
        ? `<div class="coll-item-img-box"><img src="${imgPath}" class="coll-img" loading="lazy"></div>` 
        : `<div class="coll-item-img-box coll-icon-locked">${icons[t]}</div>`;

      el.innerHTML=`${contentHtml}<div class="coll-item-name">${known?w:'???'}</div>`;
      if(known) el.onclick=()=>showModal(w, exp[w], t); // Pass Tier
      grid.appendChild(el);
    });
    cont.appendChild(sect);
  });
  document.getElementById('coll-total-val').textContent = `${allHave} / ${allTotal}`;
}

function playTrack(id){
  selectedBGM = id; localStorage.setItem(storeBGM, id);
  const track = getTracks().find(t => t.id === id);
  if(track){
    bgmPlayer.src = track.src;
    if(!isBgmOn) setBgmState(true);
    bgmPlayer.play().catch(()=>{});
    renderBGMList(); showToast(`‚ô™ ÂÜçÁîü‰∏≠: ${track.name}`);
  }
}

function hasTier(t){return pools[t].every(w=>seen.has(w));}
function getTracks(){
  return [
    {id:"default",name:"„Éí„Éó„Éä„Ç¥„Ç∏„Ç¢Èü≥È†≠",ul:true,src:"audio/Hypnagogiaondo.mp3"},
    {id:"kingyobachi",name:"ÈáëÈ≠öÈâ¢",ul:hasTier("S"),src:"audio/Kingyobachi.mp3",hint:"S„Ç≥„É≥„Éó", spotify:"https://open.spotify.com/intl-ja/track/1RtkBsTHAU4EFlUGrOBp3I?si=df763a0a3d8c427f"},
    {id:"kuganebutsu",name:"‰πùÂìÅ‰ªèÂ•áË≠ö",ul:hasTier("A"),src:"audio/Kuhonbutsukitan.mp3",hint:"A„Ç≥„É≥„Éó", spotify:"https://open.spotify.com/intl-ja/track/6EsXFW2Wrnr1NCDaRv4yC0?si=33e729e10a9b4af0"},
    {id:"necology",name:"„Éç„Ç≥„É≠„Ç∏„Ç¢",ul:hasTier("B"),src:"audio/Nekologia.mp3",hint:"B„Ç≥„É≥„Éó"},
    {id:"chorus",name:"ÈáëÈ≠öÈâ¢(ÂêàÂî±)",ul:tiers.every(t=>hasTier(t)),src:"audio/Kingyobachi_chorus.mp3",hint:"ÂÖ®„Ç≥„É≥„Éó"}
  ];
}
function renderBGMList(){
  const list=document.getElementById('bgm-list'); list.innerHTML="";
  getTracks().forEach(t=>{
    const d=document.createElement('div'); d.className='track-row';
    let spotLink = "";
    if(t.ul && t.spotify) {
      spotLink = `<a href="${t.spotify}" target="_blank" class="btn-spotify" aria-label="Spotify„ÅßËÅ¥„Åè"><svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg></a>`;
    }
    d.innerHTML=`
      <div class="track-info">
        <div class="track-name" style="color:${t.ul?'var(--ink)':'var(--muted)'}">${t.ul?t.name:'ÔºüÔºüÔºü'}</div>
        <div class="track-status">${t.ul?'Ëß£ÊîæÊ∏à':t.hint+'„ÅßËß£Êîæ'}</div>
      </div>
      <div style="display:flex; gap:8px;">
        ${spotLink}
        <button class="btn-play" ${t.ul?'':'disabled'}>${selectedBGM===t.id?'ÂÜçÁîü‰∏≠':'ÂÜçÁîü'}</button>
      </div>
    `;
    if(t.ul){d.querySelector('button').onclick=()=>{selectedBGM=t.id; localStorage.setItem(storeBGM,t.id); bgmPlayer.src=t.src; if(isBgmOn) bgmPlayer.play(); renderBGMList();};}
    list.appendChild(d);
  });
}

// Issue 3 Fix: Check persistent unlocked state
function tryUnlock(t){
  if(["S","A","B"].includes(t) && hasTier(t) && !unlockedTiers.has(t)){
    unlockedTiers.add(t);
    localStorage.setItem(storeUnlocked, JSON.stringify([...unlockedTiers]));
    showToast(`Rank ${t} „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅBGMËß£Êîæ`);
    renderCollection(); // Refresh to show unlocked BGM in header
    renderBGMList();
  }
}

const toast=document.getElementById('toast');
function showToast(msg){toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000);}

/* Modal: Now accepts Tier to style border */
const modal=document.getElementById('cmModal');
let typeInterval = null;

function showModal(title, text, tier){
  document.getElementById('cmTitle').textContent=title;
  const txtEl = document.getElementById('cmText');
  const imgEl = document.getElementById('cmImg');
  
  if(wordImages[title]) {
    imgEl.src = IMAGE_BASE_URL + wordImages[title];
    imgEl.style.display = 'block';
  } else {
    imgEl.style.display = 'none';
  }

  txtEl.textContent = "";
  txtEl.className = "cm-text cursor";
  
  // Set Dynamic Color
  const targetColor = tierColors[tier] || 'var(--aqua)';
  document.querySelector('.cm-dialog').style.setProperty('--target-color', targetColor);

  modal.classList.add('show');
  
  if(typeInterval) clearInterval(typeInterval);
  let i = 0;
  typeInterval = setInterval(()=>{
    txtEl.textContent += text.charAt(i);
    i++;
    if(i >= text.length){ clearInterval(typeInterval); txtEl.classList.remove("cursor"); }
  }, 30);
}
document.getElementById('cmClose').onclick=()=>modal.classList.remove('show');
document.getElementById('cmBackdrop').onclick=()=>modal.classList.remove('show');
document.getElementById('btn-reset').onclick=()=>{if(confirm('Êú¨ÂΩì„Å´„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô„ÅãÔºü')) {seen.clear(); localStorage.setItem(storeSeen,"[]"); location.reload();}};
document.getElementById('btn-rates').onclick=()=>{alert("ÊéíÂá∫Áéá:\nS:2% A:8% B:20% C:30% D:30% X:10%");};
const savedTrack = getTracks().find(t=>t.id===selectedBGM);
if(savedTrack) bgmPlayer.src = savedTrack.src;
</script>
</body>
</html>
